<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="ì‡¼ë‹¤ìš´ ì‹¬íŒ ì•± í”„ë¡œ - ëŒ€ì§„ ì„¤ì •, ì‹¬íŒ ê´€ë¦¬, ì‹¤ì‹œê°„ ì ìˆ˜">
    <meta name="theme-color" content="#4a90d9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ì‡¼ë‹¤ìš´">
    <title>ì‡¼ë‹¤ìš´ ì‹¬íŒ ì•± PRO</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-152.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-72.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-72.png">
    
    <!-- Splash Screen for iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-startup-image" href="icons/icon-512.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* í…Œë§ˆ ë³€ìˆ˜ */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border: #dadce0;
            --primary: #1a73e8;
            --primary-hover: #1557b0;
            --success: #34a853;
            --warning: #fbbc04;
            --danger: #ea4335;
            --shadow: rgba(0,0,0,0.1);
        }
        
        body.enhanced-contrast {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f0f0;
            --bg-card: #ffffff;
            --text-primary: #000000;
            --text-secondary: #333333;
            --border: #999999;
            --primary: #0066cc;
            --success: #228b22;
            --warning: #cc9900;
            --danger: #cc0000;
        }
        
        body.high-contrast {
            --bg-primary: #ffffff;
            --text-primary: #000000;
            --border: #000000;
            --primary: #0000ff;
            --success: #008000;
            --warning: #ff8c00;
            --danger: #ff0000;
        }
        
        body.inverted {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --bg-card: #000000;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border: #666666;
            --primary: #66b3ff;
            --success: #66ff66;
            --warning: #ffcc66;
            --danger: #ff6666;
        }
        
        body.dark {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-card: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border: #444444;
            --primary: #4d9eff;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }
        
        /* ìŠ¤í¬ë¦° ë¦¬ë” ì „ìš© (í™”ë©´ì— ë³´ì´ì§€ ì•ŠìŒ) */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        *:focus {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
        }
        
        .accessibility-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-bottom: 2px solid var(--border);
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 8px var(--shadow);
        }
        
        .accessibility-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .a11y-btn {
            min-width: 44px;
            min-height: 44px;
            padding: 8px 12px;
            border: 2px solid var(--border);
            background: var(--bg-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        .a11y-btn:hover, .a11y-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 70px 20px 20px;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            padding: 24px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px var(--shadow);
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px var(--shadow);
            border: 1px solid var(--border);
        }
        
        .card h2 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
        }
        
        .btn {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            min-height: 48px;
            margin-bottom: 12px;
            transition: all 0.2s;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary { 
            background: var(--primary); 
            color: white;
            border-color: var(--primary);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
        }
        
        .btn-success { background: var(--success); color: white; border-color: var(--success); }
        .btn-warning { background: var(--warning); color: white; border-color: var(--warning); }
        .btn-danger { background: var(--danger); color: white; border-color: var(--danger); }
        
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            margin: 8px 0;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-top: 12px;
            margin-bottom: 4px;
        }
        
        .score-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin: 24px 0;
        }
        
        .player-score {
            text-align: center;
        }
        
        .score-display {
            font-size: 72px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }
        
        .player-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .serve-indicator {
            margin-top: 8px;
            font-size: 14px;
            color: var(--success);
            font-weight: 600;
        }
        
        .timeout-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }
        
        .timeout-btn {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--warning);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .timeout-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .timeout-count {
            font-size: 12px;
        }
        
        .foul-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .foul-btn {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            min-height: 60px;
            background: var(--warning);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .goal-btn {
            background: var(--success);
            grid-column: 1 / -1;
            min-height: 80px;
            font-size: 18px;
        }
        
        .action-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }
        
        .folder-item, .match-item {
            padding: 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            margin: 12px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .folder-item:hover, .match-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .timer-display {
            font-size: 96px;
            font-weight: 700;
            color: var(--primary);
            margin: 24px 0;
            font-variant-numeric: tabular-nums;
        }
        
        .timer-display.warning {
            color: var(--danger);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 600;
            border: 2px solid var(--success);
            background: var(--bg-secondary);
            text-align: center;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }
        
        .info-item {
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
            border: 1px solid var(--border);
        }
        
        .info-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .info-value {
            font-weight: 600;
        }
        
        @media (max-width: 600px) {
            .score-display { font-size: 56px; }
            .timer-display { font-size: 72px; }
            .foul-grid { grid-template-columns: 1fr; }
            .info-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="accessibility-bar">
        <div style="font-weight: 600; font-size: 14px;">ì ‘ê·¼ì„±</div>
        <div class="accessibility-controls">
            <button class="a11y-btn" onclick="cycleTheme()" id="theme-btn" aria-label="í™”ë©´ ëª¨ë“œ ë³€ê²½">ëª¨ë“œ: ì¼ë°˜</button>
        </div>
    </div>

    <div id="app" class="container"></div>

    <!-- aria-live ì‹¤ì‹œê°„ ì•ˆë‚´ (í™”ë©´ì— ë³´ì´ì§€ ì•ŠìŒ, ìŠ¤í¬ë¦° ë¦¬ë”ë§Œ) -->
    <div aria-live="assertive" aria-atomic="true" class="sr-only" id="live-announcement"></div>

    <!-- íƒ€ì„ì•„ì›ƒ ëª¨ë‹¬ -->
    <div id="timeout-modal" class="modal">
        <div class="modal-content">
            <h2 id="timeout-title">íƒ€ì„ì•„ì›ƒ</h2>
            <div id="timer-display" class="timer-display">60</div>
            <button class="btn btn-danger" onclick="closeTimeout()" style="width:100%" aria-label="íƒ€ì„ì•„ì›ƒ ì¢…ë£Œ">íƒ€ì„ì•„ì›ƒ ì¢…ë£Œ</button>
        </div>
    </div>

    <!-- PIN ì…ë ¥ ëª¨ë‹¬ -->
    <div id="pin-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="pin-modal-title">
        <div class="modal-content" style="max-width:320px;">
            <h2 id="pin-modal-title" style="text-align:center;">ğŸ” ì‹¬íŒ PIN ì…ë ¥</h2>
            <p id="pin-modal-desc" style="text-align:center; color:#666; font-size:14px; margin-bottom:16px;">ê²½ê¸° ê´€ë¦¬ë¥¼ ìœ„í•´ PINì„ ì…ë ¥í•˜ì„¸ìš”</p>
            <label for="pin-input" class="sr-only">ì‹¬íŒ PIN ì…ë ¥</label>
            <input type="password" id="pin-input" placeholder="PIN ì…ë ¥" 
                   aria-describedby="pin-modal-desc pin-error"
                   style="width:100%; padding:16px; font-size:20px; text-align:center; border:2px solid #ddd; border-radius:8px; letter-spacing:4px;"
                   maxlength="8" inputmode="numeric">
            <div id="pin-error" role="alert" aria-live="polite" style="color:#f44336; text-align:center; margin-top:8px; display:none;">PINì´ í‹€ë ¸ìŠµë‹ˆë‹¤</div>
            <div style="display:flex; gap:8px; margin-top:16px;">
                <button class="btn" onclick="closePinModal()" style="flex:1;" aria-label="PIN ì…ë ¥ ì·¨ì†Œ">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="verifyPin()" style="flex:1;" aria-label="PIN í™•ì¸">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase ì´ˆê¸°í™”
        const firebaseConfig = {
            apiKey: "AIzaSyAKv3QOpSg-hLnyXSnE299fHRV-akpPQCs",
            authDomain: "showdown1-838bf.firebaseapp.com",
            databaseURL: "https://showdown1-838bf-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "showdown1-838bf",
            storageBucket: "showdown1-838bf.firebasestorage.app",
            messagingSenderId: "379033064628",
            appId: "1:379033064628:web:252eef0e38b45859df73e1"
        };
        
        let database = null;
        let userId = null; // âœ¨ ì‚¬ìš©ì ê³ ìœ  ID
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('âœ… Firebase ì—°ê²°ë¨');
            
            // âœ¨ ì‚¬ìš©ì ID ì´ˆê¸°í™”
            initializeUserId();
        } catch (error) {
            console.log('Firebase ì—°ê²° ì‹¤íŒ¨ - ë¡œì»¬ ëª¨ë“œ');
        }
        
        // ì‹¬íŒ ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” (ì²« ì‹¤í–‰ ì‹œ)
        if (!localStorage.getItem('refereePasswordsInitialized')) {
            localStorage.setItem('refereePasswords', JSON.stringify({}));
            localStorage.setItem('refereePasswordsInitialized', 'true');
            console.log('âœ… ì‹¬íŒ ë¹„ë°€ë²ˆí˜¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™”ë¨');
        }
        
        // âœ¨ ì‚¬ìš©ì ID ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeUserId() {
            userId = localStorage.getItem('userId');
            if (!userId) {
                // ìƒˆ ì‚¬ìš©ì - ID ìƒì„±
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
                console.log('âœ¨ ìƒˆ ì‚¬ìš©ì ID ìƒì„±:', userId);
            } else {
                console.log('âœ¨ ê¸°ì¡´ ì‚¬ìš©ì ID:', userId);
            }
        }
        
        // ìŒì„± ì•ˆë‚´
        let voiceEnabled = localStorage.getItem('voice') !== 'false';
        let isTimeoutActive = false;
        
        function speak(text) {
            if (!voiceEnabled) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = 1.1;
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
        }

        // aria-live ì‹¤ì‹œê°„ ì•ˆë‚´ (ìŠ¤í¬ë¦° ë¦¬ë”ìš©)
        function announce(text) {
            const liveRegion = document.getElementById('live-announcement');
            if (liveRegion) {
                liveRegion.textContent = text;
            }
        }

        // í…Œë§ˆ ìˆœí™˜
        const themes = [
            { id: 'normal', name: 'ì¼ë°˜' },
            { id: 'enhanced-contrast', name: 'ëª…ë„ëŒ€ë¹„' },
            { id: 'high-contrast', name: 'ê³ ëŒ€ë¹„' },
            { id: 'inverted', name: 'ìƒ‰ë°˜ì „' },
            { id: 'dark', name: 'ë‹¤í¬' }
        ];
        let currentThemeIndex = 0;

        function cycleTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            const theme = themes[currentThemeIndex];
            
            document.body.className = theme.id === 'normal' ? '' : theme.id;
            localStorage.setItem('theme', theme.id);
            localStorage.setItem('themeIndex', currentThemeIndex);
            
            document.getElementById('theme-btn').textContent = `ëª¨ë“œ: ${theme.name}`;
            speak(`${theme.name} ëª¨ë“œë¡œ ë³€ê²½ë¨`);
        }

        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            localStorage.setItem('voice', voiceEnabled);
            speak(voiceEnabled ? 'ìŒì„± ì•ˆë‚´ ì¼œì§' : 'ìŒì„± ì•ˆë‚´ êº¼ì§');
            document.getElementById('voice-btn').style.opacity = voiceEnabled ? '1' : '0.5';
        }

        // ë°ì´í„° êµ¬ì¡°
        let projects = [];
        let currentProject = null;
        let currentMatch = null;
        let screen = 'home';
        let timeoutTimer = null;
        let timeoutSeconds = 60;
        let isAuthenticated = false; // ì‹¬íŒ ì¸ì¦ ì—¬ë¶€
        let isPaused = false; // ê²½ê¸° ì¼ì‹œì •ì§€ ìƒíƒœ
        let warmupActive = false; // ì›Œë°ì—… ì§„í–‰ ìƒíƒœ
        let warmupSeconds = 60; // ì›Œë°ì—… ë‚¨ì€ ì‹œê°„ (IBSA: ê°œì¸ì „ 60ì´ˆ)
        let warmupTimer = null; // ì›Œë°ì—… íƒ€ì´ë¨¸
        let pauseTimer = null; // ì¼ì‹œì •ì§€ íƒ€ì´ë¨¸
        let pauseSeconds = 0; // ì¼ì‹œì •ì§€ ê²½ê³¼ ì‹œê°„
        let isOffline = !navigator.onLine; // ì˜¤í”„ë¼ì¸ ìƒíƒœ
        let userRole = null; // 'referee' ë˜ëŠ” 'viewer'
        
        // ì˜¤í”„ë¼ì¸ ê°ì§€
        window.addEventListener('online', () => {
            isOffline = false;
            syncOfflineData();
            announce('ì˜¨ë¼ì¸ ì—°ê²°ë¨. ë°ì´í„° ë™ê¸°í™” ì¤‘...');
        });
        window.addEventListener('offline', () => {
            isOffline = true;
            announce('ì˜¤í”„ë¼ì¸ ëª¨ë“œ. ë¡œì»¬ì— ì €ì¥ë©ë‹ˆë‹¤.');
        });
        
        // ì˜¤í”„ë¼ì¸ ë°ì´í„° ë™ê¸°í™”
        function syncOfflineData() {
            try {
                const offlineData = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
                if (offlineData.length > 0 && database) {
                    offlineData.forEach(item => {
                        if (item.type === 'project') {
                            database.ref('projects/' + item.key).set(item.data);
                        }
                    });
                    localStorage.removeItem('offlineQueue');
                    console.log('ì˜¤í”„ë¼ì¸ ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ');
                }
            } catch (error) {
                console.error('ì˜¤í”„ë¼ì¸ ë°ì´í„° ë™ê¸°í™” ì˜¤ë¥˜:', error);
                localStorage.removeItem('offlineQueue'); // ì†ìƒëœ ë°ì´í„° ì œê±°
            }
        }
        
        // Firebaseì—ì„œ í”„ë¡œì íŠ¸ ë¡œë“œ
        let isUserAction = false; // ì‚¬ìš©ì ì•¡ì…˜ ì¤‘ í”Œë˜ê·¸
        
        let matchSelectionInProgress = false; // ê²½ê¸° ì„ íƒ ì¤‘ í”Œë˜ê·¸
        
        function loadProjects() {
            try {
                if (!database) {
                    console.log('Firebase ë¯¸ì—°ê²° - ë¡œì»¬ ëª¨ë“œ');
                    try {
                        projects = JSON.parse(localStorage.getItem('projects') || '[]');
                    } catch (parseError) {
                        console.error('ë¡œì»¬ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', parseError);
                        projects = [];
                        localStorage.removeItem('projects'); // ì†ìƒëœ ë°ì´í„° ì œê±°
                    }
                    checkUrlProjectParam();
                    render();
                    return;
                }
                console.log('Firebaseì—ì„œ í”„ë¡œì íŠ¸ ë¡œë“œ ì¤‘...');
                
                let isFirstLoad = true;
                database.ref('projects').on('value', (snapshot) => {
                    const data = snapshot.val();
                    projects = data ? Object.keys(data).map(key => ({...data[key], firebaseKey: key})) : [];
                    console.log('ë¡œë“œëœ í”„ë¡œì íŠ¸:', projects.length);
                    
                    // ì²« ë¡œë“œì‹œ URL íŒŒë¼ë¯¸í„° í™•ì¸
                    if (isFirstLoad) {
                        isFirstLoad = false;
                        checkUrlProjectParam();
                        render();
                        return;
                    }
                    
                    // ê²½ê¸° ì„ íƒ ì¤‘ì´ë©´ ë Œë”ë§ ì•ˆ í•¨
                    if (matchSelectionInProgress || isUserAction) {
                        return;
                    }
                    
                    // í˜„ì¬ í”„ë¡œì íŠ¸/ê²½ê¸° ë°ì´í„° ê°±ì‹ 
                    if (currentProject && currentProject.firebaseKey) {
                        const updatedProject = projects.find(p => p.firebaseKey === currentProject.firebaseKey);
                        if (updatedProject) {
                            currentProject = updatedProject;
                            if (currentMatch && currentProject.matches) {
                                const matchIndex = currentProject.matches.findIndex(m => m.id === currentMatch.id);
                                if (matchIndex >= 0) {
                                    currentMatch = currentProject.matches[matchIndex];
                                }
                            }
                        }
                    }
                    
                    // match í™”ë©´ - ê´€ëŒ ëª¨ë“œì¼ ë•Œë§Œ ì‹¤ì‹œê°„ ê°±ì‹ 
                    if (screen === 'match' && currentMatch) {
                        if (!isAuthenticated) {
                            // ê´€ëŒ ëª¨ë“œ - ì‹¤ì‹œê°„ ì ìˆ˜ ê°±ì‹ 
                            renderMatch();
                        }
                        // ì‹¬íŒ ëª¨ë“œëŠ” ë“ì  ì…ë ¥ ì‹œ ì§ì ‘ ë Œë”ë§í•˜ë¯€ë¡œ ë¬´ì‹œ
                        return;
                    }
                    
                    // project-detail í™”ë©´ë„ ë¬´ì‹œ (ê²½ê¸° ì§„ì… ë°©í•´ ë°©ì§€)
                    if (screen === 'project-detail') {
                        return;
                    }
                    
                    // ë‚˜ë¨¸ì§€ í™”ë©´ë§Œ ìë™ ê°±ì‹ 
                    render();
                });
            } catch (error) {
                console.log('Firebase ë¡œë“œ ì‹¤íŒ¨ - ë¡œì»¬ ëª¨ë“œ:', error);
                try {
                    projects = JSON.parse(localStorage.getItem('projects') || '[]');
                } catch (parseError) {
                    console.error('ë¡œì»¬ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', parseError);
                    projects = [];
                }
                checkUrlProjectParam();
                render();
            }
        }
        
        // URL íŒŒë¼ë¯¸í„°ë¡œ í”„ë¡œì íŠ¸ ì§ì ‘ ì ‘ì†
        function checkUrlProjectParam() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project');
            
            if (projectId) {
                const projectIndex = projects.findIndex(p => String(p.id) === String(projectId));
                if (projectIndex >= 0) {
                    // í”„ë¡œì íŠ¸ ë°œê²¬ - ë°”ë¡œ ì—´ê¸°
                    currentProject = projects[projectIndex];
                    userRole = 'viewer'; // ê´€ëŒ ëª¨ë“œë¡œ ì ‘ì†
                    screen = 'viewer-results';
                    console.log('URL íŒŒë¼ë¯¸í„°ë¡œ í”„ë¡œì íŠ¸ ì ‘ì†:', currentProject.name);
                    
                    // URL íŒŒë¼ë¯¸í„° ì œê±° (íˆìŠ¤í† ë¦¬ ì •ë¦¬)
                    window.history.replaceState({}, '', window.location.pathname);
                }
            }
        }
        
        // Firebaseì— í”„ë¡œì íŠ¸ ì €ì¥ (ì˜¤í”„ë¼ì¸ ì§€ì›)
        function saveProjects() {
            // í•­ìƒ ë¡œì»¬ì— ì €ì¥ (ì˜¤í”„ë¼ì¸ ë°±ì—…)
            localStorage.setItem('projects', JSON.stringify(projects));
            
            try {
                if (database && currentProject && currentProject.firebaseKey && !isOffline) {
                    database.ref('projects/' + currentProject.firebaseKey).set(currentProject);
                    console.log('âœ… Firebase ì €ì¥ ì™„ë£Œ');
                } else if (isOffline && currentProject && currentProject.firebaseKey) {
                    // ì˜¤í”„ë¼ì¸ íì— ì¶”ê°€
                    const queue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
                    queue.push({
                        type: 'project',
                        key: currentProject.firebaseKey,
                        data: currentProject,
                        timestamp: Date.now()
                    });
                    localStorage.setItem('offlineQueue', JSON.stringify(queue));
                    console.log('ğŸ“´ ì˜¤í”„ë¼ì¸ íì— ì €ì¥ë¨');
                } else {
                    console.log('âœ… ë¡œì»¬ ì €ì¥ ì™„ë£Œ');
                }
            } catch (error) {
                console.error('ì €ì¥ ì—ëŸ¬:', error);
            }
        }
        
        // ì´ˆê¸° ë¡œë“œ
        setTimeout(() => {
            loadProjects();
            loadUserPreferences(); // ì‚¬ìš©ì ì„¤ì • ë¡œë“œ
            loadPracticeMatchesFromFirebase(); // âœ¨ Firebase ì—°ìŠµ ê²½ê¸° ë¡œë“œ
        }, 1000);


        const FOULS = [
            { id: 'irregular-serve', name: 'ë¶€ì • ì„œë¸Œ', points: 1 },
            { id: 'centerboard', name: 'ì„¼í„°ë³´ë“œ', points: 1 },
            { id: 'body-touch', name: 'ë°”ë””í„°ì¹˜', points: 1 },
            { id: 'out', name: 'ì•„ì›ƒ', points: 1 },
            { id: 'mask-touch', name: 'ê³ ê¸€í„°ì¹˜', points: 2 },
            { id: 'delay', name: 'ì§€ì—°í–‰ìœ„', points: 1 },
            { id: '2-second', name: '2ì´ˆë£°', points: 1 }
        ];

        function render() {
            const app = document.getElementById('app');
            
            // ì˜¤í”„ë¼ì¸ ìƒíƒœ í‘œì‹œ
            const offlineIndicator = isOffline ? 
                '<div style="background:#ff9800; color:white; padding:8px 16px; text-align:center; font-size:14px; margin-bottom:16px; border-radius:8px;">ğŸ“´ ì˜¤í”„ë¼ì¸ ëª¨ë“œ - ë°ì´í„°ê°€ ë¡œì»¬ì— ì €ì¥ë©ë‹ˆë‹¤</div>' : '';
            
            if (screen === 'home') {
                app.innerHTML = `
                    ${offlineIndicator}
                    <div class="header">
                        <h1>âš« ì‡¼ë‹¤ìš´ ì‹¬íŒ ì•± PRO</h1>
                        <p>ëŒ€ì§„ ì„¤ì • Â· ì‹¬íŒ Â· ê´€ëŒ</p>
                    </div>
                    <div class="card">
                        <h2>ëª¨ë“œ ì„ íƒ</h2>
                        <p style="color:var(--text-secondary); margin-bottom:16px;">ì‚¬ìš© ëª©ì ì— ë§ëŠ” ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                        
                        <button type="button" role="button" class="btn btn-primary" onclick="enterBracketMode()" style="background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%); margin-bottom:8px;" aria-label="ëŒ€ì§„ ì„¤ì • ëª¨ë“œ - ëŒ€íšŒ ìƒì„±, ì¡°í¸ì„±, í† ë„ˆë¨¼íŠ¸">
                            ğŸ† ëŒ€ì§„ ì„¤ì •
                        </button>
                        <p style="font-size:14px; color:var(--text-secondary); margin-bottom:20px;">
                            ëŒ€íšŒ ìƒì„±, ì¡°í¸ì„±, í† ë„ˆë¨¼íŠ¸ (ìš´ì˜ììš©)
                        </p>
                        
                        <button type="button" role="button" class="btn btn-primary" onclick="selectRole('referee')" style="background:var(--success); margin-bottom:8px;" aria-label="ì‹¬íŒ ëª¨ë“œ ì„ íƒ - ê²½ê¸° ì§„í–‰, ë“ì  ì…ë ¥">
                            ğŸ” ì‹¬íŒ ëª¨ë“œ
                        </button>
                        <p style="font-size:14px; color:var(--text-secondary); margin-bottom:20px;">
                            ê²½ê¸° ì§„í–‰, ë“ì  ì…ë ¥
                        </p>
                        
                        <button type="button" role="button" class="btn btn-primary" onclick="selectRole('viewer')" style="background:var(--primary);" aria-label="ê´€ëŒ ëª¨ë“œ ì„ íƒ - ì‹¤ì‹œê°„ ì ìˆ˜ í™•ì¸, ê²½ê¸° ê¸°ë¡ ë³´ê¸°">
                            ğŸ‘ï¸ ê´€ëŒ ëª¨ë“œ
                        </button>
                        <p style="font-size:14px; color:var(--text-secondary); margin-top:8px;">
                            ì‹¤ì‹œê°„ ì ìˆ˜ í™•ì¸, ê²½ê¸° ê¸°ë¡ ë³´ê¸°
                        </p>
                    </div>
                `;
            }
            else if (screen === 'referee-home') {
                // ìµœê·¼ ê²½ê¸° ê¸°ë¡ ìˆ˜
                const practiceHistory = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
                const recentCount = practiceHistory.length;
                
                app.innerHTML = `
                    <div class="header">
                        <h1>ğŸ” ì‹¬íŒ ëª¨ë“œ</h1>
                        <p>ê²½ê¸° ì§„í–‰ Â· ë“ì  ì…ë ¥</p>
                    </div>
                    
                    <div class="card">
                        <h2>ğŸ“‚ ëŒ€íšŒ ê²½ê¸°</h2>
                        <p style="font-size:13px; color:var(--text-secondary); margin-bottom:12px;">ëŒ€ì§„ ì„¤ì •ì—ì„œ ìƒì„±ëœ ëŒ€íšŒì˜ ê²½ê¸°ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.</p>
                        <button type="button" role="button" class="btn btn-primary" onclick="goTo('project-list')" aria-label="í”„ë¡œì íŠ¸ ëª©ë¡ ë³´ê¸°">
                            ğŸ“‚ ëŒ€íšŒ/ê²½ê¸° ëª©ë¡
                        </button>
                    </div>
                    
                    <div class="card" style="background:linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color:white;">
                        <h2 style="color:white;">â• ë¹ ë¥¸ í”„ë¡œì íŠ¸</h2>
                        <p style="font-size:13px; margin-bottom:12px; opacity:0.9;">ì†Œê·œëª¨ ëŒ€íšŒë‚˜ ì—°ìŠµìš© í”„ë¡œì íŠ¸ë¥¼ ë¹ ë¥´ê²Œ ìƒì„±í•©ë‹ˆë‹¤.</p>
                        <button type="button" class="btn" onclick="goTo('quick-project')" style="background:white; color:#2e7d32; width:100%;" aria-label="ë¹ ë¥¸ í”„ë¡œì íŠ¸ ìƒì„±">
                            â• ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±
                        </button>
                    </div>
                    
                    <div class="card" style="background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%); color:white;">
                        <h2 style="color:white;">ğŸ¯ ì—°ìŠµ ê²½ê¸°</h2>
                        <p style="font-size:13px; margin-bottom:12px; opacity:0.9;">í”„ë¡œì íŠ¸ ì—†ì´ ë°”ë¡œ ê²½ê¸°ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.</p>
                        <button type="button" class="btn" onclick="goTo('practice-mode')" style="background:white; color:#ff5722; width:100%;" aria-label="ì—°ìŠµ ê²½ê¸° ì‹œì‘">
                            ğŸ¯ ì—°ìŠµ ê²½ê¸° ì‹œì‘
                        </button>
                    </div>
                    
                    <div class="card">
                        <h2>ğŸ“‹ ê²½ê¸° ê¸°ë¡</h2>
                        <p style="font-size:13px; color:var(--text-secondary); margin-bottom:12px;">ì €ì¥ëœ ì—°ìŠµ ê²½ê¸° ê¸°ë¡ ${recentCount}ê±´</p>
                        <button type="button" class="btn" onclick="goTo('practice-history')" aria-label="ê²½ê¸° ê¸°ë¡ ë³´ê¸°">
                            ğŸ“‹ ê¸°ë¡ ë³´ê¸°
                        </button>
                    </div>
                    
                    <div class="card">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px;">
                            <button type="button" class="btn" onclick="changeRefereePassword()" style="background:#2196f3; color:white;" aria-label="ë¹„ë°€ë²ˆí˜¸ ë³€ê²½">ğŸ” ë¹„ë°€ë²ˆí˜¸</button>
                            <button type="button" class="btn" onclick="logout()" style="background:#666; color:white;" aria-label="ë¡œê·¸ì•„ì›ƒ">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
                        </div>
                        <button type="button" role="button" class="btn" onclick="goTo('home')" aria-label="ëª¨ë“œ ì„ íƒ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°">â† ëª¨ë“œ ì„ íƒìœ¼ë¡œ</button>
                    </div>
                `;
            }
            else if (screen === 'bracket-home') {
                // ëŒ€ì§„ ì„¤ì • ëª¨ë“œ í™ˆ
                const tournamentList = projects.filter(p => p.tournamentType).map((p, i) => {
                    const actualIndex = projects.indexOf(p);
                    const matchCount = p.matches?.length || 0;
                    const completedCount = p.matches?.filter(m => m.status === 'completed').length || 0;
                    const formatName = p.tournamentType === 'group-only' ? 'ì¡°ë³„ ë¦¬ê·¸' : 
                                       p.tournamentType === 'group-knockout' ? 'ì¡°ë³„+í† ë„ˆë¨¼íŠ¸' : 'í† ë„ˆë¨¼íŠ¸';
                    return `
                        <div style="padding:16px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; cursor:pointer; border-left:4px solid #1976d2;" onclick="openBracketProject(${actualIndex})">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong>${p.name}</strong>
                                <span style="font-size:12px; background:#e3f2fd; color:#1976d2; padding:2px 8px; border-radius:4px;">${formatName}</span>
                            </div>
                            <div style="font-size:13px; color:var(--text-secondary); margin-top:4px;">
                                ${matchCount}ê²½ê¸° ì¤‘ ${completedCount}ê²½ê¸° ì™„ë£Œ
                            </div>
                        </div>
                    `;
                }).join('') || '<p style="text-align:center; color:var(--text-secondary); padding:20px;">ìƒì„±ëœ ëŒ€íšŒê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);">
                        <h1 style="color:white;">ğŸ† ëŒ€ì§„ ì„¤ì •</h1>
                        <p style="color:rgba(255,255,255,0.9);">ëŒ€íšŒ ìƒì„± Â· ì¡°í¸ì„± Â· ìˆ˜ì •</p>
                    </div>
                    <div class="card">
                        <button type="button" class="btn btn-primary" onclick="goTo('tournament-wizard')" style="width:100%; background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);" aria-label="ìƒˆ ëŒ€íšŒ ë§Œë“¤ê¸°">
                            â• ìƒˆ ëŒ€íšŒ ë§Œë“¤ê¸°
                        </button>
                    </div>
                    <div class="card">
                        <h3>ğŸ“‹ ëŒ€íšŒ ëª©ë¡</h3>
                        ${tournamentList}
                    </div>
                    <div class="card">
                        <h3>ğŸ‘¥ ì‹¬íŒ ê´€ë¦¬</h3>
                        <p style="font-size:13px; color:var(--text-secondary); margin-bottom:12px;">ì‹¬íŒ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¶”ê°€/ì‚­ì œí•©ë‹ˆë‹¤</p>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <button type="button" class="btn btn-success" onclick="addRefereePassword()" style="width:100%;" aria-label="ì‹¬íŒ ì¶”ê°€">â• ì‹¬íŒ ì¶”ê°€</button>
                            <button type="button" class="btn btn-danger" onclick="deleteRefereePassword()" style="width:100%;" aria-label="ì‹¬íŒ ì‚­ì œ">ğŸ—‘ï¸ ì‹¬íŒ ì‚­ì œ</button>
                        </div>
                    </div>
                    <div class="card">
                        <button type="button" class="btn" onclick="goTo('home')" aria-label="ëª¨ë“œ ì„ íƒìœ¼ë¡œ">â† ëª¨ë“œ ì„ íƒìœ¼ë¡œ</button>
                    </div>
                `;
            }
            else if (screen === 'bracket-detail') {
                // ëŒ€ì§„ ì„¤ì • ìƒì„¸ (ìˆ˜ì • ê°€ëŠ¥)
                if (!currentProject) {
                    goTo('bracket-home');
                    return;
                }
                
                const p = currentProject;
                const isTeam = p.competitionType === 'team';
                const unitName = isTeam ? 'íŒ€' : 'ëª…';
                const formatName = p.tournamentType === 'group-only' ? 'ì¡°ë³„ ë¦¬ê·¸ë§Œ' : 
                                   p.tournamentType === 'group-knockout' ? 'ì¡°ë³„ ë¦¬ê·¸ + í† ë„ˆë¨¼íŠ¸' : 'í† ë„ˆë¨¼íŠ¸ë§Œ';
                
                // ëŒ€íšŒ ê·œì¹™ í‘œì‹œ
                const rulesHTML = p.rules ? `
                    <div style="background:#e3f2fd; padding:12px; border-radius:8px; margin-bottom:16px;">
                        <div style="font-weight:600; margin-bottom:8px;">ğŸ“‹ ëŒ€íšŒ ê·œì¹™</div>
                        <div style="font-size:13px; white-space:pre-wrap;">${p.rules}</div>
                    </div>
                ` : '';
                
                // ì„¸íŠ¸ ìˆ˜ ì •ë³´
                const setsInfo = [];
                if (p.preliminarySets && p.tournamentType !== 'knockout-only') {
                    setsInfo.push(`ì˜ˆì„  ${p.preliminarySets}ì„¸íŠ¸`);
                }
                if (p.finalsSets && p.tournamentType !== 'group-only') {
                    setsInfo.push(`ë³¸ì„  ${p.finalsSets}ì„¸íŠ¸`);
                }
                const setsHTML = setsInfo.length > 0 ? `
                    <span style="background:#fff3e0; padding:4px 12px; border-radius:16px; font-size:13px;">${setsInfo.join(' / ')}</span>
                ` : '';
                
                // ì¡°ë³„ ë¦¬ê·¸ í‘œì‹œ
                let groupsHTML = '';
                if (p.groups && p.groups.length > 0) {
                    groupsHTML = `
                        <h3>ğŸ“Š ì¡° í¸ì„±</h3>
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:16px;">
                            ${p.groups.map((g, gIdx) => `
                                <div style="background:#f5f5f5; padding:12px; border-radius:8px;">
                                    <div style="font-weight:600; margin-bottom:8px; color:#1976d2; display:flex; justify-content:space-between;">
                                        <span>${g.name}</span>
                                        <button class="btn" onclick="editGroup(${gIdx})" style="padding:2px 8px; min-width:auto; font-size:12px;">âœï¸ ìˆ˜ì •</button>
                                    </div>
                                    ${g.members.map((m, i) => `<div style="font-size:13px; padding:4px 0;">${i+1}. ${m}</div>`).join('')}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // ê²½ê¸° ëª©ë¡
                let matchesHTML = '';
                if (p.matches && p.matches.length > 0) {
                    const pendingMatches = p.matches.filter(m => m.status !== 'completed');
                    const completedMatches = p.matches.filter(m => m.status === 'completed');
                    
                    matchesHTML = `
                        <h3>âš”ï¸ ê²½ê¸° ëª©ë¡ (${p.matches.length}ê²½ê¸°)</h3>
                        <div style="max-height:400px; overflow-y:auto;">
                            ${pendingMatches.length > 0 ? `
                                <div style="font-size:13px; color:#666; margin-bottom:8px;">ëŒ€ê¸° ì¤‘ (${pendingMatches.length})</div>
                                ${pendingMatches.slice(0, 15).map(m => `
                                    <div style="padding:10px; margin:4px 0; background:#fff3e0; border-radius:6px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
                                        <span style="flex:1;">${m.groupName ? `[${m.groupName}] ` : ''}${m.player1Name} vs ${m.player2Name}</span>
                                        <div style="display:flex; gap:4px;">
                                            <button class="btn btn-primary" onclick="startMatchFromBracket(${m.id})" style="padding:4px 10px; min-width:auto; font-size:12px;">â–¶ï¸ ì‹œì‘</button>
                                            <button class="btn" onclick="editMatch(${m.id})" style="padding:4px 8px; min-width:auto; font-size:12px;">âœï¸</button>
                                        </div>
                                    </div>
                                `).join('')}
                                ${pendingMatches.length > 15 ? `<div style="text-align:center; color:#666; padding:8px;">...ì™¸ ${pendingMatches.length - 15}ê²½ê¸°</div>` : ''}
                            ` : ''}
                            ${completedMatches.length > 0 ? `
                                <div style="font-size:13px; color:#666; margin:12px 0 8px 0;">ì™„ë£Œë¨ (${completedMatches.length})</div>
                                ${completedMatches.slice(0, 5).map(m => {
                                    const score = m.setScores.map(s => `${s.player1}-${s.player2}`).join(', ');
                                    return `
                                        <div style="padding:10px; margin:4px 0; background:#e8f5e9; border-radius:6px;">
                                            <span>${m.groupName ? `[${m.groupName}] ` : ''}${m.player1Name} vs ${m.player2Name}</span>
                                            <span style="float:right; font-size:12px; color:#666;">${score}</span>
                                        </div>
                                    `;
                                }).join('')}
                            ` : ''}
                        </div>
                    `;
                }
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('bracket-home')" style="margin-bottom:16px;">â† ëŒ€íšŒ ëª©ë¡</button>
                        
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:16px;">
                            <div>
                                <h2 style="margin:0;">${p.name}</h2>
                                <div style="font-size:13px; color:var(--text-secondary); margin-top:4px;">
                                    ${p.date || ''} ${p.location ? 'Â· ' + p.location : ''}
                                </div>
                            </div>
                            <button class="btn" onclick="editTournamentInfo()" style="padding:4px 12px;">âœï¸ ìˆ˜ì •</button>
                        </div>
                        
                        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px;">
                            <span style="background:#e3f2fd; color:#1976d2; padding:4px 12px; border-radius:16px; font-size:13px;">${formatName}</span>
                            <span style="background:#f5f5f5; padding:4px 12px; border-radius:16px; font-size:13px;">${isTeam ? 'íŒ€ì „' : 'ê°œì¸ì „'}</span>
                            ${setsHTML}
                            <span style="background:#f5f5f5; padding:4px 12px; border-radius:16px; font-size:13px;">ğŸ”‘ ${p.bracketPin || 'ì—†ìŒ'}</span>
                        </div>
                        
                        ${rulesHTML}
                        ${groupsHTML}
                        ${matchesHTML}
                        
                        <div style="margin-top:20px; padding-top:16px; border-top:1px solid #eee;">
                            <button class="btn" onclick="shuffleGroups()" style="margin-right:8px;">ğŸ”€ ì¡° ë‹¤ì‹œ ì„ê¸°</button>
                            <button class="btn btn-danger" onclick="deleteTournament()">ğŸ—‘ï¸ ëŒ€íšŒ ì‚­ì œ</button>
                        </div>
                    </div>
                `;
            }
            else if (screen === 'bracket-password') {
                // ëŒ€ì§„ ì„¤ì • ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);">
                        <h1 style="color:white;">ğŸ† ëŒ€ì§„ ì„¤ì •</h1>
                        <p style="color:rgba(255,255,255,0.9);">ìš´ì˜ì ì¸ì¦</p>
                    </div>
                    <div class="card">
                        <div style="text-align:center; margin-bottom:20px;">
                            <span style="font-size:48px;">ğŸ”</span>
                            <h3>ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
                            <p style="color:var(--text-secondary); font-size:14px;">ëŒ€ì§„ ì„¤ì •ì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                        </div>
                        
                        <div class="form-group">
                            <label>ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="bracket-pin" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" style="width:100%;">
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="verifyBracketPin()" style="width:100%;">í™•ì¸</button>
                        
                        <div style="margin-top:20px; padding-top:16px; border-top:1px solid #eee;">
                            <p style="font-size:13px; color:var(--text-secondary); text-align:center;">
                                ì²˜ìŒì´ì‹ ê°€ìš”? ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì„¸ìš”.
                            </p>
                            <button type="button" class="btn" onclick="goTo('bracket-set-password')" style="width:100%;">ğŸ†• ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</button>
                        </div>
                        
                        <button type="button" class="btn" onclick="goTo('home')" style="width:100%; margin-top:12px;">â† ëª¨ë“œ ì„ íƒìœ¼ë¡œ</button>
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('bracket-pin')?.focus();
                    document.getElementById('bracket-pin')?.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') verifyBracketPin();
                    });
                }, 100);
            }
            else if (screen === 'bracket-set-password') {
                // ëŒ€ì§„ ì„¤ì • ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);">
                        <h1 style="color:white;">ğŸ† ëŒ€ì§„ ì„¤ì •</h1>
                        <p style="color:rgba(255,255,255,0.9);">ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</p>
                    </div>
                    <div class="card">
                        <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>âš ï¸ ì¤‘ìš”</strong>
                            <p style="font-size:13px; margin-top:4px;">ì´ ë¹„ë°€ë²ˆí˜¸ëŠ” ëŒ€ì§„ ì„¤ì • ëª¨ë“œ ì ‘ê·¼ì— ì‚¬ìš©ë©ë‹ˆë‹¤. ìŠì–´ë²„ë¦¬ì§€ ì•Šë„ë¡ ê¸°ì–µí•´ì£¼ì„¸ìš”.</p>
                        </div>
                        
                        <div style="background:#e3f2fd; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ì¡°ê±´</strong>
                            <ul style="font-size:13px; margin:8px 0 0 0; padding-left:20px;">
                                <li>8ì ì´ìƒ</li>
                                <li>ì˜ë¬¸ ëŒ€ë¬¸ì 1ê°œ ì´ìƒ</li>
                                <li>ì˜ë¬¸ ì†Œë¬¸ì 1ê°œ ì´ìƒ</li>
                                <li>ìˆ«ì 1ê°œ ì´ìƒ</li>
                                <li>íŠ¹ìˆ˜ë¬¸ì 1ê°œ ì´ìƒ (!@#$%^&*)</li>
                            </ul>
                        </div>
                        
                        <div class="form-group">
                            <label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="new-bracket-pin" placeholder="ì˜ˆ: Showdown@2024" style="width:100%;" oninput="checkPasswordStrength()">
                            <div id="pw-strength" style="margin-top:8px; font-size:13px;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                            <input type="password" id="confirm-bracket-pin" placeholder="ë¹„ë°€ë²ˆí˜¸ ì¬ì…ë ¥" style="width:100%;">
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="setBracketPin()" style="width:100%;">ë¹„ë°€ë²ˆí˜¸ ì„¤ì •</button>
                        <button type="button" class="btn" onclick="goTo('bracket-password')" style="width:100%; margin-top:8px;">â† ëŒì•„ê°€ê¸°</button>
                    </div>
                `;
            }
            else if (screen === 'referee-password') {
                // ì‹¬íŒ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
                const refPasswords = JSON.parse(localStorage.getItem('refereePasswords') || '{}');
                const refPins = Object.keys(refPasswords);
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #34a853 0%, #1b5e20 100%);">
                        <h1 style="color:white;">ğŸ” ì‹¬íŒ ëª¨ë“œ</h1>
                        <p style="color:rgba(255,255,255,0.9);">ì‹¬íŒ ì¸ì¦</p>
                    </div>
                    <div class="card">
                        <div style="text-align:center; margin-bottom:20px;">
                            <span style="font-size:48px;">ğŸ”</span>
                            <h3>ì‹¬íŒ ì¸ì¦</h3>
                            <p style="color:var(--text-secondary); font-size:14px;">ì‹¬íŒ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                        </div>
                        
                        <div class="form-group">
                            <label>ì‹¬íŒ PIN *</label>
                            <select id="referee-pin" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:6px;">
                                <option value="">ì‹¬íŒ ì„ íƒ...</option>
                                ${refPins.map(pin => `<option value="${pin}">${pin}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="referee-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" style="width:100%;">
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="verifyRefereePassword()" style="width:100%;">ì¸ì¦</button>
                        
                        <button type="button" class="btn" onclick="goTo('home')" style="width:100%; margin-top:12px;">â† ëª¨ë“œ ì„ íƒìœ¼ë¡œ</button>
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('referee-pin')?.focus();
                    document.getElementById('referee-password')?.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') verifyRefereePassword();
                    });
                }, 100);
            }
            else if (screen === 'viewer-home') {
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h1>ğŸ‘ï¸ ê´€ëŒ ëª¨ë“œ</h1>
                        <p>ì‹¤ì‹œê°„ ì ìˆ˜ Â· ì¼ì • ì¡°íšŒ Â· ê²°ê³¼ í™•ì¸</p>
                    </div>
                    <div class="card">
                        <div style="background:#e3f2fd; border-left:4px solid #2196f3; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>âš¡ ğŸ” ê²½ê¸° ê²€ìƒ‰</strong><br>
                            <span style="font-size:14px;">ì„ ìˆ˜ëª…ìœ¼ë¡œ ê²½ê¸°ë¥¼ ê²€ìƒ‰í•˜ê³  ì¦ê²¨ì°¾ê¸° Â· ì•Œë¦¼ì„ ì„¤ì •í•©ë‹ˆë‹¤.</span>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="goTo('match-list')" style="width:100%; margin-bottom:16px;" aria-label="ê²½ê¸° ê²€ìƒ‰ ë° ì¦ê²¨ì°¾ê¸°">
                            ğŸ” ê²½ê¸° ê²€ìƒ‰ (NEW!)
                        </button>
                        
                        <div style="background:#e3f2fd; border-left:4px solid #2196f3; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>âš¡ ì‹¤ì‹œê°„ ì ìˆ˜ í™•ì¸</strong><br>
                            <span style="font-size:14px;">ì§„í–‰ ì¤‘ì¸ ê²½ê¸°ì˜ ì ìˆ˜ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•©ë‹ˆë‹¤.</span>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="goTo('project-list')" style="width:100%; margin-bottom:16px;" aria-label="ì‹¤ì‹œê°„ ê²½ê¸° ì ìˆ˜ í™•ì¸">
                            ğŸ“Š ì‹¤ì‹œê°„ ê²½ê¸° ë³´ê¸°
                        </button>
                        
                        <div style="background:#fff3e0; border-left:4px solid #ff9800; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>ğŸ“… ë‚´ ì¼ì • ì¡°íšŒ</strong><br>
                            <span style="font-size:14px;">ì´ë¦„ìœ¼ë¡œ ë‚´ ê²½ê¸° ì¼ì •ê³¼ ìƒëŒ€ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</span>
                        </div>
                        <button type="button" class="btn" onclick="goTo('player-schedule')" style="width:100%; margin-bottom:16px; background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%); color:white;" aria-label="ë‚´ ì¼ì • ì¡°íšŒ">
                            ğŸ“… ë‚´ ì¼ì • ì¡°íšŒ
                        </button>
                        
                        <div style="background:#e8f5e9; border-left:4px solid #4caf50; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>ğŸ“‹ ëŒ€íšŒ ê²°ê³¼ í™•ì¸</strong><br>
                            <span style="font-size:14px;">ì¡°ë³„ ìˆœìœ„, í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ, ê°œì¸ ê¸°ë¡ì„ í™•ì¸í•©ë‹ˆë‹¤.</span>
                        </div>
                        <button type="button" class="btn" onclick="goTo('viewer-select-project')" style="width:100%; margin-bottom:16px;" aria-label="ëŒ€íšŒ ê²°ê³¼ í™•ì¸">
                            ğŸ† ëŒ€íšŒ ê²°ê³¼ ë³´ê¸°
                        </button>
                        
                        <button type="button" class="btn" onclick="goTo('home')" style="margin-top:8px;" aria-label="ëª¨ë“œ ì„ íƒ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°">â† ëª¨ë“œ ì„ íƒìœ¼ë¡œ</button>
                    </div>
                `;
            }
            // ========== ğŸ“‹ ì‹¤ì‹œê°„ ê²½ê¸° ê²€ìƒ‰ (ê´€ëŒê° ëª¨ë“œ) ==========
            else if (screen === 'match-list') {
                // âœ¨ íƒ­ ìƒíƒœ ì´ˆê¸°í™”
                if (!window.viewerTab) window.viewerTab = 'actual';
                
                const tabStyle = (tab) => `
                    padding:12px 16px; 
                    cursor:pointer; 
                    border:none; 
                    background:${window.viewerTab === tab ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#e0e0e0'}; 
                    color:${window.viewerTab === tab ? 'white' : '#333'}; 
                    border-radius:6px; 
                    font-weight:600;
                    flex:1;
                `;
                
                app.innerHTML = `
                    <div class="header" style="display:flex; justify-content:space-between; align-items:center; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div style="color:white;">
                            <button class="btn" onclick="goTo('viewer-home')" style="padding:8px 12px; margin-right:12px; background:rgba(255,255,255,0.2); color:white;">â¬…ï¸ ëŒì•„ê°€ê¸°</button>
                            <h1 style="display:inline; color:white;">ğŸ‘ï¸ ì‹¤ì‹œê°„ ê²½ê¸° í˜„í™©</h1>
                        </div>
                        <button class="btn" onclick="toggleNotifications()" style="background:#ff9800; color:white; padding:10px 14px; border-radius:6px; font-size:18px;" aria-label="ì‹¤ì‹œê°„ ì•Œë¦¼ ì„¤ì •">ğŸ””</button>
                    </div>
                    
                    <div class="card" style="margin-bottom:10px;">
                        <div style="position:relative; margin-bottom:12px;">
                            <input type="text" id="viewer-search" placeholder="ğŸ” ì„ ìˆ˜ëª… ë˜ëŠ” ê²½ê¸°ì¥ ê²€ìƒ‰..." 
                                   oninput="renderViewerResults()" 
                                   style="width:100%; padding:14px; border-radius:10px; border:2px solid #667eea; box-sizing:border-box; font-size:14px;"
                                   aria-label="ì„ ìˆ˜ëª… ë˜ëŠ” ê²½ê¸°ì¥ìœ¼ë¡œ ê²½ê¸° ê²€ìƒ‰">
                            <button onclick="clearSearch()" style="position:absolute; right:12px; top:14px; border:none; background:none; cursor:pointer; font-size:20px; color:#666;" aria-label="ê²€ìƒ‰ì–´ ì´ˆê¸°í™”">âŒ</button>
                        </div>
                        
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <button class="btn" onclick="filterFavoritesOnly()" style="flex:1; min-width:140px; padding:12px; background:#f1c40f; color:#333; border:none; border-radius:6px; font-weight:600;" aria-label="ì¦ê²¨ì°¾ê¸°í•œ ê²½ê¸°ë§Œ í‘œì‹œ">â­ ì¦ê²¨ì°¾ê¸°ë§Œ</button>
                            <button class="btn" onclick="renderViewerResults()" style="flex:1; min-width:140px; padding:12px; background:#e0e0e0; color:#333; border:none; border-radius:6px; font-weight:600;" aria-label="ëª¨ë“  ê²½ê¸° í‘œì‹œ">ğŸ“‹ ì „ì²´ë³´ê¸°</button>
                        </div>
                        
                        <div style="display:flex; gap:8px; margin-top:12px; border-top:1px solid #e0e0e0; padding-top:12px;">
                            <button onclick="switchViewerTab('actual')" style="${tabStyle('actual')}">
                                ğŸ† ì‹¤ì œ ê²½ê¸°
                            </button>
                            <button onclick="switchViewerTab('practice')" style="${tabStyle('practice')}">
                                ğŸ‹ï¸ ì—°ìŠµ ê²½ê¸°
                            </button>
                        </div>
                    </div>
                    
                    <div id="viewer-results-container" style="padding:0 16px; margin-bottom:20px;">
                        <!-- ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— ë Œë”ë§ë¨ -->
                    </div>
                `;
                renderViewerResults();
                return;
            }
            else if (screen === 'player-schedule') {
                // ì„ ìˆ˜/íŒ€ ì¼ì • ì¡°íšŒ í™”ë©´
                const tournamentProjects = projects.filter(p => p.tournamentType && p.matches?.length > 0);
                
                const projectOptions = tournamentProjects.map((p, i) => {
                    const actualIndex = projects.indexOf(p);
                    return `<option value="${actualIndex}">${p.name}</option>`;
                }).join('');
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%);">
                        <h1 style="color:white;">ğŸ“… ë‚´ ì¼ì • ì¡°íšŒ</h1>
                        <p style="color:rgba(255,255,255,0.9);">ì´ë¦„ìœ¼ë¡œ ê²½ê¸° ì¼ì • í™•ì¸</p>
                    </div>
                    <div class="card">
                        <div class="form-group">
                            <label>ëŒ€íšŒ ì„ íƒ</label>
                            <select id="schedule-project" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;" onchange="onScheduleProjectChange()">
                                <option value="">-- ëŒ€íšŒë¥¼ ì„ íƒí•˜ì„¸ìš” --</option>
                                ${projectOptions}
                            </select>
                        </div>
                        
                        <div id="participant-select-area" style="display:none;">
                            <div class="form-group">
                                <label>ì´ë¦„ ì„ íƒ ë˜ëŠ” ì…ë ¥</label>
                                <select id="schedule-name-select" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px; margin-bottom:8px;" onchange="onScheduleNameSelect()">
                                    <option value="">-- ëª©ë¡ì—ì„œ ì„ íƒ --</option>
                                </select>
                                <input type="text" id="schedule-name-input" placeholder="ë˜ëŠ” ì´ë¦„ ì§ì ‘ ì…ë ¥" style="width:100%;">
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="lookupSchedule()" style="width:100%;">
                                ğŸ” ì¼ì • ì¡°íšŒ
                            </button>
                        </div>
                        
                        <div id="schedule-result" style="margin-top:20px;"></div>
                        
                        <button type="button" class="btn" onclick="goTo('viewer-home')" style="width:100%; margin-top:16px;">â† ëŒì•„ê°€ê¸°</button>
                    </div>
                `;
            }
            else if (screen === 'practice-mode') {
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%);">
                        <h1 style="color:white;">ğŸ¯ ì—°ìŠµ ê²½ê¸°</h1>
                        <p style="color:rgba(255,255,255,0.9);">í”„ë¡œì íŠ¸ ì—†ì´ ë°”ë¡œ ê²½ê¸° ì§„í–‰</p>
                    </div>
                    <div class="card">
                        <h2>ê²½ê¸° ì„¤ì •</h2>
                        
                        <div class="form-group">
                            <label>ê²½ê¸° ìœ í˜•</label>
                            <select id="practice-type" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;">
                                <option value="individual">ê°œì¸ì „ (11ì  ì„¸íŠ¸ì œ)</option>
                                <option value="team">íŒ€ì „ (31ì  ë‹¨íŒ)</option>
                            </select>
                        </div>
                        
                        <div id="practice-sets-group" class="form-group">
                            <label>ì„¸íŠ¸ ìˆ˜</label>
                            <select id="practice-sets" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;">
                                <option value="1">1ì„¸íŠ¸</option>
                                <option value="3" selected>3ì„¸íŠ¸ (2ì„ ìŠ¹)</option>
                                <option value="5">5ì„¸íŠ¸ (3ì„ ìŠ¹)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>ì„ ìˆ˜ 1</label>
                            <input type="text" id="practice-player1" placeholder="ì´ë¦„ ì…ë ¥" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;">
                        </div>
                        
                        <div class="form-group">
                            <label>ì„ ìˆ˜ 2</label>
                            <input type="text" id="practice-player2" placeholder="ì´ë¦„ ì…ë ¥" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;">
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="startPracticeMatch()" style="width:100%; margin-top:16px; background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%);" aria-label="ì—°ìŠµ ê²½ê¸° ì‹œì‘">
                            ğŸ¯ ê²½ê¸° ì‹œì‘
                        </button>
                        
                        <button type="button" class="btn" onclick="goTo('referee-home')" style="width:100%; margin-top:8px;" aria-label="ëŒì•„ê°€ê¸°">
                            â† ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                `;
                
                // íŒ€ì „ ì„ íƒ ì‹œ ì„¸íŠ¸ ìˆ˜ ìˆ¨ê¸°ê¸°
                setTimeout(() => {
                    const typeSelect = document.getElementById('practice-type');
                    const setsGroup = document.getElementById('practice-sets-group');
                    if (typeSelect && setsGroup) {
                        typeSelect.onchange = function() {
                            setsGroup.style.display = this.value === 'team' ? 'none' : 'block';
                        };
                    }
                }, 100);
            }
            else if (screen === 'quick-project') {
                // ë¹ ë¥¸ í”„ë¡œì íŠ¸ ìƒì„±
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                        <h1 style="color:white;">â• ë¹ ë¥¸ í”„ë¡œì íŠ¸</h1>
                        <p style="color:rgba(255,255,255,0.9);">ì†Œê·œëª¨ ëŒ€íšŒ/ì—°ìŠµìš©</p>
                    </div>
                    <div class="card">
                        <div class="form-group">
                            <label>í”„ë¡œì íŠ¸ ì´ë¦„ <span style="color:#d32f2f;">*</span></label>
                            <input type="text" id="qp-name" placeholder="ì˜ˆ: ì¹œì„  ê²½ê¸°, ì—°ìŠµ ëŒ€íšŒ" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;" dir="ltr">
                        </div>
                        
                        <div class="form-group">
                            <label>ê²½ê¸° ìœ í˜•</label>
                            <select id="qp-type" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;" onchange="updateQPSets()">
                                <option value="individual">ê°œì¸ì „ (11ì  ì„¸íŠ¸ì œ)</option>
                                <option value="team">íŒ€ì „ (31ì  ë‹¨íŒ)</option>
                            </select>
                        </div>
                        
                        <div id="qp-sets-group" class="form-group">
                            <label>ì„¸íŠ¸ ìˆ˜</label>
                            <select id="qp-sets" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;">
                                <option value="1">1ì„¸íŠ¸</option>
                                <option value="3" selected>3ì„¸íŠ¸ (2ì„ ìŠ¹)</option>
                                <option value="5">5ì„¸íŠ¸ (3ì„ ìŠ¹)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>ì°¸ê°€ì ì…ë ¥ <span style="color:#d32f2f;">*</span></label>
                            <textarea id="qp-participants" placeholder="í•œ ì¤„ì— í•œ ëª…ì”© ì…ë ¥í•˜ì„¸ìš”&#10;&#10;ì˜ˆì‹œ:&#10;í™ê¸¸ë™&#10;ê¹€ì² ìˆ˜&#10;ì´ì˜í¬&#10;ë°•ë¯¼ìˆ˜" style="width:100%; height:150px; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:14px; resize:vertical;"></textarea>
                            <div style="font-size:12px; color:#666; margin-top:4px;">ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ê±°ë‚˜ ì¤„ë°”ê¿ˆìœ¼ë¡œ ì…ë ¥</div>
                        </div>
                        
                        <div class="form-group">
                            <label>ëŒ€ì§„ ë°©ì‹</label>
                            <select id="qp-format" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;">
                                <option value="full-league">í’€ë¦¬ê·¸ (ëª¨ë‘ vs ëª¨ë‘)</option>
                                <option value="tournament">í† ë„ˆë¨¼íŠ¸</option>
                            </select>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="createQuickProject()" style="width:100%; margin-top:16px; background:linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                            âœ… í”„ë¡œì íŠ¸ ìƒì„±
                        </button>
                        
                        <button type="button" class="btn" onclick="goTo('referee-home')" style="width:100%; margin-top:8px;">
                            â† ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                `;
            }
            else if (screen === 'practice-result') {
                // ì—°ìŠµ ê²½ê¸° ê²°ê³¼ í™”ë©´
                if (!currentMatch) {
                    goTo('practice-mode');
                    return;
                }
                
                const m = currentMatch;
                const p1Wins = m.setScores.filter(s => s.player1 > s.player2).length;
                const p2Wins = m.setScores.filter(s => s.player2 > s.player1).length;
                const winner = m.winner || (p1Wins > p2Wins ? m.player1Name : m.player2Name);
                
                // ì„¸íŠ¸ë³„ ì ìˆ˜
                const setScoresHTML = m.setScores.map((s, idx) => {
                    if (s.player1 === 0 && s.player2 === 0) return '';
                    const setWinner = s.player1 > s.player2 ? m.player1Name : m.player2Name;
                    return `
                        <div style="display:flex; justify-content:space-between; padding:12px; margin:4px 0; background:${s.player1 > s.player2 ? '#e3f2fd' : '#fff3e0'}; border-radius:8px;">
                            <span>ì„¸íŠ¸ ${idx + 1}</span>
                            <span style="font-weight:600;">${s.player1} : ${s.player2}</span>
                            <span style="color:#666;">${setWinner}</span>
                        </div>
                    `;
                }).join('');
                
                // ë“ì  íˆìŠ¤í† ë¦¬
                const historyHTML = m.history && m.history.length > 0 ? `
                    <div style="margin-top:20px;">
                        <h4 style="margin:0 0 8px 0;">ğŸ“‹ ë“ì  ê¸°ë¡ (${m.history.length})</h4>
                        <div style="max-height:200px; overflow-y:auto; background:#f5f5f5; border-radius:8px; padding:8px;">
                            ${m.history.slice().reverse().map((h, i) => `
                                <div style="padding:6px 8px; border-bottom:1px solid #eee; font-size:13px;">
                                    <span style="color:#666;">#${m.history.length - i}</span>
                                    <span style="margin-left:8px;">${h.player === 'player1' ? m.player1Name : m.player2Name}</span>
                                    <span style="color:#1976d2; font-weight:600;">+${h.points}</span>
                                    <span style="color:#888; margin-left:4px;">(${h.type})</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';
                
                app.innerHTML = `
                    <div class="card">
                        <div style="text-align:center; padding:20px; background:linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color:white; border-radius:12px; margin-bottom:20px;">
                            <div style="font-size:48px; margin-bottom:8px;">ğŸ†</div>
                            <h2 style="margin:0; color:white;">ì—°ìŠµ ê²½ê¸° ì¢…ë£Œ</h2>
                            <div style="font-size:24px; margin-top:12px; font-weight:700;">${winner} ìŠ¹ë¦¬!</div>
                            <div style="font-size:18px; margin-top:8px; opacity:0.9;">ì„¸íŠ¸ ${p1Wins} : ${p2Wins}</div>
                        </div>
                        
                        <div style="display:flex; justify-content:space-around; margin-bottom:20px; padding:16px; background:#f5f5f5; border-radius:8px;">
                            <div style="text-align:center;">
                                <div style="font-size:14px; color:#666;">${m.player1Name}</div>
                                <div style="font-size:28px; font-weight:700; color:${p1Wins > p2Wins ? '#4caf50' : '#666'};">${p1Wins}</div>
                            </div>
                            <div style="font-size:24px; color:#999; align-self:center;">ì„¸íŠ¸</div>
                            <div style="text-align:center;">
                                <div style="font-size:14px; color:#666;">${m.player2Name}</div>
                                <div style="font-size:28px; font-weight:700; color:${p2Wins > p1Wins ? '#4caf50' : '#666'};">${p2Wins}</div>
                            </div>
                        </div>
                        
                        <h4 style="margin:0 0 8px 0;">ì„¸íŠ¸ë³„ ì ìˆ˜</h4>
                        ${setScoresHTML}
                        
                        ${historyHTML}
                        
                        <div style="margin-top:24px; display:flex; flex-direction:column; gap:8px;">
                            <div style="text-align:center; color:#4caf50; font-size:14px; margin-bottom:8px;">
                                âœ… ê¸°ë¡ì´ ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤
                            </div>
                            <button class="btn" onclick="goTo('practice-history')" style="background:#4caf50; color:white;">
                                ğŸ“‹ ì €ì¥ëœ ê¸°ë¡ ë³´ê¸°
                            </button>
                            <div style="display:flex; gap:8px;">
                                <button class="btn btn-primary" onclick="goTo('practice-mode')" style="flex:1;">ğŸ¯ ìƒˆ ì—°ìŠµ ê²½ê¸°</button>
                                <button class="btn" onclick="goTo('referee-home')" style="flex:1;">â† ëŒì•„ê°€ê¸°</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            else if (screen === 'practice-history') {
                // ì—°ìŠµ ê²½ê¸° ê¸°ë¡ ëª©ë¡
                const practiceHistory = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
                
                const historyList = practiceHistory.length > 0 ? practiceHistory.slice().reverse().map((m, idx) => {
                    const realIdx = practiceHistory.length - 1 - idx;
                    const p1Wins = m.setScores?.filter(s => s.player1 > s.player2).length || 0;
                    const p2Wins = m.setScores?.filter(s => s.player2 > s.player1).length || 0;
                    const date = m.finishedAt ? new Date(m.finishedAt).toLocaleDateString('ko-KR') : '';
                    
                    return `
                        <div style="padding:16px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; cursor:pointer; border-left:4px solid #ff9800;" onclick="viewPracticeRecord(${realIdx})">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <strong>${m.player1Name} vs ${m.player2Name}</strong>
                                    <div style="font-size:13px; color:var(--text-secondary); margin-top:4px;">
                                        ${p1Wins} : ${p2Wins} ì„¸íŠ¸ Â· ${m.winner} ìŠ¹
                                    </div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:12px; color:var(--text-secondary);">${date}</div>
                                    <button class="btn btn-danger" onclick="event.stopPropagation(); deletePracticeRecord(${realIdx})" style="padding:4px 8px; min-width:auto; margin-top:4px; font-size:12px;">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('') : '<p style="text-align:center; color:var(--text-secondary); padding:20px;">ì €ì¥ëœ ì—°ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                
                app.innerHTML = `
                    <div class="card">
                        <div class="header" style="margin:-20px -20px 20px -20px; padding:20px; border-radius:12px 12px 0 0; background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%);">
                            <h1 style="color:white; margin:0;">ğŸ“‹ ì—°ìŠµ ê¸°ë¡</h1>
                            <p style="color:rgba(255,255,255,0.9); margin:4px 0 0 0;">${practiceHistory.length}ê°œì˜ ê¸°ë¡</p>
                        </div>
                        
                        ${historyList}
                        
                        ${practiceHistory.length > 0 ? `
                            <button class="btn btn-danger" onclick="clearPracticeHistory()" style="width:100%; margin-top:16px;">
                                ğŸ—‘ï¸ ì „ì²´ ê¸°ë¡ ì‚­ì œ
                            </button>
                        ` : ''}
                        
                        <button class="btn" onclick="goTo('practice-mode')" style="width:100%; margin-top:8px;">
                            â† ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                `;
            }
            else if (screen === 'practice-detail') {
                // ì—°ìŠµ ê²½ê¸° ìƒì„¸ ê¸°ë¡
                const practiceHistory = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
                const recordIdx = window.currentPracticeRecordIdx;
                
                if (recordIdx === undefined || !practiceHistory[recordIdx]) {
                    goTo('practice-history');
                    return;
                }
                
                const m = practiceHistory[recordIdx];
                const p1Wins = m.setScores?.filter(s => s.player1 > s.player2).length || 0;
                const p2Wins = m.setScores?.filter(s => s.player2 > s.player1).length || 0;
                
                // ì„¸íŠ¸ë³„ ì ìˆ˜
                const setScoresHTML = m.setScores?.map((s, idx) => {
                    if (s.player1 === 0 && s.player2 === 0) return '';
                    const setWinner = s.player1 > s.player2 ? m.player1Name : m.player2Name;
                    return `
                        <div style="display:flex; justify-content:space-between; padding:12px; margin:4px 0; background:${s.player1 > s.player2 ? '#e3f2fd' : '#fff3e0'}; border-radius:8px;">
                            <span>ì„¸íŠ¸ ${idx + 1}</span>
                            <span style="font-weight:600;">${s.player1} : ${s.player2}</span>
                            <span style="color:#666;">${setWinner}</span>
                        </div>
                    `;
                }).join('') || '';
                
                // ë“ì  íˆìŠ¤í† ë¦¬
                const historyHTML = m.history && m.history.length > 0 ? `
                    <div style="margin-top:20px;">
                        <h4 style="margin:0 0 8px 0;">ğŸ“‹ ë“ì  ê¸°ë¡ (${m.history.length})</h4>
                        <div style="max-height:300px; overflow-y:auto; background:#f5f5f5; border-radius:8px; padding:8px;">
                            ${m.history.slice().reverse().map((h, i) => `
                                <div style="padding:6px 8px; border-bottom:1px solid #eee; font-size:13px;">
                                    <span style="color:#666;">#${m.history.length - i}</span>
                                    <span style="margin-left:8px;">${h.player === 'player1' ? m.player1Name : m.player2Name}</span>
                                    <span style="color:#1976d2; font-weight:600;">+${h.points}</span>
                                    <span style="color:#888; margin-left:4px;">(${h.type})</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('practice-history')" style="margin-bottom:16px;">â† ê¸°ë¡ ëª©ë¡</button>
                        
                        <div style="text-align:center; padding:20px; background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%); color:white; border-radius:12px; margin-bottom:20px;">
                            <h2 style="margin:0; color:white;">${m.player1Name} vs ${m.player2Name}</h2>
                            <div style="font-size:24px; margin-top:12px; font-weight:700;">${m.winner} ìŠ¹ë¦¬!</div>
                            <div style="font-size:18px; margin-top:8px; opacity:0.9;">ì„¸íŠ¸ ${p1Wins} : ${p2Wins}</div>
                            <div style="font-size:13px; margin-top:8px; opacity:0.8;">${m.finishedAt ? new Date(m.finishedAt).toLocaleString('ko-KR') : ''}</div>
                        </div>
                        
                        <h4 style="margin:0 0 8px 0;">ì„¸íŠ¸ë³„ ì ìˆ˜</h4>
                        ${setScoresHTML}
                        
                        ${historyHTML}
                    </div>
                `;
            }
            else if (screen === 'tournament-wizard') {
                // ëŒ€íšŒ ëŒ€ì§„ ì„¤ì • ìœ„ìë“œ (í•˜ì´ë¸Œë¦¬ë“œ ì»¤ìŠ¤í…€)
                const tw = window.tournamentWizard || { 
                    step: 1, 
                    mode: 'template', // 'template' or 'custom'
                    template: null,
                    info: { name: '', date: '', location: '', type: 'individual', rules: '' },
                    participants: [],
                    teams: [],
                    seedOrder: [], // ì‹œë“œ ìˆœì„œ
                    
                    // ì‹¬íŒ ì„¤ì •
                    referees: [],
                    courts: [],
                    
                    // ì˜ˆì„  ì„¤ì •
                    preliminary: {
                        enabled: true,
                        groupCount: 4,
                        perGroup: 4,
                        sets: 3,
                        advanceCount: 2,
                        wildcards: 0,
                        groupAssignment: 'random' // 'random', 'manual'
                    },
                    
                    // ë³¸ì„  ì„¤ì •
                    finals: {
                        enabled: true,
                        size: 8,
                        sets: 5,
                        customBracket: [], // ì»¤ìŠ¤í…€ ëŒ€ì§„
                        sameGroupAvoid: 'quarterfinal' // 'none', 'quarterfinal', 'semifinal', 'all'
                    },
                    
                    // ìƒì„±ëœ ë°ì´í„°
                    groups: [],
                    bracket: null
                };
                window.tournamentWizard = tw;
                
                // ê¸°ë³¸ê°’ ë³´ì¥
                if (!tw.preliminary) tw.preliminary = { enabled: true, groupCount: 4, perGroup: 4, sets: 3, advanceCount: 2, wildcards: 0, groupAssignment: 'random' };
                if (!tw.finals) tw.finals = { enabled: true, size: 8, sets: 5, customBracket: [], sameGroupAvoid: 'quarterfinal' };
                if (!tw.mode) tw.mode = 'template';
                if (!tw.info.rules) tw.info.rules = '';
                if (!tw.seedOrder) tw.seedOrder = [];
                
                const stepTitles = tw.mode === 'custom' 
                    ? ['', 'ê¸°ë³¸ ì •ë³´', 'ì°¸ê°€ì ë“±ë¡', 'ì˜ˆì„  ì„¤ì •', 'ë³¸ì„  ì„¤ì •', 'ëŒ€ì§„í‘œ í™•ì¸', 'ì‹¬íŒ/ê²½ê¸°ì¥ ì„¤ì •']
                    : ['', 'ëŒ€íšŒ ì •ë³´', 'ì°¸ê°€ì ë“±ë¡', 'ëŒ€íšŒ ë°©ì‹', 'ì„¸ë¶€ ì„¤ì •', 'ëŒ€ì§„í‘œ í™•ì¸', 'ì‹¬íŒ/ê²½ê¸°ì¥ ì„¤ì •'];
                const totalSteps = 6;
                
                // í˜ì´ì§€ íƒ€ì´í‹€ í—¤ë”
                const pageTitleHTML = `
                    <div class="header" style="margin:-20px -20px 20px -20px; padding:20px; border-radius:12px 12px 0 0; background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);">
                        <h1 style="color:white; margin:0; font-size:20px;">ğŸ† ëŒ€íšŒ ëŒ€ì§„ ì„¤ì •</h1>
                        <p style="color:rgba(255,255,255,0.9); margin:4px 0 0 0; font-size:14px;">${stepTitles[tw.step]}</p>
                    </div>
                `;
                
                // ì§„í–‰ë¥  í‘œì‹œ
                const progressHTML = `
                    <div style="margin-bottom:24px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <span style="font-weight:600;">ë‹¨ê³„ ${tw.step}/${totalSteps}</span>
                            <span style="color:var(--text-secondary);">${Math.round(tw.step/totalSteps*100)}%</span>
                        </div>
                        <div style="height:8px; background:#e0e0e0; border-radius:4px; overflow:hidden;">
                            <div style="height:100%; width:${tw.step/totalSteps*100}%; background:linear-gradient(90deg, #1976d2, #0d47a1); transition:width 0.3s;"></div>
                        </div>
                    </div>
                `;
                
                let stepContent = '';
                
                if (tw.step === 1) {
                    // Step 1: ëŒ€íšŒ ê¸°ë³¸ ì •ë³´ + ëª¨ë“œ ì„ íƒ
                    stepContent = `
                        <div class="form-group">
                            <label>ëŒ€íšŒëª… <span style="color:#d32f2f;">*</span></label>
                            <input type="text" id="tw-name" value="${tw.info.name}" placeholder="ëŒ€íšŒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:100%;" dir="ltr">
                        </div>
                        <div class="form-group">
                            <label>ë‚ ì§œ</label>
                            <input type="date" id="tw-date" value="${tw.info.date || new Date().toISOString().split('T')[0]}" style="width:100%;">
                        </div>
                        <div class="form-group">
                            <label>ì¥ì†Œ</label>
                            <input type="text" id="tw-location" value="${tw.info.location}" placeholder="ëŒ€íšŒ ì¥ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width:100%;" dir="ltr">
                        </div>
                        
                        <div class="form-group">
                            <label>ëŒ€íšŒ ê·œì¹™ (ììœ  ì…ë ¥)</label>
                            <textarea id="tw-rules" placeholder="ëŒ€íšŒ ì§„í–‰ ë°©ì‹, íŠ¹ë³„ ê·œì¹™ ë“±ì„ ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”&#10;&#10;ì˜ˆì‹œ:&#10;- ì¡°ë³„ ì˜ˆì„  í›„ ìƒìœ„ 2ëª… ë³¸ì„  ì§„ì¶œ&#10;- ì˜ˆì„  3ì„¸íŠ¸, ë³¸ì„  5ì„¸íŠ¸&#10;- Aì¡° 1ìœ„ vs Bì¡° 2ìœ„ ë°©ì‹" style="width:100%; height:100px; resize:vertical; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:14px;">${tw.info.rules || ''}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>ì„¤ì • ë°©ì‹ <span style="color:#d32f2f;">*</span></label>
                            <div style="display:flex; flex-direction:column; gap:12px; margin-top:8px;">
                                <div style="display:block; padding:16px; background:${tw.mode === 'template' ? '#e3f2fd' : '#f5f5f5'}; border-radius:12px; cursor:pointer; border:2px solid ${tw.mode === 'template' ? '#1976d2' : 'transparent'};" onclick="window.tournamentWizard.mode='template';render();">
                                    <div style="display:flex; align-items:center; gap:12px;">
                                        <input type="radio" name="tw-mode" value="template" ${tw.mode === 'template' ? 'checked' : ''} style="pointer-events:none;">
                                        <div style="flex:1;">
                                            <div style="font-weight:600;">ğŸ“‹ í…œí”Œë¦¿ ì‚¬ìš©</div>
                                            <div style="font-size:12px; color:#666; margin-top:4px;">ê¸°ë³¸ ì œê³µ í˜•ì‹ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì„¤ì •</div>
                                        </div>
                                    </div>
                                </div>
                                <div style="display:block; padding:16px; background:${tw.mode === 'custom' ? '#e3f2fd' : '#f5f5f5'}; border-radius:12px; cursor:pointer; border:2px solid ${tw.mode === 'custom' ? '#1976d2' : 'transparent'};" onclick="window.tournamentWizard.mode='custom';render();">
                                    <div style="display:flex; align-items:center; gap:12px;">
                                        <input type="radio" name="tw-mode" value="custom" ${tw.mode === 'custom' ? 'checked' : ''} style="pointer-events:none;">
                                        <div style="flex:1;">
                                            <div style="font-weight:600;">âš™ï¸ ì»¤ìŠ¤í…€ ì„¤ì •</div>
                                            <div style="font-size:12px; color:#666; margin-top:4px;">ì¡° í¸ì„±, ì„¸íŠ¸ ìˆ˜, ëŒ€ì§„í‘œ ì§ì ‘ êµ¬ì„±</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        ${tw.mode === 'template' ? `
                            <div class="form-group">
                                <label>ëŒ€íšŒ í˜•ì‹ <span style="color:#d32f2f;">*</span></label>
                                <div style="display:flex; flex-direction:column; gap:10px; margin-top:8px;">
                                    <div style="display:flex; align-items:center; gap:12px; padding:14px; background:${tw.template === 'group-only' ? '#e8f5e9' : '#f5f5f5'}; border-radius:8px; cursor:pointer; border:2px solid ${tw.template === 'group-only' ? '#4caf50' : 'transparent'};" onclick="window.tournamentWizard.template='group-only';render();">
                                        <input type="radio" name="tw-template" value="group-only" ${tw.template === 'group-only' ? 'checked' : ''} style="pointer-events:none;">
                                        <div>
                                            <div style="font-weight:600;">ğŸ“Š ì¡°ë³„ ë¦¬ê·¸</div>
                                            <div style="font-size:11px; color:#666;">ì¡°ë³„ë¡œ í’€ë¦¬ê·¸ ì§„í–‰ í›„ ìˆœìœ„ ê²°ì •</div>
                                        </div>
                                    </div>
                                    <div style="display:flex; align-items:center; gap:12px; padding:14px; background:${tw.template === 'group-knockout' ? '#e8f5e9' : '#f5f5f5'}; border-radius:8px; cursor:pointer; border:2px solid ${tw.template === 'group-knockout' ? '#4caf50' : 'transparent'};" onclick="window.tournamentWizard.template='group-knockout';render();">
                                        <input type="radio" name="tw-template" value="group-knockout" ${tw.template === 'group-knockout' ? 'checked' : ''} style="pointer-events:none;">
                                        <div>
                                            <div style="font-weight:600;">ğŸ† ì¡°ë³„ ì˜ˆì„  + ë³¸ì„ </div>
                                            <div style="font-size:11px; color:#666;">ì¡°ë³„ ë¦¬ê·¸ í›„ ìƒìœ„ì í† ë„ˆë¨¼íŠ¸</div>
                                        </div>
                                    </div>
                                    <div style="display:flex; align-items:center; gap:12px; padding:14px; background:${tw.template === 'knockout-only' ? '#e8f5e9' : '#f5f5f5'}; border-radius:8px; cursor:pointer; border:2px solid ${tw.template === 'knockout-only' ? '#4caf50' : 'transparent'};" onclick="window.tournamentWizard.template='knockout-only';render();">
                                        <input type="radio" name="tw-template" value="knockout-only" ${tw.template === 'knockout-only' ? 'checked' : ''} style="pointer-events:none;">
                                        <div>
                                            <div style="font-weight:600;">ğŸ¥Š í† ë„ˆë¨¼íŠ¸</div>
                                            <div style="font-size:11px; color:#666;">ë…¹ì•„ì›ƒ ë°©ì‹ í† ë„ˆë¨¼íŠ¸</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div style="background:#e8f5e9; padding:16px; border-radius:12px; margin-top:8px;">
                                <div style="font-weight:600; margin-bottom:8px;">âœ… ì»¤ìŠ¤í…€ ëª¨ë“œ ì„ íƒë¨</div>
                                <div style="font-size:13px; color:#666;">
                                    ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì„¤ì •í•  ìˆ˜ ìˆëŠ” í•­ëª©:
                                    <ul style="margin:8px 0 0 16px; padding:0;">
                                        <li>ì¡° ê°œìˆ˜ ë° í¸ì„± ë°©ì‹</li>
                                        <li>ì˜ˆì„ /ë³¸ì„  ì„¸íŠ¸ ìˆ˜</li>
                                        <li>ì§„ì¶œ ì¸ì› ë° ì™€ì¼ë“œì¹´ë“œ</li>
                                        <li>ë³¸ì„  ëŒ€ì§„í‘œ ì§ì ‘ êµ¬ì„±</li>
                                    </ul>
                                </div>
                            </div>
                        `}
                    `;
                } else if (tw.step === 2) {
                    // Step 2: ì°¸ê°€ì ë“±ë¡
                    const unitName = tw.info.type === 'team' ? 'íŒ€' : 'ëª…';
                    
                    const participantList = tw.participants.map((p, i) => `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:var(--bg-secondary); border-radius:6px; margin:4px 0;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span style="background:#1976d2; color:white; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:600;">${i+1}</span>
                                <span style="direction:ltr; unicode-bidi:bidi-override;">${p}</span>
                            </div>
                            <div style="display:flex; gap:4px;">
                                ${i > 0 ? `<button class="btn" onclick="moveTWParticipant(${i}, -1)" style="padding:4px 8px; min-width:auto; font-size:12px;">â†‘</button>` : ''}
                                ${i < tw.participants.length - 1 ? `<button class="btn" onclick="moveTWParticipant(${i}, 1)" style="padding:4px 8px; min-width:auto; font-size:12px;">â†“</button>` : ''}
                                <button class="btn btn-danger" onclick="removeTWParticipant(${i})" style="padding:4px 8px; min-width:auto;">âœ•</button>
                            </div>
                        </div>
                    `).join('') || '<p style="color:var(--text-secondary); text-align:center; padding:20px;">ì°¸ê°€ìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>';
                    
                    stepContent = `
                        <div style="background:#e8f5e9; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>ğŸ’¡ ì…ë ¥ ì•ˆë‚´</strong>
                            <p style="font-size:13px; margin-top:4px;">ì—¬ëŸ¬ ëª…ì„ í•œ ë²ˆì— ì…ë ¥í•˜ë ¤ë©´ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•˜ì„¸ìš”. ìˆœì„œë¥¼ ë³€ê²½í•˜ë©´ ì‹œë“œ ìˆœì„œë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
                        </div>
                        
                        <div class="form-group">
                            <label>ì°¸ê°€ì ì¶”ê°€</label>
                            <div style="display:flex; gap:8px; margin-top:8px;">
                                <input type="text" id="tw-participant" placeholder="ì´ë¦„ ì…ë ¥ (ì‰¼í‘œë¡œ ì—¬ëŸ¬ ëª… êµ¬ë¶„)" style="flex:1;" dir="ltr" onkeypress="if(event.key==='Enter')addTWParticipant()">
                                <button class="btn btn-primary" onclick="addTWParticipant()">ì¶”ê°€</button>
                            </div>
                        </div>
                        
                        <div style="display:flex; justify-content:space-between; align-items:center; margin:16px 0 12px 0;">
                            <div style="font-size:18px; font-weight:bold;">
                                ë“±ë¡: ${tw.participants.length}${unitName}
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button class="btn" onclick="shuffleTWParticipants()" style="padding:6px 12px; font-size:13px;">ğŸ² ëœë¤ ì„ê¸°</button>
                                <button class="btn btn-danger" onclick="clearTWParticipants()" style="padding:6px 12px; font-size:13px;">ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ</button>
                            </div>
                        </div>
                        
                        <div style="max-height:350px; overflow-y:auto; border:1px solid var(--border); border-radius:8px; padding:8px;">
                            ${participantList}
                        </div>
                        
                        <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-top:16px;">
                            <strong>ğŸ“‹ ì‹œë“œ ìˆœì„œ</strong>
                            <p style="font-size:13px; margin-top:4px;">ìœ„ ëª©ë¡ ìˆœì„œê°€ ì‹œë“œ ìˆœì„œì…ë‹ˆë‹¤. â†‘â†“ ë²„íŠ¼ìœ¼ë¡œ ì¡°ì •í•˜ê±°ë‚˜ ğŸ² ë²„íŠ¼ìœ¼ë¡œ ëœë¤ ë°°ì¹˜í•˜ì„¸ìš”.</p>
                        </div>
                    `;
                } else if (tw.step === 3) {
                    // Step 3: ì˜ˆì„  ì„¤ì • (ì»¤ìŠ¤í…€) ë˜ëŠ” ëŒ€íšŒ ë°©ì‹ ì„ íƒ (í…œí”Œë¦¿)
                    
                    if (tw.mode === 'custom') {
                        // ì»¤ìŠ¤í…€ ëª¨ë“œ: ì˜ˆì„  ìƒì„¸ ì„¤ì •
                        const participantCount = tw.participants.length;
                        const groupOptions = [2,3,4,5,6,8,10,12].filter(n => n <= participantCount).map(n => {
                            const perGroup = Math.ceil(participantCount / n);
                            return `<option value="${n}" ${tw.preliminary.groupCount === n ? 'selected' : ''}>${n}ê°œ ì¡° (ì¡°ë‹¹ ì•½ ${perGroup}ëª…)</option>`;
                        }).join('');
                        
                        stepContent = `
                            <div class="form-group">
                                <label>ì˜ˆì„  ì§„í–‰ ì—¬ë¶€</label>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px;">
                                    <div style="display:flex; align-items:center; gap:8px; padding:14px; background:${tw.preliminary.enabled ? '#e8f5e9' : '#f5f5f5'}; border-radius:8px; cursor:pointer; border:2px solid ${tw.preliminary.enabled ? '#4caf50' : 'transparent'};" onclick="window.tournamentWizard.preliminary.enabled=true;render();">
                                        <input type="radio" name="tw-prelim" value="true" ${tw.preliminary.enabled ? 'checked' : ''} style="pointer-events:none;">
                                        <span style="font-weight:600;">ì¡°ë³„ ì˜ˆì„  ì§„í–‰</span>
                                    </div>
                                    <div style="display:flex; align-items:center; gap:8px; padding:14px; background:${!tw.preliminary.enabled ? '#fff3e0' : '#f5f5f5'}; border-radius:8px; cursor:pointer; border:2px solid ${!tw.preliminary.enabled ? '#ff9800' : 'transparent'};" onclick="window.tournamentWizard.preliminary.enabled=false;render();">
                                        <input type="radio" name="tw-prelim" value="false" ${!tw.preliminary.enabled ? 'checked' : ''} style="pointer-events:none;">
                                        <span style="font-weight:600;">ë°”ë¡œ ë³¸ì„ </span>
                                    </div>
                                </div>
                            </div>
                            
                            ${tw.preliminary.enabled ? `
                                <div class="form-group">
                                    <label>ì¡° ê°œìˆ˜</label>
                                    <select id="tw-custom-groups" onchange="updateCustomPreliminary()" style="width:100%;">
                                        ${groupOptions}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>ì˜ˆì„  ì„¸íŠ¸ ìˆ˜</label>
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px;">
                                        ${[3,5].map(s => `
                                            <div style="display:flex; align-items:center; justify-content:center; gap:8px; padding:14px; background:${tw.preliminary.sets === s ? '#e3f2fd' : '#f5f5f5'}; border-radius:8px; cursor:pointer; border:2px solid ${tw.preliminary.sets === s ? '#1976d2' : 'transparent'};" onclick="window.tournamentWizard.preliminary.sets=${s};render();">
                                                <input type="radio" name="tw-prelim-sets" value="${s}" ${tw.preliminary.sets === s ? 'checked' : ''} style="pointer-events:none;">
                                                <span style="font-weight:600;">${s}ì„¸íŠ¸</span>
                                                <span style="font-size:12px; color:#666;">(${Math.ceil(s/2)}ì„ ìŠ¹)</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>ì¡° í¸ì„± ë°©ì‹</label>
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px;">
                                        <div style="display:flex; align-items:center; gap:8px; padding:14px; background:${tw.preliminary.groupAssignment === 'random' ? '#e3f2fd' : '#f5f5f5'}; border-radius:8px; cursor:pointer; border:2px solid ${tw.preliminary.groupAssignment === 'random' ? '#1976d2' : 'transparent'};" onclick="window.tournamentWizard.preliminary.groupAssignment='random';render();">
                                            <input type="radio" name="tw-group-assign" value="random" ${tw.preliminary.groupAssignment === 'random' ? 'checked' : ''} style="pointer-events:none;">
                                            <div>
                                                <div style="font-weight:600;">ğŸ² ëœë¤ ë°°ì •</div>
                                                <div style="font-size:11px; color:#666;">ë¬´ì‘ìœ„ë¡œ ì¡° ë°°ì •</div>
                                            </div>
                                        </div>
                                        <div style="display:flex; align-items:center; gap:8px; padding:14px; background:${tw.preliminary.groupAssignment === 'manual' ? '#e3f2fd' : '#f5f5f5'}; border-radius:8px; cursor:pointer; border:2px solid ${tw.preliminary.groupAssignment === 'manual' ? '#1976d2' : 'transparent'};" onclick="window.tournamentWizard.preliminary.groupAssignment='manual';render();">
                                            <input type="radio" name="tw-group-assign" value="manual" ${tw.preliminary.groupAssignment === 'manual' ? 'checked' : ''} style="pointer-events:none;">
                                            <div>
                                                <div style="font-weight:600;">âœ‹ ì§ì ‘ ì…ë ¥</div>
                                                <div style="font-size:11px; color:#666;">ì‹œë“œ ìˆœì„œëŒ€ë¡œ ë°°ì •</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="background:#fff3e0; padding:16px; border-radius:12px; margin-top:16px;">
                                    <div style="font-weight:600; margin-bottom:12px;">ğŸ† ë³¸ì„  ì§„ì¶œ ê·œì¹™</div>
                                    <div class="form-group" style="margin-bottom:12px;">
                                        <label>ê° ì¡° ì§„ì¶œ ì¸ì›</label>
                                        <select id="tw-advance-count" onchange="window.tournamentWizard.preliminary.advanceCount=parseInt(this.value);render();" style="width:100%;">
                                            ${[1,2,3,4].map(n => `<option value="${n}" ${tw.preliminary.advanceCount === n ? 'selected' : ''}>ìƒìœ„ ${n}ëª…</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group" style="margin:0;">
                                        <label>ì™€ì¼ë“œì¹´ë“œ (ì¶”ê°€ ì§„ì¶œ)</label>
                                        <select id="tw-wildcards" onchange="window.tournamentWizard.preliminary.wildcards=parseInt(this.value);render();" style="width:100%;">
                                            ${[0,1,2,4].map(n => `<option value="${n}" ${tw.preliminary.wildcards === n ? 'selected' : ''}>${n}ëª…</option>`).join('')}
                                        </select>
                                    </div>
                                    <div style="margin-top:12px; padding:12px; background:#fffde7; border-radius:8px; font-size:14px;">
                                        ì´ ë³¸ì„  ì§„ì¶œ: <strong>${tw.preliminary.groupCount * tw.preliminary.advanceCount + tw.preliminary.wildcards}ëª…</strong>
                                    </div>
                                </div>
                            ` : `
                                <div style="background:#f5f5f5; padding:20px; border-radius:12px; text-align:center;">
                                    <div style="font-size:16px; color:#666;">ì˜ˆì„  ì—†ì´ ë°”ë¡œ ë³¸ì„  í† ë„ˆë¨¼íŠ¸ë¡œ ì§„í–‰í•©ë‹ˆë‹¤</div>
                                    <div style="font-size:14px; color:#999; margin-top:8px;">ì°¸ê°€ì ${participantCount}ëª… ì „ì› ë³¸ì„  ì§„ì¶œ</div>
                                </div>
                            `}
                        `;
                    } else {
                        // í…œí”Œë¦¿ ëª¨ë“œ: ê°„ë‹¨í•œ ì„¤ì •
                        const participantCount = tw.participants.length;
                        stepContent = `
                            <div style="background:#e3f2fd; padding:16px; border-radius:12px; margin-bottom:16px;">
                                <div style="font-weight:600;">ì„ íƒí•œ í…œí”Œë¦¿: ${tw.template === 'group-only' ? 'ğŸ“Š ì¡°ë³„ ë¦¬ê·¸' : tw.template === 'group-knockout' ? 'ğŸ† ì¡°ë³„ ì˜ˆì„  + ë³¸ì„ ' : 'ğŸ¥Š í† ë„ˆë¨¼íŠ¸'}</div>
                            </div>
                            
                            ${tw.template !== 'knockout-only' ? `
                                <div class="form-group">
                                    <label>ì¡° ê°œìˆ˜</label>
                                    <select id="tw-tpl-groups" onchange="window.tournamentWizard.preliminary.groupCount=parseInt(this.value);render();" style="width:100%;">
                                        ${[2,3,4,5,6,8].filter(n => n <= participantCount).map(n => {
                                            const perGroup = Math.ceil(participantCount / n);
                                            return `<option value="${n}" ${tw.preliminary.groupCount === n ? 'selected' : ''}>${n}ê°œ ì¡° (ì¡°ë‹¹ ì•½ ${perGroup}ëª…)</option>`;
                                        }).join('')}
                                    </select>
                                </div>
                            ` : ''}
                            
                            ${tw.template === 'group-knockout' ? `
                                <div class="form-group">
                                    <label>ë³¸ì„  ì§„ì¶œ (ê° ì¡°)</label>
                                    <select onchange="window.tournamentWizard.preliminary.advanceCount=parseInt(this.value);render();" style="width:100%;">
                                        ${[1,2,3].map(n => `<option value="${n}" ${tw.preliminary.advanceCount === n ? 'selected' : ''}>ìƒìœ„ ${n}ëª…</option>`).join('')}
                                    </select>
                                </div>
                            ` : ''}
                            
                            <div class="form-group">
                                <label>ì„¸íŠ¸ ìˆ˜</label>
                                <select onchange="window.tournamentWizard.preliminary.sets=parseInt(this.value);render();" style="width:100%;">
                                    <option value="3" ${tw.preliminary.sets === 3 ? 'selected' : ''}>3ì„¸íŠ¸ (2ì„ ìŠ¹)</option>
                                    <option value="5" ${tw.preliminary.sets === 5 ? 'selected' : ''}>5ì„¸íŠ¸ (3ì„ ìŠ¹)</option>
                                </select>
                            </div>
                            
                            <div style="background:#f5f5f5; padding:12px; border-radius:8px; margin-top:12px;">
                                <div style="font-size:14px;">ì°¸ê°€ì: <strong>${participantCount}ëª…</strong></div>
                                ${tw.template === 'group-knockout' ? `<div style="font-size:14px; margin-top:4px;">ë³¸ì„  ì§„ì¶œ: <strong>${tw.preliminary.groupCount * tw.preliminary.advanceCount}ëª…</strong></div>` : ''}
                            </div>
                        `;
                    }
                } else if (tw.step === 4) {
                    // Step 4: ë³¸ì„  ëŒ€ì§„ ì„¤ì • (ì»¤ìŠ¤í…€) ë˜ëŠ” ì„¸ë¶€ ì„¤ì • (í…œí”Œë¦¿)
                    const participantCount = tw.participants.length;
                    
                    if (tw.mode === 'custom') {
                        // ì»¤ìŠ¤í…€ ëª¨ë“œ: ë³¸ì„  ëŒ€ì§„í‘œ ì§ì ‘ êµ¬ì„±
                        const finalsCount = tw.preliminary.enabled 
                            ? (tw.preliminary.groupCount * tw.preliminary.advanceCount + tw.preliminary.wildcards)
                            : participantCount;
                        
                        // ë³¸ì„  ê·œëª¨ ì˜µì…˜
                        const sizeOptions = [4,8,16,32,64].filter(s => s >= finalsCount / 2 && s <= finalsCount * 2);
                        
                        // ì¡° ë¼ë²¨ ìƒì„±
                        const groupLabels = [];
                        for (let i = 0; i < tw.preliminary.groupCount; i++) {
                            groupLabels.push(String.fromCharCode(65 + i)); // A, B, C, ...
                        }
                        
                        // ì»¤ìŠ¤í…€ ëŒ€ì§„ ì´ˆê¸°í™”
                        if (!tw.finals.customBracket || tw.finals.customBracket.length === 0) {
                            initCustomBracket();
                        }
                        
                        // ëŒ€ì§„ í¸ì§‘ UI
                        const bracketEditorHTML = tw.preliminary.enabled ? tw.finals.customBracket.map((match, idx) => `
                            <div style="display:flex; align-items:center; gap:8px; padding:12px; margin:8px 0; background:#f5f5f5; border-radius:8px;">
                                <span style="font-weight:600; min-width:60px;">ê²½ê¸° ${idx + 1}</span>
                                <select onchange="updateCustomBracketMatch(${idx}, 'p1Group', this.value)" style="flex:1; padding:8px;">
                                    ${groupLabels.map(g => `<option value="${g}" ${match.p1Group === g ? 'selected' : ''}>${g}ì¡°</option>`).join('')}
                                </select>
                                <select onchange="updateCustomBracketMatch(${idx}, 'p1Rank', parseInt(this.value))" style="width:60px; padding:8px;">
                                    ${[1,2,3,4].slice(0, tw.preliminary.advanceCount).map(r => `<option value="${r}" ${match.p1Rank === r ? 'selected' : ''}>${r}ìœ„</option>`).join('')}
                                </select>
                                <span style="font-weight:600;">vs</span>
                                <select onchange="updateCustomBracketMatch(${idx}, 'p2Group', this.value)" style="flex:1; padding:8px;">
                                    ${groupLabels.map(g => `<option value="${g}" ${match.p2Group === g ? 'selected' : ''}>${g}ì¡°</option>`).join('')}
                                </select>
                                <select onchange="updateCustomBracketMatch(${idx}, 'p2Rank', parseInt(this.value))" style="width:60px; padding:8px;">
                                    ${[1,2,3,4].slice(0, tw.preliminary.advanceCount).map(r => `<option value="${r}" ${match.p2Rank === r ? 'selected' : ''}>${r}ìœ„</option>`).join('')}
                                </select>
                            </div>
                        `).join('') : `
                            <div style="background:#f5f5f5; padding:20px; border-radius:8px; text-align:center;">
                                <div style="color:#666;">ì˜ˆì„  ì—†ì´ ì§„í–‰ ì‹œ ë³¸ì„  ëŒ€ì§„ì€ ìë™ ë˜ëŠ” ì‹œë“œ ë°°ì •ë©ë‹ˆë‹¤</div>
                            </div>
                        `;
                        
                        stepContent = `
                            <div style="background:#fff3e0; padding:16px; border-radius:12px; margin-bottom:16px;">
                                <div style="font-weight:600; margin-bottom:4px;">ğŸ¥Š ë³¸ì„  ì„¤ì •</div>
                                <div style="font-size:13px; color:#666;">í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„ì„ êµ¬ì„±í•©ë‹ˆë‹¤</div>
                            </div>
                            
                            <div class="form-group">
                                <label>ë³¸ì„  ê·œëª¨</label>
                                <select id="tw-finals-size" onchange="window.tournamentWizard.finals.size=parseInt(this.value);initCustomBracket();render();" style="width:100%;">
                                    ${sizeOptions.map(s => `<option value="${s}" ${tw.finals.size === s ? 'selected' : ''}>${s}ê°•</option>`).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>ë³¸ì„  ì„¸íŠ¸ ìˆ˜</label>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px;">
                                    ${[3,5].map(s => `
                                        <div style="display:flex; align-items:center; justify-content:center; gap:8px; padding:14px; background:${tw.finals.sets === s ? '#fff3e0' : '#f5f5f5'}; border-radius:8px; cursor:pointer; border:2px solid ${tw.finals.sets === s ? '#ff9800' : 'transparent'};" onclick="window.tournamentWizard.finals.sets=${s};render();">
                                            <input type="radio" name="tw-finals-sets" value="${s}" ${tw.finals.sets === s ? 'checked' : ''} style="pointer-events:none;">
                                            <span style="font-weight:600;">${s}ì„¸íŠ¸</span>
                                            <span style="font-size:12px; color:#666;">(${Math.ceil(s/2)}ì„ ìŠ¹)</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            ${tw.preliminary.enabled ? `
                                <div class="form-group">
                                    <label>ê°™ì€ ì¡° ì„ ìˆ˜ íšŒí”¼</label>
                                    <select onchange="window.tournamentWizard.finals.sameGroupAvoid=this.value;render();" style="width:100%;">
                                        <option value="none" ${tw.finals.sameGroupAvoid === 'none' ? 'selected' : ''}>íšŒí”¼ ì•ˆ í•¨</option>
                                        <option value="quarterfinal" ${tw.finals.sameGroupAvoid === 'quarterfinal' ? 'selected' : ''}>8ê°•ê¹Œì§€ íšŒí”¼</option>
                                        <option value="semifinal" ${tw.finals.sameGroupAvoid === 'semifinal' ? 'selected' : ''}>4ê°•ê¹Œì§€ íšŒí”¼</option>
                                        <option value="all" ${tw.finals.sameGroupAvoid === 'all' ? 'selected' : ''}>ê²°ìŠ¹ê¹Œì§€ íšŒí”¼</option>
                                    </select>
                                </div>
                                
                                <div style="margin-top:20px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                        <label style="font-weight:600;">ğŸ† ${tw.finals.size}ê°• ëŒ€ì§„í‘œ êµ¬ì„±</label>
                                        <button class="btn" onclick="autoFillBracket()" style="padding:6px 12px; font-size:13px;">ğŸ² ìë™ ë°°ì •</button>
                                    </div>
                                    <div style="max-height:400px; overflow-y:auto;">
                                        ${bracketEditorHTML}
                                    </div>
                                </div>
                            ` : ''}
                        `;
                    } else {
                        // í…œí”Œë¦¿ ëª¨ë“œ: ê¸°ì¡´ ì„¸ë¶€ ì„¤ì •
                        stepContent = `
                            <div style="background:#e8f5e9; padding:16px; border-radius:12px; margin-bottom:16px;">
                                <div style="font-weight:600;">âœ… ì„¤ì • ì™„ë£Œ</div>
                                <div style="font-size:13px; color:#666; margin-top:4px;">ì•„ë˜ ë‚´ìš©ì„ í™•ì¸í•˜ì„¸ìš”</div>
                            </div>
                            
                            <div style="background:#f5f5f5; padding:16px; border-radius:8px;">
                                <div style="margin-bottom:12px;"><strong>ì°¸ê°€ì:</strong> ${participantCount}ëª…</div>
                                ${tw.template !== 'knockout-only' ? `<div style="margin-bottom:12px;"><strong>ì¡° í¸ì„±:</strong> ${tw.preliminary.groupCount}ê°œ ì¡°</div>` : ''}
                                ${tw.template === 'group-knockout' ? `<div style="margin-bottom:12px;"><strong>ë³¸ì„  ì§„ì¶œ:</strong> ê° ì¡° ìƒìœ„ ${tw.preliminary.advanceCount}ëª… (ì´ ${tw.preliminary.groupCount * tw.preliminary.advanceCount}ëª…)</div>` : ''}
                                <div><strong>ì„¸íŠ¸:</strong> ${tw.preliminary.sets}ì„¸íŠ¸ (${Math.ceil(tw.preliminary.sets/2)}ì„ ìŠ¹)</div>
                            </div>
                        `;
                    }
                } else if (tw.step === 5) {
                    // Step 5: ëŒ€ì§„í‘œ í™•ì¸
                    const previewHTML = generateTWPreview();
                    
                    stepContent = `
                        <div style="background:#e8f5e9; padding:16px; border-radius:8px; margin-bottom:16px;">
                            <h3 style="margin:0 0 8px 0;">âœ… ëŒ€ì§„í‘œ ë¯¸ë¦¬ë³´ê¸°</h3>
                            <p style="font-size:13px; margin:0;">ì•„ë˜ ëŒ€ì§„í‘œë¥¼ í™•ì¸í•˜ê³  ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰í•˜ì„¸ìš”.</p>
                        </div>
                        
                        ${tw.mode === 'custom' && tw.preliminary.enabled ? `
                            <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-bottom:16px;">
                                <strong>ğŸ“Š ì»¤ìŠ¤í…€ ëŒ€ì§„ ì„¤ì •</strong>
                                <div style="font-size:13px; margin-top:4px;">
                                    ì˜ˆì„ : ${tw.preliminary.groupCount}ê°œ ì¡°, ${tw.preliminary.sets}ì„¸íŠ¸<br>
                                    ë³¸ì„ : ${tw.finals.size}ê°•, ${tw.finals.sets}ì„¸íŠ¸
                                </div>
                            </div>
                        ` : ''}
                        
                        <div id="tw-preview" style="max-height:400px; overflow-y:auto;">
                            ${previewHTML}
                        </div>
                        
                        <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-top:16px;">
                            <strong>âš ï¸ í™•ì¸ ì‚¬í•­</strong>
                            <ul style="font-size:13px; margin:8px 0 0 0; padding-left:20px;">
                                <li>ì¡° í¸ì„±ì´ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”</li>
                                <li>ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‹¬íŒê³¼ ê²½ê¸°ì¥ì„ ì„¤ì •í•©ë‹ˆë‹¤</li>
                                <li>ì„¤ì • í›„ ëŒ€íšŒê°€ ìƒì„±ë©ë‹ˆë‹¤</li>
                            </ul>
                        </div>
                    `;
                } else if (tw.step === 6) {
                    // Step 6: ì‹¬íŒ/ê²½ê¸°ì¥ ì„¤ì •
                    if (!tw.referees) tw.referees = [];
                    if (!tw.courts) tw.courts = [];
                    
                    const refereeList = tw.referees.map((ref, idx) => `
                        <div style="background:white; padding:12px; border-radius:8px; margin-bottom:8px; border-left:4px solid #2196f3; display:flex; justify-content:space-between; align-items:center;">
                            <div style="flex:1;">
                                <strong>${ref.name}</strong><br>
                                <span style="font-size:12px; color:#666;">PIN: ${ref.pin || 'ë¯¸ì„¤ì •'} Â· ì—­í• : ${ref.role}</span>
                            </div>
                            <button class="btn" onclick="deleteTWReferee(${idx})" style="padding:6px 12px; font-size:12px; background:#ff6b6b; color:white; border:none; border-radius:4px;">ì‚­ì œ</button>
                        </div>
                    `).join('') || '<p style="text-align:center; color:#999; padding:12px;">ì‹¬íŒì„ ì¶”ê°€í•˜ì„¸ìš”</p>';
                    
                    const courtList = tw.courts.map((court, idx) => `
                        <div style="background:white; padding:12px; border-radius:8px; margin-bottom:8px; border-left:4px solid #4caf50; display:flex; justify-content:space-between; align-items:center;">
                            <div style="flex:1;">
                                <strong>${court.name}</strong><br>
                                <span style="font-size:12px; color:#666;">ê²½ê¸°ì¥</span>
                            </div>
                            <button class="btn" onclick="deleteTWCourt(${idx})" style="padding:6px 12px; font-size:12px; background:#ff6b6b; color:white; border:none; border-radius:4px;">ì‚­ì œ</button>
                        </div>
                    `).join('') || '<p style="text-align:center; color:#999; padding:12px;">ê²½ê¸°ì¥ì„ ì¶”ê°€í•˜ì„¸ìš”</p>';
                    
                    stepContent = `
                        <div style="background:#e3f2fd; padding:16px; border-radius:8px; margin-bottom:16px;">
                            <h3 style="margin:0 0 8px 0;">âš–ï¸ ì‹¬íŒ ì„¤ì •</h3>
                            <p style="font-size:13px; margin:0;">ì‹¬íŒ ì´ë¦„, ì—­í• , PIN ë²ˆí˜¸ë¥¼ ë“±ë¡í•˜ì„¸ìš”</p>
                        </div>
                        
                        <div class="form-group">
                            <label>ì‹¬íŒ ì´ë¦„</label>
                            <input type="text" id="tw-ref-name" placeholder="ì˜ˆ: í™ê¸¸ë™" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px;">
                        </div>
                        
                        <div class="form-group">
                            <label>ì—­í• </label>
                            <select id="tw-ref-role" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px;">
                                <option value="main">ì£¼ì‹¬</option>
                                <option value="assistant">ë¶€ì‹¬</option>
                                <option value="other">ê¸°íƒ€</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>PIN ë²ˆí˜¸ (6ìë¦¬ ì´ìƒ)</label>
                            <input type="text" id="tw-ref-pin" placeholder="ì˜ˆ: 123456" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px;" maxlength="10">
                            <small style="color:#666;">ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤</small>
                        </div>
                        
                        <button class="btn btn-primary" onclick="addTWReferee()" style="width:100%; margin-bottom:16px; background:#2196f3;">â• ì‹¬íŒ ì¶”ê°€</button>
                        
                        <div style="background:#f5f5f5; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <h4 style="margin:0 0 12px 0;">ë“±ë¡ëœ ì‹¬íŒ</h4>
                            ${refereeList}
                        </div>
                        
                        <div style="border-top:2px solid #e0e0e0; padding-top:16px;">
                            <div style="background:#e8f5e9; padding:16px; border-radius:8px; margin-bottom:16px;">
                                <h3 style="margin:0 0 8px 0;">ğŸŸï¸ ê²½ê¸°ì¥ ì„¤ì •</h3>
                                <p style="font-size:13px; margin:0;">ì‚¬ìš©í•  ê²½ê¸°ì¥ì„ ë“±ë¡í•˜ì„¸ìš”</p>
                            </div>
                            
                            <div class="form-group">
                                <label>ê²½ê¸°ì¥ ì´ë¦„</label>
                                <input type="text" id="tw-court-name" placeholder="ì˜ˆ: 1ë²ˆ ì½”íŠ¸" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px;">
                            </div>
                            
                            <button class="btn btn-success" onclick="addTWCourt()" style="width:100%; margin-bottom:16px;">â• ê²½ê¸°ì¥ ì¶”ê°€</button>
                            
                            <div style="background:#f5f5f5; padding:12px; border-radius:8px;">
                                <h4 style="margin:0 0 12px 0;">ë“±ë¡ëœ ê²½ê¸°ì¥</h4>
                                ${courtList}
                            </div>
                        </div>
                    `;
                }
                
                // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼
                const navButtons = `
                    <div style="display:flex; gap:12px; margin-top:24px;">
                        ${tw.step > 1 ? `<button class="btn" onclick="twPrevStep()" style="flex:1;">â† ì´ì „</button>` : `<button class="btn" onclick="goTo('bracket-home')" style="flex:1;">â† ì·¨ì†Œ</button>`}
                        ${tw.step < totalSteps ? 
                            `<button class="btn btn-primary" onclick="twNextStep()" style="flex:1;">ë‹¤ìŒ â†’</button>` : 
                            `<button class="btn btn-primary" onclick="confirmTournament()" style="flex:1; background:#4caf50; font-weight:bold; padding:12px; font-size:16px;">âœ… ëŒ€íšŒ ìƒì„±!</button>`
                        }
                    </div>
                `;
                
                app.innerHTML = `
                    <div class="card">
                        <div class="header" style="margin:-20px -20px 20px -20px; padding:20px; border-radius:12px 12px 0 0; background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);">
                            <h1 style="color:white; margin:0; font-size:20px;">ğŸ† ëŒ€íšŒ ëŒ€ì§„ ì„¤ì •</h1>
                            <p style="color:rgba(255,255,255,0.9); margin:8px 0 0 0; font-size:14px;">${stepTitles[tw.step]}</p>
                        </div>
                        ${progressHTML}
                        ${stepContent}
                        ${navButtons}
                    </div>
                `;
                
                // ì„¤ì • ìš”ì•½ ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    if (tw.step === 4) updateTWSettingsSummary();
                }, 100);
            }
            else if (screen === 'viewer-select-project') {
                // í”„ë¡œì íŠ¸ ëª©ë¡ í‘œì‹œ
                const projectList = projects.map((p, i) => {
                    const isTeam = p.competitionType === 'team';
                    const participantCount = isTeam ? (p.teams?.length || 0) : (p.players?.length || 0);
                    const hasGroups = p.groups?.length > 0;
                    const hasResult = p.autoTournamentResult;
                    
                    return `
                        <div style="padding:16px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; cursor:pointer; border-left:4px solid ${hasResult ? 'var(--success)' : 'var(--primary)'};" onclick="openViewerProject(${i})">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong>${p.name}</strong>
                                <span style="font-size:12px; color:var(--text-secondary);">${isTeam ? 'íŒ€ì „' : 'ê°œì¸ì „'}</span>
                            </div>
                            <div style="font-size:13px; color:var(--text-secondary); margin-top:4px;">
                                ${participantCount > 0 ? `${participantCount}${isTeam ? 'íŒ€' : 'ëª…'} ì°¸ê°€` : ''}
                                ${hasGroups ? ` Â· ${p.groups.length}ê°œ ì¡°` : ''}
                                ${hasResult ? ' Â· âœ… ê²°ê³¼ ìˆìŒ' : ''}
                            </div>
                        </div>
                    `;
                }).join('') || '<p style="text-align:center; color:var(--text-secondary); padding:20px;">ë“±ë¡ëœ ëŒ€íšŒê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('viewer-home')" style="margin-bottom:16px;" aria-label="ê´€ëŒ ëª¨ë“œ í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°">â† ëŒì•„ê°€ê¸°</button>
                        <h2>ğŸ“‹ ëŒ€íšŒ ì„ íƒ</h2>
                        ${projectList}
                    </div>
                `;
            }
            else if (screen === 'viewer-results') {
                // ì„ íƒëœ í”„ë¡œì íŠ¸ì˜ ê²°ê³¼ í‘œì‹œ
                if (!currentProject) {
                    goTo('viewer-select-project');
                    return;
                }
                
                const isTeam = currentProject.competitionType === 'team';
                const hasAutoResult = currentProject.autoTournamentResult;
                const hasGroups = currentProject.groups?.length > 0;
                
                // ëŒ€íšŒ ê·œì¹™ í‘œì‹œ
                const rulesHTML = currentProject.rules ? `
                    <div style="background:#e3f2fd; padding:12px; border-radius:8px; margin-bottom:16px;">
                        <div style="font-weight:600; margin-bottom:8px;">ğŸ“‹ ëŒ€íšŒ ê·œì¹™</div>
                        <div style="font-size:13px; white-space:pre-wrap;">${currentProject.rules}</div>
                    </div>
                ` : '';
                
                // ì„¸íŠ¸ ìˆ˜ ì •ë³´
                const setsInfo = [];
                if (currentProject.preliminarySets && currentProject.tournamentType !== 'knockout-only') {
                    setsInfo.push(`ì˜ˆì„  ${currentProject.preliminarySets}ì„¸íŠ¸`);
                }
                if (currentProject.finalsSets && currentProject.tournamentType !== 'group-only') {
                    setsInfo.push(`ë³¸ì„  ${currentProject.finalsSets}ì„¸íŠ¸`);
                }
                const setsDisplay = setsInfo.length > 0 ? ` Â· ${setsInfo.join(', ')}` : '';
                
                let tabsHTML = '';
                let contentHTML = '';
                
                // íƒ­ ë©”ë‰´
                tabsHTML = `
                    <div style="display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap;">
                        <button class="btn viewer-tab active" onclick="switchViewerTab('overview')" id="tab-overview" aria-label="ì „ì²´ í˜„í™© íƒ­">ğŸ“Š ì „ì²´ í˜„í™©</button>
                        ${hasGroups ? `<button class="btn viewer-tab" onclick="switchViewerTab('groups')" id="tab-groups" aria-label="ì¡°ë³„ ìˆœìœ„ íƒ­">ğŸ“‹ ì¡°ë³„ ìˆœìœ„</button>` : ''}
                        <button class="btn viewer-tab" onclick="switchViewerTab('bracket')" id="tab-bracket" aria-label="ëŒ€ì§„í‘œ íƒ­">ğŸ† ëŒ€ì§„í‘œ</button>
                        <button class="btn viewer-tab" onclick="switchViewerTab('records')" id="tab-records" aria-label="ê°œì¸ ê¸°ë¡ íƒ­">ğŸ‘¤ ê°œì¸ ê¸°ë¡</button>
                    </div>
                `;
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('viewer-select-project')" style="margin-bottom:16px;" aria-label="ëŒ€íšŒ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°">â† ëŒ€íšŒ ëª©ë¡</button>
                        <h2>ğŸ“Š ${currentProject.name}</h2>
                        <p style="color:var(--text-secondary); margin-bottom:16px;">${isTeam ? 'íŒ€ì „' : 'ê°œì¸ì „'} Â· ${currentProject.date || ''}${setsDisplay}</p>
                        
                        ${rulesHTML}
                        ${tabsHTML}
                        
                        <div id="viewer-content">
                            ${renderViewerOverview()}
                        </div>
                    </div>
                    
                    <style>
                        .viewer-tab { background: var(--bg-secondary); }
                        .viewer-tab.active { background: var(--primary); color: white; }
                    </style>
                `;
            }
            // ========== ëœë¤ íŒ€ ë¦¬ê·¸ì „ í™”ë©´ ==========
            else if (screen === 'random-team-league') {
                const rtl = window.randomTeamLeague || { participants: [], teams: [], matches: [], phase: 'input' };
                window.randomTeamLeague = rtl;
                
                let content = '';
                
                if (rtl.phase === 'input') {
                    // ì°¸ê°€ì ì…ë ¥ ë‹¨ê³„
                    const participantList = rtl.participants.map((p, i) => `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:${p.gender === 'M' ? '#e3f2fd' : '#fce4ec'}; border-radius:4px; margin:4px 0;">
                            <span>${p.gender === 'M' ? 'ğŸ‘¨' : 'ğŸ‘©'} ${p.name}</span>
                            <button class="btn btn-danger" onclick="removeRTLParticipant(${i})" style="padding:4px 8px; min-width:auto;" aria-label="${p.name} ì‚­ì œ">âœ•</button>
                        </div>
                    `).join('') || '<p style="color:var(--text-secondary); text-align:center; padding:20px;">ì°¸ê°€ìë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”</p>';
                    
                    const maleCount = rtl.participants.filter(p => p.gender === 'M').length;
                    const femaleCount = rtl.participants.filter(p => p.gender === 'F').length;
                    
                    content = `
                        <div class="card">
                            <button class="btn" onclick="goTo('referee-home')" style="margin-bottom:16px;" aria-label="ì‹¬íŒ ëª¨ë“œë¡œ ëŒì•„ê°€ê¸°">â† ëŒì•„ê°€ê¸°</button>
                            <h2>ğŸ² ëœë¤ íŒ€ ë¦¬ê·¸ì „</h2>
                            
                            <!-- ìë™ ì‹œë®¬ë ˆì´ì…˜ ì˜µì…˜ -->
                            <div style="background:linear-gradient(135deg, #667eea22 0%, #764ba222 100%); padding:16px; border-radius:8px; margin-bottom:16px; border:2px dashed #667eea;">
                                <strong style="display:block; margin-bottom:8px;">ğŸ² ìë™ ì‹œë®¬ë ˆì´ì…˜</strong>
                                <p style="font-size:12px; color:#666; margin-bottom:12px;">ì°¸ê°€ìë¥¼ ìë™ ìƒì„±í•˜ì—¬ ë¹ ë¥´ê²Œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:end;">
                                    <div>
                                        <label for="rtl-auto-count" style="font-size:12px;">ì´ ì¸ì›</label>
                                        <select id="rtl-auto-count" style="width:100%;" aria-label="ìë™ ìƒì„± ì¸ì› ìˆ˜">
                                            <option value="6">6ëª…</option>
                                            <option value="8">8ëª…</option>
                                            <option value="10">10ëª…</option>
                                            <option value="12" selected>12ëª…</option>
                                            <option value="16">16ëª…</option>
                                            <option value="20">20ëª…</option>
                                            <option value="24">24ëª…</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="rtl-auto-ratio" style="font-size:12px;">ì„±ë¹„</label>
                                        <select id="rtl-auto-ratio" style="width:100%;" aria-label="ë‚¨ë…€ ì„±ë¹„ ì„ íƒ">
                                            <option value="equal">ê· ë“± (1:1)</option>
                                            <option value="male">ë‚¨ì„± ë§ìŒ (2:1)</option>
                                            <option value="female">ì—¬ì„± ë§ìŒ (1:2)</option>
                                        </select>
                                    </div>
                                    <button class="btn" onclick="generateRTLAutoParticipants()" style="background:#667eea; color:white;" aria-label="ì°¸ê°€ì ìë™ ìƒì„±">
                                        ìë™ ìƒì„±
                                    </button>
                                </div>
                            </div>
                            
                            <div style="background:#e8f5e9; padding:12px; border-radius:8px; margin-bottom:16px;">
                                <strong>1ë‹¨ê³„: ì°¸ê°€ì ì…ë ¥</strong>
                                <p style="font-size:13px; margin-top:4px;">ì°¸ê°€ì ì´ë¦„ê³¼ ì„±ë³„ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
                            </div>
                            
                            <div style="display:grid; grid-template-columns:1fr auto auto; gap:8px; margin-bottom:16px;">
                                <input type="text" id="rtl-name" placeholder="ì´ë¦„" style="width:100%;" aria-label="ì°¸ê°€ì ì´ë¦„ ì…ë ¥">
                                <select id="rtl-gender" style="width:80px;" aria-label="ì„±ë³„ ì„ íƒ">
                                    <option value="M">ë‚¨</option>
                                    <option value="F">ì—¬</option>
                                </select>
                                <button class="btn btn-primary" onclick="addRTLParticipant()" style="min-width:60px;" aria-label="ì°¸ê°€ì ì¶”ê°€">ì¶”ê°€</button>
                            </div>
                            
                            <div style="background:#f5f5f5; padding:12px; border-radius:8px; margin-bottom:12px;" aria-live="polite">
                                <div style="font-size:18px; font-weight:bold; margin-bottom:8px;">
                                    ì´ ${rtl.participants.length}ëª…
                                </div>
                                <div style="display:flex; gap:12px;">
                                    <span style="background:#e3f2fd; padding:4px 12px; border-radius:12px; font-size:14px;">ğŸ‘¨ ë‚¨ ${maleCount}ëª…</span>
                                    <span style="background:#fce4ec; padding:4px 12px; border-radius:12px; font-size:14px;">ğŸ‘© ì—¬ ${femaleCount}ëª…</span>
                                </div>
                            </div>
                            
                            <div style="max-height:250px; overflow-y:auto; margin-bottom:16px;">
                                ${participantList}
                            </div>
                            
                            ${rtl.participants.length >= 6 ? `
                                <button class="btn btn-primary" onclick="goToRTLTeamSetup()" style="width:100%;" aria-label="íŒ€ ì„¤ì • ë‹¨ê³„ë¡œ ì´ë™">
                                    ë‹¤ìŒ: íŒ€ ì„¤ì • â†’
                                </button>
                            ` : `
                                <p style="color:var(--text-secondary); text-align:center; font-size:13px;">
                                    ìµœì†Œ 6ëª… ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤ (í˜„ì¬ ${rtl.participants.length}ëª…)
                                </p>
                            `}
                        </div>
                    `;
                } else if (rtl.phase === 'team-setup') {
                    // íŒ€ ì„¤ì • ë‹¨ê³„
                    const totalCount = rtl.participants.length;
                    const maleCount = rtl.participants.filter(p => p.gender === 'M').length;
                    const femaleCount = rtl.participants.filter(p => p.gender === 'F').length;
                    
                    // ê°€ëŠ¥í•œ íŒ€ ê°œìˆ˜ ê³„ì‚° (2~5ëª… ê¸°ì¤€)
                    const minTeams = Math.ceil(totalCount / 5);
                    const maxTeams = Math.floor(totalCount / 2);
                    
                    let teamOptions = '';
                    for (let t = Math.max(2, minTeams); t <= maxTeams; t++) {
                        const perTeam = Math.floor(totalCount / t);
                        const remainder = totalCount % t;
                        const desc = remainder > 0 ? `${perTeam}~${perTeam+1}ëª…ì”©` : `${perTeam}ëª…ì”©`;
                        teamOptions += `<option value="${t}">${t}íŒ€ (${desc})</option>`;
                    }
                    
                    // ì €ì¥ëœ ì„¤ì •ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
                    const savedTeamCount = rtl.teamCount || Math.max(2, minTeams);
                    const savedMembersPerTeam = rtl.membersPerTeam || 3;
                    const savedTopseeds = rtl.topseeds || [];
                    const savedTournamentType = rtl.tournamentType || 'full-league';
                    
                    content = `
                        <div class="card">
                            <button class="btn" onclick="window.randomTeamLeague.phase='input'; render();" style="margin-bottom:16px;" aria-label="ì°¸ê°€ì ì…ë ¥ ë‹¨ê³„ë¡œ ëŒì•„ê°€ê¸°">â† ì°¸ê°€ì ìˆ˜ì •</button>
                            <h2>ğŸ² íŒ€ ì„¤ì •</h2>
                            
                            <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-bottom:16px;">
                                <strong>2ë‹¨ê³„: íŒ€ êµ¬ì„± ì„¤ì •</strong>
                                <p style="font-size:13px; margin-top:4px;">ì°¸ê°€ì ${totalCount}ëª… (ğŸ‘¨${maleCount} ğŸ‘©${femaleCount})</p>
                            </div>
                            
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                                <div>
                                    <label for="rtl-team-count">íŒ€ ê°œìˆ˜</label>
                                    <select id="rtl-team-count" onchange="updateRTLTopseedInputs()" style="width:100%;" aria-label="íŒ€ ê°œìˆ˜ ì„ íƒ">
                                        ${teamOptions}
                                    </select>
                                </div>
                                <div>
                                    <label for="rtl-members-per-team">íŒ€ë‹¹ ì¸ì›</label>
                                    <select id="rtl-members-per-team" style="width:100%;" aria-label="íŒ€ë‹¹ ì¸ì› ìˆ˜ ì„ íƒ">
                                        <option value="2">2ëª…</option>
                                        <option value="3" selected>3ëª…</option>
                                        <option value="4">4ëª…</option>
                                        <option value="5">5ëª…</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- ëŒ€íšŒ ë°©ì‹ ì„ íƒ -->
                            <div style="background:#e3f2fd; padding:16px; border-radius:8px; margin-bottom:16px;">
                                <strong style="display:block; margin-bottom:12px;">ğŸ† ëŒ€íšŒ ë°©ì‹</strong>
                                
                                <label style="display:flex; align-items:flex-start; gap:10px; padding:10px; background:white; border-radius:6px; margin-bottom:8px; cursor:pointer; border:2px solid transparent;" 
                                       onclick="selectRTLTournamentType('full-league')" id="rtl-type-full-league-label">
                                    <input type="radio" name="rtl-tournament-type" value="full-league" id="rtl-type-full-league" 
                                           ${savedTournamentType === 'full-league' ? 'checked' : ''} 
                                           onchange="updateRTLTournamentOptions()" style="margin-top:3px;">
                                    <div>
                                        <strong>í’€ë¦¬ê·¸</strong>
                                        <p style="font-size:12px; color:#666; margin-top:2px;">ëª¨ë“  íŒ€ì´ ì„œë¡œ í•œ ë²ˆì”© ëŒ€ì „ â†’ ìµœì¢… ìˆœìœ„ ê²°ì •</p>
                                    </div>
                                </label>
                                
                                <label style="display:flex; align-items:flex-start; gap:10px; padding:10px; background:white; border-radius:6px; cursor:pointer; border:2px solid transparent;"
                                       onclick="selectRTLTournamentType('group-tournament')" id="rtl-type-group-tournament-label">
                                    <input type="radio" name="rtl-tournament-type" value="group-tournament" id="rtl-type-group-tournament"
                                           ${savedTournamentType === 'group-tournament' ? 'checked' : ''}
                                           onchange="updateRTLTournamentOptions()" style="margin-top:3px;">
                                    <div>
                                        <strong>ì¡°ë³„ ë¦¬ê·¸ + í† ë„ˆë¨¼íŠ¸</strong>
                                        <p style="font-size:12px; color:#666; margin-top:2px;">ì¡°ë³„ ì˜ˆì„  ë¦¬ê·¸ â†’ ìƒìœ„íŒ€ ê²°ì„  í† ë„ˆë¨¼íŠ¸</p>
                                    </div>
                                </label>
                                
                                <!-- ì¡°ë³„+í† ë„ˆë¨¼íŠ¸ ì˜µì…˜ -->
                                <div id="rtl-group-tournament-options" style="display:${savedTournamentType === 'group-tournament' ? 'block' : 'none'}; margin-top:12px; padding:12px; background:#f5f5f5; border-radius:6px;">
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                        <div>
                                            <label for="rtl-group-count" style="font-size:13px;">ì¡° ê°œìˆ˜</label>
                                            <select id="rtl-group-count" onchange="updateRTLGroupPreview()" style="width:100%;" aria-label="ì¡° ê°œìˆ˜ ì„ íƒ">
                                                <option value="2">2ê°œ ì¡°</option>
                                                <option value="3">3ê°œ ì¡°</option>
                                                <option value="4">4ê°œ ì¡°</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="rtl-advance-count" style="font-size:13px;">ì¡°ë³„ ì§„ì¶œì</label>
                                            <select id="rtl-advance-count" onchange="updateRTLGroupPreview()" style="width:100%;" aria-label="ì¡°ë³„ ì§„ì¶œ íŒ€ ìˆ˜ ì„ íƒ">
                                                <option value="1">1íŒ€ì”©</option>
                                                <option value="2" selected>2íŒ€ì”©</option>
                                                <option value="3">3íŒ€ì”©</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="rtl-group-preview" style="margin-top:10px; font-size:12px; color:#666;" aria-live="polite"></div>
                                </div>
                            </div>
                            
                            <div style="background:#e8f5e9; padding:12px; border-radius:8px; margin-bottom:16px;">
                                <strong>ğŸ† ê° íŒ€ íƒ‘ì‹œë“œ ì„ íƒ</strong>
                                <p style="font-size:12px; margin-top:4px; color:#666;">íƒ‘ì‹œë“œëŠ” ê° íŒ€ì— ê³ ì • ë°°ì¹˜ë˜ê³ , ë‚˜ë¨¸ì§€ ì¸ì›ë§Œ ëœë¤ ë°°ì •ë©ë‹ˆë‹¤.</p>
                            </div>
                            
                            <div id="rtl-topseed-container">
                                <!-- íƒ‘ì‹œë“œ ì„ íƒ UIê°€ ì—¬ê¸°ì— ë™ì  ìƒì„± -->
                            </div>
                            
                            <label for="rtl-balance-gender" style="display:flex; align-items:center; gap:8px; margin:16px 0;">
                                <input type="checkbox" id="rtl-balance-gender" checked aria-label="ì„±ë³„ ê· í˜• ë§ì¶”ê¸° ì˜µì…˜">
                                ì„±ë³„ ê· í˜• ë§ì¶”ê¸° (ê°€ëŠ¥í•œ ê²½ìš°)
                            </label>
                            
                            <div id="rtl-validation-msg" style="margin-bottom:12px;" aria-live="assertive"></div>
                            
                            <button class="btn btn-primary" onclick="generateRandomTeamsWithTopseeds()" style="width:100%;" aria-label="ëœë¤ìœ¼ë¡œ íŒ€ ìƒì„±">
                                ğŸ² ëœë¤ íŒ€ ìƒì„±
                            </button>
                        </div>
                    `;
                    
                    // ë Œë” í›„ íƒ‘ì‹œë“œ ì…ë ¥ UI ìƒì„±
                    setTimeout(() => {
                        updateRTLTopseedInputs();
                        updateRTLTournamentOptions();
                        updateRTLGroupPreview();
                    }, 0);
                } else if (rtl.phase === 'teams-generated') {
                    // íŒ€ ìƒì„± ì™„ë£Œ - íŒ€ ì´ë¦„ ì…ë ¥ ê°€ëŠ¥
                    const tournamentType = rtl.tournamentType || 'full-league';
                    const isGroupTournament = tournamentType === 'group-tournament';
                    const groupCount = rtl.groupCount || 2;
                    const advanceCount = rtl.advanceCount || 2;
                    
                    // ì¡°ë³„+í† ë„ˆë¨¼íŠ¸ì¸ ê²½ìš° ì¡° í¸ì„± ë¯¸ë¦¬ë³´ê¸°
                    let groupAssignmentHTML = '';
                    if (isGroupTournament) {
                        const teamsPerGroup = Math.floor(rtl.teams.length / groupCount);
                        const remainder = rtl.teams.length % groupCount;
                        
                        groupAssignmentHTML = '<div style="background:#e3f2fd; padding:12px; border-radius:8px; margin-bottom:16px;">';
                        groupAssignmentHTML += `<strong>ğŸ“‹ ì¡°ë³„ ë¦¬ê·¸ + í† ë„ˆë¨¼íŠ¸</strong>`;
                        groupAssignmentHTML += `<p style="font-size:12px; margin-top:4px; color:#666;">`;
                        
                        for (let g = 0; g < groupCount; g++) {
                            const gTeams = teamsPerGroup + (g < remainder ? 1 : 0);
                            const startIdx = g * teamsPerGroup + Math.min(g, remainder);
                            const teamNames = [];
                            
                            // ìŠ¤ë„¤ì´í¬ ë°©ì‹ìœ¼ë¡œ ë°°ì •ë  íŒ€ë“¤ ê³„ì‚°
                            rtl.teams.forEach((t, idx) => {
                                const round = Math.floor(idx / groupCount);
                                const groupIdx = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                                if (groupIdx === g) {
                                    teamNames.push(t.name.match(/^\d+ì¡°$/) ? `íŒ€${idx+1}` : t.name);
                                }
                            });
                            
                            groupAssignmentHTML += `${String.fromCharCode(65 + g)}ì¡°: ${teamNames.join(', ')}<br>`;
                        }
                        
                        groupAssignmentHTML += `</p>`;
                        groupAssignmentHTML += `<p style="font-size:12px; margin-top:6px; color:#1976d2;">ğŸ¯ ê° ì¡° ìƒìœ„ ${advanceCount}íŒ€ â†’ ê²°ì„  í† ë„ˆë¨¼íŠ¸</p>`;
                        groupAssignmentHTML += '</div>';
                    } else {
                        groupAssignmentHTML = `<div style="background:#e8f5e9; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>ğŸ“‹ í’€ë¦¬ê·¸</strong>
                            <p style="font-size:12px; margin-top:4px; color:#666;">
                                ëª¨ë“  íŒ€ì´ ì„œë¡œ í•œ ë²ˆì”© ëŒ€ì „ â†’ ì´ ${rtl.teams.length * (rtl.teams.length - 1) / 2}ê²½ê¸°
                            </p>
                        </div>`;
                    }
                    
                    const teamsHTML = rtl.teams.map((team, ti) => `
                        <div style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid hsl(${ti * 60}, 70%, 50%);">
                            <input type="text" id="team-name-${ti}" value="${team.name}" 
                                   onchange="updateRTLTeamName(${ti}, this.value)"
                                   style="font-weight:bold; font-size:16px; border:2px dashed #ccc; padding:6px 10px; border-radius:6px; width:calc(100% - 24px);"
                                   placeholder="íŒ€ ì´ë¦„ ì…ë ¥">
                            <div style="margin-top:8px;">
                                ${team.members.map((m, mi) => {
                                    const isTopseed = team.topseed === m.name;
                                    const bgColor = m.gender === 'M' ? '#e3f2fd' : '#fce4ec';
                                    const border = isTopseed ? '2px solid #ffc107' : 'none';
                                    return `
                                        <span style="display:inline-block; padding:2px 8px; margin:2px; background:${bgColor}; border-radius:12px; font-size:13px; border:${border};">
                                            ${isTopseed ? 'ğŸ†' : ''} ${m.gender === 'M' ? 'ğŸ‘¨' : 'ğŸ‘©'} ${m.name}
                                        </span>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('');
                    
                    content = `
                        <div class="card">
                            <button class="btn" onclick="window.randomTeamLeague.phase='team-setup'; render();" style="margin-bottom:16px;" aria-label="íŒ€ ì„¤ì • ë‹¨ê³„ë¡œ ëŒì•„ê°€ê¸°">â† ë‹¤ì‹œ ì„¤ì •</button>
                            <h2>ğŸ² íŒ€ í¸ì„± ê²°ê³¼</h2>
                            
                            <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-bottom:16px;">
                                <strong>3ë‹¨ê³„: íŒ€ ì´ë¦„ ì •í•˜ê¸°</strong>
                                <p style="font-size:13px; margin-top:4px;">ê° íŒ€ì—ì„œ íŒ€ ì´ë¦„ì„ ì •í•´ì£¼ì„¸ìš”! (ğŸ† = íƒ‘ì‹œë“œ)</p>
                            </div>
                            
                            ${groupAssignmentHTML}
                            
                            ${teamsHTML}
                            
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:16px;">
                                <button class="btn" onclick="generateRandomTeamsWithTopseeds()">ğŸ”„ ë‹¤ì‹œ ì„ê¸°</button>
                                <button class="btn btn-primary" onclick="startRTLLeague()">${isGroupTournament ? 'ëŒ€íšŒ ì‹œì‘ â†’' : 'ë¦¬ê·¸ì „ ì‹œì‘ â†’'}</button>
                            </div>
                        </div>
                    `;
                }
                
                app.innerHTML = content;
            }
            else if (screen === 'create-project') {
                app.innerHTML = `
                    <div class="card">
                        <h2>ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±</h2>
                        <label for="project-name">í”„ë¡œì íŠ¸ëª… *</label>
                        <input type="text" id="project-name" placeholder="ì˜ˆ: 2025 ì „êµ­ì¥ì• ì¸ì²´ìœ¡ëŒ€íšŒ" aria-label="í”„ë¡œì íŠ¸ëª… ì…ë ¥">
                        
                        <label for="competition-type">ê²½ê¸° ì¢…ë¥˜ *</label>
                        <select id="competition-type" onchange="onCompetitionTypeChange()" aria-label="ê²½ê¸° ì¢…ë¥˜ ì„ íƒ">
                            <option value="individual">ê°œì¸ì „</option>
                            <option value="team">íŒ€ì „</option>
                        </select>
                        
                        <label style="margin-top:16px; margin-bottom:8px; display:block;">ëŒ€íšŒ ìœ í˜• *</label>
                        <div id="tournament-type-cards" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <button type="button" class="tournament-type-btn active" data-type="free" onclick="selectTournamentType('free')" style="padding:16px; border:2px solid var(--primary); border-radius:8px; background:white; cursor:pointer; text-align:left;">
                                <div style="font-weight:bold; font-size:16px;">ğŸ“‹ ììœ  ê²½ê¸°</div>
                                <div style="font-size:12px; color:#666; margin-top:4px;">ëŒ€ì§„ ì—†ì´ ê²½ê¸°ë§Œ ê¸°ë¡</div>
                            </button>
                            <button type="button" class="tournament-type-btn" data-type="group" onclick="selectTournamentType('group')" style="padding:16px; border:2px solid #ddd; border-radius:8px; background:white; cursor:pointer; text-align:left;">
                                <div style="font-weight:bold; font-size:16px;">ğŸ† ì¡°ë³„ ë¦¬ê·¸</div>
                                <div style="font-size:12px; color:#666; margin-top:4px;">ëª¨ë“  íŒ€ì´ í•œ ë²ˆì”© ëŒ€ê²°</div>
                            </button>
                            <button type="button" class="tournament-type-btn" data-type="tournament" onclick="selectTournamentType('tournament')" style="padding:16px; border:2px solid #ddd; border-radius:8px; background:white; cursor:pointer; text-align:left;">
                                <div style="font-weight:bold; font-size:16px;">ğŸ¥Š í† ë„ˆë¨¼íŠ¸</div>
                                <div style="font-size:12px; color:#666; margin-top:4px;">ì§€ë©´ íƒˆë½í•˜ëŠ” ë…¹ì•„ì›ƒ</div>
                            </button>
                            <button type="button" class="tournament-type-btn" data-type="group-tournament" onclick="selectTournamentType('group-tournament')" style="padding:16px; border:2px solid #ddd; border-radius:8px; background:white; cursor:pointer; text-align:left;">
                                <div style="font-weight:bold; font-size:16px;">ğŸ¯ ì¡°ë³„+í† ë„ˆë¨¼íŠ¸</div>
                                <div style="font-size:12px; color:#666; margin-top:4px;">ì¡°ë³„ ì˜ˆì„  â†’ ê²°ì„  í† ë„ˆë¨¼íŠ¸</div>
                            </button>
                        </div>
                        <input type="hidden" id="tournament-type" value="free">
                        
                        <div id="group-settings" style="display:none; margin-top:16px; padding:16px; background:var(--bg-secondary); border-radius:8px;">
                            <h3 style="margin-bottom:12px;">ì¡°ë³„ ë¦¬ê·¸ ì„¤ì •</h3>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                <div>
                                    <label for="group-count">ì¡° ê°œìˆ˜</label>
                                    <input type="number" id="group-count" value="4" min="1" max="99" style="width:100%;" aria-label="ì¡° ê°œìˆ˜ ì…ë ¥">
                                </div>
                                <div>
                                    <label for="advance-count">ì¡°ë³„ ì§„ì¶œì ìˆ˜</label>
                                    <input type="number" id="advance-count" value="2" min="1" max="10" style="width:100%;" aria-label="ì¡°ë³„ ì§„ì¶œì ìˆ˜ ì…ë ¥">
                                </div>
                            </div>
                            <p style="font-size:12px; color:var(--text-secondary); margin-top:8px;">
                                â€» IBSA: ì¡°ë³„ ì¸ì›ì´ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë©°, ìŠ¹ë¥ ë¡œ ìˆœìœ„ ê²°ì •
                            </p>
                        </div>
                        
                        <div id="tournament-settings" style="display:none; margin-top:16px; padding:16px; background:var(--bg-secondary); border-radius:8px;">
                            <h3 style="margin-bottom:12px;">í† ë„ˆë¨¼íŠ¸ ì„¤ì •</h3>
                            <label for="tournament-size">ì°¸ê°€ <span id="tournament-unit">ì¸ì›</span></label>
                            <input type="number" id="tournament-size" value="8" min="2" max="999" style="width:100%;" aria-label="í† ë„ˆë¨¼íŠ¸ ì°¸ê°€ ì¸ì› ì…ë ¥">
                            <label for="third-place-match" style="display:flex; align-items:center; gap:8px; margin-top:12px;">
                                <input type="checkbox" id="third-place-match" checked aria-label="3/4ìœ„ ê²°ì •ì „ ì§„í–‰ ì—¬ë¶€">
                                3/4ìœ„ ê²°ì •ì „ ì§„í–‰
                            </label>
                        </div>
                        
                        <div id="team-settings" style="display:none; margin-top:16px; padding:16px; background:#e3f2fd; border-radius:8px; border-left:4px solid var(--primary);">
                            <h3 style="margin-bottom:12px;">ğŸ… IBSA íŒ€ì „ ê·œì¹™</h3>
                            <ul style="font-size:13px; color:var(--text-secondary); margin:0; padding-left:20px;">
                                <li>íŒ€ êµ¬ì„±: 3~6ëª… (í˜¼ì„±)</li>
                                <li>ë¼ì¸ì—…: ë‚¨2+ì—¬1 ë˜ëŠ” ì—¬2+ë‚¨1</li>
                                <li>ê²½ê¸° ë°©ì‹: 31ì  2ì ì°¨, ë‹¨íŒ</li>
                                <li>ì„œë¸Œ: 3íšŒì”© êµëŒ€</li>
                            </ul>
                        </div>
                        
                        <label for="project-date" style="margin-top:16px;">ë‚ ì§œ (ì„ íƒì‚¬í•­)</label>
                        <input type="text" id="project-date" placeholder="ì˜ˆ: 2025-03-15 ë˜ëŠ” 3ì›” 15ì¼" aria-label="ëŒ€íšŒ ë‚ ì§œ ì…ë ¥">
                        <label for="project-location">ì¥ì†Œ (ì„ íƒì‚¬í•­)</label>
                        <input type="text" id="project-location" placeholder="ì˜ˆ: ì„œìš¸ì¢…í•©ìš´ë™ì¥" aria-label="ëŒ€íšŒ ì¥ì†Œ ì…ë ¥">
                        <label for="project-desc">ì„¤ëª… (ì„ íƒì‚¬í•­)</label>
                        <textarea id="project-desc" rows="3" placeholder="í”„ë¡œì íŠ¸ ì„¤ëª…" aria-label="í”„ë¡œì íŠ¸ ì„¤ëª… ì…ë ¥"></textarea>
                        <div class="action-row">
                            <button type="button" role="button" class="btn btn-danger" onclick="goTo('referee-home')" aria-label="ì·¨ì†Œí•˜ê³  ëŒì•„ê°€ê¸°">ì·¨ì†Œ</button>
                            <button type="button" role="button" class="btn btn-primary" onclick="createProject()" aria-label="í”„ë¡œì íŠ¸ ìƒì„±">ìƒì„±</button>
                        </div>
                    </div>
                `;
            }
            else if (screen === 'project-list') {
                const isReferee = (userRole === 'referee');
                const backScreen = isReferee ? 'referee-home' : 'viewer-home';
                
                // ê²€ìƒ‰ í•„í„°ë§ ì ìš©
                const searchQuery = window.projectSearchQuery || '';
                const filteredProjects = searchQuery ? 
                    projects.filter(p => 
                        p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        (p.date && p.date.includes(searchQuery)) ||
                        (p.location && p.location.toLowerCase().includes(searchQuery.toLowerCase())) ||
                        (p.matches && p.matches.some(m => 
                            m.player1Name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                            m.player2Name.toLowerCase().includes(searchQuery.toLowerCase())
                        ))
                    ) : projects;
                
                let projectListHTML = '';
                if (filteredProjects.length === 0) {
                    projectListHTML = searchQuery ? 
                        '<p style="text-align:center; padding:40px; color:var(--text-secondary)">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>' :
                        '<p style="text-align:center; padding:40px; color:var(--text-secondary)">ìƒì„±ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    projectListHTML = filteredProjects.map((p, i) => {
                        const originalIdx = projects.indexOf(p);
                        const typeLabel = p.isRandomTeamLeague ? 'ğŸ²' : (p.competitionType === 'team' ? 'ğŸ‘¥' : 'ğŸ‘¤');
                        return `
                        <div class="folder-item" style="display:flex; justify-content:space-between; align-items:center;">
                            <div onclick="selectProject(${originalIdx})" style="flex:1; cursor:pointer;" role="button" tabindex="0" aria-label="${p.name} í”„ë¡œì íŠ¸ ì—´ê¸°">
                                <h4>${typeLabel} ${p.name}</h4>
                                <p style="color:var(--text-secondary); font-size:14px; margin-top:4px">
                                    ${p.date || 'ë‚ ì§œ ë¯¸ì •'} Â· ${p.location || 'ì¥ì†Œ ë¯¸ì •'} Â· ${p.competitionType === 'team' ? (p.teams?.length || 0) + 'íŒ€' : 'ê²½ê¸° ' + (p.matches?.length || 0) + 'ê°œ'}
                                </p>
                            </div>
                            <button class="btn" onclick="event.stopPropagation(); showProjectQR(${originalIdx})" style="padding:8px 12px; min-width:auto;" aria-label="${p.name} QR ê³µìœ ">ğŸ“±</button>
                        </div>
                    `}).join('');
                }
                
                // í¸ì§‘ ë²„íŠ¼ (ì‹¬íŒ ëª¨ë“œ + í”„ë¡œì íŠ¸ ìˆì„ ë•Œë§Œ)
                const editButtonHTML = (isReferee && projects.length > 0) ? 
                    '<button type="button" role="button" class="btn btn-danger" onclick="goTo(\'edit-projects\')" aria-label="í”„ë¡œì íŠ¸ í¸ì§‘ ëª¨ë“œ">ğŸ—‘ï¸ í¸ì§‘</button>' : '';
                
                // ê´€ëŒ ëª¨ë“œ ì•ˆë‚´
                const viewerNoticeHTML = !isReferee ? 
                    '<div style="background:#e3f2fd; padding:12px; border-radius:8px; margin-bottom:16px;"><span style="color:#1565c0;">ğŸ‘ï¸ ê´€ëŒ ëª¨ë“œ - í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì—¬ ê²½ê¸°ë¥¼ í™•ì¸í•˜ì„¸ìš”</span></div>' : '';
                
                app.innerHTML = `
                    <div class="card">
                        <h2>í”„ë¡œì íŠ¸ ëª©ë¡</h2>
                        ${viewerNoticeHTML}
                        
                        <div style="margin-bottom:16px;">
                            <div style="display:flex; gap:8px;">
                                <input type="text" id="project-search" placeholder="ğŸ” í”„ë¡œì íŠ¸, ë‚ ì§œ, ì¥ì†Œ, ì„ ìˆ˜ëª… ê²€ìƒ‰..." 
                                    value="${searchQuery}" 
                                    style="flex:1;" 
                                    onkeyup="if(event.key==='Enter') searchProjects()"
                                    aria-label="í”„ë¡œì íŠ¸ ê²€ìƒ‰">
                                <button class="btn btn-primary" onclick="searchProjects()" aria-label="ê²€ìƒ‰ ì‹¤í–‰">ê²€ìƒ‰</button>
                                ${searchQuery ? '<button class="btn" onclick="clearSearch()" aria-label="ê²€ìƒ‰ ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>' : ''}
                            </div>
                        </div>
                        
                        ${searchQuery ? `<p style="color:var(--text-secondary); margin-bottom:12px;">ê²€ìƒ‰ ê²°ê³¼: ${filteredProjects.length}ê°œ</p>` : ''}
                        ${projectListHTML}
                        <div style="display:flex; gap:12px; margin-top:16px; flex-wrap:wrap;">
                            <button type="button" role="button" class="btn" onclick="goTo('${backScreen}')" aria-label="ë’¤ë¡œ ê°€ê¸°">â† ë’¤ë¡œ</button>
                            ${editButtonHTML}
                        </div>
                    </div>
                `;
            }
            else if (screen === 'edit-projects') {
                // í”„ë¡œì íŠ¸ í¸ì§‘ ëª¨ë“œ (ì‚­ì œìš©)
                let editListHTML = '';
                if (projects.length === 0) {
                    editListHTML = '<p style="text-align:center; padding:40px; color:var(--text-secondary)">ì‚­ì œí•  í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    editListHTML = projects.map((p, i) => `
                        <div class="folder-item" style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h4>ğŸ“ ${p.name}</h4>
                                <p style="color:var(--text-secondary); font-size:14px; margin-top:4px">
                                    ê²½ê¸° ${p.matches?.length || 0}ê°œ
                                </p>
                            </div>
                            <button type="button" role="button" onclick="deleteProject(${i})" 
                                    aria-label="${p.name} í”„ë¡œì íŠ¸ ì‚­ì œ"
                                    class="btn btn-danger" style="min-width:auto; padding:8px 16px;">
                                ì‚­ì œ
                            </button>
                        </div>
                    `).join('');
                }
                
                app.innerHTML = `
                    <div class="card">
                        <h2>ğŸ—‘ï¸ í”„ë¡œì íŠ¸ í¸ì§‘</h2>
                        <p style="color:var(--text-secondary); margin-bottom:16px;">ì‚­ì œí•  í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                        ${editListHTML}
                        <button type="button" role="button" class="btn btn-primary" onclick="goTo('project-list')" style="margin-top:16px;" aria-label="í¸ì§‘ ì™„ë£Œ">âœ“ í¸ì§‘ ì™„ë£Œ</button>
                    </div>
                `;
            }
            else if (screen === 'project-detail') {
                const active = currentProject.matches ? currentProject.matches.filter(m => m.status === 'active') : [];
                const finished = currentProject.matches ? currentProject.matches.filter(m => m.status === 'completed') : [];
                const isReferee = (userRole === 'referee');
                const hasMatches = (active.length > 0 || finished.length > 0);
                
                let activeMatchesHTML = '';
                if (active.length > 0) {
                    activeMatchesHTML = `
                        <h3 style="color:var(--success); margin:16px 0">ì§„í–‰ ì¤‘ì¸ ê²½ê¸°</h3>
                        ${active.map(m => {
                            const idx = currentProject.matches.indexOf(m);
                            return `
                                <div class="match-item" onclick="selectMatch(${idx})" role="button" tabindex="0" aria-label="${m.player1Name} vs ${m.player2Name} ê²½ê¸° ì—´ê¸°">
                                    <h4>${m.player1Name} vs ${m.player2Name}</h4>
                                    <p style="color:var(--text-secondary); font-size:14px; margin-top:4px">
                                        ì„¸íŠ¸ ${m.currentSet}/${m.sets} Â· ${m.setScores[m.currentSet - 1].player1}-${m.setScores[m.currentSet - 1].player2} Â· ì£¼ì‹¬: ${m.mainReferee || 'ë¯¸ì •'}
                                    </p>
                                </div>
                            `;
                        }).join('')}
                    `;
                }
                
                let finishedMatchesHTML = '';
                if (finished.length > 0) {
                    finishedMatchesHTML = `
                        <h3 style="color:var(--text-secondary); margin:24px 0 16px">ì™„ë£Œëœ ê²½ê¸°</h3>
                        ${finished.map(m => {
                            const idx = currentProject.matches.indexOf(m);
                            return `
                                <div class="match-item" onclick="selectMatch(${idx})" role="button" tabindex="0" aria-label="${m.player1Name} vs ${m.player2Name} ê²½ê¸° ì—´ê¸°">
                                    <h4>${m.player1Name} vs ${m.player2Name}</h4>
                                    <p style="color:var(--text-secondary); font-size:14px; margin-top:4px">
                                        ì™„ë£Œ Â· ì£¼ì‹¬: ${m.mainReferee || 'ë¯¸ì •'}
                                    </p>
                                </div>
                            `;
                        }).join('')}
                    `;
                }
                
                let noMatchesHTML = '';
                if (!hasMatches) {
                    noMatchesHTML = '<p style="text-align:center; padding:20px; color:var(--text-secondary)">ìƒì„±ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
                
                // ë¯¸ë¦¬ ê³„ì‚°
                const titleHTML = isReferee ? 'ê²½ê¸° ê´€ë¦¬' : 'ê²½ê¸° ëª©ë¡';
                const createButtonHTML = isReferee ? 
                    '<button type="button" role="button" class="btn btn-primary" onclick="goTo(\'create-match\')" aria-label="ìƒˆ ê²½ê¸° ìƒì„±">â• ìƒˆ ê²½ê¸° ìƒì„±</button>' : 
                    '<div style="background:#e8f5e9; padding:12px; border-radius:8px; margin-bottom:16px;"><span style="color:#2e7d32;">ğŸ‘ï¸ ê´€ëŒ ëª¨ë“œ - ê²½ê¸°ë¥¼ ì„ íƒí•˜ì—¬ ì ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”</span></div>';
                const editButtonHTML = (isReferee && hasMatches) ? 
                    '<button type="button" role="button" class="btn btn-danger" onclick="goTo(\'edit-matches\')" aria-label="ê²½ê¸° í¸ì§‘ ëª¨ë“œ">ğŸ—‘ï¸ í¸ì§‘</button>' : '';
                
                // ê²½ê¸° ì¢…ë¥˜ (ê°œì¸ì „/íŒ€ì „)
                const isTeamCompetition = currentProject.competitionType === 'team';
                
                // ëŒ€íšŒ ê´€ë¦¬ ì„¹ì…˜ (ì¡°ë³„ ë¦¬ê·¸, í† ë„ˆë¨¼íŠ¸)
                let tournamentHTML = '';
                if (currentProject.tournamentType && currentProject.tournamentType !== 'free') {
                    const hasTournamentData = currentProject.groups?.length > 0 || currentProject.bracket;
                    const participantCount = isTeamCompetition ? 
                        (currentProject.teams?.length || 0) : 
                        (currentProject.players?.length || 0);
                    
                    tournamentHTML = `
                        <div class="card">
                            <h2>ğŸ† ëŒ€ì§„ ê´€ë¦¬</h2>
                            <div style="background:var(--bg-secondary); padding:12px; border-radius:8px; margin-bottom:16px;">
                                <div style="display:flex; flex-wrap:wrap; gap:16px;">
                                    <span><strong>ê²½ê¸° ì¢…ë¥˜:</strong> ${isTeamCompetition ? 'ğŸ… íŒ€ì „' : 'ğŸ‘¤ ê°œì¸ì „'}</span>
                                    <span><strong>ëŒ€íšŒ ìœ í˜•:</strong> ${
                                        currentProject.tournamentType === 'group' ? 'ì¡°ë³„ ë¦¬ê·¸' :
                                        currentProject.tournamentType === 'tournament' ? 'í† ë„ˆë¨¼íŠ¸' :
                                        'ì¡°ë³„ ë¦¬ê·¸ + ê²°ì„  í† ë„ˆë¨¼íŠ¸'
                                    }${currentProject.isRandomTeamLeague ? ' (ğŸ² ëœë¤ íŒ€)' : ''}</span>
                                </div>
                                ${currentProject.isRandomTeamLeague ? `
                                    <div style="margin-top:8px; padding:8px; background:linear-gradient(135deg, #667eea22, #764ba222); border-radius:4px; font-size:12px; border-left:3px solid #667eea;">
                                        <strong>ğŸ² ëœë¤ íŒ€ ë¦¬ê·¸ì „</strong> Â· ì°¸ê°€ìë¥¼ ëœë¤ìœ¼ë¡œ íŒ€ í¸ì„±í•˜ì—¬ ë¦¬ê·¸ì „ ì§„í–‰
                                    </div>
                                ` : ''}
                                ${isTeamCompetition ? `
                                    <div style="margin-top:8px; padding:8px; background:#e3f2fd; border-radius:4px; font-size:12px;">
                                        <strong>IBSA íŒ€ì „:</strong> 31ì  2ì ì°¨, ë‹¨íŒ, ì„œë¸Œ 3íšŒ êµëŒ€
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${isReferee ? `
                                <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;">
                                    ${isTeamCompetition ? `
                                        <button class="btn btn-primary" onclick="goTo('manage-teams')">ğŸ… íŒ€ ê´€ë¦¬</button>
                                    ` : `
                                        <button class="btn btn-primary" onclick="goTo('manage-players')">ğŸ‘¥ ì„ ìˆ˜ ê´€ë¦¬</button>
                                    `}
                                    ${(currentProject.tournamentType === 'group' || currentProject.tournamentType === 'group-tournament') ? 
                                        '<button class="btn btn-primary" onclick="goTo(\'manage-groups\')">ğŸ“‹ ì¡° í¸ì„±</button>' : ''}
                                    ${(currentProject.tournamentType === 'tournament' || currentProject.tournamentType === 'group-tournament') ? 
                                        '<button class="btn btn-primary" onclick="goTo(\'manage-bracket\')">ğŸ… ëŒ€ì§„í‘œ</button>' : ''}
                                    <button class="btn" onclick="goTo('standings')">ğŸ“Š ìˆœìœ„í‘œ</button>
                                    <button class="btn" onclick="goTo('statistics')">ğŸ“ˆ í†µê³„</button>
                                </div>
                                <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
                                    <button class="btn" onclick="goTo('auto-tournament')" style="background:#9c27b0; color:white;">ğŸ² ìë™ ëŒ€íšŒ ì§„í–‰</button>
                                </div>
                            ` : `
                                <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;">
                                    <button class="btn" onclick="goTo('standings')">ğŸ“Š ìˆœìœ„í‘œ</button>
                                    <button class="btn" onclick="goTo('statistics')">ğŸ“ˆ í†µê³„</button>
                                </div>
                            `}
                            
                            ${hasTournamentData || participantCount > 0 ? `
                                <div style="margin-top:12px;">
                                    ${participantCount > 0 ? `
                                        <p style="color:var(--text-secondary);">âœ… ${participantCount}${isTeamCompetition ? 'íŒ€' : 'ëª…'} ë“±ë¡</p>
                                    ` : ''}
                                    ${currentProject.groups?.length > 0 ? `
                                        <p style="color:var(--text-secondary);">âœ… ${currentProject.groups.length}ê°œ ì¡° í¸ì„± ì™„ë£Œ</p>
                                    ` : ''}
                                    ${currentProject.bracket ? `
                                        <p style="color:var(--text-secondary);">âœ… ëŒ€ì§„í‘œ ìƒì„± ì™„ë£Œ</p>
                                    ` : ''}
                                </div>
                            ` : `
                                <p style="color:var(--warning);">âš ï¸ ${isTeamCompetition ? 'íŒ€' : 'ì„ ìˆ˜'} ë“±ë¡ ë° ëŒ€ì§„ í¸ì„±ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
                            `}
                        </div>
                    `;
                }
                
                app.innerHTML = `
                    <div class="card">
                        <button type="button" role="button" class="btn" onclick="goTo('project-list')" aria-label="í”„ë¡œì íŠ¸ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°" style="margin-bottom:16px;">â† í”„ë¡œì íŠ¸ ëª©ë¡</button>
                        <h2>ğŸ“ ${currentProject.name}</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">ë‚ ì§œ</div>
                                <div class="info-value">${currentProject.date || 'ë¯¸ì •'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">ì¥ì†Œ</div>
                                <div class="info-value">${currentProject.location || 'ë¯¸ì •'}</div>
                            </div>
                        </div>
                        ${currentProject.desc ? `<p style="margin-top:12px; color:var(--text-secondary)">${currentProject.desc}</p>` : ''}
                    </div>
                    ${tournamentHTML}
                    <div class="card">
                        <h2>${titleHTML}</h2>
                        ${createButtonHTML}
                        ${noMatchesHTML}
                        ${activeMatchesHTML}
                        ${finishedMatchesHTML}
                        ${editButtonHTML ? `<div style="margin-top:16px;">${editButtonHTML}</div>` : ''}
                    </div>
                `;
            }
            else if (screen === 'edit-matches') {
                // ========== ğŸ† ëŒ€ì§„ í¸ì§‘ - ì‹¬íŒ/ê²½ê¸°ì¥ ë°°ì • ==========
                const allMatches = currentProject.matches || [];
                const referees = currentProject.referees || [];
                const courts = currentProject.courts || [];
                
                if (allMatches.length === 0) {
                    app.innerHTML = `
                        <div class="card">
                            <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">â† ëŒì•„ê°€ê¸°</button>
                            <h2>âš–ï¸ ê²½ê¸° í¸ì§‘</h2>
                            <p style="text-align:center; padding:40px; color:var(--text-secondary);">ìƒì„±ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                    return;
                }
                
                // ê²½ê¸°ë³„ ì‹¬íŒ/ê²½ê¸°ì¥ ë°°ì • í¼
                const matchesEditHTML = allMatches.map((m, idx) => `
                    <div class="card" style="padding:15px; margin-bottom:12px; border-left:4px solid ${m.mainRefereeName ? '#4caf50' : '#ff9800'};">
                        <div style="margin-bottom:12px;">
                            <h4 style="margin:0 0 4px 0;">${m.player1Name || 'ì„ ìˆ˜1'} vs ${m.player2Name || 'ì„ ìˆ˜2'}</h4>
                            <small style="color:#666;">
                                ğŸ“ ${m.courtName || 'ë¯¸ì§€ì •'} Â· 
                                ${m.status === 'completed' ? 'âœ… ì™„ë£Œ' : m.status === 'inprogress' ? 'â³ ì§„í–‰ì¤‘' : 'â­• ëŒ€ê¸°'}
                            </small>
                        </div>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                            <div>
                                <label style="font-size:13px; font-weight:600; display:block; margin-bottom:6px;">âš–ï¸ ì‹¬íŒ</label>
                                <select id="ref-${idx}" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px;" onchange="updateMatchReferee(${idx})">
                                    <option value="">-- ì‹¬íŒ ì„ íƒ --</option>
                                    ${referees.map(ref => `
                                        <option value="${ref.name}" ${m.mainRefereeName === ref.name ? 'selected' : ''}>
                                            ${ref.name} (${ref.role})
                                        </option>
                                    `).join('')}
                                </select>
                                ${m.mainRefereeName ? `<small style="color:#4caf50; margin-top:4px; display:block;">âœ“ ${m.mainRefereeName}</small>` : ''}
                            </div>
                            
                            <div>
                                <label style="font-size:13px; font-weight:600; display:block; margin-bottom:6px;">ğŸŸï¸ ê²½ê¸°ì¥</label>
                                <select id="court-${idx}" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px;" onchange="updateMatchCourt(${idx})">
                                    <option value="">-- ê²½ê¸°ì¥ ì„ íƒ --</option>
                                    ${courts.map(court => `
                                        <option value="${court.name}" ${m.courtName === court.name ? 'selected' : ''}>
                                            ${court.name}
                                        </option>
                                    `).join('')}
                                </select>
                                ${m.courtName ? `<small style="color:#4caf50; margin-top:4px; display:block;">âœ“ ${m.courtName}</small>` : ''}
                            </div>
                        </div>
                        
                        <div style="display:flex; gap:8px;">
                            <button class="btn" onclick="deleteMatchDirect(${idx})" style="flex:1; background:#ff6b6b; color:white; border:none; border-radius:6px; padding:8px;">
                                ğŸ—‘ï¸ ì‚­ì œ
                            </button>
                        </div>
                    </div>
                `).join('');
                
                app.innerHTML = `
                    <div class="card">
                        <div style="background:linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color:white; padding:16px; border-radius:8px; margin:-20px -20px 20px -20px;">
                            <h2 style="margin:0; color:white;">âš–ï¸ ê²½ê¸° í¸ì§‘</h2>
                            <p style="margin:4px 0 0 0; font-size:13px; color:rgba(255,255,255,0.9);">ì‹¬íŒê³¼ ê²½ê¸°ì¥ì„ ë°°ì •í•˜ì„¸ìš”</p>
                        </div>
                        
                        ${referees.length === 0 ? `
                            <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-bottom:16px; border-left:4px solid #ff9800;">
                                <strong>âš ï¸ ì‹¬íŒì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”</strong>
                                <p style="font-size:13px; margin:4px 0 0 0;">ëŒ€ì§„ ì„¤ì •ì—ì„œ ì‹¬íŒì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì„œ ë°°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        ` : ''}
                        
                        ${courts.length === 0 ? `
                            <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-bottom:16px; border-left:4px solid #ff9800;">
                                <strong>âš ï¸ ê²½ê¸°ì¥ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”</strong>
                                <p style="font-size:13px; margin:4px 0 0 0;">ëŒ€ì§„ ì„¤ì •ì—ì„œ ê²½ê¸°ì¥ì„ ì¶”ê°€í•˜ë©´ ì—¬ê¸°ì„œ ë°°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                            </div>
                        ` : ''}
                        
                        <div style="background:#e8f5e9; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>ğŸ“Š í˜„í™©</strong>
                            <div style="font-size:13px; margin-top:8px; color:#333;">
                                ì „ì²´ ê²½ê¸°: ${allMatches.length}ê²½ê¸° Â· 
                                ì‹¬íŒë°°ì •: ${allMatches.filter(m => m.mainRefereeName).length}ê²½ê¸° Â· 
                                ê²½ê¸°ì¥ë°°ì •: ${allMatches.filter(m => m.courtName).length}ê²½ê¸°
                            </div>
                        </div>
                        
                        <div style="max-height:500px; overflow-y:auto; margin-bottom:16px;">
                            ${matchesEditHTML}
                        </div>
                        
                        <button class="btn btn-primary" onclick="goTo('project-detail')" style="width:100%;">âœ“ í¸ì§‘ ì™„ë£Œ</button>
                    </div>
                `;
            }
            // ========== IBSA ëŒ€ì§„ ê´€ë¦¬ í™”ë©´ë“¤ ==========
            // íŒ€ ê´€ë¦¬ í™”ë©´ (íŒ€ì „ìš©)
            else if (screen === 'manage-teams') {
                const teams = currentProject.teams || [];
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">â† ëŒì•„ê°€ê¸°</button>
                        <h2>ğŸ… íŒ€ ê´€ë¦¬</h2>
                        
                        <div style="margin-bottom:16px; padding:16px; background:#e3f2fd; border-radius:8px; border-left:4px solid var(--primary);">
                            <strong>IBSA íŒ€ êµ¬ì„± ê·œì¹™</strong>
                            <ul style="font-size:13px; margin:8px 0 0 0; padding-left:20px; color:var(--text-secondary);">
                                <li>íŒ€ ì¸ì›: 3~6ëª…</li>
                                <li>ê²½ê¸° ë¼ì¸ì—…: í˜¼ì„± (ë‚¨2+ì—¬1 ë˜ëŠ” ì—¬2+ë‚¨1)</li>
                                <li>ê²½ê¸° ë°©ì‹: 31ì  2ì ì°¨, ë‹¨íŒ</li>
                            </ul>
                        </div>
                        
                        <div style="margin-bottom:16px; padding:16px; background:var(--bg-secondary); border-radius:8px;">
                            <h3 style="margin-bottom:12px;">ìƒˆ íŒ€ ì¶”ê°€</h3>
                            <label>íŒ€ëª… *</label>
                            <input type="text" id="new-team-name" placeholder="ì˜ˆ: ì„œìš¸íŒ€">
                            <label style="margin-top:12px;">ì„ ìˆ˜ (ì‰¼í‘œë¡œ êµ¬ë¶„, ì„±ë³„ í‘œì‹œ: ì´ë¦„/ë‚¨ ë˜ëŠ” ì´ë¦„/ì—¬)</label>
                            <input type="text" id="new-team-members" placeholder="ì˜ˆ: í™ê¸¸ë™/ë‚¨, ê¹€ì˜í¬/ì—¬, ì´ìˆœì‹ /ë‚¨">
                            <button class="btn btn-primary" onclick="addTeam()" style="margin-top:12px; width:100%;">íŒ€ ì¶”ê°€</button>
                        </div>
                        
                        <h3>ë“±ë¡ëœ íŒ€ (${teams.length}íŒ€)</h3>
                        <div id="team-list">
                            ${teams.length === 0 ? '<p style="color:var(--text-secondary); padding:20px; text-align:center;">ë“±ë¡ëœ íŒ€ì´ ì—†ìŠµë‹ˆë‹¤.</p>' :
                                teams.map((t, i) => {
                                    const maleCount = t.members?.filter(m => m.gender === 'male').length || 0;
                                    const femaleCount = t.members?.filter(m => m.gender === 'female').length || 0;
                                    const isValidLineup = (maleCount >= 2 && femaleCount >= 1) || (femaleCount >= 2 && maleCount >= 1);
                                    
                                    return `
                                    <div style="padding:16px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid ${isValidLineup ? 'var(--success)' : 'var(--warning)'};">
                                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                            <strong style="font-size:16px;">${i + 1}. ${t.name}</strong>
                                            <div>
                                                ${t.group ? `<span style="color:var(--primary); margin-right:8px;">${t.group}ì¡°</span>` : ''}
                                                <button class="btn btn-danger" onclick="removeTeam(${i})" style="padding:4px 12px; font-size:12px;">ì‚­ì œ</button>
                                            </div>
                                        </div>
                                        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
                                            ${t.members?.map(m => `
                                                <span style="padding:4px 8px; background:${m.gender === 'male' ? '#e3f2fd' : '#fce4ec'}; border-radius:4px; font-size:13px;">
                                                    ${m.gender === 'male' ? 'â™‚ï¸' : 'â™€ï¸'} ${m.name}
                                                </span>
                                            `).join('') || 'ì„ ìˆ˜ ì—†ìŒ'}
                                        </div>
                                        <div style="font-size:12px; color:${isValidLineup ? 'var(--success)' : 'var(--warning)'};">
                                            ${isValidLineup ? 'âœ… ë¼ì¸ì—… ìœ íš¨' : 'âš ï¸ ë¼ì¸ì—… í™•ì¸ í•„ìš” (ë‚¨2+ì—¬1 ë˜ëŠ” ì—¬2+ë‚¨1)'} 
                                            (ë‚¨ ${maleCount}ëª…, ì—¬ ${femaleCount}ëª…)
                                        </div>
                                    </div>
                                `}).join('')
                            }
                        </div>
                    </div>
                `;
            }
            else if (screen === 'manage-players') {
                const players = currentProject.players || [];
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">â† ëŒì•„ê°€ê¸°</button>
                        <h2>ğŸ‘¥ ì„ ìˆ˜ ê´€ë¦¬</h2>
                        
                        <div style="margin-bottom:16px; padding:16px; background:var(--bg-secondary); border-radius:8px;">
                            <label>ì„ ìˆ˜ ì¶”ê°€</label>
                            <div style="display:flex; gap:8px;">
                                <input type="text" id="new-player-name" placeholder="ì„ ìˆ˜ ì´ë¦„" style="flex:1;">
                                <button class="btn btn-primary" onclick="addPlayer()">ì¶”ê°€</button>
                            </div>
                            <p style="font-size:12px; color:var(--text-secondary); margin-top:4px;">ì—¬ëŸ¬ ëª…: ì‰¼í‘œë¡œ êµ¬ë¶„ (ì˜ˆ: í™ê¸¸ë™, ì´ìˆœì‹ )</p>
                        </div>
                        
                        <h3>ë“±ë¡ëœ ì„ ìˆ˜ (${players.length}ëª…)</h3>
                        <div id="player-list">
                            ${players.length === 0 ? '<p style="color:var(--text-secondary); padding:20px; text-align:center;">ë“±ë¡ëœ ì„ ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</p>' :
                                players.map((p, i) => `
                                    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px;">
                                        <span><strong>${i + 1}.</strong> ${p.name} ${p.group ? `<span style="color:var(--primary);">(${p.group}ì¡°)</span>` : ''}</span>
                                        <button class="btn btn-danger" onclick="removePlayer(${i})" style="padding:4px 12px; font-size:12px;">ì‚­ì œ</button>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                `;
            }
            else if (screen === 'manage-groups') {
                const isTeam = currentProject.competitionType === 'team';
                const participants = isTeam ? (currentProject.teams || []) : (currentProject.players || []);
                const groups = currentProject.groups || [];
                const settings = currentProject.groupSettings || { groupCount: 2, advanceCount: 2, setsPerMatch: isTeam ? 1 : 3 };
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">â† ëŒì•„ê°€ê¸°</button>
                        <h2>ğŸ“‹ IBSA ì¡°ë³„ ë¦¬ê·¸ ${isTeam ? '(íŒ€ì „)' : '(ê°œì¸ì „)'}</h2>
                        
                        <div style="margin-bottom:16px; padding:16px; background:#e3f2fd; border-radius:8px; border-left:4px solid var(--primary);">
                            <strong>IBSA ë¼ìš´ë“œ ë¡œë¹ˆ ë°©ì‹</strong>
                            <p style="font-size:13px; margin-top:4px;">
                                ${isTeam ? 
                                    'ê° ì¡°ì—ì„œ ëª¨ë“  íŒ€ì´ ì„œë¡œ í•œ ë²ˆì”© ëŒ€ì „í•©ë‹ˆë‹¤. (31ì  2ì ì°¨, ë‹¨íŒ)' : 
                                    'ê° ì¡°ì—ì„œ ëª¨ë“  ì„ ìˆ˜ê°€ ì„œë¡œ í•œ ë²ˆì”© ëŒ€ì „í•©ë‹ˆë‹¤. (3ì„¸íŠ¸ 2ì„ ìŠ¹)'
                                }
                            </p>
                        </div>
                        
                        <div style="margin-bottom:16px; padding:16px; background:var(--bg-secondary); border-radius:8px;">
                            <h3 style="margin-bottom:12px;">ì¡°ë³„ ë¦¬ê·¸ ì„¤ì •</h3>
                            <div style="display:grid; grid-template-columns:${isTeam ? '1fr 1fr' : '1fr 1fr 1fr'}; gap:12px;">
                                <div>
                                    <label>ì¡° ê°œìˆ˜</label>
                                    <select id="group-count-edit">
                                        ${[1,2,3,4,5,6,7,8].map(n => `<option value="${n}" ${settings.groupCount === n ? 'selected' : ''}>${n}ê°œ</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label>ì¡°ë³„ ì§„ì¶œ${isTeam ? 'íŒ€' : 'ì'}</label>
                                    <select id="advance-count-edit">
                                        ${[1,2,3,4].map(n => `<option value="${n}" ${settings.advanceCount === n ? 'selected' : ''}>${n}${isTeam ? 'íŒ€' : 'ëª…'}</option>`).join('')}
                                    </select>
                                </div>
                                ${!isTeam ? `
                                <div>
                                    <label>ì˜ˆì„  ì„¸íŠ¸</label>
                                    <select id="group-sets-edit">
                                        <option value="3" selected>3ì„¸íŠ¸ (2ì„ ìŠ¹)</option>
                                    </select>
                                </div>
                                ` : '<input type="hidden" id="group-sets-edit" value="1">'}
                            </div>
                            <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="btn btn-primary" onclick="autoAssignGroups()">ğŸ² ìë™ ë°°ì •</button>
                                <button class="btn btn-success" onclick="generateGroupMatches()">ğŸ“… ëŒ€ì§„í‘œ ìƒì„±</button>
                                <button class="btn btn-danger" onclick="clearGroups()">ì´ˆê¸°í™”</button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:16px;">
                            <p style="color:var(--text-secondary);">ë“±ë¡ ${isTeam ? 'íŒ€' : 'ì„ ìˆ˜'}: ${participants.length}${isTeam ? 'íŒ€' : 'ëª…'} | í¸ì„±ëœ ì¡°: ${groups.length}ê°œ</p>
                        </div>
                        
                        ${groups.length > 0 ? groups.map((g, gi) => `
                            <div style="margin-bottom:16px; padding:16px; border:2px solid var(--primary); border-radius:8px;">
                                <h3 style="color:var(--primary); margin-bottom:12px;">${String.fromCharCode(65 + gi)}ì¡° (${g.players?.length || 0}${isTeam ? 'íŒ€' : 'ëª…'})</h3>
                                ${g.players?.map((p, pi) => `
                                    <div style="padding:8px; margin:4px 0; background:var(--bg-secondary); border-radius:4px; display:flex; justify-content:space-between; align-items:center;">
                                        <span>${pi + 1}. ${p.name}</span>
                                        <div>
                                            <button class="btn" onclick="movePlayerGroup(${gi}, ${pi})" style="padding:2px 8px; font-size:11px;">ì´ë™</button>
                                        </div>
                                    </div>
                                `).join('') || '<p style="color:var(--text-secondary);">ì„ ìˆ˜ ì—†ìŒ</p>'}
                                
                                ${g.matches?.length > 0 ? `
                                    <h4 style="margin-top:16px; margin-bottom:8px; color:var(--text-secondary);">ëŒ€ì§„í‘œ (${g.matches.length}ê²½ê¸°)</h4>
                                    ${g.matches.map((m, mi) => `
                                        <div style="padding:8px; margin:4px 0; background:${m.status === 'completed' ? '#e8f5e9' : '#fff3e0'}; border-radius:4px; display:flex; justify-content:space-between; align-items:center;">
                                            <span>${m.player1} vs ${m.player2}</span>
                                            <span style="font-size:12px; color:var(--text-secondary);">
                                                ${m.status === 'completed' ? `âœ… ${m.result?.player1Sets || 0}:${m.result?.player2Sets || 0}` : 'â³ ëŒ€ê¸°'}
                                            </span>
                                        </div>
                                    `).join('')}
                                ` : ''}
                            </div>
                        `).join('') : `
                            <div style="text-align:center; padding:40px; color:var(--text-secondary);">
                                <p>ì¡° í¸ì„±ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                <p style="font-size:14px; margin-top:8px;">ì„ ìˆ˜ë¥¼ ë“±ë¡í•˜ê³  "ìë™ ë°°ì •"ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
                            </div>
                        `}
                    </div>
                `;
            }
            else if (screen === 'manage-bracket') {
                const bracket = currentProject.bracket;
                const settings = currentProject.tournamentSettings || { setsPerMatch: 5, thirdPlaceMatch: true };
                const groups = currentProject.groups || [];
                const advanceCount = currentProject.groupSettings?.advanceCount || 2;
                
                // ì¡°ë³„ ë¦¬ê·¸ ì§„ì¶œì ê³„ì‚°
                let qualifiedPlayers = [];
                if (groups.length > 0) {
                    groups.forEach((g, gi) => {
                        const standings = calculateGroupStandings(g);
                        standings.slice(0, advanceCount).forEach((p, rank) => {
                            qualifiedPlayers.push({
                                ...p,
                                fromGroup: String.fromCharCode(65 + gi),
                                groupRank: rank + 1
                            });
                        });
                    });
                }
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">â† ëŒì•„ê°€ê¸°</button>
                        <h2>ğŸ… IBSA ë…¹ì•„ì›ƒ í† ë„ˆë¨¼íŠ¸</h2>
                        
                        <div style="margin-bottom:16px; padding:16px; background:#e3f2fd; border-radius:8px; border-left:4px solid var(--primary);">
                            <strong>IBSA ì‹±ê¸€ ì—˜ë¦¬ë¯¸ë„¤ì´ì…˜</strong>
                            <p style="font-size:13px; margin-top:4px;">ì¡°ë³„ ë¦¬ê·¸ ì§„ì¶œìë“¤ì´ í† ë„ˆë¨¼íŠ¸ë¡œ ìš°ìŠ¹ì„ ê²°ì •í•©ë‹ˆë‹¤.</p>
                        </div>
                        
                        <div style="margin-bottom:16px; padding:16px; background:var(--bg-secondary); border-radius:8px;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                                <div>
                                    <label>ë³¸ì„  ì„¸íŠ¸</label>
                                    <select id="knockout-sets-edit" onchange="updateTournamentSettings()">
                                        <option value="3" ${settings.setsPerMatch === 3 ? 'selected' : ''}>3ì„¸íŠ¸</option>
                                        <option value="5" ${settings.setsPerMatch === 5 ? 'selected' : ''}>5ì„¸íŠ¸ (IBSA ê²°ìŠ¹)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display:flex; align-items:center; gap:8px; margin-top:24px;">
                                        <input type="checkbox" id="third-place-edit" ${settings.thirdPlaceMatch ? 'checked' : ''} onchange="updateTournamentSettings()">
                                        3/4ìœ„ ê²°ì •ì „
                                    </label>
                                </div>
                            </div>
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="btn btn-primary" onclick="generateBracket()">ğŸ² ëŒ€ì§„í‘œ ìƒì„±</button>
                                <button class="btn btn-success" onclick="createKnockoutMatches()">ğŸ“… ê²½ê¸° ìƒì„±</button>
                            </div>
                        </div>
                        
                        ${qualifiedPlayers.length > 0 ? `
                            <div style="margin-bottom:16px;">
                                <h3 style="margin-bottom:8px;">ì¡°ë³„ ë¦¬ê·¸ ì§„ì¶œì (${qualifiedPlayers.length}ëª…)</h3>
                                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:8px;">
                                    ${qualifiedPlayers.map(p => `
                                        <div style="padding:8px; background:${p.groupRank === 1 ? '#fff3cd' : '#e8f5e9'}; border-radius:4px; text-align:center;">
                                            <div style="font-weight:600;">${p.name}</div>
                                            <div style="font-size:11px; color:var(--text-secondary);">${p.fromGroup}ì¡° ${p.groupRank}ìœ„</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${bracket ? `
                            <div id="bracket-view">
                                ${renderBracketView(bracket)}
                            </div>
                        ` : `
                            <div style="text-align:center; padding:40px; color:var(--text-secondary);">
                                <p>ëŒ€ì§„í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                <p style="font-size:14px; margin-top:8px;">${groups.length > 0 ? 'ì¡°ë³„ ë¦¬ê·¸ ì™„ë£Œ í›„ "ëŒ€ì§„í‘œ ìƒì„±"ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.' : 'ë¨¼ì € ì¡°ë³„ ë¦¬ê·¸ë¥¼ ì§„í–‰í•˜ì„¸ìš”.'}</p>
                            </div>
                        `}
                    </div>
                `;
            }
            else if (screen === 'standings') {
                const standings = calculateStandings();
                const advanceCount = currentProject.groupSettings?.advanceCount || 2;
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">â† ëŒì•„ê°€ê¸°</button>
                        <h2>ğŸ“Š IBSA ìˆœìœ„í‘œ</h2>
                        
                        <div style="margin-bottom:16px; padding:12px; background:#e3f2fd; border-radius:8px; border-left:4px solid var(--primary);">
                            <strong>ìˆœìœ„ ê²°ì • ê¸°ì¤€ (IBSA)</strong>
                            <p style="font-size:12px; margin-top:4px;">1. ìŠ¹ë¥  â†’ 2. ì„¸íŠ¸ë“ì‹¤ â†’ 3. ê³¨ë“ì‹¤ â†’ 4. ì§ì ‘ëŒ€ê²°</p>
                        </div>
                        
                        ${currentProject.groups?.length > 0 ? `
                            <h3 style="margin:16px 0 12px;">ì¡°ë³„ ë¦¬ê·¸ ìˆœìœ„</h3>
                            ${currentProject.groups.map((g, gi) => `
                                <div style="margin-bottom:20px;">
                                    <h4 style="color:var(--primary); margin-bottom:8px;">${String.fromCharCode(65 + gi)}ì¡°</h4>
                                    <div style="overflow-x:auto;">
                                        <table style="width:100%; border-collapse:collapse; font-size:13px; min-width:400px;">
                                            <thead>
                                                <tr style="background:var(--bg-secondary);">
                                                    <th style="padding:8px; text-align:center;">ìˆœìœ„</th>
                                                    <th style="padding:8px; text-align:left;">ì„ ìˆ˜</th>
                                                    <th style="padding:8px; text-align:center;">ê²½ê¸°</th>
                                                    <th style="padding:8px; text-align:center;">ìŠ¹</th>
                                                    <th style="padding:8px; text-align:center;">íŒ¨</th>
                                                    <th style="padding:8px; text-align:center;">ì„¸íŠ¸</th>
                                                    <th style="padding:8px; text-align:center;">ë“ì‹¤</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${(standings.groups?.[gi] || []).map((p, pi) => `
                                                    <tr style="border-bottom:1px solid var(--border); ${pi < advanceCount ? 'background:#e8f5e9; font-weight:600;' : ''}">
                                                        <td style="padding:8px; text-align:center;">${pi < advanceCount ? 'ğŸ†' : ''} ${pi + 1}</td>
                                                        <td style="padding:8px;">${p.name}</td>
                                                        <td style="padding:8px; text-align:center;">${p.wins + p.losses}</td>
                                                        <td style="padding:8px; text-align:center;">${p.wins}</td>
                                                        <td style="padding:8px; text-align:center;">${p.losses}</td>
                                                        <td style="padding:8px; text-align:center;">+${p.setWins}/-${p.setLosses}</td>
                                                        <td style="padding:8px; text-align:center;">+${p.goalsFor}/-${p.goalsAgainst}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `).join('')}
                        ` : ''}
                        
                        ${standings.final?.length > 0 ? `
                            <h3 style="margin:16px 0 12px;">ğŸ† ìµœì¢… ìˆœìœ„</h3>
                            <div>
                                ${standings.final.map((p, i) => `
                                    <div style="display:flex; align-items:center; padding:12px; margin:8px 0; background:${i === 0 ? '#fff3cd' : i === 1 ? '#e8e8e8' : i === 2 ? '#ffe4c4' : 'var(--bg-secondary)'}; border-radius:8px;">
                                        <span style="font-size:24px; margin-right:12px;">${i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i + 1}ìœ„`}</span>
                                        <span style="font-weight:600;">${p.name}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${!currentProject.groups?.length && !standings.final?.length ? `
                            <div style="text-align:center; padding:40px; color:var(--text-secondary);">
                                <p>ìˆœìœ„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                <p style="font-size:14px; margin-top:8px;">ì¡° í¸ì„± ë˜ëŠ” ê²½ê¸° ì§„í–‰ í›„ í™•ì¸í•˜ì„¸ìš”.</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            else if (screen === 'statistics') {
                const stats = calculateStatistics();
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">â† ëŒì•„ê°€ê¸°</button>
                        <h2>ğŸ“ˆ í†µê³„</h2>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
                            <div style="padding:16px; background:var(--bg-secondary); border-radius:8px; text-align:center;">
                                <div style="font-size:24px; font-weight:700; color:var(--primary);">${stats.totalMatches}</div>
                                <div style="font-size:14px; color:var(--text-secondary);">ì´ ê²½ê¸°</div>
                            </div>
                            <div style="padding:16px; background:var(--bg-secondary); border-radius:8px; text-align:center;">
                                <div style="font-size:24px; font-weight:700; color:var(--success);">${stats.completedMatches}</div>
                                <div style="font-size:14px; color:var(--text-secondary);">ì™„ë£Œ ê²½ê¸°</div>
                            </div>
                        </div>
                        
                        <!-- PDF ì¶œë ¥ ì„¹ì…˜ -->
                        <div style="margin-bottom:20px; padding:16px; background:#fff3e0; border-radius:8px; border-left:4px solid #ff9800;">
                            <h3 style="margin-bottom:12px;">ğŸ“„ PDF ì¶œë ¥</h3>
                            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                <button class="btn" onclick="exportTournamentReport()" style="background:#ff9800; color:white;">
                                    ğŸ“‹ ëŒ€íšŒ ê²°ê³¼ ë³´ê³ ì„œ
                                </button>
                                <button class="btn" onclick="exportGroupStageReport()" style="background:#4caf50; color:white;">
                                    ğŸ“Š ì¡°ë³„ ë¦¬ê·¸ ê¸°ë¡
                                </button>
                                <button class="btn" onclick="exportMatchRecords()" style="background:#2196f3; color:white;">
                                    ğŸ“ ê²½ê¸° ê¸°ë¡ì§€
                                </button>
                            </div>
                        </div>
                        
                        ${stats.playerStats?.length > 0 ? `
                            <h3 style="margin:16px 0 12px;">ì„ ìˆ˜ë³„ í†µê³„</h3>
                            <table style="width:100%; border-collapse:collapse; font-size:14px;">
                                <thead>
                                    <tr style="background:var(--bg-secondary);">
                                        <th style="padding:8px; text-align:left;">ì„ ìˆ˜</th>
                                        <th style="padding:8px; text-align:center;">ê²½ê¸°</th>
                                        <th style="padding:8px; text-align:center;">ìŠ¹</th>
                                        <th style="padding:8px; text-align:center;">íŒ¨</th>
                                        <th style="padding:8px; text-align:center;">ìŠ¹ë¥ </th>
                                        <th style="padding:8px; text-align:center;">ë“ì </th>
                                        <th style="padding:8px; text-align:center;">ì‹¤ì </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${stats.playerStats.map(p => `
                                        <tr style="border-bottom:1px solid var(--border);">
                                            <td style="padding:8px;">${p.name}</td>
                                            <td style="padding:8px; text-align:center;">${p.matches}</td>
                                            <td style="padding:8px; text-align:center;">${p.wins}</td>
                                            <td style="padding:8px; text-align:center;">${p.losses}</td>
                                            <td style="padding:8px; text-align:center;">${p.winRate}%</td>
                                            <td style="padding:8px; text-align:center;">${p.goalsFor}</td>
                                            <td style="padding:8px; text-align:center;">${p.goalsAgainst}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : `
                            <div style="text-align:center; padding:40px; color:var(--text-secondary);">
                                <p>í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                                <p style="font-size:14px; margin-top:8px;">ê²½ê¸° ì§„í–‰ í›„ í™•ì¸í•˜ì„¸ìš”.</p>
                            </div>
                        `}
                    </div>
                `;
            }
            // ========== ìë™ ëŒ€íšŒ ì§„í–‰ í™”ë©´ ==========
            else if (screen === 'auto-tournament') {
                const isTeam = currentProject.competitionType === 'team';
                const hasResult = currentProject.autoTournamentResult;
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">â† ëŒì•„ê°€ê¸°</button>
                        <h2>ğŸ² ìë™ ëŒ€íšŒ ì§„í–‰</h2>
                        
                        <div style="margin-bottom:16px; padding:16px; background:#f3e5f5; border-radius:8px; border-left:4px solid #9c27b0;">
                            <strong>ìë™ ëŒ€íšŒë€?</strong>
                            <p style="font-size:13px; margin-top:4px; color:var(--text-secondary);">
                                ì„¤ì •ë§Œ í•˜ë©´ ì„ ìˆ˜/íŒ€ ìƒì„±ë¶€í„° ê²½ê¸° ì§„í–‰, ìµœì¢… ìˆœìœ„ê¹Œì§€ ìë™ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.
                            </p>
                        </div>
                        
                        <div style="margin-bottom:20px; padding:16px; background:var(--bg-secondary); border-radius:8px;">
                            <h3 style="margin-bottom:12px;">ğŸ“‹ ê¸°ë³¸ ì„¤ì •</h3>
                            
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                                <div>
                                    <label for="auto-participant-count">${isTeam ? 'ì°¸ê°€ íŒ€ ìˆ˜' : 'ì°¸ê°€ ì„ ìˆ˜ ìˆ˜'}</label>
                                    <input type="number" id="auto-participant-count" value="16" min="2" max="999" 
                                           oninput="updateGroupPreview()" style="width:100%;" aria-label="${isTeam ? 'ì°¸ê°€ íŒ€ ìˆ˜' : 'ì°¸ê°€ ì„ ìˆ˜ ìˆ˜'} ì…ë ¥">
                                </div>
                                <div>
                                    <label for="auto-group-count">ì¡° ê°œìˆ˜</label>
                                    <input type="number" id="auto-group-count" value="4" min="1" max="99" 
                                           oninput="updateTopSeedInputs(); updateGroupPreview()" style="width:100%;" aria-label="ì¡° ê°œìˆ˜ ì…ë ¥">
                                </div>
                            </div>
                            
                            <!-- ì¡° í¸ì„± ë¯¸ë¦¬ë³´ê¸° -->
                            <div id="group-preview" style="margin-bottom:12px; padding:10px; background:#e3f2fd; border-radius:6px; font-size:13px;" aria-live="polite">
                                ğŸ“Š ì¡° í¸ì„±: Aì¡° 4ëª…, Bì¡° 4ëª…, Cì¡° 4ëª…, Dì¡° 4ëª…
                            </div>
                            
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                <div>
                                    <label for="auto-advance-count">ì¡°ë³„ ì§„ì¶œì</label>
                                    <input type="number" id="auto-advance-count" value="2" min="1" max="10" style="width:100%;" aria-label="ì¡°ë³„ ì§„ì¶œì ìˆ˜ ì…ë ¥">
                                </div>
                                <div>
                                    <label for="auto-third-place">3/4ìœ„ ê²°ì •ì „</label>
                                    <select id="auto-third-place" aria-label="3/4ìœ„ ê²°ì •ì „ ì§„í–‰ ì—¬ë¶€ ì„ íƒ">
                                        <option value="yes" selected>ì§„í–‰</option>
                                        <option value="no">ìƒëµ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- íƒ‘ì‹œë“œ ì…ë ¥ ì„¹ì…˜ -->
                        <div style="margin-bottom:20px; padding:16px; background:#fce4ec; border-radius:8px;">
                            <h3 style="margin-bottom:8px;">â­ ì¡°ë³„ íƒ‘ì‹œë“œ ì…ë ¥ (ì„ íƒ)</h3>
                            <p style="font-size:12px; color:var(--text-secondary); margin-bottom:12px;">
                                ì…ë ¥í•œ ì´ë¦„ì€ ê° ì¡° 1ë²ˆ ì‹œë“œë¡œ ë°°ì •ë©ë‹ˆë‹¤. ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±ë©ë‹ˆë‹¤.
                            </p>
                            <div id="top-seed-inputs" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                                ${(() => {
                                    let inputs = '';
                                    for (let i = 0; i < 4; i++) {
                                        const letter = String.fromCharCode(65 + i);
                                        inputs += `<input type="text" placeholder="${letter}ì¡° íƒ‘ì‹œë“œ" id="seed-${letter}" style="padding:8px; font-size:13px;">`;
                                    }
                                    return inputs;
                                })()}
                            </div>
                        </div>
                        
                        ${!isTeam ? `
                        <div style="margin-bottom:20px; padding:16px; background:#e3f2fd; border-radius:8px;">
                            <h3 style="margin-bottom:12px;">ğŸ… ì„¸íŠ¸ ì„¤ì • (ê°œì¸ì „)</h3>
                            
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                                <div>
                                    <label>ì¡°ë³„ ë¦¬ê·¸</label>
                                    <select id="auto-group-sets">
                                        <option value="3" selected>3ì„¸íŠ¸ (2ì„ ìŠ¹)</option>
                                    </select>
                                </div>
                                <div>
                                    <label>5ì„¸íŠ¸ ì‹œì‘ ë¼ìš´ë“œ</label>
                                    <select id="auto-5set-start">
                                        <option value="final">ê²°ìŠ¹ë§Œ 5ì„¸íŠ¸</option>
                                        <option value="semi">4ê°•ë¶€í„° 5ì„¸íŠ¸</option>
                                        <option value="quarter" selected>8ê°•ë¶€í„° 5ì„¸íŠ¸</option>
                                        <option value="r16">16ê°•ë¶€í„° 5ì„¸íŠ¸</option>
                                        <option value="all">ë³¸ì„  ì „ì²´ 5ì„¸íŠ¸</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="margin-bottom:20px; padding:16px; background:#fff3e0; border-radius:8px;">
                            <h3 style="margin-bottom:12px;">ğŸ“Š ìˆœìœ„ ê²°ì • ë°©ì‹</h3>
                            
                            <div>
                                <label>ì „ì²´ ìˆœìœ„ ì‚°ì¶œ</label>
                                <select id="auto-ranking-type">
                                    <option value="knockout-only">ë³¸ì„  ì§„ì¶œìë§Œ (4ê°• ì´ìƒ)</option>
                                    <option value="all-ranked" selected>ì „ì²´ ì°¸ê°€ì ìˆœìœ„ ë¶€ì—¬</option>
                                </select>
                                <p style="font-size:11px; color:var(--text-secondary); margin-top:4px;">
                                    * ì „ì²´ ìˆœìœ„: ì¡°ë³„ íƒˆë½ìëŠ” ì¡° ìˆœìœ„ + ë“ì‹¤ë¡œ ì „ì²´ ìˆœìœ„ ì‚°ì¶œ
                                </p>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="runAutoTournament()" style="width:100%; padding:16px; font-size:16px;">
                            ğŸš€ ëŒ€íšŒ ìë™ ì§„í–‰
                        </button>
                        
                        <div id="auto-tournament-result" style="display:${hasResult ? 'block' : 'none'}; margin-top:20px;">
                            ${hasResult ? renderAutoTournamentResult() : ''}
                        </div>
                    </div>
                `;
            }
            // ========== ëŒ€ì§„ ê´€ë¦¬ í™”ë©´ ë ==========
            else if (screen === 'create-match') {
                app.innerHTML = `
                    <div class="card">
                        <h2>ìƒˆ ê²½ê¸° ìƒì„±</h2>
                        
                        <h3 style="margin-top:20px">ê²½ê¸° ì •ë³´</h3>
                        <label>ê²½ê¸° ìœ í˜• *</label>
                        <select id="match-type">
                            <option value="individual">ê°œì¸ì „</option>
                            <option value="team">íŒ€ì „</option>
                        </select>
                        <div id="sets-div">
                            <label>ì„¸íŠ¸ ìˆ˜ *</label>
                            <select id="sets">
                                <option value="3">3ì„¸íŠ¸</option>
                                <option value="5">5ì„¸íŠ¸</option>
                            </select>
                        </div>
                        
                        <h3 style="margin-top:20px">ì„ ìˆ˜ ì •ë³´</h3>
                        <label id="player1-label">ì„ ìˆ˜ 1 ì´ë¦„ *</label>
                        <input type="text" id="player1" placeholder="ì„ ìˆ˜ 1">
                        <label id="player2-label">ì„ ìˆ˜ 2 ì´ë¦„ *</label>
                        <input type="text" id="player2" placeholder="ì„ ìˆ˜ 2">
                        
                        <div id="team-lineup" style="display:none;">
                            <h3 style="margin-top:20px">íŒ€ ë¼ì¸ì—…</h3>
                            <label id="team1-lineup-label">íŒ€ 1 ë¼ì¸ì—… (3ëª…) *</label>
                            <input type="text" id="team1-player1" placeholder="ì„ ìˆ˜ 1 ì´ë¦„">
                            <input type="text" id="team1-player2" placeholder="ì„ ìˆ˜ 2 ì´ë¦„">
                            <input type="text" id="team1-player3" placeholder="ì„ ìˆ˜ 3 ì´ë¦„">
                            <label id="team2-lineup-label">íŒ€ 2 ë¼ì¸ì—… (3ëª…) *</label>
                            <input type="text" id="team2-player1" placeholder="ì„ ìˆ˜ 1 ì´ë¦„">
                            <input type="text" id="team2-player2" placeholder="ì„ ìˆ˜ 2 ì´ë¦„">
                            <input type="text" id="team2-player3" placeholder="ì„ ìˆ˜ 3 ì´ë¦„">
                        </div>
                        
                        <h3 style="margin-top:20px">ì‹¬íŒ ì •ë³´</h3>
                        <label>ì£¼ì‹¬</label>
                        <input type="text" id="main-referee" placeholder="ì£¼ì‹¬ ì´ë¦„">
                        <label>ë¶€ì‹¬</label>
                        <input type="text" id="assistant-referee" placeholder="ë¶€ì‹¬ ì´ë¦„">
                        
                        <h3 style="margin-top:20px">ì½”ì¹˜ ì •ë³´</h3>
                        <label id="coach1-label">ì„ ìˆ˜ 1 ì½”ì¹˜</label>
                        <input type="text" id="coach1" placeholder="ì½”ì¹˜ ì´ë¦„">
                        <label id="coach2-label">ì„ ìˆ˜ 2 ì½”ì¹˜</label>
                        <input type="text" id="coach2" placeholder="ì½”ì¹˜ ì´ë¦„">
                        
                        <h3 style="margin-top:20px">ğŸ” ë³´ì•ˆ ì„¤ì •</h3>
                        <label>ì‹¬íŒ PIN (6ìë¦¬ ì´ìƒ) *</label>
                        <input type="password" id="referee-pin" placeholder="6ìë¦¬ ì´ìƒ ìˆ«ì" maxlength="8" pattern="[0-9]{6,8}">
                        <p style="font-size:12px; color:var(--text-secondary); margin-top:4px;">
                            âš ï¸ ë“ì  ì…ë ¥ ì‹œ í•„ìš”í•©ë‹ˆë‹¤. ìŠì§€ ë§ˆì„¸ìš”!
                        </p>
                        
                        <div class="action-row">
                            <button type="button" class="btn btn-danger" onclick="goTo('project-detail')">ì·¨ì†Œ</button>
                            <button type="button" class="btn btn-primary" onclick="createMatch()">ê²½ê¸° ì‹œì‘</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('match-type').onchange = (e) => {
                    const isTeam = e.target.value === 'team';
                    document.getElementById('sets-div').style.display = isTeam ? 'none' : 'block';
                    document.getElementById('team-lineup').style.display = isTeam ? 'block' : 'none';
                    document.getElementById('player1-label').textContent = isTeam ? 'íŒ€ 1 ì´ë¦„ *' : 'ì„ ìˆ˜ 1 ì´ë¦„ *';
                    document.getElementById('player2-label').textContent = isTeam ? 'íŒ€ 2 ì´ë¦„ *' : 'ì„ ìˆ˜ 2 ì´ë¦„ *';
                    document.getElementById('coach1-label').textContent = isTeam ? 'íŒ€ 1 ì½”ì¹˜' : 'ì„ ìˆ˜ 1 ì½”ì¹˜';
                    document.getElementById('coach2-label').textContent = isTeam ? 'íŒ€ 2 ì½”ì¹˜' : 'ì„ ìˆ˜ 2 ì½”ì¹˜';
                };
            }
            else if (screen === 'match') {
                renderMatch();
            }
        }

        function renderMatch() {
            const app = document.getElementById('app');
            
            // currentMatch í™•ì¸
            if (!currentMatch) {
                app.innerHTML = `
                    <div class="card">
                        <h2>âš ï¸ ì˜¤ë¥˜</h2>
                        <p>ê²½ê¸° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                        <button type="button" class="btn btn-primary" onclick="goTo('project-detail')">ê²½ê¸° ëª©ë¡ìœ¼ë¡œ</button>
                    </div>
                `;
                return;
            }
            
            // ì™„ë£Œëœ ê²½ê¸°ëŠ” ê¸°ë¡ë§Œ í‘œì‹œ
            if (currentMatch.status === 'completed') {
                renderFinishedMatch();
                return;
            }
            
            const set = currentMatch.setScores[currentMatch.currentSet - 1];
            const canEnd = Math.max(set.player1, set.player2) >= currentMatch.winScore && 
                          Math.abs(set.player1 - set.player2) >= 2;
            
            // ì„¸íŠ¸ ìŠ¹ìˆ˜ ê³„ì‚°
            let p1SetWins = 0, p2SetWins = 0;
            currentMatch.setScores.forEach((s, idx) => {
                if (idx < currentMatch.currentSet - 1) {
                    if (s.player1 > s.player2) p1SetWins++;
                    else if (s.player2 > s.player1) p2SetWins++;
                }
            });
            const winsNeeded = Math.ceil(currentMatch.sets / 2);
            
            app.innerHTML = `
                <div class="card">
                    <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">â† ê²½ê¸° ëª©ë¡</button>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <div>
                            <div style="font-weight:600;">ì„¸íŠ¸ ${currentMatch.currentSet}/${currentMatch.sets}</div>
                            <div style="font-size:12px; color:var(--text-secondary);">ì„¸íŠ¸ ìŠ¤ì½”ì–´: ${p1SetWins} - ${p2SetWins} (${winsNeeded}ì„ ìŠ¹)</div>
                        </div>
                        <div style="display:flex; gap:12px; align-items:center;">
                            ${isAuthenticated ? 
                                '<span style="background:var(--success); color:white; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:600;">ğŸ”“ ì‹¬íŒ ëª¨ë“œ</span>' : 
                                '<span style="background:var(--warning); color:white; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:600;">ğŸ‘ï¸ ê´€ëŒ ëª¨ë“œ</span>'
                            }
                            <div style="font-size:12px; color:var(--text-secondary)">ì£¼ì‹¬: ${currentMatch.mainReferee || 'ë¯¸ì •'}</div>
                        </div>
                    </div>
                    
                    <!-- ì‹¤ì‹œê°„ ì ìˆ˜ ì˜ì—­ (aria-live) - ì„œë¸Œê¶Œ ê°€ì§„ ì„ ìˆ˜ê°€ ì™¼ìª½ -->
                    <div aria-live="polite" aria-atomic="true" id="live-score-region">
                        ${currentMatch.currentServe === 'player1' ? `
                        <div class="score-grid">
                            <div class="player-score" style="border:3px solid var(--primary); border-radius:12px;">
                                <div class="player-name">ğŸ¾ ${currentMatch.player1Name}</div>
                                <div class="score-display" aria-label="${currentMatch.player1Name} ${set.player1}ì ">${set.player1}</div>
                                ${currentMatch.team1Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team1Lineup.join(', ')}</div>` : ''}
                            </div>
                            <div style="font-size:24px; font-weight:700; color:var(--text-secondary)">:</div>
                            <div class="player-score">
                                <div class="player-name">${currentMatch.player2Name}</div>
                                <div class="score-display" aria-label="${currentMatch.player2Name} ${set.player2}ì ">${set.player2}</div>
                                ${currentMatch.team2Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team2Lineup.join(', ')}</div>` : ''}
                            </div>
                        </div>
                        ` : `
                        <div class="score-grid">
                            <div class="player-score" style="border:3px solid var(--primary); border-radius:12px;">
                                <div class="player-name">ğŸ¾ ${currentMatch.player2Name}</div>
                                <div class="score-display" aria-label="${currentMatch.player2Name} ${set.player2}ì ">${set.player2}</div>
                                ${currentMatch.team2Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team2Lineup.join(', ')}</div>` : ''}
                            </div>
                            <div style="font-size:24px; font-weight:700; color:var(--text-secondary)">:</div>
                            <div class="player-score">
                                <div class="player-name">${currentMatch.player1Name}</div>
                                <div class="score-display" aria-label="${currentMatch.player1Name} ${set.player1}ì ">${set.player1}</div>
                                ${currentMatch.team1Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team1Lineup.join(', ')}</div>` : ''}
                            </div>
                        </div>
                        `}
                    </div>
                    
                    <!-- ìµœê·¼ ë“ì  ì‹¤ì‹œê°„ ì•Œë¦¼ -->
                    <div aria-live="assertive" id="live-action-region" style="position:absolute; left:-9999px;">
                        ${currentMatch.history.length > 0 ? currentMatch.history[0].player + ' ' + currentMatch.history[0].points + 'ì  ë“ì ' : ''}
                    </div>
                    
                    <div style="text-align:center; padding:12px; background:var(--bg-secondary); border-radius:8px; margin-bottom:16px;">
                        ${currentMatch.serveSelected === false && isAuthenticated ? `
                            <div style="margin-bottom:12px; font-weight:600;">ğŸ¾ ì²« ì„œë¸Œ ì„ íƒ</div>
                            <div style="display:flex; gap:8px; justify-content:center;">
                                <button class="btn btn-primary" onclick="selectFirstServe('player1')" style="flex:1;">${currentMatch.player1Name}</button>
                                <button class="btn btn-primary" onclick="selectFirstServe('player2')" style="flex:1;">${currentMatch.player2Name}</button>
                            </div>
                        ` : `
                            <div class="serve-indicator">ğŸ¾ ${currentMatch.currentServe === 'player1' ? currentMatch.player1Name : currentMatch.player2Name} - ì„œë¸Œ ${currentMatch.serveCount + 1}íšŒì°¨</div>
                            ${isAuthenticated ? `
                                <button class="btn" onclick="changeServe()" style="margin-top:8px; font-size:12px; padding:6px 12px;">ğŸ”„ ì„œë¸Œê¶Œ ë³€ê²½</button>
                            ` : ''}
                        `}
                    </div>
                    
                    ${(() => {
                        // ê²½ê¸°ë‹¹ ì›Œë°ì—… 1íšŒë§Œ (IBSA ê·œì¹™)
                        const warmupUsed = currentMatch.warmupUsed || false;
                        const canUseWarmup = isAuthenticated && !warmupActive && !warmupUsed;
                        const warmupTime = (currentMatch.type === 'team') ? 90 : 60; // IBSA: ê°œì¸ì „ 60ì´ˆ, íŒ€ì „ 90ì´ˆ
                        return canUseWarmup ? `
                        <div style="text-align:center; margin-bottom:16px;">
                            <button class="btn" onclick="startWarmup()" style="background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%); color:white;">
                                ğŸ”¥ ì›Œë°ì—… ${warmupTime}ì´ˆ ì‹œì‘
                            </button>
                        </div>
                    ` : '';
                    })()}
                    
                    ${warmupActive ? `
                        <div style="text-align:center; padding:16px; background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%); color:white; border-radius:8px; margin-bottom:16px;">
                            <h3 style="margin:0; color:white;">ğŸ”¥ ì›Œë°ì—… ì§„í–‰ ì¤‘</h3>
                            <div style="font-size:36px; font-weight:700; margin:8px 0;" id="warmup-timer">${Math.floor(warmupSeconds / 60)}:${(warmupSeconds % 60).toString().padStart(2, '0')}</div>
                            <button class="btn" onclick="stopWarmup()" style="background:white; color:#ff5722;">ì›Œë°ì—… ì¢…ë£Œ</button>
                        </div>
                    ` : ''}
                    
                    ${isPaused ? `
                        <div style="text-align:center; padding:16px; background:var(--warning); color:white; border-radius:8px; margin-bottom:16px;">
                            <h3 style="margin:0; color:white;">â¸ï¸ ê²½ê¸° ì¼ì‹œì •ì§€</h3>
                            <div style="font-size:24px; margin-top:8px;" id="pause-timer">${Math.floor(pauseSeconds / 60)}:${(pauseSeconds % 60).toString().padStart(2, '0')}</div>
                            <div style="margin-top:8px; font-size:14px;">${currentMatch.pauseReason || ''}</div>
                            <button class="btn" onclick="resumeMatch()" style="margin-top:12px;">â–¶ï¸ ê²½ê¸° ì¬ê°œ</button>
                        </div>
                    ` : ''}
                    
                    ${isAuthenticated ? `
                    <h3 style="margin-bottom:8px;">â±ï¸ íƒ€ì„ì•„ì›ƒ</h3>
                    <div class="timeout-section">
                        <button class="timeout-btn" onclick="startTimeout('player1')" ${currentMatch.timeouts.player1 === 0 || isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player1Name} íƒ€ì„ì•„ì›ƒ
                            <span class="timeout-count">ë‚¨ì€ íšŸìˆ˜: ${currentMatch.timeouts.player1}</span>
                        </button>
                        <button class="timeout-btn" onclick="startTimeout('player2')" ${currentMatch.timeouts.player2 === 0 || isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player2Name} íƒ€ì„ì•„ì›ƒ
                            <span class="timeout-count">ë‚¨ì€ íšŸìˆ˜: ${currentMatch.timeouts.player2}</span>
                        </button>
                    </div>
                    
                    <h3 style="margin-top:24px; margin-bottom:12px;">ë“ì  ê¸°ë¡</h3>
                    
                    <!-- ê³¨ ë“ì  (ì¢Œìš° ë°°ì¹˜) -->
                    <div class="foul-grid">
                        <button class="foul-btn goal-btn" onclick="addScore('player1', 2, '${currentMatch.player1Name} ê³¨')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ê³¨ +2ì 
                        </button>
                        <button class="foul-btn goal-btn" onclick="addScore('player2', 2, '${currentMatch.player2Name} ê³¨')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ê³¨ +2ì 
                        </button>
                    </div>
                    
                    <!-- IBSA íŒŒìš¸ (ìƒëŒ€ ë“ì  1ì ) -->
                    <h4 style="margin:16px 0 8px; font-size:14px; color:var(--text-secondary);">íŒŒìš¸ +1ì  (ìƒëŒ€ ë“ì )</h4>
                    
                    <!-- ë¶€ì • ì„œë¸Œ Irregular Serve -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} ë¶€ì •ì„œë¸Œ')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ë¶€ì •ì„œë¸Œ
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} ë¶€ì •ì„œë¸Œ')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ë¶€ì •ì„œë¸Œ
                        </button>
                    </div>
                    
                    <!-- ì„¼í„°ë³´ë“œ Centerboard -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} ì„¼í„°ë³´ë“œ')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ì„¼í„°ë³´ë“œ
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} ì„¼í„°ë³´ë“œ')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ì„¼í„°ë³´ë“œ
                        </button>
                    </div>
                    
                    <!-- ë°”ë””í„°ì¹˜ Body Touch -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} ë°”ë””í„°ì¹˜')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ë°”ë””í„°ì¹˜
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} ë°”ë””í„°ì¹˜')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ë°”ë””í„°ì¹˜
                        </button>
                    </div>
                    
                    <!-- ì¼ë¦¬ê±¸ ë””íœìŠ¤ Illegal Defense -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} ì¼ë¦¬ê±¸ë””íœìŠ¤')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ì¼ë¦¬ê±¸ë””íœìŠ¤
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} ì¼ë¦¬ê±¸ë””íœìŠ¤')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ì¼ë¦¬ê±¸ë””íœìŠ¤
                        </button>
                    </div>
                    
                    <!-- ì•„ì›ƒ Out -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} ì•„ì›ƒ')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ì•„ì›ƒ
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} ì•„ì›ƒ')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ì•„ì›ƒ
                        </button>
                    </div>
                    
                    <!-- ë³¼ í™€ë”© Ball Infraction (2ì´ˆ ì´ìƒ) -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} ë³¼í™€ë”©')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ë³¼í™€ë”©(2ì´ˆ)
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} ë³¼í™€ë”©')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ë³¼í™€ë”©(2ì´ˆ)
                        </button>
                    </div>
                    
                    <!-- ê²½ê³  í›„ ë²Œì  +2ì  -->
                    <h4 style="margin:16px 0 8px; font-size:14px; color:var(--danger);">ë²Œì  +2ì  (ê²½ê³  í›„ ë°˜ë³µ ë˜ëŠ” ì¦‰ì‹œ)</h4>
                    
                    <!-- ë§ˆìŠ¤í¬ í„°ì¹˜ (ì¦‰ì‹œ 2ì ) -->
                    <div class="foul-grid">
                        <button class="foul-btn" style="background:#ffebee;" onclick="addScore('player2', 2, '${currentMatch.player1Name} ë§ˆìŠ¤í¬í„°ì¹˜')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ë§ˆìŠ¤í¬í„°ì¹˜ +2
                        </button>
                        <button class="foul-btn" style="background:#ffebee;" onclick="addScore('player1', 2, '${currentMatch.player2Name} ë§ˆìŠ¤í¬í„°ì¹˜')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ë§ˆìŠ¤í¬í„°ì¹˜ +2
                        </button>
                    </div>
                    
                    <!-- ê¸°íƒ€ ë²Œì  (ê²½ê³  í›„ 2ì ) -->
                    <div class="foul-grid">
                        <button class="foul-btn" style="background:#ffebee;" onclick="addScore('player2', 2, '${currentMatch.player1Name} ë²Œì ')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ë²Œì (ê¸°íƒ€) +2
                        </button>
                        <button class="foul-btn" style="background:#ffebee;" onclick="addScore('player1', 2, '${currentMatch.player2Name} ë²Œì ')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ë²Œì (ê¸°íƒ€) +2
                        </button>
                    </div>
                    
                    <div class="action-row">
                        <button class="btn btn-danger" onclick="undo()" ${currentMatch.history.length === 0 ? 'disabled' : ''}>â†©ï¸ ì·¨ì†Œ</button>
                        <button class="btn btn-success" onclick="endSet()">${(() => {
                            // í˜„ì¬ê¹Œì§€ ì„¸íŠ¸ ìŠ¹ìˆ˜ ê³„ì‚°
                            let p1Wins = 0, p2Wins = 0;
                            currentMatch.setScores.forEach((s, idx) => {
                                if (idx < currentMatch.currentSet - 1) {
                                    if (s.player1 > s.player2) p1Wins++;
                                    else if (s.player2 > s.player1) p2Wins++;
                                }
                            });
                            const winsNeeded = Math.ceil(currentMatch.sets / 2);
                            const currentSet = currentMatch.setScores[currentMatch.currentSet - 1];
                            const currentWinner = currentSet.player1 > currentSet.player2 ? 'p1' : 'p2';
                            const wouldWin = (currentWinner === 'p1' && p1Wins + 1 >= winsNeeded) || 
                                           (currentWinner === 'p2' && p2Wins + 1 >= winsNeeded);
                            return wouldWin ? 'ê²½ê¸° ì¢…ë£Œ' : 'ì„¸íŠ¸ ì¢…ë£Œ';
                        })()}</button>
                    </div>
                    ` : `
                    <!-- ê´€ëŒ ëª¨ë“œ ì•ˆë‚´ -->
                    <div style="text-align:center; padding:24px; background:var(--bg-secondary); border-radius:12px; margin-top:16px;">
                        <span style="font-size:48px;">ğŸ‘ï¸</span>
                        <h3 style="margin:12px 0;">ê´€ëŒ ëª¨ë“œ</h3>
                        <p style="color:var(--text-secondary);">ì‹¤ì‹œê°„ìœ¼ë¡œ ì ìˆ˜ê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>
                    </div>
                    `}
                    
                    ${isAuthenticated ? `
                        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--border);">
                            <h3 style="margin-bottom:12px;">âš™ï¸ ê²½ê¸° ê´€ë¦¬</h3>
                            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                <button class="btn" onclick="pauseMatch()" ${isPaused ? 'disabled' : ''}>â¸ï¸ ì¼ì‹œì •ì§€</button>
                                <button class="btn" onclick="addMemo()">ğŸ“ ë©”ëª¨ ì¶”ê°€</button>
                                ${currentMatch.type === 'team' ? `<button class="btn" onclick="substitutePlayer()">ğŸ”„ ì„ ìˆ˜ êµì²´</button>` : ''}
                                <button class="btn" onclick="showQRCode()">ğŸ“± QR ê³µìœ </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                ${currentMatch.history.length > 0 ? `
                    <div class="card">
                        <h2>ê²½ê¸° ê¸°ë¡</h2>
                        <div style="margin-bottom:12px; display:flex; gap:8px;">
                            <button class="btn" onclick="toggleHistoryOrder()" id="history-order-btn" style="font-size:12px; padding:6px 12px;">ìµœì‹ ìˆœ â†“</button>
                        </div>
                        <div id="match-history">
                            ${(() => {
                                // ì„¸íŠ¸ë³„ë¡œ ê·¸ë£¹í™”
                                const setGroups = {};
                                currentMatch.history.forEach(h => {
                                    const setNum = h.set || 1;
                                    if (!setGroups[setNum]) setGroups[setNum] = [];
                                    setGroups[setNum].push(h);
                                });
                                
                                // ì„¸íŠ¸ ë²ˆí˜¸ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì¶œë ¥
                                return Object.keys(setGroups).sort((a, b) => b - a).map(setNum => {
                                    const setHistory = setGroups[setNum].slice(0, 10);
                                    const setScore = currentMatch.setScores[setNum - 1];
                                    return `
                                        <div style="margin-bottom:16px;">
                                            <h3 style="color:var(--primary); border-bottom:2px solid var(--primary); padding-bottom:8px; margin-bottom:12px;">
                                                ì„¸íŠ¸ ${setNum} ${setScore ? `(${setScore.player1}:${setScore.player2})` : ''}
                                            </h3>
                                            ${setHistory.map(h => {
                                                let actionDesc = '';
                                                if (h.type.includes('ê³¨')) {
                                                    actionDesc = h.player + ' ê³¨';
                                                } else {
                                                    const foulType = h.type.split(' ').slice(1).join(' ');
                                                    actionDesc = (h.actionPlayer || h.type.split(' ')[0]) + ' ' + foulType + ' (' + h.player + ' ë“ì )';
                                                }
                                                
                                                return '<div style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:6px;">' +
                                                    '<div style="display:flex; justify-content:space-between; margin-bottom:4px;">' +
                                                        '<span style="font-size:12px; color:var(--text-secondary);">' + h.time + ' - ' + (h.server || h.player) + ' ì„œë¸Œ ' + (h.serveNumber || '') + 'íšŒì°¨</span>' +
                                                        (h.scoreBefore ? '<span style="font-size:12px; color:var(--text-secondary);">(' + h.scoreBefore.player1 + ':' + h.scoreBefore.player2 + ')</span>' : '') +
                                                    '</div>' +
                                                    '<div style="display:flex; justify-content:space-between; align-items:center;">' +
                                                        '<span>' + actionDesc + '</span>' +
                                                        '<span style="font-weight:700; color:var(--primary);">' + h.points + 'ì  ë“ì </span>' +
                                                    '</div>' +
                                                    (h.scoreAfter ? '<div style="margin-top:6px; padding-top:6px; border-top:1px solid var(--border);"><span style="font-size:13px; font-weight:600; color:var(--success);">â†’ ìŠ¤ì½”ì–´: ' + h.scoreAfter.player1 + ':' + h.scoreAfter.player2 + '</span></div>' : '') +
                                                '</div>';
                                            }).join('')}
                                        </div>
                                    `;
                                }).join('');
                            })()}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function renderFinishedMatch() {
            const app = document.getElementById('app');
            
            // ì„¸íŠ¸ë³„ ì ìˆ˜ ê³„ì‚°
            const setResults = currentMatch.setScores.map((s, idx) => {
                const winner = s.player1 > s.player2 ? currentMatch.player1Name : currentMatch.player2Name;
                return `ì„¸íŠ¸ ${idx + 1}: ${s.player1}-${s.player2} (${winner} ìŠ¹)`;
            }).join(' | ');
            
            // ìµœì¢… ì ìˆ˜
            const finalSet = currentMatch.setScores[currentMatch.setScores.length - 1];
            const winner = currentMatch.setScores.filter((s, idx) => idx < currentMatch.setScores.length && s.player1 > s.player2).length > 
                          currentMatch.setScores.filter((s, idx) => idx < currentMatch.setScores.length && s.player2 > s.player1).length 
                          ? currentMatch.player1Name : currentMatch.player2Name;
            
            app.innerHTML = `
                <div class="card">
                    <button class="btn btn-primary" onclick="goTo('project-detail')" style="margin-bottom:16px;">â† ê²½ê¸° ëª©ë¡ìœ¼ë¡œ</button>
                    <div style="text-align:center; padding:16px; background:var(--success); color:white; border-radius:8px; margin-bottom:16px;">
                        <h2 style="margin:0; color:white;">âœ… ê²½ê¸° ì¢…ë£Œ</h2>
                        <div style="font-size:18px; margin-top:8px;">ìŠ¹ì: ${winner}</div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <div style="font-weight:600;">ê²½ê¸° ì •ë³´</div>
                        <div style="font-size:12px; color:var(--text-secondary)">ì£¼ì‹¬: ${currentMatch.mainReferee || 'ë¯¸ì •'}</div>
                    </div>
                    
                    <div class="score-grid">
                        <div class="player-score">
                            <div class="player-name">${currentMatch.player1Name}</div>
                            <div class="score-display">${finalSet.player1}</div>
                            ${currentMatch.team1Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team1Lineup.join(', ')}</div>` : ''}
                        </div>
                        <div style="font-size:24px; font-weight:700; color:var(--text-secondary)">VS</div>
                        <div class="player-score">
                            <div class="player-name">${currentMatch.player2Name}</div>
                            <div class="score-display">${finalSet.player2}</div>
                            ${currentMatch.team2Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team2Lineup.join(', ')}</div>` : ''}
                        </div>
                    </div>
                    
                    <div style="padding:12px; background:var(--bg-secondary); border-radius:8px; margin-top:16px;">
                        <div style="font-size:14px; font-weight:600; margin-bottom:8px;">ì„¸íŠ¸ë³„ ê²°ê³¼</div>
                        <div style="font-size:14px;">${setResults}</div>
                    </div>
                </div>
                
                ${currentMatch.history.length > 0 ? `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <h2 style="margin:0;">ì „ì²´ ê²½ê¸° ê¸°ë¡</h2>
                            <button class="btn" onclick="toggleFinishedHistoryOrder()" id="finished-history-order-btn" style="font-size:12px; padding:6px 12px;">${finishedHistoryOrderDesc ? 'ìµœì‹ ìˆœ â†“' : 'ì˜¤ë˜ëœìˆœ â†‘'}</button>
                        </div>
                        <div id="finished-match-history">
                            ${(() => {
                                // ì„¸íŠ¸ë³„ë¡œ ê·¸ë£¹í™”
                                const setGroups = {};
                                currentMatch.history.forEach(h => {
                                    const setNum = h.set || 1;
                                    if (!setGroups[setNum]) setGroups[setNum] = [];
                                    setGroups[setNum].push(h);
                                });
                                
                                // ì •ë ¬ ìˆœì„œ ê²°ì •
                                const setKeys = Object.keys(setGroups).sort((a, b) => 
                                    finishedHistoryOrderDesc ? b - a : a - b
                                );
                                
                                return setKeys.map(setNum => {
                                    let setHistory = setGroups[setNum];
                                    // ì˜¤ë˜ëœìˆœì´ë©´ ì„¸íŠ¸ ë‚´ ê¸°ë¡ë„ ì—­ìˆœìœ¼ë¡œ (ì‹œê°„ìˆœ)
                                    if (!finishedHistoryOrderDesc) {
                                        setHistory = [...setHistory].reverse();
                                    }
                                    const setScore = currentMatch.setScores[setNum - 1];
                                    return `
                                        <div style="margin-bottom:16px;">
                                            <h3 style="color:var(--primary); border-bottom:2px solid var(--primary); padding-bottom:8px; margin-bottom:12px;">
                                                ì„¸íŠ¸ ${setNum} ${setScore ? `(${setScore.player1}:${setScore.player2})` : ''}
                                            </h3>
                                            ${setHistory.map(h => {
                                                let actionDesc = '';
                                                if (h.type.includes('ê³¨')) {
                                                    actionDesc = h.player + ' ê³¨';
                                                } else {
                                                    const foulType = h.type.split(' ').slice(1).join(' ');
                                                    actionDesc = (h.actionPlayer || h.type.split(' ')[0]) + ' ' + foulType + ' (' + h.player + ' ë“ì )';
                                                }
                                                
                                                return '<div style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:6px;">' +
                                                    '<div style="display:flex; justify-content:space-between; margin-bottom:4px;">' +
                                                        '<span style="font-size:12px; color:var(--text-secondary);">' + h.time + ' - ' + (h.server || h.player) + ' ì„œë¸Œ ' + (h.serveNumber || '') + 'íšŒì°¨</span>' +
                                                        (h.scoreBefore ? '<span style="font-size:12px; color:var(--text-secondary);">(' + h.scoreBefore.player1 + ':' + h.scoreBefore.player2 + ')</span>' : '') +
                                                    '</div>' +
                                                    '<div style="display:flex; justify-content:space-between; align-items:center;">' +
                                                        '<span>' + actionDesc + '</span>' +
                                                        '<span style="font-weight:700; color:var(--primary);">' + h.points + 'ì  ë“ì </span>' +
                                                    '</div>' +
                                                    (h.scoreAfter ? '<div style="margin-top:6px; padding-top:6px; border-top:1px solid var(--border);"><span style="font-size:13px; font-weight:600; color:var(--success);">â†’ ìŠ¤ì½”ì–´: ' + h.scoreAfter.player1 + ':' + h.scoreAfter.player2 + '</span></div>' : '') +
                                                '</div>';
                                            }).join('')}
                                        </div>
                                    `;
                                }).join('');
                            })()}
                        </div>
                    </div>
                ` : ''}
            `;
        }
        
        function selectRole(role) {
            userRole = role;
            if (role === 'referee') {
                // ì‹¬íŒ ëª¨ë“œ - ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                const refPasswords = JSON.parse(localStorage.getItem('refereePasswords') || '{}');
                if (Object.keys(refPasswords).length === 0) {
                    alert('âš ï¸ ë“±ë¡ëœ ì‹¬íŒì´ ì—†ìŠµë‹ˆë‹¤.\nê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
                    return;
                }
                screen = 'referee-password';
            } else {
                isAuthenticated = false; // ê´€ëŒ ëª¨ë“œëŠ” ì¸ì¦ ì•ˆ ë¨
                screen = 'viewer-home';
            }
            render();
        }

        function goTo(s) {
            screen = s;
            render();
        }
        
        // ëŒ€íšŒ ìœ í˜• ë³€ê²½ ì‹œ
        // ëŒ€íšŒ ìœ í˜• ì¹´ë“œ ì„ íƒ
        function selectTournamentType(type) {
            // ìˆ¨ê²¨ì§„ input ê°’ ì„¤ì •
            document.getElementById('tournament-type').value = type;
            
            // ì¹´ë“œ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            const cards = document.querySelectorAll('.tournament-type-btn');
            cards.forEach(card => {
                if (card.dataset.type === type) {
                    card.style.borderColor = 'var(--primary)';
                    card.style.background = '#e3f2fd';
                } else {
                    card.style.borderColor = '#ddd';
                    card.style.background = 'white';
                }
            });
            
            // ì„¤ì • íŒ¨ë„ í‘œì‹œ/ìˆ¨ê¹€
            onTournamentTypeChange();
        }
        
        function onTournamentTypeChange() {
            const type = document.getElementById('tournament-type').value;
            document.getElementById('group-settings').style.display = 
                (type === 'group' || type === 'group-tournament') ? 'block' : 'none';
            document.getElementById('tournament-settings').style.display = 
                (type === 'tournament' || type === 'group-tournament') ? 'block' : 'none';
        }
        
        function onCompetitionTypeChange() {
            const type = document.getElementById('competition-type').value;
            const teamSettings = document.getElementById('team-settings');
            const unitLabel = document.getElementById('tournament-unit');
            
            if (type === 'team') {
                teamSettings.style.display = 'block';
                if (unitLabel) unitLabel.textContent = 'íŒ€';
            } else {
                teamSettings.style.display = 'none';
                if (unitLabel) unitLabel.textContent = 'ì¸ì›';
            }
        }

        function createProject() {
            const name = document.getElementById('project-name').value.trim();
            if (!name) {
                alert('í”„ë¡œì íŠ¸ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            const competitionType = document.getElementById('competition-type')?.value || 'individual';
            const tournamentType = document.getElementById('tournament-type').value;
            
            const project = {
                id: Date.now(),
                name,
                date: document.getElementById('project-date').value,
                location: document.getElementById('project-location').value,
                desc: document.getElementById('project-desc').value,
                matches: [],
                createdAt: new Date().toISOString(),
                // ëŒ€íšŒ ì„¤ì •
                competitionType: competitionType, // 'individual' or 'team'
                tournamentType: tournamentType,
                groups: [], // ì¡°ë³„ ë¦¬ê·¸ ì¡° ì •ë³´
                players: [], // ê°œì¸ì „: ì„ ìˆ˜ ëª©ë¡
                teams: [], // íŒ€ì „: íŒ€ ëª©ë¡
                bracket: null, // í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ
                standings: [] // ìµœì¢… ìˆœìœ„
            };
            
            // ì¡°ë³„ ë¦¬ê·¸ ì„¤ì •
            if (tournamentType === 'group' || tournamentType === 'group-tournament') {
                project.groupSettings = {
                    groupCount: parseInt(document.getElementById('group-count').value) || 2,
                    advanceCount: parseInt(document.getElementById('advance-count').value) || 2,
                    setsPerMatch: 3 // ì˜ˆì„ ì€ í•­ìƒ 3ì„¸íŠ¸
                };
            }
            
            // í† ë„ˆë¨¼íŠ¸ ì„¤ì •
            if (tournamentType === 'tournament' || tournamentType === 'group-tournament') {
                project.tournamentSettings = {
                    size: parseInt(document.getElementById('tournament-size').value) || 8,
                    thirdPlaceMatch: document.getElementById('third-place-match').checked,
                    setsPerMatch: 5 // ë³¸ì„ ì€ 5ì„¸íŠ¸
                };
            }
            
            console.log('í”„ë¡œì íŠ¸ ìƒì„± ì‹œë„:', project);
            
            // Firebaseì— ì €ì¥
            try {
                if (typeof database !== 'undefined' && database) {
                    console.log('Firebaseì— ì €ì¥ ì¤‘...');
                    const newProjectRef = database.ref('projects').push();
                    project.firebaseKey = newProjectRef.key;
                    newProjectRef.set(project).then(() => {
                        console.log('âœ… Firebase ì €ì¥ ì„±ê³µ!');
                        goTo('project-list');
                    }).catch((error) => {
                        console.error('Firebase ì €ì¥ ì—ëŸ¬:', error);
                        alert('Firebase ì €ì¥ ì‹¤íŒ¨. ë¡œì»¬ ì €ì¥ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.');
                        projects.push(project);
                        localStorage.setItem('projects', JSON.stringify(projects));
                        goTo('project-list');
                    });
                } else {
                    // ë¡œì»¬ ì €ì¥
                    console.log('ë¡œì»¬ ì €ì¥ ëª¨ë“œ');
                    projects.push(project);
                    localStorage.setItem('projects', JSON.stringify(projects));
                    goTo('project-list');
                }
            } catch (error) {
                console.error('í”„ë¡œì íŠ¸ ìƒì„± ì—ëŸ¬:', error);
                alert('ì—ëŸ¬: ' + error.message);
                projects.push(project);
                localStorage.setItem('projects', JSON.stringify(projects));
                goTo('project-list');
            }
        }

        function selectProject(index) {
            currentProject = projects[index];
            goTo('project-detail');
        }
        
        // í”„ë¡œì íŠ¸ ê²€ìƒ‰
        function searchProjects() {
            const query = document.getElementById('project-search').value.trim();
            window.projectSearchQuery = query;
            render();
        }
        
        // ê²€ìƒ‰ ì´ˆê¸°í™”
        function clearSearch() {
            window.projectSearchQuery = '';
            render();
        }

        function createMatch() {
            // ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
            function validateField(id, message) {
                const el = document.getElementById(id);
                const value = el ? el.value.trim() : '';
                if (!value) {
                    alert(message);
                    if (el) el.focus();
                    return null;
                }
                return value;
            }
            
            const type = document.getElementById('match-type').value;
            
            // ì„ ìˆ˜/íŒ€ ì´ë¦„ ê²€ì‚¬
            const player1 = validateField('player1', type === 'team' ? 'íŒ€ 1 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”' : 'ì„ ìˆ˜ 1 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            if (!player1) return;
            
            const player2 = validateField('player2', type === 'team' ? 'íŒ€ 2 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”' : 'ì„ ìˆ˜ 2 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            if (!player2) return;
            
            // PIN ê²€ì‚¬
            const pinEl = document.getElementById('referee-pin');
            const pin = pinEl ? pinEl.value.trim() : '';
            if (!pin) {
                alert('ì‹¬íŒ PINì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                if (pinEl) pinEl.focus();
                return;
            }
            if (pin.length < 6) {
                alert('ì‹¬íŒ PINì€ 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤');
                if (pinEl) pinEl.focus();
                return;
            }
            if (!/^\d+$/.test(pin)) {
                alert('ì‹¬íŒ PINì€ ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                if (pinEl) pinEl.focus();
                return;
            }
            
            // íŒ€ì „ì¼ ê²½ìš° ë¼ì¸ì—… í™•ì¸
            let team1Lineup = null;
            let team2Lineup = null;
            if (type === 'team') {
                const t1p1 = validateField('team1-player1', 'íŒ€ 1 ì„ ìˆ˜ 1 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                if (!t1p1) return;
                const t1p2 = validateField('team1-player2', 'íŒ€ 1 ì„ ìˆ˜ 2 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                if (!t1p2) return;
                const t1p3 = validateField('team1-player3', 'íŒ€ 1 ì„ ìˆ˜ 3 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                if (!t1p3) return;
                const t2p1 = validateField('team2-player1', 'íŒ€ 2 ì„ ìˆ˜ 1 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                if (!t2p1) return;
                const t2p2 = validateField('team2-player2', 'íŒ€ 2 ì„ ìˆ˜ 2 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                if (!t2p2) return;
                const t2p3 = validateField('team2-player3', 'íŒ€ 2 ì„ ìˆ˜ 3 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                if (!t2p3) return;
                
                team1Lineup = [t1p1, t1p2, t1p3];
                team2Lineup = [t2p1, t2p2, t2p3];
            }

            const sets = type === 'individual' ? parseInt(document.getElementById('sets').value) : 1;
            const match = {
                id: Date.now(),
                type,
                sets,
                player1Name: player1,
                player2Name: player2,
                team1Lineup,
                team2Lineup,
                mainReferee: document.getElementById('main-referee')?.value.trim() || '',
                assistantReferee: document.getElementById('assistant-referee')?.value.trim() || '',
                coach1: document.getElementById('coach1')?.value.trim() || '',
                coach2: document.getElementById('coach2')?.value.trim() || '',
                refereePin: pin,
                winScore: type === 'individual' ? 11 : 31,
                currentSet: 1,
                setScores: [{player1: 0, player2: 0}],
                currentServe: 'player1',
                serveCount: 0,
                serveSelected: false, // ì„œë¸Œ ë¯¸ì„ íƒ ìƒíƒœ
                timeouts: {
                    player1: 1,
                    player2: 1
                },
                sideChangeUsed: false,
                status: 'active',
                history: [],
                warmupUsed: false,
                createdAt: new Date().toISOString()
            };
            
            // currentProject í™•ì¸
            if (!currentProject) {
                alert('í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”');
                goTo('project-list');
                return;
            }
            
            if (!currentProject.matches) {
                currentProject.matches = [];
            }
            
            currentProject.matches.push(match);
            currentMatch = match;
            isAuthenticated = true;
            
            // ì €ì¥ (ë¡œì»¬ ìš°ì„ )
            try {
                if (database && currentProject.firebaseKey) {
                    database.ref('projects/' + currentProject.firebaseKey).set(currentProject);
                } else {
                    // ë¡œì»¬ ì €ì¥
                    const idx = projects.findIndex(p => p.id === currentProject.id);
                    if (idx >= 0) {
                        projects[idx] = currentProject;
                    }
                    localStorage.setItem('projects', JSON.stringify(projects));
                }
            } catch (e) {
                localStorage.setItem('projects', JSON.stringify(projects));
            }
            
            // ê²½ê¸° ìƒì„± ì™„ë£Œ í›„ ê²½ê¸° ëª©ë¡ìœ¼ë¡œ ì´ë™
            alert('âœ… ê²½ê¸°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            screen = 'project-detail';
            render();
        }

        function selectMatch(index) {
            matchSelectionInProgress = true; // ê²½ê¸° ì„ íƒ ì‹œì‘
            isUserAction = true;
            currentMatch = currentProject.matches[index];
            
            // ì™„ë£Œëœ ê²½ê¸°ëŠ” ì¸ì¦ ë¶ˆí•„ìš”
            if (currentMatch.status === 'completed') {
                isAuthenticated = false;
                screen = 'match';
                render();
                setTimeout(() => { matchSelectionInProgress = false; isUserAction = false; }, 2000);
                return;
            }
            
            // ê´€ëŒ ëª¨ë“œë¡œ ì ‘ì†í–ˆìœ¼ë©´ ë°”ë¡œ ë³´ê¸°
            if (userRole === 'viewer') {
                isAuthenticated = false;
                screen = 'match';
                render();
                setTimeout(() => { matchSelectionInProgress = false; isUserAction = false; }, 2000);
                return;
            }
            
            // ì‹¬íŒ ëª¨ë“œ - ë¨¼ì € screenì„ matchë¡œ ì„¤ì • (Firebase ë°©ì–´)
            screen = 'match';
            
            // PIN í™•ì¸
            const inputPin = prompt('ğŸ” ì‹¬íŒ PINì„ ì…ë ¥í•˜ì„¸ìš”:');
            
            if (inputPin === currentMatch.refereePin) {
                isAuthenticated = true;
                render();
                setTimeout(() => { matchSelectionInProgress = false; isUserAction = false; }, 2000);
            } else {
                // PIN í‹€ë¦¬ë©´ ì›ë˜ í™”ë©´ìœ¼ë¡œ
                screen = 'project-detail';
                currentMatch = null;
                isAuthenticated = false;
                alert('âŒ PINì´ í‹€ë ¸ìŠµë‹ˆë‹¤.');
                render();
                setTimeout(() => { matchSelectionInProgress = false; isUserAction = false; }, 500);
            }
        }

        let lastScoreTime = 0; // ë”ë¸”í´ë¦­ ë°©ì§€
        
        function addScore(player, points, type) {
            // ë”ë¸”í´ë¦­ ë°©ì§€ (500ms ì´ë‚´ ì¬í´ë¦­ ë¬´ì‹œ)
            const now = Date.now();
            if (now - lastScoreTime < 500) {
                console.log('ë”ë¸”í´ë¦­ ë°©ì§€');
                return;
            }
            lastScoreTime = now;
            
            // ì¸ì¦ í™•ì¸
            if (!isAuthenticated) {
                alert('âŒ ì‹¬íŒë§Œ ë“ì ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
                return;
            }
            
            const set = currentMatch.setScores[currentMatch.currentSet - 1];
            // ë“ì  ì „ ìŠ¤ì½”ì–´ ì €ì¥
            const scoreBefore = { player1: set.player1, player2: set.player2 };
            
            if (player === 'player1') set.player1 += points;
            else set.player2 += points;
            
            // ë“ì  í›„ ìŠ¤ì½”ì–´ ì €ì¥
            const scoreAfter = { player1: set.player1, player2: set.player2 };
            
            // í˜„ì¬ ì„œë¸Œ ì •ë³´ ì €ì¥
            const servingPlayer = currentMatch.currentServe === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            const serveNumber = currentMatch.serveCount + 1;
            
            currentMatch.history.unshift({
                time: new Date().toLocaleTimeString('ko-KR'),
                player: player === 'player1' ? currentMatch.player1Name : currentMatch.player2Name, // ë“ì í•œ ì„ ìˆ˜
                actionPlayer: type.includes('ê³¨') ? (player === 'player1' ? currentMatch.player1Name : currentMatch.player2Name) : type.split(' ')[0], // ì•¡ì…˜í•œ ì„ ìˆ˜ (ê³¨ ë˜ëŠ” íŒŒìš¸í•œ ì„ ìˆ˜)
                type,
                points,
                set: currentMatch.currentSet,
                server: servingPlayer,
                serveNumber: serveNumber,
                scoreBefore: scoreBefore,
                scoreAfter: scoreAfter
            });
            
            currentMatch.serveCount++;
            // IBSA ê·œì¹™: ê°œì¸ì „ 2íšŒ, íŒ€ì „ 3íšŒ (type ì—†ìœ¼ë©´ ê°œì¸ì „ìœ¼ë¡œ ì²˜ë¦¬)
            const maxServes = (currentMatch.type === 'team') ? 3 : 2;
            if (currentMatch.serveCount >= maxServes) {
                currentMatch.currentServe = currentMatch.currentServe === 'player1' ? 'player2' : 'player1';
                currentMatch.serveCount = 0;
            }
            
            const score = player === 'player1' ? set.player1 : set.player2;
            const playerName = player === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            
            saveProjects();
            renderMatch();
            
            // aria-live ì‹¤ì‹œê°„ ì•ˆë‚´ (ì„œë¸Œê¶Œ ê¸°ì¤€ ìŠ¤ì½”ì–´ ìˆœì„œ)
            const nextServer = currentMatch.currentServe === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            const nextServeCount = currentMatch.serveCount + 1;
            // ì„œë¸Œê¶Œ ê°€ì§„ ì„ ìˆ˜ ìŠ¤ì½”ì–´ë¥¼ ë¨¼ì €
            const serverScore = currentMatch.currentServe === 'player1' ? set.player1 : set.player2;
            const receiverScore = currentMatch.currentServe === 'player1' ? set.player2 : set.player1;
            const announcement = `${playerName} ${points}ì . ìŠ¤ì½”ì–´ ${serverScore} ëŒ€ ${receiverScore}. ${nextServer} ${nextServeCount}ë²ˆì§¸ ì„œë¸Œ`;
            announce(announcement);
            
            // ì‚¬ì´ë“œ ì²´ì¸ì§€ ì²´í¬
            // ê°œì¸ì „: ë§ˆì§€ë§‰ ì„¸íŠ¸ì—ì„œ ë¨¼ì € 6ì  ë„ë‹¬ ì‹œ, íŒ€ì „: ë¨¼ì € 16ì  ë„ë‹¬ ì‹œ
            let shouldCheckSideChange = false;
            if (currentMatch.type === 'team') {
                shouldCheckSideChange = true;
            } else {
                // ê°œì¸ì „: ë§ˆì§€ë§‰ ì„¸íŠ¸ì¸ì§€ í™•ì¸
                const player1SetWins = currentMatch.setScores.filter((s, idx) => idx < currentMatch.currentSet - 1 && s.player1 > s.player2).length;
                const player2SetWins = currentMatch.setScores.filter((s, idx) => idx < currentMatch.currentSet - 1 && s.player2 > s.player1).length;
                const totalSetsNeeded = Math.ceil(currentMatch.sets / 2); // 3ì„¸íŠ¸ë©´ 2ìŠ¹, 5ì„¸íŠ¸ë©´ 3ìŠ¹
                const isLastSet = (player1SetWins === totalSetsNeeded - 1 && player2SetWins === totalSetsNeeded - 1);
                shouldCheckSideChange = isLastSet;
            }
            
            if (shouldCheckSideChange) {
                const sideChangePoint = currentMatch.type === 'individual' ? 6 : 16;
                const maxScore = Math.max(set.player1, set.player2);
                // ë¨¼ì € 6ì (ê°œì¸ì „) ë˜ëŠ” 16ì (íŒ€ì „)ì— ë„ë‹¬í•œ ìˆœê°„ ì‚¬ì´ë“œì²´ì¸ì§€
                if (!currentMatch.sideChangeUsed && maxScore >= sideChangePoint) {
                    currentMatch.sideChangeUsed = true;
                    const leadingPlayer = set.player1 >= sideChangePoint ? currentMatch.player1Name : currentMatch.player2Name;
                    saveProjects();
                    setTimeout(() => {
                        if (confirm(`ì‚¬ì´ë“œ ì²´ì¸ì§€! (${leadingPlayer} ${maxScore}ì  ë„ë‹¬)\n\n1ë¶„ íœ´ì‹ íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                            startSideChange();
                        }
                    }, 500);
                    return; // ì‚¬ì´ë“œ ì²´ì¸ì§€ í™•ì¸ í›„ ë¦¬í„´
                }
            }
            
            // ì„¸íŠ¸ ì¢…ë£Œ ì¡°ê±´ í™•ì¸ ë° ìë™ íŒì—…
            const diff = Math.abs(set.player1 - set.player2);
            const max = Math.max(set.player1, set.player2);
            if (max >= currentMatch.winScore && diff >= 2) {
                setTimeout(() => {
                    // í˜„ì¬ê¹Œì§€ ì„¸íŠ¸ ìŠ¹ìˆ˜ ê³„ì‚°
                    let p1Wins = 0, p2Wins = 0;
                    currentMatch.setScores.forEach((s, idx) => {
                        if (idx < currentMatch.currentSet - 1) {
                            if (s.player1 > s.player2) p1Wins++;
                            else if (s.player2 > s.player1) p2Wins++;
                        }
                    });
                    // í˜„ì¬ ì„¸íŠ¸ ìŠ¹ì ì¶”ê°€
                    if (set.player1 > set.player2) p1Wins++;
                    else p2Wins++;
                    
                    const winsNeeded = Math.ceil(currentMatch.sets / 2);
                    const matchWinner = p1Wins >= winsNeeded ? currentMatch.player1Name : 
                                       p2Wins >= winsNeeded ? currentMatch.player2Name : null;
                    
                    let setEndText;
                    if (matchWinner) {
                        setEndText = `ğŸ† ê²½ê¸° ì¢…ë£Œ!\n\n${matchWinner} ìŠ¹ë¦¬! (ì„¸íŠ¸ ${p1Wins}:${p2Wins})\ní˜„ì¬ ì ìˆ˜: ${set.player1} - ${set.player2}`;
                    } else {
                        setEndText = `ì„¸íŠ¸ ${currentMatch.currentSet}ì„(ë¥¼) ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní˜„ì¬ ì ìˆ˜: ${set.player1} - ${set.player2}\nì„¸íŠ¸ ìŠ¤ì½”ì–´: ${p1Wins}:${p2Wins}`;
                    }
                    
                    if (confirm(setEndText)) {
                        endSet();
                    }
                }, 500);
            }
        }


        function undo() {
            if (!isAuthenticated) {
                alert('âŒ ì‹¬íŒë§Œ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
                return;
            }
            if (currentMatch.history.length === 0) return;
            
            const last = currentMatch.history.shift();
            const set = currentMatch.setScores[currentMatch.currentSet - 1];
            
            if (last.player === currentMatch.player1Name) set.player1 -= last.points;
            else set.player2 -= last.points;
            
            currentMatch.serveCount--;
            if (currentMatch.serveCount < 0) {
                currentMatch.currentServe = currentMatch.currentServe === 'player1' ? 'player2' : 'player1';
                const maxServes = (currentMatch.type === 'team') ? 3 : 2;
                currentMatch.serveCount = maxServes - 1;
            }
            
            // aria-live ì‹¤ì‹œê°„ ì•ˆë‚´
            const nextServer = currentMatch.currentServe === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            announce(`ì·¨ì†Œë¨. ${currentMatch.player1Name} ${set.player1}, ${currentMatch.player2Name} ${set.player2}. ë‹¤ìŒ ì„œë¸Œ ${nextServer}`);
            
            saveProjects();
            renderMatch();
        }

        function endSet() {
            if (!isAuthenticated) {
                alert('âŒ ì‹¬íŒë§Œ ì„¸íŠ¸ë¥¼ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
                return;
            }
            const set = currentMatch.setScores[currentMatch.currentSet - 1];
            const diff = Math.abs(set.player1 - set.player2);
            const max = Math.max(set.player1, set.player2);
            
            if (max < currentMatch.winScore) {
                alert(`${currentMatch.winScore}ì  ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤`);
                return;
            }
            if (diff < 2) {
                alert('2ì  ì´ìƒ ì°¨ì´ê°€ ë‚˜ì•¼ í•©ë‹ˆë‹¤');
                return;
            }
            
            // ì„¸íŠ¸ ìŠ¹ì ê²°ì •
            const setWinner = set.player1 > set.player2 ? 'player1' : 'player2';
            
            // í˜„ì¬ê¹Œì§€ ì„¸íŠ¸ ìŠ¹ìˆ˜ ê³„ì‚° (í˜„ì¬ ì„¸íŠ¸ í¬í•¨)
            let player1SetWins = 0;
            let player2SetWins = 0;
            
            currentMatch.setScores.forEach((s, idx) => {
                if (idx < currentMatch.currentSet) { // í˜„ì¬ ì„¸íŠ¸ê¹Œì§€ í¬í•¨
                    if (s.player1 > s.player2) player1SetWins++;
                    else if (s.player2 > s.player1) player2SetWins++;
                }
            });
            
            // ì„ ìŠ¹ ì¡°ê±´: 3ì„¸íŠ¸ â†’ 2ìŠ¹, 5ì„¸íŠ¸ â†’ 3ìŠ¹
            const winsNeeded = Math.ceil(currentMatch.sets / 2);
            const matchWinner = player1SetWins >= winsNeeded ? currentMatch.player1Name : 
                               player2SetWins >= winsNeeded ? currentMatch.player2Name : null;
            
            if (matchWinner) {
                // ê²½ê¸° ì¢…ë£Œ!
                currentMatch.status = 'completed';
                currentMatch.winner = matchWinner;
                currentMatch.finishedAt = new Date().toISOString();
                announce(`ê²½ê¸° ì¢…ë£Œ! ${matchWinner} ìŠ¹ë¦¬! (ì„¸íŠ¸ ${player1SetWins}:${player2SetWins})`);
                
                // ì—°ìŠµ ê²½ê¸°ì¸ ê²½ìš° ë³„ë„ ê²°ê³¼ í™”ë©´ìœ¼ë¡œ
                if (currentMatch.isPractice || currentProject?.isPractice) {
                    // ìë™ ì €ì¥ (silent)
                    savePracticeResult(true);
                    goTo('practice-result');
                    return;
                }
                
                // í† ë„ˆë¨¼íŠ¸ ì§„í–‰ ì²˜ë¦¬
                processTournamentProgression(currentMatch, matchWinner);
                
                saveProjects();
                goTo('project-detail');
            } else {
                // ë‹¤ìŒ ì„¸íŠ¸ë¡œ
                const prevSet = currentMatch.currentSet;
                currentMatch.currentSet++;
                // ë‹¤ìŒ ì„¸íŠ¸ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
                if (!currentMatch.setScores[currentMatch.currentSet - 1]) {
                    currentMatch.setScores.push({player1: 0, player2: 0});
                } else {
                    // ì´ë¯¸ ìˆìœ¼ë©´ ì´ˆê¸°í™”
                    currentMatch.setScores[currentMatch.currentSet - 1] = {player1: 0, player2: 0};
                }
                currentMatch.serveCount = 0;
                currentMatch.sideChangeUsed = false; // ì‚¬ì´ë“œ ì²´ì¸ì§€ ë¦¬ì…‹
                // ê°œì¸ì „ë§Œ ì„¸íŠ¸ë§ˆë‹¤ íƒ€ì„ì•„ì›ƒ ë¦¬ì…‹ (íŒ€ì „ì€ ë‹¨íŒì´ë¯€ë¡œ ë¦¬ì…‹ ì—†ìŒ)
                if (currentMatch.type === 'individual') {
                    currentMatch.timeouts = { player1: 1, player2: 1 };
                    announce(`ì„¸íŠ¸ ${prevSet} ì¢…ë£Œ (${player1SetWins}:${player2SetWins}). ì„¸íŠ¸ ${currentMatch.currentSet} ì‹œì‘. íƒ€ì„ì•„ì›ƒ ë¦¬ì…‹`);
                } else {
                    announce(`ì„¸íŠ¸ ${prevSet} ì¢…ë£Œ. ì„¸íŠ¸ ${currentMatch.currentSet} ì‹œì‘`);
                }
                saveProjects();
                renderMatch();
            }
        }

        // ì„œë¸Œê¶Œ ìˆ˜ë™ ë³€ê²½
        function changeServe() {
            if (!isAuthenticated) return;
            currentMatch.currentServe = currentMatch.currentServe === 'player1' ? 'player2' : 'player1';
            currentMatch.serveCount = 0;
            const newServer = currentMatch.currentServe === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            announce(`ì„œë¸Œê¶Œ ë³€ê²½: ${newServer}`);
            saveProjects();
            renderMatch();
        }
        
        // ê²½ê¸° ì¼ì‹œì •ì§€
        function pauseMatch() {
            if (!isAuthenticated || isPaused) return;
            const reason = prompt('ì¼ì‹œì •ì§€ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n(ì˜ˆ: ë¶€ìƒ, ì¥ë¹„ ë¬¸ì œ, ê¸°íƒ€)');
            if (reason === null) return;
            
            isPaused = true;
            pauseSeconds = 0;
            currentMatch.pauseReason = reason || 'ì‚¬ìœ  ì—†ìŒ';
            
            // ì¼ì‹œì •ì§€ ê¸°ë¡ ì¶”ê°€
            if (!currentMatch.pauseHistory) currentMatch.pauseHistory = [];
            currentMatch.pauseHistory.push({
                time: new Date().toLocaleTimeString('ko-KR'),
                reason: currentMatch.pauseReason,
                set: currentMatch.currentSet
            });
            
            pauseTimer = setInterval(() => {
                pauseSeconds++;
                const timerEl = document.getElementById('pause-timer');
                if (timerEl) {
                    timerEl.textContent = `${Math.floor(pauseSeconds / 60)}:${(pauseSeconds % 60).toString().padStart(2, '0')}`;
                }
            }, 1000);
            
            announce(`ê²½ê¸° ì¼ì‹œì •ì§€. ì‚¬ìœ : ${currentMatch.pauseReason}`);
            saveProjects();
            renderMatch();
        }
        
        // ê²½ê¸° ì¬ê°œ
        function resumeMatch() {
            if (!isPaused) return;
            clearInterval(pauseTimer);
            
            // ì¼ì‹œì •ì§€ ì‹œê°„ ê¸°ë¡
            if (currentMatch.pauseHistory && currentMatch.pauseHistory.length > 0) {
                currentMatch.pauseHistory[currentMatch.pauseHistory.length - 1].duration = pauseSeconds;
            }
            
            isPaused = false;
            pauseSeconds = 0;
            currentMatch.pauseReason = null;
            
            announce('ê²½ê¸° ì¬ê°œ');
            saveProjects();
            renderMatch();
        }
        
        // ë©”ëª¨ ì¶”ê°€
        function addMemo() {
            if (!isAuthenticated) return;
            const memo = prompt('ê²½ê¸° ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (!memo) return;
            
            if (!currentMatch.memos) currentMatch.memos = [];
            currentMatch.memos.push({
                time: new Date().toLocaleTimeString('ko-KR'),
                text: memo,
                set: currentMatch.currentSet,
                score: `${currentMatch.setScores[currentMatch.currentSet - 1].player1}:${currentMatch.setScores[currentMatch.currentSet - 1].player2}`
            });
            
            announce(`ë©”ëª¨ ì¶”ê°€ë¨: ${memo}`);
            saveProjects();
            alert('âœ… ë©”ëª¨ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
        
        // ì„ ìˆ˜ êµì²´ (íŒ€ì „)
        function substitutePlayer() {
            if (!isAuthenticated || currentMatch.type !== 'team') return;
            
            const team = prompt('êµì²´í•  íŒ€ì„ ì„ íƒí•˜ì„¸ìš”:\n1: ' + currentMatch.player1Name + '\n2: ' + currentMatch.player2Name);
            if (team !== '1' && team !== '2') return;
            
            const lineup = team === '1' ? currentMatch.team1Lineup : currentMatch.team2Lineup;
            const teamName = team === '1' ? currentMatch.player1Name : currentMatch.player2Name;
            
            const outPlayer = prompt(`${teamName} - êµì²´ OUT ì„ ìˆ˜ ì´ë¦„:\ní˜„ì¬ ë¼ì¸ì—…: ${lineup.join(', ')}`);
            if (!outPlayer) return;
            
            const inPlayer = prompt(`${teamName} - êµì²´ IN ì„ ìˆ˜ ì´ë¦„:`);
            if (!inPlayer) return;
            
            // ë¼ì¸ì—… ì—…ë°ì´íŠ¸
            const idx = lineup.findIndex(p => p.includes(outPlayer));
            if (idx >= 0) {
                lineup[idx] = inPlayer;
                
                // êµì²´ ê¸°ë¡
                if (!currentMatch.substitutions) currentMatch.substitutions = [];
                currentMatch.substitutions.push({
                    time: new Date().toLocaleTimeString('ko-KR'),
                    team: teamName,
                    out: outPlayer,
                    in: inPlayer,
                    set: currentMatch.currentSet
                });
                
                announce(`ì„ ìˆ˜ êµì²´: ${teamName} - ${outPlayer} OUT, ${inPlayer} IN`);
                saveProjects();
                renderMatch();
                alert(`âœ… ì„ ìˆ˜ êµì²´ ì™„ë£Œ\n${outPlayer} â†’ ${inPlayer}`);
            } else {
                alert('âŒ í•´ë‹¹ ì„ ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
        
        // QR ì½”ë“œ í‘œì‹œ
        function showQRCode() {
            const url = window.location.href;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="text-align:center;">
                    <h2>ğŸ“± QR ì½”ë“œë¡œ ê³µìœ </h2>
                    <p style="margin:12px 0; color:var(--text-secondary);">ê´€ëŒê°ì´ ì´ QRì„ ìŠ¤ìº”í•˜ë©´<br>ì‹¤ì‹œê°„ìœ¼ë¡œ ê²½ê¸°ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <img src="${qrUrl}" alt="QR ì½”ë“œ" style="margin:16px auto; display:block; border-radius:8px;">
                    <p style="font-size:12px; color:var(--text-secondary); word-break:break-all; margin:12px 0;">${url}</p>
                    <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove()">ë‹«ê¸°</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // í”„ë¡œì íŠ¸ë³„ QR ì½”ë“œ í‘œì‹œ
        function showProjectQR(projectIndex) {
            const project = projects[projectIndex];
            if (!project) return;
            
            // í”„ë¡œì íŠ¸ ì ‘ì† URL ìƒì„± (í˜„ì¬ ë„ë©”ì¸ + í”„ë¡œì íŠ¸ ID íŒŒë¼ë¯¸í„°)
            const baseUrl = window.location.origin + window.location.pathname;
            const projectUrl = `${baseUrl}?project=${project.id}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(projectUrl)}`;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="text-align:center;">
                    <h2>ğŸ“± í”„ë¡œì íŠ¸ QR ê³µìœ </h2>
                    <h3 style="color:var(--primary); margin:8px 0;">${project.name}</h3>
                    <p style="margin:8px 0; color:var(--text-secondary); font-size:13px;">
                        ${project.date || 'ë‚ ì§œ ë¯¸ì •'} Â· ${project.location || 'ì¥ì†Œ ë¯¸ì •'}
                    </p>
                    <img src="${qrUrl}" alt="QR ì½”ë“œ" style="margin:16px auto; display:block; border-radius:8px; border:2px solid #eee;">
                    <p style="font-size:11px; color:var(--text-secondary); margin:12px 0;">
                        QRì„ ìŠ¤ìº”í•˜ë©´ ì´ í”„ë¡œì íŠ¸ë¡œ ë°”ë¡œ ì ‘ì†í•©ë‹ˆë‹¤
                    </p>
                    <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
                        <button class="btn" onclick="copyProjectUrl('${projectUrl}')">ğŸ“‹ URL ë³µì‚¬</button>
                        <button class="btn" onclick="downloadProjectQR('${qrUrl}', '${project.name}')">ğŸ’¾ QR ì €ì¥</button>
                        <button class="btn btn-primary" onclick="this.parentElement.parentElement.parentElement.remove()">ë‹«ê¸°</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // í”„ë¡œì íŠ¸ URL ë³µì‚¬
        function copyProjectUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                announce('URLì´ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤');
                alert('âœ… URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }).catch(() => {
                prompt('URLì„ ë³µì‚¬í•˜ì„¸ìš”:', url);
            });
        }
        
        // QR ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
        function downloadProjectQR(qrUrl, projectName) {
            const link = document.createElement('a');
            link.href = qrUrl;
            link.download = `QR_${projectName.replace(/[^a-zA-Z0-9ê°€-í£]/g, '_')}.png`;
            link.target = '_blank';
            link.click();
            announce('QR ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹œì‘');
        }

        // ========== ëŒ€ì§„ ê´€ë¦¬ í•¨ìˆ˜ë“¤ ==========
        
        // ì„ ìˆ˜ ì¶”ê°€
        // ========== íŒ€ ê´€ë¦¬ í•¨ìˆ˜ ==========
        function addTeam() {
            const nameInput = document.getElementById('new-team-name');
            const membersInput = document.getElementById('new-team-members');
            
            const teamName = nameInput.value.trim();
            if (!teamName) {
                alert('íŒ€ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!currentProject.teams) currentProject.teams = [];
            
            // ì¤‘ë³µ ì²´í¬
            if (currentProject.teams.find(t => t.name === teamName)) {
                alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” íŒ€ëª…ì…ë‹ˆë‹¤.');
                return;
            }
            
            // ì„ ìˆ˜ íŒŒì‹± (ì´ë¦„/ì„±ë³„ í˜•ì‹)
            const members = membersInput.value.split(',').map(m => {
                const parts = m.trim().split('/');
                const name = parts[0]?.trim();
                const genderStr = parts[1]?.trim()?.toLowerCase();
                let gender = 'male'; // ê¸°ë³¸ê°’
                if (genderStr === 'ì—¬' || genderStr === 'f' || genderStr === 'female') {
                    gender = 'female';
                }
                return name ? { name, gender } : null;
            }).filter(m => m);
            
            currentProject.teams.push({
                id: Date.now(),
                name: teamName,
                members: members,
                group: null
            });
            
            saveProjects();
            nameInput.value = '';
            membersInput.value = '';
            render();
            announce(`${teamName} íŒ€ ì¶”ê°€ë¨ (${members.length}ëª…)`);
        }
        
        function removeTeam(index) {
            if (confirm('ì´ íŒ€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                currentProject.teams.splice(index, 1);
                saveProjects();
                render();
            }
        }
        
        // ========== ì„ ìˆ˜ ê´€ë¦¬ í•¨ìˆ˜ ==========
        function addPlayer() {
            const input = document.getElementById('new-player-name');
            const names = input.value.split(',').map(n => n.trim()).filter(n => n);
            
            if (names.length === 0) {
                alert('ì„ ìˆ˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!currentProject.players) currentProject.players = [];
            
            names.forEach(name => {
                if (!currentProject.players.find(p => p.name === name)) {
                    currentProject.players.push({
                        id: Date.now() + Math.random(),
                        name: name,
                        group: null
                    });
                }
            });
            
            saveProjects();
            input.value = '';
            render();
            announce(`${names.length}ëª… ì„ ìˆ˜ ì¶”ê°€ë¨`);
        }
        
        // ì„ ìˆ˜ ì‚­ì œ
        function removePlayer(index) {
            if (confirm('ì´ ì„ ìˆ˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                currentProject.players.splice(index, 1);
                saveProjects();
                render();
            }
        }
        
        // ìë™ ì¡° ë°°ì • (ê°œì¸ì „/íŒ€ì „ ê³µìš©)
        function autoAssignGroups() {
            const isTeam = currentProject.competitionType === 'team';
            const participants = isTeam ? (currentProject.teams || []) : (currentProject.players || []);
            
            if (participants.length < 2) {
                alert(`ìµœì†Œ 2${isTeam ? 'íŒ€' : 'ëª…'} ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤.`);
                return;
            }
            
            const groupCount = parseInt(document.getElementById('group-count-edit')?.value) || 2;
            const advanceCount = parseInt(document.getElementById('advance-count-edit')?.value) || 2;
            const setsPerMatch = parseInt(document.getElementById('group-sets-edit')?.value) || 3;
            
            // ì°¸ê°€ì ì„ê¸° (IBSA ì¶”ì²¨ ì‹œë®¬ë ˆì´ì…˜)
            const shuffled = [...participants].sort(() => Math.random() - 0.5);
            
            // ì¡° ìƒì„±
            currentProject.groups = [];
            for (let i = 0; i < groupCount; i++) {
                currentProject.groups.push({
                    name: String.fromCharCode(65 + i) + 'ì¡°',
                    players: [], // ê°œì¸ì „: ì„ ìˆ˜, íŒ€ì „: íŒ€
                    matches: [],
                    standings: [],
                    isTeam: isTeam
                });
            }
            
            // ë°°ì • (ìŠ¤ë„¤ì´í¬ ë°©ì‹ - ê· í˜• ì¡íŒ ë°°ì •)
            shuffled.forEach((participant, idx) => {
                // ìŠ¤ë„¤ì´í¬ ë°©ì‹: 0,1,2,3,3,2,1,0,0,1,2,3...
                const round = Math.floor(idx / groupCount);
                const groupIdx = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                participant.group = String.fromCharCode(65 + groupIdx);
                currentProject.groups[groupIdx].players.push({...participant});
            });
            
            // ì„¤ì • ì €ì¥
            currentProject.groupSettings = {
                groupCount: groupCount,
                advanceCount: advanceCount,
                setsPerMatch: isTeam ? 1 : setsPerMatch // íŒ€ì „ì€ ë‹¨íŒ
            };
            
            saveProjects();
            render();
            announce(`${groupCount}ê°œ ì¡°ì— ${participants.length}${isTeam ? 'íŒ€' : 'ëª…'} ë°°ì • ì™„ë£Œ`);
        }
        
        // ì¡° ì´ˆê¸°í™”
        function clearGroups() {
            if (confirm('ì¡° í¸ì„±ê³¼ ëŒ€ì§„í‘œë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                currentProject.groups = [];
                currentProject.bracket = null;
                if (currentProject.players) {
                    currentProject.players.forEach(p => p.group = null);
                }
                if (currentProject.teams) {
                    currentProject.teams.forEach(t => t.group = null);
                }
                saveProjects();
                render();
            }
        }
        
        // ì¡°ë³„ ë¦¬ê·¸ ëŒ€ì§„ ìƒì„± (IBSA ë¼ìš´ë“œ ë¡œë¹ˆ)
        function generateGroupMatches() {
            if (!currentProject.groups || currentProject.groups.length === 0) {
                alert('ë¨¼ì € ì¡° í¸ì„±ì„ í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const isTeam = currentProject.competitionType === 'team';
            const setsPerMatch = isTeam ? 1 : (currentProject.groupSettings?.setsPerMatch || 3);
            let matchCount = 0;
            
            currentProject.groups.forEach((group, gi) => {
                const participants = group.players;
                group.matches = [];
                group.isTeam = isTeam;
                
                // IBSA ë¼ìš´ë“œ ë¡œë¹ˆ: ëª¨ë“  ì°¸ê°€ìê°€ ì„œë¡œ í•œ ë²ˆì”© ëŒ€ì „
                for (let i = 0; i < participants.length; i++) {
                    for (let j = i + 1; j < participants.length; j++) {
                        const matchId = `G${gi + 1}M${group.matches.length + 1}`;
                        group.matches.push({
                            id: matchId,
                            player1: participants[i].name,
                            player2: participants[j].name,
                            status: 'pending',
                            result: null,
                            sets: setsPerMatch,
                            isTeam: isTeam,
                            // íŒ€ì „ ì¶”ê°€ ì •ë³´
                            winScore: isTeam ? 31 : 11
                        });
                        matchCount++;
                    }
                }
            });
            
            saveProjects();
            const matchType = isTeam ? '(31ì  ë‹¨íŒ)' : `(${setsPerMatch}ì„¸íŠ¸)`;
            alert(`IBSA ë¼ìš´ë“œ ë¡œë¹ˆ ëŒ€ì§„ ìƒì„± ì™„ë£Œ!\nì´ ${matchCount}ê²½ê¸° ${matchType}`);
            render();
        }
        
        // ì„ ìˆ˜/íŒ€ ì¡° ì´ë™
        function movePlayerGroup(groupIdx, playerIdx) {
            const groups = currentProject.groups;
            const participant = groups[groupIdx].players[playerIdx];
            const isTeam = currentProject.competitionType === 'team';
            
            const newGroup = prompt(`${participant.name}${isTeam ? ' íŒ€' : ' ì„ ìˆ˜'}ì„ ì´ë™í•  ì¡°ë¥¼ ì…ë ¥í•˜ì„¸ìš” (A, B, C...):`, String.fromCharCode(65 + groupIdx));
            if (!newGroup) return;
            
            const newGroupIdx = newGroup.toUpperCase().charCodeAt(0) - 65;
            if (newGroupIdx < 0 || newGroupIdx >= groups.length || newGroupIdx === groupIdx) {
                alert('ìœ íš¨í•˜ì§€ ì•Šì€ ì¡°ì…ë‹ˆë‹¤.');
                return;
            }
            
            // ì´ë™
            groups[groupIdx].players.splice(playerIdx, 1);
            player.group = String.fromCharCode(65 + newGroupIdx);
            groups[newGroupIdx].players.push(player);
            
            // ëŒ€ì§„í‘œ ì¬ìƒì„± í•„ìš” ì•Œë¦¼
            if (groups[groupIdx].matches?.length > 0) {
                alert('ì¡° í¸ì„±ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ëŒ€ì§„í‘œë¥¼ ë‹¤ì‹œ ìƒì„±í•´ì£¼ì„¸ìš”.');
                groups[groupIdx].matches = [];
                groups[newGroupIdx].matches = [];
            }
            
            saveProjects();
            render();
        }
        
        // IBSA í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ ìƒì„± (êµì°¨ ëŒ€ì§„)
        function generateBracket() {
            let participants = [];
            const isTeam = currentProject.competitionType === 'team';
            
            // ì¡°ë³„ ë¦¬ê·¸ ì§„ì¶œì ìˆ˜ì§‘
            if (currentProject.groups?.length > 0) {
                const advanceCount = currentProject.groupSettings?.advanceCount || 2;
                currentProject.groups.forEach((group, gi) => {
                    const standings = calculateGroupStandings(group);
                    standings.slice(0, advanceCount).forEach((p, rank) => {
                        participants.push({ 
                            ...p, 
                            fromGroup: String.fromCharCode(65 + gi),
                            groupRank: rank + 1,
                            groupIndex: gi
                        });
                    });
                });
            } else if (currentProject.players?.length > 0) {
                participants = currentProject.players.map((p, i) => ({...p, seed: i + 1}));
            }
            
            if (participants.length < 2) {
                alert('ìµœì†Œ 2ëª…ì˜ ì°¸ê°€ìê°€ í•„ìš”í•©ë‹ˆë‹¤.\nì¡°ë³„ ë¦¬ê·¸ë¥¼ ë¨¼ì € ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // 2ì˜ ê±°ë“­ì œê³±ìœ¼ë¡œ ë§ì¶”ê¸°
            let size = 2;
            while (size < participants.length) size *= 2;
            
            // IBSA êµì°¨ ëŒ€ì§„: ê°™ì€ ì¡° ì„ ìˆ˜ê°€ ê°€ëŠ¥í•œ ëŠ¦ê²Œ ë§Œë‚˜ë„ë¡
            const seeded = ibsaCrossGroupSeeding(participants, size);
            
            // ë¶€ì „ìŠ¹ ì¶”ê°€
            while (seeded.length < size) {
                seeded.push({ name: 'BYE', isBye: true });
            }
            
            // ëŒ€ì§„í‘œ ìƒì„±
            const setsPerMatch = currentProject.tournamentSettings?.setsPerMatch || 5;
            currentProject.bracket = {
                size: size,
                rounds: [],
                currentRound: 0,
                setsPerMatch: setsPerMatch,
                thirdPlaceMatch: currentProject.tournamentSettings?.thirdPlaceMatch !== false
            };
            
            // 1ë¼ìš´ë“œ ìƒì„±
            const round1 = [];
            for (let i = 0; i < size / 2; i++) {
                round1.push({
                    matchId: `R1M${i + 1}`,
                    player1: seeded[i * 2],
                    player2: seeded[i * 2 + 1],
                    winner: null,
                    loser: null,
                    status: 'pending',
                    sets: setsPerMatch
                });
            }
            currentProject.bracket.rounds.push(round1);
            
            // ë¶€ì „ìŠ¹ ìë™ ì²˜ë¦¬
            round1.forEach(match => {
                if (match.player1?.isBye) {
                    match.winner = match.player2;
                    match.loser = match.player1;
                    match.status = 'finished';
                } else if (match.player2?.isBye) {
                    match.winner = match.player1;
                    match.loser = match.player2;
                    match.status = 'finished';
                }
            });
            
            saveProjects();
            render();
            announce(`IBSA í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ ìƒì„± ì™„ë£Œ (${size}ê°•)`);
        }
        
        // IBSA êµì°¨ ëŒ€ì§„ ì•Œê³ ë¦¬ì¦˜
        function ibsaCrossGroupSeeding(participants, bracketSize) {
            const numGroups = Math.max(...participants.map(p => p.groupIndex || 0)) + 1;
            const advancePerGroup = participants.length / numGroups;
            
            // ì¡° 1ìœ„, 2ìœ„, 3ìœ„... ë¶„ë¦¬
            const byRank = {};
            participants.forEach(p => {
                const rank = p.groupRank || 1;
                if (!byRank[rank]) byRank[rank] = [];
                byRank[rank].push(p);
            });
            
            // ê²°ê³¼ ë°°ì—´ (bracketSize í¬ê¸°)
            const seeded = new Array(bracketSize).fill(null);
            
            // ì‹œë“œ ìœ„ì¹˜ ê³„ì‚° (êµì°¨ ë°°ì •)
            // ì˜ˆ: 8ê°• - [1,8,5,4,3,6,7,2] (ê°™ì€ ì¡°ê°€ ê²°ìŠ¹ì—ì„œ ë§Œë‚˜ë„ë¡)
            function getSeedPosition(seed, size) {
                if (size === 2) return seed - 1;
                const half = size / 2;
                if (seed <= half) {
                    return getSeedPosition(seed, half) * 2;
                } else {
                    return getSeedPosition(size - seed + 1, half) * 2 + 1;
                }
            }
            
            // ì¡° 1ìœ„ë“¤ ë°°ì¹˜ (1, 2, 3, 4... ì‹œë“œ)
            const firstPlace = byRank[1] || [];
            firstPlace.sort((a, b) => a.groupIndex - b.groupIndex);
            firstPlace.forEach((p, i) => {
                const seedNum = i + 1;
                const pos = getSeedPosition(seedNum, bracketSize);
                seeded[pos] = p;
            });
            
            // ì¡° 2ìœ„ë“¤ ë°°ì¹˜ (ë‹¤ë¥¸ ì¡° 1ìœ„ì™€ ë§Œë‚˜ë„ë¡ ë°˜ëŒ€í¸)
            const secondPlace = byRank[2] || [];
            secondPlace.sort((a, b) => a.groupIndex - b.groupIndex);
            
            // 2ìœ„ëŠ” ë°˜ëŒ€ ì¡° 1ìœ„ì™€ ë§Œë‚˜ì•¼ í•¨
            // Aì¡°2ìœ„ vs Bì¡°1ìœ„, Bì¡°2ìœ„ vs Aì¡°1ìœ„ (4ì¡°: A2-D1, B2-C1, C2-B1, D2-A1)
            const numFirst = firstPlace.length;
            secondPlace.forEach((p, i) => {
                // ë°˜ëŒ€ ì¡° ì°¾ê¸°
                const oppositeIdx = (numFirst - 1 - i + numFirst) % numFirst;
                const seedNum = numFirst + oppositeIdx + 1;
                const pos = getSeedPosition(seedNum, bracketSize);
                if (seeded[pos] === null) {
                    seeded[pos] = p;
                } else {
                    // ë¹ˆ ìë¦¬ ì°¾ê¸°
                    for (let j = 0; j < seeded.length; j++) {
                        if (seeded[j] === null) { seeded[j] = p; break; }
                    }
                }
            });
            
            // 3ìœ„ ì´í•˜ ë°°ì¹˜
            for (let rank = 3; rank <= Math.max(...Object.keys(byRank).map(Number)); rank++) {
                (byRank[rank] || []).forEach(p => {
                    for (let j = 0; j < seeded.length; j++) {
                        if (seeded[j] === null) { seeded[j] = p; break; }
                    }
                });
            }
            
            return seeded;
        }
        
        // ë…¹ì•„ì›ƒ ê²½ê¸° ìƒì„± (ì‹¤ì œ ê²½ê¸°ë¡œ ë³€í™˜)
        function createKnockoutMatches() {
            const bracket = currentProject.bracket;
            if (!bracket) {
                alert('ë¨¼ì € ëŒ€ì§„í‘œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const currentRound = bracket.rounds[bracket.currentRound];
            const pendingMatches = currentRound.filter(m => m.status === 'pending' && !m.player1?.isBye && !m.player2?.isBye);
            
            if (pendingMatches.length === 0) {
                alert('ìƒì„±í•  ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const setsPerMatch = bracket.setsPerMatch || 5;
            
            pendingMatches.forEach(bMatch => {
                // ì´ë¯¸ ê²½ê¸° ëª©ë¡ì— ìˆëŠ”ì§€ í™•ì¸
                const exists = currentProject.matches?.some(m => 
                    m.player1Name === bMatch.player1.name && 
                    m.player2Name === bMatch.player2.name &&
                    m.status !== 'finished'
                );
                
                if (!exists) {
                    const match = {
                        id: Date.now() + Math.random(),
                        player1Name: bMatch.player1.name,
                        player2Name: bMatch.player2.name,
                        type: 'individual',
                        sets: setsPerMatch,
                        currentSet: 1,
                        setScores: [{player1: 0, player2: 0}],
                        winScore: 11,
                        status: 'active',
                        history: [],
                        timeouts: { player1: 1, player2: 1 },
                        currentServe: 'player1',
                        serveCount: 0,
                        serveSelected: false,
                        mainReferee: '',
                        bracketMatchId: bMatch.matchId,
                        tournamentRound: bracket.currentRound + 1
                    };
                    
                    if (!currentProject.matches) currentProject.matches = [];
                    currentProject.matches.push(match);
                }
            });
            
            saveProjects();
            alert(`${pendingMatches.length}ê°œ ë…¹ì•„ì›ƒ ê²½ê¸°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            render();
        }
        
        // ëŒ€ì§„í‘œ ë·° ë Œë”ë§
        function renderBracketView(bracket) {
            if (!bracket || !bracket.rounds) return '';
            
            let html = '';
            const roundNames = ['1ë¼ìš´ë“œ', '2ë¼ìš´ë“œ', '8ê°•', '4ê°•', 'ê²°ìŠ¹'];
            
            bracket.rounds.forEach((round, ri) => {
                const remaining = bracket.size / Math.pow(2, ri);
                const roundName = remaining <= 4 ? 
                    (remaining === 2 ? 'ê²°ìŠ¹' : remaining === 4 ? '4ê°•' : '8ê°•') : 
                    `${ri + 1}ë¼ìš´ë“œ`;
                
                html += `<div style="margin-bottom:20px;">
                    <h3 style="color:var(--primary); margin-bottom:12px;">${roundName}</h3>`;
                
                round.forEach((match, mi) => {
                    const p1 = match.player1?.name || 'ë¯¸ì •';
                    const p2 = match.player2?.name || 'ë¯¸ì •';
                    const winner = match.winner?.name;
                    
                    html += `
                        <div style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid ${match.status === 'completed' ? 'var(--success)' : 'var(--warning)'};">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="${winner === p1 ? 'font-weight:700; color:var(--success);' : ''}">${p1}</span>
                                <span style="color:var(--text-secondary);">vs</span>
                                <span style="${winner === p2 ? 'font-weight:700; color:var(--success);' : ''}">${p2}</span>
                            </div>
                            ${match.status === 'completed' ? `<div style="text-align:center; margin-top:8px; color:var(--success); font-size:12px;">ğŸ† ìŠ¹ì: ${winner}</div>` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            return html;
        }
        
        // ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰
        function advanceTournament() {
            const bracket = currentProject.bracket;
            if (!bracket) return;
            
            const currentRound = bracket.rounds[bracket.currentRound];
            const allFinished = currentRound.every(m => m.status === 'completed');
            
            if (!allFinished) {
                alert('í˜„ì¬ ë¼ìš´ë“œì˜ ëª¨ë“  ê²½ê¸°ê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ë‹¤ìŒ ë¼ìš´ë“œ ìƒì„±
            if (currentRound.length >= 2) {
                const nextRound = [];
                for (let i = 0; i < currentRound.length / 2; i++) {
                    nextRound.push({
                        player1: currentRound[i * 2].winner,
                        player2: currentRound[i * 2 + 1].winner,
                        winner: null,
                        status: 'pending'
                    });
                }
                bracket.rounds.push(nextRound);
                bracket.currentRound++;
                
                saveProjects();
                render();
                announce('ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰');
            } else {
                alert('í† ë„ˆë¨¼íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }
        
        // ì¡°ë³„ ìˆœìœ„ ê³„ì‚°
        function calculateGroupStandings(group) {
            const playerStats = {};
            
            group.players.forEach(p => {
                playerStats[p.name] = {
                    name: p.name,
                    wins: 0,
                    losses: 0,
                    setWins: 0,
                    setLosses: 0,
                    goalsFor: 0,
                    goalsAgainst: 0
                };
            });
            
            // ì™„ë£Œëœ ê²½ê¸°ì—ì„œ í†µê³„ ìˆ˜ì§‘
            const matches = currentProject.matches?.filter(m => 
                m.status === 'completed' && 
                playerStats[m.player1Name] && playerStats[m.player2Name]
            ) || [];
            
            matches.forEach(m => {
                const p1Stats = playerStats[m.player1Name];
                const p2Stats = playerStats[m.player2Name];
                
                // ì„¸íŠ¸ í†µê³„
                m.setScores.forEach(s => {
                    p1Stats.goalsFor += s.player1;
                    p1Stats.goalsAgainst += s.player2;
                    p2Stats.goalsFor += s.player2;
                    p2Stats.goalsAgainst += s.player1;
                    
                    if (s.player1 > s.player2) {
                        p1Stats.setWins++;
                        p2Stats.setLosses++;
                    } else {
                        p2Stats.setWins++;
                        p1Stats.setLosses++;
                    }
                });
                
                // ìŠ¹/íŒ¨
                const p1SetWins = m.setScores.filter(s => s.player1 > s.player2).length;
                const p2SetWins = m.setScores.filter(s => s.player2 > s.player1).length;
                
                if (p1SetWins > p2SetWins) {
                    p1Stats.wins++;
                    p2Stats.losses++;
                } else {
                    p2Stats.wins++;
                    p1Stats.losses++;
                }
            });
            
            // ìˆœìœ„ ì •ë ¬: ìŠ¹ë¥  â†’ ì„¸íŠ¸ë“ì‹¤ â†’ ê³¨ë“ì‹¤
            return Object.values(playerStats).sort((a, b) => {
                const aWinRate = a.wins / (a.wins + a.losses || 1);
                const bWinRate = b.wins / (b.wins + b.losses || 1);
                if (bWinRate !== aWinRate) return bWinRate - aWinRate;
                
                const aSetDiff = a.setWins - a.setLosses;
                const bSetDiff = b.setWins - b.setLosses;
                if (bSetDiff !== aSetDiff) return bSetDiff - aSetDiff;
                
                const aGoalDiff = a.goalsFor - a.goalsAgainst;
                const bGoalDiff = b.goalsFor - b.goalsAgainst;
                return bGoalDiff - aGoalDiff;
            }).map(p => ({
                ...p,
                setDiff: p.setWins - p.setLosses,
                goalDiff: p.goalsFor - p.goalsAgainst
            }));
        }
        
        // ì „ì²´ ìˆœìœ„ ê³„ì‚°
        function calculateStandings() {
            const result = { groups: {}, final: [] };
            
            if (currentProject.groups) {
                currentProject.groups.forEach((group, gi) => {
                    result.groups[gi] = calculateGroupStandings(group);
                });
            }
            
            // í† ë„ˆë¨¼íŠ¸ ìµœì¢… ìˆœìœ„
            if (currentProject.bracket?.rounds) {
                const lastRound = currentProject.bracket.rounds[currentProject.bracket.rounds.length - 1];
                if (lastRound?.length === 1 && lastRound[0].status === 'completed') {
                    result.final.push(lastRound[0].winner);
                    // ì¤€ìš°ìŠ¹
                    const loser = lastRound[0].player1.name === lastRound[0].winner.name ? 
                        lastRound[0].player2 : lastRound[0].player1;
                    result.final.push(loser);
                }
            }
            
            return result;
        }
        
        // í†µê³„ ê³„ì‚°
        function calculateStatistics() {
            const matches = currentProject.matches || [];
            const stats = {
                totalMatches: matches.length,
                completedMatches: matches.filter(m => m.status === 'completed').length,
                playerStats: []
            };
            
            const playerData = {};
            
            matches.filter(m => m.status === 'completed').forEach(m => {
                [m.player1Name, m.player2Name].forEach((name, idx) => {
                    if (!playerData[name]) {
                        playerData[name] = {
                            name,
                            matches: 0,
                            wins: 0,
                            losses: 0,
                            goalsFor: 0,
                            goalsAgainst: 0
                        };
                    }
                    
                    const p = playerData[name];
                    p.matches++;
                    
                    m.setScores.forEach(s => {
                        if (idx === 0) {
                            p.goalsFor += s.player1;
                            p.goalsAgainst += s.player2;
                        } else {
                            p.goalsFor += s.player2;
                            p.goalsAgainst += s.player1;
                        }
                    });
                    
                    const p1SetWins = m.setScores.filter(s => s.player1 > s.player2).length;
                    const p2SetWins = m.setScores.filter(s => s.player2 > s.player1).length;
                    
                    if (idx === 0) {
                        if (p1SetWins > p2SetWins) p.wins++;
                        else p.losses++;
                    } else {
                        if (p2SetWins > p1SetWins) p.wins++;
                        else p.losses++;
                    }
                });
            });
            
            stats.playerStats = Object.values(playerData)
                .map(p => ({
                    ...p,
                    winRate: p.matches > 0 ? Math.round((p.wins / p.matches) * 100) : 0
                }))
                .sort((a, b) => b.winRate - a.winRate || b.wins - a.wins);
            
            return stats;
        }
        
        // í† ë„ˆë¨¼íŠ¸ ì„¤ì • ì—…ë°ì´íŠ¸
        function updateTournamentSettings() {
            if (!currentProject.tournamentSettings) currentProject.tournamentSettings = {};
            currentProject.tournamentSettings.thirdPlaceMatch = document.getElementById('third-place-edit')?.checked;
            currentProject.tournamentSettings.setsPerMatch = parseInt(document.getElementById('knockout-sets-edit')?.value) || 5;
            saveProjects();
        }
        
        // ========== PDF ì¶œë ¥ í•¨ìˆ˜ ==========
        
        // í•œê¸€ í°íŠ¸ Base64 ë¡œë“œ (ë‚˜ëˆ”ê³ ë”• ê²½ëŸ‰í™” ë²„ì „ ì‚¬ìš©)
        // jsPDFëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í•œê¸€ì„ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, ìœ ë‹ˆì½”ë“œ ë¬¸ìë¥¼ ì˜ì–´ë¡œ ë³€í™˜í•˜ê±°ë‚˜
        // ì™¸ë¶€ í°íŠ¸ë¥¼ ë¡œë“œí•´ì•¼ í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ì²˜ë¦¬í•©ë‹ˆë‹¤.
        
        function initPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // ê¸°ë³¸ í°íŠ¸ ì„¤ì • (í•œê¸€ ë¯¸ì§€ì› ì‹œ ì˜ë¬¸ìœ¼ë¡œ ëŒ€ì²´)
            doc.setFont('helvetica');
            
            return doc;
        }
        
        // ëŒ€íšŒ ê²°ê³¼ ë³´ê³ ì„œ PDF
        function exportTournamentReport() {
            try {
                const doc = initPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = 20;
                
                // ì œëª©
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('IBSA Showdown Tournament Report', pageWidth / 2, y, { align: 'center' });
                y += 10;
                
                // ëŒ€íšŒ ì •ë³´
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text(currentProject.name || 'Tournament', pageWidth / 2, y, { align: 'center' });
                y += 8;
                
                doc.setFontSize(10);
                const dateStr = currentProject.date || new Date().toLocaleDateString();
                const locationStr = currentProject.location || 'Location TBD';
                doc.text(`Date: ${dateStr} | Location: ${locationStr}`, pageWidth / 2, y, { align: 'center' });
                y += 15;
                
                // ëŒ€íšŒ ìœ í˜•
                doc.setFontSize(12);
                const isTeam = currentProject.competitionType === 'team';
                const typeStr = isTeam ? 'Team Competition' : 'Individual Competition';
                const formatStr = currentProject.tournamentType === 'group' ? 'Group Stage' :
                    currentProject.tournamentType === 'tournament' ? 'Tournament' : 'Group + Knockout';
                doc.text(`Type: ${typeStr} | Format: ${formatStr}`, 20, y);
                y += 10;
                
                // ì°¸ê°€ì ìˆ˜
                const participantCount = isTeam ? 
                    (currentProject.teams?.length || 0) : 
                    (currentProject.players?.length || 0);
                doc.text(`Participants: ${participantCount} ${isTeam ? 'teams' : 'players'}`, 20, y);
                y += 15;
                
                // êµ¬ë¶„ì„ 
                doc.setLineWidth(0.5);
                doc.line(20, y, pageWidth - 20, y);
                y += 10;
                
                // ìµœì¢… ìˆœìœ„
                if (currentProject.standings?.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Final Standings', 20, y);
                    y += 8;
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    const medals = ['1st (Gold)', '2nd (Silver)', '3rd (Bronze)', '4th'];
                    currentProject.standings.slice(0, 4).forEach((p, i) => {
                        doc.text(`${medals[i]}: ${p.name}`, 30, y);
                        y += 6;
                    });
                    y += 10;
                }
                
                // ì¡°ë³„ ë¦¬ê·¸ ìš”ì•½
                if (currentProject.groups?.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Group Stage Summary', 20, y);
                    y += 8;
                    
                    currentProject.groups.forEach((group, gi) => {
                        if (y > pageHeight - 40) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`Group ${String.fromCharCode(65 + gi)}`, 25, y);
                        y += 6;
                        
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(9);
                        
                        const standings = calculateGroupStandings(group);
                        standings.forEach((p, pi) => {
                            const advanceCount = currentProject.groupSettings?.advanceCount || 2;
                            const prefix = pi < advanceCount ? '* ' : '  ';
                            doc.text(`${prefix}${pi + 1}. ${p.name} (W:${p.wins} L:${p.losses})`, 30, y);
                            y += 5;
                        });
                        y += 5;
                    });
                }
                
                // í†µê³„
                const stats = calculateStatistics();
                if (stats.totalMatches > 0) {
                    if (y > pageHeight - 50) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Statistics', 20, y);
                    y += 8;
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Total Matches: ${stats.totalMatches}`, 25, y); y += 5;
                    doc.text(`Completed: ${stats.completedMatches}`, 25, y); y += 5;
                }
                
                // í‘¸í„°
                doc.setFontSize(8);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 20, pageHeight - 10);
                doc.text('IBSA Showdown Referee App', pageWidth - 20, pageHeight - 10, { align: 'right' });
                
                // ì €ì¥
                const filename = `${currentProject.name || 'tournament'}_report_${Date.now()}.pdf`;
                doc.save(filename);
                announce('PDF saved: ' + filename);
                
            } catch (error) {
                console.error('PDF export error:', error);
                alert('PDF export failed. Please try again.');
            }
        }
        
        // ì¡°ë³„ ë¦¬ê·¸ ê¸°ë¡ PDF
        function exportGroupStageReport() {
            try {
                if (!currentProject.groups || currentProject.groups.length === 0) {
                    alert('No group stage data available.');
                    return;
                }
                
                const doc = initPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = 20;
                
                // ì œëª©
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('Group Stage Record', pageWidth / 2, y, { align: 'center' });
                y += 8;
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(currentProject.name || 'Tournament', pageWidth / 2, y, { align: 'center' });
                y += 15;
                
                // ê° ì¡°ë³„ ìƒì„¸
                currentProject.groups.forEach((group, gi) => {
                    if (y > pageHeight - 80) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    // ì¡° í—¤ë”
                    doc.setFillColor(230, 230, 230);
                    doc.rect(20, y - 4, pageWidth - 40, 10, 'F');
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Group ${String.fromCharCode(65 + gi)}`, 25, y + 3);
                    y += 15;
                    
                    // ìˆœìœ„í‘œ
                    const standings = calculateGroupStandings(group);
                    const advanceCount = currentProject.groupSettings?.advanceCount || 2;
                    
                    // í…Œì´ë¸” í—¤ë”
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Rank', 25, y);
                    doc.text('Name', 45, y);
                    doc.text('W', 100, y);
                    doc.text('L', 115, y);
                    doc.text('Sets', 130, y);
                    doc.text('Diff', 155, y);
                    y += 2;
                    doc.line(20, y, pageWidth - 20, y);
                    y += 5;
                    
                    // í…Œì´ë¸” ë‚´ìš©
                    doc.setFont('helvetica', 'normal');
                    standings.forEach((p, pi) => {
                        const qualified = pi < advanceCount ? 'Q' : '';
                        doc.text(`${pi + 1} ${qualified}`, 25, y);
                        doc.text(p.name.substring(0, 15), 45, y);
                        doc.text(String(p.wins), 100, y);
                        doc.text(String(p.losses), 115, y);
                        doc.text(`+${p.setWins}/-${p.setLosses}`, 130, y);
                        doc.text(`+${p.goalsFor}/-${p.goalsAgainst}`, 155, y);
                        y += 5;
                    });
                    y += 5;
                    
                    // ê²½ê¸° ê²°ê³¼
                    if (group.matches?.length > 0) {
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Match Results:', 25, y);
                        y += 5;
                        
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'normal');
                        group.matches.forEach((m, mi) => {
                            if (y > pageHeight - 20) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            let resultStr = `${m.player1} vs ${m.player2}`;
                            if (m.status === 'completed' && m.result) {
                                const winner = m.result.winner;
                                const score = m.result.score1 ? 
                                    `${m.result.score1}:${m.result.score2}` : 
                                    `${m.result.player1Sets || 0}:${m.result.player2Sets || 0}`;
                                resultStr += ` - Winner: ${winner} (${score})`;
                            } else {
                                resultStr += ' - Pending';
                            }
                            doc.text(resultStr, 30, y);
                            y += 4;
                        });
                    }
                    y += 10;
                });
                
                // í‘¸í„°
                doc.setFontSize(8);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 20, pageHeight - 10);
                
                const filename = `${currentProject.name || 'tournament'}_groups_${Date.now()}.pdf`;
                doc.save(filename);
                announce('PDF saved: ' + filename);
                
            } catch (error) {
                console.error('PDF export error:', error);
                alert('PDF export failed.');
            }
        }
        
        // ê²½ê¸° ê¸°ë¡ì§€ PDF
        function exportMatchRecords() {
            try {
                const matches = currentProject.matches || [];
                if (matches.length === 0) {
                    alert('No match records available.');
                    return;
                }
                
                const doc = initPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                
                matches.forEach((match, mi) => {
                    if (mi > 0) doc.addPage();
                    let y = 20;
                    
                    // ê²½ê¸° í—¤ë”
                    doc.setFillColor(50, 50, 50);
                    doc.rect(0, 0, pageWidth, 35, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('IBSA SHOWDOWN', pageWidth / 2, 12, { align: 'center' });
                    doc.setFontSize(12);
                    doc.text('Match Record Sheet', pageWidth / 2, 22, { align: 'center' });
                    doc.setFontSize(9);
                    doc.text(`Match #${mi + 1}`, pageWidth / 2, 30, { align: 'center' });
                    
                    doc.setTextColor(0, 0, 0);
                    y = 45;
                    
                    // ëŒ€íšŒ ì •ë³´
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Tournament: ${currentProject.name || 'N/A'}`, 20, y);
                    doc.text(`Date: ${currentProject.date || new Date().toLocaleDateString()}`, 120, y);
                    y += 6;
                    doc.text(`Location: ${currentProject.location || 'N/A'}`, 20, y);
                    doc.text(`Referee: ${match.mainReferee || 'N/A'}`, 120, y);
                    y += 15;
                    
                    // ì„ ìˆ˜ ì •ë³´ ë°•ìŠ¤
                    const boxWidth = (pageWidth - 50) / 2;
                    
                    // Player 1
                    doc.setFillColor(230, 240, 255);
                    doc.rect(20, y, boxWidth, 25, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(11);
                    doc.text('Player 1', 20 + boxWidth/2, y + 8, { align: 'center' });
                    doc.setFontSize(14);
                    doc.text(match.player1Name || 'Unknown', 20 + boxWidth/2, y + 18, { align: 'center' });
                    
                    // VS
                    doc.setFontSize(12);
                    doc.text('VS', pageWidth/2, y + 13, { align: 'center' });
                    
                    // Player 2
                    doc.setFillColor(255, 235, 235);
                    doc.rect(30 + boxWidth, y, boxWidth, 25, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(11);
                    doc.text('Player 2', 30 + boxWidth + boxWidth/2, y + 8, { align: 'center' });
                    doc.setFontSize(14);
                    doc.text(match.player2Name || 'Unknown', 30 + boxWidth + boxWidth/2, y + 18, { align: 'center' });
                    
                    y += 35;
                    
                    // ì„¸íŠ¸ë³„ ì ìˆ˜
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Set Scores', 20, y);
                    y += 8;
                    
                    // ì„¸íŠ¸ í…Œì´ë¸”
                    const setScores = match.setScores || [];
                    const colWidth = 30;
                    const startX = 40;
                    
                    // í—¤ë”
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('', startX - 15, y);
                    for (let i = 0; i < (match.sets || 3); i++) {
                        doc.text(`Set ${i + 1}`, startX + i * colWidth, y, { align: 'center' });
                    }
                    doc.text('Total', startX + (match.sets || 3) * colWidth + 10, y, { align: 'center' });
                    y += 2;
                    doc.line(20, y, pageWidth - 20, y);
                    y += 6;
                    
                    // Player 1 ì ìˆ˜
                    doc.setFont('helvetica', 'normal');
                    doc.text(match.player1Name?.substring(0, 8) || 'P1', 20, y);
                    let p1Total = 0;
                    for (let i = 0; i < (match.sets || 3); i++) {
                        const score = setScores[i]?.player1 ?? '-';
                        if (typeof score === 'number') p1Total += score;
                        doc.text(String(score), startX + i * colWidth, y, { align: 'center' });
                    }
                    doc.text(String(p1Total), startX + (match.sets || 3) * colWidth + 10, y, { align: 'center' });
                    y += 6;
                    
                    // Player 2 ì ìˆ˜
                    doc.text(match.player2Name?.substring(0, 8) || 'P2', 20, y);
                    let p2Total = 0;
                    for (let i = 0; i < (match.sets || 3); i++) {
                        const score = setScores[i]?.player2 ?? '-';
                        if (typeof score === 'number') p2Total += score;
                        doc.text(String(score), startX + i * colWidth, y, { align: 'center' });
                    }
                    doc.text(String(p2Total), startX + (match.sets || 3) * colWidth + 10, y, { align: 'center' });
                    y += 15;
                    
                    // ìŠ¹ì
                    if (match.status === 'completed' && match.winner) {
                        doc.setFillColor(255, 215, 0);
                        doc.rect(60, y, pageWidth - 120, 12, 'F');
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`WINNER: ${match.winner}`, pageWidth / 2, y + 8, { align: 'center' });
                        y += 20;
                    }
                    
                    // íŒŒìš¸ ê¸°ë¡
                    y += 5;
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Foul Record', 20, y);
                    y += 8;
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    
                    const p1Fouls = match.fouls?.filter(f => f.player === 1) || [];
                    const p2Fouls = match.fouls?.filter(f => f.player === 2) || [];
                    
                    doc.text(`${match.player1Name || 'P1'}: ${p1Fouls.length} fouls`, 25, y);
                    if (p1Fouls.length > 0) {
                        const foulTypes = p1Fouls.map(f => f.type).join(', ');
                        doc.text(foulTypes.substring(0, 60), 30, y + 5);
                    }
                    y += 12;
                    
                    doc.text(`${match.player2Name || 'P2'}: ${p2Fouls.length} fouls`, 25, y);
                    if (p2Fouls.length > 0) {
                        const foulTypes = p2Fouls.map(f => f.type).join(', ');
                        doc.text(foulTypes.substring(0, 60), 30, y + 5);
                    }
                    y += 20;
                    
                    // ì„œëª…ë€
                    doc.line(20, pageHeight - 35, 80, pageHeight - 35);
                    doc.line(pageWidth - 80, pageHeight - 35, pageWidth - 20, pageHeight - 35);
                    doc.setFontSize(8);
                    doc.text('Referee Signature', 50, pageHeight - 30, { align: 'center' });
                    doc.text('Official Signature', pageWidth - 50, pageHeight - 30, { align: 'center' });
                    
                    // í‘¸í„°
                    doc.text(`Page ${mi + 1} of ${matches.length}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                });
                
                const filename = `${currentProject.name || 'tournament'}_matches_${Date.now()}.pdf`;
                doc.save(filename);
                announce('PDF saved: ' + filename);
                
            } catch (error) {
                console.error('PDF export error:', error);
                alert('PDF export failed.');
            }
        }
        
        // ========== ìë™ ëŒ€íšŒ ì§„í–‰ í•¨ìˆ˜ ==========
        
        const KOREAN_SURNAMES = ['ê¹€', 'ì´', 'ë°•', 'ìµœ', 'ì •', 'ê°•', 'ì¡°', 'ìœ¤', 'ì¥', 'ì„', 'í•œ', 'ì˜¤', 'ì„œ', 'ì‹ ', 'ê¶Œ', 'í™©', 'ì•ˆ', 'ì†¡', 'ë¥˜', 'í™'];
        const KOREAN_NAMES_MALE = ['ë¯¼ìˆ˜', 'ì¤€í˜¸', 'ì„±ë¯¼', 'ë™í˜„', 'ìŠ¹ìš°', 'í˜„ìš°', 'ì§€í›ˆ', 'íƒœí›ˆ', 'ìŠ¹í˜„', 'ì •ìš°', 'í˜„ì¤€', 'ë„ìœ¤', 'ì‹œìš°', 'ì£¼ì›', 'ì˜ˆì¤€'];
        const KOREAN_NAMES_FEMALE = ['ì˜í¬', 'ìˆ˜ì§„', 'ì§€ì›', 'ë¯¸ë€', 'ë‚˜ì˜', 'ìœ ì§„', 'ì„œì—°', 'ë¯¼ì§€', 'í•˜ì€', 'ì§€ìœ ', 'ì„œí˜„', 'ìˆ˜ë¹ˆ', 'ì˜ˆì§„', 'ë‹¤ì€', 'ì±„ì›'];
        const TEAM_CITIES = ['ì„œìš¸', 'ë¶€ì‚°', 'ëŒ€êµ¬', 'ì¸ì²œ', 'ê´‘ì£¼', 'ëŒ€ì „', 'ìš¸ì‚°', 'ì„¸ì¢…', 'ìˆ˜ì›', 'ê³ ì–‘', 'ìš©ì¸', 'ì°½ì›', 'ì„±ë‚¨', 'ì²­ì£¼', 'ì „ì£¼', 'ì²œì•ˆ'];
        
        function generateRandomName(gender) {
            const surname = KOREAN_SURNAMES[Math.floor(Math.random() * KOREAN_SURNAMES.length)];
            const names = gender === 'male' ? KOREAN_NAMES_MALE : KOREAN_NAMES_FEMALE;
            const name = names[Math.floor(Math.random() * names.length)];
            return surname + name;
        }
        
        function autoSimulateMatch(p1, p2, isTeam, sets = 3) {
            const history = [];
            
            if (isTeam) {
                // íŒ€ì „: 31ì  2ì ì°¨
                let s1 = 0, s2 = 0;
                while (true) {
                    const prevS1 = s1, prevS2 = s2;
                    const points = Math.random() < 0.3 ? 2 : 1;
                    const isP1Score = Math.random() < 0.5;
                    
                    if (isP1Score) {
                        s1 += points;
                        history.push({
                            player: p1,
                            type: 'goal',
                            points: points,
                            scoreBefore: `${prevS1}:${prevS2}`,
                            scoreAfter: `${s1}:${s2}`
                        });
                    } else {
                        s2 += points;
                        history.push({
                            player: p2,
                            type: 'goal',
                            points: points,
                            scoreBefore: `${prevS1}:${prevS2}`,
                            scoreAfter: `${s1}:${s2}`
                        });
                    }
                    
                    if (s1 >= 31 && s1 - s2 >= 2) return { winner: p1, loser: p2, score: `${s1}:${s2}`, s1, s2, setScores: [{s1, s2}], history };
                    if (s2 >= 31 && s2 - s1 >= 2) return { winner: p2, loser: p1, score: `${s2}:${s1}`, s1: s2, s2: s1, setScores: [{s1: s2, s2: s1}], history };
                    if (s1 > 40 || s2 > 40) {
                        return s1 > s2 ? 
                            { winner: p1, loser: p2, score: `${s1}:${s2}`, s1, s2, setScores: [{s1, s2}], history } : 
                            { winner: p2, loser: p1, score: `${s2}:${s1}`, s1: s2, s2: s1, setScores: [{s1: s2, s2: s1}], history };
                    }
                }
            } else {
                // ê°œì¸ì „: Nì„¸íŠ¸ (sets íŒŒë¼ë¯¸í„° ì‚¬ìš©)
                const winsNeeded = Math.ceil(sets / 2);
                let sets1 = 0, sets2 = 0;
                const setScores = [];
                let totalP1 = 0, totalP2 = 0;
                
                while (sets1 < winsNeeded && sets2 < winsNeeded) {
                    let s1 = 0, s2 = 0;
                    const setNum = setScores.length + 1;
                    
                    // ì„¸íŠ¸ ì§„í–‰ ì‹œë®¬ë ˆì´ì…˜
                    while (true) {
                        const prevS1 = s1, prevS2 = s2;
                        const isP1Score = Math.random() < 0.5;
                        
                        if (isP1Score) {
                            s1++;
                            history.push({
                                player: p1,
                                type: 'goal',
                                points: 1,
                                set: setNum,
                                scoreBefore: `${prevS1}:${prevS2}`,
                                scoreAfter: `${s1}:${s2}`
                            });
                        } else {
                            s2++;
                            history.push({
                                player: p2,
                                type: 'goal',
                                points: 1,
                                set: setNum,
                                scoreBefore: `${prevS1}:${prevS2}`,
                                scoreAfter: `${s1}:${s2}`
                            });
                        }
                        
                        // ì„¸íŠ¸ ì¢…ë£Œ ì¡°ê±´: 11ì  ì´ìƒ, 2ì ì°¨
                        if (s1 >= 11 && s1 - s2 >= 2) break;
                        if (s2 >= 11 && s2 - s1 >= 2) break;
                        // ë“€ìŠ¤ ìƒí•œ (ì•ˆì „ì¥ì¹˜)
                        if (s1 >= 15 && s1 > s2) break;
                        if (s2 >= 15 && s2 > s1) break;
                    }
                    
                    setScores.push({ s1, s2 });
                    totalP1 += s1; totalP2 += s2;
                    if (s1 > s2) sets1++; else sets2++;
                }
                const winner = sets1 > sets2 ? p1 : p2;
                return { 
                    winner, 
                    loser: winner === p1 ? p2 : p1, 
                    score: `${sets1}:${sets2}`, 
                    sets1, sets2, 
                    setScores,
                    totalP1, totalP2,
                    history
                };
            }
        }
        
        function runAutoTournament() {
            const isTeam = currentProject.competitionType === 'team';
            const count = parseInt(document.getElementById('auto-participant-count').value);
            const groupCount = parseInt(document.getElementById('auto-group-count').value);
            const advanceCount = parseInt(document.getElementById('auto-advance-count').value);
            const thirdPlace = document.getElementById('auto-third-place').value === 'yes';
            const fiveSetStart = !isTeam ? (document.getElementById('auto-5set-start')?.value || 'quarter') : null;
            const rankingType = document.getElementById('auto-ranking-type').value;
            
            // íƒ‘ì‹œë“œ ìˆ˜ì§‘
            const topSeeds = [];
            for (let i = 0; i < groupCount; i++) {
                const seedInput = document.getElementById(`seed-${String.fromCharCode(65 + i)}`);
                const seedName = seedInput?.value?.trim();
                topSeeds.push(seedName || null);
            }
            
            // ë¼ìš´ë“œë³„ ì„¸íŠ¸ ìˆ˜ ê²°ì • í•¨ìˆ˜
            function getSetsForRound(round) {
                if (isTeam) return 1;
                if (round === 'group') return 3;
                
                const roundOrder = { 'r16': 1, 'quarter': 2, 'semi': 3, 'final': 4 };
                const startOrder = { 'r16': 1, 'quarter': 2, 'semi': 3, 'final': 4, 'all': 1 };
                
                if (fiveSetStart === 'all') return 5;
                return roundOrder[round] >= startOrder[fiveSetStart] ? 5 : 3;
            }
            
            const result = {
                settings: { count, groupCount, advanceCount, thirdPlace, isTeam, fiveSetStart, rankingType, topSeeds },
                participants: [],
                groups: [],
                groupMatches: [],
                groupStandings: [],
                knockoutRounds: [],
                playerRecords: {}, // ê°œì¸ë³„ ìƒì„¸ ê¸°ë¡
                finalStandings: []
            };
            
            // 1. ì°¸ê°€ì ìƒì„± (íƒ‘ì‹œë“œ ìš°ì„ )
            const usedNames = [];
            const extendedCities = [...TEAM_CITIES, 'ì¶˜ì²œ', 'ì›ì£¼', 'ì œì£¼', 'í¬í•­', 'ê¹€í•´', 'ë‚¨ì–‘ì£¼', 'í™”ì„±', 'í‰íƒ', 'ì˜ì •ë¶€', 'ì‹œí¥', 'íŒŒì£¼', 'ê´‘ëª…', 'ê¹€í¬', 'êµ°í¬', 'ì˜¤ì‚°', 'ì´ì²œ'];
            
            // íƒ‘ì‹œë“œ ë¨¼ì € ì¶”ê°€
            topSeeds.forEach(name => {
                if (name) usedNames.push(name);
            });
            
            for (let i = 0; i < count; i++) {
                let name;
                
                // ì¡°ë³„ íƒ‘ì‹œë“œ ìœ„ì¹˜ í™•ì¸ (ê° ì¡°ë‹¹ ì²« ë²ˆì§¸)
                const perGroup = Math.ceil(count / groupCount);
                const groupIdx = Math.floor(i / perGroup);
                const posInGroup = i % perGroup;
                
                // íƒ‘ì‹œë“œì¸ ê²½ìš°
                if (posInGroup === 0 && topSeeds[groupIdx]) {
                    name = topSeeds[groupIdx];
                } else {
                    // ìë™ ìƒì„±
                    if (isTeam) {
                        do { name = extendedCities[Math.floor(Math.random() * extendedCities.length)]; }
                        while (usedNames.includes(name));
                    } else {
                        do { name = generateRandomName(Math.random() < 0.5 ? 'male' : 'female'); }
                        while (usedNames.includes(name));
                    }
                    usedNames.push(name);
                }
                
                if (isTeam) {
                    const members = [];
                    const mc = Math.random() < 0.5 ? 2 : 1;
                    for (let j = 0; j < mc; j++) members.push({ name: generateRandomName('male'), gender: 'M' });
                    for (let j = 0; j < 3 - mc; j++) members.push({ name: generateRandomName('female'), gender: 'F' });
                    result.participants.push({ name, members });
                } else {
                    result.participants.push({ name });
                }
                
                // ê°œì¸ ê¸°ë¡ ì´ˆê¸°í™”
                result.playerRecords[result.participants[i].name] = {
                    name: result.participants[i].name,
                    matches: [],
                    totalWins: 0, totalLosses: 0,
                    setWins: 0, setLosses: 0,
                    pointsFor: 0, pointsAgainst: 0,
                    group: null, groupRank: null,
                    knockoutRound: null, finalRank: null
                };
            }
            
            // 2. ì¡° í¸ì„± (ìŠ¤ë„¤ì´í¬ ë°©ì‹)
            const shuffled = [...result.participants].sort(() => Math.random() - 0.5);
            for (let i = 0; i < groupCount; i++) {
                result.groups.push({ name: String.fromCharCode(65 + i) + 'ì¡°', players: [] });
            }
            shuffled.forEach((p, idx) => {
                const round = Math.floor(idx / groupCount);
                const gi = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                result.groups[gi].players.push(p.name);
                result.playerRecords[p.name].group = String.fromCharCode(65 + gi) + 'ì¡°';
            });
            
            // 3. ì¡°ë³„ ë¦¬ê·¸ ì§„í–‰
            result.groups.forEach((group, gi) => {
                const stats = {};
                group.players.forEach(p => { 
                    stats[p] = { wins: 0, losses: 0, pf: 0, pa: 0, sw: 0, sl: 0 }; 
                });
                
                const matches = [];
                for (let i = 0; i < group.players.length; i++) {
                    for (let j = i + 1; j < group.players.length; j++) {
                        const p1 = group.players[i], p2 = group.players[j];
                        const m = autoSimulateMatch(p1, p2, isTeam, getSetsForRound('group'));
                        
                        const matchRecord = {
                            stage: 'ì¡°ë³„ë¦¬ê·¸',
                            group: group.name,
                            opponent: null,
                            result: null,
                            score: m.score,
                            setScores: m.setScores,
                            history: m.history || [],
                            setsWon: isTeam ? (m.winner === p1 ? 1 : 0) : m.sets1,
                            setsLost: isTeam ? (m.winner === p1 ? 0 : 1) : m.sets2
                        };
                        
                        // P1 ê¸°ë¡
                        const p1Record = { ...matchRecord, opponent: p2, result: m.winner === p1 ? 'ìŠ¹' : 'íŒ¨' };
                        result.playerRecords[p1].matches.push(p1Record);
                        
                        // P2 ê¸°ë¡
                        const p2Record = { 
                            ...matchRecord, 
                            opponent: p1, 
                            result: m.winner === p2 ? 'ìŠ¹' : 'íŒ¨',
                            setsWon: isTeam ? (m.winner === p2 ? 1 : 0) : m.sets2,
                            setsLost: isTeam ? (m.winner === p2 ? 0 : 1) : m.sets1
                        };
                        result.playerRecords[p2].matches.push(p2Record);
                        
                        matches.push({ p1, p2, winner: m.winner, score: m.score, setScores: m.setScores, history: m.history || [] });
                        
                        stats[m.winner].wins++;
                        stats[m.loser].losses++;
                        
                        if (isTeam) {
                            stats[p1].pf += m.s1; stats[p1].pa += m.s2;
                            stats[p2].pf += m.s2; stats[p2].pa += m.s1;
                            result.playerRecords[p1].pointsFor += m.s1;
                            result.playerRecords[p1].pointsAgainst += m.s2;
                            result.playerRecords[p2].pointsFor += m.s2;
                            result.playerRecords[p2].pointsAgainst += m.s1;
                        } else {
                            stats[p1].sw += m.sets1; stats[p1].sl += m.sets2;
                            stats[p2].sw += m.sets2; stats[p2].sl += m.sets1;
                            result.playerRecords[p1].setWins += m.sets1;
                            result.playerRecords[p1].setLosses += m.sets2;
                            result.playerRecords[p2].setWins += m.sets2;
                            result.playerRecords[p2].setLosses += m.sets1;
                            // ë“ì ë„ ê¸°ë¡
                            result.playerRecords[p1].pointsFor += m.totalP1;
                            result.playerRecords[p1].pointsAgainst += m.totalP2;
                            result.playerRecords[p2].pointsFor += m.totalP2;
                            result.playerRecords[p2].pointsAgainst += m.totalP1;
                        }
                    }
                }
                result.groupMatches.push({ group: group.name, matches });
                
                // ìˆœìœ„ ì •ë ¬
                const sorted = [...group.players].sort((a, b) => {
                    if (stats[b].wins !== stats[a].wins) return stats[b].wins - stats[a].wins;
                    if (isTeam) return (stats[b].pf - stats[b].pa) - (stats[a].pf - stats[a].pa);
                    const setDiffB = stats[b].sw - stats[b].sl;
                    const setDiffA = stats[a].sw - stats[a].sl;
                    if (setDiffB !== setDiffA) return setDiffB - setDiffA;
                    return (stats[b].pf - stats[b].pa) - (stats[a].pf - stats[a].pa);
                });
                
                result.groupStandings.push({
                    group: group.name,
                    standings: sorted.map((p, idx) => {
                        result.playerRecords[p].groupRank = idx + 1;
                        result.playerRecords[p].totalWins = stats[p].wins;
                        result.playerRecords[p].totalLosses = stats[p].losses;
                        return {
                            rank: idx + 1, name: p, ...stats[p],
                            qualified: idx < advanceCount
                        };
                    })
                });
            });
            
            // 4. ë³¸ì„  ì§„ì¶œì ìˆ˜ì§‘
            const qualifiers = [];
            result.groupStandings.forEach(g => {
                g.standings.filter(p => p.qualified).forEach(p => {
                    qualifiers.push({ 
                        name: p.name, 
                        group: g.group, 
                        rank: p.rank,
                        stats: p
                    });
                    result.playerRecords[p.name].knockoutRound = 'ë³¸ì„ ì§„ì¶œ';
                });
            });
            
            // 5. ê²°ì„  í† ë„ˆë¨¼íŠ¸
            if (qualifiers.length >= 2) {
                // í† ë„ˆë¨¼íŠ¸ í¬ê¸° ê²°ì • (2ì˜ ê±°ë“­ì œê³±ìœ¼ë¡œ)
                let bracketSize = 2;
                while (bracketSize < qualifiers.length) bracketSize *= 2;
                
                // ì‹œë“œ ë°°ì • (ì¡° 1ìœ„ ìš°ì„ , êµì°¨ ë°°ì •)
                const seeded = [];
                const maxRank = Math.max(...qualifiers.map(q => q.rank));
                for (let r = 1; r <= maxRank; r++) {
                    const sameRank = qualifiers.filter(q => q.rank === r)
                        .sort((a, b) => a.group.localeCompare(b.group));
                    seeded.push(...sameRank);
                }
                
                // ë¶€ì „ìŠ¹ ì¶”ê°€
                while (seeded.length < bracketSize) {
                    seeded.push({ name: 'BYE', group: '-', rank: 99 });
                }
                
                // ëŒ€ì§„í‘œ ìƒì„± (ì‹œë“œ ë°°ì •)
                const bracket = [];
                for (let i = 0; i < bracketSize / 2; i++) {
                    bracket.push([seeded[i], seeded[bracketSize - 1 - i]]);
                }
                
                // ë¼ìš´ë“œ ì´ë¦„ ê²°ì •
                function getRoundName(remaining) {
                    if (remaining === 2) return 'ê²°ìŠ¹';
                    if (remaining === 4) return 'ì¤€ê²°ìŠ¹';
                    if (remaining === 8) return '8ê°•';
                    if (remaining === 16) return '16ê°•';
                    if (remaining === 32) return '32ê°•';
                    return `${remaining}ê°•`;
                }
                
                function getRoundCode(remaining) {
                    if (remaining === 2) return 'final';
                    if (remaining === 4) return 'semi';
                    if (remaining === 8) return 'quarter';
                    if (remaining === 16) return 'r16';
                    return 'r32';
                }
                
                // ê° ë¼ìš´ë“œ ì§„í–‰
                let currentBracket = bracket;
                let losers = []; // íŒ¨ìë“¤ ì €ì¥ (ì „ì²´ ìˆœìœ„ìš©)
                
                while (currentBracket.length >= 1) {
                    const remaining = currentBracket.length * 2;
                    const roundName = getRoundName(remaining);
                    const roundCode = getRoundCode(remaining);
                    const setsForRound = getSetsForRound(roundCode);
                    const roundMatches = [];
                    const nextBracket = [];
                    const roundLosers = [];
                    
                    for (const match of currentBracket) {
                        const p1 = match[0];
                        const p2 = match[1];
                        
                        // ë¶€ì „ìŠ¹ ì²˜ë¦¬
                        if (p2.name === 'BYE') {
                            nextBracket.push([p1, null]);
                            continue;
                        }
                        if (p1.name === 'BYE') {
                            nextBracket.push([p2, null]);
                            continue;
                        }
                        
                        const m = autoSimulateMatch(p1.name, p2.name, isTeam, setsForRound);
                        
                        roundMatches.push({
                            p1: p1.name, p2: p2.name,
                            winner: m.winner, loser: m.loser,
                            score: m.score, setScores: m.setScores,
                            history: m.history || [],
                            sets: setsForRound
                        });
                        
                        // ê°œì¸ ê¸°ë¡ ì—…ë°ì´íŠ¸
                        [p1.name, p2.name].forEach(pName => {
                            const isWinner = m.winner === pName;
                            const opponent = isWinner ? m.loser : m.winner;
                            result.playerRecords[pName].matches.push({
                                stage: roundName,
                                opponent,
                                result: isWinner ? 'ìŠ¹' : 'íŒ¨',
                                score: m.score,
                                setScores: m.setScores,
                                history: m.history || []
                            });
                            result.playerRecords[pName].totalWins += isWinner ? 1 : 0;
                            result.playerRecords[pName].totalLosses += isWinner ? 0 : 1;
                            if (!isTeam) {
                                result.playerRecords[pName].setWins += isWinner ? m.sets1 : m.sets2;
                                result.playerRecords[pName].setLosses += isWinner ? m.sets2 : m.sets1;
                            }
                            result.playerRecords[pName].knockoutRound = roundName;
                        });
                        
                        const winner = m.winner === p1.name ? p1 : p2;
                        const loser = m.winner === p1.name ? p2 : p1;
                        nextBracket.push([winner, null]);
                        roundLosers.push({ ...loser, eliminatedAt: roundName });
                    }
                    
                    if (roundMatches.length > 0) {
                        result.knockoutRounds.push({ round: roundName, sets: setsForRound, matches: roundMatches });
                    }
                    
                    losers.push(...roundLosers);
                    
                    // ê²°ìŠ¹ì´ë©´ ì¢…ë£Œ
                    if (currentBracket.length === 1) break;
                    
                    // ë‹¤ìŒ ë¼ìš´ë“œ ëŒ€ì§„ êµ¬ì„±
                    currentBracket = [];
                    for (let i = 0; i < nextBracket.length; i += 2) {
                        if (nextBracket[i + 1]) {
                            currentBracket.push([nextBracket[i][0], nextBracket[i + 1][0]]);
                        } else if (nextBracket[i]) {
                            currentBracket.push([nextBracket[i][0], { name: 'BYE' }]);
                        }
                    }
                }
                
                // 3/4ìœ„ì „
                if (thirdPlace && losers.length >= 2) {
                    const semiLosers = losers.filter(l => l.eliminatedAt === 'ì¤€ê²°ìŠ¹');
                    if (semiLosers.length === 2) {
                        const m = autoSimulateMatch(semiLosers[0].name, semiLosers[1].name, isTeam, getSetsForRound('semi'));
                        result.knockoutRounds.push({
                            round: '3/4ìœ„ì „',
                            sets: getSetsForRound('semi'),
                            matches: [{
                                p1: semiLosers[0].name, p2: semiLosers[1].name,
                                winner: m.winner, loser: m.loser,
                                score: m.score, setScores: m.setScores,
                                history: m.history || []
                            }]
                        });
                        
                        // ê¸°ë¡ ì—…ë°ì´íŠ¸
                        result.playerRecords[m.winner].finalRank = 3;
                        result.playerRecords[m.loser].finalRank = 4;
                    }
                }
                
                // ìµœì¢… ìˆœìœ„ ê²°ì •
                const finalRound = result.knockoutRounds.find(r => r.round === 'ê²°ìŠ¹');
                if (finalRound && finalRound.matches.length > 0) {
                    const finalMatch = finalRound.matches[0];
                    result.playerRecords[finalMatch.winner].finalRank = 1;
                    result.playerRecords[finalMatch.loser].finalRank = 2;
                }
            }
            
            // 6. ì „ì²´ ìˆœìœ„ ì‚°ì¶œ
            const allPlayers = Object.values(result.playerRecords);
            
            if (rankingType === 'all-ranked') {
                // ì „ì²´ ì°¸ê°€ì ìˆœìœ„
                // 1. ë³¸ì„  ê²°ê³¼ë¡œ ìˆœìœ„ ìˆëŠ” ì‚¬ëŒ
                // 2. ë³¸ì„  íƒˆë½ ë¼ìš´ë“œë³„ (8ê°• íƒˆë½ > 16ê°• íƒˆë½)
                // 3. ì¡°ë³„ íƒˆë½ìëŠ” ì¡° ìˆœìœ„ + ë“ì‹¤ë¡œ
                
                const roundOrder = { 'ê²°ìŠ¹': 1, 'ì¤€ê²°ìŠ¹': 2, '8ê°•': 3, '16ê°•': 4, '32ê°•': 5, 'ë³¸ì„ ì§„ì¶œ': 6 };
                
                allPlayers.sort((a, b) => {
                    // ìµœì¢… ìˆœìœ„ê°€ ìˆìœ¼ë©´ ìš°ì„ 
                    if (a.finalRank && b.finalRank) return a.finalRank - b.finalRank;
                    if (a.finalRank) return -1;
                    if (b.finalRank) return 1;
                    
                    // ë³¸ì„  ì§„ì¶œ ì—¬ë¶€
                    const aKO = roundOrder[a.knockoutRound] || 99;
                    const bKO = roundOrder[b.knockoutRound] || 99;
                    if (aKO !== bKO) return aKO - bKO;
                    
                    // ì¡° ìˆœìœ„
                    if (a.groupRank !== b.groupRank) return a.groupRank - b.groupRank;
                    
                    // ìŠ¹ë¥ 
                    const aWinRate = a.totalWins / (a.totalWins + a.totalLosses || 1);
                    const bWinRate = b.totalWins / (b.totalWins + b.totalLosses || 1);
                    if (aWinRate !== bWinRate) return bWinRate - aWinRate;
                    
                    // ì„¸íŠ¸ ë“ì‹¤
                    const aSetDiff = a.setWins - a.setLosses;
                    const bSetDiff = b.setWins - b.setLosses;
                    if (aSetDiff !== bSetDiff) return bSetDiff - aSetDiff;
                    
                    // ê³¨ ë“ì‹¤
                    return (b.pointsFor - b.pointsAgainst) - (a.pointsFor - a.pointsAgainst);
                });
                
                allPlayers.forEach((p, idx) => {
                    if (!p.finalRank) p.finalRank = idx + 1;
                    result.finalStandings.push({ rank: p.finalRank, name: p.name, record: p });
                });
            } else {
                // ë³¸ì„  ì§„ì¶œìë§Œ
                allPlayers
                    .filter(p => p.finalRank)
                    .sort((a, b) => a.finalRank - b.finalRank)
                    .forEach(p => {
                        result.finalStandings.push({ rank: p.finalRank, name: p.name, record: p });
                    });
            }
            
            // ê²°ê³¼ ì €ì¥
            currentProject.autoTournamentResult = result;
            saveProjects();
            
            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('auto-tournament-result').style.display = 'block';
            document.getElementById('auto-tournament-result').innerHTML = renderAutoTournamentResult();
            announce('ëŒ€íšŒ ì§„í–‰ ì™„ë£Œ!');
        }
        
        function renderAutoTournamentResult() {
            const r = currentProject.autoTournamentResult;
            if (!r) return '';
            
            const isTeam = r.settings.isTeam;
            let html = '';
            
            // ëŒ€íšŒ ì„¤ì • ìš”ì•½
            html += `<div style="margin-bottom:16px; padding:12px; background:#e3f2fd; border-radius:8px;">`;
            html += `<h4 style="margin-bottom:8px;">âš™ï¸ ëŒ€íšŒ ì„¤ì •</h4>`;
            html += `<p style="font-size:13px; margin:0;">`;
            html += `${r.settings.count}${isTeam ? 'íŒ€' : 'ëª…'} / ${r.settings.groupCount}ê°œì¡° / `;
            html += `ì¡°ë³„ ${r.settings.advanceCount}${isTeam ? 'íŒ€' : 'ëª…'} ì§„ì¶œ / `;
            html += `${r.settings.thirdPlace ? '3/4ìœ„ì „ ì§„í–‰' : '3/4ìœ„ì „ ìƒëµ'}`;
            if (!isTeam && r.settings.fiveSetStart) {
                const fiveSetText = { 'final': 'ê²°ìŠ¹ë§Œ', 'semi': '4ê°•ë¶€í„°', 'quarter': '8ê°•ë¶€í„°', 'r16': '16ê°•ë¶€í„°', 'all': 'ë³¸ì„  ì „ì²´' };
                html += ` / ${fiveSetText[r.settings.fiveSetStart]} 5ì„¸íŠ¸`;
            }
            html += `</p></div>`;
            
            // ì°¸ê°€ì
            html += `<div style="margin-bottom:16px; padding:12px; background:var(--bg-secondary); border-radius:8px;">`;
            html += `<h4 style="margin-bottom:8px;">ğŸ‘¥ ì°¸ê°€${isTeam ? 'íŒ€' : 'ì'} (${r.participants.length}${isTeam ? 'íŒ€' : 'ëª…'})</h4>`;
            html += `<p style="font-size:13px;">${r.participants.map(p => p.name).join(', ')}</p>`;
            html += `</div>`;
            
            // ì¡° í¸ì„±
            html += `<div style="margin-bottom:16px;">`;
            html += `<h4 style="margin-bottom:8px;">ğŸ“‹ ì¡° í¸ì„± (${r.groups.length}ê°œì¡°)</h4>`;
            html += `<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:8px;">`;
            r.groups.forEach(g => {
                html += `<div style="padding:8px; background:var(--bg-secondary); border-radius:4px;">`;
                html += `<strong>${g.name}</strong>: ${g.players.join(', ')}`;
                html += `</div>`;
            });
            html += `</div></div>`;
            
            // ì¡°ë³„ ë¦¬ê·¸ ê²°ê³¼ + ìˆœìœ„
            html += `<div style="margin-bottom:16px;">`;
            html += `<h4 style="margin-bottom:8px;">âš½ ì¡°ë³„ ë¦¬ê·¸</h4>`;
            
            r.groupStandings.forEach((gs, gi) => {
                const gm = r.groupMatches[gi];
                html += `<div style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid var(--primary);">`;
                html += `<strong style="font-size:15px;">${gs.group}</strong>`;
                
                // ìˆœìœ„í‘œ
                html += `<table style="width:100%; margin:8px 0; font-size:12px; border-collapse:collapse;">`;
                html += `<tr style="background:#e0e0e0;"><th>ìˆœìœ„</th><th>ì´ë¦„</th><th>ìŠ¹</th><th>íŒ¨</th>`;
                html += isTeam ? `<th>ë“ì </th><th>ì‹¤ì </th><th>ë“ì‹¤</th>` : `<th>ì„¸íŠ¸</th><th>ë“ì‹¤</th>`;
                html += `</tr>`;
                gs.standings.forEach(p => {
                    const bg = p.qualified ? '#e8f5e9' : 'white';
                    const diff = isTeam ? (p.pf - p.pa) : (p.sw - p.sl);
                    const diffStr = diff > 0 ? `+${diff}` : diff;
                    html += `<tr style="background:${bg};">`;
                    html += `<td style="padding:4px; text-align:center;">${p.qualified ? 'ğŸ†' : ''}${p.rank}</td>`;
                    html += `<td style="padding:4px;">${p.name}</td>`;
                    html += `<td style="padding:4px; text-align:center;">${p.wins}</td>`;
                    html += `<td style="padding:4px; text-align:center;">${p.losses}</td>`;
                    if (isTeam) {
                        html += `<td style="padding:4px; text-align:center;">${p.pf}</td>`;
                        html += `<td style="padding:4px; text-align:center;">${p.pa}</td>`;
                    } else {
                        html += `<td style="padding:4px; text-align:center;">${p.sw}:${p.sl}</td>`;
                    }
                    html += `<td style="padding:4px; text-align:center; color:${diff > 0 ? 'green' : diff < 0 ? 'red' : 'black'};">${diffStr}</td>`;
                    html += `</tr>`;
                });
                html += `</table>`;
                
                // ê²½ê¸° ê²°ê³¼
                html += `<details><summary style="cursor:pointer; font-size:12px; color:var(--text-secondary);">ê²½ê¸° ìƒì„¸ (${gm.matches.length}ê²½ê¸°)</summary>`;
                html += `<div style="margin-top:8px; font-size:11px;">`;
                gm.matches.forEach((m, mi) => {
                    const setDetail = m.setScores ? m.setScores.map(s => `${s.s1}-${s.s2}`).join(', ') : '';
                    html += `<div style="padding:8px; margin:4px 0; background:#f5f5f5; border-radius:4px;">`;
                    html += `<div>${m.p1} vs ${m.p2}: <strong>${m.winner}</strong> (${m.score}) ${setDetail ? `[${setDetail}]` : ''}</div>`;
                    
                    // ë“ì  íˆìŠ¤í† ë¦¬
                    if (m.history && m.history.length > 0) {
                        html += `<details style="margin-top:4px;"><summary style="cursor:pointer; font-size:10px; color:var(--primary);">ğŸ¯ ë“ì  ê¸°ë¡ (${m.history.length}ê°œ)</summary>`;
                        html += `<div style="margin-top:4px; max-height:150px; overflow-y:auto; background:white; padding:4px; border-radius:3px;">`;
                        m.history.slice(-20).forEach(h => {
                            const color = h.player === m.p1 ? '#1976d2' : '#c62828';
                            html += `<div style="font-size:10px; padding:2px 4px; border-left:2px solid ${color}; margin:1px 0;">`;
                            html += `${h.player} ${h.scoreBefore}â†’${h.scoreAfter}`;
                            if (h.set) html += ` (${h.set}ì„¸íŠ¸)`;
                            html += `</div>`;
                        });
                        if (m.history.length > 20) html += `<div style="font-size:9px; color:#999;">... ì™¸ ${m.history.length - 20}ê°œ</div>`;
                        html += `</div></details>`;
                    }
                    html += `</div>`;
                });
                html += `</div></details>`;
                html += `</div>`;
            });
            html += `</div>`;
            
            // ê²°ì„  í† ë„ˆë¨¼íŠ¸
            if (r.knockoutRounds.length > 0) {
                html += `<div style="margin-bottom:16px;">`;
                html += `<h4 style="margin-bottom:8px;">ğŸ… ê²°ì„  í† ë„ˆë¨¼íŠ¸</h4>`;
                
                r.knockoutRounds.forEach(round => {
                    const bg = round.round === 'ê²°ìŠ¹' ? '#fff3cd' : round.round === '3/4ìœ„ì „' ? '#ffe4c4' : 'var(--bg-secondary)';
                    html += `<div style="padding:12px; margin:8px 0; background:${bg}; border-radius:8px;">`;
                    html += `<strong>${round.round}</strong> (${round.sets}ì„¸íŠ¸)<br>`;
                    round.matches.forEach(m => {
                        const setDetail = m.setScores ? m.setScores.map(s => `${s.s1}-${s.s2}`).join(', ') : '';
                        html += `<div style="padding:6px; margin:4px 0; background:rgba(255,255,255,0.5); border-radius:4px;">`;
                        html += `<div>${m.p1} vs ${m.p2}: <strong>${m.winner}</strong> (${m.score}) ${setDetail ? `[${setDetail}]` : ''}</div>`;
                        
                        // ë“ì  íˆìŠ¤í† ë¦¬
                        if (m.history && m.history.length > 0) {
                            html += `<details style="margin-top:4px;"><summary style="cursor:pointer; font-size:10px; color:var(--primary);">ğŸ¯ ë“ì  ê¸°ë¡ (${m.history.length}ê°œ)</summary>`;
                            html += `<div style="margin-top:4px; max-height:150px; overflow-y:auto; background:white; padding:4px; border-radius:3px;">`;
                            m.history.slice(-20).forEach(h => {
                                const color = h.player === m.p1 ? '#1976d2' : '#c62828';
                                html += `<div style="font-size:10px; padding:2px 4px; border-left:2px solid ${color}; margin:1px 0;">`;
                                html += `${h.player} ${h.scoreBefore}â†’${h.scoreAfter}`;
                                if (h.set) html += ` (${h.set}ì„¸íŠ¸)`;
                                html += `</div>`;
                            });
                            if (m.history.length > 20) html += `<div style="font-size:9px; color:#999;">... ì™¸ ${m.history.length - 20}ê°œ</div>`;
                            html += `</div></details>`;
                        }
                        html += `</div>`;
                    });
                    html += `</div>`;
                });
                html += `</div>`;
            }
            
            // ê°œì¸ë³„ ìƒì„¸ ê¸°ë¡
            html += `<div style="margin-bottom:16px;">`;
            html += `<h4 style="margin-bottom:8px;">ğŸ“Š ê°œì¸ë³„ ìƒì„¸ ê¸°ë¡</h4>`;
            html += `<details><summary style="cursor:pointer; padding:8px; background:var(--bg-secondary); border-radius:4px;">ì „ì²´ ${r.participants.length}${isTeam ? 'íŒ€' : 'ëª…'} ê¸°ë¡ ë³´ê¸°</summary>`;
            html += `<div style="margin-top:8px; max-height:400px; overflow-y:auto;">`;
            
            Object.values(r.playerRecords).forEach(p => {
                const setDiff = p.setWins - p.setLosses;
                const ptDiff = p.pointsFor - p.pointsAgainst;
                html += `<div style="padding:10px; margin:6px 0; background:var(--bg-secondary); border-radius:6px; border-left:3px solid ${p.finalRank <= 3 ? 'gold' : 'var(--primary)'};">`;
                html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">`;
                html += `<strong>${p.finalRank ? `#${p.finalRank} ` : ''}${p.name}</strong>`;
                html += `<span style="font-size:12px; color:var(--text-secondary);">${p.group} ${p.groupRank}ìœ„</span>`;
                html += `</div>`;
                html += `<div style="font-size:12px;">`;
                html += `ì „ì : ${p.totalWins}ìŠ¹ ${p.totalLosses}íŒ¨ | `;
                if (!isTeam) html += `ì„¸íŠ¸: +${p.setWins}/-${p.setLosses} | `;
                html += `ë“ì‹¤: +${p.pointsFor}/-${p.pointsAgainst}`;
                html += `</div>`;
                html += `<details style="margin-top:6px;"><summary style="cursor:pointer; font-size:11px;">ê²½ê¸° ê¸°ë¡ (${p.matches.length}ê²½ê¸°)</summary>`;
                html += `<div style="font-size:11px; margin-top:4px;">`;
                p.matches.forEach(m => {
                    const color = m.result === 'ìŠ¹' ? 'green' : 'red';
                    html += `[${m.stage}] vs ${m.opponent}: <span style="color:${color};">${m.result}</span> (${m.score})<br>`;
                });
                html += `</div></details></div>`;
            });
            html += `</div></details></div>`;
            
            // ìµœì¢… ìˆœìœ„
            if (r.finalStandings.length > 0) {
                html += `<div style="padding:16px; background:#e8f5e9; border-radius:8px;">`;
                html += `<h4 style="margin-bottom:12px;">ğŸ† ìµœì¢… ìˆœìœ„ ${r.settings.rankingType === 'all-ranked' ? '(ì „ì²´)' : '(ë³¸ì„ )'}</h4>`;
                
                const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
                const topN = r.settings.rankingType === 'all-ranked' ? Math.min(r.finalStandings.length, 16) : r.finalStandings.length;
                
                for (let i = 0; i < topN; i++) {
                    const p = r.finalStandings[i];
                    const medal = i < 3 ? medals[i] : `${p.rank}ìœ„`;
                    const size = i === 0 ? '18px' : i < 3 ? '16px' : '14px';
                    const weight = i < 4 ? 'bold' : 'normal';
                    html += `<div style="font-size:${size}; font-weight:${weight}; margin:4px 0; padding:4px 8px; background:${i < 4 ? 'rgba(255,255,255,0.5)' : 'transparent'}; border-radius:4px;">`;
                    html += `${medal} ${p.name}`;
                    if (p.record) {
                        html += ` <span style="font-size:11px; font-weight:normal; color:var(--text-secondary);">(${p.record.totalWins}ìŠ¹ ${p.record.totalLosses}íŒ¨)</span>`;
                    }
                    html += `</div>`;
                }
                
                if (r.settings.rankingType === 'all-ranked' && r.finalStandings.length > 16) {
                    html += `<p style="font-size:12px; color:var(--text-secondary); margin-top:8px;">... ì™¸ ${r.finalStandings.length - 16}ëª…</p>`;
                }
                html += `</div>`;
            }
            
            return html;
        }
        
        // íƒ‘ì‹œë“œ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
        function updateTopSeedInputs() {
            const groupCount = parseInt(document.getElementById('auto-group-count')?.value || 4);
            const container = document.getElementById('top-seed-inputs');
            if (!container) return;
            
            let html = '';
            for (let i = 0; i < groupCount; i++) {
                const groupLetter = String.fromCharCode(65 + i);
                html += `<input type="text" placeholder="${groupLetter}ì¡° íƒ‘ì‹œë“œ" id="seed-${groupLetter}" style="padding:8px; font-size:13px;">`;
            }
            container.innerHTML = html;
        }
        
        // ì¡° í¸ì„± ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        function updateGroupPreview() {
            const count = parseInt(document.getElementById('auto-participant-count')?.value || 16);
            const groupCount = parseInt(document.getElementById('auto-group-count')?.value || 4);
            const preview = document.getElementById('group-preview');
            if (!preview) return;
            
            if (count < 2 || groupCount < 1) {
                preview.innerHTML = 'âš ï¸ ì°¸ê°€ì 2ëª… ì´ìƒ, ì¡° 1ê°œ ì´ìƒ í•„ìš”';
                preview.style.background = '#ffebee';
                return;
            }
            
            // IBSA ë°©ì‹: ìŠ¤ë„¤ì´í¬ ë°°ì •ìœ¼ë¡œ ì¡°ë³„ ì¸ì› ê³„ì‚°
            const perGroup = [];
            for (let i = 0; i < groupCount; i++) perGroup.push(0);
            
            for (let i = 0; i < count; i++) {
                const round = Math.floor(i / groupCount);
                const gi = round % 2 === 0 ? i % groupCount : groupCount - 1 - (i % groupCount);
                perGroup[gi]++;
            }
            
            // ë¯¸ë¦¬ë³´ê¸° ìƒì„±
            const groupNames = perGroup.map((n, i) => `${String.fromCharCode(65 + i)}ì¡° ${n}ëª…`);
            const isUneven = new Set(perGroup).size > 1;
            
            let html = `ğŸ“Š ì¡° í¸ì„±: ${groupNames.join(', ')}`;
            if (isUneven) {
                html += `<br><span style="color:#ff9800; font-size:12px;">â€» IBSA: ë¶ˆê· ë“± ì¡° í—ˆìš©, ìŠ¹ë¥ ë¡œ ìˆœìœ„ ê²°ì •</span>`;
            }
            
            preview.innerHTML = html;
            preview.style.background = isUneven ? '#fff3e0' : '#e3f2fd';
        }
        
        // ========== ì„ ìˆ˜ìš© ë·°ì–´ í•¨ìˆ˜ ==========
        
        // ========== ëœë¤ íŒ€ ë¦¬ê·¸ì „ í•¨ìˆ˜ ==========
        
        function addRTLParticipant() {
            const name = document.getElementById('rtl-name')?.value?.trim();
            const gender = document.getElementById('rtl-gender')?.value;
            
            if (!name) {
                alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            if (!window.randomTeamLeague) window.randomTeamLeague = { participants: [], teams: [], matches: [], phase: 'input' };
            
            window.randomTeamLeague.participants.push({ name, gender });
            document.getElementById('rtl-name').value = '';
            document.getElementById('rtl-name').focus();
            render();
        }
        
        function generateRTLAutoParticipants() {
            const count = parseInt(document.getElementById('rtl-auto-count')?.value || 12);
            const ratio = document.getElementById('rtl-auto-ratio')?.value || 'equal';
            
            if (!window.randomTeamLeague) window.randomTeamLeague = { participants: [], teams: [], matches: [], phase: 'input' };
            
            // ê¸°ì¡´ ì°¸ê°€ì ì´ˆê¸°í™” í™•ì¸
            if (window.randomTeamLeague.participants.length > 0) {
                if (!confirm(`ê¸°ì¡´ ì°¸ê°€ì ${window.randomTeamLeague.participants.length}ëª…ì„ ì‚­ì œí•˜ê³  ìƒˆë¡œ ìƒì„±í• ê¹Œìš”?`)) {
                    return;
                }
            }
            
            // ì„±ë¹„ ê³„ì‚°
            let maleCount, femaleCount;
            if (ratio === 'male') {
                maleCount = Math.ceil(count * 2 / 3);
                femaleCount = count - maleCount;
            } else if (ratio === 'female') {
                femaleCount = Math.ceil(count * 2 / 3);
                maleCount = count - femaleCount;
            } else {
                maleCount = Math.floor(count / 2);
                femaleCount = count - maleCount;
            }
            
            // ì°¸ê°€ì ìƒì„±
            const participants = [];
            const usedNames = [];
            
            for (let i = 0; i < maleCount; i++) {
                let name;
                do { name = generateRandomName('male'); } while (usedNames.includes(name));
                usedNames.push(name);
                participants.push({ name, gender: 'M' });
            }
            
            for (let i = 0; i < femaleCount; i++) {
                let name;
                do { name = generateRandomName('female'); } while (usedNames.includes(name));
                usedNames.push(name);
                participants.push({ name, gender: 'F' });
            }
            
            // ì„ê¸°
            for (let i = participants.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [participants[i], participants[j]] = [participants[j], participants[i]];
            }
            
            window.randomTeamLeague.participants = participants;
            render();
            announce(`${count}ëª… ì°¸ê°€ì ìë™ ìƒì„± ì™„ë£Œ. ë‚¨ì ${maleCount}ëª…, ì—¬ì ${femaleCount}ëª….`);
        }
        
        function removeRTLParticipant(index) {
            window.randomTeamLeague.participants.splice(index, 1);
            render();
        }
        
        function goToRTLTeamSetup() {
            window.randomTeamLeague.phase = 'team-setup';
            render();
        }
        
        function generateRandomTeams() {
            const rtl = window.randomTeamLeague;
            const teamCount = parseInt(document.getElementById('rtl-team-count')?.value || rtl.teams.length || 2);
            const balanceGender = document.getElementById('rtl-balance-gender')?.checked ?? true;
            
            // ì°¸ê°€ì ë³µì‚¬ í›„ ì„ê¸°
            let participants = [...rtl.participants];
            
            // íŒ€ ì´ˆê¸°í™” (ì´ë¦„ì€ ë¹„ì›Œë‘ê³  ë‚˜ì¤‘ì— ì…ë ¥ë°›ìŒ)
            rtl.teams = [];
            for (let i = 0; i < teamCount; i++) {
                rtl.teams.push({ name: `${i+1}ì¡°`, members: [] });
            }
            
            if (balanceGender) {
                // ì„±ë³„ ê· í˜• ë§ì¶”ê¸°
                const males = participants.filter(p => p.gender === 'M');
                const females = participants.filter(p => p.gender === 'F');
                
                // ì„ê¸°
                shuffleArray(males);
                shuffleArray(females);
                
                // êµëŒ€ë¡œ ë°°ì • (ìŠ¤ë„¤ì´í¬ ë°©ì‹)
                let teamIdx = 0;
                let direction = 1;
                
                // ë‚¨ì„± ë¨¼ì €
                males.forEach(p => {
                    rtl.teams[teamIdx].members.push(p);
                    teamIdx += direction;
                    if (teamIdx >= teamCount || teamIdx < 0) {
                        direction *= -1;
                        teamIdx += direction;
                    }
                });
                
                // ì—¬ì„±
                females.forEach(p => {
                    rtl.teams[teamIdx].members.push(p);
                    teamIdx += direction;
                    if (teamIdx >= teamCount || teamIdx < 0) {
                        direction *= -1;
                        teamIdx += direction;
                    }
                });
            } else {
                // ì™„ì „ ëœë¤
                shuffleArray(participants);
                participants.forEach((p, i) => {
                    rtl.teams[i % teamCount].members.push(p);
                });
            }
            
            rtl.phase = 'teams-generated';
            render();
        }
        
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }
        
        // íƒ‘ì‹œë“œ ì„ íƒ UI ì—…ë°ì´íŠ¸
        function updateRTLTopseedInputs() {
            const container = document.getElementById('rtl-topseed-container');
            const validationMsg = document.getElementById('rtl-validation-msg');
            if (!container) return;
            
            const rtl = window.randomTeamLeague;
            const teamCount = parseInt(document.getElementById('rtl-team-count')?.value || 2);
            const membersPerTeam = parseInt(document.getElementById('rtl-members-per-team')?.value || 3);
            
            // ì„¤ì • ì €ì¥
            rtl.teamCount = teamCount;
            rtl.membersPerTeam = membersPerTeam;
            
            // í•„ìš” ì¸ì› ê²€ì¦
            const totalNeeded = teamCount * membersPerTeam;
            const available = rtl.participants.length;
            
            if (totalNeeded > available) {
                validationMsg.innerHTML = `<div style="color:#d32f2f; padding:8px; background:#ffebee; border-radius:4px;">
                    âš ï¸ ì¸ì› ë¶€ì¡±: ${teamCount}íŒ€ Ã— ${membersPerTeam}ëª… = ${totalNeeded}ëª… í•„ìš” (í˜„ì¬ ${available}ëª…)
                </div>`;
            } else {
                const extra = available - totalNeeded;
                validationMsg.innerHTML = extra > 0 ? 
                    `<div style="color:#1976d2; padding:8px; background:#e3f2fd; border-radius:4px;">
                        â„¹ï¸ ${totalNeeded}ëª… ë°°ì • ì˜ˆì • (${extra}ëª… ë¯¸ë°°ì •)
                    </div>` : '';
            }
            
            // ì°¸ê°€ì ì˜µì…˜ ìƒì„±
            const participantOptions = rtl.participants.map((p, i) => 
                `<option value="${i}">${p.gender === 'M' ? 'ğŸ‘¨' : 'ğŸ‘©'} ${p.name}</option>`
            ).join('');
            
            // ê° íŒ€ë³„ íƒ‘ì‹œë“œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ìƒì„±
            let html = '<div style="display:grid; gap:8px;">';
            for (let t = 0; t < teamCount; t++) {
                const savedTopseed = rtl.topseeds?.[t];
                html += `
                    <div style="display:flex; align-items:center; gap:8px; padding:8px; background:#f5f5f5; border-radius:6px;">
                        <span style="min-width:60px; font-weight:bold; color:hsl(${t * 60}, 70%, 40%);">${t+1}íŒ€</span>
                        <select id="rtl-topseed-${t}" onchange="saveRTLTopseed(${t})" style="flex:1;">
                            <option value="">-- íƒ‘ì‹œë“œ ì„ íƒ --</option>
                            ${participantOptions}
                        </select>
                        <span style="font-size:12px; color:#666;">ğŸ†</span>
                    </div>
                `;
            }
            html += '</div>';
            
            container.innerHTML = html;
            
            // ì €ì¥ëœ íƒ‘ì‹œë“œ ê°’ ë³µì›
            if (rtl.topseeds) {
                rtl.topseeds.forEach((ts, t) => {
                    const select = document.getElementById(`rtl-topseed-${t}`);
                    if (select && ts !== null && ts !== undefined) {
                        select.value = ts;
                    }
                });
            }
        }
        
        // íƒ‘ì‹œë“œ ì„ íƒ ì €ì¥
        function saveRTLTopseed(teamIdx) {
            const rtl = window.randomTeamLeague;
            if (!rtl.topseeds) rtl.topseeds = [];
            
            const value = document.getElementById(`rtl-topseed-${teamIdx}`)?.value;
            rtl.topseeds[teamIdx] = value !== '' ? parseInt(value) : null;
        }
        
        // ëŒ€íšŒ ë°©ì‹ ì„ íƒ
        function selectRTLTournamentType(type) {
            const rtl = window.randomTeamLeague;
            rtl.tournamentType = type;
            
            document.getElementById('rtl-type-full-league').checked = (type === 'full-league');
            document.getElementById('rtl-type-group-tournament').checked = (type === 'group-tournament');
            
            updateRTLTournamentOptions();
        }
        
        // ëŒ€íšŒ ë°©ì‹ ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateRTLTournamentOptions() {
            const rtl = window.randomTeamLeague;
            const fullLeagueRadio = document.getElementById('rtl-type-full-league');
            const groupTournamentRadio = document.getElementById('rtl-type-group-tournament');
            const optionsDiv = document.getElementById('rtl-group-tournament-options');
            
            if (!fullLeagueRadio || !optionsDiv) return;
            
            const type = groupTournamentRadio?.checked ? 'group-tournament' : 'full-league';
            rtl.tournamentType = type;
            
            // ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            const fullLabel = document.getElementById('rtl-type-full-league-label');
            const groupLabel = document.getElementById('rtl-type-group-tournament-label');
            
            if (fullLabel) {
                fullLabel.style.border = type === 'full-league' ? '2px solid #1976d2' : '2px solid transparent';
                fullLabel.style.background = type === 'full-league' ? '#e3f2fd' : 'white';
            }
            if (groupLabel) {
                groupLabel.style.border = type === 'group-tournament' ? '2px solid #1976d2' : '2px solid transparent';
                groupLabel.style.background = type === 'group-tournament' ? '#e3f2fd' : 'white';
            }
            
            // ì˜µì…˜ í‘œì‹œ/ìˆ¨ê¹€
            optionsDiv.style.display = type === 'group-tournament' ? 'block' : 'none';
            
            updateRTLGroupPreview();
        }
        
        // ì¡°ë³„+í† ë„ˆë¨¼íŠ¸ ë¯¸ë¦¬ë³´ê¸°
        function updateRTLGroupPreview() {
            const rtl = window.randomTeamLeague;
            const previewDiv = document.getElementById('rtl-group-preview');
            const teamCountEl = document.getElementById('rtl-team-count');
            const groupCountEl = document.getElementById('rtl-group-count');
            const advanceCountEl = document.getElementById('rtl-advance-count');
            
            if (!previewDiv || !teamCountEl) return;
            
            const teamCount = parseInt(teamCountEl.value || 4);
            const groupCount = parseInt(groupCountEl?.value || 2);
            const advanceCount = parseInt(advanceCountEl?.value || 2);
            
            // ì €ì¥
            rtl.groupCount = groupCount;
            rtl.advanceCount = advanceCount;
            
            // ì¡°ë³„ íŒ€ ìˆ˜ ê³„ì‚°
            const teamsPerGroup = Math.floor(teamCount / groupCount);
            const remainder = teamCount % groupCount;
            
            // ì§„ì¶œíŒ€ ì´ ìˆ˜
            const totalAdvance = groupCount * advanceCount;
            
            // í† ë„ˆë¨¼íŠ¸ ê·œëª¨ ê³„ì‚° (2ì˜ ê±°ë“­ì œê³±)
            let bracketSize = 2;
            while (bracketSize < totalAdvance) bracketSize *= 2;
            
            let html = '';
            
            // ì¡° í¸ì„± ë¯¸ë¦¬ë³´ê¸°
            const groupNames = [];
            for (let i = 0; i < groupCount; i++) {
                const gTeams = teamsPerGroup + (i < remainder ? 1 : 0);
                groupNames.push(`${String.fromCharCode(65 + i)}ì¡° ${gTeams}íŒ€`);
            }
            html += `ğŸ“‹ ì¡° í¸ì„±: ${groupNames.join(', ')}<br>`;
            
            // ì§„ì¶œ ë° í† ë„ˆë¨¼íŠ¸
            html += `ğŸ¯ ê²°ì„  ì§„ì¶œ: ${groupCount}ì¡° Ã— ${advanceCount}íŒ€ = ${totalAdvance}íŒ€<br>`;
            html += `ğŸ† ê²°ì„  í† ë„ˆë¨¼íŠ¸: ${bracketSize}ê°•`;
            
            // ê²½ê³ 
            if (advanceCount >= teamsPerGroup) {
                html += `<br><span style="color:#d32f2f;">âš ï¸ ì§„ì¶œì ìˆ˜ê°€ ì¡°ë³„ íŒ€ ìˆ˜ë³´ë‹¤ ë§ê±°ë‚˜ ê°™ìŠµë‹ˆë‹¤</span>`;
            }
            
            previewDiv.innerHTML = html;
        }
        
        // íƒ‘ì‹œë“œ í¬í•¨ ëœë¤ íŒ€ ìƒì„±
        function generateRandomTeamsWithTopseeds() {
            const rtl = window.randomTeamLeague;
            const teamCount = parseInt(document.getElementById('rtl-team-count')?.value || 2);
            const membersPerTeam = parseInt(document.getElementById('rtl-members-per-team')?.value || 3);
            const balanceGender = document.getElementById('rtl-balance-gender')?.checked ?? true;
            
            // ê²€ì¦: ì¸ì› ìˆ˜
            const totalNeeded = teamCount * membersPerTeam;
            if (totalNeeded > rtl.participants.length) {
                alert(`ì¸ì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!\ní•„ìš”: ${totalNeeded}ëª…, í˜„ì¬: ${rtl.participants.length}ëª…`);
                return;
            }
            
            // íƒ‘ì‹œë“œ ìˆ˜ì§‘
            const topseeds = [];
            const topseedIndices = new Set();
            
            for (let t = 0; t < teamCount; t++) {
                const topseedIdx = rtl.topseeds?.[t];
                if (topseedIdx !== null && topseedIdx !== undefined && topseedIdx !== '') {
                    // ì¤‘ë³µ ì²´í¬
                    if (topseedIndices.has(topseedIdx)) {
                        alert(`íƒ‘ì‹œë“œê°€ ì¤‘ë³µë˜ì—ˆìŠµë‹ˆë‹¤: ${rtl.participants[topseedIdx].name}`);
                        return;
                    }
                    topseedIndices.add(parseInt(topseedIdx));
                    topseeds[t] = rtl.participants[topseedIdx];
                } else {
                    topseeds[t] = null;
                }
            }
            
            // íŒ€ ì´ˆê¸°í™” ë° íƒ‘ì‹œë“œ ë°°ì¹˜
            rtl.teams = [];
            for (let t = 0; t < teamCount; t++) {
                const team = { name: `${t+1}ì¡°`, members: [], topseed: null };
                if (topseeds[t]) {
                    team.members.push(topseeds[t]);
                    team.topseed = topseeds[t].name;
                }
                rtl.teams.push(team);
            }
            
            // íƒ‘ì‹œë“œ ì œì™¸í•œ ë‚˜ë¨¸ì§€ ì°¸ê°€ì
            const remainingParticipants = rtl.participants.filter((p, i) => !topseedIndices.has(i));
            
            // ë‚˜ë¨¸ì§€ ì¸ì› ë°°ì •
            const remainingNeeded = teamCount * membersPerTeam - topseedIndices.size;
            let toAssign = [...remainingParticipants].slice(0, remainingNeeded);
            
            if (balanceGender) {
                // ì„±ë³„ ê· í˜• - ë‚¨ë…€ ë¶„ë¦¬ í›„ êµëŒ€ ë°°ì •
                const males = toAssign.filter(p => p.gender === 'M');
                const females = toAssign.filter(p => p.gender === 'F');
                shuffleArray(males);
                shuffleArray(females);
                
                // íŒ€ë³„ í•„ìš” ì¸ì› ê³„ì‚°
                const neededPerTeam = rtl.teams.map(t => membersPerTeam - t.members.length);
                
                // ìŠ¤ë„¤ì´í¬ ë°©ì‹ ë°°ì •
                let teamIdx = 0;
                let direction = 1;
                
                // ë‚¨ì„± ë¨¼ì €
                males.forEach(p => {
                    // ì•„ì§ ì¸ì›ì´ í•„ìš”í•œ íŒ€ ì°¾ê¸°
                    while (neededPerTeam[teamIdx] <= 0) {
                        teamIdx += direction;
                        if (teamIdx >= teamCount || teamIdx < 0) {
                            direction *= -1;
                            teamIdx += direction;
                        }
                    }
                    rtl.teams[teamIdx].members.push(p);
                    neededPerTeam[teamIdx]--;
                    teamIdx += direction;
                    if (teamIdx >= teamCount || teamIdx < 0) {
                        direction *= -1;
                        teamIdx += direction;
                    }
                });
                
                // ì—¬ì„±
                females.forEach(p => {
                    while (neededPerTeam[teamIdx] <= 0) {
                        teamIdx += direction;
                        if (teamIdx >= teamCount || teamIdx < 0) {
                            direction *= -1;
                            teamIdx += direction;
                        }
                    }
                    rtl.teams[teamIdx].members.push(p);
                    neededPerTeam[teamIdx]--;
                    teamIdx += direction;
                    if (teamIdx >= teamCount || teamIdx < 0) {
                        direction *= -1;
                        teamIdx += direction;
                    }
                });
            } else {
                // ì™„ì „ ëœë¤
                shuffleArray(toAssign);
                let idx = 0;
                rtl.teams.forEach(team => {
                    while (team.members.length < membersPerTeam && idx < toAssign.length) {
                        team.members.push(toAssign[idx++]);
                    }
                });
            }
            
            rtl.phase = 'teams-generated';
            render();
        }
        
        function updateRTLTeamName(teamIndex, newName) {
            window.randomTeamLeague.teams[teamIndex].name = newName.trim() || `${teamIndex+1}ì¡°`;
        }
        
        function startRTLLeague() {
            const rtl = window.randomTeamLeague;
            
            // íŒ€ ì´ë¦„ ë¹ˆ ì¹¸ ì²´í¬
            const emptyNames = rtl.teams.filter(t => !t.name || t.name.match(/^\d+ì¡°$/));
            if (emptyNames.length > 0) {
                alert('ëª¨ë“  íŒ€ì˜ ì´ë¦„ì„ ì •í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const tournamentType = rtl.tournamentType || 'full-league';
            const typeLabel = tournamentType === 'group-tournament' ? 'ì¡°ë³„+í† ë„ˆë¨¼íŠ¸' : 'í’€ë¦¬ê·¸';
            
            // í”„ë¡œì íŠ¸ëª… ì…ë ¥
            const projectName = prompt('í”„ë¡œì íŠ¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”:', `ëœë¤íŒ€ ${typeLabel} ${new Date().toLocaleDateString()}`);
            if (!projectName) return;
            
            // ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±
            const project = {
                id: Date.now(),
                name: projectName,
                date: new Date().toISOString().split('T')[0],
                location: '',
                desc: `ëœë¤ íŒ€ ${typeLabel}`,
                matches: [],
                createdAt: new Date().toISOString(),
                competitionType: 'team',
                tournamentType: tournamentType === 'group-tournament' ? 'group-tournament' : 'group',
                groups: [],
                players: [],
                teams: [],
                bracket: null,
                standings: [],
                isRandomTeamLeague: true,
                randomTeamData: {
                    participants: [...rtl.participants],
                    teamAssignments: rtl.teams.map(t => ({
                        name: t.name,
                        members: t.members.map(m => m.name),
                        topseed: t.topseed
                    }))
                }
            };
            
            // íŒ€ ë“±ë¡
            rtl.teams.forEach((team, idx) => {
                project.teams.push({
                    id: Date.now() + idx,
                    name: team.name,
                    members: team.members.map(m => ({
                        name: m.name,
                        gender: m.gender === 'M' ? 'male' : 'female'
                    })),
                    topseed: team.topseed || null,
                    group: null // ë‚˜ì¤‘ì— ë°°ì •
                });
            });
            
            if (tournamentType === 'group-tournament') {
                // === ì¡°ë³„ ë¦¬ê·¸ + í† ë„ˆë¨¼íŠ¸ ===
                const groupCount = rtl.groupCount || 2;
                const advanceCount = rtl.advanceCount || 2;
                
                // ì¡° ìƒì„±
                for (let i = 0; i < groupCount; i++) {
                    project.groups.push({
                        name: String.fromCharCode(65 + i) + 'ì¡°',
                        players: [],
                        matches: [],
                        standings: [],
                        isTeam: true
                    });
                }
                
                // íŒ€ì„ ì¡°ì— ë°°ì • (ìŠ¤ë„¤ì´í¬ ë°©ì‹)
                project.teams.forEach((team, idx) => {
                    const round = Math.floor(idx / groupCount);
                    const groupIdx = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                    team.group = String.fromCharCode(65 + groupIdx);
                    project.groups[groupIdx].players.push({ name: team.name, id: team.id });
                });
                
                // ê° ì¡°ë³„ ë¼ìš´ë“œ ë¡œë¹ˆ ëŒ€ì§„ ìƒì„±
                project.groups.forEach((group, gi) => {
                    const groupTeams = group.players;
                    for (let i = 0; i < groupTeams.length; i++) {
                        for (let j = i + 1; j < groupTeams.length; j++) {
                            const matchId = `G${gi + 1}M${group.matches.length + 1}`;
                            group.matches.push({
                                id: matchId,
                                player1: groupTeams[i].name,
                                player2: groupTeams[j].name,
                                status: 'pending',
                                result: null,
                                sets: 1,
                                isTeam: true,
                                winScore: 31
                            });
                        }
                    }
                });
                
                // ì„¤ì • ì €ì¥
                project.groupSettings = {
                    groupCount: groupCount,
                    advanceCount: advanceCount,
                    setsPerMatch: 1
                };
                
                // í† ë„ˆë¨¼íŠ¸ ì„¤ì • (ê²°ì„ ìš©)
                const totalAdvance = groupCount * advanceCount;
                let bracketSize = 2;
                while (bracketSize < totalAdvance) bracketSize *= 2;
                
                project.tournamentSettings = {
                    size: bracketSize,
                    thirdPlaceMatch: true,
                    setsPerMatch: 1
                };
                
            } else {
                // === í’€ë¦¬ê·¸ ===
                // ë‹¨ì¼ ì¡°ì— ëª¨ë“  íŒ€ ë°°ì •
                project.groups = [{
                    name: 'Aì¡°',
                    players: project.teams.map(t => ({ name: t.name, id: t.id })),
                    matches: [],
                    standings: [],
                    isTeam: true
                }];
                
                // íŒ€ ì¡° ì •ë³´ ì—…ë°ì´íŠ¸
                project.teams.forEach(t => t.group = 'A');
                
                // ë¼ìš´ë“œ ë¡œë¹ˆ ëŒ€ì§„ ìƒì„±
                const teams = project.groups[0].players;
                for (let i = 0; i < teams.length; i++) {
                    for (let j = i + 1; j < teams.length; j++) {
                        const matchId = `G1M${project.groups[0].matches.length + 1}`;
                        project.groups[0].matches.push({
                            id: matchId,
                            player1: teams[i].name,
                            player2: teams[j].name,
                            status: 'pending',
                            result: null,
                            sets: 1,
                            isTeam: true,
                            winScore: 31
                        });
                    }
                }
                
                // ì„¤ì • ì €ì¥
                project.groupSettings = {
                    groupCount: 1,
                    advanceCount: project.teams.length,
                    setsPerMatch: 1
                };
            }
            
            // Firebaseì— ì €ì¥
            const teamCount = rtl.teams.length;
            try {
                if (typeof database !== 'undefined' && database) {
                    const newProjectRef = database.ref('projects').push();
                    project.firebaseKey = newProjectRef.key;
                    newProjectRef.set(project).then(() => {
                        console.log('âœ… ëœë¤ íŒ€ í”„ë¡œì íŠ¸ ìƒì„± ì™„ë£Œ');
                        projects.push(project);
                        currentProject = project;
                        window.randomTeamLeague = null;
                        goTo('project-detail');
                        announce(`${projectName} ìƒì„± ì™„ë£Œ. ${teamCount}íŒ€ ${typeLabel}.`);
                    }).catch((error) => {
                        console.error('Firebase ì €ì¥ ì—ëŸ¬:', error);
                        saveRTLProjectLocal(project, projectName, rtl, typeLabel);
                    });
                } else {
                    saveRTLProjectLocal(project, projectName, rtl, typeLabel);
                }
            } catch (error) {
                console.error('í”„ë¡œì íŠ¸ ìƒì„± ì—ëŸ¬:', error);
                saveRTLProjectLocal(project, projectName, rtl, typeLabel);
            }
        }
        
        function saveRTLProjectLocal(project, projectName, rtl, typeLabel) {
            projects.push(project);
            localStorage.setItem('projects', JSON.stringify(projects));
            currentProject = project;
            const teamCount = rtl.teams.length;
            window.randomTeamLeague = null;
            goTo('project-detail');
            announce(`${projectName} ìƒì„± ì™„ë£Œ. ${teamCount}íŒ€ ${typeLabel || 'ë¦¬ê·¸ì „'}.`);
        }
        
        function resetRTL() {
            if (confirm('ìƒˆ ë¦¬ê·¸ì „ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.randomTeamLeague = { participants: [], teams: [], matches: [], phase: 'input' };
                render();
            }
        }
        
        function openViewerProject(index) {
            currentProjectIndex = index;
            currentProject = projects[index];
            goTo('viewer-results');
        }
        
        function switchViewerTab(tab) {
            // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë³€ê²½
            document.querySelectorAll('.viewer-tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}`)?.classList.add('active');
            
            // ì½˜í…ì¸  ë³€ê²½
            const content = document.getElementById('viewer-content');
            switch(tab) {
                case 'overview':
                    content.innerHTML = renderViewerOverview();
                    break;
                case 'groups':
                    content.innerHTML = renderViewerGroups();
                    break;
                case 'bracket':
                    content.innerHTML = renderViewerBracket();
                    break;
                case 'records':
                    content.innerHTML = renderViewerRecords();
                    break;
            }
        }
        
        function renderViewerOverview() {
            const p = currentProject;
            const isTeam = p.competitionType === 'team';
            const hasAutoResult = p.autoTournamentResult;
            const hasGroups = p.groups?.length > 0;
            
            let html = '';
            
            // ëŒ€íšŒ ì •ë³´
            html += `<div style="padding:16px; background:var(--bg-secondary); border-radius:8px; margin-bottom:16px;">`;
            html += `<h3 style="margin-bottom:12px;">ğŸ“Œ ëŒ€íšŒ ì •ë³´</h3>`;
            html += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:14px;">`;
            html += `<div>ğŸ“… ë‚ ì§œ: ${p.date || 'ë¯¸ì •'}</div>`;
            html += `<div>ğŸ“ ì¥ì†Œ: ${p.location || 'ë¯¸ì •'}</div>`;
            html += `<div>ğŸ… ìœ í˜•: ${isTeam ? 'íŒ€ì „' : 'ê°œì¸ì „'}${p.isRandomTeamLeague ? ' (ëœë¤)' : ''}</div>`;
            
            const participantCount = isTeam ? (p.teams?.length || 0) : (p.players?.length || 0);
            html += `<div>ğŸ‘¥ ì°¸ê°€: ${participantCount}${isTeam ? 'íŒ€' : 'ëª…'}</div>`;
            html += `</div></div>`;
            
            // ëœë¤ íŒ€ ë¦¬ê·¸ì „ - íŒ€ êµ¬ì„± í‘œì‹œ
            if (p.isRandomTeamLeague && p.teams?.length > 0) {
                html += `<div style="padding:16px; background:linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border-radius:8px; margin-bottom:16px; border-left:4px solid #667eea;">`;
                html += `<h3 style="margin-bottom:12px;">ğŸ² íŒ€ êµ¬ì„± <span style="font-size:12px; font-weight:normal; color:#666;">(ğŸ† = íƒ‘ì‹œë“œ)</span></h3>`;
                
                p.teams.forEach((team, ti) => {
                    html += `<div style="padding:10px; margin:8px 0; background:white; border-radius:6px; border-left:4px solid hsl(${ti * 60}, 70%, 50%);">`;
                    html += `<strong style="font-size:15px;">${team.name}</strong>`;
                    html += `<div style="margin-top:6px;">`;
                    team.members.forEach(m => {
                        const genderIcon = m.gender === 'male' ? 'ğŸ‘¨' : 'ğŸ‘©';
                        const bgColor = m.gender === 'male' ? '#e3f2fd' : '#fce4ec';
                        const isTopseed = team.topseed === m.name;
                        const border = isTopseed ? 'border:2px solid #ffc107;' : '';
                        html += `<span style="display:inline-block; padding:3px 10px; margin:2px; background:${bgColor}; border-radius:12px; font-size:13px; ${border}">${isTopseed ? 'ğŸ†' : ''} ${genderIcon} ${m.name}</span>`;
                    });
                    html += `</div></div>`;
                });
                
                html += `</div>`;
            }
            
            // ìµœì¢… ìˆœìœ„ (ìë™ ëŒ€íšŒ ê²°ê³¼ê°€ ìˆìœ¼ë©´)
            if (hasAutoResult && p.autoTournamentResult.finalStandings?.length > 0) {
                html += `<div style="padding:16px; background:#e8f5e9; border-radius:8px; margin-bottom:16px;">`;
                html += `<h3 style="margin-bottom:12px;">ğŸ† ìµœì¢… ìˆœìœ„</h3>`;
                const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
                p.autoTournamentResult.finalStandings.slice(0, 8).forEach((s, i) => {
                    const medal = i < 3 ? medals[i] : `${s.rank}ìœ„`;
                    const bg = i < 3 ? 'rgba(255,215,0,0.2)' : 'transparent';
                    html += `<div style="padding:8px; margin:4px 0; background:${bg}; border-radius:4px; font-size:${i < 3 ? '16px' : '14px'};">`;
                    html += `${medal} <strong>${s.name}</strong>`;
                    html += `</div>`;
                });
                html += `</div>`;
            }
            
            // ì§„í–‰ ìƒí™©
            if (hasGroups) {
                const totalMatches = p.groups.reduce((sum, g) => sum + (g.matches?.length || 0), 0);
                const finishedMatches = p.groups.reduce((sum, g) => 
                    sum + (g.matches?.filter(m => m.status === 'completed').length || 0), 0);
                
                html += `<div style="padding:16px; background:var(--bg-secondary); border-radius:8px;">`;
                html += `<h3 style="margin-bottom:12px;">ğŸ“ˆ ì§„í–‰ ìƒí™©</h3>`;
                html += `<div style="font-size:14px;">`;
                html += `<p>ì¡°ë³„ ë¦¬ê·¸: ${finishedMatches}/${totalMatches} ê²½ê¸° ì™„ë£Œ</p>`;
                
                const progress = totalMatches > 0 ? Math.round(finishedMatches / totalMatches * 100) : 0;
                html += `<div style="background:#ddd; border-radius:10px; height:20px; margin-top:8px;">`;
                html += `<div style="background:var(--success); border-radius:10px; height:100%; width:${progress}%; transition:width 0.3s;"></div>`;
                html += `</div>`;
                html += `<p style="text-align:center; margin-top:4px;">${progress}%</p>`;
                html += `</div></div>`;
            }
            
            return html;
        }
        
        function renderViewerGroups() {
            const p = currentProject;
            const isTeam = p.competitionType === 'team';
            const hasAutoResult = p.autoTournamentResult;
            
            // ìë™ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ê²°ê³¼ í‘œì‹œ
            if (hasAutoResult && p.autoTournamentResult.groupStandings?.length > 0) {
                let html = '';
                
                p.autoTournamentResult.groupStandings.forEach((gs, gi) => {
                    const gm = p.autoTournamentResult.groupMatches?.[gi];
                    const advanceCount = p.groupSettings?.advanceCount || p.autoTournamentResult.settings?.advanceCount || 2;
                    
                    html += '<div style="padding:16px; margin:12px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid var(--primary);">';
                    html += '<h4 style="margin-bottom:12px;">' + gs.group + '</h4>';
                    
                    // ìˆœìœ„í‘œ
                    html += '<table style="width:100%; font-size:13px; border-collapse:collapse;">';
                    html += '<tr style="background:#e0e0e0;"><th style="padding:6px;">ìˆœìœ„</th><th style="padding:6px; text-align:left;">ì´ë¦„</th>';
                    html += '<th style="padding:6px;">ìŠ¹</th><th style="padding:6px;">íŒ¨</th>';
                    html += isTeam ? '<th style="padding:6px;">ë“ì </th><th style="padding:6px;">ì‹¤ì </th>' : '<th style="padding:6px;">ì„¸íŠ¸</th>';
                    html += '<th style="padding:6px;">ë“ì‹¤</th></tr>';
                    
                    gs.standings.forEach((s, si) => {
                        const bg = s.qualified ? '#e8f5e9' : 'white';
                        const diff = isTeam ? (s.pf - s.pa) : (s.sw - s.sl);
                        const diffStr = diff > 0 ? '+' + diff : diff;
                        
                        html += '<tr style="background:' + bg + '; border-bottom:1px solid #eee;">';
                        html += '<td style="padding:6px; text-align:center;">' + (s.qualified ? 'ğŸ†' : '') + s.rank + '</td>';
                        html += '<td style="padding:6px;">' + s.name + '</td>';
                        html += '<td style="padding:6px; text-align:center;">' + s.wins + '</td>';
                        html += '<td style="padding:6px; text-align:center;">' + s.losses + '</td>';
                        if (isTeam) {
                            html += '<td style="padding:6px; text-align:center;">' + (s.pf || 0) + '</td>';
                            html += '<td style="padding:6px; text-align:center;">' + (s.pa || 0) + '</td>';
                        } else {
                            html += '<td style="padding:6px; text-align:center;">' + s.sw + ':' + s.sl + '</td>';
                        }
                        html += '<td style="padding:6px; text-align:center; color:' + (diff > 0 ? 'green' : diff < 0 ? 'red' : 'black') + ';">' + diffStr + '</td>';
                        html += '</tr>';
                    });
                    html += '</table>';
                    
                    // ê²½ê¸° ê²°ê³¼ ìƒì„¸
                    if (gm?.matches?.length > 0) {
                        html += '<details style="margin-top:12px;"><summary style="cursor:pointer; font-size:12px; padding:4px 8px; background:#e8f5e9; border-radius:4px;">ğŸ“‹ ê²½ê¸° ê²°ê³¼ (' + gm.matches.length + 'ê²½ê¸°)</summary>';
                        html += '<div style="margin-top:8px;">';
                        gm.matches.forEach(function(m, mi) {
                            const winColor = '#2e7d32';
                            html += '<div style="padding:10px; margin:4px 0; background:#f5f5f5; border-radius:6px; border-left:3px solid ' + winColor + ';">';
                            html += '<div style="display:flex; justify-content:space-between; align-items:center;">';
                            html += '<span style="font-weight:bold;">' + m.p1 + ' vs ' + m.p2 + '</span>';
                            html += '<strong style="font-size:14px; color:' + winColor + ';">' + m.score + '</strong>';
                            html += '</div>';
                            html += '<div style="font-size:12px; color:var(--text-secondary); margin-top:4px;">ìŠ¹ì: ' + m.winner + '</div>';
                            if (m.setScores?.length > 0) {
                                html += '<div style="font-size:11px; margin-top:4px;">';
                                html += 'ì„¸íŠ¸ë³„: ';
                                m.setScores.forEach(function(s, i) {
                                    html += '<span style="background:white; padding:2px 6px; border-radius:3px; margin:2px;">' + (i+1) + 'ì„¸íŠ¸ ' + s.s1 + '-' + s.s2 + '</span> ';
                                });
                                html += '</div>';
                            }
                            // ìƒì„¸ ê²½ê¸° ê¸°ë¡ (history)
                            if (m.history?.length > 0) {
                                html += '<details style="margin-top:8px;"><summary style="cursor:pointer; font-size:11px; color:#666;">ğŸ“Š ìƒì„¸ ë“ì  ê¸°ë¡ (' + m.history.length + 'ì )</summary>';
                                html += '<div style="max-height:200px; overflow-y:auto; margin-top:4px; padding:8px; background:white; border-radius:4px;">';
                                m.history.forEach(function(h, hi) {
                                    html += '<div style="padding:4px 8px; margin:2px 0; font-size:11px; background:#fafafa; border-radius:3px; display:flex; justify-content:space-between;">';
                                    html += '<span>' + (hi+1) + '. ' + h.player + (h.set ? ' (ì„¸íŠ¸' + h.set + ')' : '') + '</span>';
                                    html += '<span style="color:#1976d2;">+' + h.points + 'ì  â†’ ' + h.scoreAfter + '</span>';
                                    html += '</div>';
                                });
                                html += '</div></details>';
                            }
                            html += '</div>';
                        });
                        html += '</div></details>';
                    }
                    
                    html += '</div>';
                });
                
                return html;
            }
            
            if (!p.groups || p.groups.length === 0) {
                return '<p style="text-align:center; padding:20px; color:var(--text-secondary);">ì¡°ë³„ ë¦¬ê·¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            
            let html = '';
            
            p.groups.forEach((group, gi) => {
                const standings = calculateGroupStandings(group);
                const advanceCount = p.groupSettings?.advanceCount || 2;
                
                html += `<div style="padding:16px; margin:12px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid var(--primary);">`;
                html += `<h4 style="margin-bottom:12px;">${group.name}</h4>`;
                
                // ìˆœìœ„í‘œ
                html += `<table style="width:100%; font-size:13px; border-collapse:collapse;">`;
                html += `<tr style="background:#e0e0e0;"><th style="padding:6px;">ìˆœìœ„</th><th style="padding:6px; text-align:left;">ì´ë¦„</th>`;
                html += `<th style="padding:6px;">ìŠ¹</th><th style="padding:6px;">íŒ¨</th>`;
                html += isTeam ? `<th style="padding:6px;">ë“ì </th><th style="padding:6px;">ì‹¤ì </th>` : `<th style="padding:6px;">ì„¸íŠ¸</th>`;
                html += `<th style="padding:6px;">ë“ì‹¤</th></tr>`;
                
                standings.forEach((s, si) => {
                    const bg = si < advanceCount ? '#e8f5e9' : 'white';
                    const diff = isTeam ? (s.goalDiff) : (s.setWins - s.setLosses);
                    const diffStr = diff > 0 ? `+${diff}` : diff;
                    
                    html += `<tr style="background:${bg}; border-bottom:1px solid #eee;">`;
                    html += `<td style="padding:6px; text-align:center;">${si < advanceCount ? 'ğŸ†' : ''}${si + 1}</td>`;
                    html += `<td style="padding:6px;">${s.name}</td>`;
                    html += `<td style="padding:6px; text-align:center;">${s.wins}</td>`;
                    html += `<td style="padding:6px; text-align:center;">${s.losses}</td>`;
                    if (isTeam) {
                        html += `<td style="padding:6px; text-align:center;">${s.goalsFor || 0}</td>`;
                        html += `<td style="padding:6px; text-align:center;">${s.goalsAgainst || 0}</td>`;
                    } else {
                        html += `<td style="padding:6px; text-align:center;">+${s.setWins}/-${s.setLosses}</td>`;
                    }
                    html += `<td style="padding:6px; text-align:center; color:${diff > 0 ? 'green' : diff < 0 ? 'red' : 'black'};">${diffStr}</td>`;
                    html += `</tr>`;
                });
                html += `</table>`;
                
                // ê²½ê¸° ê²°ê³¼
                if (group.matches?.length > 0) {
                    html += `<details style="margin-top:12px;"><summary style="cursor:pointer; font-size:12px; padding:4px 8px; background:#e8f5e9; border-radius:4px;">ğŸ“‹ ê²½ê¸° ê²°ê³¼ (${group.matches.length}ê²½ê¸°)</summary>`;
                    html += `<div style="margin-top:8px;">`;
                    group.matches.forEach((m, mi) => {
                        const isFinished = m.status === 'completed';
                        const statusIcon = isFinished ? 'âœ…' : 'â³';
                        let result = 'ëŒ€ê¸°ì¤‘';
                        let winner = null;
                        
                        if (m.result) {
                            if (m.result.score1 !== undefined) {
                                result = m.result.score1 + ':' + m.result.score2;
                                winner = m.result.score1 > m.result.score2 ? m.player1 : m.player2;
                            } else if (m.result.player1Sets !== undefined) {
                                result = m.result.player1Sets + ':' + m.result.player2Sets + ' (ì„¸íŠ¸)';
                                winner = m.result.player1Sets > m.result.player2Sets ? m.player1 : m.player2;
                            }
                        }
                        
                        // finalScoreê°€ ìˆìœ¼ë©´ ê·¸ê²ƒë„ í‘œì‹œ
                        if (m.finalScore) {
                            result = m.finalScore.player1 + ':' + m.finalScore.player2;
                            winner = m.finalScore.player1 > m.finalScore.player2 ? m.player1Name || m.player1 : m.player2Name || m.player2;
                        }
                        
                        const p1Name = m.player1Name || m.player1;
                        const p2Name = m.player2Name || m.player2;
                        
                        const bg = isFinished ? '#f5f5f5' : 'white';
                        html += '<div style="padding:8px; margin:4px 0; background:' + bg + '; border-radius:6px; border-left:3px solid ' + (isFinished ? 'var(--success)' : 'var(--warning)') + ';">';
                        html += '<div style="display:flex; justify-content:space-between; align-items:center;">';
                        html += '<span>' + statusIcon + ' ' + p1Name + ' vs ' + p2Name + '</span>';
                        html += '<strong style="font-size:14px;">' + result + '</strong>';
                        html += '</div>';
                        if (winner) {
                            html += '<div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">ìŠ¹ì: ' + winner + '</div>';
                        }
                        
                        // ê²½ê¸° ìƒì„¸ ê¸°ë¡ (historyê°€ ìˆìœ¼ë©´)
                        if (m.history && m.history.length > 0) {
                            html += '<details style="margin-top:6px;"><summary style="cursor:pointer; font-size:11px; color:var(--primary);">ğŸ¯ ë“ì  ê¸°ë¡ (' + m.history.length + 'ê°œ)</summary>';
                            html += '<div style="margin-top:6px; max-height:200px; overflow-y:auto; background:white; padding:8px; border-radius:4px;">';
                            m.history.slice().reverse().forEach((h, hi) => {
                                const scoreColor = h.player === p1Name ? '#1976d2' : '#c62828';
                                const bgColor = h.player === p1Name ? '#e3f2fd' : '#ffebee';
                                html += '<div style="padding:4px 8px; margin:2px 0; background:' + bgColor + '; border-radius:4px; font-size:11px; border-left:3px solid ' + scoreColor + ';">';
                                html += '<div style="display:flex; justify-content:space-between;">';
                                html += '<span style="font-weight:bold; color:' + scoreColor + ';">' + h.player + '</span>';
                                html += '<span>' + h.scoreBefore + ' â†’ ' + h.scoreAfter + '</span>';
                                html += '</div>';
                                
                                // ë“ì  ìœ í˜•
                                let actionText = '';
                                if (h.type === 'goal') {
                                    actionText = 'ê³¨ ' + h.points + 'ì ';
                                } else if (h.type && h.type.includes('foul')) {
                                    actionText = h.type.split(' ')[0] + ' íŒŒìš¸ (ìƒëŒ€ +1)';
                                } else if (h.type === 'hand' || h.type === 'head' || h.type === 'double' || h.type === 'long') {
                                    actionText = h.type + ' íŒŒìš¸';
                                } else {
                                    actionText = h.type || 'ë“ì ';
                                }
                                html += '<div style="color:#666; font-size:10px;">' + actionText + '</div>';
                                html += '</div>';
                            });
                            html += '</div></details>';
                        }
                        
                        // ì„¸íŠ¸ ìŠ¤ì½”ì–´ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                        if (m.setScores && m.setScores.length > 0) {
                            const setInfo = m.setScores.map((s, si) => (si + 1) + 'ì„¸íŠ¸: ' + s.player1 + '-' + s.player2).join(' | ');
                            html += '<div style="font-size:10px; color:#666; margin-top:4px;">' + setInfo + '</div>';
                        }
                        
                        html += '</div>';
                    });
                    html += `</div></details>`;
                }
                
                html += `</div>`;
            });
            
            return html;
        }
        
        function renderViewerBracket() {
            const p = currentProject;
            const hasAutoResult = p.autoTournamentResult;
            
            let html = '';
            
            // ìë™ ëŒ€íšŒ ê²°ê³¼ í† ë„ˆë¨¼íŠ¸
            if (hasAutoResult && p.autoTournamentResult.knockoutRounds?.length > 0) {
                html += `<h4 style="margin-bottom:12px;">ğŸ… ê²°ì„  í† ë„ˆë¨¼íŠ¸</h4>`;
                
                p.autoTournamentResult.knockoutRounds.forEach(round => {
                    const bg = round.round === 'ê²°ìŠ¹' ? '#fff3cd' : 
                              round.round === '3/4ìœ„ì „' ? '#ffe4c4' : 'var(--bg-secondary)';
                    
                    html += `<div style="padding:12px; margin:8px 0; background:${bg}; border-radius:8px;">`;
                    html += `<strong>${round.round}</strong> (${round.sets}ì„¸íŠ¸)<br>`;
                    round.matches.forEach((m, mi) => {
                        html += `<div style="padding:8px; margin:4px 0; background:white; border-radius:6px;">`;
                        html += `<div style="display:flex; justify-content:space-between; align-items:center;">`;
                        html += `<span>${m.p1} vs ${m.p2}</span>`;
                        html += `<strong style="color:#2e7d32;">${m.winner} (${m.score})</strong>`;
                        html += `</div>`;
                        if (m.setScores?.length > 0) {
                            html += `<div style="font-size:11px; margin-top:4px;">ì„¸íŠ¸ë³„: `;
                            m.setScores.forEach((s, si) => {
                                html += `<span style="background:#f5f5f5; padding:2px 6px; border-radius:3px; margin:2px;">${si+1}ì„¸íŠ¸ ${s.s1}-${s.s2}</span> `;
                            });
                            html += `</div>`;
                        }
                        // ìƒì„¸ ê²½ê¸° ê¸°ë¡
                        if (m.history?.length > 0) {
                            html += `<details style="margin-top:8px;"><summary style="cursor:pointer; font-size:11px; color:#666;">ğŸ“Š ìƒì„¸ ë“ì  ê¸°ë¡ (${m.history.length}ì )</summary>`;
                            html += `<div style="max-height:200px; overflow-y:auto; margin-top:4px; padding:8px; background:#fafafa; border-radius:4px;">`;
                            m.history.forEach((h, hi) => {
                                html += `<div style="padding:4px 8px; margin:2px 0; font-size:11px; background:white; border-radius:3px; display:flex; justify-content:space-between;">`;
                                html += `<span>${hi+1}. ${h.player}${h.set ? ' (ì„¸íŠ¸' + h.set + ')' : ''}</span>`;
                                html += `<span style="color:#1976d2;">+${h.points}ì  â†’ ${h.scoreAfter}</span>`;
                                html += `</div>`;
                            });
                            html += `</div></details>`;
                        }
                        html += `</div>`;
                    });
                    html += `</div>`;
                });
            }
            // ì¼ë°˜ ëŒ€ì§„í‘œ
            else if (p.bracket) {
                html += `<h4 style="margin-bottom:12px;">ğŸ… ëŒ€ì§„í‘œ (${p.bracket.size}ê°•)</h4>`;
                
                p.bracket.rounds.forEach((round, ri) => {
                    const roundName = p.bracket.size / Math.pow(2, ri) <= 2 ? 'ê²°ìŠ¹' :
                                     p.bracket.size / Math.pow(2, ri) <= 4 ? 'ì¤€ê²°ìŠ¹' :
                                     `${p.bracket.size / Math.pow(2, ri)}ê°•`;
                    
                    html += `<div style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px;">`;
                    html += `<strong>${roundName}</strong><br>`;
                    round.forEach(m => {
                        if (m.player1?.isBye || m.player2?.isBye) return;
                        const statusIcon = m.status === 'completed' ? 'âœ…' : 'â³';
                        html += `<div style="padding:4px 0;">`;
                        html += `${statusIcon} ${m.player1?.name || '?'} vs ${m.player2?.name || '?'}`;
                        if (m.winner) html += ` â†’ <strong>${m.winner.name}</strong>`;
                        html += `</div>`;
                    });
                    html += `</div>`;
                });
            } else {
                html += '<p style="text-align:center; padding:20px; color:var(--text-secondary);">ëŒ€ì§„í‘œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
            
            return html;
        }
        
        function renderViewerRecords() {
            const p = currentProject;
            const hasAutoResult = p.autoTournamentResult;
            const isTeam = p.competitionType === 'team';
            
            let html = '';
            
            // ê²€ìƒ‰ í•„ë“œ
            html += `<div style="margin-bottom:16px;">`;
            html += `<input type="text" id="viewer-search" placeholder="ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰..." oninput="filterViewerRecords()" style="width:100%; padding:10px; font-size:14px;" aria-label="ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰">`;
            html += `</div>`;
            
            html += `<div id="viewer-records-list">`;
            
            if (hasAutoResult && p.autoTournamentResult.playerRecords) {
                // ìë™ ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼ê°€ ìˆëŠ” ê²½ìš°
                const records = Object.values(p.autoTournamentResult.playerRecords);
                records.sort((a, b) => (a.finalRank || 999) - (b.finalRank || 999));
                
                records.forEach(r => {
                    html += renderTeamRecordCard(r, isTeam);
                });
            } else if (p.isRandomTeamLeague && p.groups?.length > 0) {
                // ëœë¤ íŒ€ ë¦¬ê·¸ì „ - ìˆ˜ë™ ê²½ê¸° ì§„í–‰ ì¤‘ì¸ ê²½ìš°
                const teamRecords = calculateTeamRecordsFromGroups(p);
                
                // ìŠ¹ìˆ˜, ë“ì‹¤ì°¨ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
                const sorted = Object.values(teamRecords).sort((a, b) => {
                    if (a.wins !== b.wins) return b.wins - a.wins;
                    return (b.pointsFor - b.pointsAgainst) - (a.pointsFor - a.pointsAgainst);
                });
                
                if (sorted.length > 0) {
                    sorted.forEach((r, idx) => {
                        html += renderTeamRecordCard({...r, tempRank: idx + 1}, isTeam);
                    });
                } else {
                    html += '<p style="text-align:center; padding:20px; color:var(--text-secondary);">ì•„ì§ ì™„ë£Œëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            } else {
                // ì¼ë°˜ í†µê³„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                const stats = calculateStatistics();
                if (stats.playerStats?.length > 0) {
                    stats.playerStats.forEach(s => {
                        html += `<div class="viewer-record-item" data-name="${s.name}" style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px;">`;
                        html += `<strong>${s.name}</strong>`;
                        html += `<div style="font-size:13px; margin-top:4px;">`;
                        html += `${s.wins}ìŠ¹ ${s.losses}íŒ¨ (${s.winRate}%)`;
                        html += `</div></div>`;
                    });
                } else {
                    html += '<p style="text-align:center; padding:20px; color:var(--text-secondary);">ê°œì¸ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
            }
            
            html += `</div>`;
            return html;
        }
        
        // íŒ€ë³„ ê²½ê¸° ê¸°ë¡ ì¹´ë“œ ë Œë”ë§
        function renderTeamRecordCard(r, isTeam) {
            let html = '';
            const rankBadge = r.finalRank ? 
                (r.finalRank <= 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][r.finalRank - 1] : `#${r.finalRank}`) : 
                (r.tempRank ? `#${r.tempRank}` : '');
            
            const borderColor = (r.finalRank && r.finalRank <= 3) ? 'gold' : 'var(--primary)';
            
            html += `<div class="viewer-record-item" data-name="${r.name}" style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; border-left:3px solid ${borderColor};">`;
            html += `<div style="display:flex; justify-content:space-between; align-items:center;">`;
            html += `<strong>${rankBadge} ${r.name}</strong>`;
            html += `<span style="font-size:12px; color:var(--text-secondary);">${r.group || ''} ${r.groupRank ? r.groupRank + 'ìœ„' : ''}</span>`;
            html += `</div>`;
            
            // ì „ì  ìš”ì•½
            html += `<div style="font-size:13px; margin-top:6px;">`;
            html += `ì „ì : <strong>${r.wins || r.totalWins || 0}ìŠ¹ ${r.losses || r.totalLosses || 0}íŒ¨</strong>`;
            if (!isTeam && (r.setWins !== undefined)) {
                html += ` | ì„¸íŠ¸: +${r.setWins}/-${r.setLosses}`;
            }
            const pf = r.pointsFor || 0;
            const pa = r.pointsAgainst || 0;
            const diff = pf - pa;
            const diffStr = diff > 0 ? `+${diff}` : diff;
            html += ` | ë“ì‹¤: ${pf}:${pa} (<span style="color:${diff > 0 ? 'green' : diff < 0 ? 'red' : 'black'};">${diffStr}</span>)`;
            html += `</div>`;
            
            // ê²½ê¸° ê¸°ë¡
            const matches = r.matches || [];
            if (matches.length > 0) {
                html += `<details style="margin-top:8px;"><summary style="cursor:pointer; font-size:12px; padding:4px 8px; background:#e8f5e9; border-radius:4px;">ğŸ“‹ ê²½ê¸° ê¸°ë¡ (${matches.length}ê²½ê¸°)</summary>`;
                html += `<div style="margin-top:8px;">`;
                matches.forEach(m => {
                    const color = m.result === 'ìŠ¹' ? '#2e7d32' : '#c62828';
                    const bg = m.result === 'ìŠ¹' ? '#e8f5e9' : '#ffebee';
                    html += `<div style="padding:8px; margin:4px 0; background:${bg}; border-radius:6px; border-left:3px solid ${color};">`;
                    html += `<div style="display:flex; justify-content:space-between; align-items:center;">`;
                    html += `<strong style="color:${color};">${m.result}</strong>`;
                    html += `<span style="font-size:11px; color:var(--text-secondary);">${m.stage || ''}${m.group ? ' ' + m.group : ''}</span>`;
                    html += `</div>`;
                    html += `<div style="margin-top:4px;">vs ${m.opponent}</div>`;
                    html += `<div style="font-size:14px; font-weight:bold; margin-top:4px;">${m.score}</div>`;
                    if (m.setScores?.length > 0) {
                        html += `<div style="font-size:11px; margin-top:4px; color:var(--text-secondary);">`;
                        html += `ì„¸íŠ¸ë³„: ${m.setScores.map((s, i) => '<span style="background:#fff; padding:2px 6px; border-radius:3px; margin:2px;">' + (i+1) + 'ì„¸íŠ¸ ' + s.s1 + '-' + s.s2 + '</span>').join(' ')}`;
                        html += `</div>`;
                    }
                    
                    // ë“ì  íˆìŠ¤í† ë¦¬ê°€ ìˆìœ¼ë©´ í‘œì‹œ
                    if (m.history && m.history.length > 0) {
                        html += `<details style="margin-top:6px;"><summary style="cursor:pointer; font-size:11px; color:var(--primary);">ğŸ¯ ìƒì„¸ ë“ì  ê¸°ë¡ (${m.history.length}ê°œ)</summary>`;
                        html += `<div style="margin-top:6px; max-height:150px; overflow-y:auto; background:white; padding:6px; border-radius:4px;">`;
                        m.history.slice().reverse().forEach(h => {
                            const pColor = h.player === r.name ? '#1976d2' : '#c62828';
                            const pBg = h.player === r.name ? '#e3f2fd' : '#ffebee';
                            html += `<div style="padding:3px 6px; margin:2px 0; background:${pBg}; border-radius:3px; font-size:10px; border-left:2px solid ${pColor};">`;
                            html += `<span style="font-weight:bold;">${h.player}</span> `;
                            html += `${h.scoreBefore} â†’ ${h.scoreAfter}`;
                            if (h.type === 'goal') html += ` (ê³¨ ${h.points}ì )`;
                            else if (h.type) html += ` (${h.type})`;
                            html += `</div>`;
                        });
                        html += `</div></details>`;
                    }
                    
                    html += `</div>`;
                });
                html += `</div></details>`;
            }
            html += `</div>`;
            
            return html;
        }
        
        // ê·¸ë£¹ ê²½ê¸° ë°ì´í„°ì—ì„œ íŒ€ë³„ ê¸°ë¡ ê³„ì‚°
        function calculateTeamRecordsFromGroups(p) {
            const records = {};
            
            // ëª¨ë“  íŒ€ ì´ˆê¸°í™”
            p.teams?.forEach(team => {
                records[team.name] = {
                    name: team.name,
                    group: team.group ? team.group + 'ì¡°' : '',
                    wins: 0,
                    losses: 0,
                    pointsFor: 0,
                    pointsAgainst: 0,
                    matches: []
                };
            });
            
            // ì¡°ë³„ ê²½ê¸°ì—ì„œ ê¸°ë¡ ìˆ˜ì§‘
            p.groups?.forEach((group, gi) => {
                const groupName = group.name || (String.fromCharCode(65 + gi) + 'ì¡°');
                
                group.matches?.forEach(match => {
                    if (match.status !== 'finished') return;
                    
                    const p1 = match.player1Name || match.player1;
                    const p2 = match.player2Name || match.player2;
                    const s1 = match.finalScore?.player1 || match.result?.score1 || 0;
                    const s2 = match.finalScore?.player2 || match.result?.score2 || 0;
                    const history = match.history || [];
                    const setScores = match.setScores || [];
                    
                    // ë ˆì½”ë“œê°€ ì—†ìœ¼ë©´ ìƒì„±
                    if (!records[p1]) records[p1] = { name: p1, group: groupName, wins: 0, losses: 0, pointsFor: 0, pointsAgainst: 0, matches: [] };
                    if (!records[p2]) records[p2] = { name: p2, group: groupName, wins: 0, losses: 0, pointsFor: 0, pointsAgainst: 0, matches: [] };
                    
                    // ìŠ¹íŒ¨ ê¸°ë¡ (history, setScores í¬í•¨)
                    if (s1 > s2) {
                        records[p1].wins++;
                        records[p2].losses++;
                        records[p1].matches.push({ opponent: p2, result: 'ìŠ¹', score: `${s1} - ${s2}`, stage: 'ì¡°ë³„', group: groupName, history: history, setScores: setScores });
                        records[p2].matches.push({ opponent: p1, result: 'íŒ¨', score: `${s2} - ${s1}`, stage: 'ì¡°ë³„', group: groupName, history: history, setScores: setScores });
                    } else {
                        records[p2].wins++;
                        records[p1].losses++;
                        records[p2].matches.push({ opponent: p1, result: 'ìŠ¹', score: `${s2} - ${s1}`, stage: 'ì¡°ë³„', group: groupName, history: history, setScores: setScores });
                        records[p1].matches.push({ opponent: p2, result: 'íŒ¨', score: `${s1} - ${s2}`, stage: 'ì¡°ë³„', group: groupName, history: history, setScores: setScores });
                    }
                    
                    // ë“ì‹¤ì 
                    records[p1].pointsFor += s1;
                    records[p1].pointsAgainst += s2;
                    records[p2].pointsFor += s2;
                    records[p2].pointsAgainst += s1;
                });
            });
            
            // ê²°ì„  í† ë„ˆë¨¼íŠ¸ ê²½ê¸°
            p.bracket?.rounds?.forEach(round => {
                round.matches?.forEach(match => {
                    if (match.status !== 'finished') return;
                    
                    const p1 = match.player1Name || match.player1?.name;
                    const p2 = match.player2Name || match.player2?.name;
                    const s1 = match.finalScore?.player1 || 0;
                    const s2 = match.finalScore?.player2 || 0;
                    const roundName = round.name || 'ê²°ì„ ';
                    const history = match.history || [];
                    const setScores = match.setScores || [];
                    
                    if (!p1 || !p2) return;
                    
                    if (!records[p1]) records[p1] = { name: p1, group: '', wins: 0, losses: 0, pointsFor: 0, pointsAgainst: 0, matches: [] };
                    if (!records[p2]) records[p2] = { name: p2, group: '', wins: 0, losses: 0, pointsFor: 0, pointsAgainst: 0, matches: [] };
                    
                    if (s1 > s2) {
                        records[p1].wins++;
                        records[p2].losses++;
                        records[p1].matches.push({ opponent: p2, result: 'ìŠ¹', score: `${s1} - ${s2}`, stage: roundName, history: history, setScores: setScores });
                        records[p2].matches.push({ opponent: p1, result: 'íŒ¨', score: `${s2} - ${s1}`, stage: roundName, history: history, setScores: setScores });
                    } else {
                        records[p2].wins++;
                        records[p1].losses++;
                        records[p2].matches.push({ opponent: p1, result: 'ìŠ¹', score: `${s2} - ${s1}`, stage: roundName, history: history, setScores: setScores });
                        records[p1].matches.push({ opponent: p2, result: 'íŒ¨', score: `${s1} - ${s2}`, stage: roundName, history: history, setScores: setScores });
                    }
                    
                    records[p1].pointsFor += s1;
                    records[p1].pointsAgainst += s2;
                    records[p2].pointsFor += s2;
                    records[p2].pointsAgainst += s1;
                });
            });
            
            return records;
        }
        
        function filterViewerRecords() {
            const search = document.getElementById('viewer-search')?.value.toLowerCase() || '';
            document.querySelectorAll('.viewer-record-item').forEach(item => {
                const name = item.dataset.name?.toLowerCase() || '';
                item.style.display = name.includes(search) ? 'block' : 'none';
            });
        }
        
        // ========== ëŒ€ì§„ ê´€ë¦¬ í•¨ìˆ˜ ë ==========

        // ========== ëŒ€íšŒ ëŒ€ì§„ ìœ„ìë“œ í•¨ìˆ˜ ==========
        function twNextStep() {
            const tw = window.tournamentWizard;
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (tw.step === 1) {
                const name = document.getElementById('tw-name')?.value.trim();
                if (!name) {
                    alert('ëŒ€íšŒëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                tw.info.name = name;
                tw.info.date = document.getElementById('tw-date')?.value || '';
                tw.info.location = document.getElementById('tw-location')?.value.trim() || '';
                tw.info.rules = document.getElementById('tw-rules')?.value.trim() || '';
                
                // í…œí”Œë¦¿ ëª¨ë“œì—ì„œ í…œí”Œë¦¿ ì„ íƒ í™•ì¸
                if (tw.mode === 'template' && !tw.template) {
                    alert('ëŒ€íšŒ í˜•ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                    return;
                }
            } else if (tw.step === 2) {
                if (tw.participants.length < 2) {
                    alert('ìµœì†Œ 2ëª… ì´ìƒì˜ ì°¸ê°€ìê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }
            } else if (tw.step === 4) {
                // ì„¤ì • ìœ íš¨ì„± ê²€ì‚¬
                if (tw.format === 'group-knockout') {
                    const advanceTotal = tw.groupSettings.groupCount * tw.groupSettings.advanceCount;
                    if (advanceTotal > tw.knockoutSettings.size) {
                        alert(`ì§„ì¶œì ìˆ˜(${advanceTotal}ëª…)ê°€ í† ë„ˆë¨¼íŠ¸ ê·œëª¨(${tw.knockoutSettings.size}ê°•)ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤.`);
                        return;
                    }
                }
            }
            
            tw.step++;
            
            // Step 5 ì§„ì… ì‹œ ëŒ€ì§„í‘œ ìƒì„±
            if (tw.step === 5) {
                generateTWBracket();
            }
            
            render();
        }
        
        function twPrevStep() {
            const tw = window.tournamentWizard;
            if (tw.step > 1) {
                tw.step--;
                render();
            }
        }
        
        function addTWParticipant() {
            const tw = window.tournamentWizard;
            const input = document.getElementById('tw-participant');
            const value = input?.value.trim();
            
            if (!value) return;
            
            // ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì—¬ëŸ¬ ëª… ì²˜ë¦¬
            const names = value.split(',').map(n => n.trim()).filter(n => n);
            names.forEach(name => {
                if (!tw.participants.includes(name)) {
                    tw.participants.push(name);
                }
            });
            
            input.value = '';
            render();
        }
        
        function removeTWParticipant(index) {
            window.tournamentWizard.participants.splice(index, 1);
            render();
        }
        
        function moveTWParticipant(index, direction) {
            const tw = window.tournamentWizard;
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= tw.participants.length) return;
            
            const temp = tw.participants[index];
            tw.participants[index] = tw.participants[newIndex];
            tw.participants[newIndex] = temp;
            render();
        }
        
        function shuffleTWParticipants() {
            const tw = window.tournamentWizard;
            for (let i = tw.participants.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [tw.participants[i], tw.participants[j]] = [tw.participants[j], tw.participants[i]];
            }
            announce('ì°¸ê°€ì ìˆœì„œê°€ ëœë¤ìœ¼ë¡œ ì„ì˜€ìŠµë‹ˆë‹¤');
            render();
        }
        
        function clearTWParticipants() {
            if (confirm('ëª¨ë“  ì°¸ê°€ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                window.tournamentWizard.participants = [];
                render();
            }
        }
        
        // ì»¤ìŠ¤í…€ ì˜ˆì„  ì„¤ì • ì—…ë°ì´íŠ¸
        function updateCustomPreliminary() {
            const tw = window.tournamentWizard;
            const groupCount = parseInt(document.getElementById('tw-custom-groups')?.value) || 4;
            tw.preliminary.groupCount = groupCount;
            tw.preliminary.perGroup = Math.ceil(tw.participants.length / groupCount);
            render();
        }
        
        // ì»¤ìŠ¤í…€ ëŒ€ì§„í‘œ ì´ˆê¸°í™”
        function initCustomBracket() {
            const tw = window.tournamentWizard;
            const size = tw.finals.size || 8;
            const matchCount = size / 2;
            
            tw.finals.customBracket = [];
            
            // ì¡° ë¼ë²¨ ìƒì„±
            const groupLabels = [];
            for (let i = 0; i < tw.preliminary.groupCount; i++) {
                groupLabels.push(String.fromCharCode(65 + i)); // A, B, C, ...
            }
            
            // ê¸°ë³¸ ëŒ€ì§„ ìƒì„± (A1 vs B2, B1 vs A2, ...)
            for (let i = 0; i < matchCount; i++) {
                const g1Idx = (i * 2) % groupLabels.length;
                const g2Idx = (i * 2 + 1) % groupLabels.length;
                
                tw.finals.customBracket.push({
                    matchNum: i + 1,
                    p1Group: groupLabels[g1Idx] || 'A',
                    p1Rank: 1,
                    p2Group: groupLabels[g2Idx] || 'B',
                    p2Rank: 2
                });
            }
        }
        
        // ì»¤ìŠ¤í…€ ëŒ€ì§„ ê°œë³„ ê²½ê¸° ì—…ë°ì´íŠ¸
        function updateCustomBracketMatch(idx, field, value) {
            const tw = window.tournamentWizard;
            if (tw.finals.customBracket && tw.finals.customBracket[idx]) {
                tw.finals.customBracket[idx][field] = value;
            }
        }
        
        // ìë™ ëŒ€ì§„ ë°°ì • (êµì°¨ ì‹œë“œ)
        function autoFillBracket() {
            const tw = window.tournamentWizard;
            const size = tw.finals.size || 8;
            const matchCount = size / 2;
            const groupCount = tw.preliminary.groupCount;
            const advanceCount = tw.preliminary.advanceCount;
            
            // ì¡° ë¼ë²¨
            const groupLabels = [];
            for (let i = 0; i < groupCount; i++) {
                groupLabels.push(String.fromCharCode(65 + i));
            }
            
            tw.finals.customBracket = [];
            
            // êµì°¨ ì‹œë“œ ë°©ì‹ (A1 vs B2, A2 vs B1, C1 vs D2, ...)
            for (let i = 0; i < matchCount; i++) {
                const pairIdx = Math.floor(i / 2);
                const isFirstInPair = i % 2 === 0;
                
                const g1Idx = (pairIdx * 2) % groupCount;
                const g2Idx = (pairIdx * 2 + 1) % groupCount;
                
                if (isFirstInPair) {
                    tw.finals.customBracket.push({
                        matchNum: i + 1,
                        p1Group: groupLabels[g1Idx] || 'A',
                        p1Rank: 1,
                        p2Group: groupLabels[g2Idx] || 'B',
                        p2Rank: Math.min(2, advanceCount)
                    });
                } else {
                    tw.finals.customBracket.push({
                        matchNum: i + 1,
                        p1Group: groupLabels[g1Idx] || 'A',
                        p1Rank: Math.min(2, advanceCount),
                        p2Group: groupLabels[g2Idx] || 'B',
                        p2Rank: 1
                    });
                }
            }
            
            announce('ëŒ€ì§„ì´ ìë™ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
            render();
        }
        
        function setTWFormat(format) {
            window.tournamentWizard.format = format;
            render();
        }
        
        // íŒ€ ë¦¬ê·¸ìš© íŒ€ ìƒì„±
        function generateTWTeams() {
            const tw = window.tournamentWizard;
            const teamCount = tw.info.teamCount || 4;
            const membersPerTeam = tw.info.membersPerTeam || 3;
            const participants = [...tw.participants];
            
            // ëœë¤ íŒ€ ë¦¬ê·¸ì¸ ê²½ìš° ì„ê¸°
            if (tw.info.type === 'random-team') {
                for (let i = participants.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [participants[i], participants[j]] = [participants[j], participants[i]];
                }
            }
            
            // íŒ€ ìƒì„±
            tw.teams = [];
            for (let t = 0; t < teamCount; t++) {
                tw.teams.push({
                    name: `${t + 1}íŒ€`,
                    members: []
                });
            }
            
            // ìŠ¤ë„¤ì´í¬ ë“œë˜í”„íŠ¸ë¡œ ë°°ì •
            participants.forEach((p, idx) => {
                const round = Math.floor(idx / teamCount);
                const teamIdx = round % 2 === 0 ? idx % teamCount : teamCount - 1 - (idx % teamCount);
                if (tw.teams[teamIdx]) {
                    tw.teams[teamIdx].members.push(p);
                }
            });
        }
        
        // íŒ€ ë‹¤ì‹œ ì„ê¸°
        function shuffleTWTeams() {
            const tw = window.tournamentWizard;
            tw.teams = []; // ì´ˆê¸°í™”
            generateTWTeams();
            announce('íŒ€ì´ ë‹¤ì‹œ í¸ì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
            render();
        }
        
        function updateTWSettings() {
            const tw = window.tournamentWizard;
            
            const groupCount = parseInt(document.getElementById('tw-group-count')?.value) || 4;
            const advanceCount = parseInt(document.getElementById('tw-advance')?.value) || 2;
            const knockoutSize = parseInt(document.getElementById('tw-knockout-size')?.value) || 8;
            
            tw.groupSettings.groupCount = groupCount;
            tw.groupSettings.advanceCount = advanceCount;
            tw.groupSettings.perGroup = Math.ceil(tw.participants.length / groupCount);
            tw.knockoutSettings.size = knockoutSize;
            
            updateTWSettingsSummary();
        }
        
        function updateTWSettingsSummary() {
            const tw = window.tournamentWizard;
            const summary = document.getElementById('tw-settings-summary');
            const validation = document.getElementById('tw-knockout-validation');
            
            if (!summary) return;
            
            const unitName = tw.info.type === 'team' ? 'íŒ€' : 'ëª…';
            let html = `<p>â€¢ ì°¸ê°€ì: ${tw.participants.length}${unitName}</p>`;
            
            if (tw.format !== 'knockout-only') {
                html += `<p>â€¢ ì¡° í¸ì„±: ${tw.groupSettings.groupCount}ê°œ ì¡° (ì¡°ë‹¹ ì•½ ${tw.groupSettings.perGroup}${unitName})</p>`;
            }
            
            if (tw.format === 'group-knockout') {
                const advanceTotal = tw.groupSettings.groupCount * tw.groupSettings.advanceCount;
                html += `<p>â€¢ ë³¸ì„  ì§„ì¶œ: ê° ì¡° ìƒìœ„ ${tw.groupSettings.advanceCount}${unitName} (ì´ ${advanceTotal}${unitName})</p>`;
                html += `<p>â€¢ ë³¸ì„ : ${tw.knockoutSettings.size}ê°• í† ë„ˆë¨¼íŠ¸</p>`;
                
                if (validation) {
                    if (advanceTotal > tw.knockoutSettings.size) {
                        validation.innerHTML = `<span style="color:#d32f2f;">âŒ ì§„ì¶œì(${advanceTotal}${unitName})ê°€ í† ë„ˆë¨¼íŠ¸ ê·œëª¨(${tw.knockoutSettings.size}ê°•)ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤!</span>`;
                    } else if (advanceTotal < tw.knockoutSettings.size) {
                        validation.innerHTML = `<span style="color:#ff9800;">âš ï¸ ë¶€ì „ìŠ¹ ${tw.knockoutSettings.size - advanceTotal}${unitName} ë°œìƒ</span>`;
                    } else {
                        validation.innerHTML = `<span style="color:#4caf50;">âœ… ë”± ë§ìŠµë‹ˆë‹¤!</span>`;
                    }
                }
            } else if (tw.format === 'knockout-only') {
                html += `<p>â€¢ ${tw.knockoutSettings.size}ê°• í† ë„ˆë¨¼íŠ¸</p>`;
            }
            
            summary.innerHTML = html;
        }
        
        function generateTWBracket() {
            const tw = window.tournamentWizard;
            const participants = [...tw.participants];
            const isCustom = tw.mode === 'custom';
            
            // ëŒ€íšŒ í˜•ì‹ ê²°ì •
            let tournamentType;
            if (isCustom) {
                tournamentType = tw.preliminary?.enabled ? 'group-knockout' : 'knockout-only';
            } else {
                tournamentType = tw.template || 'group-knockout';
            }
            
            // ì¡° í¸ì„± í•„ìš” ì—¬ë¶€
            const needsGroups = tournamentType !== 'knockout-only';
            
            // ì»¤ìŠ¤í…€ ëª¨ë“œì—ì„œ ì§ì ‘ ì…ë ¥ì´ ì•„ë‹ˆê±°ë‚˜, í…œí”Œë¦¿ ëª¨ë“œë©´ ì„ê¸°
            const shouldShuffle = isCustom ? (tw.preliminary?.groupAssignment === 'random') : true;
            
            if (shouldShuffle) {
                for (let i = participants.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [participants[i], participants[j]] = [participants[j], participants[i]];
                }
            }
            
            // ì¡° í¸ì„±
            if (needsGroups) {
                const groupCount = isCustom ? tw.preliminary.groupCount : (tw.preliminary?.groupCount || 4);
                tw.groups = Array(groupCount).fill(null).map(() => []);
                
                // ìŠ¤ë„¤ì´í¬ ë“œë˜í”„íŠ¸ ë°©ì‹ìœ¼ë¡œ ë°°ì •
                participants.forEach((p, idx) => {
                    const round = Math.floor(idx / groupCount);
                    const groupIdx = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                    tw.groups[groupIdx].push(p);
                });
            }
            
            // í† ë„ˆë¨¼íŠ¸ë§Œì¸ ê²½ìš° ëŒ€ì§„í‘œ ìƒì„±
            if (tournamentType === 'knockout-only') {
                const size = isCustom ? (tw.finals?.size || 8) : (tw.knockoutSettings?.size || participants.length);
                tw.bracket = {
                    size: size,
                    participants: participants.slice(0, size),
                    matches: []
                };
            }
        }
        
        function generateTWPreview() {
            const tw = window.tournamentWizard;
            const isCustom = tw.mode === 'custom';
            let html = '';
            
            // ëŒ€íšŒ í˜•ì‹ ê²°ì •
            let tournamentType;
            if (isCustom) {
                tournamentType = tw.preliminary?.enabled ? 'group-knockout' : 'knockout-only';
            } else {
                tournamentType = tw.template || 'group-knockout';
            }
            
            // ëŒ€íšŒ ê·œì¹™ í‘œì‹œ
            if (tw.info.rules) {
                html += `
                    <div style="background:#e3f2fd; padding:12px; border-radius:8px; margin-bottom:16px;">
                        <div style="font-weight:600; margin-bottom:8px;">ğŸ“‹ ëŒ€íšŒ ê·œì¹™</div>
                        <div style="font-size:13px; white-space:pre-wrap;">${tw.info.rules}</div>
                    </div>
                `;
            }
            
            // ì„¤ì • ìš”ì•½
            html += `
                <div style="background:#f5f5f5; padding:12px; border-radius:8px; margin-bottom:16px;">
                    <div style="font-size:14px;">
                        <strong>ì°¸ê°€ì:</strong> ${tw.participants.length}ëª…<br>
                        ${isCustom && tw.preliminary?.enabled ? `
                            <strong>ì˜ˆì„ :</strong> ${tw.preliminary.groupCount}ê°œ ì¡°, ${tw.preliminary.sets}ì„¸íŠ¸<br>
                            <strong>ë³¸ì„  ì§„ì¶œ:</strong> ê° ì¡° ${tw.preliminary.advanceCount}ëª…${tw.preliminary.wildcards > 0 ? ` + ì™€ì¼ë“œì¹´ë“œ ${tw.preliminary.wildcards}ëª…` : ''}<br>
                            <strong>ë³¸ì„ :</strong> ${tw.finals.size}ê°•, ${tw.finals.sets}ì„¸íŠ¸
                        ` : isCustom ? `
                            <strong>í˜•ì‹:</strong> í† ë„ˆë¨¼íŠ¸ ${tw.finals?.size || 8}ê°•, ${tw.finals?.sets || 5}ì„¸íŠ¸
                        ` : `
                            <strong>í˜•ì‹:</strong> ${tournamentType === 'group-only' ? 'ì¡°ë³„ ë¦¬ê·¸' : tournamentType === 'knockout-only' ? 'í† ë„ˆë¨¼íŠ¸' : 'ì¡°ë³„ ì˜ˆì„  + ë³¸ì„ '}
                        `}
                    </div>
                </div>
            `;
            
            // ì¡°ë³„ ë¦¬ê·¸ ë¯¸ë¦¬ë³´ê¸°
            if (tournamentType !== 'knockout-only' && tw.groups && tw.groups.length > 0) {
                html += `<h4 style="margin:0 0 12px 0;">ğŸ“Š ì¡°ë³„ ë¦¬ê·¸</h4>`;
                html += `<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:20px;">`;
                
                tw.groups.forEach((group, idx) => {
                    const groupName = String.fromCharCode(65 + idx); // A, B, C, ...
                    html += `
                        <div style="background:#f5f5f5; padding:12px; border-radius:8px;">
                            <div style="font-weight:600; margin-bottom:8px; color:#1976d2;">${groupName}ì¡° (${group.length}ëª…)</div>
                            ${group.map((p, i) => `<div style="font-size:13px; padding:4px 0;">${i+1}. ${p}</div>`).join('')}
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                // ì¡°ë³„ ê²½ê¸° ìˆ˜ ê³„ì‚°
                const matchesPerGroup = tw.groups.map(g => g.length * (g.length - 1) / 2);
                const totalGroupMatches = matchesPerGroup.reduce((a, b) => a + b, 0);
                html += `<p style="font-size:13px; color:#666;">ì¡°ë³„ ë¦¬ê·¸ ì´ ${totalGroupMatches}ê²½ê¸°</p>`;
            }
            
            // ë³¸ì„  í† ë„ˆë¨¼íŠ¸ ë¯¸ë¦¬ë³´ê¸°
            if (tournamentType === 'group-knockout') {
                const advanceCount = isCustom ? tw.preliminary.advanceCount : (tw.preliminary?.advanceCount || 2);
                const groupCount = isCustom ? tw.preliminary.groupCount : (tw.preliminary?.groupCount || 4);
                const wildcards = isCustom ? (tw.preliminary.wildcards || 0) : 0;
                const finalsSize = isCustom ? tw.finals.size : (tw.knockoutSettings?.size || 8);
                const advanceTotal = groupCount * advanceCount + wildcards;
                
                html += `
                    <h4 style="margin:20px 0 12px 0;">ğŸ¥Š ë³¸ì„  í† ë„ˆë¨¼íŠ¸</h4>
                    <div style="background:#fff3e0; padding:12px; border-radius:8px;">
                        <p style="margin:0;">â€¢ ${finalsSize}ê°• í† ë„ˆë¨¼íŠ¸</p>
                        <p style="margin:4px 0 0 0;">â€¢ ê° ì¡° ìƒìœ„ ${advanceCount}ëª… ì§„ì¶œ${wildcards > 0 ? ` + ì™€ì¼ë“œì¹´ë“œ ${wildcards}ëª…` : ''} (ì´ ${advanceTotal}ëª…)</p>
                        ${isCustom && tw.finals.customBracket?.length > 0 ? `
                            <p style="margin:8px 0 0 0; font-weight:600;">ì»¤ìŠ¤í…€ ëŒ€ì§„:</p>
                            ${tw.finals.customBracket.slice(0, 4).map((m, i) => `
                                <p style="margin:4px 0 0 0; font-size:13px;">${i+1}ê²½ê¸°: ${m.p1Group}ì¡° ${m.p1Rank}ìœ„ vs ${m.p2Group}ì¡° ${m.p2Rank}ìœ„</p>
                            `).join('')}
                            ${tw.finals.customBracket.length > 4 ? `<p style="margin:4px 0 0 0; font-size:13px; color:#666;">... ì™¸ ${tw.finals.customBracket.length - 4}ê²½ê¸°</p>` : ''}
                        ` : `
                            <p style="margin:4px 0 0 0; font-size:13px; color:#666;">â€» ì¡°ë³„ ë¦¬ê·¸ ì™„ë£Œ í›„ ëŒ€ì§„í‘œ í™•ì •</p>
                        `}
                    </div>
                `;
            } else if (tournamentType === 'knockout-only') {
                const finalsSize = isCustom ? (tw.finals?.size || 8) : (tw.knockoutSettings?.size || 8);
                html += `<h4 style="margin:0 0 12px 0;">ğŸ¥Š í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ</h4>`;
                html += `<div style="background:#fff3e0; padding:12px; border-radius:8px;">`;
                html += `<p style="margin:0;">${finalsSize}ê°• í† ë„ˆë¨¼íŠ¸</p>`;
                
                const bracket = tw.bracket;
                if (bracket && bracket.participants) {
                    html += `<div style="margin-top:12px;">`;
                    for (let i = 0; i < bracket.participants.length; i += 2) {
                        const p1 = bracket.participants[i] || 'BYE';
                        const p2 = bracket.participants[i + 1] || 'BYE';
                        html += `<div style="font-size:13px; padding:6px 0; border-bottom:1px solid #eee;">${i/2+1}ê²½ê¸°: ${p1} vs ${p2}</div>`;
                    }
                    html += `</div>`;
                }
                html += `</div>`;
            }
            
            return html;
        }
        
        function confirmTournament() {
            const tw = window.tournamentWizard;
            
            if (!confirm('ëŒ€ì§„í‘œë¥¼ í™•ì •í•˜ê³  ëŒ€íšŒë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            // ì„¸íŠ¸ ìˆ˜ ê²°ì • (ì»¤ìŠ¤í…€ ëª¨ë“œ vs í…œí”Œë¦¿ ëª¨ë“œ)
            const isCustom = tw.mode === 'custom';
            const preliminarySets = isCustom ? (tw.preliminary?.sets || 3) : (tw.preliminary?.sets || 3);
            const finalsSets = isCustom ? (tw.finals?.sets || 5) : (tw.preliminary?.sets || 3);
            const isTeam = tw.info.type === 'team';
            const winScore = isTeam ? 31 : 11;
            
            // ëŒ€íšŒ í˜•ì‹ ê²°ì •
            let tournamentType;
            if (isCustom) {
                tournamentType = tw.preliminary?.enabled ? 'group-knockout' : 'knockout-only';
            } else {
                tournamentType = tw.template || 'group-knockout';
            }
            
            // í”„ë¡œì íŠ¸ ìƒì„±
            const project = {
                id: Date.now(),
                name: tw.info.name,
                date: tw.info.date,
                location: tw.info.location,
                rules: tw.info.rules || '',
                competitionType: isTeam ? 'team' : 'individual',
                players: !isTeam ? tw.participants : [],
                teams: isTeam ? tw.participants.map(t => ({ name: t, players: [] })) : [],
                tournamentType: tournamentType,
                groups: [],
                matches: [],
                bracket: tw.bracket,
                customBracket: tw.finals?.customBracket || [],
                preliminarySets: preliminarySets,
                finalsSets: finalsSets,
                advanceCount: tw.preliminary?.advanceCount || 2,
                wildcards: tw.preliminary?.wildcards || 0,
                sameGroupAvoid: tw.finals?.sameGroupAvoid || 'quarterfinal',
                // âœ¨ ì‹¬íŒ ë° ê²½ê¸°ì¥ ì •ë³´ ì¶”ê°€
                referees: tw.referees || [],
                courts: tw.courts || [],
                createdAt: new Date().toISOString()
            };
            
            // ì¡° í¸ì„± (ì»¤ìŠ¤í…€ ë˜ëŠ” í…œí”Œë¦¿ ëª¨ë‘)
            const needsGroups = (isCustom && tw.preliminary?.enabled) || 
                               (!isCustom && tournamentType !== 'knockout-only');
            
            if (needsGroups) {
                const participants = [...tw.participants];
                const groupCount = isCustom ? tw.preliminary.groupCount : (tw.preliminary?.groupCount || 4);
                
                // í¸ì„± ë°©ì‹ì— ë”°ë¼ ì²˜ë¦¬
                if (isCustom && tw.preliminary.groupAssignment === 'random') {
                    for (let i = participants.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [participants[i], participants[j]] = [participants[j], participants[i]];
                    }
                } else if (!isCustom) {
                    // í…œí”Œë¦¿ ëª¨ë“œëŠ” ê¸°ë³¸ ëœë¤
                    for (let i = participants.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [participants[i], participants[j]] = [participants[j], participants[i]];
                    }
                }
                
                // ìŠ¤ë„¤ì´í¬ ë“œë˜í”„íŠ¸ë¡œ ì¡° ë°°ì •
                const groups = Array(groupCount).fill(null).map(() => []);
                participants.forEach((p, idx) => {
                    const round = Math.floor(idx / groupCount);
                    const groupIdx = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                    groups[groupIdx].push(p);
                });
                
                project.groups = groups.map((members, idx) => ({
                    name: String.fromCharCode(65 + idx) + 'ì¡°',
                    members: members,
                    matches: [],
                    standings: []
                }));
                
                // ì¡°ë³„ ë¦¬ê·¸ ê²½ê¸° ìƒì„±
                project.groups.forEach((group, gIdx) => {
                    const members = group.members;
                    for (let i = 0; i < members.length; i++) {
                        for (let j = i + 1; j < members.length; j++) {
                            const match = {
                                id: Date.now() + gIdx * 1000 + i * 100 + j,
                                player1Name: members[i],
                                player2Name: members[j],
                                type: isTeam ? 'team' : 'individual',
                                sets: isTeam ? 1 : preliminarySets,
                                winScore: winScore,
                                currentSet: 1,
                                setScores: [{ player1: 0, player2: 0 }],
                                currentServe: 'player1',
                                serveCount: 0,
                                serveSelected: false,
                                timeouts: { player1: 1, player2: 1 },
                                history: [],
                                status: 'pending',
                                groupIndex: gIdx,
                                groupName: group.name,
                                phase: 'preliminary',
                                refereePin: generatePin()
                            };
                            project.matches.push(match);
                            group.matches.push(match.id);
                        }
                    }
                });
            }
            
            // í† ë„ˆë¨¼íŠ¸ë§Œì¸ ê²½ìš° ë°”ë¡œ ë³¸ì„  ê²½ê¸° ìƒì„±
            if (tournamentType === 'knockout-only') {
                const participants = [...tw.participants];
                const size = isCustom ? (tw.finals?.size || 8) : (tw.knockoutSettings?.size || participants.length);
                
                // ëœë¤ ì„ê¸°
                for (let i = participants.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [participants[i], participants[j]] = [participants[j], participants[i]];
                }
                
                for (let i = 0; i < Math.min(participants.length, size); i += 2) {
                    const p1 = participants[i];
                    const p2 = participants[i + 1];
                    
                    if (p1 && p2) {
                        const match = {
                            id: Date.now() + i,
                            player1Name: p1,
                            player2Name: p2,
                            type: isTeam ? 'team' : 'individual',
                            sets: isTeam ? 1 : finalsSets,
                            winScore: winScore,
                            currentSet: 1,
                            setScores: [{ player1: 0, player2: 0 }],
                            currentServe: 'player1',
                            serveCount: 0,
                            serveSelected: false,
                            timeouts: { player1: 1, player2: 1 },
                            history: [],
                            status: 'pending',
                            bracketRound: 1,
                            bracketMatchNum: i / 2 + 1,
                            phase: 'finals',
                            refereePin: generatePin()
                        };
                        project.matches.push(match);
                    }
                }
            }
            
            // í”„ë¡œì íŠ¸ ì €ì¥
            projects.push(project);
            saveProjects();
            
            // ìœ„ìë“œ ì´ˆê¸°í™”
            window.tournamentWizard = null;
            
            // ìƒì„±ëœ í”„ë¡œì íŠ¸ë¡œ ì´ë™
            currentProject = project;
            announce(`${project.name} ëŒ€íšŒê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ${project.matches.length}ê²½ê¸°`);
            goTo('bracket-detail');
        }
        
        function generatePin() {
            return Math.random().toString().slice(2, 6);
        }
        
        // ========== ëŒ€ì§„ ì„¤ì • ëª¨ë“œ í•¨ìˆ˜ ==========
        let bracketModeAuth = false;
        
        function enterBracketMode() {
            const savedPin = localStorage.getItem('bracketPin');
            if (!savedPin) {
                // ë¹„ë°€ë²ˆí˜¸ ë¯¸ì„¤ì • - ì„¤ì • í™”ë©´ìœ¼ë¡œ
                goTo('bracket-set-password');
            } else {
                // ë¹„ë°€ë²ˆí˜¸ ìˆìŒ - ì¸ì¦ í™”ë©´ìœ¼ë¡œ
                goTo('bracket-password');
            }
        }
        
        function verifyBracketPin() {
            const input = document.getElementById('bracket-pin')?.value;
            const savedPin = localStorage.getItem('bracketPin');
            
            if (input === savedPin) {
                bracketModeAuth = true;
                announce('ëŒ€ì§„ ì„¤ì • ëª¨ë“œ ì§„ì…');
                goTo('bracket-home');
            } else {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                document.getElementById('bracket-pin').value = '';
                document.getElementById('bracket-pin').focus();
            }
        }
        
        function checkPasswordStrength() {
            const pw = document.getElementById('new-bracket-pin')?.value || '';
            const display = document.getElementById('pw-strength');
            if (!display) return;
            
            const checks = {
                length: pw.length >= 8,
                upper: /[A-Z]/.test(pw),
                lower: /[a-z]/.test(pw),
                number: /[0-9]/.test(pw),
                special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pw)
            };
            
            const passed = Object.values(checks).filter(v => v).length;
            
            let html = '';
            html += `<div style="color:${checks.length ? '#4caf50' : '#999'};">${checks.length ? 'âœ…' : 'â¬œ'} 8ì ì´ìƒ</div>`;
            html += `<div style="color:${checks.upper ? '#4caf50' : '#999'};">${checks.upper ? 'âœ…' : 'â¬œ'} ì˜ë¬¸ ëŒ€ë¬¸ì</div>`;
            html += `<div style="color:${checks.lower ? '#4caf50' : '#999'};">${checks.lower ? 'âœ…' : 'â¬œ'} ì˜ë¬¸ ì†Œë¬¸ì</div>`;
            html += `<div style="color:${checks.number ? '#4caf50' : '#999'};">${checks.number ? 'âœ…' : 'â¬œ'} ìˆ«ì</div>`;
            html += `<div style="color:${checks.special ? '#4caf50' : '#999'};">${checks.special ? 'âœ…' : 'â¬œ'} íŠ¹ìˆ˜ë¬¸ì</div>`;
            
            if (passed === 5) {
                html += `<div style="color:#4caf50; font-weight:600; margin-top:8px;">ğŸ”’ ê°•ë ¥í•œ ë¹„ë°€ë²ˆí˜¸!</div>`;
            }
            
            display.innerHTML = html;
        }
        
        function validatePassword(pw) {
            if (pw.length < 8) return 'ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
            if (!/[A-Z]/.test(pw)) return 'ì˜ë¬¸ ëŒ€ë¬¸ìë¥¼ 1ê°œ ì´ìƒ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
            if (!/[a-z]/.test(pw)) return 'ì˜ë¬¸ ì†Œë¬¸ìë¥¼ 1ê°œ ì´ìƒ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
            if (!/[0-9]/.test(pw)) return 'ìˆ«ìë¥¼ 1ê°œ ì´ìƒ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pw)) return 'íŠ¹ìˆ˜ë¬¸ìë¥¼ 1ê°œ ì´ìƒ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.';
            return null;
        }
        
        function setBracketPin() {
            const newPin = document.getElementById('new-bracket-pin')?.value;
            const confirmPin = document.getElementById('confirm-bracket-pin')?.value;
            
            const error = validatePassword(newPin);
            if (error) {
                alert(error);
                return;
            }
            
            if (newPin !== confirmPin) {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            
            localStorage.setItem('bracketPin', newPin);
            bracketModeAuth = true;
            announce('ë¹„ë°€ë²ˆí˜¸ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤');
            goTo('bracket-home');
        }
        
        // ========== ì‹¬íŒ ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬ ==========
        function logout() {
            sessionStorage.removeItem('refereePin');
            sessionStorage.removeItem('refereeAuth');
            isAuthenticated = false;
            userRole = null;
            announce('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤');
            goTo('home');
        }
        
        function verifyRefereePassword() {
            const pin = document.getElementById('referee-pin')?.value;
            const password = document.getElementById('referee-password')?.value;
            const refPasswords = JSON.parse(localStorage.getItem('refereePasswords') || '{}');
            
            if (!pin) {
                alert('ì‹¬íŒì„ ì„ íƒí•´ì£¼ì„¸ìš”');
                return;
            }
            
            if (!password) {
                alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            if (!refPasswords[pin]) {
                alert('ë“±ë¡ë˜ì§€ ì•Šì€ ì‹¬íŒì…ë‹ˆë‹¤');
                return;
            }
            
            if (refPasswords[pin] !== password) {
                alert('âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                document.getElementById('referee-password').value = '';
                document.getElementById('referee-password').focus();
                return;
            }
            
            // ì¸ì¦ ì„±ê³µ
            isAuthenticated = true;
            sessionStorage.setItem('refereePin', pin);
            sessionStorage.setItem('refereeAuth', 'true');
            announce('âœ… ì‹¬íŒ ì¸ì¦ ì™„ë£Œ');
            screen = 'referee-home';
            render();
        }
        
        // ì‹¬íŒ ë¹„ë°€ë²ˆí˜¸ ì¶”ê°€ (ê´€ë¦¬ììš©)
        function addRefereePassword() {
            const pin = prompt('ì‹¬íŒ PINì„ ì…ë ¥í•˜ì„¸ìš”:\n(ì˜ˆ: REF001, ì‹¬íŒ1)');
            if (!pin) return;
            
            const password = prompt('ì‹¬íŒ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n(8ì ì´ìƒ, ëŒ€ì†Œë¬¸ì+ìˆ«ì+íŠ¹ìˆ˜ë¬¸ì)');
            if (!password) return;
            
            const error = validatePassword(password);
            if (error) {
                alert(error);
                return;
            }
            
            const confirmPassword = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”:');
            if (confirmPassword !== password) {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                return;
            }
            
            const refPasswords = JSON.parse(localStorage.getItem('refereePasswords') || '{}');
            if (refPasswords[pin]) {
                alert('ì´ë¯¸ ë“±ë¡ëœ ì‹¬íŒì…ë‹ˆë‹¤');
                return;
            }
            
            refPasswords[pin] = password;
            localStorage.setItem('refereePasswords', JSON.stringify(refPasswords));
            announce(`âœ… ${pin} ì‹¬íŒì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤`);
        }
        
        // ì‹¬íŒ ë¹„ë°€ë²ˆí˜¸ ì‚­ì œ (ê´€ë¦¬ììš©)
        function deleteRefereePassword() {
            const refPasswords = JSON.parse(localStorage.getItem('refereePasswords') || '{}');
            const pins = Object.keys(refPasswords);
            
            if (pins.length === 0) {
                alert('ë“±ë¡ëœ ì‹¬íŒì´ ì—†ìŠµë‹ˆë‹¤');
                return;
            }
            
            const pinList = pins.join('\n');
            const pin = prompt(`ì‚­ì œí•  ì‹¬íŒ PINì„ ì…ë ¥í•˜ì„¸ìš”:\n\në“±ë¡ëœ ì‹¬íŒ:\n${pinList}`);
            
            if (!pin) return;
            
            if (!refPasswords[pin]) {
                alert('ë“±ë¡ë˜ì§€ ì•Šì€ ì‹¬íŒì…ë‹ˆë‹¤');
                return;
            }
            
            if (!confirm(`${pin} ì‹¬íŒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            delete refPasswords[pin];
            localStorage.setItem('refereePasswords', JSON.stringify(refPasswords));
            announce(`âœ… ${pin} ì‹¬íŒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`);
        }
        
        // ì‹¬íŒ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ (ì‹¬íŒ ìì‹ )
        function changeRefereePassword() {
            const pin = sessionStorage.getItem('refereePin');
            const currentPassword = prompt('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (!currentPassword) return;
            
            const refPasswords = JSON.parse(localStorage.getItem('refereePasswords') || '{}');
            
            if (refPasswords[pin] !== currentPassword) {
                alert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                return;
            }
            
            const newPassword = prompt('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:\n(8ì ì´ìƒ, ëŒ€ì†Œë¬¸ì+ìˆ«ì+íŠ¹ìˆ˜ë¬¸ì)');
            if (!newPassword) return;
            
            const error = validatePassword(newPassword);
            if (error) {
                alert(error);
                return;
            }
            
            const confirmPassword = prompt('ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”:');
            if (confirmPassword !== newPassword) {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
                return;
            }
            
            refPasswords[pin] = newPassword;
            localStorage.setItem('refereePasswords', JSON.stringify(refPasswords));
            announce('âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        
        // ========== ì„ ìˆ˜ ì¼ì • ì¡°íšŒ í•¨ìˆ˜ ==========
        function onScheduleProjectChange() {
            const select = document.getElementById('schedule-project');
            const area = document.getElementById('participant-select-area');
            const nameSelect = document.getElementById('schedule-name-select');
            const result = document.getElementById('schedule-result');
            
            if (!select.value) {
                area.style.display = 'none';
                result.innerHTML = '';
                return;
            }
            
            const project = projects[parseInt(select.value)];
            if (!project) return;
            
            area.style.display = 'block';
            result.innerHTML = '';
            
            // ì°¸ê°€ì ëª©ë¡ ìˆ˜ì§‘
            let participants = [];
            if (project.groups && project.groups.length > 0) {
                project.groups.forEach(g => {
                    participants = participants.concat(g.members || []);
                });
            } else if (project.players && project.players.length > 0) {
                participants = project.players;
            } else if (project.teams && project.teams.length > 0) {
                participants = project.teams.map(t => t.name || t);
            }
            
            // ì¤‘ë³µ ì œê±°
            participants = [...new Set(participants)];
            
            // ì •ë ¬
            participants.sort((a, b) => a.localeCompare(b, 'ko'));
            
            nameSelect.innerHTML = '<option value="">-- ëª©ë¡ì—ì„œ ì„ íƒ --</option>' + 
                participants.map(p => `<option value="${p}">${p}</option>`).join('');
        }
        
        function onScheduleNameSelect() {
            const select = document.getElementById('schedule-name-select');
            const input = document.getElementById('schedule-name-input');
            if (select.value) {
                input.value = select.value;
            }
        }
        
        function lookupSchedule() {
            const projectIdx = document.getElementById('schedule-project')?.value;
            const name = document.getElementById('schedule-name-input')?.value.trim() || 
                         document.getElementById('schedule-name-select')?.value;
            
            if (!projectIdx || !name) {
                alert('ëŒ€íšŒì™€ ì´ë¦„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const project = projects[parseInt(projectIdx)];
            if (!project) return;
            
            const resultDiv = document.getElementById('schedule-result');
            
            // í•´ë‹¹ ì„ ìˆ˜ì˜ ê²½ê¸° ì°¾ê¸°
            const myMatches = project.matches.filter(m => 
                m.player1Name === name || m.player2Name === name
            );
            
            if (myMatches.length === 0) {
                resultDiv.innerHTML = `
                    <div style="text-align:center; padding:20px; background:#fff3e0; border-radius:8px;">
                        <span style="font-size:24px;">ğŸ”</span>
                        <p style="margin-top:8px;">"${name}"ì˜ ê²½ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p style="font-size:13px; color:#666;">ì´ë¦„ì„ ì •í™•íˆ ì…ë ¥í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }
            
            // ê²½ê¸° ë¶„ë¥˜
            const pending = myMatches.filter(m => m.status !== 'completed');
            const completed = myMatches.filter(m => m.status === 'completed');
            
            // ë‹¤ìŒ ê²½ê¸° (ëŒ€ê¸° ì¤‘ì¸ ì²« ë²ˆì§¸ ê²½ê¸°)
            const nextMatch = pending[0];
            
            // ì „ì  ê³„ì‚°
            let wins = 0, losses = 0;
            completed.forEach(m => {
                const isP1 = m.player1Name === name;
                const p1Sets = m.setScores.filter(s => s.player1 > s.player2).length;
                const p2Sets = m.setScores.filter(s => s.player2 > s.player1).length;
                if ((isP1 && p1Sets > p2Sets) || (!isP1 && p2Sets > p1Sets)) {
                    wins++;
                } else if (p1Sets !== p2Sets) {
                    losses++;
                }
            });
            
            // ë‚´ ì¡° ì°¾ê¸°
            let myGroup = null;
            if (project.groups) {
                project.groups.forEach(g => {
                    if (g.members && g.members.includes(name)) {
                        myGroup = g;
                    }
                });
            }
            
            // í† ë„ˆë¨¼íŠ¸ ë¼ìš´ë“œ ì •ë³´
            const knockoutMatches = project.matches.filter(m => m.bracketRound);
            const maxRound = knockoutMatches.length > 0 ? Math.max(...knockoutMatches.map(m => m.bracketRound)) : 0;
            
            // ê²°ê³¼ í‘œì‹œ
            let html = `
                <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:16px; border-radius:12px; margin-bottom:16px;">
                    <div style="font-size:24px; font-weight:700;">${name}</div>
                    ${myGroup ? `<div style="opacity:0.9; margin-top:4px;">${myGroup.name}</div>` : ''}
                    <div style="display:flex; gap:16px; margin-top:12px;">
                        <div style="text-align:center;">
                            <div style="font-size:20px; font-weight:600;">${wins}</div>
                            <div style="font-size:12px; opacity:0.8;">ìŠ¹</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:20px; font-weight:600;">${losses}</div>
                            <div style="font-size:12px; opacity:0.8;">íŒ¨</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:20px; font-weight:600;">${myMatches.length}</div>
                            <div style="font-size:12px; opacity:0.8;">ì´ ê²½ê¸°</div>
                        </div>
                    </div>
                </div>
            `;
            
            // ë‹¤ìŒ ê²½ê¸°
            if (nextMatch) {
                const opponent = nextMatch.player1Name === name ? nextMatch.player2Name : nextMatch.player1Name;
                const isTBD = opponent === 'TBD';
                const roundName = nextMatch.bracketRound ? getRoundName(nextMatch.bracketRound, maxRound + 1) : null;
                
                html += `
                    <div style="background:#e3f2fd; padding:16px; border-radius:8px; margin-bottom:16px;">
                        <div style="font-weight:600; margin-bottom:8px;">â­ï¸ ë‹¤ìŒ ê²½ê¸°</div>
                        <div style="font-size:18px; font-weight:600;">
                            ${isTBD ? 'ğŸ”œ ìƒëŒ€ ë¯¸ì • (ì´ì „ ê²½ê¸° ê²°ê³¼ ëŒ€ê¸° ì¤‘)' : `vs ${opponent}`}
                        </div>
                        <div style="font-size:13px; color:#666; margin-top:4px;">
                            ${roundName ? `ğŸ† ${roundName}` : ''}
                            ${nextMatch.groupName ? nextMatch.groupName : ''}
                        </div>
                    </div>
                `;
            } else if (project.tournamentType === 'group-knockout' && myGroup) {
                // ì¡°ë³„ ë¦¬ê·¸ ì§„í–‰ ì¤‘ì´ë©´ ë³¸ì„  ì§„ì¶œ ì•ˆë‚´
                const groupMatches = project.matches.filter(m => m.groupIndex !== undefined);
                const completedGroupMatches = groupMatches.filter(m => m.status === 'completed');
                
                if (completedGroupMatches.length < groupMatches.length) {
                    html += `
                        <div style="background:#fff3e0; padding:16px; border-radius:8px; margin-bottom:16px;">
                            <div style="font-weight:600; margin-bottom:8px;">ğŸ“Š ì¡°ë³„ ë¦¬ê·¸ ì§„í–‰ ì¤‘</div>
                            <div style="font-size:14px; color:#666;">
                                ì¡°ë³„ ë¦¬ê·¸ ì™„ë£Œ í›„ ë³¸ì„  í† ë„ˆë¨¼íŠ¸ê°€ ì‹œì‘ë©ë‹ˆë‹¤.
                            </div>
                        </div>
                    `;
                }
            }
            
            // ëŒ€ê¸° ì¤‘ì¸ ê²½ê¸°
            if (pending.length > 0) {
                html += `
                    <div style="margin-bottom:16px;">
                        <h4 style="margin:0 0 8px 0;">â³ ëŒ€ê¸° ì¤‘ì¸ ê²½ê¸° (${pending.length})</h4>
                        ${pending.map(m => {
                            const opponent = m.player1Name === name ? m.player2Name : m.player1Name;
                            const isTBD = opponent === 'TBD';
                            const roundName = m.bracketRound ? getRoundName(m.bracketRound, maxRound + 1) : null;
                            
                            return `
                                <div style="padding:10px; margin:4px 0; background:#fff3e0; border-radius:6px; display:flex; justify-content:space-between; align-items:center;">
                                    <span>${isTBD ? 'ğŸ”œ ìƒëŒ€ ë¯¸ì •' : `vs ${opponent}`}</span>
                                    <span style="font-size:12px; color:#666;">
                                        ${roundName ? `ğŸ† ${roundName}` : ''}
                                        ${m.groupName || ''}
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            // ì™„ë£Œëœ ê²½ê¸°
            if (completed.length > 0) {
                html += `
                    <div>
                        <h4 style="margin:0 0 8px 0;">âœ… ì™„ë£Œëœ ê²½ê¸° (${completed.length})</h4>
                        ${completed.filter(m => !m.isBye).map(m => {
                            const isP1 = m.player1Name === name;
                            const opponent = isP1 ? m.player2Name : m.player1Name;
                            const scores = m.setScores.map(s => isP1 ? `${s.player1}-${s.player2}` : `${s.player2}-${s.player1}`).join(', ');
                            const p1Sets = m.setScores.filter(s => s.player1 > s.player2).length;
                            const p2Sets = m.setScores.filter(s => s.player2 > s.player1).length;
                            const won = (isP1 && p1Sets > p2Sets) || (!isP1 && p2Sets > p1Sets);
                            const roundName = m.bracketRound ? getRoundName(m.bracketRound, maxRound + 1) : null;
                            
                            return `
                                <div style="padding:10px; margin:4px 0; background:${won ? '#e8f5e9' : '#ffebee'}; border-radius:6px;">
                                    <div style="display:flex; justify-content:space-between;">
                                        <span>${won ? 'ğŸ†' : ''} vs ${opponent}</span>
                                        <span style="font-weight:600; color:${won ? '#4caf50' : '#f44336'};">${won ? 'ìŠ¹' : 'íŒ¨'}</span>
                                    </div>
                                    <div style="font-size:12px; color:#666; margin-top:4px;">
                                        ${roundName ? `${roundName} Â· ` : ''}${m.groupName ? `${m.groupName} Â· ` : ''}${scores}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            resultDiv.innerHTML = html;
        }
        // ========== ì„ ìˆ˜ ì¼ì • ì¡°íšŒ í•¨ìˆ˜ ë ==========
        
        // ========== í† ë„ˆë¨¼íŠ¸ ì§„í–‰ í•¨ìˆ˜ ==========
        function processTournamentProgression(match, winner) {
            if (!currentProject) return;
            
            const p = currentProject;
            
            // 1. í† ë„ˆë¨¼íŠ¸ ê²½ê¸°ì¸ ê²½ìš° ë‹¤ìŒ ë¼ìš´ë“œ ì²˜ë¦¬
            if (match.bracketRound) {
                advanceTournamentWinner(p, match, winner);
            }
            
            // 2. ì¡°ë³„ ë¦¬ê·¸ ê²½ê¸°ì¸ ê²½ìš° ì¡°ë³„ ë¦¬ê·¸ ì™„ë£Œ ì—¬ë¶€ ì²´í¬
            if (match.groupIndex !== undefined && p.tournamentType === 'group-knockout') {
                checkGroupStageCompletion(p);
            }
        }
        
        function advanceTournamentWinner(project, match, winner) {
            const currentRound = match.bracketRound;
            const matchNum = match.bracketMatchNum;
            const nextRound = currentRound + 1;
            const nextMatchNum = Math.ceil(matchNum / 2);
            
            // ë‹¤ìŒ ë¼ìš´ë“œ ê²½ê¸° ì°¾ê¸°
            let nextMatch = project.matches.find(m => 
                m.bracketRound === nextRound && m.bracketMatchNum === nextMatchNum
            );
            
            // ë‹¤ìŒ ë¼ìš´ë“œ ê²½ê¸°ê°€ ì—†ìœ¼ë©´ ìƒì„±
            if (!nextMatch) {
                // ê²°ìŠ¹ì „ ì´í›„ëŠ” ë” ì´ìƒ ê²½ê¸° ì—†ìŒ
                const remainingMatches = project.matches.filter(m => 
                    m.bracketRound === currentRound && m.status !== 'completed'
                );
                
                // ê°™ì€ ë¼ìš´ë“œì— ë‹¤ë¥¸ ê²½ê¸°ê°€ ë‚¨ì•„ìˆëŠ”ì§€ í™•ì¸
                const sameRoundCompleted = project.matches.filter(m => 
                    m.bracketRound === currentRound && m.status === 'completed'
                ).length;
                
                const totalInRound = project.matches.filter(m => m.bracketRound === currentRound).length;
                
                // ê²°ìŠ¹ì „(1ê²½ê¸°ë§Œ ìˆëŠ” ë¼ìš´ë“œ)ì´ë©´ ì¢…ë£Œ
                if (totalInRound === 1) {
                    project.tournamentWinner = winner;
                    announce(`ğŸ† ìš°ìŠ¹: ${winner}!`);
                    return;
                }
                
                // ë‹¤ìŒ ë¼ìš´ë“œ ê²½ê¸° ìƒì„±
                nextMatch = {
                    id: Date.now() + nextRound * 100 + nextMatchNum,
                    player1Name: matchNum % 2 === 1 ? winner : 'TBD',
                    player2Name: matchNum % 2 === 0 ? winner : 'TBD',
                    type: project.competitionType,
                    sets: project.competitionType === 'individual' ? 3 : 1,
                    winScore: project.competitionType === 'individual' ? 11 : 31,
                    currentSet: 1,
                    setScores: [{ player1: 0, player2: 0 }],
                    currentServe: 'player1',
                    serveCount: 0,
                    serveSelected: false,
                    timeouts: { player1: 1, player2: 1 },
                    history: [],
                    status: 'pending',
                    bracketRound: nextRound,
                    bracketMatchNum: nextMatchNum,
                    refereePin: generatePin()
                };
                project.matches.push(nextMatch);
            } else {
                // ê¸°ì¡´ ë‹¤ìŒ ë¼ìš´ë“œ ê²½ê¸°ì— ìŠ¹ì ë°°ì •
                if (matchNum % 2 === 1) {
                    nextMatch.player1Name = winner;
                } else {
                    nextMatch.player2Name = winner;
                }
                
                // ë‘ ì„ ìˆ˜ ëª¨ë‘ ê²°ì •ë˜ë©´ ê²½ê¸° ì¤€ë¹„ ì™„ë£Œ
                if (nextMatch.player1Name !== 'TBD' && nextMatch.player2Name !== 'TBD') {
                    nextMatch.status = 'ready';
                }
            }
        }
        
        function checkGroupStageCompletion(project) {
            if (!project.groups || project.groups.length === 0) return;
            
            // ì¡°ë³„ ë¦¬ê·¸ ê²½ê¸°ê°€ ëª¨ë‘ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
            const groupMatches = project.matches.filter(m => m.groupIndex !== undefined);
            const completedGroupMatches = groupMatches.filter(m => m.status === 'completed');
            
            if (groupMatches.length === 0 || completedGroupMatches.length < groupMatches.length) {
                return; // ì•„ì§ ì¡°ë³„ ë¦¬ê·¸ ì§„í–‰ ì¤‘
            }
            
            // ì´ë¯¸ ë³¸ì„  ìƒì„±ë¨?
            const knockoutMatches = project.matches.filter(m => m.bracketRound);
            if (knockoutMatches.length > 0) return;
            
            // ì¡°ë³„ ìˆœìœ„ ê³„ì‚° ë° ë³¸ì„  ì§„ì¶œì ê²°ì •
            const advanceCount = project.groupSettings?.advanceCount || 2;
            const knockoutSize = project.knockoutSettings?.size || 8;
            
            const advancers = [];
            
            project.groups.forEach((group, gIdx) => {
                const standings = calculateGroupStandings(project, gIdx);
                const groupAdvancers = standings.slice(0, advanceCount);
                advancers.push(...groupAdvancers.map((s, rank) => ({
                    name: s.name,
                    group: group.name,
                    rank: rank + 1,
                    seed: gIdx * advanceCount + rank + 1
                })));
            });
            
            // ë³¸ì„  ëŒ€ì§„í‘œ ìƒì„± (ì‹œë“œ ë°°ì •)
            generateKnockoutBracket(project, advancers, knockoutSize);
            
            announce(`ì¡°ë³„ ë¦¬ê·¸ ì™„ë£Œ! ë³¸ì„  ${knockoutSize}ê°• ëŒ€ì§„í‘œ ìƒì„±`);
        }
        
        function calculateGroupStandings(project, groupIndex) {
            const group = project.groups[groupIndex];
            if (!group) return [];
            
            const records = {};
            group.members.forEach(m => {
                records[m] = { name: m, wins: 0, losses: 0, setsWon: 0, setsLost: 0, pointsFor: 0, pointsAgainst: 0 };
            });
            
            const groupMatches = project.matches.filter(m => 
                m.groupIndex === groupIndex && m.status === 'completed'
            );
            
            groupMatches.forEach(m => {
                const p1 = m.player1Name;
                const p2 = m.player2Name;
                
                if (!records[p1] || !records[p2]) return;
                
                let p1Sets = 0, p2Sets = 0;
                m.setScores.forEach(s => {
                    if (s.player1 > s.player2) p1Sets++;
                    else if (s.player2 > s.player1) p2Sets++;
                    
                    records[p1].pointsFor += s.player1;
                    records[p1].pointsAgainst += s.player2;
                    records[p2].pointsFor += s.player2;
                    records[p2].pointsAgainst += s.player1;
                });
                
                records[p1].setsWon += p1Sets;
                records[p1].setsLost += p2Sets;
                records[p2].setsWon += p2Sets;
                records[p2].setsLost += p1Sets;
                
                if (p1Sets > p2Sets) {
                    records[p1].wins++;
                    records[p2].losses++;
                } else {
                    records[p2].wins++;
                    records[p1].losses++;
                }
            });
            
            // ì •ë ¬: ìŠ¹ìˆ˜ > ì„¸íŠ¸ë“ì‹¤ > ì ìˆ˜ë“ì‹¤
            return Object.values(records).sort((a, b) => {
                if (b.wins !== a.wins) return b.wins - a.wins;
                const aSetDiff = a.setsWon - a.setsLost;
                const bSetDiff = b.setsWon - b.setsLost;
                if (bSetDiff !== aSetDiff) return bSetDiff - aSetDiff;
                const aPointDiff = a.pointsFor - a.pointsAgainst;
                const bPointDiff = b.pointsFor - b.pointsAgainst;
                return bPointDiff - aPointDiff;
            });
        }
        
        function generateKnockoutBracket(project, advancers, size) {
            // ì‹œë“œ ë°°ì • (1ë²ˆ ì‹œë“œ vs ë§ˆì§€ë§‰ ì‹œë“œê°€ ê²°ìŠ¹ì—ì„œ ë§Œë‚˜ë„ë¡)
            const seededOrder = [];
            
            // ê¸°ë³¸ ì‹œë“œ ë°°ì¹˜ (8ê°• ì˜ˆì‹œ: 1-8, 4-5, 2-7, 3-6)
            function getSeedOrder(n) {
                if (n === 2) return [1, 2];
                const half = getSeedOrder(n / 2);
                const result = [];
                half.forEach(seed => {
                    result.push(seed);
                    result.push(n + 1 - seed);
                });
                return result;
            }
            
            const seedOrder = getSeedOrder(size);
            
            // ëŒ€ì§„ ìƒì„±
            for (let i = 0; i < size; i += 2) {
                const seed1 = seedOrder[i];
                const seed2 = seedOrder[i + 1];
                
                const p1 = advancers.find(a => a.seed === seed1);
                const p2 = advancers.find(a => a.seed === seed2);
                
                const match = {
                    id: Date.now() + i,
                    player1Name: p1 ? p1.name : 'BYE',
                    player2Name: p2 ? p2.name : 'BYE',
                    type: project.competitionType,
                    sets: project.competitionType === 'individual' ? 3 : 1,
                    winScore: project.competitionType === 'individual' ? 11 : 31,
                    currentSet: 1,
                    setScores: [{ player1: 0, player2: 0 }],
                    currentServe: 'player1',
                    serveCount: 0,
                    serveSelected: false,
                    timeouts: { player1: 1, player2: 1 },
                    history: [],
                    status: 'pending',
                    bracketRound: 1,
                    bracketMatchNum: (i / 2) + 1,
                    refereePin: generatePin()
                };
                
                // BYE ì²˜ë¦¬ - ìƒëŒ€ê°€ ìë™ ì§„ì¶œ
                if (p1 && !p2) {
                    match.status = 'completed';
                    match.winner = p1.name;
                    match.setScores = [{ player1: 0, player2: 0 }];
                    match.isBye = true;
                } else if (p2 && !p1) {
                    match.status = 'completed';
                    match.winner = p2.name;
                    match.setScores = [{ player1: 0, player2: 0 }];
                    match.isBye = true;
                }
                
                project.matches.push(match);
                
                // BYE ìŠ¹ìëŠ” ë°”ë¡œ ë‹¤ìŒ ë¼ìš´ë“œë¡œ ì§„ì¶œ
                if (match.isBye && match.winner) {
                    advanceTournamentWinner(project, match, match.winner);
                }
            }
        }
        
        function getRoundName(round, totalRounds) {
            const roundsFromFinal = totalRounds - round;
            switch(roundsFromFinal) {
                case 0: return 'ê²°ìŠ¹';
                case 1: return 'ì¤€ê²°ìŠ¹';
                case 2: return '8ê°•';
                case 3: return '16ê°•';
                case 4: return '32ê°•';
                default: return `${round}ë¼ìš´ë“œ`;
            }
        }
        // ========== í† ë„ˆë¨¼íŠ¸ ì§„í–‰ í•¨ìˆ˜ ë ==========
        
        function openBracketProject(index) {
            currentProject = projects[index];
            goTo('bracket-detail');
        }
        
        function editTournamentInfo() {
            const p = currentProject;
            if (!p) return;
            
            const newName = prompt('ëŒ€íšŒëª…:', p.name);
            if (newName && newName.trim()) {
                p.name = newName.trim();
            }
            
            const newDate = prompt('ë‚ ì§œ (YYYY-MM-DD):', p.date || '');
            if (newDate !== null) {
                p.date = newDate;
            }
            
            const newLocation = prompt('ì¥ì†Œ:', p.location || '');
            if (newLocation !== null) {
                p.location = newLocation;
            }
            
            saveProjects();
            render();
        }
        
        function editGroup(groupIndex) {
            const p = currentProject;
            if (!p || !p.groups[groupIndex]) return;
            
            const group = p.groups[groupIndex];
            const currentMembers = group.members.join(', ');
            const newMembers = prompt(`${group.name} ë©¤ë²„ (ì‰¼í‘œë¡œ êµ¬ë¶„):`, currentMembers);
            
            if (newMembers !== null) {
                const members = newMembers.split(',').map(m => m.trim()).filter(m => m);
                if (members.length > 0) {
                    group.members = members;
                    
                    // í•´ë‹¹ ì¡° ê²½ê¸° ì¬ìƒì„±
                    p.matches = p.matches.filter(m => m.groupIndex !== groupIndex);
                    
                    for (let i = 0; i < members.length; i++) {
                        for (let j = i + 1; j < members.length; j++) {
                            const match = {
                                id: Date.now() + groupIndex * 1000 + i * 100 + j,
                                player1Name: members[i],
                                player2Name: members[j],
                                type: p.competitionType,
                                sets: p.competitionType === 'individual' ? 3 : 1,
                                winScore: p.competitionType === 'individual' ? 11 : 31,
                                currentSet: 1,
                                setScores: [{ player1: 0, player2: 0 }],
                                currentServe: 'player1',
                                serveCount: 0,
                                serveSelected: false,
                                timeouts: { player1: 1, player2: 1 },
                                history: [],
                                status: 'pending',
                                groupIndex: groupIndex,
                                groupName: group.name,
                                refereePin: generatePin()
                            };
                            p.matches.push(match);
                            if (!group.matches) group.matches = [];
                            group.matches.push(match.id);
                        }
                    }
                    
                    saveProjects();
                    announce(`${group.name} ìˆ˜ì • ì™„ë£Œ`);
                    render();
                }
            }
        }
        
        // ëŒ€ì§„í‘œì—ì„œ ê²½ê¸° ì‹œì‘
        function startMatchFromBracket(matchId) {
            const p = currentProject;
            if (!p) return;
            
            const match = p.matches.find(m => m.id === matchId);
            if (!match) {
                alert('ê²½ê¸°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // PIN í™•ì¸
            if (match.refereePin) {
                const inputPin = prompt('ğŸ” ì‹¬íŒ PINì„ ì…ë ¥í•˜ì„¸ìš”:');
                if (inputPin !== match.refereePin) {
                    alert('âŒ PINì´ í‹€ë ¸ìŠµë‹ˆë‹¤.');
                    return;
                }
            }
            
            // ê²½ê¸° ìƒíƒœ ë³€ê²½
            match.status = 'in-progress';
            saveProjects();
            
            // ê²½ê¸° í™”ë©´ìœ¼ë¡œ ì´ë™
            currentMatch = match;
            isAuthenticated = true;
            screen = 'match';
            announce(`${match.player1Name} ëŒ€ ${match.player2Name} ê²½ê¸°ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.`);
            render();
        }
        
        function editMatch(matchId) {
            const p = currentProject;
            if (!p) return;
            
            const match = p.matches.find(m => m.id === matchId);
            if (!match) return;
            
            const newP1 = prompt('ì„ ìˆ˜1 ì´ë¦„:', match.player1Name);
            if (newP1 && newP1.trim()) {
                match.player1Name = newP1.trim();
            }
            
            const newP2 = prompt('ì„ ìˆ˜2 ì´ë¦„:', match.player2Name);
            if (newP2 && newP2.trim()) {
                match.player2Name = newP2.trim();
            }
            
            saveProjects();
            render();
        }
        
        function shuffleGroups() {
            const p = currentProject;
            if (!p || !p.groups || p.groups.length === 0) return;
            
            if (!confirm('ì¡°ë¥¼ ë‹¤ì‹œ ì„ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ? ì§„í–‰ëœ ê²½ê¸° ê¸°ë¡ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.')) return;
            
            // ëª¨ë“  ë©¤ë²„ ìˆ˜ì§‘
            const allMembers = [];
            p.groups.forEach(g => allMembers.push(...g.members));
            
            // ì„ê¸°
            for (let i = allMembers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allMembers[i], allMembers[j]] = [allMembers[j], allMembers[i]];
            }
            
            // ë‹¤ì‹œ ë°°ì •
            const groupCount = p.groups.length;
            p.groups.forEach((g, idx) => {
                g.members = [];
                g.matches = [];
            });
            
            allMembers.forEach((member, idx) => {
                const round = Math.floor(idx / groupCount);
                const groupIdx = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                p.groups[groupIdx].members.push(member);
            });
            
            // ê²½ê¸° ì¬ìƒì„±
            p.matches = [];
            p.groups.forEach((group, gIdx) => {
                const members = group.members;
                for (let i = 0; i < members.length; i++) {
                    for (let j = i + 1; j < members.length; j++) {
                        const match = {
                            id: Date.now() + gIdx * 1000 + i * 100 + j,
                            player1Name: members[i],
                            player2Name: members[j],
                            type: p.competitionType,
                            sets: p.competitionType === 'individual' ? 3 : 1,
                            winScore: p.competitionType === 'individual' ? 11 : 31,
                            currentSet: 1,
                            setScores: [{ player1: 0, player2: 0 }],
                            currentServe: 'player1',
                            serveCount: 0,
                            serveSelected: false,
                            timeouts: { player1: 1, player2: 1 },
                            history: [],
                            status: 'pending',
                            groupIndex: gIdx,
                            groupName: group.name,
                            refereePin: generatePin()
                        };
                        p.matches.push(match);
                        group.matches.push(match.id);
                    }
                }
            });
            
            saveProjects();
            announce('ì¡°ê°€ ë‹¤ì‹œ í¸ì„±ë˜ì—ˆìŠµë‹ˆë‹¤');
            render();
        }
        
        function deleteTournament() {
            if (!currentProject) return;
            
            if (!confirm(`"${currentProject.name}" ëŒ€íšŒë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ëª¨ë“  ê²½ê¸° ê¸°ë¡ì´ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
            
            const idx = projects.indexOf(currentProject);
            if (idx > -1) {
                projects.splice(idx, 1);
                saveProjects();
                currentProject = null;
                announce('ëŒ€íšŒê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
                goTo('bracket-home');
            }
        }
        // ========== ëŒ€ì§„ ì„¤ì • ëª¨ë“œ í•¨ìˆ˜ ë ==========
        
        // ========== ëŒ€íšŒ ëŒ€ì§„ ìœ„ìë“œ í•¨ìˆ˜ ë ==========

        function startTimeout(player) {
            if (currentMatch.timeouts[player] === 0 || isTimeoutActive) return;
            
            // ì¸ì¦ í™•ì¸
            if (!isAuthenticated) {
                alert('âŒ ì‹¬íŒë§Œ íƒ€ì„ì•„ì›ƒì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
                return;
            }
            
            isTimeoutActive = true;
            currentMatch.timeouts[player]--;
            saveProjects();
            
            const playerName = player === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            document.getElementById('timeout-title').textContent = `${playerName} íƒ€ì„ì•„ì›ƒ`;
            document.getElementById('timeout-modal').classList.add('active');
            
            timeoutSeconds = 60;
            updateTimerDisplay();
            speak(`${playerName} íƒ€ì„ì•„ì›ƒ ì‹œì‘. 60ì´ˆ`);
            announce(`${playerName} íƒ€ì„ì•„ì›ƒ ì‹œì‘. ë‚¨ì€ íšŸìˆ˜ ${currentMatch.timeouts[player]}`);
            
            timeoutTimer = setInterval(() => {
                timeoutSeconds--;
                updateTimerDisplay();
                
                if (timeoutSeconds === 15) {
                    speak('15ì´ˆ ë‚¨ìŒ');
                    announce('15ì´ˆ ë‚¨ìŒ');
                    document.getElementById('timer-display').classList.add('warning');
                } else if (timeoutSeconds === 0) {
                    speak('íƒ€ì„ì•„ì›ƒ ì¢…ë£Œ');
                    announce('íƒ€ì„ì•„ì›ƒ ì¢…ë£Œ');
                    closeTimeout();
                }
            }, 1000);
            
            renderMatch();
        }

        function startSideChange() {
            if (isTimeoutActive) return;
            
            isTimeoutActive = true;
            document.getElementById('timeout-title').textContent = 'ì‚¬ì´ë“œ ì²´ì¸ì§€ (1ë¶„ íœ´ì‹)';
            document.getElementById('timeout-modal').classList.add('active');
            
            timeoutSeconds = 60;
            updateTimerDisplay();
            speak('ì‚¬ì´ë“œ ì²´ì¸ì§€. 1ë¶„ íœ´ì‹ ì‹œì‘');
            announce('ì‚¬ì´ë“œ ì²´ì¸ì§€. 1ë¶„ íœ´ì‹');
            
            timeoutTimer = setInterval(() => {
                timeoutSeconds--;
                updateTimerDisplay();
                
                if (timeoutSeconds === 15) {
                    speak('15ì´ˆ ë‚¨ìŒ');
                    announce('15ì´ˆ ë‚¨ìŒ');
                    document.getElementById('timer-display').classList.add('warning');
                } else if (timeoutSeconds === 0) {
                    speak('íœ´ì‹ ì¢…ë£Œ');
                    announce('íœ´ì‹ ì¢…ë£Œ');
                    closeTimeout();
                }
            }, 1000);
            
            renderMatch();
        }

        function updateTimerDisplay() {
            document.getElementById('timer-display').textContent = timeoutSeconds;
        }

        function closeTimeout() {
            clearInterval(timeoutTimer);
            document.getElementById('timeout-modal').classList.remove('active');
            document.getElementById('timer-display').classList.remove('warning');
            timeoutSeconds = 60;
            isTimeoutActive = false;
            renderMatch();
        }

        function deleteMatch(event, index) {
            event.stopPropagation();
            const match = currentProject.matches[index];
            const matchName = `${match.player1Name} vs ${match.player2Name}`;
            
            if (confirm(`ê²½ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${matchName}\nì„¸íŠ¸ ${match.currentSet}/${match.sets}`)) {
                currentProject.matches.splice(index, 1);
                saveProjects();
                render();
            }
        }

        function deleteProject(index) {
            const project = projects[index];
            
            if (confirm(`í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${project.name}\nê²½ê¸° ${project.matches?.length || 0}ê°œ í¬í•¨`)) {
                // Firebaseì—ì„œ ì‚­ì œ
                if (database && project.firebaseKey) {
                    database.ref('projects/' + project.firebaseKey).remove();
                } else {
                    // ë¡œì»¬ì—ì„œ ì‚­ì œ
                    projects.splice(index, 1);
                    localStorage.setItem('projects', JSON.stringify(projects));
                }
                render();
            }
        }

        function deleteMatchDirect(index) {
            const match = currentProject.matches[index];
            const matchName = `${match.player1Name} vs ${match.player2Name}`;
            
            if (confirm(`ê²½ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${matchName}`)) {
                currentProject.matches.splice(index, 1);
                saveProjects();
                render();
            }
        }
        
        // ========== ê²½ê¸° í¸ì§‘ - ì‹¬íŒ/ê²½ê¸°ì¥ ì‹¤ì‹œê°„ ë°°ì • ==========
        
        function updateMatchReferee(matchIdx) {
            const match = currentProject.matches[matchIdx];
            const refereeSelect = document.getElementById(`ref-${matchIdx}`);
            const refereeName = refereeSelect.value;
            
            if (!refereeName) {
                match.mainRefereeName = null;
                match.refereePin = null;
                announce(`âš–ï¸ ì‹¬íŒ ë°°ì • ì œê±°ë¨`);
            } else {
                const referee = currentProject.referees.find(r => r.name === refereeName);
                match.mainRefereeName = refereeName;
                match.refereePin = referee?.pin; // PINë„ ì €ì¥
                announce(`âœ… ì‹¬íŒ ë°°ì •: ${refereeName}`);
            }
            
            saveProjects(); // ì¦‰ì‹œ ì €ì¥
            render(); // í™”ë©´ ì—…ë°ì´íŠ¸
        }
        
        function updateMatchCourt(matchIdx) {
            const match = currentProject.matches[matchIdx];
            const courtSelect = document.getElementById(`court-${matchIdx}`);
            const courtName = courtSelect.value;
            
            if (!courtName) {
                match.courtName = null;
                announce(`ğŸŸï¸ ê²½ê¸°ì¥ ë°°ì • ì œê±°ë¨`);
            } else {
                match.courtName = courtName;
                announce(`âœ… ê²½ê¸°ì¥ ë°°ì •: ${courtName}`);
            }
            
            saveProjects(); // ì¦‰ì‹œ ì €ì¥
            render(); // í™”ë©´ ì—…ë°ì´íŠ¸
        }

        // ê²½ê¸° ê¸°ë¡ ìˆœì„œ í† ê¸€
        let historyOrderDesc = true; // true: ìµœì‹ ìˆœ, false: ì˜¤ë˜ëœìˆœ
        let finishedHistoryOrderDesc = true;

        function toggleHistoryOrder() {
            historyOrderDesc = !historyOrderDesc;
            const btn = document.getElementById('history-order-btn');
            btn.textContent = historyOrderDesc ? 'ìµœì‹ ìˆœ â†“' : 'ì˜¤ë˜ëœìˆœ â†‘';
            
            const container = document.getElementById('match-history');
            const items = Array.from(container.children);
            items.reverse().forEach(item => container.appendChild(item));
        }

        function toggleFinishedHistoryOrder() {
            finishedHistoryOrderDesc = !finishedHistoryOrderDesc;
            // ì „ì²´ í™”ë©´ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ì •ë ¬ ì ìš©
            render();
        }
        
        // ë¹ ë¥¸ í”„ë¡œì íŠ¸ - ì„¸íŠ¸ ìˆ˜ í‘œì‹œ í† ê¸€
        function updateQPSets() {
            const type = document.getElementById('qp-type').value;
            const setsGroup = document.getElementById('qp-sets-group');
            if (setsGroup) {
                setsGroup.style.display = type === 'team' ? 'none' : 'block';
            }
        }
        
        // ë¹ ë¥¸ í”„ë¡œì íŠ¸ ìƒì„±
        function createQuickProject() {
            const name = document.getElementById('qp-name').value.trim();
            if (!name) {
                alert('í”„ë¡œì íŠ¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const participantsText = document.getElementById('qp-participants').value.trim();
            if (!participantsText) {
                alert('ì°¸ê°€ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì°¸ê°€ì íŒŒì‹± (ì¤„ë°”ê¿ˆ ë˜ëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„)
            const participants = participantsText
                .split(/[\n,]+/)
                .map(p => p.trim())
                .filter(p => p.length > 0);
            
            if (participants.length < 2) {
                alert('ìµœì†Œ 2ëª… ì´ìƒì˜ ì°¸ê°€ìê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            const type = document.getElementById('qp-type').value;
            const sets = type === 'team' ? 1 : parseInt(document.getElementById('qp-sets').value);
            const format = document.getElementById('qp-format').value;
            const isTeam = type === 'team';
            const winScore = isTeam ? 31 : 11;
            
            // í”„ë¡œì íŠ¸ ìƒì„±
            const project = {
                id: Date.now(),
                name: name,
                date: new Date().toISOString().split('T')[0],
                location: '',
                competitionType: isTeam ? 'team' : 'individual',
                players: isTeam ? [] : participants,
                teams: isTeam ? participants.map(t => ({ name: t, players: [] })) : [],
                tournamentType: format === 'full-league' ? 'group-only' : 'knockout-only',
                groups: [],
                matches: [],
                preliminarySets: sets,
                finalsSets: sets,
                createdAt: new Date().toISOString(),
                isQuickProject: true
            };
            
            // ê²½ê¸° ìƒì„±
            if (format === 'full-league') {
                // í’€ë¦¬ê·¸: ëª¨ë“  ì¡°í•©
                for (let i = 0; i < participants.length; i++) {
                    for (let j = i + 1; j < participants.length; j++) {
                        const match = {
                            id: Date.now() + i * 100 + j,
                            player1Name: participants[i],
                            player2Name: participants[j],
                            type: isTeam ? 'team' : 'individual',
                            sets: sets,
                            winScore: winScore,
                            currentSet: 1,
                            setScores: [{ player1: 0, player2: 0 }],
                            currentServe: 'player1',
                            serveCount: 0,
                            serveSelected: false,
                            timeouts: { player1: 1, player2: 1 },
                            history: [],
                            status: 'pending',
                            refereePin: generatePin()
                        };
                        project.matches.push(match);
                    }
                }
            } else {
                // í† ë„ˆë¨¼íŠ¸: ìˆœì„œëŒ€ë¡œ ë§¤ì¹­
                const shuffled = [...participants];
                // ëœë¤ ì„ê¸°
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                
                for (let i = 0; i < shuffled.length - 1; i += 2) {
                    const match = {
                        id: Date.now() + i,
                        player1Name: shuffled[i],
                        player2Name: shuffled[i + 1] || 'BYE',
                        type: isTeam ? 'team' : 'individual',
                        sets: sets,
                        winScore: winScore,
                        currentSet: 1,
                        setScores: [{ player1: 0, player2: 0 }],
                        currentServe: 'player1',
                        serveCount: 0,
                        serveSelected: false,
                        timeouts: { player1: 1, player2: 1 },
                        history: [],
                        status: 'pending',
                        bracketRound: 1,
                        bracketMatchNum: i / 2 + 1,
                        refereePin: generatePin()
                    };
                    project.matches.push(match);
                }
            }
            
            // í”„ë¡œì íŠ¸ ì €ì¥
            projects.push(project);
            saveProjects();
            
            // ìƒì„±ëœ í”„ë¡œì íŠ¸ë¡œ ì´ë™
            currentProject = project;
            announce(`${project.name} í”„ë¡œì íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ${project.matches.length}ê²½ê¸°`);
            goTo('project-list');
        }

        // ì‹¬íŒ ì—°ìŠµ ëª¨ë“œ ê²½ê¸° ì‹œì‘
        function startPracticeMatch() {
            const type = document.getElementById('practice-type').value;
            const sets = type === 'team' ? 1 : parseInt(document.getElementById('practice-sets').value);
            const player1 = document.getElementById('practice-player1').value.trim() || 'ì„ ìˆ˜ A';
            const player2 = document.getElementById('practice-player2').value.trim() || 'ì„ ìˆ˜ B';
            
            // ì—°ìŠµìš© í”„ë¡œì íŠ¸ ìƒì„± (Firebase ë™ê¸°í™”ë¨)
            const practiceProject = {
                id: Date.now(),
                name: 'ğŸ¯ ì—°ìŠµ ê²½ê¸°',
                date: new Date().toISOString().split('T')[0],
                location: 'ì—°ìŠµ',
                competitionType: type === 'team' ? 'team' : 'individual',
                matches: [],
                isPractice: true // ì—°ìŠµ ëª¨ë“œ í‘œì‹œ
            };
            
            // ì—°ìŠµ ê²½ê¸° ìƒì„±
            const practiceMatch = {
                id: Date.now() + 1,
                type: type, // ê°œì¸ì „/íŒ€ì „ êµ¬ë¶„ - ì„œë¸Œ íšŸìˆ˜ì— ì˜í–¥
                player1Name: player1,
                player2Name: player2,
                mainReferee: 'ì—°ìŠµ',
                refereePin: null, // PIN ì—†ìŒ
                sets: sets,
                winScore: type === 'team' ? 31 : 11,
                currentSet: 1,
                setScores: [{ player1: 0, player2: 0 }], // ì²« ì„¸íŠ¸ë§Œ ìƒì„±
                currentServe: 'player1',
                serveCount: 0,
                serveSelected: false, // ì„œë¸Œ ë¯¸ì„ íƒ ìƒíƒœ
                timeouts: { player1: 1, player2: 1 },
                history: [],
                warmupUsed: false,
                status: 'in-progress',
                isPractice: true
            };
            
            practiceProject.matches.push(practiceMatch);
            
            // í”„ë¡œì íŠ¸ ì €ì¥ (Firebase ë™ê¸°í™”)
            projects.push(practiceProject);
            saveProjects();
            
            // í˜„ì¬ í”„ë¡œì íŠ¸/ê²½ê¸° ì„¤ì •
            currentProject = practiceProject;
            currentMatch = practiceMatch;
            isAuthenticated = true; // ì—°ìŠµ ëª¨ë“œëŠ” í•­ìƒ ì¸ì¦ë¨
            
            // ê²½ê¸° í™”ë©´ìœ¼ë¡œ ì´ë™
            screen = 'match';
            announce('ì—°ìŠµ ê²½ê¸°ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ' + player1 + ' ëŒ€ ' + player2 + '. ' + sets + 'ì„¸íŠ¸');
            render();
        }
        
        // ì—°ìŠµ ê²½ê¸° ê¸°ë¡ ì €ì¥ (Firebase + ë¡œì»¬)
        function savePracticeResult(silent = false) {
            if (!currentMatch) return;
            
            const practiceHistory = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
            
            // ì¤‘ë³µ ì €ì¥ ë°©ì§€
            const exists = practiceHistory.some(m => m.id === currentMatch.id);
            if (exists) {
                if (!silent) alert('ì´ë¯¸ ì €ì¥ëœ ê¸°ë¡ì…ë‹ˆë‹¤.');
                return;
            }
            
            // ì €ì¥í•  ë°ì´í„°
            const matchRecord = {
                id: currentMatch.id,
                player1Name: currentMatch.player1Name,
                player2Name: currentMatch.player2Name,
                setScores: currentMatch.setScores,
                history: currentMatch.history,
                winner: currentMatch.winner,
                finishedAt: currentMatch.finishedAt || new Date().toISOString(),
                sets: currentMatch.sets,
                matchType: 'practice' // âœ¨ êµ¬ë¶„ í•„ë“œ
            };
            
            // ë¡œì»¬ì— ì €ì¥
            practiceHistory.push(matchRecord);
            localStorage.setItem('practiceHistory', JSON.stringify(practiceHistory));
            
            // âœ¨ Firebaseì—ë„ ì €ì¥
            savePracticeToFirebase(matchRecord);
            
            if (!silent) {
                announce('ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
                alert('âœ… ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }
        
        // âœ¨ ì—°ìŠµ ê²½ê¸°ë¥¼ Firebaseì— ì €ì¥
        function savePracticeToFirebase(matchRecord) {
            if (!database || !userId) {
                // Firebase ë¯¸ì—°ê²° - ì˜¤í”„ë¼ì¸ íì— ì¶”ê°€
                const queue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
                queue.push({
                    type: 'practiceMatch',
                    userId: userId,
                    data: matchRecord,
                    timestamp: Date.now()
                });
                localStorage.setItem('offlineQueue', JSON.stringify(queue));
                console.log('ğŸ“´ ì—°ìŠµ ê²½ê¸° ì˜¤í”„ë¼ì¸ íì— ì¶”ê°€');
                return;
            }
            
            try {
                if (!isOffline) {
                    // Firebaseì— ì €ì¥
                    const matchId = 'practice_' + matchRecord.id;
                    database.ref(`practiceMatches/${userId}/${matchId}`).set(matchRecord);
                    console.log('âœ… Firebaseì— ì—°ìŠµ ê²½ê¸° ì €ì¥:', matchId);
                } else {
                    // ì˜¤í”„ë¼ì¸ íì— ì¶”ê°€
                    const queue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
                    queue.push({
                        type: 'practiceMatch',
                        userId: userId,
                        matchId: 'practice_' + matchRecord.id,
                        data: matchRecord,
                        timestamp: Date.now()
                    });
                    localStorage.setItem('offlineQueue', JSON.stringify(queue));
                    console.log('ğŸ“´ ì—°ìŠµ ê²½ê¸° ì˜¤í”„ë¼ì¸ íì— ì¶”ê°€');
                }
            } catch (error) {
                console.error('ì—°ìŠµ ê²½ê¸° Firebase ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }
        
        // âœ¨ Firebaseì—ì„œ ì—°ìŠµ ê²½ê¸° ë¡œë“œ
        let practiceMatchesFromFirebase = [];
        
        function loadPracticeMatchesFromFirebase() {
            if (!database || !userId) {
                console.log('ğŸ“´ Firebase ë¯¸ì—°ê²° - ë¡œì»¬ë§Œ ì‚¬ìš©');
                return;
            }
            
            try {
                database.ref(`practiceMatches/${userId}`).once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        practiceMatchesFromFirebase = Object.values(data);
                        console.log('âœ… Firebaseì—ì„œ ì—°ìŠµ ê²½ê¸° ë¡œë“œ:', practiceMatchesFromFirebase.length);
                    } else {
                        console.log('Firebaseì— ì—°ìŠµ ê²½ê¸° ì—†ìŒ');
                    }
                }).catch(error => {
                    console.log('âŒ Firebase ì—°ìŠµ ê²½ê¸° ë¡œë“œ ì‹¤íŒ¨:', error);
                });
            } catch (error) {
                console.log('âŒ ì—°ìŠµ ê²½ê¸° ë¡œë“œ ì—ëŸ¬:', error);
            }
        }
        
        // ì—°ìŠµ ê¸°ë¡ ìƒì„¸ ë³´ê¸°
        function viewPracticeRecord(idx) {
            window.currentPracticeRecordIdx = idx;
            goTo('practice-detail');
        }
        
        // ì—°ìŠµ ê¸°ë¡ ì‚­ì œ
        function deletePracticeRecord(idx) {
            if (!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            const practiceHistory = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
            practiceHistory.splice(idx, 1);
            localStorage.setItem('practiceHistory', JSON.stringify(practiceHistory));
            
            announce('ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            render();
        }
        
        // ì—°ìŠµ ê¸°ë¡ ì „ì²´ ì‚­ì œ
        function clearPracticeHistory() {
            if (!confirm('ëª¨ë“  ì—°ìŠµ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            localStorage.removeItem('practiceHistory');
            announce('ëª¨ë“  ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤');
            render();
        }

        // ì²« ì„œë¸Œ ì„ íƒ
        function selectFirstServe(player) {
            if (!currentMatch) return;
            currentMatch.currentServe = player;
            currentMatch.serveSelected = true;
            currentMatch.serveCount = 0;
            const serverName = player === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            announce(serverName + ' ì²« ì„œë¸Œ');
            saveProjects();
            render();
        }

        // ì›Œë°ì—… ì‹œì‘ (IBSA ê·œì¹™: ê°œì¸ì „ 60ì´ˆ, íŒ€ì „ 90ì´ˆ)
        function startWarmup() {
            // ê²½ê¸°ë‹¹ ì›Œë°ì—… 1íšŒë§Œ ì‚¬ìš© ê°€ëŠ¥
            currentMatch.warmupUsed = true;
            saveProjects();
            
            warmupActive = true;
            // IBSA ê·œì¹™: ê°œì¸ì „ 60ì´ˆ, íŒ€ì „ 90ì´ˆ (type ì—†ìœ¼ë©´ ê°œì¸ì „ìœ¼ë¡œ ì²˜ë¦¬)
            const isTeam = currentMatch.type === 'team';
            warmupSeconds = isTeam ? 90 : 60;
            announce(`ì›Œë°ì—… ${warmupSeconds}ì´ˆ ì‹œì‘`);
            render();
            
            warmupTimer = setInterval(() => {
                warmupSeconds--;
                const display = document.getElementById('warmup-timer');
                if (display) {
                    display.textContent = `${Math.floor(warmupSeconds / 60)}:${(warmupSeconds % 60).toString().padStart(2, '0')}`;
                }
                
                // ë‚¨ì€ ì‹œê°„ ì•ˆë‚´
                if (isTeam) {
                    // íŒ€ì „ 90ì´ˆ: 60ì´ˆ, 30ì´ˆì— "30ì´ˆ" ì•ˆë‚´
                    if (warmupSeconds === 60 || warmupSeconds === 30) {
                        announce('30ì´ˆ');
                    }
                } else {
                    // ê°œì¸ì „ 60ì´ˆ: 15ì´ˆì—ë§Œ ì•ˆë‚´
                    if (warmupSeconds === 15) {
                        announce('15ì´ˆ');
                    }
                }
                
                if (warmupSeconds <= 0) {
                    stopWarmup();
                    announce('ì›Œë°ì—… ì¢…ë£Œ');
                }
            }, 1000);
        }

        // ì›Œë°ì—… ì¢…ë£Œ
        function stopWarmup() {
            warmupActive = false;
            if (warmupTimer) {
                clearInterval(warmupTimer);
                warmupTimer = null;
            }
            render();
        }

        // ì´ˆê¸°í™”
        const savedTheme = localStorage.getItem('theme') || 'normal';
        const savedThemeIndex = parseInt(localStorage.getItem('themeIndex')) || 0;
        currentThemeIndex = savedThemeIndex;
        
        if (savedTheme !== 'normal') {
            document.body.className = savedTheme;
        }
        
        const currentTheme = themes[currentThemeIndex];
        document.getElementById('theme-btn').textContent = `ëª¨ë“œ: ${currentTheme.name}`;
        document.getElementById('voice-btn').style.opacity = voiceEnabled ? '1' : '0.5';
        render();
        
        // PWA Service Worker ë“±ë¡
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('SW ë“±ë¡ ì„±ê³µ:', registration.scope);
                        
                        // ì—…ë°ì´íŠ¸ í™•ì¸
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // ìƒˆ ë²„ì „ ì‚¬ìš© ê°€ëŠ¥
                                    if (confirm('ìƒˆ ë²„ì „ì´ ìˆìŠµë‹ˆë‹¤. ì—…ë°ì´íŠ¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.log('SW ë“±ë¡ ì‹¤íŒ¨:', err);
                    });
            });
        }
        
        // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ (ì„ íƒì )
            const installBtn = document.getElementById('pwa-install-btn');
            if (installBtn) {
                installBtn.style.display = 'block';
                installBtn.onclick = async () => {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('ì„¤ì¹˜ ê²°ê³¼:', outcome);
                    deferredPrompt = null;
                    installBtn.style.display = 'none';
                };
            }
        });
        
        // ========== Tournament Wizard - Step 6: ì‹¬íŒ/ê²½ê¸°ì¥ ì„¤ì • ==========
        
        function addTWReferee() {
            const tw = window.tournamentWizard;
            const name = document.getElementById('tw-ref-name')?.value.trim();
            const role = document.getElementById('tw-ref-role')?.value || 'main';
            const pin = document.getElementById('tw-ref-pin')?.value.trim();
            
            // ìœ íš¨ì„± ê²€ì‚¬
            if (!name) {
                announce('âŒ ì‹¬íŒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            if (!pin || pin.length < 6) {
                announce('âŒ PIN ë²ˆí˜¸ëŠ” 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤');
                return;
            }
            
            if (!/^\d+$/.test(pin)) {
                announce('âŒ PIN ë²ˆí˜¸ëŠ” ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                return;
            }
            
            // ì¤‘ë³µ í™•ì¸
            if (tw.referees.some(r => r.name === name)) {
                announce('âŒ ì´ë¯¸ ë“±ë¡ëœ ì‹¬íŒì…ë‹ˆë‹¤');
                return;
            }
            
            // ì¶”ê°€
            tw.referees.push({ name, role, pin });
            
            // ì´ˆê¸°í™”
            document.getElementById('tw-ref-name').value = '';
            document.getElementById('tw-ref-pin').value = '';
            
            announce(`âœ… ì‹¬íŒ "${name}" ì¶”ê°€ë¨ (PIN: ${pin})`);
            render();
        }
        
        function deleteTWReferee(index) {
            const tw = window.tournamentWizard;
            const ref = tw.referees[index];
            tw.referees.splice(index, 1);
            announce(`âœ… ì‹¬íŒ "${ref.name}" ì‚­ì œë¨`);
            render();
        }
        
        function addTWCourt() {
            const tw = window.tournamentWizard;
            const name = document.getElementById('tw-court-name')?.value.trim();
            
            if (!name) {
                announce('âŒ ê²½ê¸°ì¥ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
                return;
            }
            
            // ì¤‘ë³µ í™•ì¸
            if (tw.courts.some(c => c.name === name)) {
                announce('âŒ ì´ë¯¸ ë“±ë¡ëœ ê²½ê¸°ì¥ì…ë‹ˆë‹¤');
                return;
            }
            
            // ì¶”ê°€
            tw.courts.push({ name });
            
            // ì´ˆê¸°í™”
            document.getElementById('tw-court-name').value = '';
            
            announce(`âœ… ê²½ê¸°ì¥ "${name}" ì¶”ê°€ë¨`);
            render();
        }
        
        function deleteTWCourt(index) {
            const tw = window.tournamentWizard;
            const court = tw.courts[index];
            tw.courts.splice(index, 1);
            announce(`âœ… ê²½ê¸°ì¥ "${court.name}" ì‚­ì œë¨`);
            render();
        }
        
    </script>
        
        // âœ¨ Firebase ê¸°ë°˜ ì‚¬ìš©ì ì„¤ì •
        let favoritePlayers = [];
        let notifiedMatches = [];
        let showFavoritesOnly = false;
        
        // Firebaseì—ì„œ ì‚¬ìš©ì ì„¤ì • ë¡œë“œ
        function loadUserPreferences() {
            if (!database || !userId) {
                // Firebase ë¯¸ì—°ê²° - ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë¡œë“œ
                favoritePlayers = JSON.parse(localStorage.getItem('favorite-players') || '[]');
                notifiedMatches = JSON.parse(localStorage.getItem('notified-matches') || '[]');
                console.log('ğŸ“´ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš©ì ì„¤ì • ë¡œë“œ');
                return;
            }
            
            try {
                // Firebaseì—ì„œ ì‚¬ìš©ì ì„¤ì • ë¡œë“œ
                database.ref(`userPreferences/${userId}`).once('value', (snapshot) => {
                    const prefs = snapshot.val();
                    if (prefs) {
                        favoritePlayers = prefs.favorites || [];
                        notifiedMatches = prefs.notifications || [];
                        console.log('âœ… Firebaseì—ì„œ ì‚¬ìš©ì ì„¤ì • ë¡œë“œ:', userId);
                    } else {
                        // ì²« ë¡œë“œ - ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ë§ˆì´ê·¸ë ˆì´ì…˜
                        favoritePlayers = JSON.parse(localStorage.getItem('favorite-players') || '[]');
                        notifiedMatches = JSON.parse(localStorage.getItem('notified-matches') || '[]');
                        saveUserPreferences(); // Firebaseì— ì €ì¥
                        console.log('âœ… ë¡œì»¬ ë°ì´í„°ë¥¼ Firebaseë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜');
                    }
                }).catch(error => {
                    console.log('âŒ Firebase ë¡œë“œ ì‹¤íŒ¨ - ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©:', error);
                    favoritePlayers = JSON.parse(localStorage.getItem('favorite-players') || '[]');
                    notifiedMatches = JSON.parse(localStorage.getItem('notified-matches') || '[]');
                });
            } catch (error) {
                console.log('âŒ ì‚¬ìš©ì ì„¤ì • ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // Firebaseì— ì‚¬ìš©ì ì„¤ì • ì €ì¥
        function saveUserPreferences() {
            if (!database || !userId) {
                // Firebase ë¯¸ì—°ê²° - ë¡œì»¬ë§Œ ì €ì¥
                localStorage.setItem('favorite-players', JSON.stringify(favoritePlayers));
                localStorage.setItem('notified-matches', JSON.stringify(notifiedMatches));
                return;
            }
            
            try {
                if (database && userId && !isOffline) {
                    database.ref(`userPreferences/${userId}`).set({
                        favorites: favoritePlayers,
                        notifications: notifiedMatches,
                        lastUpdated: new Date().toISOString()
                    });
                    console.log('âœ… Firebaseì— ì‚¬ìš©ì ì„¤ì • ì €ì¥');
                } else if (isOffline) {
                    // ì˜¤í”„ë¼ì¸ íì— ì¶”ê°€
                    const queue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
                    queue.push({
                        type: 'userPreferences',
                        userId: userId,
                        data: { favorites: favoritePlayers, notifications: notifiedMatches },
                        timestamp: Date.now()
                    });
                    localStorage.setItem('offlineQueue', JSON.stringify(queue));
                    // ë¡œì»¬ì—ë„ ì €ì¥
                    localStorage.setItem('favorite-players', JSON.stringify(favoritePlayers));
                    localStorage.setItem('notified-matches', JSON.stringify(notifiedMatches));
                    console.log('ğŸ“´ ì˜¤í”„ë¼ì¸ - ì‚¬ìš©ì ì„¤ì • ë¡œì»¬ ì €ì¥ ë° íì— ì¶”ê°€');
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì„¤ì • ì €ì¥ ì—ëŸ¬:', error);
            }
        }
        
        // ê²€ìƒ‰ ê²°ê³¼ ë Œë”ë§ í•¨ìˆ˜
        function renderViewerResults() {
            const container = document.getElementById('viewer-results-container');
            if (!container) return;
            
            const tab = window.viewerTab || 'actual';
            const query = (document.getElementById('viewer-search')?.value || '').toLowerCase();
            
            // ëª¨ë“  ê²½ê¸° ìˆ˜ì§‘
            let allMatches = [];
            
            // âœ¨ íƒ­ì´ 'actual'ì´ë©´ ì‹¤ì œ ê²½ê¸°
            if (tab === 'actual') {
                projects.forEach((project, pIdx) => {
                    if (project.matches) {
                        project.matches.forEach((match, mIdx) => {
                            allMatches.push({
                                ...match,
                                projectName: project.name,
                                projectIdx: pIdx,
                                matchIdx: mIdx,
                                matchType: 'actual'
                            });
                        });
                    }
                });
            } 
            // âœ¨ íƒ­ì´ 'practice'ì´ë©´ ì—°ìŠµ ê²½ê¸°
            else if (tab === 'practice') {
                const practiceHistory = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
                // Firebase ë°ì´í„°ë„ í¬í•¨
                const allPractice = [...practiceHistory, ...practiceMatchesFromFirebase];
                // ì¤‘ë³µ ì œê±°
                const unique = Array.from(new Map(allPractice.map(m => [m.id, m])).values());
                
                unique.forEach((match, idx) => {
                    allMatches.push({
                        ...match,
                        projectName: 'ì—°ìŠµ ê²½ê¸°',
                        projectIdx: -1,
                        matchIdx: idx,
                        matchType: 'practice'
                    });
                });
            }
            
            // í•„í„°ë§
            let filtered = allMatches.filter(m => {
                const matchesQuery = !query || 
                    (m.player1Name && m.player1Name.toLowerCase().includes(query)) ||
                    (m.player2Name && m.player2Name.toLowerCase().includes(query));
                
                const isFavorite = favoritePlayers.includes(m.player1Name) || favoritePlayers.includes(m.player2Name);
                return matchesQuery && (!showFavoritesOnly || isFavorite);
            });
            
            if (filtered.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:40px 20px; color:var(--text-secondary);">
                    <div style="font-size:48px; margin-bottom:12px;">ğŸ˜•</div>
                    <p>${tab === 'actual' ? 'ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤' : 'ì—°ìŠµ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤'}</p>
                </div>`;
                return;
            }
            
            // ê²½ê¸° ì¹´ë“œ ë Œë”ë§
            container.innerHTML = filtered.map(m => {
                const isFav = favoritePlayers.includes(m.player1Name) || favoritePlayers.includes(m.player2Name);
                const isNotify = notifiedMatches.includes(`${m.projectIdx}-${m.matchIdx}`);
                
                // âœ¨ ì‹¤ì œ ê²½ê¸°ì™€ ì—°ìŠµ ê²½ê¸° í‘œì‹œ ë°©ì‹ ë‹¤ë¥´ê²Œ
                let resultText = '';
                if (m.matchType === 'actual') {
                    resultText = `
                        <div style="font-size:1.3rem; margin-top:6px; font-weight:bold; color:#667eea;">
                            ${m.setScores ? m.setScores[m.currentSet-1]?.player1 || 0 : 0} : ${m.setScores ? m.setScores[m.currentSet-1]?.player2 || 0 : 0}
                        </div>
                        <div style="font-size:0.85rem; color:#999; margin-top:4px;">
                            ğŸ“ ${m.courtName || 'ë¯¸ì •'} | ${m.status === 'completed' ? 'âœ… ì™„ë£Œ' : m.status === 'inprogress' ? 'â³ ì§„í–‰ì¤‘' : 'â­• ëŒ€ê¸°'}
                        </div>
                    `;
                } else {
                    // ì—°ìŠµ ê²½ê¸°
                    const date = m.finishedAt ? new Date(m.finishedAt).toLocaleDateString('ko-KR') : '';
                    const p1Wins = m.setScores?.filter(s => s.player1 > s.player2).length || 0;
                    const p2Wins = m.setScores?.filter(s => s.player2 > s.player1).length || 0;
                    resultText = `
                        <div style="font-size:1.3rem; margin-top:6px; font-weight:bold; color:#4caf50;">
                            ${p1Wins} : ${p2Wins} ì„¸íŠ¸ (ìŠ¹: ${m.winner})
                        </div>
                        <div style="font-size:0.85rem; color:#999; margin-top:4px;">
                            ğŸ“… ${date}
                        </div>
                    `;
                }
                
                return `
                    <div class="card" style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center; padding:15px; border-left:4px solid ${m.matchType === 'actual' ? '#667eea' : '#4caf50'};">
                        <div style="flex:1; cursor:pointer;" onclick="viewMatchResult('${m.matchType}', ${m.matchType === 'actual' ? m.projectIdx : m.matchIdx})">
                            <div style="font-size:0.9rem; color:${m.matchType === 'actual' ? '#667eea' : '#4caf50'}; font-weight:bold;">
                                ${m.matchType === 'actual' ? 'ğŸ† ' : 'ğŸ‹ï¸ '}${m.projectName}
                            </div>
                            <div style="font-size:1.05rem; margin-top:4px; font-weight:600;">${m.player1Name || 'ì„ ìˆ˜1'} vs ${m.player2Name || 'ì„ ìˆ˜2'}</div>
                            ${resultText}
                        </div>
                        <div style="display:flex; flex-direction:column; gap:10px; margin-left:12px;">
                            <button style="font-size:26px; background:none; border:none; cursor:pointer; padding:0; color:${isFav ? '#f1c40f' : '#ddd'};" 
                                    onclick="toggleFavorite('${m.player1Name}', '${m.player2Name}')"
                                    aria-label="${m.player1Name}ì™€ ${m.player2Name}ì˜ ê²½ê¸°ë¥¼ ì¦ê²¨ì°¾ê¸°ì— ${isFav ? 'í•´ì œ' : 'ì¶”ê°€'}">
                                ${isFav ? 'â˜…' : 'â˜†'}
                            </button>
                            <button style="font-size:22px; background:none; border:none; cursor:pointer; padding:0; color:${isNotify ? '#4a90d9' : '#ddd'};" 
                                    onclick="toggleNotification('${m.projectIdx}-${m.matchIdx}')"
                                    aria-label="${m.player1Name}ì™€ ${m.player2Name}ì˜ ê²½ê¸° ë“ì  ì•Œë¦¼ì„ ${isNotify ? 'ë„ê¸°' : 'ë°›ê¸°'}">
                                ${isNotify ? 'ğŸ””' : 'ğŸ”•'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // âœ¨ íƒ­ ì „í™˜ í•¨ìˆ˜
        function switchViewerTab(tab) {
            window.viewerTab = tab;
            render(); // ì „ì²´ í™”ë©´ ë‹¤ì‹œ ë Œë”ë§
        }
        
        // âœ¨ ê²½ê¸° ê²°ê³¼ ë³´ê¸°
        function viewMatchResult(type, idx) {
            if (type === 'actual') {
                currentProject = projects[idx];
                goTo('project-detail');
            } else {
                window.currentPracticeRecordIdx = idx;
                goTo('practice-detail');
            }
        }
        
        // ì¦ê²¨ì°¾ê¸° í† ê¸€
        function toggleFavorite(player1, player2) {
            if (!player1 || !player2) return;
            [player1, player2].forEach(p => {
                if (p && p !== 'ì„ ìˆ˜1' && p !== 'ì„ ìˆ˜2') {
                    const idx = favoritePlayers.indexOf(p);
                    if (idx > -1) {
                        favoritePlayers.splice(idx, 1);
                    } else {
                        favoritePlayers.push(p);
                    }
                }
            });
            
            // âœ¨ Firebase ì €ì¥
            saveUserPreferences();
            
            renderViewerResults();
            announce(`â­ ${player1} ì¦ê²¨ì°¾ê¸° ${favoritePlayers.includes(player1) ? 'ì¶”ê°€' : 'ì œê±°'}`);
        }
        
        // ì•Œë¦¼ í† ê¸€
        function toggleNotification(matchKey) {
            const idx = notifiedMatches.indexOf(matchKey);
            if (idx > -1) {
                notifiedMatches.splice(idx, 1);
            } else {
                notifiedMatches.push(matchKey);
            }
            
            // âœ¨ Firebase ì €ì¥
            saveUserPreferences();
            
            renderViewerResults();
            announce(`ğŸ”” ì•Œë¦¼ ${idx > -1 ? 'í•´ì œ' : 'ì„¤ì •'}`);
        }
        
        // ê²€ìƒ‰ì–´ ì´ˆê¸°í™”
        function clearSearch() {
            const searchInput = document.getElementById('viewer-search');
            if (searchInput) {
                searchInput.value = '';
                renderViewerResults();
                announce('ê²€ìƒ‰ì–´ ì´ˆê¸°í™”ë¨');
            }
        }
        
        // ì¦ê²¨ì°¾ê¸°ë§Œ ë³´ê¸°
        function filterFavoritesOnly() {
            showFavoritesOnly = !showFavoritesOnly;
            renderViewerResults();
            announce(showFavoritesOnly ? 'â­ ì¦ê²¨ì°¾ê¸°ë§Œ í‘œì‹œ' : 'ğŸ“‹ ì „ì²´ í‘œì‹œ');
        }
        
        // ì—°ìŠµ ê²½ê¸° ì‹œì‘
        function startPracticeMode() {
            goTo('practice-mode');
            announce('ğŸ‹ï¸ ì—°ìŠµ ê²½ê¸° ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
        
    </script>
</body>
</html>
