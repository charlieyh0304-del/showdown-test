<!DOCTYPE html>
<html lang="ko" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="ÏáºÎã§Ïö¥ Ïã¨Ìåê Ïï± ÌîÑÎ°ú - ÎåÄÏßÑ ÏÑ§Ï†ï, Ïã¨Ìåê Í¥ÄÎ¶¨, Ïã§ÏãúÍ∞Ñ Ï†êÏàò">
    <meta name="theme-color" content="#4a90d9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ÏáºÎã§Ïö¥">
    <title>ÏáºÎã§Ïö¥ Ïã¨Ìåê Ïï± PRO</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icons/icon-152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/icon-152.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-72.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-72.png">
    
    <!-- Splash Screen for iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-startup-image" href="icons/icon-512.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* ÌÖçÏä§Ìä∏ ÏûÖÎ†• Î∞©Ìñ• Í≥†Ï†ï - Í∏ÄÏûê Îí§ÏßëÌûò Î∞©ÏßÄ */
        input[type="text"],
        input[type="number"],
        input[type="password"],
        input[type="search"],
        input[type="email"],
        input[type="tel"],
        textarea {
            direction: ltr !important;
            text-align: left !important;
            unicode-bidi: bidi-override !important;
            writing-mode: horizontal-tb !important;
            -webkit-rtl-ordering: logical !important;
        }
        
        /* Ï†ÑÏ≤¥ Î¨∏ÏÑú Î∞©Ìñ• */
        html, body, #app {
            direction: ltr !important;
        }
        
        /* ÌÖåÎßà Î≥ÄÏàò */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border: #dadce0;
            --primary: #1a73e8;
            --primary-hover: #1557b0;
            --success: #34a853;
            --warning: #fbbc04;
            --danger: #ea4335;
            --shadow: rgba(0,0,0,0.1);
        }
        
        body.enhanced-contrast {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f0f0;
            --bg-card: #ffffff;
            --text-primary: #000000;
            --text-secondary: #333333;
            --border: #999999;
            --primary: #0066cc;
            --success: #228b22;
            --warning: #cc9900;
            --danger: #cc0000;
        }
        
        body.high-contrast {
            --bg-primary: #ffffff;
            --text-primary: #000000;
            --border: #000000;
            --primary: #0000ff;
            --success: #008000;
            --warning: #ff8c00;
            --danger: #ff0000;
        }
        
        body.inverted {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --bg-card: #000000;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border: #666666;
            --primary: #66b3ff;
            --success: #66ff66;
            --warning: #ffcc66;
            --danger: #ff6666;
        }
        
        body.dark {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-card: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border: #444444;
            --primary: #4d9eff;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }
        
        /* Ïä§ÌÅ¨Î¶∞ Î¶¨Îçî Ï†ÑÏö© (ÌôîÎ©¥Ïóê Î≥¥Ïù¥ÏßÄ ÏïäÏùå) */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        /* ÏãúÎß®Ìã± HTML Ïä§ÌÉÄÏùº */
        main {
            padding: 16px;
            background: var(--bg-card);
            border-radius: 12px;
            margin: 16px;
        }
        
        section {
            margin-bottom: 24px;
        }
        
        fieldset {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        legend {
            padding: 0 8px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .mode-navigation ul {
            list-style: none;
            padding: 0;
        }
        
        .mode-navigation li {
            margin-bottom: 20px;
        }
        
        /* Ìñ•ÏÉÅÎêú Ìèº Ïä§ÌÉÄÏùº */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }
        
        .form-group input:invalid {
            border-color: var(--danger);
        }
        
        .form-group input:valid {
            border-color: var(--success);
        }
        
        /* ÎßÅÌÅ¨ Ïä§ÌÉÄÏùº Î≤ÑÌäº */
        .btn-link {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 14px;
            text-decoration: underline;
            padding: 4px 0;
        }
        
        .btn-link:hover {
            color: var(--primary-hover);
        }
        
        .btn-link:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        *:focus {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
        }
        
        .accessibility-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-bottom: 2px solid var(--border);
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 8px var(--shadow);
        }
        
        .accessibility-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .a11y-btn {
            min-width: 44px;
            min-height: 44px;
            padding: 8px 12px;
            border: 2px solid var(--border);
            background: var(--bg-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        .a11y-btn:hover, .a11y-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 70px 20px 20px;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            padding: 24px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px var(--shadow);
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px var(--shadow);
            border: 1px solid var(--border);
        }
        
        .card h2 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
        }
        
        .btn {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            min-height: 48px;
            margin-bottom: 12px;
            transition: all 0.2s;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary { 
            background: var(--primary); 
            color: white;
            border-color: var(--primary);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
        }
        
        .btn-success { background: var(--success); color: white; border-color: var(--success); }
        .btn-warning { background: var(--warning); color: white; border-color: var(--warning); }
        .btn-danger { background: var(--danger); color: white; border-color: var(--danger); }
        
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            margin: 8px 0;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-top: 12px;
            margin-bottom: 4px;
        }
        
        .score-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin: 24px 0;
        }
        
        .player-score {
            text-align: center;
        }
        
        .score-display {
            font-size: 72px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }
        
        .player-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .serve-indicator {
            margin-top: 8px;
            font-size: 14px;
            color: var(--success);
            font-weight: 600;
        }
        
        .timeout-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }
        
        .timeout-btn {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--warning);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .timeout-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .timeout-count {
            font-size: 12px;
        }
        
        .foul-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .foul-btn {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            min-height: 60px;
            background: var(--warning);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .goal-btn {
            background: var(--success);
            grid-column: 1 / -1;
            min-height: 80px;
            font-size: 18px;
        }
        
        .action-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }
        
        .folder-item, .match-item {
            padding: 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            margin: 12px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .folder-item:hover, .match-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .timer-display {
            font-size: 96px;
            font-weight: 700;
            color: var(--primary);
            margin: 24px 0;
            font-variant-numeric: tabular-nums;
        }
        
        .timer-display.warning {
            color: var(--danger);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 600;
            border: 2px solid var(--success);
            background: var(--bg-secondary);
            text-align: center;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }
        
        .info-item {
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
            border: 1px solid var(--border);
        }
        
        .info-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .info-value {
            font-weight: 600;
        }
        
        @media (max-width: 600px) {
            .score-display { font-size: 56px; }
            .timer-display { font-size: 72px; }
            .foul-grid { grid-template-columns: 1fr; }
            .info-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body dir="ltr">
    <div class="accessibility-bar">
        <div style="display:flex; align-items:center; gap:12px;">
            <div style="font-weight: 600; font-size: 14px;">ÏáºÎã§Ïö¥</div>
            <div id="connection-status"></div>
        </div>
        <div class="accessibility-controls">
            <div style="position:relative;">
                <button class="a11y-btn" onclick="toggleAccessibilityMenu(event)" id="a11y-menu-btn" aria-label="Ï†ëÍ∑ºÏÑ± ÏÑ§Ï†ï Ïó¥Í∏∞" aria-expanded="false" aria-haspopup="true">
                    Ï†ëÍ∑ºÏÑ± ‚ñº
                </button>
                <div id="a11y-dropdown" role="menu" aria-label="Ï†ëÍ∑ºÏÑ± ÏòµÏÖò" style="display:none; position:absolute; right:0; top:100%; margin-top:4px; background:var(--bg-card); border:2px solid var(--border); border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); min-width:160px; z-index:1001;">
                    <div style="padding:8px 0;">
                        <button onclick="setTheme('default', event)" role="menuitem" aria-label="ÏùºÎ∞ò Î™®ÎìúÎ°ú Î≥ÄÍ≤Ω" class="a11y-dropdown-item" style="width:100%; padding:12px 16px; border:none; background:none; text-align:left; cursor:pointer; font-size:14px;">
                            ÏùºÎ∞ò Î™®Îìú
                        </button>
                        <button onclick="setTheme('dark', event)" role="menuitem" aria-label="Îã§ÌÅ¨ Î™®ÎìúÎ°ú Î≥ÄÍ≤Ω" class="a11y-dropdown-item" style="width:100%; padding:12px 16px; border:none; background:none; text-align:left; cursor:pointer; font-size:14px;">
                            Îã§ÌÅ¨ Î™®Îìú
                        </button>
                        <button onclick="setTheme('high-contrast', event)" role="menuitem" aria-label="Í≥†ÎåÄÎπÑ Î™®ÎìúÎ°ú Î≥ÄÍ≤Ω" class="a11y-dropdown-item" style="width:100%; padding:12px 16px; border:none; background:none; text-align:left; cursor:pointer; font-size:14px;">
                            Í≥†ÎåÄÎπÑ
                        </button>
                        <button onclick="setTheme('inverted', event)" role="menuitem" aria-label="ÏÉâÎ∞òÏ†Ñ Î™®ÎìúÎ°ú Î≥ÄÍ≤Ω" class="a11y-dropdown-item" style="width:100%; padding:12px 16px; border:none; background:none; text-align:left; cursor:pointer; font-size:14px;">
                            ÏÉâÎ∞òÏ†Ñ
                        </button>
                        <div style="border-top:1px solid var(--border); margin:8px 0;"></div>
                        <button onclick="toggleLargeText(event)" role="menuitem" aria-label="ÌÅ∞ Í∏ÄÏî® ÏºúÍ∏∞/ÎÅÑÍ∏∞" class="a11y-dropdown-item" style="width:100%; padding:12px 16px; border:none; background:none; text-align:left; cursor:pointer; font-size:14px; display:flex; justify-content:space-between;">
                            ÌÅ∞ Í∏ÄÏî® <span id="large-text-status" style="font-size:12px; color:#666;">OFF</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="container"></div>

    <!-- aria-live Ïã§ÏãúÍ∞Ñ ÏïàÎÇ¥ (ÌôîÎ©¥Ïóê Î≥¥Ïù¥ÏßÄ ÏïäÏùå, Ïä§ÌÅ¨Î¶∞ Î¶¨ÎçîÎßå) -->
    <div aria-live="assertive" aria-atomic="true" class="sr-only" id="live-announcement"></div>

    <!-- ÌÉÄÏûÑÏïÑÏõÉ Î™®Îã¨ -->
    <div id="timeout-modal" class="modal">
        <div class="modal-content">
            <h2 id="timeout-title">ÌÉÄÏûÑÏïÑÏõÉ</h2>
            <div id="timer-display" class="timer-display">60</div>
            <button class="btn btn-danger" onclick="closeTimeout()" style="width:100%" aria-label="ÌÉÄÏûÑÏïÑÏõÉ Ï¢ÖÎ£å">ÌÉÄÏûÑÏïÑÏõÉ Ï¢ÖÎ£å</button>
        </div>
    </div>

    <!-- PIN ÏûÖÎ†• Î™®Îã¨ -->
    <div id="pin-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="pin-modal-title">
        <div class="modal-content" style="max-width:320px;">
            <h2 id="pin-modal-title" style="text-align:center;">Ïã¨Ìåê PIN ÏûÖÎ†•</h2>
            <p id="pin-modal-desc" style="text-align:center; color:#666; font-size:14px; margin-bottom:16px;">Í≤ΩÍ∏∞ Í¥ÄÎ¶¨Î•º ÏúÑÌï¥ PINÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>
            <label for="pin-input" class="sr-only">Ïã¨Ìåê PIN ÏûÖÎ†•</label>
            <input type="password" id="pin-input" placeholder="PIN ÏûÖÎ†•" 
                   aria-describedby="pin-modal-desc pin-error"
                   style="width:100%; padding:16px; font-size:20px; text-align:center; border:2px solid #ddd; border-radius:8px; letter-spacing:4px;"
                   maxlength="8" inputmode="numeric">
            <div id="pin-error" role="alert" aria-live="polite" style="color:#f44336; text-align:center; margin-top:8px; display:none;">PINÏù¥ ÌãÄÎ†∏ÏäµÎãàÎã§</div>
            <div style="display:flex; gap:8px; margin-top:16px;">
                <button class="btn" onclick="closePinModal()" style="flex:1;" aria-label="PIN ÏûÖÎ†• Ï∑®ÏÜå">Ï∑®ÏÜå</button>
                <button class="btn btn-primary" onclick="verifyPin()" style="flex:1;" aria-label="PIN ÌôïÏù∏">ÌôïÏù∏</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Ï¥àÍ∏∞Ìôî
        const firebaseConfig = {
            apiKey: "AIzaSyAKv3QOpSg-hLnyXSnE299fHRV-akpPQCs",
            authDomain: "showdown1-838bf.firebaseapp.com",
            databaseURL: "https://showdown1-838bf-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "showdown1-838bf",
            storageBucket: "showdown1-838bf.firebasestorage.app",
            messagingSenderId: "379033064628",
            appId: "1:379033064628:web:252eef0e38b45859df73e1"
        };
        
        let database = null;
        let auth = null; // Firebase Auth
        let userId = null; // ‚ú® ÏÇ¨Ïö©Ïûê Í≥†Ïú† ID
        
        // Firebase Ï¥àÍ∏∞Ìôî
        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                auth = firebase.auth();
                console.log('‚úÖ Firebase Ïó∞Í≤∞Îê®');
                
                // ‚ú® ÏÇ¨Ïö©Ïûê ID Ï¥àÍ∏∞Ìôî
                initializeUserId();
                
                // ‚ú® Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî ÏãúÏûë
                initializeRealtimeSync();
            } else {
                console.log('Firebase SDK Î°úÎìú ÏïàÎê® - Î°úÏª¨ Î™®Îìú');
            }
        } catch (error) {
            console.log('Firebase Ïó∞Í≤∞ Ïã§Ìå® - Î°úÏª¨ Î™®Îìú:', error);
        }
        
        // ========== Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî ÏãúÏä§ÌÖú ==========
        
        // Firebase Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî Ï¥àÍ∏∞Ìôî
        function initializeRealtimeSync() {
            if (!database) {
                console.log('Firebase Ïó∞Í≤∞ ÏóÜÏùå - Î°úÏª¨ Î™®ÎìúÎ°ú ÎèôÏûë');
                return;
            }
            
            console.log('üîÑ Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî ÏãúÏûë...');
            
            // 1. Ïö¥ÏòÅÏûê Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
            initializeOperatorsSync();
            
            // 2. ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî  
            initializeProjectsSync();
            
            // 3. ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï ÎèôÍ∏∞Ìôî
            initializeUserPreferencesSync();
            
            // 4. Ïã§ÏãúÍ∞Ñ Í≤ΩÍ∏∞ ÏÉÅÌÉú ÎèôÍ∏∞Ìôî
            initializeMatchesSync();
        }
        
        // Ïö¥ÏòÅÏûê Îç∞Ïù¥ÌÑ∞ Firebase ÎèôÍ∏∞Ìôî Ï¥àÍ∏∞Ìôî
        function initializeOperatorsSync() {
            if (!database) return;
            
            // FirebaseÏóêÏÑú Ïö¥ÏòÅÏûê Îç∞Ïù¥ÌÑ∞ Ïã§ÏãúÍ∞Ñ Í∞êÏßÄ
            database.ref('operators').on('value', (snapshot) => {
                const firebaseOperators = snapshot.val();
                if (firebaseOperators && Array.isArray(firebaseOperators) && firebaseOperators.length > 0) {
                    // FirebaseÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ Î°úÏª¨Ïóê ÎèôÍ∏∞Ìôî
                    localStorage.setItem('operators', JSON.stringify(firebaseOperators));
                    console.log('‚úÖ FirebaseÏóêÏÑú Ïö¥ÏòÅÏûê Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞ÌôîÎê®:', firebaseOperators.length + 'Î™Ö');
                } else {
                    // FirebaseÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Î•º FirebaseÏóê ÏóÖÎ°úÎìú
                    const localOperators = JSON.parse(localStorage.getItem('operators') || '[]');
                    if (localOperators.length > 0) {
                        database.ref('operators').set(localOperators);
                        console.log('‚úÖ Î°úÏª¨ Ïö¥ÏòÅÏûê Îç∞Ïù¥ÌÑ∞Î•º FirebaseÏóê ÏóÖÎ°úÎìúÎê®:', localOperators.length + 'Î™Ö');
                    }
                }
            });
        }
        
        // ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Firebase ÎèôÍ∏∞Ìôî
        function initializeProjectsSync() {
            if (!database) return;
            
            // FirebaseÏóêÏÑú ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Ïã§ÏãúÍ∞Ñ Í∞êÏßÄ
            database.ref('projects').on('value', (snapshot) => {
                const firebaseProjects = snapshot.val();
                if (firebaseProjects) {
                    // ObjectÎ•º ArrayÎ°ú Î≥ÄÌôò
                    const projectsArray = Object.keys(firebaseProjects).map(key => ({
                        ...firebaseProjects[key],
                        firebaseKey: key
                    }));
                    
                    // Î°úÏª¨Í≥º Î≥ëÌï© (firebaseKey Í∏∞Ï§ÄÏúºÎ°ú Ï§ëÎ≥µ Ï†úÍ±∞)
                    const localProjects = JSON.parse(localStorage.getItem('projects') || '[]');
                    const mergedProjects = mergeDataArrays(localProjects, projectsArray, 'id');
                    
                    localStorage.setItem('projects', JSON.stringify(mergedProjects));
                    projects = mergedProjects; // Ï†ÑÏó≠ Î≥ÄÏàò ÏóÖÎç∞Ïù¥Ìä∏
                    
                    console.log('‚úÖ FirebaseÏóêÏÑú ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞ÌôîÎê®:', mergedProjects.length + 'Í∞ú');
                    
                    // ÌôîÎ©¥Ïù¥ ÌîÑÎ°úÏ†ùÌä∏ Í¥ÄÎ†®Ïù¥Î©¥ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®
                    if (['project-list', 'bracket-home', 'project-detail'].includes(screen)) {
                        render();
                    }
                }
            });
        }
        
        // ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï ÎèôÍ∏∞Ìôî
        function initializeUserPreferencesSync() {
            if (!database || !userId) return;
            
            database.ref(`userPreferences/${userId}`).on('value', (snapshot) => {
                const prefs = snapshot.val();
                if (prefs) {
                    favoritePlayers = prefs.favorites || [];
                    notifiedMatches = prefs.notifications || [];
                    console.log('‚úÖ FirebaseÏóêÏÑú ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï ÎèôÍ∏∞ÌôîÎê®');
                }
            });
        }
        
        // Ïã§ÏãúÍ∞Ñ Í≤ΩÍ∏∞ ÏÉÅÌÉú ÎèôÍ∏∞Ìôî
        function initializeMatchesSync() {
            if (!database) return;
            
            // Ïã§ÏãúÍ∞Ñ Í≤ΩÍ∏∞ ÏßÑÌñâ ÏÉÅÌÉú Í∞êÏßÄ
            database.ref('liveMatches').on('value', (snapshot) => {
                const liveMatches = snapshot.val();
                if (liveMatches) {
                    // ÏßÑÌñâ Ï§ëÏù∏ Í≤ΩÍ∏∞ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
                    updateLiveMatchesData(liveMatches);
                    
                    // Í¥ÄÎûå Î™®Îìú ÌôîÎ©¥Ïù¥Î©¥ ÏûêÎèô ÏÉàÎ°úÍ≥†Ïπ®
                    if (['viewer-home', 'match-list', 'live-practice'].includes(screen)) {
                        render();
                    }
                }
            });
        }
        
        // Îç∞Ïù¥ÌÑ∞ Î∞∞Ïó¥ Î≥ëÌï© (Ï§ëÎ≥µ Ï†úÍ±∞)
        function mergeDataArrays(localArray, firebaseArray, keyField = 'id') {
            const merged = [...localArray];
            
            firebaseArray.forEach(fbItem => {
                const existingIndex = merged.findIndex(localItem => 
                    localItem[keyField] === fbItem[keyField]
                );
                
                if (existingIndex >= 0) {
                    // Í∏∞Ï°¥ Ìï≠Î™© ÏóÖÎç∞Ïù¥Ìä∏ (Firebase Îç∞Ïù¥ÌÑ∞Í∞Ä Îçî ÏµúÏã†)
                    merged[existingIndex] = { ...merged[existingIndex], ...fbItem };
                } else {
                    // ÏÉà Ìï≠Î™© Ï∂îÍ∞Ä
                    merged.push(fbItem);
                }
            });
            
            return merged;
        }
        
        // FirebaseÏóê Ïö¥ÏòÅÏûê Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        function syncOperatorsToFirebase(operators) {
            if (!database) {
                console.log('Firebase Ïó∞Í≤∞ ÏóÜÏùå - Î°úÏª¨Îßå Ï†ÄÏû•');
                return;
            }
            
            try {
                database.ref('operators').set(operators);
                console.log('‚úÖ Ïö¥ÏòÅÏûê Îç∞Ïù¥ÌÑ∞ Firebase ÎèôÍ∏∞Ìôî ÏôÑÎ£å');
                announceSync('Ïö¥ÏòÅÏûê Ï†ïÎ≥¥ ÎèôÍ∏∞ÌôîÎê®');
            } catch (error) {
                console.warn('Firebase ÎèôÍ∏∞Ìôî Ïã§Ìå®:', error);
            }
        }
        
        // FirebaseÏóê ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        function syncProjectToFirebase(project) {
            if (!database) {
                console.log('Firebase Ïó∞Í≤∞ ÏóÜÏùå - Î°úÏª¨Îßå Ï†ÄÏû•');
                return;
            }
            
            try {
                const projectRef = project.firebaseKey ? 
                    database.ref(`projects/${project.firebaseKey}`) :
                    database.ref('projects').push();
                    
                if (!project.firebaseKey) {
                    project.firebaseKey = projectRef.key;
                }
                
                projectRef.set(project);
                console.log('‚úÖ ÌîÑÎ°úÏ†ùÌä∏ Firebase ÎèôÍ∏∞Ìôî ÏôÑÎ£å:', project.name);
                announceSync(`"${project.name}" ÎåÄÌöå ÎèôÍ∏∞ÌôîÎê®`);
            } catch (error) {
                console.warn('ÌîÑÎ°úÏ†ùÌä∏ Firebase ÎèôÍ∏∞Ìôî Ïã§Ìå®:', error);
            }
        }
        
        // FirebaseÏóê Ïã§ÏãúÍ∞Ñ Í≤ΩÍ∏∞ ÏÉÅÌÉú Ï†ÄÏû•
        function syncLiveMatchToFirebase(match) {
            if (!database || !match.isShared) return;
            
            try {
                database.ref(`liveMatches/${match.id}`).set({
                    id: match.id,
                    player1Name: match.player1Name,
                    player2Name: match.player2Name,
                    setScores: match.setScores,
                    status: match.status,
                    type: match.type,
                    isShared: match.isShared,
                    updatedAt: new Date().toISOString()
                });
                console.log('‚úÖ Ïã§ÏãúÍ∞Ñ Í≤ΩÍ∏∞ Firebase ÎèôÍ∏∞Ìôî:', match.player1Name + ' vs ' + match.player2Name);
                // Í≤ΩÍ∏∞ ÎèôÍ∏∞ÌôîÎäî ÎÑàÎ¨¥ ÏûêÏ£º Î∞úÏÉùÌïòÎØÄÎ°ú ÏïåÎ¶º ÏÉùÎûµ
            } catch (error) {
                console.warn('Ïã§ÏãúÍ∞Ñ Í≤ΩÍ∏∞ ÎèôÍ∏∞Ìôî Ïã§Ìå®:', error);
            }
        }
        
        // Ïã§ÏãúÍ∞Ñ Í≤ΩÍ∏∞ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateLiveMatchesData(liveMatches) {
            Object.keys(liveMatches).forEach(matchId => {
                const liveMatch = liveMatches[matchId];
                
                // Î°úÏª¨ ÌîÑÎ°úÏ†ùÌä∏ÏóêÏÑú Ìï¥Îãπ Í≤ΩÍ∏∞ Ï∞æÏïÑÏÑú ÏóÖÎç∞Ïù¥Ìä∏
                projects.forEach(project => {
                    if (project.matches) {
                        const matchIndex = project.matches.findIndex(m => m.id == matchId);
                        if (matchIndex >= 0) {
                            // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞Î°ú ÏóÖÎç∞Ïù¥Ìä∏
                            project.matches[matchIndex].setScores = liveMatch.setScores;
                            project.matches[matchIndex].status = liveMatch.status;
                            project.matches[matchIndex].updatedAt = liveMatch.updatedAt;
                        }
                    }
                });
            });
            
            // ÏóÖÎç∞Ïù¥Ìä∏Îêú ÌîÑÎ°úÏ†ùÌä∏ Î°úÏª¨ Ï†ÄÏû•
            localStorage.setItem('projects', JSON.stringify(projects));
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Î∞îÎ°ú ÌôîÎ©¥ ÌëúÏãú
        document.addEventListener('DOMContentLoaded', function() {
            // Ï¶âÏãú Ìôà ÌôîÎ©¥ Î†åÎçîÎßÅ
            setTimeout(() => {
                if (typeof render === 'function') {
                    render();
                }
            }, 100);
        });
        
        // ‚ú® ÏÇ¨Ïö©Ïûê ID Ï¥àÍ∏∞Ìôî Ìï®Ïàò
        function initializeUserId() {
            userId = localStorage.getItem('userId');
            if (!userId) {
                // ÏÉà ÏÇ¨Ïö©Ïûê - ID ÏÉùÏÑ±
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
                console.log('‚ú® ÏÉà ÏÇ¨Ïö©Ïûê ID ÏÉùÏÑ±:', userId);
            } else {
                console.log('‚ú® Í∏∞Ï°¥ ÏÇ¨Ïö©Ïûê ID:', userId);
            }
        }
        
        // ÏùåÏÑ± ÏïàÎÇ¥
        let voiceEnabled = localStorage.getItem('voice') !== 'false';
        let isTimeoutActive = false;
        
        function speak(text) {
            if (!voiceEnabled) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = 1.1;
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
        }

        // aria-live Ïã§ÏãúÍ∞Ñ ÏïàÎÇ¥ (Ïä§ÌÅ¨Î¶∞ Î¶¨ÎçîÏö©)
        function announce(text) {
            const liveRegion = document.getElementById('live-announcement');
            if (liveRegion) {
                liveRegion.textContent = text;
            }
        }

        // ÌÖåÎßà ÏàúÌôò
        const themes = [
            { id: 'normal', name: 'ÏùºÎ∞ò' },
            { id: 'enhanced-contrast', name: 'Î™ÖÎèÑÎåÄÎπÑ' },
            { id: 'high-contrast', name: 'Í≥†ÎåÄÎπÑ' },
            { id: 'inverted', name: 'ÏÉâÎ∞òÏ†Ñ' },
            { id: 'dark', name: 'Îã§ÌÅ¨' }
        ];
        let currentThemeIndex = 0;

        function cycleTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            const theme = themes[currentThemeIndex];
            
            document.body.className = theme.id === 'normal' ? '' : theme.id;
            localStorage.setItem('theme', theme.id);
            localStorage.setItem('themeIndex', currentThemeIndex);
            
            const themeBtn = document.getElementById('theme-btn');
            if (themeBtn) themeBtn.textContent = `Î™®Îìú: ${theme.name}`;
            speak(`${theme.name} Î™®ÎìúÎ°ú Î≥ÄÍ≤ΩÎê®`);
        }
        
        // Ï†ëÍ∑ºÏÑ± ÎìúÎ°≠Îã§Ïö¥ ÌÜ†Í∏Ä
        function toggleAccessibilityMenu(e) {
            if (e) e.stopPropagation();
            const dropdown = document.getElementById('a11y-dropdown');
            const btn = document.getElementById('a11y-menu-btn');
            const isOpen = dropdown.style.display !== 'none';
            
            dropdown.style.display = isOpen ? 'none' : 'block';
            btn.setAttribute('aria-expanded', !isOpen);
            
            // Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
            if (!isOpen) {
                setTimeout(() => {
                    document.addEventListener('click', closeA11yMenuOnClickOutside);
                }, 10);
            }
        }
        
        function closeA11yMenuOnClickOutside(e) {
            const dropdown = document.getElementById('a11y-dropdown');
            const btn = document.getElementById('a11y-menu-btn');
            if (!dropdown.contains(e.target) && e.target !== btn) {
                dropdown.style.display = 'none';
                btn.setAttribute('aria-expanded', 'false');
                document.removeEventListener('click', closeA11yMenuOnClickOutside);
            }
        }
        
        // ÌÖåÎßà ÏßÅÏ†ë ÏÑ§Ï†ï
        function setTheme(themeId, e) {
            if (e) e.stopPropagation();
            const themeMap = {
                'default': { id: 'normal', name: 'ÏùºÎ∞ò', class: '' },
                'dark': { id: 'dark', name: 'Îã§ÌÅ¨', class: 'dark' },
                'high-contrast': { id: 'high-contrast', name: 'Í≥†ÎåÄÎπÑ', class: 'high-contrast' },
                'inverted': { id: 'inverted', name: 'ÏÉâÎ∞òÏ†Ñ', class: 'inverted' }
            };
            
            const theme = themeMap[themeId] || themeMap['default'];
            document.body.className = theme.class;
            localStorage.setItem('theme', theme.id);
            
            // ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞
            document.getElementById('a11y-dropdown').style.display = 'none';
            document.getElementById('a11y-menu-btn').setAttribute('aria-expanded', 'false');
            document.removeEventListener('click', closeA11yMenuOnClickOutside);
            
            announce(`${theme.name} Î™®ÎìúÎ°ú Î≥ÄÍ≤ΩÎê®`);
        }
        
        // ÌÅ∞ Í∏ÄÏî® ÌÜ†Í∏Ä
        let largeTextEnabled = localStorage.getItem('largeText') === 'true';
        
        function toggleLargeText(e) {
            if (e) e.stopPropagation();
            largeTextEnabled = !largeTextEnabled;
            localStorage.setItem('largeText', largeTextEnabled);
            
            if (largeTextEnabled) {
                document.body.style.fontSize = '18px';
            } else {
                document.body.style.fontSize = '';
            }
            
            const statusEl = document.getElementById('large-text-status');
            if (statusEl) statusEl.textContent = largeTextEnabled ? 'ON' : 'OFF';
            
            // ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞
            document.getElementById('a11y-dropdown').style.display = 'none';
            document.getElementById('a11y-menu-btn').setAttribute('aria-expanded', 'false');
            document.removeEventListener('click', closeA11yMenuOnClickOutside);
            
            announce(largeTextEnabled ? 'ÌÅ∞ Í∏ÄÏî® ÏºúÏßê' : 'ÌÅ∞ Í∏ÄÏî® Í∫ºÏßê');
        }
        
        // Ï¥àÍ∏∞ ÌÅ∞ Í∏ÄÏî® Ï†ÅÏö©
        if (largeTextEnabled) {
            document.body.style.fontSize = '18px';
        }

        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            localStorage.setItem('voice', voiceEnabled);
            speak(voiceEnabled ? 'ÏùåÏÑ± ÏïàÎÇ¥ ÏºúÏßê' : 'ÏùåÏÑ± ÏïàÎÇ¥ Í∫ºÏßê');
            document.getElementById('voice-btn').style.opacity = voiceEnabled ? '1' : '0.5';
        }

        // Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞
        let projects = [];
        let currentProject = null;
        let currentMatch = null;
        let screen = 'home';
        let timeoutTimer = null;
        let timeoutSeconds = 60;
        let isAuthenticated = false; // Ïã¨Ìåê Ïù∏Ï¶ù Ïó¨Î∂Ä
        let isPaused = false; // Í≤ΩÍ∏∞ ÏùºÏãúÏ†ïÏßÄ ÏÉÅÌÉú
        let warmupActive = false; // ÏõåÎ∞çÏóÖ ÏßÑÌñâ ÏÉÅÌÉú
        let warmupSeconds = 60; // ÏõåÎ∞çÏóÖ ÎÇ®ÏùÄ ÏãúÍ∞Ñ (IBSA: Í∞úÏù∏Ï†Ñ 60Ï¥à)
        let warmupTimer = null; // ÏõåÎ∞çÏóÖ ÌÉÄÏù¥Î®∏
        let pauseTimer = null; // ÏùºÏãúÏ†ïÏßÄ ÌÉÄÏù¥Î®∏
        let pauseSeconds = 0; // ÏùºÏãúÏ†ïÏßÄ Í≤ΩÍ≥º ÏãúÍ∞Ñ
        let isOffline = !navigator.onLine; // Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉú
        let userRole = null; // 'referee' ÎòêÎäî 'viewer'
        let favoritePlayers = []; // Ï¶êÍ≤®Ï∞æÍ∏∞ ÏÑ†Ïàò
        let notifiedMatches = []; // ÏïåÎ¶º ÏÑ§Ï†ïÎêú Í≤ΩÍ∏∞
        let showFavoritesOnly = false; // Ï¶êÍ≤®Ï∞æÍ∏∞Îßå ÌëúÏãú
        
        // Ïò§ÌîÑÎùºÏù∏ Í∞êÏßÄ
        window.addEventListener('online', () => {
            isOffline = false;
            syncOfflineData();
            announce('Ïò®ÎùºÏù∏ Ïó∞Í≤∞Îê®. Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî Ï§ë...');
        });
        window.addEventListener('offline', () => {
            isOffline = true;
            announce('Ïò§ÌîÑÎùºÏù∏ Î™®Îìú. Î°úÏª¨Ïóê Ï†ÄÏû•Îê©ÎãàÎã§.');
        });
        
        // Ïò§ÌîÑÎùºÏù∏ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî
        function syncOfflineData() {
            try {
                const offlineData = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
                if (offlineData.length > 0 && database) {
                    offlineData.forEach(item => {
                        if (item.type === 'project') {
                            database.ref('projects/' + item.key).set(item.data);
                        }
                    });
                    localStorage.removeItem('offlineQueue');
                    console.log('Ïò§ÌîÑÎùºÏù∏ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî ÏôÑÎ£å');
                }
            } catch (error) {
                console.error('Ïò§ÌîÑÎùºÏù∏ Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî Ïò§Î•ò:', error);
                localStorage.removeItem('offlineQueue'); // ÏÜêÏÉÅÎêú Îç∞Ïù¥ÌÑ∞ Ï†úÍ±∞
            }
        }
        
        // FirebaseÏóêÏÑú ÌîÑÎ°úÏ†ùÌä∏ Î°úÎìú
        let isUserAction = false; // ÏÇ¨Ïö©Ïûê Ïï°ÏÖò Ï§ë ÌîåÎûòÍ∑∏
        
        let matchSelectionInProgress = false; // Í≤ΩÍ∏∞ ÏÑ†ÌÉù Ï§ë ÌîåÎûòÍ∑∏
        
        function loadProjects() {
            try {
                if (!database) {
                    console.log('Firebase ÎØ∏Ïó∞Í≤∞ - Î°úÏª¨ Î™®Îìú');
                    try {
                        projects = JSON.parse(localStorage.getItem('projects') || '[]');
                    } catch (parseError) {
                        console.error('Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò:', parseError);
                        projects = [];
                        localStorage.removeItem('projects'); // ÏÜêÏÉÅÎêú Îç∞Ïù¥ÌÑ∞ Ï†úÍ±∞
                    }
                    checkUrlProjectParam();
                    render();
                    return;
                }
                console.log('FirebaseÏóêÏÑú ÌîÑÎ°úÏ†ùÌä∏ Î°úÎìú Ï§ë...');
                
                let isFirstLoad = true;
                database.ref('projects').on('value', (snapshot) => {
                    const data = snapshot.val();
                    projects = data ? Object.keys(data).map(key => ({...data[key], firebaseKey: key})) : [];
                    console.log('Î°úÎìúÎêú ÌîÑÎ°úÏ†ùÌä∏:', projects.length);
                    
                    // Ï≤´ Î°úÎìúÏãú URL ÌååÎùºÎØ∏ÌÑ∞ ÌôïÏù∏
                    if (isFirstLoad) {
                        isFirstLoad = false;
                        checkUrlProjectParam();
                        render();
                        return;
                    }
                    
                    // Í≤ΩÍ∏∞ ÏÑ†ÌÉù Ï§ëÏù¥Î©¥ Î†åÎçîÎßÅ Ïïà Ìï®
                    if (matchSelectionInProgress || isUserAction) {
                        return;
                    }
                    
                    // ÌòÑÏû¨ ÌîÑÎ°úÏ†ùÌä∏/Í≤ΩÍ∏∞ Îç∞Ïù¥ÌÑ∞ Í∞±Ïã†
                    if (currentProject && currentProject.firebaseKey) {
                        const updatedProject = projects.find(p => p.firebaseKey === currentProject.firebaseKey);
                        if (updatedProject) {
                            currentProject = updatedProject;
                            if (currentMatch && currentProject.matches) {
                                const matchIndex = currentProject.matches.findIndex(m => m.id === currentMatch.id);
                                if (matchIndex >= 0) {
                                    currentMatch = currentProject.matches[matchIndex];
                                }
                            }
                        }
                    }
                    
                    // match ÌôîÎ©¥ - Í¥ÄÎûå Î™®ÎìúÏùº ÎïåÎßå Ïã§ÏãúÍ∞Ñ Í∞±Ïã†
                    if (screen === 'match' && currentMatch) {
                        if (!isAuthenticated) {
                            // Í¥ÄÎûå Î™®Îìú - Ïã§ÏãúÍ∞Ñ Ï†êÏàò Í∞±Ïã†
                            renderMatch();
                        }
                        // Ïã¨Ìåê Î™®ÎìúÎäî ÎìùÏ†ê ÏûÖÎ†• Ïãú ÏßÅÏ†ë Î†åÎçîÎßÅÌïòÎØÄÎ°ú Î¨¥Ïãú
                        return;
                    }
                    
                    // project-detail ÌôîÎ©¥ÎèÑ Î¨¥Ïãú (Í≤ΩÍ∏∞ ÏßÑÏûÖ Î∞©Ìï¥ Î∞©ÏßÄ)
                    if (screen === 'project-detail') {
                        return;
                    }
                    
                    // ÎÇòÎ®∏ÏßÄ ÌôîÎ©¥Îßå ÏûêÎèô Í∞±Ïã†
                    render();
                });
            } catch (error) {
                console.log('Firebase Î°úÎìú Ïã§Ìå® - Î°úÏª¨ Î™®Îìú:', error);
                try {
                    projects = JSON.parse(localStorage.getItem('projects') || '[]');
                } catch (parseError) {
                    console.error('Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ ÌååÏã± Ïò§Î•ò:', parseError);
                    projects = [];
                }
                checkUrlProjectParam();
                render();
            }
        }
        
        // URL ÌååÎùºÎØ∏ÌÑ∞Î°ú ÌîÑÎ°úÏ†ùÌä∏ ÏßÅÏ†ë Ï†ëÏÜç
        function checkUrlProjectParam() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project');
            
            if (projectId) {
                const projectIndex = projects.findIndex(p => String(p.id) === String(projectId));
                if (projectIndex >= 0) {
                    // ÌîÑÎ°úÏ†ùÌä∏ Î∞úÍ≤¨ - Î∞îÎ°ú Ïó¥Í∏∞
                    currentProject = projects[projectIndex];
                    userRole = 'viewer'; // Í¥ÄÎûå Î™®ÎìúÎ°ú Ï†ëÏÜç
                    screen = 'viewer-results';
                    console.log('URL ÌååÎùºÎØ∏ÌÑ∞Î°ú ÌîÑÎ°úÏ†ùÌä∏ Ï†ëÏÜç:', currentProject.name);
                    
                    // URL ÌååÎùºÎØ∏ÌÑ∞ Ï†úÍ±∞ (ÌûàÏä§ÌÜ†Î¶¨ Ï†ïÎ¶¨)
                    window.history.replaceState({}, '', window.location.pathname);
                }
            }
        }
        
        // FirebaseÏóê ÌîÑÎ°úÏ†ùÌä∏ Ï†ÄÏû• (Ïò§ÌîÑÎùºÏù∏ ÏßÄÏõê)
        function saveProjects() {
            // Ìï≠ÏÉÅ Î°úÏª¨Ïóê Ï†ÄÏû• (Ïò§ÌîÑÎùºÏù∏ Î∞±ÏóÖ)
            localStorage.setItem('projects', JSON.stringify(projects));
            
            if (!database) {
                console.log('Î°úÏª¨ Ï†ÄÏû• ÏôÑÎ£å (Firebase Ïó∞Í≤∞ ÏóÜÏùå)');
                return;
            }
            
            try {
                if (!isOffline) {
                    // Ïò®ÎùºÏù∏: Î™®Îì† ÌîÑÎ°úÏ†ùÌä∏Î•º FirebaseÏóê ÎèôÍ∏∞Ìôî
                    projects.forEach(project => {
                        syncProjectToFirebase(project);
                    });
                    console.log('‚úÖ Ï†ÑÏ≤¥ ÌîÑÎ°úÏ†ùÌä∏ Firebase ÎèôÍ∏∞Ìôî ÏôÑÎ£å');
                } else {
                    // Ïò§ÌîÑÎùºÏù∏: ÌÅêÏóê Ï†ÄÏû•
                    const queue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
                    projects.forEach(project => {
                        queue.push({
                            type: 'project',
                            action: 'sync',
                            data: project,
                            timestamp: Date.now()
                        });
                    });
                    localStorage.setItem('offlineQueue', JSON.stringify(queue));
                    console.log('üì¥ Ïò§ÌîÑÎùºÏù∏ ÌÅêÏóê Ï†ÄÏû•Îê®');
                }
            } catch (error) {
                console.error('Ï†ÄÏû• ÏóêÎü¨:', error);
            }
        }
        
        // Ïã§ÏãúÍ∞Ñ Í≤ΩÍ∏∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (Firebase ÎèôÍ∏∞Ìôî Ìè¨Ìï®)
        function updateLiveMatchStatus(match) {
            // Î°úÏª¨ ÏóÖÎç∞Ïù¥Ìä∏
            saveProjects();
            
            // Firebase Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî
            if (match.isShared) {
                syncLiveMatchToFirebase(match);
            }
        }
        
        // Ïò§ÌîÑÎùºÏù∏ ÌÅê Ï≤òÎ¶¨ (Ïò®ÎùºÏù∏ Î≥µÍµ¨Ïãú)
        function processOfflineQueue() {
            if (!database || isOffline) return;
            
            const queue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
            if (queue.length === 0) return;
            
            console.log('üì§ Ïò§ÌîÑÎùºÏù∏ ÌÅê Ï≤òÎ¶¨ ÏãúÏûë:', queue.length + 'Í∞ú');
            
            queue.forEach(item => {
                switch(item.type) {
                    case 'project':
                        syncProjectToFirebase(item.data);
                        break;
                    case 'operators':
                        syncOperatorsToFirebase(item.data);
                        break;
                    case 'liveMatch':
                        syncLiveMatchToFirebase(item.data);
                        break;
                }
            });
            
            // ÌÅê ÎπÑÏö∞Í∏∞
            localStorage.removeItem('offlineQueue');
            console.log('‚úÖ Ïò§ÌîÑÎùºÏù∏ ÌÅê Ï≤òÎ¶¨ ÏôÑÎ£å');
        }
        
        // ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉú Í∞êÏßÄ
        window.addEventListener('online', () => {
            isOffline = false;
            updateConnectionStatus();
            console.log('üåê Ïò®ÎùºÏù∏ Î≥µÍµ¨Îê®');
            processOfflineQueue();
            render();
        });
        
        window.addEventListener('offline', () => {
            isOffline = true;
            updateConnectionStatus();
            console.log('üì¥ Ïò§ÌîÑÎùºÏù∏ Î™®Îìú');
            render();
        });
        
        // Ïó∞Í≤∞ ÏÉÅÌÉú UI ÏóÖÎç∞Ïù¥Ìä∏
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connection-status');
            if (!statusElement) return;
            
            let statusHTML = '';
            
            if (isOffline) {
                statusHTML = `
                    <div style="background:#ff9800; color:white; padding:4px 8px; border-radius:12px; font-size:12px; display:flex; align-items:center; gap:4px;">
                        üì¥ Ïò§ÌîÑÎùºÏù∏
                    </div>
                `;
            } else if (database) {
                statusHTML = `
                    <div style="background:#4caf50; color:white; padding:4px 8px; border-radius:12px; font-size:12px; display:flex; align-items:center; gap:4px;">
                        ‚úÖ Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî
                    </div>
                `;
            } else {
                statusHTML = `
                    <div style="background:#9e9e9e; color:white; padding:4px 8px; border-radius:12px; font-size:12px; display:flex; align-items:center; gap:4px;">
                        üíæ Î°úÏª¨ Ï†ÄÏû•
                    </div>
                `;
            }
            
            statusElement.innerHTML = statusHTML;
        }
        
        // ÎèôÍ∏∞Ìôî ÏÉÅÌÉú ÏïåÎ¶º
        function announceSync(message) {
            console.log('üîÑ ' + message);
            
            // ÌôîÎ©¥Ïóê ÏïåÎ¶º ÌëúÏãú (3Ï¥à ÌõÑ ÏûêÎèô Ï†úÍ±∞)
            const notification = document.createElement('div');
            notification.style.cssText = `
                position:fixed; 
                top:60px; 
                right:20px; 
                background:#4caf50; 
                color:white; 
                padding:12px 16px; 
                border-radius:8px; 
                font-size:14px; 
                z-index:9999; 
                box-shadow:0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease-out;
            `;
            notification.innerHTML = `
                <div style="display:flex; align-items:center; gap:8px;">
                    üîÑ ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // Ïï†ÎãàÎ©îÏù¥ÏÖò CSS Ï∂îÍ∞Ä
        if (!document.getElementById('sync-animations')) {
            const style = document.createElement('style');
            style.id = 'sync-animations';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Ï¥àÍ∏∞ Î°úÎìú
        setTimeout(() => {
            loadProjects();
            loadUserPreferences(); // ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Î°úÎìú
            loadPracticeMatchesFromFirebase(); // ‚ú® Firebase Ïó∞Ïäµ Í≤ΩÍ∏∞ Î°úÎìú
            
            // Ïó∞Í≤∞ ÏÉÅÌÉú Ï¶âÏãú ÌëúÏãú
            updateConnectionStatus();
            
            // Firebase Ïó∞Í≤∞ ÏÑ±Í≥µ Ïãú ÏïåÎ¶º
            if (database && !isOffline) {
                setTimeout(() => {
                    announceSync('Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî ÌôúÏÑ±ÌôîÎê®');
                }, 2000);
            }
        }, 1000);


        const FOULS = [
            { id: 'irregular-serve', name: 'Î∂ÄÏ†ï ÏÑúÎ∏å', points: 1 },
            { id: 'centerboard', name: 'ÏÑºÌÑ∞Î≥¥Îìú', points: 1 },
            { id: 'body-touch', name: 'Î∞îÎîîÌÑ∞Ïπò', points: 1 },
            { id: 'out', name: 'ÏïÑÏõÉ', points: 1 },
            { id: 'mask-touch', name: 'Í≥†Í∏ÄÌÑ∞Ïπò', points: 2 },
            { id: 'delay', name: 'ÏßÄÏó∞ÌñâÏúÑ', points: 1 },
            { id: '2-second', name: '2Ï¥àÎ£∞', points: 1 }
        ];

        function render() {
            const app = document.getElementById('app');
            
            // ÌéòÏù¥ÏßÄ ÌÉÄÏù¥ÌãÄ ÏÑ§Ï†ï
            const pageTitles = {
                'home': 'ÏáºÎã§Ïö¥ Ïã¨Ìåê Ïï± - Ìôà',
                'referee-home': 'Ïã¨Ìåê Î™®Îìú - ÏáºÎã§Ïö¥',
                'referee-project-list': 'ÎåÄÌöå/Í≤ΩÍ∏∞ Î™©Î°ù - Ïã¨Ìåê Î™®Îìú',
                'admin-home': 'Í¥ÄÎ¶¨Ïûê Î™®Îìú - ÏáºÎã§Ïö¥',
                'admin-settings': 'Í¥ÄÎ¶¨Ïûê ÏÑ§Ï†ï - ÏáºÎã§Ïö¥',
                'bracket-home': 'ÎåÄÏßÑ ÏÑ§Ï†ï - ÏáºÎã§Ïö¥',
                'bracket-detail': 'ÎåÄÌöå ÏÉÅÏÑ∏ - ÏáºÎã§Ïö¥',
                'referee-manage': 'Ïã¨Ìåê Í¥ÄÎ¶¨ - ÏáºÎã§Ïö¥',
                'court-manage': 'Í≤ΩÍ∏∞Ïû• Í¥ÄÎ¶¨ - ÏáºÎã§Ïö¥',
                'viewer-home': 'Í¥ÄÎûå Î™®Îìú - ÏáºÎã§Ïö¥',
                'viewer-results': 'Í≤ΩÍ∏∞ Í≤∞Í≥º - ÏáºÎã§Ïö¥',
                'match': 'Í≤ΩÍ∏∞ ÏßÑÌñâ - ÏáºÎã§Ïö¥',
                'practice-mode': 'Ïó∞Ïäµ Í≤ΩÍ∏∞ - ÏáºÎã§Ïö¥',
                'practice-history': 'Í≤ΩÍ∏∞ Í∏∞Î°ù - ÏáºÎã§Ïö¥',
                'tournament-wizard': 'ÎåÄÌöå ÏÉùÏÑ± - ÏáºÎã§Ïö¥',
                'random-team-league': 'ÎûúÎç§ ÌåÄÎ¶¨Í∑∏ - ÏáºÎã§Ïö¥',
                'operator-setup': 'Ïö¥ÏòÅÏûê Îì±Î°ù - ÏáºÎã§Ïö¥',
                'admin-password': 'Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏Ïù∏ - ÏáºÎã§Ïö¥',
                'password-reset': 'ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞ - ÏáºÎã§Ïö¥',
                'project-detail': 'ÎåÄÌöå ÏÉÅÏÑ∏ - ÏáºÎã§Ïö¥',
                'bracket-password': 'Í¥ÄÎ¶¨Ïûê Ïù∏Ï¶ù - ÏáºÎã§Ïö¥',
                'referee-password': 'Ïã¨Ìåê Ïù∏Ï¶ù - ÏáºÎã§Ïö¥',
                'quick-project': 'Îπ†Î•∏ ÎåÄÌöå - ÏáºÎã§Ïö¥',
                'group-detail': 'Ï°∞Î≥Ñ Î¶¨Í∑∏ - ÏáºÎã§Ïö¥',
                'tournament-courts': 'Í≤ΩÍ∏∞Ïû• ÏÑ§Ï†ï - ÏáºÎã§Ïö¥',
                'tournament-referees': 'Ïã¨Ìåê ÏÑ§Ï†ï - ÏáºÎã§Ïö¥',
                'referee-assignments': 'Ïã¨Ìåê Î∞∞Ï†ï - ÏáºÎã§Ïö¥',
                'player-schedule': 'ÎÇ¥ Í≤ΩÍ∏∞ Ïä§ÏºÄÏ§Ñ - ÏáºÎã§Ïö¥',
                'referee-schedule': 'ÎÇ¥ Ïã¨Ìåê Ïä§ÏºÄÏ§Ñ - ÏáºÎã§Ïö¥', 
                'schedule-overview': 'Ï†ÑÏ≤¥ Ïä§ÏºÄÏ§Ñ - ÏáºÎã§Ïö¥'
            };
            document.title = pageTitles[screen] || 'ÏáºÎã§Ïö¥ Ïã¨Ìåê Ïï±';
            
            // Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉú ÌëúÏãú
            const offlineIndicator = isOffline ? 
                '<div role="alert" style="background:#ff9800; color:white; padding:8px 16px; text-align:center; font-size:14px; margin-bottom:16px; border-radius:8px;">Ïò§ÌîÑÎùºÏù∏ Î™®Îìú - Îç∞Ïù¥ÌÑ∞Í∞Ä Î°úÏª¨Ïóê Ï†ÄÏû•Îê©ÎãàÎã§</div>' : '';
            
            if (screen === 'home') {
                app.innerHTML = `
                    ${offlineIndicator}
                    <header class="header">
                        <h1>ÏáºÎã§Ïö¥ Ïã¨Ìåê Ïï±</h1>
                        <p>Í¥ÄÎûå ¬∑ Ïã¨Ìåê ¬∑ Í¥ÄÎ¶¨</p>
                    </header>
                    
                    <main>
                        <section>
                            <h2>Î™®Îìú ÏÑ†ÌÉù</h2>
                            <p>ÏÇ¨Ïö© Î™©Ï†ÅÏóê ÎßûÎäî Î™®ÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                            
                            <nav class="mode-navigation">
                                <ul style="list-style:none; padding:0;">
                                    <li style="margin-bottom:24px;">
                                        <button type="button" class="btn btn-primary" onclick="selectRole('viewer')" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); width:100%; margin-bottom:8px;">
                                            Í¥ÄÎûå Î™®Îìú
                                        </button>
                                        <p style="font-size:14px; color:var(--text-secondary); margin:0;">
                                            Ïã§ÏãúÍ∞Ñ Ï†êÏàò ÌôïÏù∏, Í≤ΩÍ∏∞ ÏùºÏ†ï, ÎåÄÌöå Í≤∞Í≥º
                                        </p>
                                    </li>
                                    
                                    <li style="margin-bottom:24px;">
                                        <button type="button" class="btn btn-primary" onclick="goTo('referee-home')" style="background:var(--success); width:100%; margin-bottom:8px;">
                                            Ïã¨Ìåê Î™®Îìú
                                        </button>
                                        <p style="font-size:14px; color:var(--text-secondary); margin:0;">
                                            Í≤ΩÍ∏∞ ÏßÑÌñâ, ÎìùÏ†ê ÏûÖÎ†•, Ïó∞Ïäµ Í≤ΩÍ∏∞
                                        </p>
                                    </li>
                                    
                                    <li>
                                        <button type="button" class="btn btn-primary" onclick="enterAdminMode()" style="background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%); width:100%; margin-bottom:8px;">
                                            Í¥ÄÎ¶¨Ïûê Î™®Îìú
                                        </button>
                                        <p style="font-size:14px; color:var(--text-secondary); margin:0;">
                                            ÎåÄÏßÑ ÏÑ§Ï†ï, Ïã¨Ìåê Í¥ÄÎ¶¨, Í≤ΩÍ∏∞Ïû• Í¥ÄÎ¶¨
                                        </p>
                                    </li>
                                </ul>
                            </nav>
                        </section>
                    </main>
                `;
            }
            else if (screen === 'referee-home') {
                // ÏµúÍ∑º Í≤ΩÍ∏∞ Í∏∞Î°ù Ïàò
                const practiceHistory = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
                const recentCount = practiceHistory.length;
                
                // ÏßÑÌñâ Ï§ëÏù∏ Ïó∞Ïäµ Í≤ΩÍ∏∞ ÌôïÏù∏
                let resumeCard = '';
                try {
                    const savedState = sessionStorage.getItem('practiceState');
                    if (savedState) {
                        const state = JSON.parse(savedState);
                        const project = projects.find(p => p.id === state.projectId);
                        if (project) {
                            const match = project.matches?.find(m => m.id === state.matchId);
                            if (match && match.status === 'in-progress') {
                                const set = match.setScores[match.currentSet - 1];
                                resumeCard = `
                                    <div class="card" style="background:linear-gradient(135deg, #f44336 0%, #c62828 100%); color:white; border:3px solid #ff5722;">
                                        <h2 style="color:white;">‚ö†Ô∏è ÏßÑÌñâ Ï§ëÏù∏ Ïó∞Ïäµ Í≤ΩÍ∏∞</h2>
                                        <div style="background:rgba(255,255,255,0.2); padding:12px; border-radius:8px; margin:12px 0;">
                                            <div style="font-size:16px; font-weight:600;">${match.player1Name} vs ${match.player2Name}</div>
                                            <div style="font-size:14px; margin-top:4px;">ÏÑ∏Ìä∏ ${match.currentSet}/${match.sets} ¬∑ Ïä§ÏΩîÏñ¥: ${set.player1} - ${set.player2}</div>
                                        </div>
                                        <button type="button" class="btn" onclick="resumePractice()" style="background:white; color:#f44336; width:100%; font-weight:700;">
                                            üîÑ Ïù¥Ïñ¥ÏÑú ÏßÑÌñâÌïòÍ∏∞
                                        </button>
                                        <button type="button" class="btn" onclick="sessionStorage.removeItem('practiceState'); render();" style="background:rgba(255,255,255,0.2); color:white; width:100%; margin-top:8px;">
                                            Í≤ΩÍ∏∞ Ï∑®ÏÜå
                                        </button>
                                    </div>
                                `;
                            }
                        }
                    }
                } catch (e) {}
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                        <h1 style="color:white;">Ïã¨Ìåê Î™®Îìú</h1>
                        <p style="color:rgba(255,255,255,0.9);">Í≤ΩÍ∏∞ ÏßÑÌñâ ¬∑ ÎìùÏ†ê ÏûÖÎ†•</p>
                    </div>
                    
                    <main role="main">
                    ${resumeCard}
                    <div class="card">
                        <div style="background:#e8f5e9; border-left:4px solid #4caf50; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>ÎåÄÌöå Í≤ΩÍ∏∞</strong><br>
                            <span style="font-size:14px;">ÎåÄÏßÑ ÏÑ§Ï†ïÏóêÏÑú ÏÉùÏÑ±Îêú ÎåÄÌöåÏùò Í≤ΩÍ∏∞Î•º ÏßÑÌñâÌï©ÎãàÎã§.</span>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="goTo('referee-project-list')" style="width:100%; background:#4caf50;" aria-label="ÎåÄÌöå Í≤ΩÍ∏∞ Î™©Î°ù Î≥¥Í∏∞">
                            ÎåÄÌöå/Í≤ΩÍ∏∞ Î™©Î°ù
                        </button>
                        <p style="font-size:12px; color:#666; margin-top:8px; text-align:center;">Í≤ΩÍ∏∞Î≥Ñ PINÏúºÎ°ú Ïù∏Ï¶ù ÌõÑ ÏßÑÌñâ</p>
                    </div>
                    
                    <div class="card" style="background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%); color:white;">
                        <h2 style="color:white;">Ïó∞Ïäµ Í≤ΩÍ∏∞</h2>
                        <p style="font-size:13px; margin-bottom:12px; opacity:0.9;">ÌîÑÎ°úÏ†ùÌä∏ ÏóÜÏù¥ Î∞îÎ°ú Í≤ΩÍ∏∞Î•º ÏßÑÌñâÌï©ÎãàÎã§. Ïã§ÏãúÍ∞Ñ Í≥µÏú† Í∞ÄÎä•!</p>
                        <button type="button" class="btn" onclick="goTo('practice-mode')" style="background:white; color:#ff5722; width:100%;" aria-label="Ïó∞Ïäµ Í≤ΩÍ∏∞ ÏãúÏûëÌïòÍ∏∞">
                            Ïó∞Ïäµ Í≤ΩÍ∏∞ ÏãúÏûë
                        </button>
                    </div>
                    
                    <div class="card">
                        <h2>Í≤ΩÍ∏∞ Í∏∞Î°ù</h2>
                        <p style="font-size:13px; color:var(--text-secondary); margin-bottom:12px;">Ï†ÄÏû•Îêú Ïó∞Ïäµ Í≤ΩÍ∏∞ Í∏∞Î°ù ${recentCount}Í±¥</p>
                        <button type="button" class="btn" onclick="goTo('practice-history')" style="width:100%;" aria-label="Í≤ΩÍ∏∞ Í∏∞Î°ù ${recentCount}Í±¥ Î≥¥Í∏∞">
                            Í∏∞Î°ù Î≥¥Í∏∞
                        </button>
                    </div>
                    
                    <div class="card">
                        <h2>ÎÇ¥ Ïã¨Ìåê Ïä§ÏºÄÏ§Ñ</h2>
                        <p style="font-size:13px; color:var(--text-secondary); margin-bottom:12px;">Î∞∞Ï†ïÎêú Í≤ΩÍ∏∞ ÏùºÏ†ïÍ≥º Í≤ΩÍ∏∞Ïû•ÏùÑ ÌôïÏù∏Ìï©ÎãàÎã§</p>
                        <button type="button" class="btn" onclick="goTo('referee-schedule')" style="width:100%; background:#9c27b0; color:white;">
                            üìÖ ÎÇ¥ Ïã¨Ìåê Ïä§ÏºÄÏ§Ñ Î≥¥Í∏∞
                        </button>
                    </div>
                    
                    <div class="card">
                        <button type="button" class="btn" onclick="goTo('home')">‚Üê Î™®Îìú ÏÑ†ÌÉùÏúºÎ°ú</button>
                    </div>
                    </main>
                `;
            }
            // Ïã¨ÌåêÏö© ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù (PIN Ïù∏Ï¶ù Î∞©Ïãù)
            else if (screen === 'referee-project-list') {
                const projectList = projects.filter(p => p.matches && p.matches.length > 0).map((p, i) => {
                    const actualIndex = projects.indexOf(p);
                    const activeMatches = p.matches.filter(m => m.status !== 'completed').length;
                    const completedMatches = p.matches.filter(m => m.status === 'completed').length;
                    return `
                        <div style="padding:16px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; cursor:pointer; border-left:4px solid #4caf50;" onclick="openRefereeProject(${actualIndex})">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong>${p.name}</strong>
                                ${activeMatches > 0 ? `<span style="background:#ff9800; color:white; padding:2px 8px; border-radius:12px; font-size:12px;">${activeMatches}Í≤ΩÍ∏∞ ÎåÄÍ∏∞</span>` : ''}
                            </div>
                            <div style="font-size:13px; color:var(--text-secondary); margin-top:4px;">
                                ${p.date || 'ÎÇ†Ïßú ÎØ∏Ï†ï'} ¬∑ ${completedMatches}/${p.matches.length} ÏôÑÎ£å
                            </div>
                        </div>
                    `;
                }).join('') || '<p style="text-align:center; color:var(--text-secondary); padding:20px;">ÏßÑÌñâ Í∞ÄÎä•Ìïú ÎåÄÌöåÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                        <h1 style="color:white;">ÎåÄÌöå/Í≤ΩÍ∏∞ Î™©Î°ù</h1>
                        <p style="color:rgba(255,255,255,0.9);">Í≤ΩÍ∏∞Î•º ÏÑ†ÌÉùÌïòÍ≥† PINÏúºÎ°ú Ïù∏Ï¶ùÌïòÏÑ∏Ïöî</p>
                    </div>
                    <div class="card">
                        ${projectList}
                    </div>
                    <div class="card">
                        <button class="btn" onclick="goTo('referee-home')" style="width:100%;">‚Üê Ïã¨Ìåê ÌôàÏúºÎ°ú</button>
                    </div>
                `;
            }
            // Í¥ÄÎ¶¨Ïûê Î™®Îìú Ìôà
            else if (screen === 'admin-home') {
                const currentOperator = JSON.parse(sessionStorage.getItem('currentOperator') || 'null');
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h1 style="color:white; margin:0;">Í¥ÄÎ¶¨Ïûê Î™®Îìú</h1>
                                <p style="color:rgba(255,255,255,0.9); margin:4px 0 0 0;">ÎåÄÏßÑ ÏÑ§Ï†ï ¬∑ Ïã¨Ìåê Í¥ÄÎ¶¨ ¬∑ Í≤ΩÍ∏∞Ïû• Í¥ÄÎ¶¨</p>
                            </div>
                            <button class="btn" onclick="adminLogout()" style="background:rgba(255,255,255,0.2); color:white; padding:8px 12px;">
                                Î°úÍ∑∏ÏïÑÏõÉ
                            </button>
                        </div>
                    </div>
                    
                    ${currentOperator ? `
                        <div class="card" style="background:linear-gradient(135deg, ${currentOperator.role === 'super' ? '#e91e63' : '#2196f3'} 0%, ${currentOperator.role === 'super' ? '#c2185b' : '#1976d2'} 100%); color:white;">
                            <div style="display:flex; align-items:center; gap:12px;">
                                <span style="font-size:32px;">${currentOperator.role === 'super' ? 'üëë' : 'üîß'}</span>
                                <div>
                                    <strong style="font-size:18px;">${currentOperator.name}</strong>
                                    <div style="font-size:13px; opacity:0.9;">${currentOperator.role === 'super' ? 'ÏµúÍ≥† Í¥ÄÎ¶¨Ïûê' : 'ÏùºÎ∞ò Í¥ÄÎ¶¨Ïûê'}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="card">
                        <div style="background:#e3f2fd; border-left:4px solid #1976d2; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>ÎåÄÏßÑ ÏÑ§Ï†ï</strong><br>
                            <span style="font-size:14px;">ÎåÄÌöå ÏÉùÏÑ±, Ï°∞Ìé∏ÏÑ±, ÌÜ†ÎÑàÎ®ºÌä∏ Íµ¨ÏÑ±</span>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="goTo('bracket-home')" style="width:100%;" aria-label="ÎåÄÏßÑ ÏÑ§Ï†ï">
                            ÎåÄÏßÑ ÏÑ§Ï†ï
                        </button>
                    </div>
                    
                    <div class="card">
                        <div style="background:#e8f5e9; border-left:4px solid #4caf50; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>Ïã¨Ìåê Í¥ÄÎ¶¨ (Ï†ÑÏó≠)</strong><br>
                            <span style="font-size:14px;">Ïã¨Ìåê Îì±Î°ù, PIN Î∞úÍ∏â - Î™®Îì† ÎåÄÌöåÏóêÏÑú ÏÇ¨Ïö©</span>
                        </div>
                        <button type="button" class="btn" onclick="goTo('referee-manage')" style="width:100%; background:#4caf50; color:white;" aria-label="Ïã¨Ìåê Í¥ÄÎ¶¨">
                            Ïã¨Ìåê Í¥ÄÎ¶¨
                        </button>
                    </div>
                    
                    <div class="card">
                        <div style="background:#fff3e0; border-left:4px solid #ff9800; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>Í≤ΩÍ∏∞Ïû• Í¥ÄÎ¶¨ (Ï†ÑÏó≠)</strong><br>
                            <span style="font-size:14px;">Í≤ΩÍ∏∞Ïû• Îì±Î°ù - Î™®Îì† ÎåÄÌöåÏóêÏÑú ÏÇ¨Ïö© Í∞ÄÎä•</span>
                        </div>
                        <button type="button" class="btn" onclick="goTo('court-manage')" style="width:100%; background:#ff9800; color:white;" aria-label="Í≤ΩÍ∏∞Ïû• Í¥ÄÎ¶¨">
                            Í≤ΩÍ∏∞Ïû• Í¥ÄÎ¶¨
                        </button>
                    </div>
                    
                    <div class="card" style="background:#f5f5f5;">
                        <p style="font-size:13px; color:#666; text-align:center; margin:0;">
                            ÎåÄÌöåÎ≥Ñ Ïã¨Ìåê/Í≤ΩÍ∏∞Ïû• Î∞∞Ï†ïÏùÄ<br>
                            <strong>ÎåÄÏßÑ ÏÑ§Ï†ï ‚Üí ÎåÄÌöå ÏÑ†ÌÉù ‚Üí ÎåÄÌöå Í¥ÄÎ¶¨</strong>ÏóêÏÑú Ìï©ÎãàÎã§
                        </p>
                    </div>
                    
                    <div class="card">
                        <div style="background:#fce4ec; border-left:4px solid #e91e63; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>ÏÑ§Ï†ï</strong><br>
                            <span style="font-size:14px;">Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω, Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</span>
                        </div>
                        <button type="button" class="btn" onclick="goTo('admin-settings')" style="width:100%; background:#e91e63; color:white;" aria-label="ÏÑ§Ï†ï">
                            ÏÑ§Ï†ï
                        </button>
                    </div>
                    
                    <div class="card">
                        <button type="button" class="btn" onclick="goTo('home')">‚Üê Î™®Îìú ÏÑ†ÌÉùÏúºÎ°ú</button>
                    </div>
                `;
            }
            // Ïã¨Ìåê Í¥ÄÎ¶¨ ÌôîÎ©¥
            else if (screen === 'referee-manage') {
                // Î™®Îì† ÌîÑÎ°úÏ†ùÌä∏Ïùò Ïã¨Ìåê Î™©Î°ù ÏàòÏßë
                const allReferees = [];
                projects.forEach(p => {
                    if (p.referees) {
                        p.referees.forEach(r => {
                            if (!allReferees.find(ar => ar.name === r.name)) {
                                allReferees.push({ ...r, projects: [p.name] });
                            } else {
                                const existing = allReferees.find(ar => ar.name === r.name);
                                if (!existing.projects.includes(p.name)) {
                                    existing.projects.push(p.name);
                                }
                            }
                        });
                    }
                });
                
                // Ï†ÑÏó≠ Ïã¨Ìåê Î™©Î°ù (localStorage)
                const globalReferees = JSON.parse(localStorage.getItem('globalReferees') || '[]');
                
                const refereeListHTML = globalReferees.length > 0 ? globalReferees.map((ref, idx) => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid #4caf50;">
                        <div>
                            <strong>${ref.name}</strong>
                            <div style="font-size:12px; color:#666; margin-top:2px;">
                                ${ref.role || 'Ïã¨Ìåê'} ¬∑ PIN: <code style="background:#e0e0e0; padding:2px 6px; border-radius:4px;">${ref.pin}</code>
                            </div>
                        </div>
                        <div style="display:flex; gap:4px;">
                            <button class="btn" onclick="regenerateRefereePin(${idx})" style="padding:6px 10px; font-size:12px; background:#ff9800; color:white;">PIN</button>
                            <button class="btn" onclick="deleteGlobalReferee(${idx})" aria-label="Ïã¨Ìåê ÏÇ≠Ï†ú" style="padding:6px 10px; font-size:12px; background:#f44336; color:white;">üóëÔ∏è</button>
                        </div>
                    </div>
                `).join('') : '<p style="text-align:center; color:#666; padding:20px;">Îì±Î°ùÎêú Ïã¨ÌåêÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                        <h1 style="color:white;">Ïã¨Ìåê Í¥ÄÎ¶¨</h1>
                        <p style="color:rgba(255,255,255,0.9);">Ïã¨Ìåê Îì±Î°ù ¬∑ PIN Î∞úÍ∏â ¬∑ Í≤ΩÍ∏∞ Î∞∞Ï†ï</p>
                    </div>
                    
                    <div class="card">
                        <h3>Ïã¨Ìåê Îì±Î°ù</h3>
                        <div style="display:grid; grid-template-columns:1fr auto; gap:8px; margin-bottom:12px;">
                            <input type="text" id="new-referee-name" dir="ltr" lang="ko" placeholder="Ïã¨Ìåê Ïù¥Î¶Ñ" style="padding:12px; border:1px solid var(--border); border-radius:8px;" autocomplete="off" spellcheck="false">
                            <select id="new-referee-role" style="padding:12px; border:1px solid var(--border); border-radius:8px;">
                                <option value="Ï£ºÏã¨">Ï£ºÏã¨</option>
                                <option value="Î∂ÄÏã¨">Î∂ÄÏã¨</option>
                                <option value="Í∏∞Î°ùÏõê">Í∏∞Î°ùÏõê</option>
                                <option value="Ïã¨Ìåê">Ïã¨Ìåê</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addGlobalReferee()" style="width:100%;">Ïã¨Ìåê Îì±Î°ù</button>
                    </div>
                    
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <h3 style="margin:0;">Îì±Î°ùÎêú Ïã¨Ìåê (${globalReferees.length}Î™Ö)</h3>
                            <button class="btn" onclick="showAllPins()" style="padding:6px 12px; font-size:12px;">Ï†ÑÏ≤¥ PIN Î≥¥Í∏∞</button>
                        </div>
                        <div style="max-height:300px; overflow-y:auto;">
                            ${refereeListHTML}
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>Í≤ΩÍ∏∞ Î∞∞Ï†ï ÌòÑÌô©</h3>
                        <p style="font-size:13px; color:#666; margin-bottom:12px;">Í∞Å Ïã¨ÌåêÏùò Î∞∞Ï†ïÎêú Í≤ΩÍ∏∞ ÏàòÎ•º ÌôïÏù∏Ìï©ÎãàÎã§.</p>
                        <button class="btn" onclick="goTo('referee-assignments')" style="width:100%;">Î∞∞Ï†ï ÌòÑÌô© Î≥¥Í∏∞</button>
                    </div>
                    
                    <div class="card">
                        <button class="btn" onclick="goTo('admin-home')" style="width:100%;">‚Üê Í¥ÄÎ¶¨Ïûê ÌôàÏúºÎ°ú</button>
                    </div>
                `;
            }
            // ÎåÄÌöåÎ≥Ñ Í≤ΩÍ∏∞Ïû• Îì±Î°ù ÌôîÎ©¥
            else if (screen === 'tournament-court-manage') {
                if (!currentProject) {
                    goTo('bracket-home');
                    return;
                }
                
                const courts = currentProject.courts || [];
                const globalCourts = JSON.parse(localStorage.getItem('globalCourts') || '[]');
                
                const courtListHTML = courts.length > 0 ? courts.map((court, idx) => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid #ff9800;">
                        <div>
                            <strong>${court.name}</strong>
                        </div>
                        <button class="btn" onclick="deleteTournamentCourt(${idx})" aria-label="Í≤ΩÍ∏∞Ïû• ÏÇ≠Ï†ú" style="padding:6px 10px; font-size:12px; background:#f44336; color:white;">üóëÔ∏è</button>
                    </div>
                `).join('') : '<p style="text-align:center; color:#666; padding:20px;">Îì±Î°ùÎêú Í≤ΩÍ∏∞Ïû•Ïù¥ ÏóÜÏäµÎãàÎã§.</p>';
                
                // Ï†ÑÏó≠ Í≤ΩÍ∏∞Ïû•ÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞ ÏòµÏÖò
                const globalCourtOptions = globalCourts.filter(gc => !courts.find(c => c.name === gc.name));
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%);">
                        <h1 style="color:white;">${currentProject.name}</h1>
                        <p style="color:rgba(255,255,255,0.9);">Í≤ΩÍ∏∞Ïû• Îì±Î°ù</p>
                    </div>
                    
                    <div class="card">
                        <h3>Í≤ΩÍ∏∞Ïû• Ï∂îÍ∞Ä</h3>
                        <div style="margin-bottom:12px;">
                            <input type="text" id="tournament-court-name" dir="ltr" lang="ko" placeholder="Í≤ΩÍ∏∞Ïû• Ïù¥Î¶Ñ (Ïòà: 1Î≤à ÏΩîÌä∏)" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px;" autocomplete="off" spellcheck="false">
                        </div>
                        <button class="btn btn-primary" onclick="addTournamentCourt()" style="width:100%;">Í≤ΩÍ∏∞Ïû• Ï∂îÍ∞Ä</button>
                        
                        ${globalCourtOptions.length > 0 ? `
                            <div style="margin-top:16px; padding-top:16px; border-top:1px solid #eee;">
                                <p style="font-size:13px; color:#666; margin-bottom:8px;">ÎòêÎäî Ï†ÑÏó≠ Í≤ΩÍ∏∞Ïû•ÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞:</p>
                                <select id="import-global-court" style="width:100%; padding:10px; margin-bottom:8px;">
                                    <option value="">-- ÏÑ†ÌÉù --</option>
                                    ${globalCourtOptions.map(c => `<option value="${c.name}">${c.name}</option>`).join('')}
                                </select>
                                <button class="btn" onclick="importGlobalCourt()" style="width:100%;">Í∞ÄÏ†∏Ïò§Í∏∞</button>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="card">
                        <h3>Îì±Î°ùÎêú Í≤ΩÍ∏∞Ïû• (${courts.length}Í∞ú)</h3>
                        <div style="max-height:300px; overflow-y:auto;">
                            ${courtListHTML}
                        </div>
                    </div>
                    
                    <div class="card">
                        <button class="btn" onclick="goTo('bracket-detail')" style="width:100%;">‚Üê ÎåÄÌöå ÏÉÅÏÑ∏Î°ú</button>
                    </div>
                `;
            }
            // ÎåÄÌöåÎ≥Ñ Ïã¨Ìåê Îì±Î°ù ÌôîÎ©¥
            else if (screen === 'tournament-referee-manage') {
                if (!currentProject) {
                    goTo('bracket-home');
                    return;
                }
                
                const referees = currentProject.referees || [];
                const globalReferees = JSON.parse(localStorage.getItem('globalReferees') || '[]');
                
                const refereeListHTML = referees.length > 0 ? referees.map((ref, idx) => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid #4caf50;">
                        <div>
                            <strong>${ref.name}</strong>
                            <div style="font-size:12px; color:#666; margin-top:2px;">
                                ${ref.role || 'Ïã¨Ìåê'} ¬∑ PIN: <code style="background:#e0e0e0; padding:2px 6px; border-radius:4px;">${ref.pin || 'N/A'}</code>
                            </div>
                        </div>
                        <button class="btn" onclick="deleteTournamentReferee(${idx})" aria-label="Ïã¨Ìåê ÏÇ≠Ï†ú" style="padding:6px 10px; font-size:12px; background:#f44336; color:white;">üóëÔ∏è</button>
                    </div>
                `).join('') : '<p style="text-align:center; color:#666; padding:20px;">Îì±Î°ùÎêú Ïã¨ÌåêÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                
                // Ï†ÑÏó≠ Ïã¨ÌåêÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞ ÏòµÏÖò
                const globalRefOptions = globalReferees.filter(gr => !referees.find(r => r.name === gr.name));
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                        <h1 style="color:white;">${currentProject.name}</h1>
                        <p style="color:rgba(255,255,255,0.9);">Ïã¨Ìåê Îì±Î°ù</p>
                    </div>
                    
                    <div class="card">
                        <h3>Ïã¨Ìåê Ï∂îÍ∞Ä</h3>
                        <div style="display:grid; grid-template-columns:1fr auto; gap:8px; margin-bottom:12px;">
                            <input type="text" id="tournament-referee-name" dir="ltr" lang="ko" placeholder="Ïã¨Ìåê Ïù¥Î¶Ñ" style="padding:12px; border:1px solid var(--border); border-radius:8px;" autocomplete="off" spellcheck="false">
                            <select id="tournament-referee-role" style="padding:12px; border:1px solid var(--border); border-radius:8px;">
                                <option value="Ï£ºÏã¨">Ï£ºÏã¨</option>
                                <option value="Î∂ÄÏã¨">Î∂ÄÏã¨</option>
                                <option value="Í∏∞Î°ùÏõê">Í∏∞Î°ùÏõê</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="addTournamentReferee()" style="width:100%;">Ïã¨Ìåê Ï∂îÍ∞Ä</button>
                        
                        ${globalRefOptions.length > 0 ? `
                            <div style="margin-top:16px; padding-top:16px; border-top:1px solid #eee;">
                                <p style="font-size:13px; color:#666; margin-bottom:8px;">ÎòêÎäî Ï†ÑÏó≠ Ïã¨ÌåêÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞:</p>
                                <select id="import-global-referee" style="width:100%; padding:10px; margin-bottom:8px;">
                                    <option value="">-- ÏÑ†ÌÉù --</option>
                                    ${globalRefOptions.map(r => `<option value="${r.name}">${r.name} (${r.role}) - PIN: ${r.pin}</option>`).join('')}
                                </select>
                                <button class="btn" onclick="importGlobalReferee()" style="width:100%;">Í∞ÄÏ†∏Ïò§Í∏∞</button>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="card">
                        <h3>Îì±Î°ùÎêú Ïã¨Ìåê (${referees.length}Î™Ö)</h3>
                        <div style="max-height:300px; overflow-y:auto;">
                            ${refereeListHTML}
                        </div>
                    </div>
                    
                    <div class="card">
                        <button class="btn" onclick="goTo('bracket-detail')" style="width:100%;">‚Üê ÎåÄÌöå ÏÉÅÏÑ∏Î°ú</button>
                    </div>
                `;
            }
            // Í≤ΩÍ∏∞Ïû• Í¥ÄÎ¶¨ ÌôîÎ©¥
            else if (screen === 'court-manage') {
                const globalCourts = JSON.parse(localStorage.getItem('globalCourts') || '[]');
                
                const courtListHTML = globalCourts.length > 0 ? globalCourts.map((court, idx) => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid #ff9800;">
                        <div>
                            <strong>${court.name}</strong>
                            <div style="font-size:12px; color:#666; margin-top:2px;">${court.location || 'ÏúÑÏπò ÎØ∏ÏßÄÏ†ï'}</div>
                        </div>
                        <button class="btn" onclick="deleteGlobalCourt(${idx})" aria-label="Í≤ΩÍ∏∞Ïû• ÏÇ≠Ï†ú" style="padding:6px 10px; font-size:12px; background:#f44336; color:white;">üóëÔ∏è</button>
                    </div>
                `).join('') : '<p style="text-align:center; color:#666; padding:20px;">Îì±Î°ùÎêú Í≤ΩÍ∏∞Ïû•Ïù¥ ÏóÜÏäµÎãàÎã§.</p>';
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%);">
                        <h1 style="color:white;">Í≤ΩÍ∏∞Ïû• Í¥ÄÎ¶¨</h1>
                        <p style="color:rgba(255,255,255,0.9);">Í≤ΩÍ∏∞Ïû• Îì±Î°ù ¬∑ Î∞∞Ï†ï Í¥ÄÎ¶¨</p>
                    </div>
                    
                    <div class="card">
                        <h3>Í≤ΩÍ∏∞Ïû• Îì±Î°ù</h3>
                        <div style="margin-bottom:12px;">
                            <input type="text" id="new-court-name" dir="ltr" lang="ko" placeholder="Í≤ΩÍ∏∞Ïû• Ïù¥Î¶Ñ (Ïòà: 1Î≤à ÏΩîÌä∏)" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; margin-bottom:8px;" autocomplete="off" spellcheck="false">
                            <input type="text" id="new-court-location" dir="ltr" lang="ko" placeholder="ÏúÑÏπò (ÏÑ†ÌÉù)" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px;" autocomplete="off" spellcheck="false">
                        </div>
                        <button class="btn btn-primary" onclick="addGlobalCourt()" style="width:100%;">Í≤ΩÍ∏∞Ïû• Îì±Î°ù</button>
                    </div>
                    
                    <div class="card">
                        <h3>Îì±Î°ùÎêú Í≤ΩÍ∏∞Ïû• (${globalCourts.length}Í∞ú)</h3>
                        <div style="max-height:300px; overflow-y:auto;">
                            ${courtListHTML}
                        </div>
                    </div>
                    
                    <div class="card">
                        <button class="btn" onclick="goTo('admin-home')" style="width:100%;">‚Üê Í¥ÄÎ¶¨Ïûê ÌôàÏúºÎ°ú</button>
                    </div>
                `;
            }
            // Í¥ÄÎ¶¨Ïûê ÏÑ§Ï†ï ÌôîÎ©¥
            else if (screen === 'admin-settings') {
                // Ïö¥ÏòÅÏûê Î™©Î°ù
                const operators = JSON.parse(localStorage.getItem('operators') || '[]');
                const currentOperator = JSON.parse(sessionStorage.getItem('currentOperator') || 'null');
                const isSuperAdmin = currentOperator?.role === 'super';
                
                const operatorListHTML = operators.length > 0 ? operators.map((op, idx) => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid ${op.role === 'super' ? '#e91e63' : '#2196f3'};">
                        <div style="flex:1; min-width:0;">
                            <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                                <strong>${op.name}</strong>
                                <span style="background:${op.role === 'super' ? '#e91e63' : '#2196f3'}; color:white; padding:2px 8px; border-radius:12px; font-size:11px;">
                                    ${op.role === 'super' ? 'üëë' : 'üîß'}
                                </span>
                            </div>
                            <div style="font-size:12px; color:#666; margin-top:4px; overflow:hidden; text-overflow:ellipsis;">
                                ${op.email || 'Ïù¥Î©îÏùº ÏóÜÏùå'}
                            </div>
                        </div>
                        ${isSuperAdmin && op.email !== currentOperator.email ? `
                            <div style="display:flex; gap:4px; flex-wrap:wrap;">
                                <button class="btn" onclick="resetOperatorPassword(${idx})" aria-label="ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî" style="padding:6px 8px; font-size:11px; background:#2196f3; color:white;" title="ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï Ïù¥Î©îÏùº Î∞úÏÜ°">üîë</button>
                                <button class="btn" onclick="toggleOperatorRole(${idx})" aria-label="Í∂åÌïú Î≥ÄÍ≤Ω" style="padding:6px 8px; font-size:11px; background:#ff9800; color:white;" title="Í∂åÌïú Î≥ÄÍ≤Ω">‚öôÔ∏è</button>
                                <button class="btn" onclick="deleteOperator(${idx})" aria-label="Ïö¥ÏòÅÏûê ÏÇ≠Ï†ú" style="padding:6px 8px; font-size:11px; background:#f44336; color:white;" title="ÏÇ≠Ï†ú">üóëÔ∏è</button>
                            </div>
                        ` : ''}
                    </div>
                `).join('') : '<p style="text-align:center; color:#666; padding:20px;">Îì±Î°ùÎêú Ïö¥ÏòÅÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #e91e63 0%, #c2185b 100%);">
                        <h1 style="color:white;">Í¥ÄÎ¶¨Ïûê ÏÑ§Ï†ï</h1>
                        <p style="color:rgba(255,255,255,0.9);">Ïö¥ÏòÅÏûê Í¥ÄÎ¶¨ ¬∑ ÏãúÏä§ÌÖú ÏÑ§Ï†ï</p>
                    </div>
                    
                    ${currentOperator ? `
                        <div class="card" style="background:#e8f5e9; border-left:4px solid #4caf50;">
                            <div style="display:flex; align-items:center; gap:12px;">
                                <span style="font-size:32px;">${currentOperator.role === 'super' ? 'üëë' : 'üîß'}</span>
                                <div>
                                    <strong>${currentOperator.name}</strong>ÎãòÏúºÎ°ú Î°úÍ∑∏Ïù∏Îê®
                                    <div style="font-size:12px; color:#666;">${currentOperator.role === 'super' ? 'ÏµúÍ≥† Í¥ÄÎ¶¨Ïûê' : 'ÏùºÎ∞ò Í¥ÄÎ¶¨Ïûê'}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Ïö¥ÏòÅÏûê Í¥ÄÎ¶¨ (ÏµúÍ≥†Í¥ÄÎ¶¨ÏûêÎßå) -->
                    ${isSuperAdmin ? `
                        <div class="card">
                            <h3>Ïö¥ÏòÅÏûê Í¥ÄÎ¶¨</h3>
                            <p style="font-size:13px; color:#666; margin-bottom:12px;">Ïö¥ÏòÅÏûêÎ•º Ï∂îÍ∞ÄÌïòÍ±∞ÎÇò Í∂åÌïúÏùÑ Í¥ÄÎ¶¨Ìï©ÎãàÎã§.</p>
                            
                            <div style="display:grid; grid-template-columns:1fr auto; gap:8px; margin-bottom:8px;">
                                <input type="text" id="new-operator-name" dir="ltr" lang="ko" placeholder="Ïö¥ÏòÅÏûê Ïù¥Î¶Ñ" style="padding:12px; border:1px solid var(--border); border-radius:8px;" autocomplete="off" spellcheck="false">
                                <select id="new-operator-role" style="padding:12px; border:1px solid var(--border); border-radius:8px;">
                                    <option value="admin">Í¥ÄÎ¶¨Ïûê</option>
                                    <option value="super">ÏµúÍ≥†Í¥ÄÎ¶¨Ïûê</option>
                                </select>
                            </div>
                            <input type="email" id="new-operator-email" placeholder="Ïù¥Î©îÏùº (ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞Ïö©)" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; margin-bottom:8px;">
                            <input type="password" id="new-operator-password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ (6Ïûê Ïù¥ÏÉÅ)" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; margin-bottom:12px;">
                            <button class="btn btn-primary" onclick="addOperator()" style="width:100%;">Ïö¥ÏòÅÏûê Ï∂îÍ∞Ä</button>
                            
                            <div style="margin-top:16px; max-height:250px; overflow-y:auto;">
                                ${operatorListHTML}
                            </div>
                        </div>
                    ` : `
                        <div class="card">
                            <h3>Ïö¥ÏòÅÏûê Î™©Î°ù</h3>
                            <p style="font-size:13px; color:#666; margin-bottom:12px;">Ïö¥ÏòÅÏûê Í¥ÄÎ¶¨Îäî ÏµúÍ≥† Í¥ÄÎ¶¨ÏûêÎßå Í∞ÄÎä•Ìï©ÎãàÎã§.</p>
                            <div style="max-height:200px; overflow-y:auto;">
                                ${operatorListHTML}
                            </div>
                        </div>
                    `}
                    
                    <div class="card">
                        <h3>ÎÇ¥ ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω</h3>
                        <p style="font-size:13px; color:#666; margin-bottom:12px;">ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Ìïú Í≥ÑÏ†ïÏùò ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Î≥ÄÍ≤ΩÌï©ÎãàÎã§.</p>
                        <button class="btn" onclick="changeMyPassword()" style="width:100%; background:#1976d2; color:white;">ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω</button>
                    </div>
                    
                    <div class="card">
                        <h3>Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</h3>
                        <div style="display:grid; gap:8px;">
                            <button class="btn" onclick="exportAllData()" style="background:#4caf50; color:white;">Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞</button>
                            <button class="btn" onclick="importDataPrompt()" style="background:#2196f3; color:white;">Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞</button>
                        </div>
                    </div>
                    
                    ${isSuperAdmin ? `
                        <div class="card" style="border:2px solid #f44336;">
                            <h3 style="color:#f44336;">ÏúÑÌóò Íµ¨Ïó≠</h3>
                            <p style="font-size:13px; color:#666; margin-bottom:12px;">ÏïÑÎûò ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                            <div style="display:grid; gap:8px;">
                                <button class="btn" onclick="resetTournamentData()" style="background:#ff9800; color:white;">ÎåÄÌöå Îç∞Ïù¥ÌÑ∞Îßå Ï¥àÍ∏∞Ìôî</button>
                                <button class="btn" onclick="resetOperators()" style="background:#e91e63; color:white;">Ïö¥ÏòÅÏûê Ï¥àÍ∏∞Ìôî (Ïû¨ÏÑ§Ï†ï)</button>
                                <button class="btn" onclick="factoryReset()" style="background:#f44336; color:white;">Í≥µÏû• Ï¥àÍ∏∞Ìôî (Ï†ÑÏ≤¥ ÏÇ≠Ï†ú)</button>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="card">
                        <button class="btn" onclick="goTo('admin-home')" style="width:100%;">‚Üê Í¥ÄÎ¶¨Ïûê ÌôàÏúºÎ°ú</button>
                    </div>
                `;
            }
            else if (screen === 'bracket-home') {
                // ÎåÄÏßÑ ÏÑ§Ï†ï Î™®Îìú Ìôà
                const tournamentList = projects.filter(p => p.tournamentType).map((p, i) => {
                    const actualIndex = projects.indexOf(p);
                    const matchCount = p.matches?.length || 0;
                    const completedCount = p.matches?.filter(m => m.status === 'completed').length || 0;
                    const formatName = p.tournamentType === 'group-only' ? 'Ï°∞Î≥Ñ Î¶¨Í∑∏' : 
                                       p.tournamentType === 'group-knockout' ? 'Ï°∞Î≥Ñ+ÌÜ†ÎÑàÎ®ºÌä∏' : 'ÌÜ†ÎÑàÎ®ºÌä∏';
                    return `
                        <div style="padding:16px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; cursor:pointer; border-left:4px solid #1976d2;" onclick="openBracketProject(${actualIndex})">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong>${p.name}</strong>
                                <span style="font-size:12px; background:#e3f2fd; color:#1976d2; padding:2px 8px; border-radius:4px;">${formatName}</span>
                            </div>
                            <div style="font-size:13px; color:var(--text-secondary); margin-top:4px;">
                                ${matchCount}Í≤ΩÍ∏∞ Ï§ë ${completedCount}Í≤ΩÍ∏∞ ÏôÑÎ£å
                            </div>
                        </div>
                    `;
                }).join('') || '<p style="text-align:center; color:var(--text-secondary); padding:20px;">ÏÉùÏÑ±Îêú ÎåÄÌöåÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);">
                        <h1 style="color:white;">ÎåÄÏßÑ ÏÑ§Ï†ï</h1>
                        <p style="color:rgba(255,255,255,0.9);">ÎåÄÌöå ÏÉùÏÑ± ¬∑ Ï°∞Ìé∏ÏÑ± ¬∑ ÏàòÏ†ï</p>
                    </div>
                    <div class="card">
                        <button type="button" class="btn btn-primary" onclick="goTo('tournament-wizard')" style="width:100%; background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);" aria-label="ÏÉà ÎåÄÌöå ÎßåÎì§Í∏∞">
                            ÏÉà ÎåÄÌöå ÎßåÎì§Í∏∞
                        </button>
                    </div>
                    <div class="card">
                        <h3>ÎåÄÌöå Î™©Î°ù</h3>
                        ${tournamentList}
                    </div>
                    <div class="card">
                        <button type="button" class="btn" onclick="goTo('admin-home')" aria-label="Í¥ÄÎ¶¨Ïûê ÌôàÏúºÎ°ú">‚Üê Í¥ÄÎ¶¨Ïûê ÌôàÏúºÎ°ú</button>
                    </div>
                `;
            }
            else if (screen === 'bracket-detail') {
                // ÎåÄÏßÑ ÏÑ§Ï†ï ÏÉÅÏÑ∏ (ÏàòÏ†ï Í∞ÄÎä•)
                if (!currentProject) {
                    goTo('bracket-home');
                    return;
                }
                
                const p = currentProject;
                const isTeam = p.competitionType === 'team';
                const unitName = isTeam ? 'ÌåÄ' : 'Î™Ö';
                const formatName = p.tournamentType === 'group-only' ? 'Ï°∞Î≥Ñ Î¶¨Í∑∏Îßå' : 
                                   p.tournamentType === 'group-knockout' ? 'Ï°∞Î≥Ñ Î¶¨Í∑∏ + ÌÜ†ÎÑàÎ®ºÌä∏' : 'ÌÜ†ÎÑàÎ®ºÌä∏Îßå';
                
                const rulesHTML = '';
                
                // ÏÑ∏Ìä∏ Ïàò Ï†ïÎ≥¥
                const setsInfo = [];
                if (p.preliminarySets && p.tournamentType !== 'knockout-only') {
                    setsInfo.push(`ÏòàÏÑ† ${p.preliminarySets}ÏÑ∏Ìä∏`);
                }
                if (p.finalsSets && p.tournamentType !== 'group-only') {
                    setsInfo.push(`Î≥∏ÏÑ† ${p.finalsSets}ÏÑ∏Ìä∏`);
                }
                const setsHTML = setsInfo.length > 0 ? `
                    <span style="background:#fff3e0; padding:4px 12px; border-radius:16px; font-size:13px;">${setsInfo.join(' / ')}</span>
                ` : '';
                
                // Ï°∞Î≥Ñ Î¶¨Í∑∏ ÌëúÏãú
                let groupsHTML = '';
                if (p.groups && p.groups.length > 0) {
                    groupsHTML = `
                        <h3>Ï°∞ Ìé∏ÏÑ±</h3>
                        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:16px;">
                            ${p.groups.map((g, gIdx) => `
                                <div style="background:#f5f5f5; padding:12px; border-radius:8px;">
                                    <div style="font-weight:600; margin-bottom:8px; color:#1976d2; display:flex; justify-content:space-between;">
                                        <span>${g.name}</span>
                                        <button class="btn" onclick="editGroup(${gIdx})" style="padding:2px 8px; min-width:auto; font-size:12px;">‚úèÔ∏è ÏàòÏ†ï</button>
                                    </div>
                                    ${g.members.map((m, i) => `<div style="font-size:13px; padding:4px 0;">${i+1}. ${m}</div>`).join('')}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                // Í≤ΩÍ∏∞ Î™©Î°ù
                let matchesHTML = '';
                if (p.matches && p.matches.length > 0) {
                    const pendingMatches = p.matches.filter(m => m.status !== 'completed');
                    const completedMatches = p.matches.filter(m => m.status === 'completed');
                    
                    matchesHTML = `
                        <h3>‚öîÔ∏è Í≤ΩÍ∏∞ Î™©Î°ù (${p.matches.length}Í≤ΩÍ∏∞)</h3>
                        <div style="max-height:400px; overflow-y:auto;">
                            ${pendingMatches.length > 0 ? `
                                <div style="font-size:13px; color:#666; margin-bottom:8px;">ÎåÄÍ∏∞ Ï§ë (${pendingMatches.length})</div>
                                ${pendingMatches.slice(0, 15).map(m => `
                                    <div style="padding:10px; margin:4px 0; background:#fff3e0; border-radius:6px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
                                        <span style="flex:1;">${m.groupName ? `[${m.groupName}] ` : ''}${m.player1Name} vs ${m.player2Name}</span>
                                        <div style="display:flex; gap:4px;">
                                            <button class="btn btn-primary" onclick="startMatchFromBracket(${m.id})" style="padding:4px 10px; min-width:auto; font-size:12px;">‚ñ∂Ô∏è ÏãúÏûë</button>
                                            <button class="btn" onclick="editMatch(${m.id})" style="padding:4px 8px; min-width:auto; font-size:12px;">‚úèÔ∏è</button>
                                        </div>
                                    </div>
                                `).join('')}
                                ${pendingMatches.length > 15 ? `<div style="text-align:center; color:#666; padding:8px;">...Ïô∏ ${pendingMatches.length - 15}Í≤ΩÍ∏∞</div>` : ''}
                            ` : ''}
                            ${completedMatches.length > 0 ? `
                                <div style="font-size:13px; color:#666; margin:12px 0 8px 0;">ÏôÑÎ£åÎê® (${completedMatches.length})</div>
                                ${completedMatches.slice(0, 5).map(m => {
                                    const score = m.setScores.map(s => `${s.player1}-${s.player2}`).join(', ');
                                    return `
                                        <div style="padding:10px; margin:4px 0; background:#e8f5e9; border-radius:6px;">
                                            <span>${m.groupName ? `[${m.groupName}] ` : ''}${m.player1Name} vs ${m.player2Name}</span>
                                            <span style="float:right; font-size:12px; color:#666;">${score}</span>
                                        </div>
                                    `;
                                }).join('')}
                            ` : ''}
                        </div>
                    `;
                }
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('bracket-home')" style="margin-bottom:16px;">‚Üê ÎåÄÌöå Î™©Î°ù</button>
                        
                        <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:16px;">
                            <div>
                                <h2 style="margin:0;">${p.name}</h2>
                                <div style="font-size:13px; color:var(--text-secondary); margin-top:4px;">
                                    ${p.date || ''} ${p.location ? '¬∑ ' + p.location : ''}
                                </div>
                            </div>
                            <button class="btn" onclick="editTournamentInfo()" style="padding:4px 12px;">‚úèÔ∏è ÏàòÏ†ï</button>
                        </div>
                        
                        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px;">
                            <span style="background:#e3f2fd; color:#1976d2; padding:4px 12px; border-radius:16px; font-size:13px;">${formatName}</span>
                            <span style="background:#f5f5f5; padding:4px 12px; border-radius:16px; font-size:13px;">${isTeam ? 'ÌåÄÏ†Ñ' : 'Í∞úÏù∏Ï†Ñ'}</span>
                            ${setsHTML}
                            <span style="background:#f5f5f5; padding:4px 12px; border-radius:16px; font-size:13px;">${p.bracketPin || 'ÏóÜÏùå'}</span>
                        </div>
                        
                        ${rulesHTML}
                        ${groupsHTML}
                        ${matchesHTML}
                    </div>
                    
                    <!-- ÎåÄÌöå Í¥ÄÎ¶¨ Î©îÎâ¥ -->
                    <div class="card">
                        <h3 style="margin-bottom:12px;">ÎåÄÌöå Í¥ÄÎ¶¨</h3>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:12px;">
                            <button class="btn" onclick="goTo('edit-matches')" style="padding:12px; background:#2196f3; color:white;">
                                Ïã¨Ìåê/Í≤ΩÍ∏∞Ïû• Î∞∞Ï†ï
                            </button>
                            <button class="btn" onclick="goTo('tournament-court-manage')" style="padding:12px; background:#ff9800; color:white;">
                                Í≤ΩÍ∏∞Ïû• Îì±Î°ù
                            </button>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <button class="btn" onclick="goTo('tournament-referee-manage')" style="padding:12px; background:#4caf50; color:white;">
                                Ïã¨Ìåê Îì±Î°ù
                            </button>
                            <button class="btn" onclick="shuffleGroups()" style="padding:12px;">
                                üîÄ Ï°∞ Îã§Ïãú ÏÑûÍ∏∞
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <button class="btn btn-danger" onclick="deleteTournament()" style="width:100%;">ÎåÄÌöå ÏÇ≠Ï†ú</button>
                    </div>
                `;
            }
            // ÏµúÏ¥à Ïö¥ÏòÅÏûê Îì±Î°ù ÌôîÎ©¥
            else if (screen === 'operator-setup') {
                app.innerHTML = `
                    <header class="header" style="background:linear-gradient(135deg, #e91e63 0%, #c2185b 100%);">
                        <h1 style="color:white;">ÏµúÏ¥à Ïö¥ÏòÅÏûê Îì±Î°ù</h1>
                        <p style="color:rgba(255,255,255,0.9);">Í¥ÄÎ¶¨Ïûê Í≥ÑÏ†ïÏùÑ ÏÉùÏÑ±ÌïòÏÑ∏Ïöî</p>
                    </header>
                    
                    <main>
                        <section>
                            <h2>ÏµúÍ≥† Í¥ÄÎ¶¨Ïûê Îì±Î°ù</h2>
                            <p>Ï≤òÏùå Îì±Î°ùÌïòÎäî Ïö¥ÏòÅÏûêÎäî ÏµúÍ≥† Í¥ÄÎ¶¨Ïûê Í∂åÌïúÏùÑ Í∞ñÏäµÎãàÎã§.</p>
                            
                            <form onsubmit="setupFirstOperator(); return false;">
                                <fieldset>
                                    <legend class="sr-only">Ïö¥ÏòÅÏûê Ï†ïÎ≥¥ ÏûÖÎ†•</legend>
                                    
                                    <div class="form-group">
                                        <label for="first-operator-name">Ïö¥ÏòÅÏûê Ïù¥Î¶Ñ</label>
                                        <input type="text" id="first-operator-name" name="name" dir="ltr" lang="ko" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•" required autocomplete="name" spellcheck="false">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="first-operator-email">Ïù¥Î©îÏùº (ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞Ïö©)</label>
                                        <input type="email" id="first-operator-email" name="email" placeholder="example@email.com" required autocomplete="email">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="first-operator-password">ÎπÑÎ∞ÄÎ≤àÌò∏ (6Ïûê Ïù¥ÏÉÅ)</label>
                                        <input type="password" id="first-operator-password" name="password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•" required minlength="6" autocomplete="new-password">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="first-operator-confirm">ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</label>
                                        <input type="password" id="first-operator-confirm" name="confirm" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ Îã§Ïãú ÏûÖÎ†•" required minlength="6" autocomplete="new-password">
                                    </div>
                                    
                                    <button type="submit" id="setup-btn" class="btn btn-primary" style="width:100%; background:linear-gradient(135deg, #e91e63 0%, #c2185b 100%);">ÏµúÍ≥† Í¥ÄÎ¶¨ÏûêÎ°ú Îì±Î°ù</button>
                                </fieldset>
                            </form>
                            
                            <nav style="margin-top:12px;">
                                <button type="button" class="btn" onclick="goTo('home')" style="width:100%;">‚Üê Î™®Îìú ÏÑ†ÌÉùÏúºÎ°ú</button>
                            </nav>
                        </section>
                        
                        <aside style="margin-top:20px;">
                            <div style="background:#e3f2fd; padding:16px; border-radius:8px; margin-bottom:12px;">
                                <h3>Ïù¥Î©îÏùº Îì±Î°ù ÌïÑÏàò</h3>
                                <p style="font-size:13px; margin:0;">
                                    ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûäÏñ¥Î≤ÑÎ†∏ÏùÑ Îïå Ïù¥Î©îÏùºÎ°ú Ïû¨ÏÑ§Ï†ï ÎßÅÌÅ¨Î•º Î∞õÏùÑ Ïàò ÏûàÏäµÎãàÎã§.
                                </p>
                            </div>
                            
                            <div style="background:#fff3e0; padding:16px; border-radius:8px;">
                                <h3>ÏµúÍ≥† Í¥ÄÎ¶¨Ïûê Í∂åÌïú</h3>
                                <ul style="font-size:13px; margin:8px 0 0 0; padding-left:20px;">
                                    <li>Îã§Î•∏ Ïö¥ÏòÅÏûê Ï∂îÍ∞Ä/ÏÇ≠Ï†ú</li>
                                    <li>Ïö¥ÏòÅÏûê Í∂åÌïú Î≥ÄÍ≤Ω</li>
                                    <li>ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî</li>
                                    <li>Î™®Îì† ÎåÄÌöå/Ïã¨Ìåê/Í≤ΩÍ∏∞Ïû• Í¥ÄÎ¶¨</li>
                                </ul>
                            </div>
                        </aside>
                    </main>
                `;
                
                setTimeout(() => {
                    document.getElementById('first-operator-name')?.focus();
                }, 100);
            }
            // Í¥ÄÎ¶¨Ïûê Î™®Îìú Î°úÍ∑∏Ïù∏
            else if (screen === 'admin-password') {
                const operators = JSON.parse(localStorage.getItem('operators') || '[]');
                
                app.innerHTML = `
                    <header class="header" style="background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);">
                        <h1 style="color:white;">Í¥ÄÎ¶¨Ïûê Î™®Îìú</h1>
                        <p style="color:rgba(255,255,255,0.9);">Ïö¥ÏòÅÏûê Î°úÍ∑∏Ïù∏</p>
                    </header>
                    
                    <main>
                        <section>
                            <h2>Ïö¥ÏòÅÏûê Î°úÍ∑∏Ïù∏</h2>
                            <p>Îì±Î°ùÎêú Ïù¥Î©îÏùºÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î°ú Î°úÍ∑∏Ïù∏ÌïòÏÑ∏Ïöî</p>
                            
                            <form onsubmit="verifyAdminPin(); return false;">
                                <fieldset>
                                    <legend class="sr-only">Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ ÏûÖÎ†•</legend>
                                    
                                    <div class="form-group">
                                        <label for="admin-email">Ïù¥Î©îÏùº</label>
                                        <input type="email" id="admin-email" name="email" placeholder="example@email.com" required autocomplete="email">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="admin-pin">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                                        <input type="password" id="admin-pin" name="password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•" required autocomplete="current-password">
                                    </div>
                                    
                                    <button type="submit" id="admin-login-btn" class="btn btn-primary" style="width:100%;">Î°úÍ∑∏Ïù∏</button>
                                </fieldset>
                            </form>
                            
                            <p style="text-align:center; margin-top:16px;">
                                <button type="button" onclick="goTo('password-reset')" class="btn-link">
                                    ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûäÏúºÏÖ®ÎÇòÏöî?
                                </button>
                            </p>
                            
                            <nav style="margin-top:12px;">
                                <button type="button" class="btn" onclick="goTo('home')" style="width:100%;">‚Üê Î™®Îìú ÏÑ†ÌÉùÏúºÎ°ú</button>
                            </nav>
                        </section>
                        
                        <aside style="margin-top:16px; background:#f5f5f5; padding:12px; border-radius:8px;">
                            <p style="font-size:12px; color:#666; text-align:center; margin:0;">
                                Îì±Î°ùÎêú Ïö¥ÏòÅÏûê: ${operators.length}Î™Ö
                            </p>
                        </aside>
                    </main>
                `;
                
                setTimeout(() => {
                    document.getElementById('admin-email')?.focus();
                }, 100);
            }
            // ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞ ÌôîÎ©¥
            else if (screen === 'password-reset') {
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%);">
                        <h1 style="color:white;">ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞</h1>
                        <p style="color:rgba(255,255,255,0.9);">Ïù¥Î©îÏùºÎ°ú Ïû¨ÏÑ§Ï†ï ÎßÅÌÅ¨ Î∞úÏÜ°</p>
                    </div>
                    <div class="card">
                        <div style="text-align:center; margin-bottom:20px;">
                            <span style="font-size:48px;">üìß</span>
                            <h3>ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï</h3>
                            <p style="color:var(--text-secondary); font-size:14px;">Îì±Î°ùÎêú Ïù¥Î©îÏùº Ï£ºÏÜåÎ•º ÏûÖÎ†•ÌïòÏãúÎ©¥<br>ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï ÎßÅÌÅ¨Î•º Î≥¥ÎÇ¥ÎìúÎ¶ΩÎãàÎã§.</p>
                        </div>
                        
                        <div class="form-group">
                            <label>Ïù¥Î©îÏùº Ï£ºÏÜå</label>
                            <input type="email" id="reset-email" placeholder="example@email.com" style="width:100%;" autocomplete="email">
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="sendPasswordReset()" style="width:100%; background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%);">Ïû¨ÏÑ§Ï†ï ÎßÅÌÅ¨ Î∞úÏÜ°</button>
                        
                        <button type="button" class="btn" onclick="goTo('admin-password')" style="width:100%; margin-top:12px;">‚Üê Î°úÍ∑∏Ïù∏ÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                    </div>
                    
                    <div class="card" style="background:#e8f5e9;">
                        <strong>üì¨ Ïù¥Î©îÏùº ÌôïÏù∏</strong>
                        <p style="font-size:13px; margin:8px 0 0 0; color:#666;">
                            Ïù¥Î©îÏùºÏù¥ ÎèÑÏ∞©ÌïòÏßÄ ÏïäÏúºÎ©¥ Ïä§Ìå∏ Ìè¥ÎçîÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.<br>
                            FirebaseÏóêÏÑú Î∞úÏÜ°ÌïòÎäî Ïù¥Î©îÏùºÏûÖÎãàÎã§.
                        </p>
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('reset-email')?.focus();
                    document.getElementById('reset-email')?.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') sendPasswordReset();
                    });
                }, 100);
            }
            else if (screen === 'bracket-password') {
                // ÎåÄÏßÑ ÏÑ§Ï†ï ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);">
                        <h1 style="color:white;">ÎåÄÏßÑ ÏÑ§Ï†ï</h1>
                        <p style="color:rgba(255,255,255,0.9);">Ïö¥ÏòÅÏûê Ïù∏Ï¶ù</p>
                    </div>
                    <div class="card">
                        <div style="text-align:center; margin-bottom:20px;">
                            <span style="font-size:48px;">üîê</span>
                            <h3>ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•</h3>
                            <p style="color:var(--text-secondary); font-size:14px;">ÎåÄÏßÑ ÏÑ§Ï†ïÏùÑ ÏúÑÌï¥ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>
                        </div>
                        
                        <div class="form-group">
                            <label>ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                            <input type="password" id="bracket-pin" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•" style="width:100%;">
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="verifyBracketPin()" style="width:100%;">ÌôïÏù∏</button>
                        
                        <div style="margin-top:20px; padding-top:16px; border-top:1px solid #eee;">
                            <p style="font-size:13px; color:var(--text-secondary); text-align:center;">
                                Ï≤òÏùåÏù¥Ïã†Í∞ÄÏöî? ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏÑ§Ï†ïÌïòÏÑ∏Ïöî.
                            </p>
                            <button type="button" class="btn" onclick="goTo('bracket-set-password')" style="width:100%;">üÜï ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï</button>
                        </div>
                        
                        <button type="button" class="btn" onclick="goTo('home')" style="width:100%; margin-top:12px;">‚Üê Î™®Îìú ÏÑ†ÌÉùÏúºÎ°ú</button>
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('bracket-pin')?.focus();
                    document.getElementById('bracket-pin')?.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') verifyBracketPin();
                    });
                }, 100);
            }
            else if (screen === 'bracket-set-password') {
                // ÎåÄÏßÑ ÏÑ§Ï†ï ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);">
                        <h1 style="color:white;">ÎåÄÏßÑ ÏÑ§Ï†ï</h1>
                        <p style="color:rgba(255,255,255,0.9);">ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï</p>
                    </div>
                    <div class="card">
                        <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>Ï§ëÏöî</strong>
                            <p style="font-size:13px; margin-top:4px;">Ïù¥ ÎπÑÎ∞ÄÎ≤àÌò∏Îäî ÎåÄÏßÑ ÏÑ§Ï†ï Î™®Îìú Ï†ëÍ∑ºÏóê ÏÇ¨Ïö©Îê©ÎãàÎã§. ÏûäÏñ¥Î≤ÑÎ¶¨ÏßÄ ÏïäÎèÑÎ°ù Í∏∞ÏñµÌï¥Ï£ºÏÑ∏Ïöî.</p>
                        </div>
                        
                        <div style="background:#e3f2fd; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>üîí ÎπÑÎ∞ÄÎ≤àÌò∏ Ï°∞Í±¥</strong>
                            <ul style="font-size:13px; margin:8px 0 0 0; padding-left:20px;">
                                <li>8Ïûê Ïù¥ÏÉÅ</li>
                                <li>ÏòÅÎ¨∏ ÎåÄÎ¨∏Ïûê 1Í∞ú Ïù¥ÏÉÅ</li>
                                <li>ÏòÅÎ¨∏ ÏÜåÎ¨∏Ïûê 1Í∞ú Ïù¥ÏÉÅ</li>
                                <li>Ïà´Ïûê 1Í∞ú Ïù¥ÏÉÅ</li>
                                <li>ÌäπÏàòÎ¨∏Ïûê 1Í∞ú Ïù¥ÏÉÅ (!@#$%^&*)</li>
                            </ul>
                        </div>
                        
                        <div class="form-group">
                            <label>ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                            <input type="password" id="new-bracket-pin" placeholder="Ïòà: Showdown@2024" style="width:100%;" oninput="checkPasswordStrength()">
                            <div id="pw-strength" style="margin-top:8px; font-size:13px;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏</label>
                            <input type="password" id="confirm-bracket-pin" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏûÖÎ†•" style="width:100%;">
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="setBracketPin()" style="width:100%;">ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÑ§Ï†ï</button>
                        <button type="button" class="btn" onclick="goTo('bracket-password')" style="width:100%; margin-top:8px;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                    </div>
                `;
            }
            else if (screen === 'referee-password') {
                // Ïã¨Ìåê ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•
                const refPasswords = JSON.parse(localStorage.getItem('refereePasswords') || '{}');
                const refPins = Object.keys(refPasswords);
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #34a853 0%, #1b5e20 100%);">
                        <h1 style="color:white;">Ïã¨Ìåê Î™®Îìú</h1>
                        <p style="color:rgba(255,255,255,0.9);">Ïã¨Ìåê Ïù∏Ï¶ù</p>
                    </div>
                    <div class="card">
                        <div style="text-align:center; margin-bottom:20px;">
                            <span style="font-size:48px;">üîê</span>
                            <h3>Ïã¨Ìåê Ïù∏Ï¶ù</h3>
                            <p style="color:var(--text-secondary); font-size:14px;">Ïã¨Ìåê Ï†ïÎ≥¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>
                        </div>
                        
                        <div class="form-group">
                            <label>Ïã¨Ìåê PIN *</label>
                            <select id="referee-pin" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:6px;">
                                <option value="">Ïã¨Ìåê ÏÑ†ÌÉù...</option>
                                ${refPins.map(pin => `<option value="${pin}">${pin}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                            <input type="password" id="referee-password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•" style="width:100%;">
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="verifyRefereePassword()" style="width:100%;">Ïù∏Ï¶ù</button>
                        <button type="button" class="btn" onclick="goTo('home')" style="width:100%; margin-top:12px;">‚Üê Î™®Îìú ÏÑ†ÌÉùÏúºÎ°ú</button>
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('referee-pin')?.focus();
                    document.getElementById('referee-password')?.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') verifyRefereePassword();
                    });
                }, 100);
            }
            else if (screen === 'viewer-home') {
                // Ïã§ÏãúÍ∞Ñ ÏßÑÌñâ Ï§ëÏù∏ Ïó∞Ïäµ Í≤ΩÍ∏∞ ÌôïÏù∏
                const liveMatches = projects
                    .filter(p => p.isPractice && p.isShared)
                    .flatMap(p => p.matches || [])
                    .filter(m => m.status === 'in-progress' && m.isShared);
                
                const liveMatchesHTML = liveMatches.length > 0 ? `
                    <div style="background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%); padding:16px; border-radius:12px; margin-bottom:16px; color:white;">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:12px;">
                            <span style="font-size:20px;">üî¥</span>
                            <strong>Ïã§ÏãúÍ∞Ñ ÏßÑÌñâ Ï§ë (${liveMatches.length}Í≤ΩÍ∏∞)</strong>
                        </div>
                        ${liveMatches.map(m => `
                            <div style="background:rgba(255,255,255,0.15); padding:12px; border-radius:8px; margin:8px 0; cursor:pointer;" onclick="watchLiveMatch(${m.id})">
                                <div style="font-weight:600; font-size:16px;">${m.player1Name} vs ${m.player2Name}</div>
                                <div style="font-size:14px; margin-top:4px; opacity:0.9;">
                                    ${m.setScores ? m.setScores.map((s, i) => `[${s.player1}-${s.player2}]`).join(' ') : '0-0'}
                                    ${m.type === 'team' ? '(ÌåÄÏ†Ñ)' : `(${m.sets}ÏÑ∏Ìä∏)`}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : '';
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h1>Í¥ÄÎûå Î™®Îìú</h1>
                        <p>Ïã§ÏãúÍ∞Ñ Ï†êÏàò ¬∑ ÏùºÏ†ï Ï°∞Ìöå ¬∑ Í≤∞Í≥º ÌôïÏù∏</p>
                    </div>
                    <div class="card">
                        ${liveMatchesHTML}
                        
                        <div style="background:#e3f2fd; border-left:4px solid #2196f3; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>‚ö° üîç Í≤ΩÍ∏∞ Í≤ÄÏÉâ</strong><br>
                            <span style="font-size:14px;">ÏÑ†ÏàòÎ™ÖÏúºÎ°ú Í≤ΩÍ∏∞Î•º Í≤ÄÏÉâÌïòÍ≥† Ï¶êÍ≤®Ï∞æÍ∏∞ ¬∑ ÏïåÎ¶ºÏùÑ ÏÑ§Ï†ïÌï©ÎãàÎã§.</span>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="goTo('match-list')" style="width:100%; margin-bottom:16px;" aria-label="Í≤ΩÍ∏∞ Í≤ÄÏÉâ Î∞è Ï¶êÍ≤®Ï∞æÍ∏∞">
                            üîç Í≤ΩÍ∏∞ Í≤ÄÏÉâ (NEW!)
                        </button>
                        
                        <div style="background:#e3f2fd; border-left:4px solid #2196f3; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>‚ö° Ïã§ÏãúÍ∞Ñ Ï†êÏàò ÌôïÏù∏</strong><br>
                            <span style="font-size:14px;">ÏßÑÌñâ Ï§ëÏù∏ Í≤ΩÍ∏∞Ïùò Ï†êÏàòÎ•º Ïã§ÏãúÍ∞ÑÏúºÎ°ú ÌôïÏù∏Ìï©ÎãàÎã§.</span>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="goTo('project-list')" style="width:100%; margin-bottom:16px;" aria-label="Ïã§ÏãúÍ∞Ñ Í≤ΩÍ∏∞ Ï†êÏàò ÌôïÏù∏">
                            Ïã§ÏãúÍ∞Ñ Í≤ΩÍ∏∞ Î≥¥Í∏∞
                        </button>
                        
                        <div style="background:#fff3e0; border-left:4px solid #ff9800; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>Ïó∞Ïäµ Í≤ΩÍ∏∞ Ïã§ÏãúÍ∞Ñ</strong><br>
                            <span style="font-size:14px;">Í≥µÏú†Îêú Ïó∞Ïäµ Í≤ΩÍ∏∞Î•º Ïã§ÏãúÍ∞ÑÏúºÎ°ú ÌôïÏù∏Ìï©ÎãàÎã§.</span>
                        </div>
                        <button type="button" class="btn" onclick="goTo('live-practice')" style="width:100%; margin-bottom:16px; background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%); color:white;" aria-label="Ïó∞Ïäµ Í≤ΩÍ∏∞ Ïã§ÏãúÍ∞Ñ Î≥¥Í∏∞">
                            üî¥ Ïó∞Ïäµ Í≤ΩÍ∏∞ Ïã§ÏãúÍ∞Ñ
                        </button>
                        
                        <div style="background:#fff3e0; border-left:4px solid #ff9800; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>üìÖ ÎÇ¥ ÏùºÏ†ï Ï°∞Ìöå</strong><br>
                            <span style="font-size:14px;">Ïù¥Î¶ÑÏúºÎ°ú ÎÇ¥ Í≤ΩÍ∏∞ ÏùºÏ†ïÍ≥º ÏÉÅÎåÄÎ•º ÌôïÏù∏Ìï©ÎãàÎã§.</span>
                        </div>
                        <button type="button" class="btn" onclick="goTo('player-schedule')" style="width:100%; margin-bottom:16px; background:#9c27b0; color:white;" aria-label="ÎÇ¥ ÏùºÏ†ï Ï°∞Ìöå">
                            üìÖ ÎÇ¥ ÏùºÏ†ï Ï°∞Ìöå
                        </button>
                        
                        <div style="background:#e8f5e9; border-left:4px solid #4caf50; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>ÎåÄÌöå Í≤∞Í≥º ÌôïÏù∏</strong><br>
                            <span style="font-size:14px;">Ï°∞Î≥Ñ ÏàúÏúÑ, ÌÜ†ÎÑàÎ®ºÌä∏ ÎåÄÏßÑÌëú, Í∞úÏù∏ Í∏∞Î°ùÏùÑ ÌôïÏù∏Ìï©ÎãàÎã§.</span>
                        </div>
                        <button type="button" class="btn" onclick="goTo('viewer-select-project')" style="width:100%; margin-bottom:16px;" aria-label="ÎåÄÌöå Í≤∞Í≥º ÌôïÏù∏">
                            ÎåÄÌöå Í≤∞Í≥º Î≥¥Í∏∞
                        </button>
                        
                        <button type="button" class="btn" onclick="goTo('home')" style="margin-top:8px;">‚Üê Î™®Îìú ÏÑ†ÌÉùÏúºÎ°ú</button>
                    </div>
                `;
            }
            
            // ========== Ïä§ÏºÄÏ§Ñ Ï°∞Ìöå ÌôîÎ©¥Îì§ ==========
            // Ï∞∏Í∞ÄÏûê Ïä§ÏºÄÏ§Ñ Ï°∞Ìöå
            else if (screen === 'player-schedule') {
                app.innerHTML = `
                    <header class="header" style="background:linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);">
                        <h1 style="color:white;">üìÖ ÎÇ¥ Í≤ΩÍ∏∞ Ïä§ÏºÄÏ§Ñ</h1>
                        <p style="color:rgba(255,255,255,0.9);">Ïù¥Î¶ÑÏúºÎ°ú Í≤ΩÍ∏∞ ÏùºÏ†ï Ï°∞Ìöå</p>
                    </header>
                    
                    <main>
                        <section>
                            <form onsubmit="searchPlayerSchedule(); return false;">
                                <fieldset>
                                    <legend class="sr-only">ÏÑ†Ïàò Ïù¥Î¶Ñ ÏûÖÎ†•</legend>
                                    <div class="form-group">
                                        <label for="player-name-search">ÏÑ†Ïàò/ÌåÄ Ïù¥Î¶Ñ</label>
                                        <input type="text" id="player-name-search" dir="ltr" lang="ko" placeholder="Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" required autocomplete="off" spellcheck="false">
                                    </div>
                                    <button type="submit" class="btn btn-primary" style="width:100%;">üîç ÎÇ¥ Í≤ΩÍ∏∞ Ï∞æÍ∏∞</button>
                                </fieldset>
                            </form>
                            
                            <div id="player-schedule-results"></div>
                            
                            <nav style="margin-top:20px;">
                                <button type="button" class="btn" onclick="goTo('viewer-home')" style="width:100%;">‚Üê Í¥ÄÎûå Î™®ÎìúÎ°ú</button>
                            </nav>
                        </section>
                    </main>
                `;
                
                setTimeout(() => {
                    document.getElementById('player-name-search')?.focus();
                }, 100);
            }
            
            // Ïã¨Ìåê Ïä§ÏºÄÏ§Ñ Ï°∞Ìöå
            else if (screen === 'referee-schedule') {
                app.innerHTML = `
                    <header class="header" style="background:linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);">
                        <h1 style="color:white;">üë®‚Äç‚öñÔ∏è ÎÇ¥ Ïã¨Ìåê Ïä§ÏºÄÏ§Ñ</h1>
                        <p style="color:rgba(255,255,255,0.9);">Î∞∞Ï†ïÎêú Í≤ΩÍ∏∞ ÏùºÏ†ï</p>
                    </header>
                    
                    <main>
                        <section>
                            <form onsubmit="searchRefereeSchedule(); return false;">
                                <fieldset>
                                    <legend class="sr-only">Ïã¨Ìåê Ïù¥Î¶Ñ ÏûÖÎ†•</legend>
                                    <div class="form-group">
                                        <label for="referee-name-search">Ïã¨Ìåê Ïù¥Î¶Ñ</label>
                                        <input type="text" id="referee-name-search" dir="ltr" lang="ko" placeholder="Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" required autocomplete="off" spellcheck="false">
                                    </div>
                                    <button type="submit" class="btn btn-primary" style="width:100%;">üîç ÎÇ¥ Ïã¨Ìåê Í≤ΩÍ∏∞ Ï∞æÍ∏∞</button>
                                </fieldset>
                            </form>
                            
                            <div id="referee-schedule-results"></div>
                            
                            <nav style="margin-top:20px;">
                                <button type="button" class="btn" onclick="goTo('referee-home')" style="width:100%;">‚Üê Ïã¨Ìåê Î™®ÎìúÎ°ú</button>
                            </nav>
                        </section>
                    </main>
                `;
                
                setTimeout(() => {
                    document.getElementById('referee-name-search')?.focus();
                }, 100);
            }
            
            // Í¥ÄÎ¶¨ÏûêÏö© Ï†ÑÏ≤¥ Ïä§ÏºÄÏ§Ñ ÌÉÄÏûÑÎùºÏù∏
            else if (screen === 'schedule-overview') {
                const allMatches = currentProject?.matches || [];
                const scheduledMatches = allMatches.filter(m => m.scheduledDate && m.scheduledTime);
                
                // ÎÇ†ÏßúÎ≥ÑÎ°ú Í∑∏Î£πÌïë
                const matchesByDate = {};
                scheduledMatches.forEach(match => {
                    const date = match.scheduledDate;
                    if (!matchesByDate[date]) {
                        matchesByDate[date] = [];
                    }
                    matchesByDate[date].push(match);
                });
                
                // ÎÇ†ÏßúÎ≥ÑÎ°ú ÏãúÍ∞ÑÏàú Ï†ïÎ†¨
                Object.keys(matchesByDate).forEach(date => {
                    matchesByDate[date].sort((a, b) => a.scheduledTime.localeCompare(b.scheduledTime));
                });
                
                const datesHTML = Object.keys(matchesByDate).sort().map(date => {
                    const matches = matchesByDate[date];
                    const dateObj = new Date(date);
                    const dateStr = dateObj.toLocaleDateString('ko-KR', { 
                        month: 'long', 
                        day: 'numeric',
                        weekday: 'short'
                    });
                    
                    return `
                        <div style="margin-bottom:24px;">
                            <h3 style="background:#f5f5f5; padding:12px 16px; border-radius:8px; margin-bottom:16px; border-left:4px solid #2196f3;">
                                üìÖ ${dateStr} (${matches.length}Í≤ΩÍ∏∞)
                            </h3>
                            
                            ${matches.map(match => {
                                const endTime = new Date(\`\${match.scheduledDate}T\${match.scheduledTime}\`);
                                endTime.setMinutes(endTime.getMinutes() + match.estimatedDuration);
                                const endTimeStr = endTime.toTimeString().slice(0, 5);
                                
                                return \`
                                    <div style="background:white; border:1px solid #ddd; border-radius:8px; padding:16px; margin-bottom:12px; position:relative;">
                                        <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                                            <div>
                                                <h4 style="margin:0 0 4px 0; color:#1976d2;">
                                                    \${match.player1Name} vs \${match.player2Name}
                                                </h4>
                                                <div style="font-size:14px; color:#666;">
                                                    üïê \${match.scheduledTime} - \${endTimeStr} (\${match.estimatedDuration}Î∂Ñ)
                                                </div>
                                            </div>
                                            <div style="text-align:right; font-size:12px;">
                                                <div style="background:\${match.status === 'completed' ? '#4caf50' : match.status === 'in-progress' ? '#ff9800' : '#e0e0e0'}; color:\${match.status === 'pending' ? '#666' : 'white'}; padding:4px 8px; border-radius:12px; margin-bottom:4px;">
                                                    \${match.status === 'completed' ? 'ÏôÑÎ£å' : match.status === 'in-progress' ? 'ÏßÑÌñâÏ§ë' : 'ÎåÄÍ∏∞'}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; font-size:13px;">
                                            <div>
                                                <strong>üèüÔ∏è Í≤ΩÍ∏∞Ïû•:</strong> \${match.courtName || 'ÎØ∏ÏßÄÏ†ï'}
                                            </div>
                                            <div>
                                                <strong>üë®‚Äç‚öñÔ∏è Ïã¨Ìåê:</strong> \${match.mainRefereeName || 'ÎØ∏ÏßÄÏ†ï'}
                                            </div>
                                        </div>
                                    </div>
                                \`;
                            }).join('')}
                        </div>
                    `;
                }).join('') || '<p style="text-align:center; color:#666; padding:40px;">ÏïÑÏßÅ Ïä§ÏºÄÏ§ÑÏù¥ ÏÑ§Ï†ïÎêú Í≤ΩÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                
                app.innerHTML = `
                    <header class="header" style="background:linear-gradient(135deg, #2196f3 0%, #1976d2 100%);">
                        <h1 style="color:white;">üìã Í≤ΩÍ∏∞ Ïä§ÏºÄÏ§Ñ ÌÉÄÏûÑÎùºÏù∏</h1>
                        <p style="color:rgba(255,255,255,0.9);">${currentProject?.name || 'ÎåÄÌöå'} Ï†ÑÏ≤¥ ÏùºÏ†ï</p>
                    </header>
                    
                    <main>
                        <section>
                            <div style="background:#e3f2fd; padding:16px; border-radius:8px; margin-bottom:16px;">
                                <strong>üìä Ïä§ÏºÄÏ§Ñ ÌòÑÌô©</strong>
                                <div style="font-size:13px; margin-top:8px; color:#333;">
                                    Ï†ÑÏ≤¥ Í≤ΩÍ∏∞: ${allMatches.length}Í≤ΩÍ∏∞ ¬∑ 
                                    Ïä§ÏºÄÏ§Ñ ÏÑ§Ï†ï: ${scheduledMatches.length}Í≤ΩÍ∏∞ ¬∑ 
                                    ÎØ∏ÏÑ§Ï†ï: ${allMatches.length - scheduledMatches.length}Í≤ΩÍ∏∞
                                </div>
                            </div>
                            
                            <div style="max-height:600px; overflow-y:auto;">
                                ${datesHTML}
                            </div>
                            
                            <nav style="margin-top:20px;">
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                    <button type="button" class="btn" onclick="goTo('edit-matches')" style="background:#2196f3; color:white;">
                                        ‚öôÔ∏è Ïä§ÏºÄÏ§Ñ Ìé∏Ïßë
                                    </button>
                                    <button type="button" class="btn" onclick="goTo('project-detail')">
                                        ‚Üê ÎåÄÌöå ÏÉÅÏÑ∏Î°ú
                                    </button>
                                </div>
                            </nav>
                        </section>
                    </main>
                `;
            }
            
            // ========== Ïã§ÏãúÍ∞Ñ Í≤ΩÍ∏∞ Í≤ÄÏÉâ (Í¥ÄÎûåÍ∞ù Î™®Îìú) ==========
            else if (screen === 'match-list') {
                // ‚ú® ÌÉ≠ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                if (!window.viewerTab) window.viewerTab = 'actual';
                
                const tabStyle = (tab) => `
                    padding:12px 16px; 
                    cursor:pointer; 
                    border:none; 
                    background:${window.viewerTab === tab ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : '#e0e0e0'}; 
                    color:${window.viewerTab === tab ? 'white' : '#333'}; 
                    border-radius:6px; 
                    font-weight:600;
                    flex:1;
                `;
                
                app.innerHTML = `
                    <div class="header" style="display:flex; justify-content:space-between; align-items:center; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div style="color:white;">
                            <button class="btn" onclick="goTo('viewer-home')" style="padding:8px 12px; margin-right:12px; background:rgba(255,255,255,0.2); color:white;">‚¨ÖÔ∏è ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                            <h1 style="display:inline; color:white;">Ïã§ÏãúÍ∞Ñ Í≤ΩÍ∏∞ ÌòÑÌô©</h1>
                        </div>
                        <button class="btn" onclick="toggleNotifications()" style="background:#ff9800; color:white; padding:10px 14px; border-radius:6px; font-size:18px;" aria-label="Ïã§ÏãúÍ∞Ñ ÏïåÎ¶º ÏÑ§Ï†ï">üîî</button>
                    </div>
                    
                    <div class="card" style="margin-bottom:10px;">
                        <div style="position:relative; margin-bottom:12px;">
                            <input type="text" id="viewer-search" placeholder="üîç ÏÑ†ÏàòÎ™Ö ÎòêÎäî Í≤ΩÍ∏∞Ïû• Í≤ÄÏÉâ..." 
                                   oninput="renderViewerResults()" 
                                   style="width:100%; padding:14px; border-radius:10px; border:2px solid #667eea; box-sizing:border-box; font-size:14px;"
                                   aria-label="ÏÑ†ÏàòÎ™Ö ÎòêÎäî Í≤ΩÍ∏∞Ïû•ÏúºÎ°ú Í≤ΩÍ∏∞ Í≤ÄÏÉâ">
                            <button onclick="clearSearch()" style="position:absolute; right:12px; top:14px; border:none; background:none; cursor:pointer; font-size:20px; color:#666;" aria-label="Í≤ÄÏÉâÏñ¥ Ï¥àÍ∏∞Ìôî">‚ùå</button>
                        </div>
                        
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <button class="btn" onclick="filterFavoritesOnly()" style="flex:1; min-width:140px; padding:12px; background:#f1c40f; color:#333; border:none; border-radius:6px; font-weight:600;" aria-label="Ï¶êÍ≤®Ï∞æÍ∏∞Ìïú Í≤ΩÍ∏∞Îßå ÌëúÏãú">Ï¶êÍ≤®Ï∞æÍ∏∞Îßå</button>
                            <button class="btn" onclick="renderViewerResults()" style="flex:1; min-width:140px; padding:12px; background:#e0e0e0; color:#333; border:none; border-radius:6px; font-weight:600;" aria-label="Î™®Îì† Í≤ΩÍ∏∞ ÌëúÏãú">Ï†ÑÏ≤¥Î≥¥Í∏∞</button>
                        </div>
                        
                        <div style="display:flex; gap:8px; margin-top:12px; border-top:1px solid #e0e0e0; padding-top:12px;">
                            <button onclick="switchViewerTab('actual')" style="${tabStyle('actual')}">
                                Ïã§Ï†ú Í≤ΩÍ∏∞
                            </button>
                            <button onclick="switchViewerTab('practice')" style="${tabStyle('practice')}">
                                üèãÔ∏è Ïó∞Ïäµ Í≤ΩÍ∏∞
                            </button>
                        </div>
                    </div>
                    
                    <div id="viewer-results-container" style="padding:0 16px; margin-bottom:20px;">
                        <!-- Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê Î†åÎçîÎßÅÎê® -->
                    </div>
                `;
                renderViewerResults();
                return;
            }
            else if (screen === 'live-practice') {
                // Ïã§ÏãúÍ∞Ñ Ïó∞Ïäµ Í≤ΩÍ∏∞ Î™©Î°ù
                const liveMatches = projects
                    .filter(p => p.isPractice && p.isShared)
                    .flatMap(p => (p.matches || []).map(m => ({ ...m, projectName: p.name })))
                    .filter(m => m.isShared);
                
                const inProgressMatches = liveMatches.filter(m => m.status === 'in-progress');
                const completedMatches = liveMatches.filter(m => m.status === 'completed').slice(0, 10);
                
                const inProgressHTML = inProgressMatches.length > 0 ? inProgressMatches.map(m => `
                    <div style="padding:16px; margin:8px 0; background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%); border-radius:12px; color:white; cursor:pointer;" onclick="watchLiveMatch(${m.id})">
                        <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                            <span style="animation: blink 1s infinite;">üî¥</span>
                            <strong>LIVE</strong>
                        </div>
                        <div style="font-size:18px; font-weight:600; margin-bottom:4px;">${m.player1Name} vs ${m.player2Name}</div>
                        <div style="font-size:14px; opacity:0.9;">
                            ${m.setScores ? m.setScores.map((s, i) => `${i === m.currentSet - 1 ? '‚ñ∂' : ''}[${s.player1}-${s.player2}]`).join(' ') : '[0-0]'}
                        </div>
                        <div style="font-size:12px; margin-top:4px; opacity:0.8;">
                            ${m.type === 'team' ? 'ÌåÄÏ†Ñ 31Ï†ê' : `Í∞úÏù∏Ï†Ñ ${m.sets}ÏÑ∏Ìä∏`}
                        </div>
                    </div>
                `).join('') : '<p style="text-align:center; color:#666; padding:20px;">ÌòÑÏû¨ ÏßÑÌñâ Ï§ëÏù∏ Ïó∞Ïäµ Í≤ΩÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§</p>';
                
                const completedHTML = completedMatches.length > 0 ? completedMatches.map(m => `
                    <div style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; cursor:pointer;" onclick="watchLiveMatch(${m.id})">
                        <div style="font-weight:600;">${m.player1Name} vs ${m.player2Name}</div>
                        <div style="font-size:13px; color:#666; margin-top:4px;">
                            ${m.setScores ? m.setScores.map(s => `[${s.player1}-${s.player2}]`).join(' ') : ''}
                            ¬∑ ÏäπÏûê: ${m.winner || 'ÎØ∏Ï†ï'}
                        </div>
                    </div>
                `).join('') : '';
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%);">
                        <h1 style="color:white;">üî¥ Ïã§ÏãúÍ∞Ñ Ïó∞Ïäµ Í≤ΩÍ∏∞</h1>
                        <p style="color:rgba(255,255,255,0.9);">Í≥µÏú†Îêú Ïó∞Ïäµ Í≤ΩÍ∏∞Î•º Ïã§ÏãúÍ∞ÑÏúºÎ°ú ÌôïÏù∏</p>
                    </div>
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <h2 style="margin:0;">‚è≥ ÏßÑÌñâ Ï§ë (${inProgressMatches.length})</h2>
                            <button class="btn" onclick="render()" style="padding:8px 12px;">ÏÉàÎ°úÍ≥†Ïπ®</button>
                        </div>
                        ${inProgressHTML}
                    </div>
                    
                    ${completedMatches.length > 0 ? `
                        <div class="card">
                            <h2>ÏµúÍ∑º ÏôÑÎ£å (${completedMatches.length})</h2>
                            ${completedHTML}
                        </div>
                    ` : ''}
                    
                    <div class="card">
                        <button class="btn" onclick="goTo('viewer-home')" style="width:100%;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                    </div>
                    
                    <style>
                        @keyframes blink {
                            0%, 50% { opacity: 1; }
                            51%, 100% { opacity: 0.3; }
                        }
                    </style>
                `;
            }
            else if (screen === 'player-schedule') {
                // ÏÑ†Ïàò/ÌåÄ ÏùºÏ†ï Ï°∞Ìöå ÌôîÎ©¥
                const tournamentProjects = projects.filter(p => p.tournamentType && p.matches?.length > 0);
                
                const projectOptions = tournamentProjects.map((p, i) => {
                    const actualIndex = projects.indexOf(p);
                    return `<option value="${actualIndex}">${p.name}</option>`;
                }).join('');
                
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%);">
                        <h1 style="color:white;">üìÖ ÎÇ¥ ÏùºÏ†ï Ï°∞Ìöå</h1>
                        <p style="color:rgba(255,255,255,0.9);">Ïù¥Î¶ÑÏúºÎ°ú Í≤ΩÍ∏∞ ÏùºÏ†ï ÌôïÏù∏</p>
                    </div>
                    <div class="card">
                        <div class="form-group">
                            <label>ÎåÄÌöå ÏÑ†ÌÉù</label>
                            <select id="schedule-project" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;" onchange="onScheduleProjectChange()">
                                <option value="">-- ÎåÄÌöåÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî --</option>
                                ${projectOptions}
                            </select>
                        </div>
                        
                        <div id="participant-select-area" style="display:none;">
                            <div class="form-group">
                                <label>Ïù¥Î¶Ñ ÏÑ†ÌÉù ÎòêÎäî ÏûÖÎ†•</label>
                                <select id="schedule-name-select" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px; margin-bottom:8px;" onchange="onScheduleNameSelect()">
                                    <option value="">-- Î™©Î°ùÏóêÏÑú ÏÑ†ÌÉù --</option>
                                </select>
                                <input type="text" id="schedule-name-input" placeholder="ÎòêÎäî Ïù¥Î¶Ñ ÏßÅÏ†ë ÏûÖÎ†•" style="width:100%;">
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="lookupSchedule()" style="width:100%;">
                                üîç ÏùºÏ†ï Ï°∞Ìöå
                            </button>
                        </div>
                        
                        <div id="schedule-result" style="margin-top:20px;"></div>
                        
                        <button type="button" class="btn" onclick="goTo('viewer-home')" style="width:100%; margin-top:16px;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                    </div>
                `;
            }
            else if (screen === 'practice-mode') {
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%);">
                        <h1 style="color:white;">Ïã¨Ìåê Ïó∞Ïäµ Î™®Îìú</h1>
                        <p style="color:rgba(255,255,255,0.9);">ÌîÑÎ°úÏ†ùÌä∏ ÏóÜÏù¥ Î∞îÎ°ú Í≤ΩÍ∏∞ ÏßÑÌñâ ¬∑ Ïã§ÏãúÍ∞Ñ Í≥µÏú†</p>
                    </div>
                    <div class="card">
                        <h2>Í≤ΩÍ∏∞ ÏÑ§Ï†ï</h2>
                        
                        <div class="form-group">
                            <label>Í≤ΩÍ∏∞ Ïú†Ìòï</label>
                            <select id="practice-type" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;">
                                <option value="individual">Í∞úÏù∏Ï†Ñ (11Ï†ê ÏÑ∏Ìä∏Ï†ú)</option>
                                <option value="team">ÌåÄÏ†Ñ (31Ï†ê Îã®Ìåê)</option>
                            </select>
                        </div>
                        
                        <div id="practice-sets-group" class="form-group">
                            <label>ÏÑ∏Ìä∏ Ïàò (Í∞úÏù∏Ï†Ñ)</label>
                            <select id="practice-sets" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;">
                                <option value="1">1ÏÑ∏Ìä∏ (Îã®Ìåê)</option>
                                <option value="2">2ÏÑ∏Ìä∏</option>
                                <option value="3" selected>3ÏÑ∏Ìä∏ (2ÏÑ†Ïäπ)</option>
                                <option value="4">4ÏÑ∏Ìä∏</option>
                                <option value="5">5ÏÑ∏Ìä∏ (3ÏÑ†Ïäπ)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>ÏÑ†Ïàò/ÌåÄ 1</label>
                            <input type="text" id="practice-player1" dir="ltr" lang="ko" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;" autocomplete="off" spellcheck="false">
                        </div>
                        
                        <div class="form-group">
                            <label>ÏÑ†Ïàò/ÌåÄ 2</label>
                            <input type="text" id="practice-player2" dir="ltr" lang="ko" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†•" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;" autocomplete="off" spellcheck="false">
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="practice-share" checked style="margin-right:8px;">
                                Ïã§ÏãúÍ∞Ñ Í≥µÏú† (Í¥ÄÎûåÏûêÍ∞Ä Í≤ΩÍ∏∞ ÏßÑÌñâ ÏÉÅÌô©ÏùÑ Î≥º Ïàò ÏûàÏùå)
                            </label>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="startPracticeMatch()" style="width:100%; margin-top:16px; background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%);" aria-label="Ïó∞Ïäµ Í≤ΩÍ∏∞ ÏãúÏûë">
                            Í≤ΩÍ∏∞ ÏãúÏûë
                        </button>
                        
                        <button type="button" class="btn" onclick="goTo('practice-history')" style="width:100%; margin-top:8px;">
                            Ïó∞Ïäµ Í∏∞Î°ù Î≥¥Í∏∞
                        </button>
                        
                        <button type="button" class="btn" onclick="goTo('home')" style="width:100%; margin-top:8px;" aria-label="ÎèåÏïÑÍ∞ÄÍ∏∞">
                            ‚Üê ÌôàÏúºÎ°ú
                        </button>
                    </div>
                `;
                
                // ÌåÄÏ†Ñ ÏÑ†ÌÉù Ïãú ÏÑ∏Ìä∏ Ïàò Ïà®Í∏∞Í∏∞
                setTimeout(() => {
                    const typeSelect = document.getElementById('practice-type');
                    const setsGroup = document.getElementById('practice-sets-group');
                    if (typeSelect && setsGroup) {
                        typeSelect.onchange = function() {
                            setsGroup.style.display = this.value === 'team' ? 'none' : 'block';
                        };
                    }
                }, 100);
            }
            else if (screen === 'quick-project') {
                // Îπ†Î•∏ ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                        <h1 style="color:white;">Îπ†Î•∏ ÌîÑÎ°úÏ†ùÌä∏</h1>
                        <p style="color:rgba(255,255,255,0.9);">ÏÜåÍ∑úÎ™® ÎåÄÌöå/Ïó∞ÏäµÏö©</p>
                    </div>
                    <div class="card">
                        <div class="form-group">
                            <label>ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶Ñ <span style="color:#d32f2f;">*</span></label>
                            <input type="text" id="qp-name" placeholder="Ïòà: ÏπúÏÑ† Í≤ΩÍ∏∞, Ïó∞Ïäµ ÎåÄÌöå" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;">
                        </div>
                        
                        <div class="form-group">
                            <label>Í≤ΩÍ∏∞ Ïú†Ìòï</label>
                            <select id="qp-type" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;" onchange="updateQPSets()">
                                <option value="individual">Í∞úÏù∏Ï†Ñ (11Ï†ê ÏÑ∏Ìä∏Ï†ú)</option>
                                <option value="team">ÌåÄÏ†Ñ (31Ï†ê Îã®Ìåê)</option>
                            </select>
                        </div>
                        
                        <div id="qp-sets-group" class="form-group">
                            <label>ÏÑ∏Ìä∏ Ïàò</label>
                            <select id="qp-sets" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;">
                                <option value="1">1ÏÑ∏Ìä∏</option>
                                <option value="3" selected>3ÏÑ∏Ìä∏ (2ÏÑ†Ïäπ)</option>
                                <option value="5">5ÏÑ∏Ìä∏ (3ÏÑ†Ïäπ)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Ï∞∏Í∞ÄÏûê ÏûÖÎ†• <span style="color:#d32f2f;">*</span></label>
                            <textarea id="qp-participants" dir="ltr" lang="ko" placeholder="Ìïú Ï§ÑÏóê Ìïú Î™ÖÏî© ÏûÖÎ†•ÌïòÏÑ∏Ïöî&#10;&#10;ÏòàÏãú:&#10;ÌôçÍ∏∏Îèô&#10;ÍπÄÏ≤†Ïàò&#10;Ïù¥ÏòÅÌù¨&#10;Î∞ïÎØºÏàò" style="width:100%; height:150px; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:14px; resize:vertical; direction:ltr !important; text-align:left !important;"></textarea>
                            <div style="font-size:12px; color:#666; margin-top:4px;">ÏâºÌëú(,)Î°ú Íµ¨Î∂ÑÌïòÍ±∞ÎÇò Ï§ÑÎ∞îÍøàÏúºÎ°ú ÏûÖÎ†•</div>
                        </div>
                        
                        <div class="form-group">
                            <label>ÎåÄÏßÑ Î∞©Ïãù</label>
                            <select id="qp-format" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-size:16px;">
                                <option value="full-league">ÌíÄÎ¶¨Í∑∏ (Î™®Îëê vs Î™®Îëê)</option>
                                <option value="tournament">ÌÜ†ÎÑàÎ®ºÌä∏</option>
                            </select>
                        </div>
                        
                        <button type="button" class="btn btn-primary" onclick="createQuickProject()" style="width:100%; margin-top:16px; background:linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);">
                            ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±
                        </button>
                        
                        <button type="button" class="btn" onclick="goTo('referee-home')" style="width:100%; margin-top:8px;">
                            ‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞
                        </button>
                    </div>
                `;
            }
            else if (screen === 'practice-result') {
                // Ïó∞Ïäµ Í≤ΩÍ∏∞ Í≤∞Í≥º ÌôîÎ©¥
                if (!currentMatch) {
                    goTo('practice-mode');
                    return;
                }
                
                const m = currentMatch;
                const p1Wins = m.setScores.filter(s => s.player1 > s.player2).length;
                const p2Wins = m.setScores.filter(s => s.player2 > s.player1).length;
                const winner = m.winner || (p1Wins > p2Wins ? m.player1Name : m.player2Name);
                
                // ÏÑ∏Ìä∏Î≥Ñ Ï†êÏàò
                const setScoresHTML = m.setScores.map((s, idx) => {
                    if (s.player1 === 0 && s.player2 === 0) return '';
                    const setWinner = s.player1 > s.player2 ? m.player1Name : m.player2Name;
                    return `
                        <div style="display:flex; justify-content:space-between; padding:12px; margin:4px 0; background:${s.player1 > s.player2 ? '#e3f2fd' : '#fff3e0'}; border-radius:8px;">
                            <span>ÏÑ∏Ìä∏ ${idx + 1}</span>
                            <span style="font-weight:600;">${s.player1} : ${s.player2}</span>
                            <span style="color:#666;">${setWinner}</span>
                        </div>
                    `;
                }).join('');
                
                // ÎìùÏ†ê ÌûàÏä§ÌÜ†Î¶¨
                const historyHTML = m.history && m.history.length > 0 ? `
                    <div style="margin-top:20px;">
                        <h4 style="margin:0 0 8px 0;">ÎìùÏ†ê Í∏∞Î°ù (${m.history.length})</h4>
                        <div style="max-height:200px; overflow-y:auto; background:#f5f5f5; border-radius:8px; padding:8px;">
                            ${m.history.slice().reverse().map((h, i) => `
                                <div style="padding:6px 8px; border-bottom:1px solid #eee; font-size:13px;">
                                    <span style="color:#666;">#${m.history.length - i}</span>
                                    <span style="margin-left:8px;">${h.player === 'player1' ? m.player1Name : m.player2Name}</span>
                                    <span style="color:#1976d2; font-weight:600;">+${h.points}</span>
                                    <span style="color:#888; margin-left:4px;">(${h.type})</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';
                
                app.innerHTML = `
                    <div class="card">
                        <div style="text-align:center; padding:20px; background:linear-gradient(135deg, #4caf50 0%, #2e7d32 100%); color:white; border-radius:12px; margin-bottom:20px;">
                            <div style="font-size:48px; margin-bottom:8px;">üèÜ</div>
                            <h2 style="margin:0; color:white;">Ïó∞Ïäµ Í≤ΩÍ∏∞ Ï¢ÖÎ£å</h2>
                            <div style="font-size:24px; margin-top:12px; font-weight:700;">${winner} ÏäπÎ¶¨!</div>
                            <div style="font-size:18px; margin-top:8px; opacity:0.9;">ÏÑ∏Ìä∏ ${p1Wins} : ${p2Wins}</div>
                        </div>
                        
                        <div style="display:flex; justify-content:space-around; margin-bottom:20px; padding:16px; background:#f5f5f5; border-radius:8px;">
                            <div style="text-align:center;">
                                <div style="font-size:14px; color:#666;">${m.player1Name}</div>
                                <div style="font-size:28px; font-weight:700; color:${p1Wins > p2Wins ? '#4caf50' : '#666'};">${p1Wins}</div>
                            </div>
                            <div style="font-size:24px; color:#999; align-self:center;">ÏÑ∏Ìä∏</div>
                            <div style="text-align:center;">
                                <div style="font-size:14px; color:#666;">${m.player2Name}</div>
                                <div style="font-size:28px; font-weight:700; color:${p2Wins > p1Wins ? '#4caf50' : '#666'};">${p2Wins}</div>
                            </div>
                        </div>
                        
                        <h4 style="margin:0 0 8px 0;">ÏÑ∏Ìä∏Î≥Ñ Ï†êÏàò</h4>
                        ${setScoresHTML}
                        
                        ${historyHTML}
                        
                        <div style="margin-top:24px; display:flex; flex-direction:column; gap:8px;">
                            <div style="text-align:center; color:#4caf50; font-size:14px; margin-bottom:8px;">
                                Í∏∞Î°ùÏù¥ ÏûêÎèô Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§
                            </div>
                            <button class="btn" onclick="goTo('practice-history')" style="background:#4caf50; color:white;">
                                Ï†ÄÏû•Îêú Í∏∞Î°ù Î≥¥Í∏∞
                            </button>
                            <div style="display:flex; gap:8px;">
                                <button class="btn btn-primary" onclick="goTo('practice-mode')" style="flex:1;">ÏÉà Ïó∞Ïäµ Í≤ΩÍ∏∞</button>
                                <button class="btn" onclick="goTo('referee-home')" style="flex:1;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            else if (screen === 'practice-history') {
                // Ïó∞Ïäµ Í≤ΩÍ∏∞ Í∏∞Î°ù Î™©Î°ù
                const practiceHistory = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
                
                const historyList = practiceHistory.length > 0 ? practiceHistory.slice().reverse().map((m, idx) => {
                    const realIdx = practiceHistory.length - 1 - idx;
                    const p1Wins = m.setScores?.filter(s => s.player1 > s.player2).length || 0;
                    const p2Wins = m.setScores?.filter(s => s.player2 > s.player1).length || 0;
                    const date = m.finishedAt ? new Date(m.finishedAt).toLocaleDateString('ko-KR') : '';
                    
                    return `
                        <div style="padding:16px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; cursor:pointer; border-left:4px solid #ff9800;" onclick="viewPracticeRecord(${realIdx})">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <strong>${m.player1Name} vs ${m.player2Name}</strong>
                                    <div style="font-size:13px; color:var(--text-secondary); margin-top:4px;">
                                        ${p1Wins} : ${p2Wins} ÏÑ∏Ìä∏ ¬∑ ${m.winner} Ïäπ
                                    </div>
                                </div>
                                <div style="text-align:right;">
                                    <div style="font-size:12px; color:var(--text-secondary);">${date}</div>
                                    <button class="btn btn-danger" onclick="event.stopPropagation(); deletePracticeRecord(${realIdx})" style="padding:4px 8px; min-width:auto; margin-top:4px; font-size:12px;">üóëÔ∏è</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('') : '<p style="text-align:center; color:var(--text-secondary); padding:20px;">Ï†ÄÏû•Îêú Ïó∞Ïäµ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                
                app.innerHTML = `
                    <div class="card">
                        <div class="header" style="margin:-20px -20px 20px -20px; padding:20px; border-radius:12px 12px 0 0; background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%);">
                            <h1 style="color:white; margin:0;">Ïó∞Ïäµ Í∏∞Î°ù</h1>
                            <p style="color:rgba(255,255,255,0.9); margin:4px 0 0 0;">${practiceHistory.length}Í∞úÏùò Í∏∞Î°ù</p>
                        </div>
                        
                        ${historyList}
                        
                        ${practiceHistory.length > 0 ? `
                            <button class="btn btn-danger" onclick="clearPracticeHistory()" style="width:100%; margin-top:16px;">
                                Ï†ÑÏ≤¥ Í∏∞Î°ù ÏÇ≠Ï†ú
                            </button>
                        ` : ''}
                        
                        <button class="btn" onclick="goTo('practice-mode')" style="width:100%; margin-top:8px;">
                            ‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞
                        </button>
                    </div>
                `;
            }
            else if (screen === 'practice-detail') {
                // Ïó∞Ïäµ Í≤ΩÍ∏∞ ÏÉÅÏÑ∏ Í∏∞Î°ù
                const practiceHistory = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
                const recordIdx = window.currentPracticeRecordIdx;
                
                if (recordIdx === undefined || !practiceHistory[recordIdx]) {
                    goTo('practice-history');
                    return;
                }
                
                const m = practiceHistory[recordIdx];
                const p1Wins = m.setScores?.filter(s => s.player1 > s.player2).length || 0;
                const p2Wins = m.setScores?.filter(s => s.player2 > s.player1).length || 0;
                
                // ÏÑ∏Ìä∏Î≥Ñ Ï†êÏàò
                const setScoresHTML = m.setScores?.map((s, idx) => {
                    if (s.player1 === 0 && s.player2 === 0) return '';
                    const setWinner = s.player1 > s.player2 ? m.player1Name : m.player2Name;
                    return `
                        <div style="display:flex; justify-content:space-between; padding:12px; margin:4px 0; background:${s.player1 > s.player2 ? '#e3f2fd' : '#fff3e0'}; border-radius:8px;">
                            <span>ÏÑ∏Ìä∏ ${idx + 1}</span>
                            <span style="font-weight:600;">${s.player1} : ${s.player2}</span>
                            <span style="color:#666;">${setWinner}</span>
                        </div>
                    `;
                }).join('') || '';
                
                // ÎìùÏ†ê ÌûàÏä§ÌÜ†Î¶¨
                const historyHTML = m.history && m.history.length > 0 ? `
                    <div style="margin-top:20px;">
                        <h4 style="margin:0 0 8px 0;">ÎìùÏ†ê Í∏∞Î°ù (${m.history.length})</h4>
                        <div style="max-height:300px; overflow-y:auto; background:#f5f5f5; border-radius:8px; padding:8px;">
                            ${m.history.slice().reverse().map((h, i) => `
                                <div style="padding:6px 8px; border-bottom:1px solid #eee; font-size:13px;">
                                    <span style="color:#666;">#${m.history.length - i}</span>
                                    <span style="margin-left:8px;">${h.player === 'player1' ? m.player1Name : m.player2Name}</span>
                                    <span style="color:#1976d2; font-weight:600;">+${h.points}</span>
                                    <span style="color:#888; margin-left:4px;">(${h.type})</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : '';
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('practice-history')" style="margin-bottom:16px;">‚Üê Í∏∞Î°ù Î™©Î°ù</button>
                        
                        <div style="text-align:center; padding:20px; background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%); color:white; border-radius:12px; margin-bottom:20px;">
                            <h2 style="margin:0; color:white;">${m.player1Name} vs ${m.player2Name}</h2>
                            <div style="font-size:24px; margin-top:12px; font-weight:700;">${m.winner} ÏäπÎ¶¨!</div>
                            <div style="font-size:18px; margin-top:8px; opacity:0.9;">ÏÑ∏Ìä∏ ${p1Wins} : ${p2Wins}</div>
                            <div style="font-size:13px; margin-top:8px; opacity:0.8;">${m.finishedAt ? new Date(m.finishedAt).toLocaleString('ko-KR') : ''}</div>
                        </div>
                        
                        <h4 style="margin:0 0 8px 0;">ÏÑ∏Ìä∏Î≥Ñ Ï†êÏàò</h4>
                        ${setScoresHTML}
                        
                        ${historyHTML}
                    </div>
                `;
            }
            else if (screen === 'tournament-wizard') {
                // ÎåÄÌöå ÎåÄÏßÑ ÏÑ§Ï†ï ÏúÑÏûêÎìú (ÌïòÏù¥Î∏åÎ¶¨Îìú Ïª§Ïä§ÌÖÄ)
                const tw = window.tournamentWizard || { 
                    step: 1, 
                    mode: 'custom', // Ïª§Ïä§ÌÖÄÎßå ÏÇ¨Ïö©
                    template: null,
                    info: { name: '', date: '', location: '', type: 'individual', rules: '' },
                    participants: [],
                    teams: [],
                    seedOrder: [], // ÏãúÎìú ÏàúÏÑú
                    
                    // Ïã¨Ìåê ÏÑ§Ï†ï
                    referees: [],
                    courts: [],
                    
                    // ÏòàÏÑ† ÏÑ§Ï†ï
                    preliminary: {
                        enabled: true,
                        groupCount: 4,
                        perGroup: 4,
                        sets: 3,
                        advanceCount: 2,
                        wildcards: 0,
                        groupAssignment: 'random' // 'random', 'manual'
                    },
                    
                    // Î≥∏ÏÑ† ÏÑ§Ï†ï
                    finals: {
                        enabled: true,
                        size: 8,
                        sets: 5,
                        customBracket: [], // Ïª§Ïä§ÌÖÄ ÎåÄÏßÑ
                        sameGroupAvoid: 'quarterfinal' // 'none', 'quarterfinal', 'semifinal', 'all'
                    },
                    
                    // ÏÉùÏÑ±Îêú Îç∞Ïù¥ÌÑ∞
                    groups: [],
                    bracket: null
                };
                window.tournamentWizard = tw;
                
                // Í∏∞Î≥∏Í∞í Î≥¥Ïû•
                if (!tw.preliminary) tw.preliminary = { enabled: true, groupCount: 4, perGroup: 4, sets: 3, advanceCount: 2, wildcards: 0, groupAssignment: 'random' };
                if (!tw.finals) tw.finals = { enabled: true, size: 8, sets: 5, customBracket: [], sameGroupAvoid: 'quarterfinal' };
                if (!tw.seedOrder) tw.seedOrder = [];
                
                const stepTitles = ['', 'Í∏∞Î≥∏ Ï†ïÎ≥¥', 'Ï∞∏Í∞ÄÏûê Îì±Î°ù', 'ÏòàÏÑ† ÏÑ§Ï†ï', 'Î≥∏ÏÑ† ÏÑ§Ï†ï', 'ÎåÄÏßÑÌëú ÌôïÏù∏', 'Ïã¨Ìåê/Í≤ΩÍ∏∞Ïû• ÏÑ§Ï†ï'];
                const totalSteps = 6;
                
                // ÌéòÏù¥ÏßÄ ÌÉÄÏù¥ÌãÄ Ìó§Îçî
                const pageTitleHTML = `
                    <div class="header" style="margin:-20px -20px 20px -20px; padding:20px; border-radius:12px 12px 0 0; background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);">
                        <h1 style="color:white; margin:0; font-size:20px;">ÎåÄÌöå ÎåÄÏßÑ ÏÑ§Ï†ï</h1>
                        <p style="color:rgba(255,255,255,0.9); margin:4px 0 0 0; font-size:14px;">${stepTitles[tw.step]}</p>
                    </div>
                `;
                
                // ÏßÑÌñâÎ•† ÌëúÏãú
                const progressHTML = `
                    <div style="margin-bottom:24px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                            <span style="font-weight:600;">Îã®Í≥Ñ ${tw.step}/${totalSteps}</span>
                            <span style="color:var(--text-secondary);">${Math.round(tw.step/totalSteps*100)}%</span>
                        </div>
                        <div style="height:8px; background:#e0e0e0; border-radius:4px; overflow:hidden;">
                            <div style="height:100%; width:${tw.step/totalSteps*100}%; background:linear-gradient(90deg, #1976d2, #0d47a1); transition:width 0.3s;"></div>
                        </div>
                    </div>
                `;
                
                let stepContent = '';
                
                if (tw.step === 1) {
                    // Step 1: ÎåÄÌöå Í∏∞Î≥∏ Ï†ïÎ≥¥
                    stepContent = `
                        <div class="form-group">
                            <label>ÎåÄÌöåÎ™Ö <span style="color:#d32f2f;">*</span></label>
                            <input type="text" id="tw-name" dir="ltr" lang="ko" value="${tw.info.name}" placeholder="ÎåÄÌöå Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" style="width:100%; direction:ltr !important; text-align:left !important;" autocomplete="off" spellcheck="false" onchange="window.tournamentWizard.info.name=this.value;">
                        </div>
                        <div class="form-group">
                            <label>ÎÇ†Ïßú</label>
                            <input type="date" id="tw-date" value="${tw.info.date || new Date().toISOString().split('T')[0]}" style="width:100%;" onchange="window.tournamentWizard.info.date=this.value;">
                        </div>
                        <div class="form-group">
                            <label>Ïû•ÏÜå</label>
                            <input type="text" id="tw-location" dir="ltr" lang="ko" value="${tw.info.location}" placeholder="ÎåÄÌöå Ïû•ÏÜåÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî" style="width:100%; direction:ltr !important; text-align:left !important;" autocomplete="off" spellcheck="false" onchange="window.tournamentWizard.info.location=this.value;">
                        </div>
                        
                        <div style="background:#e8f5e9; padding:16px; border-radius:12px; margin-top:8px;">
                            <div style="font-weight:600; margin-bottom:8px;">Ïª§Ïä§ÌÖÄ Î™®Îìú</div>
                            <div style="font-size:13px; color:#666;">
                                Îã§Ïùå Îã®Í≥ÑÏóêÏÑú ÏÑ§Ï†ïÌï† Ïàò ÏûàÎäî Ìï≠Î™©:
                                <ul style="margin:8px 0 0 16px; padding:0;">
                                    <li>Ï°∞ Í∞úÏàò Î∞è Ìé∏ÏÑ± Î∞©Ïãù</li>
                                    <li>ÏòàÏÑ†/Î≥∏ÏÑ† ÏÑ∏Ìä∏ Ïàò</li>
                                    <li>ÏßÑÏ∂ú Ïù∏Ïõê Î∞è ÏôÄÏùºÎìúÏπ¥Îìú</li>
                                    <li>Î≥∏ÏÑ† ÎåÄÏßÑÌëú ÏßÅÏ†ë Íµ¨ÏÑ±</li>
                                </ul>
                            </div>
                        </div>
                    `;
                } else if (tw.step === 2) {
                    // Step 2: Ï∞∏Í∞ÄÏûê Îì±Î°ù
                    const unitName = tw.info.type === 'team' ? 'ÌåÄ' : 'Î™Ö';
                    
                    const participantList = tw.participants.map((p, i) => `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 12px; background:var(--bg-secondary); border-radius:6px; margin:4px 0;">
                            <div style="display:flex; align-items:center; gap:8px;">
                                <span style="background:#1976d2; color:white; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:600;">${i+1}</span>
                                <span>${p}</span>
                            </div>
                            <div style="display:flex; gap:4px;">
                                ${i > 0 ? `<button class="btn" onclick="moveTWParticipant(${i}, -1)" style="padding:4px 8px; min-width:auto; font-size:12px;">‚Üë</button>` : ''}
                                ${i < tw.participants.length - 1 ? `<button class="btn" onclick="moveTWParticipant(${i}, 1)" style="padding:4px 8px; min-width:auto; font-size:12px;">‚Üì</button>` : ''}
                                <button class="btn btn-danger" onclick="removeTWParticipant(${i})" aria-label="Ï∞∏Í∞ÄÏûê ÏÇ≠Ï†ú" style="padding:4px 8px; min-width:auto;">‚úï</button>
                            </div>
                        </div>
                    `).join('') || '<p style="color:var(--text-secondary); text-align:center; padding:20px;">Ï∞∏Í∞ÄÏûêÎ•º Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî</p>';
                    
                    stepContent = `
                        <div style="background:#e8f5e9; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>ÏûÖÎ†• ÏïàÎÇ¥</strong>
                            <p style="font-size:13px; margin-top:4px;">Ïó¨Îü¨ Î™ÖÏùÑ Ìïú Î≤àÏóê ÏûÖÎ†•ÌïòÎ†§Î©¥ ÏâºÌëú(,)Î°ú Íµ¨Î∂ÑÌïòÏÑ∏Ïöî. ÏàúÏÑúÎ•º Î≥ÄÍ≤ΩÌïòÎ©¥ ÏãúÎìú ÏàúÏÑúÎ°ú ÏÇ¨Ïö©Îê©ÎãàÎã§.</p>
                        </div>
                        
                        <div class="form-group">
                            <label>Ï∞∏Í∞ÄÏûê Ï∂îÍ∞Ä</label>
                            <div style="display:flex; gap:8px; margin-top:8px;">
                                <input type="text" id="tw-participant" dir="ltr" lang="ko" placeholder="Ïù¥Î¶Ñ ÏûÖÎ†• (ÏâºÌëúÎ°ú Ïó¨Îü¨ Î™Ö Íµ¨Î∂Ñ)" style="flex:1; direction:ltr !important; text-align:left !important; unicode-bidi:bidi-override !important;" autocomplete="off" spellcheck="false" inputmode="text" onkeypress="if(event.key==='Enter')addTWParticipant()">
                                <button class="btn btn-primary" onclick="addTWParticipant()">Ï∂îÍ∞Ä</button>
                            </div>
                        </div>
                        
                        <div style="display:flex; justify-content:space-between; align-items:center; margin:16px 0 12px 0;">
                            <div style="font-size:18px; font-weight:bold;">
                                Îì±Î°ù: ${tw.participants.length}${unitName}
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button class="btn" onclick="shuffleTWParticipants()" style="padding:6px 12px; font-size:13px;">ÎûúÎç§ ÏÑûÍ∏∞</button>
                                <button class="btn btn-danger" onclick="clearTWParticipants()" style="padding:6px 12px; font-size:13px;">Ï†ÑÏ≤¥ ÏÇ≠Ï†ú</button>
                            </div>
                        </div>
                        
                        <div style="max-height:350px; overflow-y:auto; border:1px solid var(--border); border-radius:8px; padding:8px;">
                            ${participantList}
                        </div>
                        
                        <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-top:16px;">
                            <strong>ÏãúÎìú ÏàúÏÑú</strong>
                            <p style="font-size:13px; margin-top:4px;">ÏúÑ Î™©Î°ù ÏàúÏÑúÍ∞Ä ÏãúÎìú ÏàúÏÑúÏûÖÎãàÎã§. ‚Üë‚Üì Î≤ÑÌäºÏúºÎ°ú Ï°∞Ï†ïÌïòÍ±∞ÎÇò Î≤ÑÌäºÏúºÎ°ú ÎûúÎç§ Î∞∞ÏπòÌïòÏÑ∏Ïöî.</p>
                        </div>
                    `;
                } else if (tw.step === 3) {
                    // Step 3: ÏòàÏÑ† ÏÑ§Ï†ï (Ïª§Ïä§ÌÖÄ) ÎòêÎäî ÎåÄÌöå Î∞©Ïãù ÏÑ†ÌÉù (ÌÖúÌîåÎ¶ø)
                    
                    if (tw.mode === 'custom') {
                        // Ïª§Ïä§ÌÖÄ Î™®Îìú: ÏòàÏÑ† ÏÉÅÏÑ∏ ÏÑ§Ï†ï
                        const participantCount = tw.participants.length;
                        const groupOptions = [2,3,4,5,6,8,10,12].filter(n => n <= participantCount).map(n => {
                            const perGroup = Math.ceil(participantCount / n);
                            return `<option value="${n}" ${tw.preliminary.groupCount === n ? 'selected' : ''}>${n}Í∞ú Ï°∞ (Ï°∞Îãπ ÏïΩ ${perGroup}Î™Ö)</option>`;
                        }).join('');
                        
                        stepContent = `
                            <div class="form-group">
                                <label>ÏòàÏÑ† ÏßÑÌñâ Ïó¨Î∂Ä</label>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px;">
                                    <div style="display:flex; align-items:center; gap:8px; padding:14px; background:${tw.preliminary.enabled ? '#e8f5e9' : '#f5f5f5'}; border-radius:8px; cursor:pointer; border:2px solid ${tw.preliminary.enabled ? '#4caf50' : 'transparent'};" onclick="window.tournamentWizard.preliminary.enabled=true;render();">
                                        <input type="radio" name="tw-prelim" value="true" ${tw.preliminary.enabled ? 'checked' : ''} style="pointer-events:none;">
                                        <span style="font-weight:600;">Ï°∞Î≥Ñ ÏòàÏÑ† ÏßÑÌñâ</span>
                                    </div>
                                    <div style="display:flex; align-items:center; gap:8px; padding:14px; background:${!tw.preliminary.enabled ? '#fff3e0' : '#f5f5f5'}; border-radius:8px; cursor:pointer; border:2px solid ${!tw.preliminary.enabled ? '#ff9800' : 'transparent'};" onclick="window.tournamentWizard.preliminary.enabled=false;render();">
                                        <input type="radio" name="tw-prelim" value="false" ${!tw.preliminary.enabled ? 'checked' : ''} style="pointer-events:none;">
                                        <span style="font-weight:600;">Î∞îÎ°ú Î≥∏ÏÑ†</span>
                                    </div>
                                </div>
                            </div>
                            
                            ${tw.preliminary.enabled ? `
                                <div class="form-group">
                                    <label>Ï°∞ Í∞úÏàò</label>
                                    <select id="tw-custom-groups" onchange="updateCustomPreliminary()" style="width:100%;">
                                        ${groupOptions}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>ÏòàÏÑ† ÏÑ∏Ìä∏ Ïàò</label>
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px;">
                                        ${[3,5].map(s => `
                                            <div style="display:flex; align-items:center; justify-content:center; gap:8px; padding:14px; background:${tw.preliminary.sets === s ? '#e3f2fd' : '#f5f5f5'}; border-radius:8px; cursor:pointer; border:2px solid ${tw.preliminary.sets === s ? '#1976d2' : 'transparent'};" onclick="window.tournamentWizard.preliminary.sets=${s};render();">
                                                <input type="radio" name="tw-prelim-sets" value="${s}" ${tw.preliminary.sets === s ? 'checked' : ''} style="pointer-events:none;">
                                                <span style="font-weight:600;">${s}ÏÑ∏Ìä∏</span>
                                                <span style="font-size:12px; color:#666;">(${Math.ceil(s/2)}ÏÑ†Ïäπ)</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Ï°∞ Ìé∏ÏÑ± Î∞©Ïãù</label>
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px;">
                                        <div style="display:flex; align-items:center; gap:8px; padding:14px; background:${tw.preliminary.groupAssignment === 'random' ? '#e3f2fd' : '#f5f5f5'}; border-radius:8px; cursor:pointer; border:2px solid ${tw.preliminary.groupAssignment === 'random' ? '#1976d2' : 'transparent'};" onclick="window.tournamentWizard.preliminary.groupAssignment='random';render();">
                                            <input type="radio" name="tw-group-assign" value="random" ${tw.preliminary.groupAssignment === 'random' ? 'checked' : ''} style="pointer-events:none;">
                                            <div>
                                                <div style="font-weight:600;">ÎûúÎç§ Î∞∞Ï†ï</div>
                                                <div style="font-size:11px; color:#666;">Î¨¥ÏûëÏúÑÎ°ú Ï°∞ Î∞∞Ï†ï</div>
                                            </div>
                                        </div>
                                        <div style="display:flex; align-items:center; gap:8px; padding:14px; background:${tw.preliminary.groupAssignment === 'manual' ? '#e3f2fd' : '#f5f5f5'}; border-radius:8px; cursor:pointer; border:2px solid ${tw.preliminary.groupAssignment === 'manual' ? '#1976d2' : 'transparent'};" onclick="window.tournamentWizard.preliminary.groupAssignment='manual';render();">
                                            <input type="radio" name="tw-group-assign" value="manual" ${tw.preliminary.groupAssignment === 'manual' ? 'checked' : ''} style="pointer-events:none;">
                                            <div>
                                                <div style="font-weight:600;">‚úã ÏßÅÏ†ë ÏûÖÎ†•</div>
                                                <div style="font-size:11px; color:#666;">ÏãúÎìú ÏàúÏÑúÎåÄÎ°ú Î∞∞Ï†ï</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div style="background:#fff3e0; padding:16px; border-radius:12px; margin-top:16px;">
                                    <div style="font-weight:600; margin-bottom:12px;">Î≥∏ÏÑ† ÏßÑÏ∂ú Í∑úÏπô</div>
                                    <div class="form-group" style="margin-bottom:12px;">
                                        <label>Í∞Å Ï°∞ ÏßÑÏ∂ú Ïù∏Ïõê</label>
                                        <select id="tw-advance-count" onchange="window.tournamentWizard.preliminary.advanceCount=parseInt(this.value);render();" style="width:100%;">
                                            ${[1,2,3,4].map(n => `<option value="${n}" ${tw.preliminary.advanceCount === n ? 'selected' : ''}>ÏÉÅÏúÑ ${n}Î™Ö</option>`).join('')}
                                        </select>
                                    </div>
                                    <div class="form-group" style="margin:0;">
                                        <label>ÏôÄÏùºÎìúÏπ¥Îìú (Ï∂îÍ∞Ä ÏßÑÏ∂ú)</label>
                                        <select id="tw-wildcards" onchange="window.tournamentWizard.preliminary.wildcards=parseInt(this.value);render();" style="width:100%;">
                                            ${[0,1,2,4].map(n => `<option value="${n}" ${tw.preliminary.wildcards === n ? 'selected' : ''}>${n}Î™Ö</option>`).join('')}
                                        </select>
                                    </div>
                                    <div style="margin-top:12px; padding:12px; background:#fffde7; border-radius:8px; font-size:14px;">
                                        Ï¥ù Î≥∏ÏÑ† ÏßÑÏ∂ú: <strong>${tw.preliminary.groupCount * tw.preliminary.advanceCount + tw.preliminary.wildcards}Î™Ö</strong>
                                    </div>
                                </div>
                            ` : `
                                <div style="background:#f5f5f5; padding:20px; border-radius:12px; text-align:center;">
                                    <div style="font-size:16px; color:#666;">ÏòàÏÑ† ÏóÜÏù¥ Î∞îÎ°ú Î≥∏ÏÑ† ÌÜ†ÎÑàÎ®ºÌä∏Î°ú ÏßÑÌñâÌï©ÎãàÎã§</div>
                                    <div style="font-size:14px; color:#999; margin-top:8px;">Ï∞∏Í∞ÄÏûê ${participantCount}Î™Ö Ï†ÑÏõê Î≥∏ÏÑ† ÏßÑÏ∂ú</div>
                                </div>
                            `}
                        `;
                    } else {
                        // ÌÖúÌîåÎ¶ø Î™®Îìú: Í∞ÑÎã®Ìïú ÏÑ§Ï†ï
                        const participantCount = tw.participants.length;
                        stepContent = `
                            <div style="background:#e3f2fd; padding:16px; border-radius:12px; margin-bottom:16px;">
                                <div style="font-weight:600;">ÏÑ†ÌÉùÌïú ÌÖúÌîåÎ¶ø: ${tw.template === 'group-only' ? 'Ï°∞Î≥Ñ Î¶¨Í∑∏' : tw.template === 'group-knockout' ? 'Ï°∞Î≥Ñ ÏòàÏÑ† + Î≥∏ÏÑ†' : 'ü•ä ÌÜ†ÎÑàÎ®ºÌä∏'}</div>
                            </div>
                            
                            ${tw.template !== 'knockout-only' ? `
                                <div class="form-group">
                                    <label>Ï°∞ Í∞úÏàò</label>
                                    <select id="tw-tpl-groups" onchange="window.tournamentWizard.preliminary.groupCount=parseInt(this.value);render();" style="width:100%;">
                                        ${[2,3,4,5,6,8].filter(n => n <= participantCount).map(n => {
                                            const perGroup = Math.ceil(participantCount / n);
                                            return `<option value="${n}" ${tw.preliminary.groupCount === n ? 'selected' : ''}>${n}Í∞ú Ï°∞ (Ï°∞Îãπ ÏïΩ ${perGroup}Î™Ö)</option>`;
                                        }).join('')}
                                    </select>
                                </div>
                            ` : ''}
                            
                            ${tw.template === 'group-knockout' ? `
                                <div class="form-group">
                                    <label>Î≥∏ÏÑ† ÏßÑÏ∂ú (Í∞Å Ï°∞)</label>
                                    <select onchange="window.tournamentWizard.preliminary.advanceCount=parseInt(this.value);render();" style="width:100%;">
                                        ${[1,2,3].map(n => `<option value="${n}" ${tw.preliminary.advanceCount === n ? 'selected' : ''}>ÏÉÅÏúÑ ${n}Î™Ö</option>`).join('')}
                                    </select>
                                </div>
                            ` : ''}
                            
                            <div class="form-group">
                                <label>ÏÑ∏Ìä∏ Ïàò</label>
                                <select onchange="window.tournamentWizard.preliminary.sets=parseInt(this.value);render();" style="width:100%;">
                                    <option value="3" ${tw.preliminary.sets === 3 ? 'selected' : ''}>3ÏÑ∏Ìä∏ (2ÏÑ†Ïäπ)</option>
                                    <option value="5" ${tw.preliminary.sets === 5 ? 'selected' : ''}>5ÏÑ∏Ìä∏ (3ÏÑ†Ïäπ)</option>
                                </select>
                            </div>
                            
                            <div style="background:#f5f5f5; padding:12px; border-radius:8px; margin-top:12px;">
                                <div style="font-size:14px;">Ï∞∏Í∞ÄÏûê: <strong>${participantCount}Î™Ö</strong></div>
                                ${tw.template === 'group-knockout' ? `<div style="font-size:14px; margin-top:4px;">Î≥∏ÏÑ† ÏßÑÏ∂ú: <strong>${tw.preliminary.groupCount * tw.preliminary.advanceCount}Î™Ö</strong></div>` : ''}
                            </div>
                        `;
                    }
                } else if (tw.step === 4) {
                    // Step 4: Î≥∏ÏÑ† ÎåÄÏßÑ ÏÑ§Ï†ï (Ïª§Ïä§ÌÖÄ) ÎòêÎäî ÏÑ∏Î∂Ä ÏÑ§Ï†ï (ÌÖúÌîåÎ¶ø)
                    const participantCount = tw.participants.length;
                    
                    if (tw.mode === 'custom') {
                        // Ïª§Ïä§ÌÖÄ Î™®Îìú: Î≥∏ÏÑ† ÎåÄÏßÑÌëú ÏßÅÏ†ë Íµ¨ÏÑ±
                        const finalsCount = tw.preliminary.enabled 
                            ? (tw.preliminary.groupCount * tw.preliminary.advanceCount + tw.preliminary.wildcards)
                            : participantCount;
                        
                        // Î≥∏ÏÑ† Í∑úÎ™® ÏòµÏÖò
                        const sizeOptions = [4,8,16,32,64].filter(s => s >= finalsCount / 2 && s <= finalsCount * 2);
                        
                        // Ï°∞ ÎùºÎ≤® ÏÉùÏÑ±
                        const groupLabels = [];
                        for (let i = 0; i < tw.preliminary.groupCount; i++) {
                            groupLabels.push(String.fromCharCode(65 + i)); // A, B, C, ...
                        }
                        
                        // Ïª§Ïä§ÌÖÄ ÎåÄÏßÑ Ï¥àÍ∏∞Ìôî
                        if (!tw.finals.customBracket || tw.finals.customBracket.length === 0) {
                            initCustomBracket();
                        }
                        
                        // ÎåÄÏßÑ Ìé∏Ïßë UI
                        const bracketEditorHTML = tw.preliminary.enabled ? tw.finals.customBracket.map((match, idx) => `
                            <div style="display:flex; align-items:center; gap:8px; padding:12px; margin:8px 0; background:#f5f5f5; border-radius:8px;">
                                <span style="font-weight:600; min-width:60px;">Í≤ΩÍ∏∞ ${idx + 1}</span>
                                <select onchange="updateCustomBracketMatch(${idx}, 'p1Group', this.value)" style="flex:1; padding:8px;">
                                    ${groupLabels.map(g => `<option value="${g}" ${match.p1Group === g ? 'selected' : ''}>${g}Ï°∞</option>`).join('')}
                                </select>
                                <select onchange="updateCustomBracketMatch(${idx}, 'p1Rank', parseInt(this.value))" style="width:60px; padding:8px;">
                                    ${[1,2,3,4].slice(0, tw.preliminary.advanceCount).map(r => `<option value="${r}" ${match.p1Rank === r ? 'selected' : ''}>${r}ÏúÑ</option>`).join('')}
                                </select>
                                <span style="font-weight:600;">vs</span>
                                <select onchange="updateCustomBracketMatch(${idx}, 'p2Group', this.value)" style="flex:1; padding:8px;">
                                    ${groupLabels.map(g => `<option value="${g}" ${match.p2Group === g ? 'selected' : ''}>${g}Ï°∞</option>`).join('')}
                                </select>
                                <select onchange="updateCustomBracketMatch(${idx}, 'p2Rank', parseInt(this.value))" style="width:60px; padding:8px;">
                                    ${[1,2,3,4].slice(0, tw.preliminary.advanceCount).map(r => `<option value="${r}" ${match.p2Rank === r ? 'selected' : ''}>${r}ÏúÑ</option>`).join('')}
                                </select>
                            </div>
                        `).join('') : `
                            <div style="background:#f5f5f5; padding:20px; border-radius:8px; text-align:center;">
                                <div style="color:#666;">ÏòàÏÑ† ÏóÜÏù¥ ÏßÑÌñâ Ïãú Î≥∏ÏÑ† ÎåÄÏßÑÏùÄ ÏûêÎèô ÎòêÎäî ÏãúÎìú Î∞∞Ï†ïÎê©ÎãàÎã§</div>
                            </div>
                        `;
                        
                        stepContent = `
                            <div style="background:#fff3e0; padding:16px; border-radius:12px; margin-bottom:16px;">
                                <div style="font-weight:600; margin-bottom:4px;">ü•ä Î≥∏ÏÑ† ÏÑ§Ï†ï</div>
                                <div style="font-size:13px; color:#666;">ÌÜ†ÎÑàÎ®ºÌä∏ ÎåÄÏßÑÏùÑ Íµ¨ÏÑ±Ìï©ÎãàÎã§</div>
                            </div>
                            
                            <div class="form-group">
                                <label>Î≥∏ÏÑ† Í∑úÎ™®</label>
                                <select id="tw-finals-size" onchange="window.tournamentWizard.finals.size=parseInt(this.value);initCustomBracket();render();" style="width:100%;">
                                    ${sizeOptions.map(s => `<option value="${s}" ${tw.finals.size === s ? 'selected' : ''}>${s}Í∞ï</option>`).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label>Î≥∏ÏÑ† ÏÑ∏Ìä∏ Ïàò</label>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px;">
                                    ${[3,5].map(s => `
                                        <div style="display:flex; align-items:center; justify-content:center; gap:8px; padding:14px; background:${tw.finals.sets === s ? '#fff3e0' : '#f5f5f5'}; border-radius:8px; cursor:pointer; border:2px solid ${tw.finals.sets === s ? '#ff9800' : 'transparent'};" onclick="window.tournamentWizard.finals.sets=${s};render();">
                                            <input type="radio" name="tw-finals-sets" value="${s}" ${tw.finals.sets === s ? 'checked' : ''} style="pointer-events:none;">
                                            <span style="font-weight:600;">${s}ÏÑ∏Ìä∏</span>
                                            <span style="font-size:12px; color:#666;">(${Math.ceil(s/2)}ÏÑ†Ïäπ)</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            
                            ${tw.preliminary.enabled ? `
                                <div class="form-group">
                                    <label>Í∞ôÏùÄ Ï°∞ ÏÑ†Ïàò ÌöåÌîº</label>
                                    <select onchange="window.tournamentWizard.finals.sameGroupAvoid=this.value;render();" style="width:100%;">
                                        <option value="none" ${tw.finals.sameGroupAvoid === 'none' ? 'selected' : ''}>ÌöåÌîº Ïïà Ìï®</option>
                                        <option value="quarterfinal" ${tw.finals.sameGroupAvoid === 'quarterfinal' ? 'selected' : ''}>8Í∞ïÍπåÏßÄ ÌöåÌîº</option>
                                        <option value="semifinal" ${tw.finals.sameGroupAvoid === 'semifinal' ? 'selected' : ''}>4Í∞ïÍπåÏßÄ ÌöåÌîº</option>
                                        <option value="all" ${tw.finals.sameGroupAvoid === 'all' ? 'selected' : ''}>Í≤∞ÏäπÍπåÏßÄ ÌöåÌîº</option>
                                    </select>
                                </div>
                                
                                <div style="margin-top:20px;">
                                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                        <label style="font-weight:600;">${tw.finals.size}Í∞ï ÎåÄÏßÑÌëú Íµ¨ÏÑ±</label>
                                        <button class="btn" onclick="autoFillBracket()" style="padding:6px 12px; font-size:13px;">ÏûêÎèô Î∞∞Ï†ï</button>
                                    </div>
                                    <div style="max-height:400px; overflow-y:auto;">
                                        ${bracketEditorHTML}
                                    </div>
                                </div>
                            ` : ''}
                        `;
                    } else {
                        // ÌÖúÌîåÎ¶ø Î™®Îìú: Í∏∞Ï°¥ ÏÑ∏Î∂Ä ÏÑ§Ï†ï
                        stepContent = `
                            <div style="background:#e8f5e9; padding:16px; border-radius:12px; margin-bottom:16px;">
                                <div style="font-weight:600;">ÏÑ§Ï†ï ÏôÑÎ£å</div>
                                <div style="font-size:13px; color:#666; margin-top:4px;">ÏïÑÎûò ÎÇ¥Ïö©ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî</div>
                            </div>
                            
                            <div style="background:#f5f5f5; padding:16px; border-radius:8px;">
                                <div style="margin-bottom:12px;"><strong>Ï∞∏Í∞ÄÏûê:</strong> ${participantCount}Î™Ö</div>
                                ${tw.template !== 'knockout-only' ? `<div style="margin-bottom:12px;"><strong>Ï°∞ Ìé∏ÏÑ±:</strong> ${tw.preliminary.groupCount}Í∞ú Ï°∞</div>` : ''}
                                ${tw.template === 'group-knockout' ? `<div style="margin-bottom:12px;"><strong>Î≥∏ÏÑ† ÏßÑÏ∂ú:</strong> Í∞Å Ï°∞ ÏÉÅÏúÑ ${tw.preliminary.advanceCount}Î™Ö (Ï¥ù ${tw.preliminary.groupCount * tw.preliminary.advanceCount}Î™Ö)</div>` : ''}
                                <div><strong>ÏÑ∏Ìä∏:</strong> ${tw.preliminary.sets}ÏÑ∏Ìä∏ (${Math.ceil(tw.preliminary.sets/2)}ÏÑ†Ïäπ)</div>
                            </div>
                        `;
                    }
                } else if (tw.step === 5) {
                    // Step 5: ÎåÄÏßÑÌëú ÌôïÏù∏
                    const previewHTML = generateTWPreview();
                    
                    stepContent = `
                        <div style="background:#e8f5e9; padding:16px; border-radius:8px; margin-bottom:16px;">
                            <h3 style="margin:0 0 8px 0;">ÎåÄÏßÑÌëú ÎØ∏Î¶¨Î≥¥Í∏∞</h3>
                            <p style="font-size:13px; margin:0;">ÏïÑÎûò ÎåÄÏßÑÌëúÎ•º ÌôïÏù∏ÌïòÍ≥† Îã§Ïùå Îã®Í≥ÑÎ°ú ÏßÑÌñâÌïòÏÑ∏Ïöî.</p>
                        </div>
                        
                        ${tw.mode === 'custom' && tw.preliminary.enabled ? `
                            <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-bottom:16px;">
                                <strong>Ïª§Ïä§ÌÖÄ ÎåÄÏßÑ ÏÑ§Ï†ï</strong>
                                <div style="font-size:13px; margin-top:4px;">
                                    ÏòàÏÑ†: ${tw.preliminary.groupCount}Í∞ú Ï°∞, ${tw.preliminary.sets}ÏÑ∏Ìä∏<br>
                                    Î≥∏ÏÑ†: ${tw.finals.size}Í∞ï, ${tw.finals.sets}ÏÑ∏Ìä∏
                                </div>
                            </div>
                        ` : ''}
                        
                        <div id="tw-preview" style="max-height:400px; overflow-y:auto;">
                            ${previewHTML}
                        </div>
                        
                        <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-top:16px;">
                            <strong>ÌôïÏù∏ ÏÇ¨Ìï≠</strong>
                            <ul style="font-size:13px; margin:8px 0 0 0; padding-left:20px;">
                                <li>Ï°∞ Ìé∏ÏÑ±Ïù¥ Ïò¨Î∞îÎ•∏ÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî</li>
                                <li>Îã§Ïùå Îã®Í≥ÑÏóêÏÑú Ïã¨ÌåêÍ≥º Í≤ΩÍ∏∞Ïû•ÏùÑ ÏÑ§Ï†ïÌï©ÎãàÎã§</li>
                                <li>ÏÑ§Ï†ï ÌõÑ ÎåÄÌöåÍ∞Ä ÏÉùÏÑ±Îê©ÎãàÎã§</li>
                            </ul>
                        </div>
                    `;
                } else if (tw.step === 6) {
                    // Step 6: Ïã¨Ìåê/Í≤ΩÍ∏∞Ïû• ÏÑ§Ï†ï
                    if (!tw.referees) tw.referees = [];
                    if (!tw.courts) tw.courts = [];
                    
                    const refereeList = tw.referees.map((ref, idx) => `
                        <div style="background:white; padding:12px; border-radius:8px; margin-bottom:8px; border-left:4px solid #2196f3; display:flex; justify-content:space-between; align-items:center;">
                            <div style="flex:1;">
                                <strong>${ref.name}</strong><br>
                                <span style="font-size:12px; color:#666;">PIN: ${ref.pin || 'ÎØ∏ÏÑ§Ï†ï'} ¬∑ Ïó≠Ìï†: ${ref.role}</span>
                            </div>
                            <button class="btn" onclick="deleteTWReferee(${idx})" style="padding:6px 12px; font-size:12px; background:#ff6b6b; color:white; border:none; border-radius:4px;">ÏÇ≠Ï†ú</button>
                        </div>
                    `).join('') || '<p style="text-align:center; color:#999; padding:12px;">Ïã¨ÌåêÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</p>';
                    
                    const courtList = tw.courts.map((court, idx) => `
                        <div style="background:white; padding:12px; border-radius:8px; margin-bottom:8px; border-left:4px solid #4caf50; display:flex; justify-content:space-between; align-items:center;">
                            <div style="flex:1;">
                                <strong>${court.name}</strong><br>
                                <span style="font-size:12px; color:#666;">Í≤ΩÍ∏∞Ïû•</span>
                            </div>
                            <button class="btn" onclick="deleteTWCourt(${idx})" style="padding:6px 12px; font-size:12px; background:#ff6b6b; color:white; border:none; border-radius:4px;">ÏÇ≠Ï†ú</button>
                        </div>
                    `).join('') || '<p style="text-align:center; color:#999; padding:12px;">Í≤ΩÍ∏∞Ïû•ÏùÑ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî</p>';
                    
                    stepContent = `
                        <div style="background:#e3f2fd; padding:16px; border-radius:8px; margin-bottom:16px;">
                            <h3 style="margin:0 0 8px 0;">Ïã¨Ìåê ÏÑ§Ï†ï</h3>
                            <p style="font-size:13px; margin:0;">Ïã¨Ìåê Ïù¥Î¶Ñ, Ïó≠Ìï†, PIN Î≤àÌò∏Î•º Îì±Î°ùÌïòÏÑ∏Ïöî</p>
                        </div>
                        
                        <div class="form-group">
                            <label>Ïã¨Ìåê Ïù¥Î¶Ñ</label>
                            <input type="text" id="tw-ref-name" placeholder="Ïòà: ÌôçÍ∏∏Îèô" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px;" autocomplete="off">
                        </div>
                        
                        <div class="form-group">
                            <label>Ïó≠Ìï†</label>
                            <select id="tw-ref-role" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px;">
                                <option value="main">Ï£ºÏã¨</option>
                                <option value="assistant">Î∂ÄÏã¨</option>
                                <option value="other">Í∏∞ÌÉÄ</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>PIN Î≤àÌò∏ (6ÏûêÎ¶¨ Ïù¥ÏÉÅ)</label>
                            <input type="text" id="tw-ref-pin" placeholder="Ïòà: 123456" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px;" autocomplete="off" maxlength="10">
                            <small style="color:#666;">Ïà´ÏûêÎßå ÏûÖÎ†• Í∞ÄÎä•Ìï©ÎãàÎã§</small>
                        </div>
                        
                        <button class="btn btn-primary" onclick="addTWReferee()" style="width:100%; margin-bottom:16px; background:#2196f3;">Ïã¨Ìåê Ï∂îÍ∞Ä</button>
                        
                        <div style="background:#f5f5f5; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <h4 style="margin:0 0 12px 0;">Îì±Î°ùÎêú Ïã¨Ìåê</h4>
                            ${refereeList}
                        </div>
                        
                        <div style="border-top:2px solid #e0e0e0; padding-top:16px;">
                            <div style="background:#e8f5e9; padding:16px; border-radius:8px; margin-bottom:16px;">
                                <h3 style="margin:0 0 8px 0;">Í≤ΩÍ∏∞Ïû• ÏÑ§Ï†ï</h3>
                                <p style="font-size:13px; margin:0;">ÏÇ¨Ïö©Ìï† Í≤ΩÍ∏∞Ïû•ÏùÑ Îì±Î°ùÌïòÏÑ∏Ïöî</p>
                            </div>
                            
                            <div class="form-group">
                                <label>Í≤ΩÍ∏∞Ïû• Ïù¥Î¶Ñ</label>
                                <input type="text" id="tw-court-name" placeholder="Ïòà: 1Î≤à ÏΩîÌä∏" style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px;" autocomplete="off">
                            </div>
                            
                            <button class="btn btn-success" onclick="addTWCourt()" style="width:100%; margin-bottom:16px;">Í≤ΩÍ∏∞Ïû• Ï∂îÍ∞Ä</button>
                            
                            <div style="background:#f5f5f5; padding:12px; border-radius:8px;">
                                <h4 style="margin:0 0 12px 0;">Îì±Î°ùÎêú Í≤ΩÍ∏∞Ïû•</h4>
                                ${courtList}
                            </div>
                        </div>
                    `;
                }
                
                // ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò Î≤ÑÌäº
                const navButtons = `
                    <div style="display:flex; gap:12px; margin-top:24px;">
                        ${tw.step > 1 ? `<button class="btn" onclick="twPrevStep()" style="flex:1;">‚Üê Ïù¥Ï†Ñ</button>` : `<button class="btn" onclick="goTo('bracket-home')" style="flex:1;">‚Üê Ï∑®ÏÜå</button>`}
                        ${tw.step < totalSteps ? 
                            `<button class="btn btn-primary" onclick="twNextStep()" style="flex:1;">Îã§Ïùå ‚Üí</button>` : 
                            `<button class="btn btn-primary" onclick="confirmTournament()" style="flex:1; background:#4caf50; font-weight:bold; padding:12px; font-size:16px;">ÎåÄÌöå ÏÉùÏÑ±!</button>`
                        }
                    </div>
                `;
                
                app.innerHTML = `
                    <div class="card">
                        <div class="header" style="margin:-20px -20px 20px -20px; padding:20px; border-radius:12px 12px 0 0; background:linear-gradient(135deg, #1976d2 0%, #0d47a1 100%);">
                            <h1 style="color:white; margin:0; font-size:20px;">ÎåÄÌöå ÎåÄÏßÑ ÏÑ§Ï†ï</h1>
                            <p style="color:rgba(255,255,255,0.9); margin:8px 0 0 0; font-size:14px;">${stepTitles[tw.step]}</p>
                        </div>
                        ${progressHTML}
                        ${stepContent}
                        ${navButtons}
                    </div>
                `;
                
                // ÏÑ§Ï†ï ÏöîÏïΩ ÏóÖÎç∞Ïù¥Ìä∏
                setTimeout(() => {
                    if (tw.step === 4) updateTWSettingsSummary();
                }, 100);
            }
            else if (screen === 'viewer-select-project') {
                // ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù ÌëúÏãú
                const projectList = projects.map((p, i) => {
                    const isTeam = p.competitionType === 'team';
                    const participantCount = isTeam ? (p.teams?.length || 0) : (p.players?.length || 0);
                    const hasGroups = p.groups?.length > 0;
                    const hasResult = p.autoTournamentResult;
                    
                    return `
                        <div style="padding:16px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; cursor:pointer; border-left:4px solid ${hasResult ? 'var(--success)' : 'var(--primary)'};" onclick="openViewerProject(${i})">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong>${p.name}</strong>
                                <span style="font-size:12px; color:var(--text-secondary);">${isTeam ? 'ÌåÄÏ†Ñ' : 'Í∞úÏù∏Ï†Ñ'}</span>
                            </div>
                            <div style="font-size:13px; color:var(--text-secondary); margin-top:4px;">
                                ${participantCount > 0 ? `${participantCount}${isTeam ? 'ÌåÄ' : 'Î™Ö'} Ï∞∏Í∞Ä` : ''}
                                ${hasGroups ? ` ¬∑ ${p.groups.length}Í∞ú Ï°∞` : ''}
                                ${hasResult ? ' ¬∑ Í≤∞Í≥º ÏûàÏùå' : ''}
                            </div>
                        </div>
                    `;
                }).join('') || '<p style="text-align:center; color:var(--text-secondary); padding:20px;">Îì±Î°ùÎêú ÎåÄÌöåÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('viewer-home')" style="margin-bottom:16px;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                        <h2>ÎåÄÌöå ÏÑ†ÌÉù</h2>
                        ${projectList}
                    </div>
                `;
            }
            else if (screen === 'viewer-results') {
                // ÏÑ†ÌÉùÎêú ÌîÑÎ°úÏ†ùÌä∏Ïùò Í≤∞Í≥º ÌëúÏãú
                if (!currentProject) {
                    goTo('viewer-select-project');
                    return;
                }
                
                const isTeam = currentProject.competitionType === 'team';
                const hasAutoResult = currentProject.autoTournamentResult;
                const hasGroups = currentProject.groups?.length > 0;
                
                const rulesHTML = '';
                
                // ÏÑ∏Ìä∏ Ïàò Ï†ïÎ≥¥
                const setsInfo = [];
                if (currentProject.preliminarySets && currentProject.tournamentType !== 'knockout-only') {
                    setsInfo.push(`ÏòàÏÑ† ${currentProject.preliminarySets}ÏÑ∏Ìä∏`);
                }
                if (currentProject.finalsSets && currentProject.tournamentType !== 'group-only') {
                    setsInfo.push(`Î≥∏ÏÑ† ${currentProject.finalsSets}ÏÑ∏Ìä∏`);
                }
                const setsDisplay = setsInfo.length > 0 ? ` ¬∑ ${setsInfo.join(', ')}` : '';
                
                let tabsHTML = '';
                let contentHTML = '';
                
                // ÌÉ≠ Î©îÎâ¥
                tabsHTML = `
                    <div style="display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap;">
                        <button class="btn viewer-tab active" onclick="switchViewerTab('overview')" id="tab-overview" aria-label="Ï†ÑÏ≤¥ ÌòÑÌô© ÌÉ≠">Ï†ÑÏ≤¥ ÌòÑÌô©</button>
                        ${hasGroups ? `<button class="btn viewer-tab" onclick="switchViewerTab('groups')" id="tab-groups" aria-label="Ï°∞Î≥Ñ ÏàúÏúÑ ÌÉ≠">Ï°∞Î≥Ñ ÏàúÏúÑ</button>` : ''}
                        <button class="btn viewer-tab" onclick="switchViewerTab('bracket')" id="tab-bracket" aria-label="ÎåÄÏßÑÌëú ÌÉ≠">ÎåÄÏßÑÌëú</button>
                        <button class="btn viewer-tab" onclick="switchViewerTab('records')" id="tab-records" aria-label="Í∞úÏù∏ Í∏∞Î°ù ÌÉ≠">üë§ Í∞úÏù∏ Í∏∞Î°ù</button>
                    </div>
                `;
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('viewer-select-project')" style="margin-bottom:16px;" aria-label="ÎåÄÌöå Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞">‚Üê ÎåÄÌöå Î™©Î°ù</button>
                        <h2>${currentProject.name}</h2>
                        <p style="color:var(--text-secondary); margin-bottom:16px;">${isTeam ? 'ÌåÄÏ†Ñ' : 'Í∞úÏù∏Ï†Ñ'} ¬∑ ${currentProject.date || ''}${setsDisplay}</p>
                        
                        ${rulesHTML}
                        ${tabsHTML}
                        
                        <div id="viewer-content">
                            ${renderViewerOverview()}
                        </div>
                    </div>
                    
                    <style>
                        .viewer-tab { background: var(--bg-secondary); }
                        .viewer-tab.active { background: var(--primary); color: white; }
                    </style>
                `;
            }
            // ========== ÎûúÎç§ ÌåÄ Î¶¨Í∑∏Ï†Ñ ÌôîÎ©¥ ==========
            else if (screen === 'random-team-league') {
                const rtl = window.randomTeamLeague || { participants: [], teams: [], matches: [], phase: 'input' };
                window.randomTeamLeague = rtl;
                
                let content = '';
                
                if (rtl.phase === 'input') {
                    // Ï∞∏Í∞ÄÏûê ÏûÖÎ†• Îã®Í≥Ñ
                    const participantList = rtl.participants.map((p, i) => `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:${p.gender === 'M' ? '#e3f2fd' : '#fce4ec'}; border-radius:4px; margin:4px 0;">
                            <span>${p.gender === 'M' ? 'üë®' : 'üë©'} ${p.name}</span>
                            <button class="btn btn-danger" onclick="removeRTLParticipant(${i})" style="padding:4px 8px; min-width:auto;" aria-label="${p.name} ÏÇ≠Ï†ú">‚úï</button>
                        </div>
                    `).join('') || '<p style="color:var(--text-secondary); text-align:center; padding:20px;">Ï∞∏Í∞ÄÏûêÎ•º Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî</p>';
                    
                    const maleCount = rtl.participants.filter(p => p.gender === 'M').length;
                    const femaleCount = rtl.participants.filter(p => p.gender === 'F').length;
                    
                    content = `
                        <div class="card">
                            <button class="btn" onclick="goTo('referee-home')" style="margin-bottom:16px;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                            <h2>ÎûúÎç§ ÌåÄ Î¶¨Í∑∏Ï†Ñ</h2>
                            
                            <!-- ÏûêÎèô ÏãúÎÆ¨Î†àÏù¥ÏÖò ÏòµÏÖò -->
                            <div style="background:linear-gradient(135deg, #667eea22 0%, #764ba222 100%); padding:16px; border-radius:8px; margin-bottom:16px; border:2px dashed #667eea;">
                                <strong style="display:block; margin-bottom:8px;">ÏûêÎèô ÏãúÎÆ¨Î†àÏù¥ÏÖò</strong>
                                <p style="font-size:12px; color:#666; margin-bottom:12px;">Ï∞∏Í∞ÄÏûêÎ•º ÏûêÎèô ÏÉùÏÑ±ÌïòÏó¨ Îπ†Î•¥Í≤å ÌÖåÏä§Ìä∏Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                                <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:8px; align-items:end;">
                                    <div>
                                        <label for="rtl-auto-count" style="font-size:12px;">Ï¥ù Ïù∏Ïõê</label>
                                        <select id="rtl-auto-count" style="width:100%;" aria-label="ÏûêÎèô ÏÉùÏÑ± Ïù∏Ïõê Ïàò">
                                            <option value="6">6Î™Ö</option>
                                            <option value="8">8Î™Ö</option>
                                            <option value="10">10Î™Ö</option>
                                            <option value="12" selected>12Î™Ö</option>
                                            <option value="16">16Î™Ö</option>
                                            <option value="20">20Î™Ö</option>
                                            <option value="24">24Î™Ö</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="rtl-auto-ratio" style="font-size:12px;">ÏÑ±ÎπÑ</label>
                                        <select id="rtl-auto-ratio" style="width:100%;" aria-label="ÎÇ®ÎÖÄ ÏÑ±ÎπÑ ÏÑ†ÌÉù">
                                            <option value="equal">Í∑†Îì± (1:1)</option>
                                            <option value="male">ÎÇ®ÏÑ± ÎßéÏùå (2:1)</option>
                                            <option value="female">Ïó¨ÏÑ± ÎßéÏùå (1:2)</option>
                                        </select>
                                    </div>
                                    <button class="btn" onclick="generateRTLAutoParticipants()" style="background:#667eea; color:white;" aria-label="Ï∞∏Í∞ÄÏûê ÏûêÎèô ÏÉùÏÑ±">
                                        ÏûêÎèô ÏÉùÏÑ±
                                    </button>
                                </div>
                            </div>
                            
                            <div style="background:#e8f5e9; padding:12px; border-radius:8px; margin-bottom:16px;">
                                <strong>1Îã®Í≥Ñ: Ï∞∏Í∞ÄÏûê ÏûÖÎ†•</strong>
                                <p style="font-size:13px; margin-top:4px;">Ï∞∏Í∞ÄÏûê Ïù¥Î¶ÑÍ≥º ÏÑ±Î≥ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</p>
                            </div>
                            
                            <div style="display:grid; grid-template-columns:1fr auto auto; gap:8px; margin-bottom:16px;">
                                <input type="text" id="rtl-name" dir="ltr" lang="ko" placeholder="Ïù¥Î¶Ñ" style="width:100%; direction:ltr !important; text-align:left !important;" autocomplete="off" spellcheck="false" aria-label="Ï∞∏Í∞ÄÏûê Ïù¥Î¶Ñ ÏûÖÎ†•">
                                <select id="rtl-gender" style="width:80px;" aria-label="ÏÑ±Î≥Ñ ÏÑ†ÌÉù">
                                    <option value="M">ÎÇ®</option>
                                    <option value="F">Ïó¨</option>
                                </select>
                                <button class="btn btn-primary" onclick="addRTLParticipant()" style="min-width:60px;" aria-label="Ï∞∏Í∞ÄÏûê Ï∂îÍ∞Ä">Ï∂îÍ∞Ä</button>
                            </div>
                            
                            <div style="background:#f5f5f5; padding:12px; border-radius:8px; margin-bottom:12px;" aria-live="polite">
                                <div style="font-size:18px; font-weight:bold; margin-bottom:8px;">
                                    Ï¥ù ${rtl.participants.length}Î™Ö
                                </div>
                                <div style="display:flex; gap:12px;">
                                    <span style="background:#e3f2fd; padding:4px 12px; border-radius:12px; font-size:14px;">üë® ÎÇ® ${maleCount}Î™Ö</span>
                                    <span style="background:#fce4ec; padding:4px 12px; border-radius:12px; font-size:14px;">üë© Ïó¨ ${femaleCount}Î™Ö</span>
                                </div>
                            </div>
                            
                            <div style="max-height:250px; overflow-y:auto; margin-bottom:16px;">
                                ${participantList}
                            </div>
                            
                            ${rtl.participants.length >= 6 ? `
                                <button class="btn btn-primary" onclick="goToRTLTeamSetup()" style="width:100%;" aria-label="ÌåÄ ÏÑ§Ï†ï Îã®Í≥ÑÎ°ú Ïù¥Îèô">
                                    Îã§Ïùå: ÌåÄ ÏÑ§Ï†ï ‚Üí
                                </button>
                            ` : `
                                <p style="color:var(--text-secondary); text-align:center; font-size:13px;">
                                    ÏµúÏÜå 6Î™Ö Ïù¥ÏÉÅ ÌïÑÏöîÌï©ÎãàÎã§ (ÌòÑÏû¨ ${rtl.participants.length}Î™Ö)
                                </p>
                            `}
                        </div>
                    `;
                } else if (rtl.phase === 'team-setup') {
                    // ÌåÄ ÏÑ§Ï†ï Îã®Í≥Ñ
                    const totalCount = rtl.participants.length;
                    const maleCount = rtl.participants.filter(p => p.gender === 'M').length;
                    const femaleCount = rtl.participants.filter(p => p.gender === 'F').length;
                    
                    // Í∞ÄÎä•Ìïú ÌåÄ Í∞úÏàò Í≥ÑÏÇ∞ (2~5Î™Ö Í∏∞Ï§Ä)
                    const minTeams = Math.ceil(totalCount / 5);
                    const maxTeams = Math.floor(totalCount / 2);
                    
                    let teamOptions = '';
                    for (let t = Math.max(2, minTeams); t <= maxTeams; t++) {
                        const perTeam = Math.floor(totalCount / t);
                        const remainder = totalCount % t;
                        const desc = remainder > 0 ? `${perTeam}~${perTeam+1}Î™ÖÏî©` : `${perTeam}Î™ÖÏî©`;
                        teamOptions += `<option value="${t}">${t}ÌåÄ (${desc})</option>`;
                    }
                    
                    // Ï†ÄÏû•Îêú ÏÑ§Ï†ïÍ∞í Î∂àÎü¨Ïò§Í∏∞
                    const savedTeamCount = rtl.teamCount || Math.max(2, minTeams);
                    const savedMembersPerTeam = rtl.membersPerTeam || 3;
                    const savedTopseeds = rtl.topseeds || [];
                    const savedTournamentType = rtl.tournamentType || 'full-league';
                    
                    content = `
                        <div class="card">
                            <button class="btn" onclick="window.randomTeamLeague.phase='input'; render();" style="margin-bottom:16px;" aria-label="Ï∞∏Í∞ÄÏûê ÏûÖÎ†• Îã®Í≥ÑÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞">‚Üê Ï∞∏Í∞ÄÏûê ÏàòÏ†ï</button>
                            <h2>ÌåÄ ÏÑ§Ï†ï</h2>
                            
                            <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-bottom:16px;">
                                <strong>2Îã®Í≥Ñ: ÌåÄ Íµ¨ÏÑ± ÏÑ§Ï†ï</strong>
                                <p style="font-size:13px; margin-top:4px;">Ï∞∏Í∞ÄÏûê ${totalCount}Î™Ö (üë®${maleCount} üë©${femaleCount})</p>
                            </div>
                            
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:16px;">
                                <div>
                                    <label for="rtl-team-count">ÌåÄ Í∞úÏàò</label>
                                    <select id="rtl-team-count" onchange="updateRTLTopseedInputs()" style="width:100%;" aria-label="ÌåÄ Í∞úÏàò ÏÑ†ÌÉù">
                                        ${teamOptions}
                                    </select>
                                </div>
                                <div>
                                    <label for="rtl-members-per-team">ÌåÄÎãπ Ïù∏Ïõê</label>
                                    <select id="rtl-members-per-team" style="width:100%;" aria-label="ÌåÄÎãπ Ïù∏Ïõê Ïàò ÏÑ†ÌÉù">
                                        <option value="2">2Î™Ö</option>
                                        <option value="3" selected>3Î™Ö</option>
                                        <option value="4">4Î™Ö</option>
                                        <option value="5">5Î™Ö</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- ÎåÄÌöå Î∞©Ïãù ÏÑ†ÌÉù -->
                            <div style="background:#e3f2fd; padding:16px; border-radius:8px; margin-bottom:16px;">
                                <strong style="display:block; margin-bottom:12px;">ÎåÄÌöå Î∞©Ïãù</strong>
                                
                                <label style="display:flex; align-items:flex-start; gap:10px; padding:10px; background:white; border-radius:6px; margin-bottom:8px; cursor:pointer; border:2px solid transparent;" 
                                       onclick="selectRTLTournamentType('full-league')" id="rtl-type-full-league-label">
                                    <input type="radio" name="rtl-tournament-type" value="full-league" id="rtl-type-full-league" 
                                           ${savedTournamentType === 'full-league' ? 'checked' : ''} 
                                           onchange="updateRTLTournamentOptions()" style="margin-top:3px;">
                                    <div>
                                        <strong>ÌíÄÎ¶¨Í∑∏</strong>
                                        <p style="font-size:12px; color:#666; margin-top:2px;">Î™®Îì† ÌåÄÏù¥ ÏÑúÎ°ú Ìïú Î≤àÏî© ÎåÄÏ†Ñ ‚Üí ÏµúÏ¢Ö ÏàúÏúÑ Í≤∞Ï†ï</p>
                                    </div>
                                </label>
                                
                                <label style="display:flex; align-items:flex-start; gap:10px; padding:10px; background:white; border-radius:6px; cursor:pointer; border:2px solid transparent;"
                                       onclick="selectRTLTournamentType('group-tournament')" id="rtl-type-group-tournament-label">
                                    <input type="radio" name="rtl-tournament-type" value="group-tournament" id="rtl-type-group-tournament"
                                           ${savedTournamentType === 'group-tournament' ? 'checked' : ''}
                                           onchange="updateRTLTournamentOptions()" style="margin-top:3px;">
                                    <div>
                                        <strong>Ï°∞Î≥Ñ Î¶¨Í∑∏ + ÌÜ†ÎÑàÎ®ºÌä∏</strong>
                                        <p style="font-size:12px; color:#666; margin-top:2px;">Ï°∞Î≥Ñ ÏòàÏÑ† Î¶¨Í∑∏ ‚Üí ÏÉÅÏúÑÌåÄ Í≤∞ÏÑ† ÌÜ†ÎÑàÎ®ºÌä∏</p>
                                    </div>
                                </label>
                                
                                <!-- Ï°∞Î≥Ñ+ÌÜ†ÎÑàÎ®ºÌä∏ ÏòµÏÖò -->
                                <div id="rtl-group-tournament-options" style="display:${savedTournamentType === 'group-tournament' ? 'block' : 'none'}; margin-top:12px; padding:12px; background:#f5f5f5; border-radius:6px;">
                                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                        <div>
                                            <label for="rtl-group-count" style="font-size:13px;">Ï°∞ Í∞úÏàò</label>
                                            <select id="rtl-group-count" onchange="updateRTLGroupPreview()" style="width:100%;" aria-label="Ï°∞ Í∞úÏàò ÏÑ†ÌÉù">
                                                <option value="2">2Í∞ú Ï°∞</option>
                                                <option value="3">3Í∞ú Ï°∞</option>
                                                <option value="4">4Í∞ú Ï°∞</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="rtl-advance-count" style="font-size:13px;">Ï°∞Î≥Ñ ÏßÑÏ∂úÏûê</label>
                                            <select id="rtl-advance-count" onchange="updateRTLGroupPreview()" style="width:100%;" aria-label="Ï°∞Î≥Ñ ÏßÑÏ∂ú ÌåÄ Ïàò ÏÑ†ÌÉù">
                                                <option value="1">1ÌåÄÏî©</option>
                                                <option value="2" selected>2ÌåÄÏî©</option>
                                                <option value="3">3ÌåÄÏî©</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="rtl-group-preview" style="margin-top:10px; font-size:12px; color:#666;" aria-live="polite"></div>
                                </div>
                            </div>
                            
                            <div style="background:#e8f5e9; padding:12px; border-radius:8px; margin-bottom:16px;">
                                <strong>Í∞Å ÌåÄ ÌÉëÏãúÎìú ÏÑ†ÌÉù</strong>
                                <p style="font-size:12px; margin-top:4px; color:#666;">ÌÉëÏãúÎìúÎäî Í∞Å ÌåÄÏóê Í≥†Ï†ï Î∞∞ÏπòÎêòÍ≥†, ÎÇòÎ®∏ÏßÄ Ïù∏ÏõêÎßå ÎûúÎç§ Î∞∞Ï†ïÎê©ÎãàÎã§.</p>
                            </div>
                            
                            <div id="rtl-topseed-container">
                                <!-- ÌÉëÏãúÎìú ÏÑ†ÌÉù UIÍ∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†Å ÏÉùÏÑ± -->
                            </div>
                            
                            <label for="rtl-balance-gender" style="display:flex; align-items:center; gap:8px; margin:16px 0;">
                                <input type="checkbox" id="rtl-balance-gender" checked aria-label="ÏÑ±Î≥Ñ Í∑†Ìòï ÎßûÏ∂îÍ∏∞ ÏòµÏÖò">
                                ÏÑ±Î≥Ñ Í∑†Ìòï ÎßûÏ∂îÍ∏∞ (Í∞ÄÎä•Ìïú Í≤ΩÏö∞)
                            </label>
                            
                            <div id="rtl-validation-msg" style="margin-bottom:12px;" aria-live="assertive"></div>
                            
                            <button class="btn btn-primary" onclick="generateRandomTeamsWithTopseeds()" style="width:100%;" aria-label="ÎûúÎç§ÏúºÎ°ú ÌåÄ ÏÉùÏÑ±">
                                ÎûúÎç§ ÌåÄ ÏÉùÏÑ±
                            </button>
                        </div>
                    `;
                    
                    // Î†åÎçî ÌõÑ ÌÉëÏãúÎìú ÏûÖÎ†• UI ÏÉùÏÑ±
                    setTimeout(() => {
                        updateRTLTopseedInputs();
                        updateRTLTournamentOptions();
                        updateRTLGroupPreview();
                    }, 0);
                } else if (rtl.phase === 'teams-generated') {
                    // Ìé∏Ïßë Î™®Îìú Ï≤¥ÌÅ¨
                    if (rtl.editPhase === 'group-edit') {
                        // Ï°∞ Ìé∏ÏÑ± ÏàòÏ†ï ÌôîÎ©¥
                        const groupCount = rtl.groupCount || 2;
                        
                        // Ï°∞ Î∞∞Ï†ï Ï¥àÍ∏∞Ìôî
                        if (!rtl.groupAssignments) {
                            rtl.groupAssignments = [];
                            rtl.teams.forEach((t, idx) => {
                                const round = Math.floor(idx / groupCount);
                                const groupIdx = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                                rtl.groupAssignments[idx] = groupIdx;
                            });
                        }
                        
                        // Ï°∞Î≥Ñ ÌåÄ Î™©Î°ù ÏÉùÏÑ±
                        let groupsHTML = '';
                        for (let g = 0; g < groupCount; g++) {
                            const groupTeams = rtl.teams
                                .map((t, idx) => ({ ...t, originalIdx: idx }))
                                .filter((t, idx) => rtl.groupAssignments[t.originalIdx] === g);
                            
                            groupsHTML += `
                                <div style="background:#f5f5f5; padding:12px; border-radius:8px; margin-bottom:12px;">
                                    <h4 style="margin:0 0 8px 0; color:#1976d2;">${String.fromCharCode(65 + g)}Ï°∞ (${groupTeams.length}ÌåÄ)</h4>
                                    ${groupTeams.map(t => `
                                        <div style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:white; border-radius:6px; margin:4px 0;">
                                            <span>${t.name}</span>
                                            <select onchange="moveRTLTeamToGroup(${t.originalIdx}, parseInt(this.value))" style="padding:4px 8px;">
                                                ${Array(groupCount).fill(0).map((_, gi) => 
                                                    `<option value="${gi}" ${gi === g ? 'selected' : ''}>${String.fromCharCode(65 + gi)}Ï°∞</option>`
                                                ).join('')}
                                            </select>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                        
                        content = `
                            <div class="card">
                                <button class="btn" onclick="window.randomTeamLeague.editPhase=null; render();" style="margin-bottom:16px;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                                <h2>‚úèÔ∏è Ï°∞ Ìé∏ÏÑ± ÏàòÏ†ï</h2>
                                <p style="font-size:13px; color:#666; margin-bottom:16px;">Í∞Å ÌåÄÏùÑ ÏõêÌïòÎäî Ï°∞Î°ú Ïù¥ÎèôÌïòÏÑ∏Ïöî</p>
                                ${groupsHTML}
                                <button class="btn btn-primary" onclick="window.randomTeamLeague.editPhase=null; render();" style="width:100%;">‚úì ÏàòÏ†ï ÏôÑÎ£å</button>
                            </div>
                        `;
                    } else if (rtl.editPhase === 'match-order') {
                        // ÎåÄÏßÑÌëú Î≥¥Í∏∞/ÏàòÏ†ï ÌôîÎ©¥
                        if (!rtl.matchOrder) {
                            rtl.matchOrder = [];
                            let matchNum = 0;
                            for (let i = 0; i < rtl.teams.length; i++) {
                                for (let j = i + 1; j < rtl.teams.length; j++) {
                                    rtl.matchOrder.push({ team1: i, team2: j, order: matchNum++ });
                                }
                            }
                        }
                        
                        const matchesHTML = rtl.matchOrder.map((m, idx) => `
                            <div style="display:flex; align-items:center; gap:8px; padding:10px; background:#f5f5f5; border-radius:6px; margin:4px 0;">
                                <span style="min-width:30px; font-weight:600; color:#666;">${idx + 1}</span>
                                <span style="flex:1;">${rtl.teams[m.team1]?.name || 'ÌåÄ1'} vs ${rtl.teams[m.team2]?.name || 'ÌåÄ2'}</span>
                                <div style="display:flex; gap:4px;">
                                    ${idx > 0 ? `<button class="btn" onclick="moveRTLMatch(${idx}, -1)" style="padding:4px 8px; min-width:auto;">‚Üë</button>` : ''}
                                    ${idx < rtl.matchOrder.length - 1 ? `<button class="btn" onclick="moveRTLMatch(${idx}, 1)" style="padding:4px 8px; min-width:auto;">‚Üì</button>` : ''}
                                </div>
                            </div>
                        `).join('');
                        
                        content = `
                            <div class="card">
                                <button class="btn" onclick="window.randomTeamLeague.editPhase=null; render();" style="margin-bottom:16px;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                                <h2>ÎåÄÏßÑÌëú</h2>
                                <p style="font-size:13px; color:#666; margin-bottom:16px;">Í≤ΩÍ∏∞ ÏàúÏÑúÎ•º Î≥ÄÍ≤ΩÌïòÎ†§Î©¥ ‚Üë‚Üì Î≤ÑÌäºÏùÑ ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî</p>
                                <div style="max-height:400px; overflow-y:auto;">
                                    ${matchesHTML}
                                </div>
                                <button class="btn btn-primary" onclick="window.randomTeamLeague.editPhase=null; render();" style="width:100%; margin-top:16px;">‚úì ÏàòÏ†ï ÏôÑÎ£å</button>
                            </div>
                        `;
                    } else {
                    // ÌåÄ ÏÉùÏÑ± ÏôÑÎ£å - ÌåÄ Ïù¥Î¶Ñ ÏûÖÎ†• Í∞ÄÎä•
                    const tournamentType = rtl.tournamentType || 'full-league';
                    const isGroupTournament = tournamentType === 'group-tournament';
                    const groupCount = rtl.groupCount || 2;
                    const advanceCount = rtl.advanceCount || 2;
                    const rtlSets = rtl.sets || 3;
                    
                    // Ï°∞Î≥Ñ+ÌÜ†ÎÑàÎ®ºÌä∏Ïù∏ Í≤ΩÏö∞ Ï°∞ Ìé∏ÏÑ± ÎØ∏Î¶¨Î≥¥Í∏∞
                    let groupAssignmentHTML = '';
                    if (isGroupTournament) {
                        const teamsPerGroup = Math.floor(rtl.teams.length / groupCount);
                        const remainder = rtl.teams.length % groupCount;
                        
                        groupAssignmentHTML = '<div style="background:#e3f2fd; padding:12px; border-radius:8px; margin-bottom:16px;">';
                        groupAssignmentHTML += `<div style="display:flex; justify-content:space-between; align-items:center;">`;
                        groupAssignmentHTML += `<strong>Ï°∞Î≥Ñ Î¶¨Í∑∏ + ÌÜ†ÎÑàÎ®ºÌä∏</strong>`;
                        groupAssignmentHTML += `<button class="btn" onclick="goToRTLGroupEdit()" style="padding:4px 12px; font-size:12px;">‚úèÔ∏è Ï°∞ Ìé∏ÏÑ± ÏàòÏ†ï</button>`;
                        groupAssignmentHTML += `</div>`;
                        groupAssignmentHTML += `<div style="font-size:12px; margin-top:8px; color:#666;">`;
                        
                        for (let g = 0; g < groupCount; g++) {
                            const teamNames = [];
                            rtl.teams.forEach((t, idx) => {
                                const round = Math.floor(idx / groupCount);
                                const groupIdx = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                                if (groupIdx === g) {
                                    teamNames.push(t.name.match(/^\d+Ï°∞$/) ? `ÌåÄ${idx+1}` : t.name);
                                }
                            });
                            groupAssignmentHTML += `<strong>${String.fromCharCode(65 + g)}Ï°∞:</strong> ${teamNames.join(', ')}<br>`;
                        }
                        
                        groupAssignmentHTML += `</div>`;
                        groupAssignmentHTML += `<p style="font-size:12px; margin-top:6px; color:#1976d2;">Í∞Å Ï°∞ ÏÉÅÏúÑ ${advanceCount}ÌåÄ ‚Üí Í≤∞ÏÑ† ÌÜ†ÎÑàÎ®ºÌä∏</p>`;
                        groupAssignmentHTML += '</div>';
                    } else {
                        const totalMatches = rtl.teams.length * (rtl.teams.length - 1) / 2;
                        groupAssignmentHTML = `<div style="background:#e8f5e9; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <strong>ÌíÄÎ¶¨Í∑∏</strong>
                                <button class="btn" onclick="goToRTLMatchOrder()" style="padding:4px 12px; font-size:12px;">ÎåÄÏßÑÌëú Î≥¥Í∏∞</button>
                            </div>
                            <p style="font-size:12px; margin-top:4px; color:#666;">
                                Î™®Îì† ÌåÄÏù¥ ÏÑúÎ°ú Ìïú Î≤àÏî© ÎåÄÏ†Ñ ‚Üí Ï¥ù ${totalMatches}Í≤ΩÍ∏∞
                            </p>
                        </div>`;
                    }
                    
                    const teamsHTML = rtl.teams.map((team, ti) => `
                        <div style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid hsl(${ti * 60}, 70%, 50%);">
                            <input type="text" id="team-name-${ti}" value="${team.name}" dir="ltr" lang="ko"
                                   onchange="updateRTLTeamName(${ti}, this.value)"
                                   style="font-weight:bold; font-size:16px; border:2px dashed #ccc; padding:6px 10px; border-radius:6px; width:calc(100% - 24px);"
                                   placeholder="ÌåÄ Ïù¥Î¶Ñ ÏûÖÎ†•" autocomplete="off" spellcheck="false">
                            <div style="margin-top:8px;">
                                ${team.members.map((m, mi) => {
                                    const isTopseed = team.topseed === m.name;
                                    const bgColor = m.gender === 'M' ? '#e3f2fd' : '#fce4ec';
                                    const border = isTopseed ? '2px solid #ffc107' : 'none';
                                    return `
                                        <span style="display:inline-block; padding:2px 8px; margin:2px; background:${bgColor}; border-radius:12px; font-size:13px; border:${border};">
                                            ${isTopseed ? 'üèÜ' : ''} ${m.gender === 'M' ? 'üë®' : 'üë©'} ${m.name}
                                        </span>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('');
                    
                    content = `
                        <div class="card">
                            <button class="btn" onclick="window.randomTeamLeague.phase='team-setup'; render();" style="margin-bottom:16px;" aria-label="ÌåÄ ÏÑ§Ï†ï Îã®Í≥ÑÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞">‚Üê Îã§Ïãú ÏÑ§Ï†ï</button>
                            <h2>ÌåÄ Ìé∏ÏÑ± Í≤∞Í≥º</h2>
                            
                            <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-bottom:16px;">
                                <strong>3Îã®Í≥Ñ: ÎåÄÏßÑ ÏÑ§Ï†ï</strong>
                                <p style="font-size:13px; margin-top:4px;">ÌåÄ Ïù¥Î¶ÑÏùÑ Ï†ïÌïòÍ≥† Í≤ΩÍ∏∞ Í∑úÏπôÏùÑ ÏÑ§Ï†ïÌïòÏÑ∏Ïöî (= ÌÉëÏãúÎìú)</p>
                            </div>
                            
                            <!-- ÏÑ∏Ìä∏ Ïàò ÏÑ§Ï†ï -->
                            <div style="background:#f5f5f5; padding:12px; border-radius:8px; margin-bottom:16px;">
                                <strong style="display:block; margin-bottom:8px;">üèÖ Í≤ΩÍ∏∞ Í∑úÏπô</strong>
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                    <div>
                                        <label style="font-size:13px;">ÏÑ∏Ìä∏ Ïàò</label>
                                        <select id="rtl-match-sets" onchange="window.randomTeamLeague.sets=parseInt(this.value);" style="width:100%;">
                                            <option value="1" ${rtlSets===1?'selected':''}>1ÏÑ∏Ìä∏ (Îã®Ìåê)</option>
                                            <option value="2" ${rtlSets===2?'selected':''}>2ÏÑ∏Ìä∏</option>
                                            <option value="3" ${rtlSets===3?'selected':''}>3ÏÑ∏Ìä∏ (2ÏÑ†Ïäπ)</option>
                                            <option value="4" ${rtlSets===4?'selected':''}>4ÏÑ∏Ìä∏</option>
                                            <option value="5" ${rtlSets===5?'selected':''}>5ÏÑ∏Ìä∏ (3ÏÑ†Ïäπ)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size:13px;">Í≤ΩÍ∏∞ Ïú†Ìòï</label>
                                        <select id="rtl-match-type" onchange="window.randomTeamLeague.matchType=this.value;" style="width:100%;">
                                            <option value="team" ${(rtl.matchType||'team')==='team'?'selected':''}>ÌåÄÏ†Ñ (31Ï†ê)</option>
                                            <option value="individual" ${rtl.matchType==='individual'?'selected':''}>Í∞úÏù∏Ï†Ñ (11Ï†ê)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            ${groupAssignmentHTML}
                            
                            ${teamsHTML}
                            
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:16px;">
                                <button class="btn" onclick="generateRandomTeamsWithTopseeds()">Îã§Ïãú ÏÑûÍ∏∞</button>
                                <button class="btn btn-primary" onclick="startRTLLeague()">${isGroupTournament ? 'ÎåÄÌöå ÏãúÏûë ‚Üí' : 'Î¶¨Í∑∏Ï†Ñ ÏãúÏûë ‚Üí'}</button>
                            </div>
                        </div>
                    `;
                    } // else Î∏îÎ°ù (ÏùºÎ∞ò teams-generated) Îã´Í∏∞
                }
                
                app.innerHTML = content;
            }
            else if (screen === 'create-project') {
                app.innerHTML = `
                    <div class="card">
                        <h2>ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±</h2>
                        <label for="project-name">ÌîÑÎ°úÏ†ùÌä∏Î™Ö *</label>
                        <input type="text" id="project-name" placeholder="Ïòà: 2025 Ï†ÑÍµ≠Ïû•Ïï†Ïù∏Ï≤¥Ïú°ÎåÄÌöå" style="text-align:left;" autocomplete="off" aria-label="ÌîÑÎ°úÏ†ùÌä∏Î™Ö ÏûÖÎ†•">
                        
                        <label for="competition-type">Í≤ΩÍ∏∞ Ï¢ÖÎ•ò *</label>
                        <select id="competition-type" onchange="onCompetitionTypeChange()" aria-label="Í≤ΩÍ∏∞ Ï¢ÖÎ•ò ÏÑ†ÌÉù">
                            <option value="individual">Í∞úÏù∏Ï†Ñ</option>
                            <option value="team">ÌåÄÏ†Ñ</option>
                        </select>
                        
                        <label style="margin-top:16px; margin-bottom:8px; display:block;">ÎåÄÌöå Ïú†Ìòï *</label>
                        <div id="tournament-type-cards" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <button type="button" class="tournament-type-btn active" data-type="free" onclick="selectTournamentType('free')" style="padding:16px; border:2px solid var(--primary); border-radius:8px; background:white; cursor:pointer;">
                                <div style="font-weight:bold; font-size:16px;">ÏûêÏú† Í≤ΩÍ∏∞</div>
                                <div style="font-size:12px; color:#666; margin-top:4px;">ÎåÄÏßÑ ÏóÜÏù¥ Í≤ΩÍ∏∞Îßå Í∏∞Î°ù</div>
                            </button>
                            <button type="button" class="tournament-type-btn" data-type="group" onclick="selectTournamentType('group')" style="padding:16px; border:2px solid #ddd; border-radius:8px; background:white; cursor:pointer;">
                                <div style="font-weight:bold; font-size:16px;">Ï°∞Î≥Ñ Î¶¨Í∑∏</div>
                                <div style="font-size:12px; color:#666; margin-top:4px;">Î™®Îì† ÌåÄÏù¥ Ìïú Î≤àÏî© ÎåÄÍ≤∞</div>
                            </button>
                            <button type="button" class="tournament-type-btn" data-type="tournament" onclick="selectTournamentType('tournament')" style="padding:16px; border:2px solid #ddd; border-radius:8px; background:white; cursor:pointer;">
                                <div style="font-weight:bold; font-size:16px;">ü•ä ÌÜ†ÎÑàÎ®ºÌä∏</div>
                                <div style="font-size:12px; color:#666; margin-top:4px;">ÏßÄÎ©¥ ÌÉàÎùΩÌïòÎäî ÎÖπÏïÑÏõÉ</div>
                            </button>
                            <button type="button" class="tournament-type-btn" data-type="group-tournament" onclick="selectTournamentType('group-tournament')" style="padding:16px; border:2px solid #ddd; border-radius:8px; background:white; cursor:pointer;">
                                <div style="font-weight:bold; font-size:16px;">Ï°∞Î≥Ñ+ÌÜ†ÎÑàÎ®ºÌä∏</div>
                                <div style="font-size:12px; color:#666; margin-top:4px;">Ï°∞Î≥Ñ ÏòàÏÑ† ‚Üí Í≤∞ÏÑ† ÌÜ†ÎÑàÎ®ºÌä∏</div>
                            </button>
                        </div>
                        <input type="hidden" id="tournament-type" value="free">
                        
                        <div id="group-settings" style="display:none; margin-top:16px; padding:16px; background:var(--bg-secondary); border-radius:8px;">
                            <h3 style="margin-bottom:12px;">Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏÑ§Ï†ï</h3>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                <div>
                                    <label for="group-count">Ï°∞ Í∞úÏàò</label>
                                    <input type="number" id="group-count" value="4" min="1" max="99" style="width:100%;" aria-label="Ï°∞ Í∞úÏàò ÏûÖÎ†•">
                                </div>
                                <div>
                                    <label for="advance-count">Ï°∞Î≥Ñ ÏßÑÏ∂úÏûê Ïàò</label>
                                    <input type="number" id="advance-count" value="2" min="1" max="10" style="width:100%;" aria-label="Ï°∞Î≥Ñ ÏßÑÏ∂úÏûê Ïàò ÏûÖÎ†•">
                                </div>
                            </div>
                            <p style="font-size:12px; color:var(--text-secondary); margin-top:8px;">
                                ‚Äª IBSA: Ï°∞Î≥Ñ Ïù∏ÏõêÏù¥ Îã§Î•º Ïàò ÏûàÏúºÎ©∞, ÏäπÎ•†Î°ú ÏàúÏúÑ Í≤∞Ï†ï
                            </p>
                        </div>
                        
                        <div id="tournament-settings" style="display:none; margin-top:16px; padding:16px; background:var(--bg-secondary); border-radius:8px;">
                            <h3 style="margin-bottom:12px;">ÌÜ†ÎÑàÎ®ºÌä∏ ÏÑ§Ï†ï</h3>
                            <label for="tournament-size">Ï∞∏Í∞Ä <span id="tournament-unit">Ïù∏Ïõê</span></label>
                            <input type="number" id="tournament-size" value="8" min="2" max="999" style="width:100%;" aria-label="ÌÜ†ÎÑàÎ®ºÌä∏ Ï∞∏Í∞Ä Ïù∏Ïõê ÏûÖÎ†•">
                            <label for="third-place-match" style="display:flex; align-items:center; gap:8px; margin-top:12px;">
                                <input type="checkbox" id="third-place-match" checked aria-label="3/4ÏúÑ Í≤∞Ï†ïÏ†Ñ ÏßÑÌñâ Ïó¨Î∂Ä">
                                3/4ÏúÑ Í≤∞Ï†ïÏ†Ñ ÏßÑÌñâ
                            </label>
                        </div>
                        
                        <div id="team-settings" style="display:none; margin-top:16px; padding:16px; background:#e3f2fd; border-radius:8px; border-left:4px solid var(--primary);">
                            <h3 style="margin-bottom:12px;">üèÖ IBSA ÌåÄÏ†Ñ Í∑úÏπô</h3>
                            <ul style="font-size:13px; color:var(--text-secondary); margin:0; padding-left:20px;">
                                <li>ÌåÄ Íµ¨ÏÑ±: 3~6Î™Ö (ÌòºÏÑ±)</li>
                                <li>ÎùºÏù∏ÏóÖ: ÎÇ®2+Ïó¨1 ÎòêÎäî Ïó¨2+ÎÇ®1</li>
                                <li>Í≤ΩÍ∏∞ Î∞©Ïãù: 31Ï†ê 2Ï†êÏ∞®, Îã®Ìåê</li>
                                <li>ÏÑúÎ∏å: 3ÌöåÏî© ÍµêÎåÄ</li>
                            </ul>
                        </div>
                        
                        <label for="project-date" style="margin-top:16px;">ÎÇ†Ïßú (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <input type="text" id="project-date" placeholder="Ïòà: 2025-03-15 ÎòêÎäî 3Ïõî 15Ïùº" style="text-align:left;" autocomplete="off" aria-label="ÎåÄÌöå ÎÇ†Ïßú ÏûÖÎ†•">
                        <label for="project-location">Ïû•ÏÜå (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <input type="text" id="project-location" placeholder="Ïòà: ÏÑúÏö∏Ï¢ÖÌï©Ïö¥ÎèôÏû•" style="text-align:left;" autocomplete="off" aria-label="ÎåÄÌöå Ïû•ÏÜå ÏûÖÎ†•">
                        <label for="project-desc">ÏÑ§Î™Ö (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                        <textarea id="project-desc" rows="3" placeholder="ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Î™Ö" aria-label="ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Î™Ö ÏûÖÎ†•"></textarea>
                        <div class="action-row">
                            <button type="button" class="btn btn-danger" onclick="goTo('referee-home')" aria-label="Ï∑®ÏÜåÌïòÍ≥† ÎèåÏïÑÍ∞ÄÍ∏∞">Ï∑®ÏÜå</button>
                            <button type="button" class="btn btn-primary" onclick="createProject()" aria-label="ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±">ÏÉùÏÑ±</button>
                        </div>
                    </div>
                `;
            }
            else if (screen === 'project-list') {
                const isReferee = (userRole === 'referee');
                const backScreen = isReferee ? 'referee-home' : 'viewer-home';
                
                // Í≤ÄÏÉâ ÌïÑÌÑ∞ÎßÅ Ï†ÅÏö©
                const searchQuery = window.projectSearchQuery || '';
                const filteredProjects = searchQuery ? 
                    projects.filter(p => 
                        p.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                        (p.date && p.date.includes(searchQuery)) ||
                        (p.location && p.location.toLowerCase().includes(searchQuery.toLowerCase())) ||
                        (p.matches && p.matches.some(m => 
                            m.player1Name.toLowerCase().includes(searchQuery.toLowerCase()) ||
                            m.player2Name.toLowerCase().includes(searchQuery.toLowerCase())
                        ))
                    ) : projects;
                
                let projectListHTML = '';
                if (filteredProjects.length === 0) {
                    projectListHTML = searchQuery ? 
                        '<p style="text-align:center; padding:40px; color:var(--text-secondary)">Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>' :
                        '<p style="text-align:center; padding:40px; color:var(--text-secondary)">ÏÉùÏÑ±Îêú ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                } else {
                    projectListHTML = filteredProjects.map((p, i) => {
                        const originalIdx = projects.indexOf(p);
                        const typeLabel = p.isRandomTeamLeague ? 'üé≤' : (p.competitionType === 'team' ? 'üë•' : 'üë§');
                        return `
                        <div class="folder-item" style="display:flex; justify-content:space-between; align-items:center;">
                            <div onclick="selectProject(${originalIdx})" style="flex:1; cursor:pointer;" tabindex="0" aria-label="${p.name} ÌîÑÎ°úÏ†ùÌä∏ Ïó¥Í∏∞">
                                <h4>${typeLabel} ${p.name}</h4>
                                <p style="color:var(--text-secondary); font-size:14px; margin-top:4px">
                                    ${p.date || 'ÎÇ†Ïßú ÎØ∏Ï†ï'} ¬∑ ${p.location || 'Ïû•ÏÜå ÎØ∏Ï†ï'} ¬∑ ${p.competitionType === 'team' ? (p.teams?.length || 0) + 'ÌåÄ' : 'Í≤ΩÍ∏∞ ' + (p.matches?.length || 0) + 'Í∞ú'}
                                </p>
                            </div>
                            <button class="btn" onclick="event.stopPropagation(); showProjectQR(${originalIdx})" style="padding:8px 12px; min-width:auto;" aria-label="${p.name} QR Í≥µÏú†">üì±</button>
                        </div>
                    `}).join('');
                }
                
                // Ìé∏Ïßë Î≤ÑÌäº (Ïã¨Ìåê Î™®Îìú + ÌîÑÎ°úÏ†ùÌä∏ ÏûàÏùÑ ÎïåÎßå)
                const editButtonHTML = (isReferee && projects.length > 0) ? 
                    '<button type="button" class="btn btn-danger" onclick="goTo(\'edit-projects\')" aria-label="ÌîÑÎ°úÏ†ùÌä∏ Ìé∏Ïßë Î™®Îìú">Ìé∏Ïßë</button>' : '';
                
                // Í¥ÄÎûå Î™®Îìú ÏïàÎÇ¥
                const viewerNoticeHTML = !isReferee ? 
                    '<div style="background:#e3f2fd; padding:12px; border-radius:8px; margin-bottom:16px;"><span style="color:#1565c0;">Í¥ÄÎûå Î™®Îìú - ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ†ÌÉùÌïòÏó¨ Í≤ΩÍ∏∞Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî</span></div>' : '';
                
                app.innerHTML = `
                    <div class="card">
                        <h2>ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù</h2>
                        ${viewerNoticeHTML}
                        
                        <div style="margin-bottom:16px;">
                            <div style="display:flex; gap:8px;">
                                <input type="text" id="project-search" placeholder="üîç ÌîÑÎ°úÏ†ùÌä∏, ÎÇ†Ïßú, Ïû•ÏÜå, ÏÑ†ÏàòÎ™Ö Í≤ÄÏÉâ..." 
                                    value="${searchQuery}" 
                                    style="flex:1;" 
                                    onkeyup="if(event.key==='Enter') searchProjects()"
                                    aria-label="ÌîÑÎ°úÏ†ùÌä∏ Í≤ÄÏÉâ">
                                <button class="btn btn-primary" onclick="searchProjects()" aria-label="Í≤ÄÏÉâ Ïã§Ìñâ">Í≤ÄÏÉâ</button>
                                ${searchQuery ? '<button class="btn" onclick="clearSearch()" aria-label="Í≤ÄÏÉâ Ï¥àÍ∏∞Ìôî">Ï¥àÍ∏∞Ìôî</button>' : ''}
                            </div>
                        </div>
                        
                        ${searchQuery ? `<p style="color:var(--text-secondary); margin-bottom:12px;">Í≤ÄÏÉâ Í≤∞Í≥º: ${filteredProjects.length}Í∞ú</p>` : ''}
                        ${projectListHTML}
                        <div style="display:flex; gap:12px; margin-top:16px; flex-wrap:wrap;">
                            <button type="button" class="btn" onclick="goTo('${backScreen}')" aria-label="Îí§Î°ú Í∞ÄÍ∏∞">‚Üê Îí§Î°ú</button>
                            ${editButtonHTML}
                        </div>
                    </div>
                `;
            }
            else if (screen === 'edit-projects') {
                // ÌîÑÎ°úÏ†ùÌä∏ Ìé∏Ïßë Î™®Îìú (ÏÇ≠Ï†úÏö©)
                let editListHTML = '';
                if (projects.length === 0) {
                    editListHTML = '<p style="text-align:center; padding:40px; color:var(--text-secondary)">ÏÇ≠Ï†úÌï† ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                } else {
                    editListHTML = projects.map((p, i) => `
                        <div class="folder-item" style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h4>üìÅ ${p.name}</h4>
                                <p style="color:var(--text-secondary); font-size:14px; margin-top:4px">
                                    Í≤ΩÍ∏∞ ${p.matches?.length || 0}Í∞ú
                                </p>
                            </div>
                            <button type="button" onclick="deleteProject(${i})" 
                                    aria-label="${p.name} ÌîÑÎ°úÏ†ùÌä∏ ÏÇ≠Ï†ú"
                                    class="btn btn-danger" style="min-width:auto; padding:8px 16px;">
                                ÏÇ≠Ï†ú
                            </button>
                        </div>
                    `).join('');
                }
                
                app.innerHTML = `
                    <div class="card">
                        <h2>ÌîÑÎ°úÏ†ùÌä∏ Ìé∏Ïßë</h2>
                        <p style="color:var(--text-secondary); margin-bottom:16px;">ÏÇ≠Ï†úÌï† ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p>
                        ${editListHTML}
                        <button type="button" class="btn btn-primary" onclick="goTo('project-list')" style="margin-top:16px;" aria-label="Ìé∏Ïßë ÏôÑÎ£å">‚úì Ìé∏Ïßë ÏôÑÎ£å</button>
                    </div>
                `;
            }
            else if (screen === 'project-detail') {
                const active = currentProject.matches ? currentProject.matches.filter(m => m.status === 'active') : [];
                const finished = currentProject.matches ? currentProject.matches.filter(m => m.status === 'completed') : [];
                const isReferee = (userRole === 'referee');
                const hasMatches = (active.length > 0 || finished.length > 0);
                
                let activeMatchesHTML = '';
                if (active.length > 0) {
                    activeMatchesHTML = `
                        <h3 style="color:var(--success); margin:16px 0">ÏßÑÌñâ Ï§ëÏù∏ Í≤ΩÍ∏∞</h3>
                        ${active.map(m => {
                            const idx = currentProject.matches.indexOf(m);
                            return `
                                <div class="match-item" onclick="selectMatch(${idx})" tabindex="0" aria-label="${m.player1Name} vs ${m.player2Name} Í≤ΩÍ∏∞ Ïó¥Í∏∞">
                                    <h4>${m.player1Name} vs ${m.player2Name}</h4>
                                    <p style="color:var(--text-secondary); font-size:14px; margin-top:4px">
                                        ÏÑ∏Ìä∏ ${m.currentSet}/${m.sets} ¬∑ ${m.setScores[m.currentSet - 1].player1}-${m.setScores[m.currentSet - 1].player2} ¬∑ Ï£ºÏã¨: ${m.mainReferee || 'ÎØ∏Ï†ï'}
                                    </p>
                                </div>
                            `;
                        }).join('')}
                    `;
                }
                
                let finishedMatchesHTML = '';
                if (finished.length > 0) {
                    finishedMatchesHTML = `
                        <h3 style="color:var(--text-secondary); margin:24px 0 16px">ÏôÑÎ£åÎêú Í≤ΩÍ∏∞</h3>
                        ${finished.map(m => {
                            const idx = currentProject.matches.indexOf(m);
                            return `
                                <div class="match-item" onclick="selectMatch(${idx})" tabindex="0" aria-label="${m.player1Name} vs ${m.player2Name} Í≤ΩÍ∏∞ Ïó¥Í∏∞">
                                    <h4>${m.player1Name} vs ${m.player2Name}</h4>
                                    <p style="color:var(--text-secondary); font-size:14px; margin-top:4px">
                                        ÏôÑÎ£å ¬∑ Ï£ºÏã¨: ${m.mainReferee || 'ÎØ∏Ï†ï'}
                                    </p>
                                </div>
                            `;
                        }).join('')}
                    `;
                }
                
                let noMatchesHTML = '';
                if (!hasMatches) {
                    noMatchesHTML = '<p style="text-align:center; padding:20px; color:var(--text-secondary)">ÏÉùÏÑ±Îêú Í≤ΩÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                }
                
                // ÎØ∏Î¶¨ Í≥ÑÏÇ∞
                const titleHTML = isReferee ? 'Í≤ΩÍ∏∞ Í¥ÄÎ¶¨' : 'Í≤ΩÍ∏∞ Î™©Î°ù';
                const createButtonHTML = isReferee ? 
                    '<button type="button" class="btn btn-primary" onclick="goTo(\'create-match\')" aria-label="ÏÉà Í≤ΩÍ∏∞ ÏÉùÏÑ±">ÏÉà Í≤ΩÍ∏∞ ÏÉùÏÑ±</button>' : 
                    '<div style="background:#e8f5e9; padding:12px; border-radius:8px; margin-bottom:16px;"><span style="color:#2e7d32;">Í¥ÄÎûå Î™®Îìú - Í≤ΩÍ∏∞Î•º ÏÑ†ÌÉùÌïòÏó¨ Ï†êÏàòÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî</span></div>';
                const editButtonHTML = (isReferee && hasMatches) ? 
                    '<button type="button" class="btn btn-danger" onclick="goTo(\'edit-matches\')" aria-label="Í≤ΩÍ∏∞ Ìé∏Ïßë Î™®Îìú">Ìé∏Ïßë</button>' : '';
                
                // Í≤ΩÍ∏∞ Ï¢ÖÎ•ò (Í∞úÏù∏Ï†Ñ/ÌåÄÏ†Ñ)
                const isTeamCompetition = currentProject.competitionType === 'team';
                
                // ÎåÄÌöå Í¥ÄÎ¶¨ ÏÑπÏÖò (Ï°∞Î≥Ñ Î¶¨Í∑∏, ÌÜ†ÎÑàÎ®ºÌä∏)
                let tournamentHTML = '';
                if (currentProject.tournamentType && currentProject.tournamentType !== 'free') {
                    const hasTournamentData = currentProject.groups?.length > 0 || currentProject.bracket;
                    const participantCount = isTeamCompetition ? 
                        (currentProject.teams?.length || 0) : 
                        (currentProject.players?.length || 0);
                    
                    tournamentHTML = `
                        <div class="card">
                            <h2>ÎåÄÏßÑ Í¥ÄÎ¶¨</h2>
                            <div style="background:var(--bg-secondary); padding:12px; border-radius:8px; margin-bottom:16px;">
                                <div style="display:flex; flex-wrap:wrap; gap:16px;">
                                    <span><strong>Í≤ΩÍ∏∞ Ï¢ÖÎ•ò:</strong> ${isTeamCompetition ? 'üèÖ ÌåÄÏ†Ñ' : 'üë§ Í∞úÏù∏Ï†Ñ'}</span>
                                    <span><strong>ÎåÄÌöå Ïú†Ìòï:</strong> ${
                                        currentProject.tournamentType === 'group' ? 'Ï°∞Î≥Ñ Î¶¨Í∑∏' :
                                        currentProject.tournamentType === 'tournament' ? 'ÌÜ†ÎÑàÎ®ºÌä∏' :
                                        'Ï°∞Î≥Ñ Î¶¨Í∑∏ + Í≤∞ÏÑ† ÌÜ†ÎÑàÎ®ºÌä∏'
                                    }${currentProject.isRandomTeamLeague ? ' (ÎûúÎç§ ÌåÄ)' : ''}</span>
                                </div>
                                ${currentProject.isRandomTeamLeague ? `
                                    <div style="margin-top:8px; padding:8px; background:linear-gradient(135deg, #667eea22, #764ba222); border-radius:4px; font-size:12px; border-left:3px solid #667eea;">
                                        <strong>ÎûúÎç§ ÌåÄ Î¶¨Í∑∏Ï†Ñ</strong> ¬∑ Ï∞∏Í∞ÄÏûêÎ•º ÎûúÎç§ÏúºÎ°ú ÌåÄ Ìé∏ÏÑ±ÌïòÏó¨ Î¶¨Í∑∏Ï†Ñ ÏßÑÌñâ
                                    </div>
                                ` : ''}
                                ${isTeamCompetition ? `
                                    <div style="margin-top:8px; padding:8px; background:#e3f2fd; border-radius:4px; font-size:12px;">
                                        <strong>IBSA ÌåÄÏ†Ñ:</strong> 31Ï†ê 2Ï†êÏ∞®, Îã®Ìåê, ÏÑúÎ∏å 3Ìöå ÍµêÎåÄ
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${isReferee ? `
                                <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;">
                                    ${isTeamCompetition ? `
                                        <button class="btn btn-primary" onclick="goTo('manage-teams')">üèÖ ÌåÄ Í¥ÄÎ¶¨</button>
                                    ` : `
                                        <button class="btn btn-primary" onclick="goTo('manage-players')">ÏÑ†Ïàò Í¥ÄÎ¶¨</button>
                                    `}
                                    ${(currentProject.tournamentType === 'group' || currentProject.tournamentType === 'group-tournament') ? 
                                        '<button class="btn btn-primary" onclick="goTo(\'manage-groups\')">Ï°∞ Ìé∏ÏÑ±</button>' : ''}
                                    ${(currentProject.tournamentType === 'tournament' || currentProject.tournamentType === 'group-tournament') ? 
                                        '<button class="btn btn-primary" onclick="goTo(\'manage-bracket\')">üèÖ ÎåÄÏßÑÌëú</button>' : ''}
                                    <button class="btn" onclick="goTo('standings')">ÏàúÏúÑÌëú</button>
                                    <button class="btn" onclick="goTo('statistics')">üìà ÌÜµÍ≥Ñ</button>
                                </div>
                                <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border);">
                                    <button class="btn" onclick="goTo('auto-tournament')" style="background:#9c27b0; color:white;">ÏûêÎèô ÎåÄÌöå ÏßÑÌñâ</button>
                                </div>
                            ` : `
                                <div style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:16px;">
                                    <button class="btn" onclick="goTo('standings')">ÏàúÏúÑÌëú</button>
                                    <button class="btn" onclick="goTo('statistics')">üìà ÌÜµÍ≥Ñ</button>
                                </div>
                            `}
                            
                            ${hasTournamentData || participantCount > 0 ? `
                                <div style="margin-top:12px;">
                                    ${participantCount > 0 ? `
                                        <p style="color:var(--text-secondary);">${participantCount}${isTeamCompetition ? 'ÌåÄ' : 'Î™Ö'} Îì±Î°ù</p>
                                    ` : ''}
                                    ${currentProject.groups?.length > 0 ? `
                                        <p style="color:var(--text-secondary);">${currentProject.groups.length}Í∞ú Ï°∞ Ìé∏ÏÑ± ÏôÑÎ£å</p>
                                    ` : ''}
                                    ${currentProject.bracket ? `
                                        <p style="color:var(--text-secondary);">ÎåÄÏßÑÌëú ÏÉùÏÑ± ÏôÑÎ£å</p>
                                    ` : ''}
                                </div>
                            ` : `
                                <p style="color:var(--warning);">${isTeamCompetition ? 'ÌåÄ' : 'ÏÑ†Ïàò'} Îì±Î°ù Î∞è ÎåÄÏßÑ Ìé∏ÏÑ±Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.</p>
                            `}
                        </div>
                    `;
                }
                
                app.innerHTML = `
                    <div class="card">
                        <button type="button" class="btn" onclick="goTo('project-list')" aria-label="ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ùÏúºÎ°ú ÎèåÏïÑÍ∞ÄÍ∏∞" style="margin-bottom:16px;">‚Üê ÌîÑÎ°úÏ†ùÌä∏ Î™©Î°ù</button>
                        <h2>üìÅ ${currentProject.name}</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">ÎÇ†Ïßú</div>
                                <div class="info-value">${currentProject.date || 'ÎØ∏Ï†ï'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Ïû•ÏÜå</div>
                                <div class="info-value">${currentProject.location || 'ÎØ∏Ï†ï'}</div>
                            </div>
                        </div>
                        ${currentProject.desc ? `<p style="margin-top:12px; color:var(--text-secondary)">${currentProject.desc}</p>` : ''}
                    </div>
                    ${tournamentHTML}
                    <div class="card">
                        <h2>${titleHTML}</h2>
                        ${createButtonHTML}
                        ${noMatchesHTML}
                        ${activeMatchesHTML}
                        ${finishedMatchesHTML}
                        ${editButtonHTML ? `<div style="margin-top:16px;">${editButtonHTML}</div>` : ''}
                    </div>
                `;
            }
            else if (screen === 'edit-matches') {
                // ========== ÎåÄÏßÑ Ìé∏Ïßë - Ïã¨Ìåê/Í≤ΩÍ∏∞Ïû• Î∞∞Ï†ï ==========
                const allMatches = currentProject.matches || [];
                const referees = currentProject.referees || [];
                const courts = currentProject.courts || [];
                
                if (allMatches.length === 0) {
                    app.innerHTML = `
                        <div class="card">
                            <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                            <h2>Í≤ΩÍ∏∞ Ìé∏Ïßë</h2>
                            <p style="text-align:center; padding:40px; color:var(--text-secondary);">ÏÉùÏÑ±Îêú Í≤ΩÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                        </div>
                    `;
                    return;
                }
                
                // Í≤ΩÍ∏∞Î≥Ñ Ïã¨Ìåê/Í≤ΩÍ∏∞Ïû• Î∞∞Ï†ï Ìèº
                const matchesEditHTML = allMatches.map((m, idx) => {
                    const scheduledDateTime = m.scheduledDate && m.scheduledTime ? 
                        `${m.scheduledDate} ${m.scheduledTime}` : 'ÎØ∏Ï†ï';
                    
                    return `
                    <div class="card" style="padding:15px; margin-bottom:12px; border-left:4px solid ${m.scheduledDate && m.scheduledTime ? '#2196f3' : m.mainRefereeName ? '#4caf50' : '#ff9800'};">
                        <div style="margin-bottom:12px;">
                            <h4 style="margin:0 0 4px 0;">${m.player1Name || 'ÏÑ†Ïàò1'} vs ${m.player2Name || 'ÏÑ†Ïàò2'}</h4>
                            <small style="color:#666;">
                                üïê ${scheduledDateTime} ¬∑ 
                                üìç ${m.courtName || 'ÎØ∏ÏßÄÏ†ï'} ¬∑ 
                                üë®‚Äç‚öñÔ∏è ${m.mainRefereeName || 'ÎØ∏ÏßÄÏ†ï'} ¬∑ 
                                ${m.status === 'completed' ? 'ÏôÑÎ£å' : m.status === 'inprogress' ? 'ÏßÑÌñâÏ§ë' : 'ÎåÄÍ∏∞'}
                            </small>
                        </div>
                        
                        <!-- ÏãúÍ∞Ñ Ïä§ÏºÄÏ§Ñ ÏÑ§Ï†ï -->
                        <div style="background:#f8f9fa; padding:12px; border-radius:6px; margin-bottom:12px;">
                            <label style="font-size:13px; font-weight:600; display:block; margin-bottom:8px;">üìÖ Í≤ΩÍ∏∞ Ïä§ÏºÄÏ§Ñ</label>
                            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                                <div>
                                    <label style="font-size:12px; color:#666;">ÎÇ†Ïßú</label>
                                    <input type="date" id="date-${idx}" value="${m.scheduledDate || ''}" 
                                           onchange="updateMatchSchedule(${idx}, 'date', this.value)"
                                           style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; font-size:12px;">
                                </div>
                                <div>
                                    <label style="font-size:12px; color:#666;">ÏãúÍ∞Ñ</label>
                                    <input type="time" id="time-${idx}" value="${m.scheduledTime || ''}" 
                                           onchange="updateMatchSchedule(${idx}, 'time', this.value)"
                                           style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; font-size:12px;">
                                </div>
                                <div>
                                    <label style="font-size:12px; color:#666;">ÏÜåÏöîÏãúÍ∞Ñ(Î∂Ñ)</label>
                                    <select id="duration-${idx}" onchange="updateMatchSchedule(${idx}, 'duration', this.value)"
                                            style="width:100%; padding:8px; border:1px solid var(--border); border-radius:4px; font-size:12px;">
                                        <option value="15" ${m.estimatedDuration === 15 ? 'selected' : ''}>15Î∂Ñ</option>
                                        <option value="20" ${m.estimatedDuration === 20 ? 'selected' : ''}>20Î∂Ñ</option>
                                        <option value="30" ${m.estimatedDuration === 30 ? 'selected' : ''}>30Î∂Ñ</option>
                                        <option value="45" ${m.estimatedDuration === 45 ? 'selected' : ''}>45Î∂Ñ</option>
                                        <option value="60" ${m.estimatedDuration === 60 ? 'selected' : ''}>60Î∂Ñ</option>
                                        <option value="90" ${m.estimatedDuration === 90 ? 'selected' : ''}>90Î∂Ñ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                            <div>
                                <label style="font-size:13px; font-weight:600; display:block; margin-bottom:6px;">üë®‚Äç‚öñÔ∏è Ïã¨Ìåê</label>
                                <select id="ref-${idx}" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px;" onchange="updateMatchReferee(${idx})">
                                    <option value="">-- Ïã¨Ìåê ÏÑ†ÌÉù --</option>
                                    ${referees.map(ref => `
                                        <option value="${ref.name}" ${m.mainRefereeName === ref.name ? 'selected' : ''}>
                                            ${ref.name} (${ref.role})
                                        </option>
                                    `).join('')}
                                </select>
                                ${m.mainRefereeName ? `<small style="color:#4caf50; margin-top:4px; display:block;">‚úì ${m.mainRefereeName}</small>` : ''}
                            </div>
                            
                            <div>
                                <label style="font-size:13px; font-weight:600; display:block; margin-bottom:6px;">üèüÔ∏è Í≤ΩÍ∏∞Ïû•</label>
                                <select id="court-${idx}" style="width:100%; padding:10px; border:1px solid var(--border); border-radius:6px;" onchange="updateMatchCourt(${idx})">
                                    <option value="">-- Í≤ΩÍ∏∞Ïû• ÏÑ†ÌÉù --</option>
                                    ${courts.map(court => `
                                        <option value="${court.name}" ${m.courtName === court.name ? 'selected' : ''}>
                                            ${court.name}
                                        </option>
                                    `).join('')}
                                </select>
                                ${m.courtName ? `<small style="color:#4caf50; margin-top:4px; display:block;">‚úì ${m.courtName}</small>` : ''}
                            </div>
                        </div>
                        
                        <div style="display:flex; gap:8px;">
                            <button class="btn" onclick="copyScheduleToNext(${idx})" style="flex:1; background:#2196f3; color:white; border:none; border-radius:6px; padding:8px; font-size:12px;">
                                ‚¨áÔ∏è Îã§Ïùå Í≤ΩÍ∏∞Ïóê Ïó∞ÏÜç Î∞∞Ï†ï
                            </button>
                            <button class="btn" onclick="deleteMatchDirect(${idx})" style="background:#ff6b6b; color:white; border:none; border-radius:6px; padding:8px;">
                                üóëÔ∏è ÏÇ≠Ï†ú
                            </button>
                        </div>
                    </div>
                `}).join('');
                
                // Í≤ΩÍ∏∞Ïû• Î∞∞Ï†ï Î™®Îìú (Ï†ÄÏû•Îêú Í∞í ÎòêÎäî Í∏∞Î≥∏Í∞í)
                const courtAssignMode = currentProject.courtAssignMode || 'manual';
                const fixedCourt = currentProject.fixedCourt || '';
                
                app.innerHTML = `
                    <div class="card">
                        <div style="background:linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color:white; padding:16px; border-radius:8px; margin:-20px -20px 20px -20px;">
                            <h2 style="margin:0; color:white;">Í≤ΩÍ∏∞ Ìé∏Ïßë</h2>
                            <p style="margin:4px 0 0 0; font-size:13px; color:rgba(255,255,255,0.9);">Ïã¨ÌåêÍ≥º Í≤ΩÍ∏∞Ïû•ÏùÑ Î∞∞Ï†ïÌïòÏÑ∏Ïöî</p>
                        </div>
                        
                        ${referees.length === 0 ? `
                            <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-bottom:16px; border-left:4px solid #ff9800;">
                                <strong>Ïã¨ÌåêÏùÑ Î®ºÏ†Ä Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî</strong>
                                <p style="font-size:13px; margin:4px 0 0 0;">ÎåÄÏßÑ ÏÑ§Ï†ïÏóêÏÑú Ïã¨ÌåêÏùÑ Ï∂îÍ∞ÄÌïòÎ©¥ Ïó¨Í∏∞ÏÑú Î∞∞Ï†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                            </div>
                        ` : ''}
                        
                        ${courts.length === 0 ? `
                            <div style="background:#fff3e0; padding:12px; border-radius:8px; margin-bottom:16px; border-left:4px solid #ff9800;">
                                <strong>Í≤ΩÍ∏∞Ïû•ÏùÑ Î®ºÏ†Ä Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî</strong>
                                <p style="font-size:13px; margin:4px 0 0 0;">ÎåÄÏßÑ ÏÑ§Ï†ïÏóêÏÑú Í≤ΩÍ∏∞Ïû•ÏùÑ Ï∂îÍ∞ÄÌïòÎ©¥ Ïó¨Í∏∞ÏÑú Î∞∞Ï†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                            </div>
                        ` : `
                            <!-- Í≤ΩÍ∏∞Ïû• Î∞∞Ï†ï Î™®Îìú ÏÑ§Ï†ï -->
                            <div style="background:#e3f2fd; padding:16px; border-radius:8px; margin-bottom:16px;">
                                <strong style="display:block; margin-bottom:12px;">Í≤ΩÍ∏∞Ïû• Î∞∞Ï†ï Î™®Îìú</strong>
                                
                                <div style="display:grid; gap:8px; margin-bottom:12px;">
                                    <label style="display:flex; align-items:center; gap:8px; padding:10px; background:white; border-radius:6px; cursor:pointer; border:2px solid ${courtAssignMode==='manual'?'#1976d2':'transparent'};">
                                        <input type="radio" name="court-mode" value="manual" ${courtAssignMode==='manual'?'checked':''} onchange="setCourtAssignMode('manual')">
                                        <div>
                                            <strong>ÏàòÎèô Î∞∞Ï†ï</strong>
                                            <span style="font-size:12px; color:#666;"> - Í∞Å Í≤ΩÍ∏∞ÎßàÎã§ ÏßÅÏ†ë ÏÑ†ÌÉù</span>
                                        </div>
                                    </label>
                                    
                                    <label style="display:flex; align-items:center; gap:8px; padding:10px; background:white; border-radius:6px; cursor:pointer; border:2px solid ${courtAssignMode==='fixed'?'#1976d2':'transparent'};">
                                        <input type="radio" name="court-mode" value="fixed" ${courtAssignMode==='fixed'?'checked':''} onchange="setCourtAssignMode('fixed')">
                                        <div>
                                            <strong>Í≤ΩÍ∏∞Ïû• Í≥†Ï†ï</strong>
                                            <span style="font-size:12px; color:#666;"> - Î™®Îì† Í≤ΩÍ∏∞Î•º Ìïú Í≤ΩÍ∏∞Ïû•ÏóêÏÑú ÏßÑÌñâ</span>
                                        </div>
                                    </label>
                                    
                                    <label style="display:flex; align-items:center; gap:8px; padding:10px; background:white; border-radius:6px; cursor:pointer; border:2px solid ${courtAssignMode==='rotate'?'#1976d2':'transparent'};">
                                        <input type="radio" name="court-mode" value="rotate" ${courtAssignMode==='rotate'?'checked':''} onchange="setCourtAssignMode('rotate')">
                                        <div>
                                            <strong>ÏûêÎèô ÏàúÌôò</strong>
                                            <span style="font-size:12px; color:#666;"> - Í≤ΩÍ∏∞Ïû•ÏùÑ ÏàúÏÑúÎåÄÎ°ú ÏûêÎèô Î∞∞Ï†ï</span>
                                        </div>
                                    </label>
                                </div>
                                
                                ${courtAssignMode === 'fixed' ? `
                                    <div style="margin-top:12px;">
                                        <label style="font-size:13px; font-weight:600;">Í≥†Ï†ï Í≤ΩÍ∏∞Ïû• ÏÑ†ÌÉù:</label>
                                        <select id="fixed-court-select" onchange="setFixedCourt(this.value)" style="width:100%; margin-top:6px; padding:10px; border-radius:6px;">
                                            <option value="">-- ÏÑ†ÌÉù --</option>
                                            ${courts.map(c => `<option value="${c.name}" ${fixedCourt===c.name?'selected':''}>${c.name}</option>`).join('')}
                                        </select>
                                        ${fixedCourt ? `<button class="btn btn-primary" onclick="applyFixedCourt()" style="width:100%; margin-top:8px;">‚úì Î™®Îì† Í≤ΩÍ∏∞Ïóê Ï†ÅÏö©</button>` : ''}
                                    </div>
                                ` : ''}
                                
                                ${courtAssignMode === 'rotate' ? `
                                    <div style="margin-top:12px;">
                                        <button class="btn btn-primary" onclick="applyRotateCourt()" style="width:100%;">Í≤ΩÍ∏∞Ïû• ÏûêÎèô ÏàúÌôò Î∞∞Ï†ï</button>
                                        <p style="font-size:12px; color:#666; margin-top:6px;">Í≤ΩÍ∏∞ 1‚Üí${courts[0]?.name}, Í≤ΩÍ∏∞ 2‚Üí${courts[1]?.name || courts[0]?.name}, ...</p>
                                    </div>
                                ` : ''}
                            </div>
                        `}
                        
                        <div style="background:#e8f5e9; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>üìä ÌòÑÌô©</strong>
                            <div style="font-size:13px; margin-top:8px; color:#333;">
                                Ï†ÑÏ≤¥ Í≤ΩÍ∏∞: ${allMatches.length}Í≤ΩÍ∏∞ ¬∑ 
                                Ïã¨ÌåêÎ∞∞Ï†ï: ${allMatches.filter(m => m.mainRefereeName).length}Í≤ΩÍ∏∞ ¬∑ 
                                Í≤ΩÍ∏∞Ïû•Î∞∞Ï†ï: ${allMatches.filter(m => m.courtName).length}Í≤ΩÍ∏∞ ¬∑ 
                                Ïä§ÏºÄÏ§ÑÏÑ§Ï†ï: ${allMatches.filter(m => m.scheduledDate && m.scheduledTime).length}Í≤ΩÍ∏∞
                            </div>
                        </div>
                        
                        <!-- Ïä§ÏºÄÏ§Ñ Í¥ÄÎ¶¨ ÎèÑÍµ¨ -->
                        <div style="background:#f8f9fa; padding:16px; border-radius:8px; margin-bottom:16px; border-left:4px solid #2196f3;">
                            <strong>‚è∞ Ïä§ÏºÄÏ§Ñ Í¥ÄÎ¶¨ ÎèÑÍµ¨</strong>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px;">
                                <button class="btn" onclick="generateAutoSchedule()" style="background:#2196f3; color:white; font-size:13px;">
                                    üöÄ Ï†ÑÏ≤¥ Ïä§ÏºÄÏ§Ñ ÏûêÎèô ÏÉùÏÑ±
                                </button>
                                <button class="btn" onclick="goTo('schedule-overview')" style="background:#9c27b0; color:white; font-size:13px;">
                                    üìÖ Ïä§ÏºÄÏ§Ñ ÌÉÄÏûÑÎùºÏù∏ Î≥¥Í∏∞
                                </button>
                            </div>
                        </div>
                        
                        <div style="max-height:500px; overflow-y:auto; margin-bottom:16px;">
                            ${matchesEditHTML}
                        </div>
                        
                        <button class="btn btn-primary" onclick="goTo('project-detail')" style="width:100%;">‚úì Ìé∏Ïßë ÏôÑÎ£å</button>
                    </div>
                `;
            }
            // ========== IBSA ÎåÄÏßÑ Í¥ÄÎ¶¨ ÌôîÎ©¥Îì§ ==========
            // ÌåÄ Í¥ÄÎ¶¨ ÌôîÎ©¥ (ÌåÄÏ†ÑÏö©)
            else if (screen === 'manage-teams') {
                const teams = currentProject.teams || [];
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                        <h2>üèÖ ÌåÄ Í¥ÄÎ¶¨</h2>
                        
                        <div style="margin-bottom:16px; padding:16px; background:#e3f2fd; border-radius:8px; border-left:4px solid var(--primary);">
                            <strong>IBSA ÌåÄ Íµ¨ÏÑ± Í∑úÏπô</strong>
                            <ul style="font-size:13px; margin:8px 0 0 0; padding-left:20px; color:var(--text-secondary);">
                                <li>ÌåÄ Ïù∏Ïõê: 3~6Î™Ö</li>
                                <li>Í≤ΩÍ∏∞ ÎùºÏù∏ÏóÖ: ÌòºÏÑ± (ÎÇ®2+Ïó¨1 ÎòêÎäî Ïó¨2+ÎÇ®1)</li>
                                <li>Í≤ΩÍ∏∞ Î∞©Ïãù: 31Ï†ê 2Ï†êÏ∞®, Îã®Ìåê</li>
                            </ul>
                        </div>
                        
                        <div style="margin-bottom:16px; padding:16px; background:var(--bg-secondary); border-radius:8px;">
                            <h3 style="margin-bottom:12px;">ÏÉà ÌåÄ Ï∂îÍ∞Ä</h3>
                            <label>ÌåÄÎ™Ö *</label>
                            <input type="text" id="new-team-name" placeholder="Ïòà: ÏÑúÏö∏ÌåÄ" style="text-align:left;" autocomplete="off">
                            <label style="margin-top:12px;">ÏÑ†Ïàò (ÏâºÌëúÎ°ú Íµ¨Î∂Ñ, ÏÑ±Î≥Ñ ÌëúÏãú: Ïù¥Î¶Ñ/ÎÇ® ÎòêÎäî Ïù¥Î¶Ñ/Ïó¨)</label>
                            <input type="text" id="new-team-members" placeholder="Ïòà: ÌôçÍ∏∏Îèô/ÎÇ®, ÍπÄÏòÅÌù¨/Ïó¨, Ïù¥ÏàúÏã†/ÎÇ®" style="text-align:left;" autocomplete="off">
                            <button class="btn btn-primary" onclick="addTeam()" style="margin-top:12px; width:100%;">ÌåÄ Ï∂îÍ∞Ä</button>
                        </div>
                        
                        <h3>Îì±Î°ùÎêú ÌåÄ (${teams.length}ÌåÄ)</h3>
                        <div id="team-list">
                            ${teams.length === 0 ? '<p style="color:var(--text-secondary); padding:20px; text-align:center;">Îì±Î°ùÎêú ÌåÄÏù¥ ÏóÜÏäµÎãàÎã§.</p>' :
                                teams.map((t, i) => {
                                    const maleCount = t.members?.filter(m => m.gender === 'male').length || 0;
                                    const femaleCount = t.members?.filter(m => m.gender === 'female').length || 0;
                                    const isValidLineup = (maleCount >= 2 && femaleCount >= 1) || (femaleCount >= 2 && maleCount >= 1);
                                    
                                    return `
                                    <div style="padding:16px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid ${isValidLineup ? 'var(--success)' : 'var(--warning)'};">
                                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                                            <strong style="font-size:16px;">${i + 1}. ${t.name}</strong>
                                            <div>
                                                ${t.group ? `<span style="color:var(--primary); margin-right:8px;">${t.group}Ï°∞</span>` : ''}
                                                <button class="btn btn-danger" onclick="removeTeam(${i})" style="padding:4px 12px; font-size:12px;">ÏÇ≠Ï†ú</button>
                                            </div>
                                        </div>
                                        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px;">
                                            ${t.members?.map(m => `
                                                <span style="padding:4px 8px; background:${m.gender === 'male' ? '#e3f2fd' : '#fce4ec'}; border-radius:4px; font-size:13px;">
                                                    ${m.gender === 'male' ? '‚ôÇÔ∏è' : '‚ôÄÔ∏è'} ${m.name}
                                                </span>
                                            `).join('') || 'ÏÑ†Ïàò ÏóÜÏùå'}
                                        </div>
                                        <div style="font-size:12px; color:${isValidLineup ? 'var(--success)' : 'var(--warning)'};">
                                            ${isValidLineup ? 'ÎùºÏù∏ÏóÖ Ïú†Ìö®' : 'ÎùºÏù∏ÏóÖ ÌôïÏù∏ ÌïÑÏöî (ÎÇ®2+Ïó¨1 ÎòêÎäî Ïó¨2+ÎÇ®1)'} 
                                            (ÎÇ® ${maleCount}Î™Ö, Ïó¨ ${femaleCount}Î™Ö)
                                        </div>
                                    </div>
                                `}).join('')
                            }
                        </div>
                    </div>
                `;
            }
            else if (screen === 'manage-players') {
                const players = currentProject.players || [];
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                        <h2>ÏÑ†Ïàò Í¥ÄÎ¶¨</h2>
                        
                        <div style="margin-bottom:16px; padding:16px; background:var(--bg-secondary); border-radius:8px;">
                            <label>ÏÑ†Ïàò Ï∂îÍ∞Ä</label>
                            <div style="display:flex; gap:8px;">
                                <input type="text" id="new-player-name" placeholder="ÏÑ†Ïàò Ïù¥Î¶Ñ" style="flex:1;" autocomplete="off">
                                <button class="btn btn-primary" onclick="addPlayer()">Ï∂îÍ∞Ä</button>
                            </div>
                            <p style="font-size:12px; color:var(--text-secondary); margin-top:4px;">Ïó¨Îü¨ Î™Ö: ÏâºÌëúÎ°ú Íµ¨Î∂Ñ (Ïòà: ÌôçÍ∏∏Îèô, Ïù¥ÏàúÏã†)</p>
                        </div>
                        
                        <h3>Îì±Î°ùÎêú ÏÑ†Ïàò (${players.length}Î™Ö)</h3>
                        <div id="player-list">
                            ${players.length === 0 ? '<p style="color:var(--text-secondary); padding:20px; text-align:center;">Îì±Î°ùÎêú ÏÑ†ÏàòÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>' :
                                players.map((p, i) => `
                                    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px;">
                                        <span><strong>${i + 1}.</strong> ${p.name} ${p.group ? `<span style="color:var(--primary);">(${p.group}Ï°∞)</span>` : ''}</span>
                                        <button class="btn btn-danger" onclick="removePlayer(${i})" style="padding:4px 12px; font-size:12px;">ÏÇ≠Ï†ú</button>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                `;
            }
            else if (screen === 'manage-groups') {
                const isTeam = currentProject.competitionType === 'team';
                const participants = isTeam ? (currentProject.teams || []) : (currentProject.players || []);
                const groups = currentProject.groups || [];
                const settings = currentProject.groupSettings || { groupCount: 2, advanceCount: 2, setsPerMatch: isTeam ? 1 : 3 };
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                        <h2>IBSA Ï°∞Î≥Ñ Î¶¨Í∑∏ ${isTeam ? '(ÌåÄÏ†Ñ)' : '(Í∞úÏù∏Ï†Ñ)'}</h2>
                        
                        <div style="margin-bottom:16px; padding:16px; background:#e3f2fd; border-radius:8px; border-left:4px solid var(--primary);">
                            <strong>IBSA ÎùºÏö¥Îìú Î°úÎπà Î∞©Ïãù</strong>
                            <p style="font-size:13px; margin-top:4px;">
                                ${isTeam ? 
                                    'Í∞Å Ï°∞ÏóêÏÑú Î™®Îì† ÌåÄÏù¥ ÏÑúÎ°ú Ìïú Î≤àÏî© ÎåÄÏ†ÑÌï©ÎãàÎã§. (31Ï†ê 2Ï†êÏ∞®, Îã®Ìåê)' : 
                                    'Í∞Å Ï°∞ÏóêÏÑú Î™®Îì† ÏÑ†ÏàòÍ∞Ä ÏÑúÎ°ú Ìïú Î≤àÏî© ÎåÄÏ†ÑÌï©ÎãàÎã§. (3ÏÑ∏Ìä∏ 2ÏÑ†Ïäπ)'
                                }
                            </p>
                        </div>
                        
                        <div style="margin-bottom:16px; padding:16px; background:var(--bg-secondary); border-radius:8px;">
                            <h3 style="margin-bottom:12px;">Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏÑ§Ï†ï</h3>
                            <div style="display:grid; grid-template-columns:${isTeam ? '1fr 1fr' : '1fr 1fr 1fr'}; gap:12px;">
                                <div>
                                    <label>Ï°∞ Í∞úÏàò</label>
                                    <select id="group-count-edit">
                                        ${[1,2,3,4,5,6,7,8].map(n => `<option value="${n}" ${settings.groupCount === n ? 'selected' : ''}>${n}Í∞ú</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label>Ï°∞Î≥Ñ ÏßÑÏ∂ú${isTeam ? 'ÌåÄ' : 'Ïûê'}</label>
                                    <select id="advance-count-edit">
                                        ${[1,2,3,4].map(n => `<option value="${n}" ${settings.advanceCount === n ? 'selected' : ''}>${n}${isTeam ? 'ÌåÄ' : 'Î™Ö'}</option>`).join('')}
                                    </select>
                                </div>
                                ${!isTeam ? `
                                <div>
                                    <label>ÏòàÏÑ† ÏÑ∏Ìä∏</label>
                                    <select id="group-sets-edit">
                                        <option value="3" selected>3ÏÑ∏Ìä∏ (2ÏÑ†Ïäπ)</option>
                                    </select>
                                </div>
                                ` : '<input type="hidden" id="group-sets-edit" value="1">'}
                            </div>
                            <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="btn btn-primary" onclick="autoAssignGroups()">ÏûêÎèô Î∞∞Ï†ï</button>
                                <button class="btn btn-success" onclick="generateGroupMatches()">üìÖ ÎåÄÏßÑÌëú ÏÉùÏÑ±</button>
                                <button class="btn btn-danger" onclick="clearGroups()">Ï¥àÍ∏∞Ìôî</button>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:16px;">
                            <p style="color:var(--text-secondary);">Îì±Î°ù ${isTeam ? 'ÌåÄ' : 'ÏÑ†Ïàò'}: ${participants.length}${isTeam ? 'ÌåÄ' : 'Î™Ö'} | Ìé∏ÏÑ±Îêú Ï°∞: ${groups.length}Í∞ú</p>
                        </div>
                        
                        ${groups.length > 0 ? groups.map((g, gi) => `
                            <div style="margin-bottom:16px; padding:16px; border:2px solid var(--primary); border-radius:8px;">
                                <h3 style="color:var(--primary); margin-bottom:12px;">${String.fromCharCode(65 + gi)}Ï°∞ (${g.players?.length || 0}${isTeam ? 'ÌåÄ' : 'Î™Ö'})</h3>
                                ${g.players?.map((p, pi) => `
                                    <div style="padding:8px; margin:4px 0; background:var(--bg-secondary); border-radius:4px; display:flex; justify-content:space-between; align-items:center;">
                                        <span>${pi + 1}. ${p.name}</span>
                                        <div>
                                            <button class="btn" onclick="movePlayerGroup(${gi}, ${pi})" style="padding:2px 8px; font-size:11px;">Ïù¥Îèô</button>
                                        </div>
                                    </div>
                                `).join('') || '<p style="color:var(--text-secondary);">ÏÑ†Ïàò ÏóÜÏùå</p>'}
                                
                                ${g.matches?.length > 0 ? `
                                    <h4 style="margin-top:16px; margin-bottom:8px; color:var(--text-secondary);">ÎåÄÏßÑÌëú (${g.matches.length}Í≤ΩÍ∏∞)</h4>
                                    ${g.matches.map((m, mi) => `
                                        <div style="padding:8px; margin:4px 0; background:${m.status === 'completed' ? '#e8f5e9' : '#fff3e0'}; border-radius:4px; display:flex; justify-content:space-between; align-items:center;">
                                            <span>${m.player1} vs ${m.player2}</span>
                                            <span style="font-size:12px; color:var(--text-secondary);">
                                                ${m.status === 'completed' ? `${m.result?.player1Sets || 0}:${m.result?.player2Sets || 0}` : '‚è≥ ÎåÄÍ∏∞'}
                                            </span>
                                        </div>
                                    `).join('')}
                                ` : ''}
                            </div>
                        `).join('') : `
                            <div style="text-align:center; padding:40px; color:var(--text-secondary);">
                                <p>Ï°∞ Ìé∏ÏÑ±Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                                <p style="font-size:14px; margin-top:8px;">ÏÑ†ÏàòÎ•º Îì±Î°ùÌïòÍ≥† "ÏûêÎèô Î∞∞Ï†ï"ÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.</p>
                            </div>
                        `}
                    </div>
                `;
            }
            else if (screen === 'manage-bracket') {
                const bracket = currentProject.bracket;
                const settings = currentProject.tournamentSettings || { setsPerMatch: 5, thirdPlaceMatch: true };
                const groups = currentProject.groups || [];
                const advanceCount = currentProject.groupSettings?.advanceCount || 2;
                
                // Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏßÑÏ∂úÏûê Í≥ÑÏÇ∞
                let qualifiedPlayers = [];
                if (groups.length > 0) {
                    groups.forEach((g, gi) => {
                        const standings = calculateGroupStandings(g);
                        standings.slice(0, advanceCount).forEach((p, rank) => {
                            qualifiedPlayers.push({
                                ...p,
                                fromGroup: String.fromCharCode(65 + gi),
                                groupRank: rank + 1
                            });
                        });
                    });
                }
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                        <h2>üèÖ IBSA ÎÖπÏïÑÏõÉ ÌÜ†ÎÑàÎ®ºÌä∏</h2>
                        
                        <div style="margin-bottom:16px; padding:16px; background:#e3f2fd; border-radius:8px; border-left:4px solid var(--primary);">
                            <strong>IBSA Ïã±Í∏Ä ÏóòÎ¶¨ÎØ∏ÎÑ§Ïù¥ÏÖò</strong>
                            <p style="font-size:13px; margin-top:4px;">Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏßÑÏ∂úÏûêÎì§Ïù¥ ÌÜ†ÎÑàÎ®ºÌä∏Î°ú Ïö∞ÏäπÏùÑ Í≤∞Ï†ïÌï©ÎãàÎã§.</p>
                        </div>
                        
                        <div style="margin-bottom:16px; padding:16px; background:var(--bg-secondary); border-radius:8px;">
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                                <div>
                                    <label>Î≥∏ÏÑ† ÏÑ∏Ìä∏</label>
                                    <select id="knockout-sets-edit" onchange="updateTournamentSettings()">
                                        <option value="3" ${settings.setsPerMatch === 3 ? 'selected' : ''}>3ÏÑ∏Ìä∏</option>
                                        <option value="5" ${settings.setsPerMatch === 5 ? 'selected' : ''}>5ÏÑ∏Ìä∏ (IBSA Í≤∞Ïäπ)</option>
                                    </select>
                                </div>
                                <div>
                                    <label style="display:flex; align-items:center; gap:8px; margin-top:24px;">
                                        <input type="checkbox" id="third-place-edit" ${settings.thirdPlaceMatch ? 'checked' : ''} onchange="updateTournamentSettings()">
                                        3/4ÏúÑ Í≤∞Ï†ïÏ†Ñ
                                    </label>
                                </div>
                            </div>
                            <div style="display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="btn btn-primary" onclick="generateBracket()">ÎåÄÏßÑÌëú ÏÉùÏÑ±</button>
                                <button class="btn btn-success" onclick="createKnockoutMatches()">üìÖ Í≤ΩÍ∏∞ ÏÉùÏÑ±</button>
                            </div>
                        </div>
                        
                        ${qualifiedPlayers.length > 0 ? `
                            <div style="margin-bottom:16px;">
                                <h3 style="margin-bottom:8px;">Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏßÑÏ∂úÏûê (${qualifiedPlayers.length}Î™Ö)</h3>
                                <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(150px, 1fr)); gap:8px;">
                                    ${qualifiedPlayers.map(p => `
                                        <div style="padding:8px; background:${p.groupRank === 1 ? '#fff3cd' : '#e8f5e9'}; border-radius:4px; text-align:center;">
                                            <div style="font-weight:600;">${p.name}</div>
                                            <div style="font-size:11px; color:var(--text-secondary);">${p.fromGroup}Ï°∞ ${p.groupRank}ÏúÑ</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${bracket ? `
                            <div id="bracket-view">
                                ${renderBracketView(bracket)}
                            </div>
                        ` : `
                            <div style="text-align:center; padding:40px; color:var(--text-secondary);">
                                <p>ÎåÄÏßÑÌëúÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                                <p style="font-size:14px; margin-top:8px;">${groups.length > 0 ? 'Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏôÑÎ£å ÌõÑ "ÎåÄÏßÑÌëú ÏÉùÏÑ±"ÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.' : 'Î®ºÏ†Ä Ï°∞Î≥Ñ Î¶¨Í∑∏Î•º ÏßÑÌñâÌïòÏÑ∏Ïöî.'}</p>
                            </div>
                        `}
                    </div>
                `;
            }
            else if (screen === 'standings') {
                const standings = calculateStandings();
                const advanceCount = currentProject.groupSettings?.advanceCount || 2;
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                        <h2>IBSA ÏàúÏúÑÌëú</h2>
                        
                        <div style="margin-bottom:16px; padding:12px; background:#e3f2fd; border-radius:8px; border-left:4px solid var(--primary);">
                            <strong>ÏàúÏúÑ Í≤∞Ï†ï Í∏∞Ï§Ä (IBSA)</strong>
                            <p style="font-size:12px; margin-top:4px;">1. ÏäπÎ•† ‚Üí 2. ÏÑ∏Ìä∏ÎìùÏã§ ‚Üí 3. Í≥®ÎìùÏã§ ‚Üí 4. ÏßÅÏ†ëÎåÄÍ≤∞</p>
                        </div>
                        
                        ${currentProject.groups?.length > 0 ? `
                            <h3 style="margin:16px 0 12px;">Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏàúÏúÑ</h3>
                            ${currentProject.groups.map((g, gi) => `
                                <div style="margin-bottom:20px;">
                                    <h4 style="color:var(--primary); margin-bottom:8px;">${String.fromCharCode(65 + gi)}Ï°∞</h4>
                                    <div style="overflow-x:auto;">
                                        <table style="width:100%; border-collapse:collapse; font-size:13px; min-width:400px;">
                                            <thead>
                                                <tr style="background:var(--bg-secondary);">
                                                    <th style="padding:8px; text-align:center;">ÏàúÏúÑ</th>
                                                    <th style="padding:8px;">ÏÑ†Ïàò</th>
                                                    <th style="padding:8px; text-align:center;">Í≤ΩÍ∏∞</th>
                                                    <th style="padding:8px; text-align:center;">Ïäπ</th>
                                                    <th style="padding:8px; text-align:center;">Ìå®</th>
                                                    <th style="padding:8px; text-align:center;">ÏÑ∏Ìä∏</th>
                                                    <th style="padding:8px; text-align:center;">ÎìùÏã§</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${(standings.groups?.[gi] || []).map((p, pi) => `
                                                    <tr style="border-bottom:1px solid var(--border); ${pi < advanceCount ? 'background:#e8f5e9; font-weight:600;' : ''}">
                                                        <td style="padding:8px; text-align:center;">${pi < advanceCount ? 'üèÜ' : ''} ${pi + 1}</td>
                                                        <td style="padding:8px;">${p.name}</td>
                                                        <td style="padding:8px; text-align:center;">${p.wins + p.losses}</td>
                                                        <td style="padding:8px; text-align:center;">${p.wins}</td>
                                                        <td style="padding:8px; text-align:center;">${p.losses}</td>
                                                        <td style="padding:8px; text-align:center;">+${p.setWins}/-${p.setLosses}</td>
                                                        <td style="padding:8px; text-align:center;">+${p.goalsFor}/-${p.goalsAgainst}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `).join('')}
                        ` : ''}
                        
                        ${standings.final?.length > 0 ? `
                            <h3 style="margin:16px 0 12px;">ÏµúÏ¢Ö ÏàúÏúÑ</h3>
                            <div>
                                ${standings.final.map((p, i) => `
                                    <div style="display:flex; align-items:center; padding:12px; margin:8px 0; background:${i === 0 ? '#fff3cd' : i === 1 ? '#e8e8e8' : i === 2 ? '#ffe4c4' : 'var(--bg-secondary)'}; border-radius:8px;">
                                        <span style="font-size:24px; margin-right:12px;">${i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : `${i + 1}ÏúÑ`}</span>
                                        <span style="font-weight:600;">${p.name}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${!currentProject.groups?.length && !standings.final?.length ? `
                            <div style="text-align:center; padding:40px; color:var(--text-secondary);">
                                <p>ÏàúÏúÑ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                                <p style="font-size:14px; margin-top:8px;">Ï°∞ Ìé∏ÏÑ± ÎòêÎäî Í≤ΩÍ∏∞ ÏßÑÌñâ ÌõÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
            else if (screen === 'statistics') {
                const stats = calculateStatistics();
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                        <h2>üìà ÌÜµÍ≥Ñ</h2>
                        
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
                            <div style="padding:16px; background:var(--bg-secondary); border-radius:8px; text-align:center;">
                                <div style="font-size:24px; font-weight:700; color:var(--primary);">${stats.totalMatches}</div>
                                <div style="font-size:14px; color:var(--text-secondary);">Ï¥ù Í≤ΩÍ∏∞</div>
                            </div>
                            <div style="padding:16px; background:var(--bg-secondary); border-radius:8px; text-align:center;">
                                <div style="font-size:24px; font-weight:700; color:var(--success);">${stats.completedMatches}</div>
                                <div style="font-size:14px; color:var(--text-secondary);">ÏôÑÎ£å Í≤ΩÍ∏∞</div>
                            </div>
                        </div>
                        
                        <!-- PDF Ï∂úÎ†• ÏÑπÏÖò -->
                        <div style="margin-bottom:20px; padding:16px; background:#fff3e0; border-radius:8px; border-left:4px solid #ff9800;">
                            <h3 style="margin-bottom:12px;">üìÑ PDF Ï∂úÎ†•</h3>
                            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                <button class="btn" onclick="exportTournamentReport()" style="background:#ff9800; color:white;">
                                    ÎåÄÌöå Í≤∞Í≥º Î≥¥Í≥†ÏÑú
                                </button>
                                <button class="btn" onclick="exportGroupStageReport()" style="background:#4caf50; color:white;">
                                    Ï°∞Î≥Ñ Î¶¨Í∑∏ Í∏∞Î°ù
                                </button>
                                <button class="btn" onclick="exportMatchRecords()" style="background:#2196f3; color:white;">
                                    üèì Í≤ΩÍ∏∞ Í∏∞Î°ùÏßÄ
                                </button>
                            </div>
                        </div>
                        
                        ${stats.playerStats?.length > 0 ? `
                            <h3 style="margin:16px 0 12px;">ÏÑ†ÏàòÎ≥Ñ ÌÜµÍ≥Ñ</h3>
                            <table style="width:100%; border-collapse:collapse; font-size:14px;">
                                <thead>
                                    <tr style="background:var(--bg-secondary);">
                                        <th style="padding:8px;">ÏÑ†Ïàò</th>
                                        <th style="padding:8px; text-align:center;">Í≤ΩÍ∏∞</th>
                                        <th style="padding:8px; text-align:center;">Ïäπ</th>
                                        <th style="padding:8px; text-align:center;">Ìå®</th>
                                        <th style="padding:8px; text-align:center;">ÏäπÎ•†</th>
                                        <th style="padding:8px; text-align:center;">ÎìùÏ†ê</th>
                                        <th style="padding:8px; text-align:center;">Ïã§Ï†ê</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${stats.playerStats.map(p => `
                                        <tr style="border-bottom:1px solid var(--border);">
                                            <td style="padding:8px;">${p.name}</td>
                                            <td style="padding:8px; text-align:center;">${p.matches}</td>
                                            <td style="padding:8px; text-align:center;">${p.wins}</td>
                                            <td style="padding:8px; text-align:center;">${p.losses}</td>
                                            <td style="padding:8px; text-align:center;">${p.winRate}%</td>
                                            <td style="padding:8px; text-align:center;">${p.goalsFor}</td>
                                            <td style="padding:8px; text-align:center;">${p.goalsAgainst}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : `
                            <div style="text-align:center; padding:40px; color:var(--text-secondary);">
                                <p>ÌÜµÍ≥Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>
                                <p style="font-size:14px; margin-top:8px;">Í≤ΩÍ∏∞ ÏßÑÌñâ ÌõÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.</p>
                            </div>
                        `}
                    </div>
                `;
            }
            // ========== ÏûêÎèô ÎåÄÌöå ÏßÑÌñâ ÌôîÎ©¥ ==========
            else if (screen === 'auto-tournament') {
                const isTeam = currentProject.competitionType === 'team';
                const hasResult = currentProject.autoTournamentResult;
                
                app.innerHTML = `
                    <div class="card">
                        <button class="btn" onclick="goTo('project-detail')" style="margin-bottom:16px;">‚Üê ÎèåÏïÑÍ∞ÄÍ∏∞</button>
                        <h2>ÏûêÎèô ÎåÄÌöå ÏßÑÌñâ</h2>
                        
                        <div style="margin-bottom:16px; padding:16px; background:#f3e5f5; border-radius:8px; border-left:4px solid #9c27b0;">
                            <strong>ÏûêÎèô ÎåÄÌöåÎûÄ?</strong>
                            <p style="font-size:13px; margin-top:4px; color:var(--text-secondary);">
                                ÏÑ§Ï†ïÎßå ÌïòÎ©¥ ÏÑ†Ïàò/ÌåÄ ÏÉùÏÑ±Î∂ÄÌÑ∞ Í≤ΩÍ∏∞ ÏßÑÌñâ, ÏµúÏ¢Ö ÏàúÏúÑÍπåÏßÄ ÏûêÎèôÏúºÎ°ú ÏßÑÌñâÎê©ÎãàÎã§.
                            </p>
                        </div>
                        
                        <div style="margin-bottom:20px; padding:16px; background:var(--bg-secondary); border-radius:8px;">
                            <h3 style="margin-bottom:12px;">Í∏∞Î≥∏ ÏÑ§Ï†ï</h3>
                            
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                                <div>
                                    <label for="auto-participant-count">${isTeam ? 'Ï∞∏Í∞Ä ÌåÄ Ïàò' : 'Ï∞∏Í∞Ä ÏÑ†Ïàò Ïàò'}</label>
                                    <input type="number" id="auto-participant-count" value="16" min="2" max="999" 
                                           oninput="updateGroupPreview()" style="width:100%;" aria-label="${isTeam ? 'Ï∞∏Í∞Ä ÌåÄ Ïàò' : 'Ï∞∏Í∞Ä ÏÑ†Ïàò Ïàò'} ÏûÖÎ†•">
                                </div>
                                <div>
                                    <label for="auto-group-count">Ï°∞ Í∞úÏàò</label>
                                    <input type="number" id="auto-group-count" value="4" min="1" max="99" 
                                           oninput="updateTopSeedInputs(); updateGroupPreview()" style="width:100%;" aria-label="Ï°∞ Í∞úÏàò ÏûÖÎ†•">
                                </div>
                            </div>
                            
                            <!-- Ï°∞ Ìé∏ÏÑ± ÎØ∏Î¶¨Î≥¥Í∏∞ -->
                            <div id="group-preview" style="margin-bottom:12px; padding:10px; background:#e3f2fd; border-radius:6px; font-size:13px;" aria-live="polite">
                                Ï°∞ Ìé∏ÏÑ±: AÏ°∞ 4Î™Ö, BÏ°∞ 4Î™Ö, CÏ°∞ 4Î™Ö, DÏ°∞ 4Î™Ö
                            </div>
                            
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                                <div>
                                    <label for="auto-advance-count">Ï°∞Î≥Ñ ÏßÑÏ∂úÏûê</label>
                                    <input type="number" id="auto-advance-count" value="2" min="1" max="10" style="width:100%;" aria-label="Ï°∞Î≥Ñ ÏßÑÏ∂úÏûê Ïàò ÏûÖÎ†•">
                                </div>
                                <div>
                                    <label for="auto-third-place">3/4ÏúÑ Í≤∞Ï†ïÏ†Ñ</label>
                                    <select id="auto-third-place" aria-label="3/4ÏúÑ Í≤∞Ï†ïÏ†Ñ ÏßÑÌñâ Ïó¨Î∂Ä ÏÑ†ÌÉù">
                                        <option value="yes" selected>ÏßÑÌñâ</option>
                                        <option value="no">ÏÉùÎûµ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ÌÉëÏãúÎìú ÏûÖÎ†• ÏÑπÏÖò -->
                        <div style="margin-bottom:20px; padding:16px; background:#fce4ec; border-radius:8px;">
                            <h3 style="margin-bottom:8px;">Ï°∞Î≥Ñ ÌÉëÏãúÎìú ÏûÖÎ†• (ÏÑ†ÌÉù)</h3>
                            <p style="font-size:12px; color:var(--text-secondary); margin-bottom:12px;">
                                ÏûÖÎ†•Ìïú Ïù¥Î¶ÑÏùÄ Í∞Å Ï°∞ 1Î≤à ÏãúÎìúÎ°ú Î∞∞Ï†ïÎê©ÎãàÎã§. ÎπÑÏõåÎëêÎ©¥ ÏûêÎèô ÏÉùÏÑ±Îê©ÎãàÎã§.
                            </p>
                            <div id="top-seed-inputs" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                                ${(() => {
                                    let inputs = '';
                                    for (let i = 0; i < 4; i++) {
                                        const letter = String.fromCharCode(65 + i);
                                        inputs += `<input type="text" placeholder="${letter}Ï°∞ ÌÉëÏãúÎìú" id="seed-${letter}" style="padding:8px; font-size:13px;">`;
                                    }
                                    return inputs;
                                })()}
                            </div>
                        </div>
                        
                        ${!isTeam ? `
                        <div style="margin-bottom:20px; padding:16px; background:#e3f2fd; border-radius:8px;">
                            <h3 style="margin-bottom:12px;">üèÖ ÏÑ∏Ìä∏ ÏÑ§Ï†ï (Í∞úÏù∏Ï†Ñ)</h3>
                            
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px;">
                                <div>
                                    <label>Ï°∞Î≥Ñ Î¶¨Í∑∏</label>
                                    <select id="auto-group-sets">
                                        <option value="3" selected>3ÏÑ∏Ìä∏ (2ÏÑ†Ïäπ)</option>
                                    </select>
                                </div>
                                <div>
                                    <label>5ÏÑ∏Ìä∏ ÏãúÏûë ÎùºÏö¥Îìú</label>
                                    <select id="auto-5set-start">
                                        <option value="final">Í≤∞ÏäπÎßå 5ÏÑ∏Ìä∏</option>
                                        <option value="semi">4Í∞ïÎ∂ÄÌÑ∞ 5ÏÑ∏Ìä∏</option>
                                        <option value="quarter" selected>8Í∞ïÎ∂ÄÌÑ∞ 5ÏÑ∏Ìä∏</option>
                                        <option value="r16">16Í∞ïÎ∂ÄÌÑ∞ 5ÏÑ∏Ìä∏</option>
                                        <option value="all">Î≥∏ÏÑ† Ï†ÑÏ≤¥ 5ÏÑ∏Ìä∏</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div style="margin-bottom:20px; padding:16px; background:#fff3e0; border-radius:8px;">
                            <h3 style="margin-bottom:12px;">ÏàúÏúÑ Í≤∞Ï†ï Î∞©Ïãù</h3>
                            
                            <div>
                                <label>Ï†ÑÏ≤¥ ÏàúÏúÑ ÏÇ∞Ï∂ú</label>
                                <select id="auto-ranking-type">
                                    <option value="knockout-only">Î≥∏ÏÑ† ÏßÑÏ∂úÏûêÎßå (4Í∞ï Ïù¥ÏÉÅ)</option>
                                    <option value="all-ranked" selected>Ï†ÑÏ≤¥ Ï∞∏Í∞ÄÏûê ÏàúÏúÑ Î∂ÄÏó¨</option>
                                </select>
                                <p style="font-size:11px; color:var(--text-secondary); margin-top:4px;">
                                    * Ï†ÑÏ≤¥ ÏàúÏúÑ: Ï°∞Î≥Ñ ÌÉàÎùΩÏûêÎäî Ï°∞ ÏàúÏúÑ + ÎìùÏã§Î°ú Ï†ÑÏ≤¥ ÏàúÏúÑ ÏÇ∞Ï∂ú
                                </p>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary" onclick="runAutoTournament()" style="width:100%; padding:16px; font-size:16px;">
                            üöÄ ÎåÄÌöå ÏûêÎèô ÏßÑÌñâ
                        </button>
                        
                        <div id="auto-tournament-result" style="display:${hasResult ? 'block' : 'none'}; margin-top:20px;">
                            ${hasResult ? renderAutoTournamentResult() : ''}
                        </div>
                    </div>
                `;
            }
            // ========== ÎåÄÏßÑ Í¥ÄÎ¶¨ ÌôîÎ©¥ ÎÅù ==========
            else if (screen === 'create-match') {
                app.innerHTML = `
                    <div class="card">
                        <h2>ÏÉà Í≤ΩÍ∏∞ ÏÉùÏÑ±</h2>
                        
                        <h3 style="margin-top:20px">Í≤ΩÍ∏∞ Ï†ïÎ≥¥</h3>
                        <label>Í≤ΩÍ∏∞ Ïú†Ìòï *</label>
                        <select id="match-type">
                            <option value="individual">Í∞úÏù∏Ï†Ñ</option>
                            <option value="team">ÌåÄÏ†Ñ</option>
                        </select>
                        <div id="sets-div">
                            <label>ÏÑ∏Ìä∏ Ïàò *</label>
                            <select id="sets">
                                <option value="3">3ÏÑ∏Ìä∏</option>
                                <option value="5">5ÏÑ∏Ìä∏</option>
                            </select>
                        </div>
                        
                        <h3 style="margin-top:20px">ÏÑ†Ïàò Ï†ïÎ≥¥</h3>
                        <label id="player1-label">ÏÑ†Ïàò 1 Ïù¥Î¶Ñ *</label>
                        <input type="text" id="player1" placeholder="ÏÑ†Ïàò 1" style="text-align:left;" autocomplete="off">
                        <label id="player2-label">ÏÑ†Ïàò 2 Ïù¥Î¶Ñ *</label>
                        <input type="text" id="player2" placeholder="ÏÑ†Ïàò 2" style="text-align:left;" autocomplete="off">
                        
                        <div id="team-lineup" style="display:none;">
                            <h3 style="margin-top:20px">ÌåÄ ÎùºÏù∏ÏóÖ</h3>
                            <label id="team1-lineup-label">ÌåÄ 1 ÎùºÏù∏ÏóÖ (3Î™Ö) *</label>
                            <input type="text" id="team1-player1" placeholder="ÏÑ†Ïàò 1 Ïù¥Î¶Ñ">
                            <input type="text" id="team1-player2" placeholder="ÏÑ†Ïàò 2 Ïù¥Î¶Ñ">
                            <input type="text" id="team1-player3" placeholder="ÏÑ†Ïàò 3 Ïù¥Î¶Ñ">
                            <label id="team2-lineup-label">ÌåÄ 2 ÎùºÏù∏ÏóÖ (3Î™Ö) *</label>
                            <input type="text" id="team2-player1" placeholder="ÏÑ†Ïàò 1 Ïù¥Î¶Ñ">
                            <input type="text" id="team2-player2" placeholder="ÏÑ†Ïàò 2 Ïù¥Î¶Ñ">
                            <input type="text" id="team2-player3" placeholder="ÏÑ†Ïàò 3 Ïù¥Î¶Ñ">
                        </div>
                        
                        <h3 style="margin-top:20px">Ïã¨Ìåê Ï†ïÎ≥¥</h3>
                        <label>Ï£ºÏã¨</label>
                        <input type="text" id="main-referee" placeholder="Ï£ºÏã¨ Ïù¥Î¶Ñ">
                        <label>Î∂ÄÏã¨</label>
                        <input type="text" id="assistant-referee" placeholder="Î∂ÄÏã¨ Ïù¥Î¶Ñ">
                        
                        <h3 style="margin-top:20px">ÏΩîÏπò Ï†ïÎ≥¥</h3>
                        <label id="coach1-label">ÏÑ†Ïàò 1 ÏΩîÏπò</label>
                        <input type="text" id="coach1" placeholder="ÏΩîÏπò Ïù¥Î¶Ñ">
                        <label id="coach2-label">ÏÑ†Ïàò 2 ÏΩîÏπò</label>
                        <input type="text" id="coach2" placeholder="ÏΩîÏπò Ïù¥Î¶Ñ">
                        
                        <h3 style="margin-top:20px">Î≥¥Ïïà ÏÑ§Ï†ï</h3>
                        <label>Ïã¨Ìåê PIN (6ÏûêÎ¶¨ Ïù¥ÏÉÅ) *</label>
                        <input type="password" id="referee-pin" placeholder="6ÏûêÎ¶¨ Ïù¥ÏÉÅ Ïà´Ïûê" maxlength="8" pattern="[0-9]{6,8}">
                        <p style="font-size:12px; color:var(--text-secondary); margin-top:4px;">
                            ÎìùÏ†ê ÏûÖÎ†• Ïãú ÌïÑÏöîÌï©ÎãàÎã§. ÏûäÏßÄ ÎßàÏÑ∏Ïöî!
                        </p>
                        
                        <div class="action-row">
                            <button type="button" class="btn btn-danger" onclick="goTo('project-detail')">Ï∑®ÏÜå</button>
                            <button type="button" class="btn btn-primary" onclick="createMatch()">Í≤ΩÍ∏∞ ÏãúÏûë</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('match-type').onchange = (e) => {
                    const isTeam = e.target.value === 'team';
                    document.getElementById('sets-div').style.display = isTeam ? 'none' : 'block';
                    document.getElementById('team-lineup').style.display = isTeam ? 'block' : 'none';
                    document.getElementById('player1-label').textContent = isTeam ? 'ÌåÄ 1 Ïù¥Î¶Ñ *' : 'ÏÑ†Ïàò 1 Ïù¥Î¶Ñ *';
                    document.getElementById('player2-label').textContent = isTeam ? 'ÌåÄ 2 Ïù¥Î¶Ñ *' : 'ÏÑ†Ïàò 2 Ïù¥Î¶Ñ *';
                    document.getElementById('coach1-label').textContent = isTeam ? 'ÌåÄ 1 ÏΩîÏπò' : 'ÏÑ†Ïàò 1 ÏΩîÏπò';
                    document.getElementById('coach2-label').textContent = isTeam ? 'ÌåÄ 2 ÏΩîÏπò' : 'ÏÑ†Ïàò 2 ÏΩîÏπò';
                };
            }
            else if (screen === 'match') {
                renderMatch();
            }
        }

        function renderMatch() {
            const app = document.getElementById('app');
            
            // currentMatch ÌôïÏù∏
            if (!currentMatch) {
                app.innerHTML = `
                    <div class="card">
                        <h2>Ïò§Î•ò</h2>
                        <p>Í≤ΩÍ∏∞ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                        <button type="button" class="btn btn-primary" onclick="goTo('project-detail')">Í≤ΩÍ∏∞ Î™©Î°ùÏúºÎ°ú</button>
                    </div>
                `;
                return;
            }
            
            // ÏôÑÎ£åÎêú Í≤ΩÍ∏∞Îäî Í∏∞Î°ùÎßå ÌëúÏãú
            if (currentMatch.status === 'completed') {
                renderFinishedMatch();
                return;
            }
            
            const set = currentMatch.setScores[currentMatch.currentSet - 1];
            const canEnd = Math.max(set.player1, set.player2) >= currentMatch.winScore && 
                          Math.abs(set.player1 - set.player2) >= 2;
            
            // ÏÑ∏Ìä∏ ÏäπÏàò Í≥ÑÏÇ∞
            let p1SetWins = 0, p2SetWins = 0;
            currentMatch.setScores.forEach((s, idx) => {
                if (idx < currentMatch.currentSet - 1) {
                    if (s.player1 > s.player2) p1SetWins++;
                    else if (s.player2 > s.player1) p2SetWins++;
                }
            });
            const winsNeeded = Math.ceil(currentMatch.sets / 2);
            
            app.innerHTML = `
                <div class="card">
                    ${
                        userRole === 'viewer' || !isAuthenticated
                            ? '<button class="btn" onclick="goToViewerHome()" style="margin-bottom:16px;">‚Üê Í¥ÄÎûå Î™®ÎìúÎ°ú</button>'
                            : currentMatch.isPractice
                                ? '<button class="btn" onclick="goTo(\'referee-home\')" style="margin-bottom:16px;">‚Üê Ïã¨Ìåê Î™®ÎìúÎ°ú</button>'
                                : '<button class="btn" onclick="goTo(\'project-detail\')" style="margin-bottom:16px;">‚Üê Í≤ΩÍ∏∞ Î™©Î°ù</button>'
                    }
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <div>
                            <div style="font-weight:600;">ÏÑ∏Ìä∏ ${currentMatch.currentSet}/${currentMatch.sets}</div>
                            <div style="font-size:12px; color:var(--text-secondary);">ÏÑ∏Ìä∏ Ïä§ÏΩîÏñ¥: ${p1SetWins} - ${p2SetWins} (${winsNeeded}ÏÑ†Ïäπ)</div>
                        </div>
                        <div style="display:flex; gap:12px; align-items:center;">
                            ${isAuthenticated ? 
                                '<span style="background:var(--success); color:white; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:600;">üîì Ïã¨Ìåê Î™®Îìú</span>' : 
                                '<span style="background:var(--warning); color:white; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:600;">Í¥ÄÎûå Î™®Îìú</span>'
                            }
                            <div style="font-size:12px; color:var(--text-secondary)">Ï£ºÏã¨: ${currentMatch.mainReferee || 'ÎØ∏Ï†ï'}</div>
                        </div>
                    </div>
                    
                    <!-- Ïã§ÏãúÍ∞Ñ Ï†êÏàò ÏòÅÏó≠ (aria-live) - ÏÑúÎ∏åÍ∂å Í∞ÄÏßÑ ÏÑ†ÏàòÍ∞Ä ÏôºÏ™Ω -->
                    <div aria-live="polite" aria-atomic="true" id="live-score-region">
                        ${currentMatch.currentServe === 'player1' ? `
                        <div class="score-grid">
                            <div class="player-score" style="border:3px solid var(--primary); border-radius:12px;">
                                <div class="player-name">üéæ ${currentMatch.player1Name}</div>
                                <div class="score-display" aria-label="${currentMatch.player1Name} ${set.player1}Ï†ê">${set.player1}</div>
                                ${currentMatch.team1Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team1Lineup.join(', ')}</div>` : ''}
                            </div>
                            <div style="font-size:24px; font-weight:700; color:var(--text-secondary)">:</div>
                            <div class="player-score">
                                <div class="player-name">${currentMatch.player2Name}</div>
                                <div class="score-display" aria-label="${currentMatch.player2Name} ${set.player2}Ï†ê">${set.player2}</div>
                                ${currentMatch.team2Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team2Lineup.join(', ')}</div>` : ''}
                            </div>
                        </div>
                        ` : `
                        <div class="score-grid">
                            <div class="player-score" style="border:3px solid var(--primary); border-radius:12px;">
                                <div class="player-name">üéæ ${currentMatch.player2Name}</div>
                                <div class="score-display" aria-label="${currentMatch.player2Name} ${set.player2}Ï†ê">${set.player2}</div>
                                ${currentMatch.team2Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team2Lineup.join(', ')}</div>` : ''}
                            </div>
                            <div style="font-size:24px; font-weight:700; color:var(--text-secondary)">:</div>
                            <div class="player-score">
                                <div class="player-name">${currentMatch.player1Name}</div>
                                <div class="score-display" aria-label="${currentMatch.player1Name} ${set.player1}Ï†ê">${set.player1}</div>
                                ${currentMatch.team1Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team1Lineup.join(', ')}</div>` : ''}
                            </div>
                        </div>
                        `}
                    </div>
                    
                    <!-- ÏµúÍ∑º ÎìùÏ†ê Ïã§ÏãúÍ∞Ñ ÏïåÎ¶º -->
                    <div aria-live="assertive" id="live-action-region" style="position:absolute; left:-9999px;">
                        ${currentMatch.history.length > 0 ? currentMatch.history[0].player + ' ' + currentMatch.history[0].points + 'Ï†ê ÎìùÏ†ê' : ''}
                    </div>
                    
                    <div style="text-align:center; padding:12px; background:var(--bg-secondary); border-radius:8px; margin-bottom:16px;">
                        ${currentMatch.serveSelected === false && isAuthenticated ? `
                            <div style="margin-bottom:12px; font-weight:600;">üéæ Ï≤´ ÏÑúÎ∏å ÏÑ†ÌÉù</div>
                            <div style="display:flex; gap:8px; justify-content:center;">
                                <button class="btn btn-primary" onclick="selectFirstServe('player1')" style="flex:1;">${currentMatch.player1Name}</button>
                                <button class="btn btn-primary" onclick="selectFirstServe('player2')" style="flex:1;">${currentMatch.player2Name}</button>
                            </div>
                        ` : `
                            <div class="serve-indicator">üéæ ${currentMatch.currentServe === 'player1' ? currentMatch.player1Name : currentMatch.player2Name} - ÏÑúÎ∏å ${currentMatch.serveCount + 1}ÌöåÏ∞®</div>
                            ${isAuthenticated ? `
                                <button class="btn" onclick="changeServe()" style="margin-top:8px; font-size:12px; padding:6px 12px;">ÏÑúÎ∏åÍ∂å Î≥ÄÍ≤Ω</button>
                            ` : ''}
                        `}
                    </div>
                    
                    ${(() => {
                        // Í≤ΩÍ∏∞Îãπ ÏõåÎ∞çÏóÖ 1ÌöåÎßå (IBSA Í∑úÏπô)
                        const warmupUsed = currentMatch.warmupUsed || false;
                        const canUseWarmup = isAuthenticated && !warmupActive && !warmupUsed;
                        const warmupTime = (currentMatch.type === 'team') ? 90 : 60; // IBSA: Í∞úÏù∏Ï†Ñ 60Ï¥à, ÌåÄÏ†Ñ 90Ï¥à
                        return canUseWarmup ? `
                        <div style="text-align:center; margin-bottom:16px;">
                            <button class="btn" onclick="startWarmup()" style="background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%); color:white;">
                                üî• ÏõåÎ∞çÏóÖ ${warmupTime}Ï¥à ÏãúÏûë
                            </button>
                        </div>
                    ` : '';
                    })()}
                    
                    ${warmupActive ? `
                        <div style="text-align:center; padding:16px; background:linear-gradient(135deg, #ff9800 0%, #ff5722 100%); color:white; border-radius:8px; margin-bottom:16px;">
                            <h3 style="margin:0; color:white;">üî• ÏõåÎ∞çÏóÖ ÏßÑÌñâ Ï§ë</h3>
                            <div style="font-size:36px; font-weight:700; margin:8px 0;" id="warmup-timer">${Math.floor(warmupSeconds / 60)}:${(warmupSeconds % 60).toString().padStart(2, '0')}</div>
                            <button class="btn" onclick="stopWarmup()" style="background:white; color:#ff5722;">ÏõåÎ∞çÏóÖ Ï¢ÖÎ£å</button>
                        </div>
                    ` : ''}
                    
                    ${isPaused ? `
                        <div style="text-align:center; padding:16px; background:var(--warning); color:white; border-radius:8px; margin-bottom:16px;">
                            <h3 style="margin:0; color:white;">‚è∏Ô∏è Í≤ΩÍ∏∞ ÏùºÏãúÏ†ïÏßÄ</h3>
                            <div style="font-size:24px; margin-top:8px;" id="pause-timer">${Math.floor(pauseSeconds / 60)}:${(pauseSeconds % 60).toString().padStart(2, '0')}</div>
                            <div style="margin-top:8px; font-size:14px;">${currentMatch.pauseReason || ''}</div>
                            <button class="btn" onclick="resumeMatch()" style="margin-top:12px;">‚ñ∂Ô∏è Í≤ΩÍ∏∞ Ïû¨Í∞ú</button>
                        </div>
                    ` : ''}
                    
                    ${isAuthenticated ? `
                    <h3 style="margin-bottom:8px;">‚è±Ô∏è ÌÉÄÏûÑÏïÑÏõÉ</h3>
                    <div class="timeout-section">
                        <button class="timeout-btn" onclick="startTimeout('player1')" ${currentMatch.timeouts.player1 === 0 || isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player1Name} ÌÉÄÏûÑÏïÑÏõÉ
                            <span class="timeout-count">ÎÇ®ÏùÄ ÌöüÏàò: ${currentMatch.timeouts.player1}</span>
                        </button>
                        <button class="timeout-btn" onclick="startTimeout('player2')" ${currentMatch.timeouts.player2 === 0 || isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player2Name} ÌÉÄÏûÑÏïÑÏõÉ
                            <span class="timeout-count">ÎÇ®ÏùÄ ÌöüÏàò: ${currentMatch.timeouts.player2}</span>
                        </button>
                    </div>
                    
                    <h3 style="margin-top:24px; margin-bottom:12px;">ÎìùÏ†ê Í∏∞Î°ù</h3>
                    
                    <!-- Í≥® ÎìùÏ†ê (Ï¢åÏö∞ Î∞∞Ïπò) -->
                    <div class="foul-grid">
                        <button class="foul-btn goal-btn" onclick="addScore('player1', 2, '${currentMatch.player1Name} Í≥®')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>Í≥® +2Ï†ê
                        </button>
                        <button class="foul-btn goal-btn" onclick="addScore('player2', 2, '${currentMatch.player2Name} Í≥®')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>Í≥® +2Ï†ê
                        </button>
                    </div>
                    
                    <!-- IBSA ÌååÏö∏ (ÏÉÅÎåÄ ÎìùÏ†ê 1Ï†ê) -->
                    <h4 style="margin:16px 0 8px; font-size:14px; color:var(--text-secondary);">ÌååÏö∏ +1Ï†ê (ÏÉÅÎåÄ ÎìùÏ†ê)</h4>
                    
                    <!-- Î∂ÄÏ†ï ÏÑúÎ∏å Irregular Serve -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} Î∂ÄÏ†ïÏÑúÎ∏å')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>Î∂ÄÏ†ïÏÑúÎ∏å
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} Î∂ÄÏ†ïÏÑúÎ∏å')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>Î∂ÄÏ†ïÏÑúÎ∏å
                        </button>
                    </div>
                    
                    <!-- ÏÑºÌÑ∞Î≥¥Îìú Centerboard -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} ÏÑºÌÑ∞Î≥¥Îìú')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ÏÑºÌÑ∞Î≥¥Îìú
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} ÏÑºÌÑ∞Î≥¥Îìú')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ÏÑºÌÑ∞Î≥¥Îìú
                        </button>
                    </div>
                    
                    <!-- Î∞îÎîîÌÑ∞Ïπò Body Touch -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} Î∞îÎîîÌÑ∞Ïπò')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>Î∞îÎîîÌÑ∞Ïπò
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} Î∞îÎîîÌÑ∞Ïπò')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>Î∞îÎîîÌÑ∞Ïπò
                        </button>
                    </div>
                    
                    <!-- ÏùºÎ¶¨Í±∏ ÎîîÌéúÏä§ Illegal Defense -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} ÏùºÎ¶¨Í±∏ÎîîÌéúÏä§')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ÏùºÎ¶¨Í±∏ÎîîÌéúÏä§
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} ÏùºÎ¶¨Í±∏ÎîîÌéúÏä§')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ÏùºÎ¶¨Í±∏ÎîîÌéúÏä§
                        </button>
                    </div>
                    
                    <!-- ÏïÑÏõÉ Out -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} ÏïÑÏõÉ')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ÏïÑÏõÉ
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} ÏïÑÏõÉ')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ÏïÑÏõÉ
                        </button>
                    </div>
                    
                    <!-- Î≥º ÌôÄÎî© Ball Infraction (2Ï¥à Ïù¥ÏÉÅ) -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} Î≥ºÌôÄÎî©')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>Î≥ºÌôÄÎî©(2Ï¥à)
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} Î≥ºÌôÄÎî©')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>Î≥ºÌôÄÎî©(2Ï¥à)
                        </button>
                    </div>
                    
                    <!-- Í≤ΩÍ≥† ÌõÑ Î≤åÏ†ê +2Ï†ê -->
                    <h4 style="margin:16px 0 8px; font-size:14px; color:var(--danger);">Î≤åÏ†ê +2Ï†ê (Í≤ΩÍ≥† ÌõÑ Î∞òÎ≥µ ÎòêÎäî Ï¶âÏãú)</h4>
                    
                    <!-- ÎßàÏä§ÌÅ¨ ÌÑ∞Ïπò (Ï¶âÏãú 2Ï†ê) -->
                    <div class="foul-grid">
                        <button class="foul-btn" style="background:#ffebee;" onclick="addScore('player2', 2, '${currentMatch.player1Name} ÎßàÏä§ÌÅ¨ÌÑ∞Ïπò')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ÎßàÏä§ÌÅ¨ÌÑ∞Ïπò +2
                        </button>
                        <button class="foul-btn" style="background:#ffebee;" onclick="addScore('player1', 2, '${currentMatch.player2Name} ÎßàÏä§ÌÅ¨ÌÑ∞Ïπò')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ÎßàÏä§ÌÅ¨ÌÑ∞Ïπò +2
                        </button>
                    </div>
                    
                    <!-- Í∏∞ÌÉÄ Î≤åÏ†ê (Í≤ΩÍ≥† ÌõÑ 2Ï†ê) -->
                    <div class="foul-grid">
                        <button class="foul-btn" style="background:#ffebee;" onclick="addScore('player2', 2, '${currentMatch.player1Name} Î≤åÏ†ê')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>Î≤åÏ†ê(Í∏∞ÌÉÄ) +2
                        </button>
                        <button class="foul-btn" style="background:#ffebee;" onclick="addScore('player1', 2, '${currentMatch.player2Name} Î≤åÏ†ê')" ${isTimeoutActive || isPaused ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>Î≤åÏ†ê(Í∏∞ÌÉÄ) +2
                        </button>
                    </div>
                    
                    <div class="action-row">
                        <button class="btn btn-danger" onclick="undo()" ${currentMatch.history.length === 0 ? 'disabled' : ''}>‚Ü©Ô∏è Ï∑®ÏÜå</button>
                        <button class="btn btn-success" onclick="endSet()">${(() => {
                            // ÌòÑÏû¨ÍπåÏßÄ ÏÑ∏Ìä∏ ÏäπÏàò Í≥ÑÏÇ∞
                            let p1Wins = 0, p2Wins = 0;
                            currentMatch.setScores.forEach((s, idx) => {
                                if (idx < currentMatch.currentSet - 1) {
                                    if (s.player1 > s.player2) p1Wins++;
                                    else if (s.player2 > s.player1) p2Wins++;
                                }
                            });
                            const winsNeeded = Math.ceil(currentMatch.sets / 2);
                            const currentSet = currentMatch.setScores[currentMatch.currentSet - 1];
                            const currentWinner = currentSet.player1 > currentSet.player2 ? 'p1' : 'p2';
                            const wouldWin = (currentWinner === 'p1' && p1Wins + 1 >= winsNeeded) || 
                                           (currentWinner === 'p2' && p2Wins + 1 >= winsNeeded);
                            return wouldWin ? 'Í≤ΩÍ∏∞ Ï¢ÖÎ£å' : 'ÏÑ∏Ìä∏ Ï¢ÖÎ£å';
                        })()}</button>
                    </div>
                    ` : `
                    <!-- Í¥ÄÎûå Î™®Îìú ÏïàÎÇ¥ -->
                    <div style="text-align:center; padding:24px; background:var(--bg-secondary); border-radius:12px; margin-top:16px;">
                        <span style="font-size:48px;">üëÅÔ∏è</span>
                        <h3 style="margin:12px 0;">Í¥ÄÎûå Î™®Îìú</h3>
                        <p style="color:var(--text-secondary);">Ïã§ÏãúÍ∞ÑÏúºÎ°ú Ï†êÏàòÍ∞Ä ÏóÖÎç∞Ïù¥Ìä∏Îê©ÎãàÎã§.</p>
                    </div>
                    `}
                    
                    ${isAuthenticated ? `
                        <div style="margin-top:16px; padding-top:16px; border-top:1px solid var(--border);">
                            <h3 style="margin-bottom:12px;">Í≤ΩÍ∏∞ Í¥ÄÎ¶¨</h3>
                            <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                <button class="btn" onclick="pauseMatch()" ${isPaused ? 'disabled' : ''}>‚è∏Ô∏è ÏùºÏãúÏ†ïÏßÄ</button>
                                <button class="btn" onclick="addMemo()">üìù Î©îÎ™® Ï∂îÍ∞Ä</button>
                                ${currentMatch.type === 'team' ? `<button class="btn" onclick="substitutePlayer()">ÏÑ†Ïàò ÍµêÏ≤¥</button>` : ''}
                                <button class="btn" onclick="showQRCode()">üì± QR Í≥µÏú†</button>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                ${currentMatch.history.length > 0 ? `
                    <div class="card">
                        <h2>Í≤ΩÍ∏∞ Í∏∞Î°ù</h2>
                        <div style="margin-bottom:12px; display:flex; gap:8px;">
                            <button class="btn" onclick="toggleHistoryOrder()" id="history-order-btn" style="font-size:12px; padding:6px 12px;">ÏµúÏã†Ïàú ‚Üì</button>
                        </div>
                        <div id="match-history">
                            ${(() => {
                                // ÏÑ∏Ìä∏Î≥ÑÎ°ú Í∑∏Î£πÌôî
                                const setGroups = {};
                                currentMatch.history.forEach(h => {
                                    const setNum = h.set || 1;
                                    if (!setGroups[setNum]) setGroups[setNum] = [];
                                    setGroups[setNum].push(h);
                                });
                                
                                // ÏÑ∏Ìä∏ Î≤àÌò∏ ÎÇ¥Î¶ºÏ∞®ÏàúÏúºÎ°ú Ï†ïÎ†¨ÌïòÏó¨ Ï∂úÎ†•
                                return Object.keys(setGroups).sort((a, b) => b - a).map(setNum => {
                                    const setHistory = setGroups[setNum].slice(0, 10);
                                    const setScore = currentMatch.setScores[setNum - 1];
                                    return `
                                        <div style="margin-bottom:16px;">
                                            <h3 style="color:var(--primary); border-bottom:2px solid var(--primary); padding-bottom:8px; margin-bottom:12px;">
                                                ÏÑ∏Ìä∏ ${setNum} ${setScore ? `(${setScore.player1}:${setScore.player2})` : ''}
                                            </h3>
                                            ${setHistory.map(h => {
                                                let actionDesc = '';
                                                if (h.type.includes('Í≥®')) {
                                                    actionDesc = h.player + ' Í≥®';
                                                } else {
                                                    const foulType = h.type.split(' ').slice(1).join(' ');
                                                    actionDesc = (h.actionPlayer || h.type.split(' ')[0]) + ' ' + foulType + ' (' + h.player + ' ÎìùÏ†ê)';
                                                }
                                                
                                                return '<div style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:6px;">' +
                                                    '<div style="display:flex; justify-content:space-between; margin-bottom:4px;">' +
                                                        '<span style="font-size:12px; color:var(--text-secondary);">' + h.time + ' - ' + (h.server || h.player) + ' ÏÑúÎ∏å ' + (h.serveNumber || '') + 'ÌöåÏ∞®</span>' +
                                                        (h.scoreBefore ? '<span style="font-size:12px; color:var(--text-secondary);">(' + h.scoreBefore.player1 + ':' + h.scoreBefore.player2 + ')</span>' : '') +
                                                    '</div>' +
                                                    '<div style="display:flex; justify-content:space-between; align-items:center;">' +
                                                        '<span>' + actionDesc + '</span>' +
                                                        '<span style="font-weight:700; color:var(--primary);">' + h.points + 'Ï†ê ÎìùÏ†ê</span>' +
                                                    '</div>' +
                                                    (h.scoreAfter ? '<div style="margin-top:6px; padding-top:6px; border-top:1px solid var(--border);"><span style="font-size:13px; font-weight:600; color:var(--success);">‚Üí Ïä§ÏΩîÏñ¥: ' + h.scoreAfter.player1 + ':' + h.scoreAfter.player2 + '</span></div>' : '') +
                                                '</div>';
                                            }).join('')}
                                        </div>
                                    `;
                                }).join('');
                            })()}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function renderFinishedMatch() {
            const app = document.getElementById('app');
            
            // ÏÑ∏Ìä∏Î≥Ñ Ï†êÏàò Í≥ÑÏÇ∞
            const setResults = currentMatch.setScores.map((s, idx) => {
                const winner = s.player1 > s.player2 ? currentMatch.player1Name : currentMatch.player2Name;
                return `ÏÑ∏Ìä∏ ${idx + 1}: ${s.player1}-${s.player2} (${winner} Ïäπ)`;
            }).join(' | ');
            
            // ÏµúÏ¢Ö Ï†êÏàò
            const finalSet = currentMatch.setScores[currentMatch.setScores.length - 1];
            const winner = currentMatch.setScores.filter((s, idx) => idx < currentMatch.setScores.length && s.player1 > s.player2).length > 
                          currentMatch.setScores.filter((s, idx) => idx < currentMatch.setScores.length && s.player2 > s.player1).length 
                          ? currentMatch.player1Name : currentMatch.player2Name;
            
            app.innerHTML = `
                <div class="card">
                    <button class="btn btn-primary" onclick="goTo('project-detail')" style="margin-bottom:16px;">‚Üê Í≤ΩÍ∏∞ Î™©Î°ùÏúºÎ°ú</button>
                    <div style="text-align:center; padding:16px; background:var(--success); color:white; border-radius:8px; margin-bottom:16px;">
                        <h2 style="margin:0; color:white;">Í≤ΩÍ∏∞ Ï¢ÖÎ£å</h2>
                        <div style="font-size:18px; margin-top:8px;">ÏäπÏûê: ${winner}</div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <div style="font-weight:600;">Í≤ΩÍ∏∞ Ï†ïÎ≥¥</div>
                        <div style="font-size:12px; color:var(--text-secondary)">Ï£ºÏã¨: ${currentMatch.mainReferee || 'ÎØ∏Ï†ï'}</div>
                    </div>
                    
                    <div class="score-grid">
                        <div class="player-score">
                            <div class="player-name">${currentMatch.player1Name}</div>
                            <div class="score-display">${finalSet.player1}</div>
                            ${currentMatch.team1Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team1Lineup.join(', ')}</div>` : ''}
                        </div>
                        <div style="font-size:24px; font-weight:700; color:var(--text-secondary)">VS</div>
                        <div class="player-score">
                            <div class="player-name">${currentMatch.player2Name}</div>
                            <div class="score-display">${finalSet.player2}</div>
                            ${currentMatch.team2Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team2Lineup.join(', ')}</div>` : ''}
                        </div>
                    </div>
                    
                    <div style="padding:12px; background:var(--bg-secondary); border-radius:8px; margin-top:16px;">
                        <div style="font-size:14px; font-weight:600; margin-bottom:8px;">ÏÑ∏Ìä∏Î≥Ñ Í≤∞Í≥º</div>
                        <div style="font-size:14px;">${setResults}</div>
                    </div>
                </div>
                
                ${currentMatch.history.length > 0 ? `
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                            <h2 style="margin:0;">Ï†ÑÏ≤¥ Í≤ΩÍ∏∞ Í∏∞Î°ù</h2>
                            <button class="btn" onclick="toggleFinishedHistoryOrder()" id="finished-history-order-btn" style="font-size:12px; padding:6px 12px;">${finishedHistoryOrderDesc ? 'ÏµúÏã†Ïàú ‚Üì' : 'Ïò§ÎûòÎêúÏàú ‚Üë'}</button>
                        </div>
                        <div id="finished-match-history">
                            ${(() => {
                                // ÏÑ∏Ìä∏Î≥ÑÎ°ú Í∑∏Î£πÌôî
                                const setGroups = {};
                                currentMatch.history.forEach(h => {
                                    const setNum = h.set || 1;
                                    if (!setGroups[setNum]) setGroups[setNum] = [];
                                    setGroups[setNum].push(h);
                                });
                                
                                // Ï†ïÎ†¨ ÏàúÏÑú Í≤∞Ï†ï
                                const setKeys = Object.keys(setGroups).sort((a, b) => 
                                    finishedHistoryOrderDesc ? b - a : a - b
                                );
                                
                                return setKeys.map(setNum => {
                                    let setHistory = setGroups[setNum];
                                    // Ïò§ÎûòÎêúÏàúÏù¥Î©¥ ÏÑ∏Ìä∏ ÎÇ¥ Í∏∞Î°ùÎèÑ Ïó≠ÏàúÏúºÎ°ú (ÏãúÍ∞ÑÏàú)
                                    if (!finishedHistoryOrderDesc) {
                                        setHistory = [...setHistory].reverse();
                                    }
                                    const setScore = currentMatch.setScores[setNum - 1];
                                    return `
                                        <div style="margin-bottom:16px;">
                                            <h3 style="color:var(--primary); border-bottom:2px solid var(--primary); padding-bottom:8px; margin-bottom:12px;">
                                                ÏÑ∏Ìä∏ ${setNum} ${setScore ? `(${setScore.player1}:${setScore.player2})` : ''}
                                            </h3>
                                            ${setHistory.map(h => {
                                                let actionDesc = '';
                                                if (h.type.includes('Í≥®')) {
                                                    actionDesc = h.player + ' Í≥®';
                                                } else {
                                                    const foulType = h.type.split(' ').slice(1).join(' ');
                                                    actionDesc = (h.actionPlayer || h.type.split(' ')[0]) + ' ' + foulType + ' (' + h.player + ' ÎìùÏ†ê)';
                                                }
                                                
                                                return '<div style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:6px;">' +
                                                    '<div style="display:flex; justify-content:space-between; margin-bottom:4px;">' +
                                                        '<span style="font-size:12px; color:var(--text-secondary);">' + h.time + ' - ' + (h.server || h.player) + ' ÏÑúÎ∏å ' + (h.serveNumber || '') + 'ÌöåÏ∞®</span>' +
                                                        (h.scoreBefore ? '<span style="font-size:12px; color:var(--text-secondary);">(' + h.scoreBefore.player1 + ':' + h.scoreBefore.player2 + ')</span>' : '') +
                                                    '</div>' +
                                                    '<div style="display:flex; justify-content:space-between; align-items:center;">' +
                                                        '<span>' + actionDesc + '</span>' +
                                                        '<span style="font-weight:700; color:var(--primary);">' + h.points + 'Ï†ê ÎìùÏ†ê</span>' +
                                                    '</div>' +
                                                    (h.scoreAfter ? '<div style="margin-top:6px; padding-top:6px; border-top:1px solid var(--border);"><span style="font-size:13px; font-weight:600; color:var(--success);">‚Üí Ïä§ÏΩîÏñ¥: ' + h.scoreAfter.player1 + ':' + h.scoreAfter.player2 + '</span></div>' : '') +
                                                '</div>';
                                            }).join('')}
                                        </div>
                                    `;
                                }).join('');
                            })()}
                        </div>
                    </div>
                ` : ''}
            `;
        }
        
        function selectRole(role) {
            userRole = role;
            if (role === 'referee') {
                // Ïã¨Ìåê Î™®Îìú - ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏
                const refPasswords = JSON.parse(localStorage.getItem('refereePasswords') || '{}');
                if (Object.keys(refPasswords).length === 0) {
                    alert('Îì±Î°ùÎêú Ïã¨ÌåêÏù¥ ÏóÜÏäµÎãàÎã§.\nÍ¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                screen = 'referee-password';
            } else {
                isAuthenticated = false;
                screen = 'viewer-home';
            }
            render();
        }

        function goTo(s) {
            screen = s;
            render();
        }
        
        // ÏßÑÌñâ Ï§ëÏù∏ Ïó∞Ïäµ Í≤ΩÍ∏∞ Î≥µÍµ¨
        function resumePractice() {
            try {
                const state = JSON.parse(sessionStorage.getItem('practiceState'));
                currentProject = projects.find(p => p.id === state.projectId);
                currentMatch = currentProject.matches.find(m => m.id === state.matchId);
                isAuthenticated = true;
                screen = 'match';
                render();
            } catch (e) {
                alert('Í≤ΩÍ∏∞Î•º Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
                sessionStorage.removeItem('practiceState');
                render();
            }
        }
        
        // Í¥ÄÎûåÏûêÏö© Ìôà Ïù¥Îèô
        function goToViewerHome() {
            if (currentMatch && currentMatch.isShared) {
                goTo('live-practice');
            } else {
                goTo('viewer-home');
            }
            currentProject = null;
            currentMatch = null;
            isAuthenticated = false;
            userRole = 'viewer';
        }
        
        // ÎåÄÌöå Ïú†Ìòï Î≥ÄÍ≤Ω Ïãú
        // ÎåÄÌöå Ïú†Ìòï Ïπ¥Îìú ÏÑ†ÌÉù
        function selectTournamentType(type) {
            // Ïà®Í≤®ÏßÑ input Í∞í ÏÑ§Ï†ï
            document.getElementById('tournament-type').value = type;
            
            // Ïπ¥Îìú Ïä§ÌÉÄÏùº ÏóÖÎç∞Ïù¥Ìä∏
            const cards = document.querySelectorAll('.tournament-type-btn');
            cards.forEach(card => {
                if (card.dataset.type === type) {
                    card.style.borderColor = 'var(--primary)';
                    card.style.background = '#e3f2fd';
                } else {
                    card.style.borderColor = '#ddd';
                    card.style.background = 'white';
                }
            });
            
            // ÏÑ§Ï†ï Ìå®ÎÑê ÌëúÏãú/Ïà®ÍπÄ
            onTournamentTypeChange();
        }
        
        function onTournamentTypeChange() {
            const type = document.getElementById('tournament-type').value;
            document.getElementById('group-settings').style.display = 
                (type === 'group' || type === 'group-tournament') ? 'block' : 'none';
            document.getElementById('tournament-settings').style.display = 
                (type === 'tournament' || type === 'group-tournament') ? 'block' : 'none';
        }
        
        function onCompetitionTypeChange() {
            const type = document.getElementById('competition-type').value;
            const teamSettings = document.getElementById('team-settings');
            const unitLabel = document.getElementById('tournament-unit');
            
            if (type === 'team') {
                teamSettings.style.display = 'block';
                if (unitLabel) unitLabel.textContent = 'ÌåÄ';
            } else {
                teamSettings.style.display = 'none';
                if (unitLabel) unitLabel.textContent = 'Ïù∏Ïõê';
            }
        }

        function createProject() {
            const name = document.getElementById('project-name').value.trim();
            if (!name) {
                alert('ÌîÑÎ°úÏ†ùÌä∏Î™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                return;
            }
            
            const competitionType = document.getElementById('competition-type')?.value || 'individual';
            const tournamentType = document.getElementById('tournament-type').value;
            
            const project = {
                id: Date.now(),
                name,
                date: document.getElementById('project-date').value,
                location: document.getElementById('project-location').value,
                desc: document.getElementById('project-desc').value,
                matches: [],
                createdAt: new Date().toISOString(),
                // ÎåÄÌöå ÏÑ§Ï†ï
                competitionType: competitionType, // 'individual' or 'team'
                tournamentType: tournamentType,
                groups: [], // Ï°∞Î≥Ñ Î¶¨Í∑∏ Ï°∞ Ï†ïÎ≥¥
                players: [], // Í∞úÏù∏Ï†Ñ: ÏÑ†Ïàò Î™©Î°ù
                teams: [], // ÌåÄÏ†Ñ: ÌåÄ Î™©Î°ù
                bracket: null, // ÌÜ†ÎÑàÎ®ºÌä∏ ÎåÄÏßÑÌëú
                standings: [] // ÏµúÏ¢Ö ÏàúÏúÑ
            };
            
            // Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏÑ§Ï†ï
            if (tournamentType === 'group' || tournamentType === 'group-tournament') {
                project.groupSettings = {
                    groupCount: parseInt(document.getElementById('group-count').value) || 2,
                    advanceCount: parseInt(document.getElementById('advance-count').value) || 2,
                    setsPerMatch: 3 // ÏòàÏÑ†ÏùÄ Ìï≠ÏÉÅ 3ÏÑ∏Ìä∏
                };
            }
            
            // ÌÜ†ÎÑàÎ®ºÌä∏ ÏÑ§Ï†ï
            if (tournamentType === 'tournament' || tournamentType === 'group-tournament') {
                project.tournamentSettings = {
                    size: parseInt(document.getElementById('tournament-size').value) || 8,
                    thirdPlaceMatch: document.getElementById('third-place-match').checked,
                    setsPerMatch: 5 // Î≥∏ÏÑ†ÏùÄ 5ÏÑ∏Ìä∏
                };
            }
            
            console.log('ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± ÏãúÎèÑ:', project);
            
            // Î°úÏª¨Ïóê Ï∂îÍ∞Ä
            projects.push(project);
            
            // Firebase ÎèôÍ∏∞Ìôî
            syncProjectToFirebase(project);
            
            // Î°úÏª¨ Ï†ÄÏû•
            localStorage.setItem('projects', JSON.stringify(projects));
            
            console.log('‚úÖ ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± ÏôÑÎ£å:', project.name);
            goTo('project-list');
        }

        function selectProject(index) {
            currentProject = projects[index];
            goTo('project-detail');
        }
        
        // ÌîÑÎ°úÏ†ùÌä∏ Í≤ÄÏÉâ
        function searchProjects() {
            const query = document.getElementById('project-search').value.trim();
            window.projectSearchQuery = query;
            render();
        }
        
        // Í≤ÄÏÉâ Ï¥àÍ∏∞Ìôî
        function clearSearch() {
            window.projectSearchQuery = '';
            render();
        }

        function createMatch() {
            // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨ Ìï®Ïàò
            function validateField(id, message) {
                const el = document.getElementById(id);
                const value = el ? el.value.trim() : '';
                if (!value) {
                    alert(message);
                    if (el) el.focus();
                    return null;
                }
                return value;
            }
            
            const type = document.getElementById('match-type').value;
            
            // ÏÑ†Ïàò/ÌåÄ Ïù¥Î¶Ñ Í≤ÄÏÇ¨
            const player1 = validateField('player1', type === 'team' ? 'ÌåÄ 1 Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî' : 'ÏÑ†Ïàò 1 Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
            if (!player1) return;
            
            const player2 = validateField('player2', type === 'team' ? 'ÌåÄ 2 Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî' : 'ÏÑ†Ïàò 2 Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
            if (!player2) return;
            
            // PIN Í≤ÄÏÇ¨
            const pinEl = document.getElementById('referee-pin');
            const pin = pinEl ? pinEl.value.trim() : '';
            if (!pin) {
                alert('Ïã¨Ìåê PINÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                if (pinEl) pinEl.focus();
                return;
            }
            if (pin.length < 6) {
                alert('Ïã¨Ìåê PINÏùÄ 6ÏûêÎ¶¨ Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§');
                if (pinEl) pinEl.focus();
                return;
            }
            if (!/^\d+$/.test(pin)) {
                alert('Ïã¨Ìåê PINÏùÄ Ïà´ÏûêÎßå ÏûÖÎ†• Í∞ÄÎä•Ìï©ÎãàÎã§');
                if (pinEl) pinEl.focus();
                return;
            }
            
            // ÌåÄÏ†ÑÏùº Í≤ΩÏö∞ ÎùºÏù∏ÏóÖ ÌôïÏù∏
            let team1Lineup = null;
            let team2Lineup = null;
            if (type === 'team') {
                const t1p1 = validateField('team1-player1', 'ÌåÄ 1 ÏÑ†Ïàò 1 Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                if (!t1p1) return;
                const t1p2 = validateField('team1-player2', 'ÌåÄ 1 ÏÑ†Ïàò 2 Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                if (!t1p2) return;
                const t1p3 = validateField('team1-player3', 'ÌåÄ 1 ÏÑ†Ïàò 3 Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                if (!t1p3) return;
                const t2p1 = validateField('team2-player1', 'ÌåÄ 2 ÏÑ†Ïàò 1 Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                if (!t2p1) return;
                const t2p2 = validateField('team2-player2', 'ÌåÄ 2 ÏÑ†Ïàò 2 Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                if (!t2p2) return;
                const t2p3 = validateField('team2-player3', 'ÌåÄ 2 ÏÑ†Ïàò 3 Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                if (!t2p3) return;
                
                team1Lineup = [t1p1, t1p2, t1p3];
                team2Lineup = [t2p1, t2p2, t2p3];
            }

            const sets = type === 'individual' ? parseInt(document.getElementById('sets').value) : 1;
            const match = {
                id: Date.now(),
                type,
                sets,
                player1Name: player1,
                player2Name: player2,
                team1Lineup,
                team2Lineup,
                mainReferee: document.getElementById('main-referee')?.value.trim() || '',
                assistantReferee: document.getElementById('assistant-referee')?.value.trim() || '',
                coach1: document.getElementById('coach1')?.value.trim() || '',
                coach2: document.getElementById('coach2')?.value.trim() || '',
                refereePin: pin,
                winScore: type === 'individual' ? 11 : 31,
                currentSet: 1,
                setScores: [{player1: 0, player2: 0}],
                currentServe: 'player1',
                serveCount: 0,
                serveSelected: false, // ÏÑúÎ∏å ÎØ∏ÏÑ†ÌÉù ÏÉÅÌÉú
                timeouts: {
                    player1: 1,
                    player2: 1
                },
                sideChangeUsed: false,
                status: 'active',
                history: [],
                warmupUsed: false,
                createdAt: new Date().toISOString(),
                // Ïä§ÏºÄÏ§Ñ Í¥ÄÎ†® ÌïÑÎìú Ï∂îÍ∞Ä
                scheduledDate: null, // Í≤ΩÍ∏∞ ÏòàÏ†ï ÎÇ†Ïßú (YYYY-MM-DD)
                scheduledTime: null, // Í≤ΩÍ∏∞ ÏòàÏ†ï ÏãúÍ∞Ñ (HH:MM)
                estimatedDuration: 30, // ÏòàÏÉÅ ÏÜåÏöî ÏãúÍ∞Ñ (Î∂Ñ)
                courtName: '', // Î∞∞Ï†ïÎêú Í≤ΩÍ∏∞Ïû•
                mainRefereeName: '', // Î∞∞Ï†ïÎêú Ï£ºÏã¨
                round: '', // Í≤ΩÍ∏∞ ÎùºÏö¥Îìú (ÏòàÏÑ†/Î≥∏ÏÑ†/Í≤∞Ïäπ Îì±)
                matchOrder: 0 // Í≤ΩÍ∏∞ ÏàúÏÑú
            };
            
            // currentProject ÌôïÏù∏
            if (!currentProject) {
                alert('ÌîÑÎ°úÏ†ùÌä∏Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');
                goTo('project-list');
                return;
            }
            
            if (!currentProject.matches) {
                currentProject.matches = [];
            }
            
            currentProject.matches.push(match);
            currentMatch = match;
            isAuthenticated = true;
            
            // Ï†ÄÏû• (Î°úÏª¨ Ïö∞ÏÑ†)
            try {
                if (database && currentProject.firebaseKey) {
                    database.ref('projects/' + currentProject.firebaseKey).set(currentProject);
                } else {
                    // Î°úÏª¨ Ï†ÄÏû•
                    const idx = projects.findIndex(p => p.id === currentProject.id);
                    if (idx >= 0) {
                        projects[idx] = currentProject;
                    }
                    localStorage.setItem('projects', JSON.stringify(projects));
                }
            } catch (e) {
                localStorage.setItem('projects', JSON.stringify(projects));
            }
            
            // Í≤ΩÍ∏∞ ÏÉùÏÑ± ÏôÑÎ£å ÌõÑ Í≤ΩÍ∏∞ Î™©Î°ùÏúºÎ°ú Ïù¥Îèô
            alert('Í≤ΩÍ∏∞Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!');
            screen = 'project-detail';
            render();
        }

        function selectMatch(index) {
            matchSelectionInProgress = true; // Í≤ΩÍ∏∞ ÏÑ†ÌÉù ÏãúÏûë
            isUserAction = true;
            currentMatch = currentProject.matches[index];
            
            // ÏôÑÎ£åÎêú Í≤ΩÍ∏∞Îäî Ïù∏Ï¶ù Î∂àÌïÑÏöî
            if (currentMatch.status === 'completed') {
                isAuthenticated = false;
                screen = 'match';
                render();
                setTimeout(() => { matchSelectionInProgress = false; isUserAction = false; }, 2000);
                return;
            }
            
            // Í¥ÄÎûå Î™®ÎìúÎ°ú Ï†ëÏÜçÌñàÏúºÎ©¥ Î∞îÎ°ú Î≥¥Í∏∞
            if (userRole === 'viewer') {
                isAuthenticated = false;
                screen = 'match';
                render();
                setTimeout(() => { matchSelectionInProgress = false; isUserAction = false; }, 2000);
                return;
            }
            
            // Ïã¨Ìåê Î™®Îìú - Î®ºÏ†Ä screenÏùÑ matchÎ°ú ÏÑ§Ï†ï (Firebase Î∞©Ïñ¥)
            screen = 'match';
            
            // PIN ÌôïÏù∏
            const inputPin = prompt('Ïã¨Ìåê PINÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            
            if (inputPin === currentMatch.refereePin) {
                isAuthenticated = true;
                render();
                setTimeout(() => { matchSelectionInProgress = false; isUserAction = false; }, 2000);
            } else {
                // PIN ÌãÄÎ¶¨Î©¥ ÏõêÎûò ÌôîÎ©¥ÏúºÎ°ú
                screen = 'project-detail';
                currentMatch = null;
                isAuthenticated = false;
                alert('PINÏù¥ ÌãÄÎ†∏ÏäµÎãàÎã§.');
                render();
                setTimeout(() => { matchSelectionInProgress = false; isUserAction = false; }, 500);
            }
        }

        let lastScoreTime = 0; // ÎçîÎ∏îÌÅ¥Î¶≠ Î∞©ÏßÄ
        
        function addScore(player, points, type) {
            // ÎçîÎ∏îÌÅ¥Î¶≠ Î∞©ÏßÄ (500ms Ïù¥ÎÇ¥ Ïû¨ÌÅ¥Î¶≠ Î¨¥Ïãú)
            const now = Date.now();
            if (now - lastScoreTime < 500) {
                console.log('ÎçîÎ∏îÌÅ¥Î¶≠ Î∞©ÏßÄ');
                return;
            }
            lastScoreTime = now;
            
            // Ïù∏Ï¶ù ÌôïÏù∏
            if (!isAuthenticated) {
                alert('Ïã¨ÌåêÎßå ÎìùÏ†êÏùÑ ÏûÖÎ†•Ìï† Ïàò ÏûàÏäµÎãàÎã§');
                return;
            }
            
            const set = currentMatch.setScores[currentMatch.currentSet - 1];
            // ÎìùÏ†ê Ï†Ñ Ïä§ÏΩîÏñ¥ Ï†ÄÏû•
            const scoreBefore = { player1: set.player1, player2: set.player2 };
            
            if (player === 'player1') set.player1 += points;
            else set.player2 += points;
            
            // ÎìùÏ†ê ÌõÑ Ïä§ÏΩîÏñ¥ Ï†ÄÏû•
            const scoreAfter = { player1: set.player1, player2: set.player2 };
            
            // ÌòÑÏû¨ ÏÑúÎ∏å Ï†ïÎ≥¥ Ï†ÄÏû•
            const servingPlayer = currentMatch.currentServe === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            const serveNumber = currentMatch.serveCount + 1;
            
            currentMatch.history.unshift({
                time: new Date().toLocaleTimeString('ko-KR'),
                player: player === 'player1' ? currentMatch.player1Name : currentMatch.player2Name, // ÎìùÏ†êÌïú ÏÑ†Ïàò
                actionPlayer: type.includes('Í≥®') ? (player === 'player1' ? currentMatch.player1Name : currentMatch.player2Name) : type.split(' ')[0], // Ïï°ÏÖòÌïú ÏÑ†Ïàò (Í≥® ÎòêÎäî ÌååÏö∏Ìïú ÏÑ†Ïàò)
                type,
                points,
                set: currentMatch.currentSet,
                server: servingPlayer,
                serveNumber: serveNumber,
                scoreBefore: scoreBefore,
                scoreAfter: scoreAfter
            });
            
            currentMatch.serveCount++;
            // IBSA Í∑úÏπô: Í∞úÏù∏Ï†Ñ 2Ìöå, ÌåÄÏ†Ñ 3Ìöå (type ÏóÜÏúºÎ©¥ Í∞úÏù∏Ï†ÑÏúºÎ°ú Ï≤òÎ¶¨)
            const maxServes = (currentMatch.type === 'team') ? 3 : 2;
            if (currentMatch.serveCount >= maxServes) {
                currentMatch.currentServe = currentMatch.currentServe === 'player1' ? 'player2' : 'player1';
                currentMatch.serveCount = 0;
            }
            
            const score = player === 'player1' ? set.player1 : set.player2;
            const playerName = player === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            
            saveProjects();
            updateLiveMatch(); // Ïã§ÏãúÍ∞Ñ Í≥µÏú† ÏóÖÎç∞Ïù¥Ìä∏
            renderMatch();
            
            // aria-live Ïã§ÏãúÍ∞Ñ ÏïàÎÇ¥ (ÏÑúÎ∏åÍ∂å Í∏∞Ï§Ä Ïä§ÏΩîÏñ¥ ÏàúÏÑú)
            const nextServer = currentMatch.currentServe === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            const nextServeCount = currentMatch.serveCount + 1;
            // ÏÑúÎ∏åÍ∂å Í∞ÄÏßÑ ÏÑ†Ïàò Ïä§ÏΩîÏñ¥Î•º Î®ºÏ†Ä
            const serverScore = currentMatch.currentServe === 'player1' ? set.player1 : set.player2;
            const receiverScore = currentMatch.currentServe === 'player1' ? set.player2 : set.player1;
            const announcement = `${playerName} ${points}Ï†ê. Ïä§ÏΩîÏñ¥ ${serverScore} ÎåÄ ${receiverScore}. ${nextServer} ${nextServeCount}Î≤àÏß∏ ÏÑúÎ∏å`;
            announce(announcement);
            
            // ÏÇ¨Ïù¥Îìú Ï≤¥Ïù∏ÏßÄ Ï≤¥ÌÅ¨
            // Í∞úÏù∏Ï†Ñ: ÎßàÏßÄÎßâ ÏÑ∏Ìä∏ÏóêÏÑú Î®ºÏ†Ä 6Ï†ê ÎèÑÎã¨ Ïãú, ÌåÄÏ†Ñ: Î®ºÏ†Ä 16Ï†ê ÎèÑÎã¨ Ïãú
            let shouldCheckSideChange = false;
            if (currentMatch.type === 'team') {
                shouldCheckSideChange = true;
            } else {
                // Í∞úÏù∏Ï†Ñ: ÎßàÏßÄÎßâ ÏÑ∏Ìä∏Ïù∏ÏßÄ ÌôïÏù∏
                const player1SetWins = currentMatch.setScores.filter((s, idx) => idx < currentMatch.currentSet - 1 && s.player1 > s.player2).length;
                const player2SetWins = currentMatch.setScores.filter((s, idx) => idx < currentMatch.currentSet - 1 && s.player2 > s.player1).length;
                const totalSetsNeeded = Math.ceil(currentMatch.sets / 2); // 3ÏÑ∏Ìä∏Î©¥ 2Ïäπ, 5ÏÑ∏Ìä∏Î©¥ 3Ïäπ
                const isLastSet = (player1SetWins === totalSetsNeeded - 1 && player2SetWins === totalSetsNeeded - 1);
                shouldCheckSideChange = isLastSet;
            }
            
            if (shouldCheckSideChange) {
                const sideChangePoint = currentMatch.type === 'individual' ? 6 : 16;
                const maxScore = Math.max(set.player1, set.player2);
                // Î®ºÏ†Ä 6Ï†ê(Í∞úÏù∏Ï†Ñ) ÎòêÎäî 16Ï†ê(ÌåÄÏ†Ñ)Ïóê ÎèÑÎã¨Ìïú ÏàúÍ∞Ñ ÏÇ¨Ïù¥ÎìúÏ≤¥Ïù∏ÏßÄ
                if (!currentMatch.sideChangeUsed && maxScore >= sideChangePoint) {
                    currentMatch.sideChangeUsed = true;
                    const leadingPlayer = set.player1 >= sideChangePoint ? currentMatch.player1Name : currentMatch.player2Name;
                    saveProjects();
                    setTimeout(() => {
                        if (confirm(`ÏÇ¨Ïù¥Îìú Ï≤¥Ïù∏ÏßÄ! (${leadingPlayer} ${maxScore}Ï†ê ÎèÑÎã¨)\n\n1Î∂Ñ Ìú¥Ïãù ÌÉÄÏù¥Î®∏Î•º ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                            startSideChange();
                        }
                    }, 500);
                    return; // ÏÇ¨Ïù¥Îìú Ï≤¥Ïù∏ÏßÄ ÌôïÏù∏ ÌõÑ Î¶¨ÌÑ¥
                }
            }
            
            // ÏÑ∏Ìä∏ Ï¢ÖÎ£å Ï°∞Í±¥ ÌôïÏù∏ Î∞è ÏûêÎèô ÌåùÏóÖ
            const diff = Math.abs(set.player1 - set.player2);
            const max = Math.max(set.player1, set.player2);
            if (max >= currentMatch.winScore && diff >= 2) {
                setTimeout(() => {
                    // ÌòÑÏû¨ÍπåÏßÄ ÏÑ∏Ìä∏ ÏäπÏàò Í≥ÑÏÇ∞
                    let p1Wins = 0, p2Wins = 0;
                    currentMatch.setScores.forEach((s, idx) => {
                        if (idx < currentMatch.currentSet - 1) {
                            if (s.player1 > s.player2) p1Wins++;
                            else if (s.player2 > s.player1) p2Wins++;
                        }
                    });
                    // ÌòÑÏû¨ ÏÑ∏Ìä∏ ÏäπÏûê Ï∂îÍ∞Ä
                    if (set.player1 > set.player2) p1Wins++;
                    else p2Wins++;
                    
                    const winsNeeded = Math.ceil(currentMatch.sets / 2);
                    const matchWinner = p1Wins >= winsNeeded ? currentMatch.player1Name : 
                                       p2Wins >= winsNeeded ? currentMatch.player2Name : null;
                    
                    let setEndText;
                    if (matchWinner) {
                        setEndText = `Í≤ΩÍ∏∞ Ï¢ÖÎ£å!\n\n${matchWinner} ÏäπÎ¶¨! (ÏÑ∏Ìä∏ ${p1Wins}:${p2Wins})\nÌòÑÏû¨ Ï†êÏàò: ${set.player1} - ${set.player2}`;
                    } else {
                        setEndText = `ÏÑ∏Ìä∏ ${currentMatch.currentSet}ÏùÑ(Î•º) Ï¢ÖÎ£åÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÌòÑÏû¨ Ï†êÏàò: ${set.player1} - ${set.player2}\nÏÑ∏Ìä∏ Ïä§ÏΩîÏñ¥: ${p1Wins}:${p2Wins}`;
                    }
                    
                    if (confirm(setEndText)) {
                        endSet();
                    }
                }, 500);
            }
        }


        function undo() {
            if (!isAuthenticated) {
                alert('Ïã¨ÌåêÎßå Ï∑®ÏÜåÌï† Ïàò ÏûàÏäµÎãàÎã§');
                return;
            }
            if (currentMatch.history.length === 0) return;
            
            const last = currentMatch.history.shift();
            const set = currentMatch.setScores[currentMatch.currentSet - 1];
            
            if (last.player === currentMatch.player1Name) set.player1 -= last.points;
            else set.player2 -= last.points;
            
            currentMatch.serveCount--;
            if (currentMatch.serveCount < 0) {
                currentMatch.currentServe = currentMatch.currentServe === 'player1' ? 'player2' : 'player1';
                const maxServes = (currentMatch.type === 'team') ? 3 : 2;
                currentMatch.serveCount = maxServes - 1;
            }
            
            // aria-live Ïã§ÏãúÍ∞Ñ ÏïàÎÇ¥
            const nextServer = currentMatch.currentServe === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            announce(`Ï∑®ÏÜåÎê®. ${currentMatch.player1Name} ${set.player1}, ${currentMatch.player2Name} ${set.player2}. Îã§Ïùå ÏÑúÎ∏å ${nextServer}`);
            
            saveProjects();
            renderMatch();
        }

        function endSet() {
            if (!isAuthenticated) {
                alert('Ïã¨ÌåêÎßå ÏÑ∏Ìä∏Î•º Ï¢ÖÎ£åÌï† Ïàò ÏûàÏäµÎãàÎã§');
                return;
            }
            const set = currentMatch.setScores[currentMatch.currentSet - 1];
            const diff = Math.abs(set.player1 - set.player2);
            const max = Math.max(set.player1, set.player2);
            
            if (max < currentMatch.winScore) {
                alert(`${currentMatch.winScore}Ï†ê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§`);
                return;
            }
            if (diff < 2) {
                alert('2Ï†ê Ïù¥ÏÉÅ Ï∞®Ïù¥Í∞Ä ÎÇòÏïº Ìï©ÎãàÎã§');
                return;
            }
            
            // ÏÑ∏Ìä∏ ÏäπÏûê Í≤∞Ï†ï
            const setWinner = set.player1 > set.player2 ? 'player1' : 'player2';
            
            // ÌòÑÏû¨ÍπåÏßÄ ÏÑ∏Ìä∏ ÏäπÏàò Í≥ÑÏÇ∞ (ÌòÑÏû¨ ÏÑ∏Ìä∏ Ìè¨Ìï®)
            let player1SetWins = 0;
            let player2SetWins = 0;
            
            currentMatch.setScores.forEach((s, idx) => {
                if (idx < currentMatch.currentSet) { // ÌòÑÏû¨ ÏÑ∏Ìä∏ÍπåÏßÄ Ìè¨Ìï®
                    if (s.player1 > s.player2) player1SetWins++;
                    else if (s.player2 > s.player1) player2SetWins++;
                }
            });
            
            // ÏÑ†Ïäπ Ï°∞Í±¥: 3ÏÑ∏Ìä∏ ‚Üí 2Ïäπ, 5ÏÑ∏Ìä∏ ‚Üí 3Ïäπ
            const winsNeeded = Math.ceil(currentMatch.sets / 2);
            const matchWinner = player1SetWins >= winsNeeded ? currentMatch.player1Name : 
                               player2SetWins >= winsNeeded ? currentMatch.player2Name : null;
            
            if (matchWinner) {
                // Í≤ΩÍ∏∞ Ï¢ÖÎ£å!
                currentMatch.status = 'completed';
                currentMatch.winner = matchWinner;
                currentMatch.finishedAt = new Date().toISOString();
                announce(`Í≤ΩÍ∏∞ Ï¢ÖÎ£å! ${matchWinner} ÏäπÎ¶¨! (ÏÑ∏Ìä∏ ${player1SetWins}:${player2SetWins})`);
                
                // Ïó∞Ïäµ Í≤ΩÍ∏∞Ïù∏ Í≤ΩÏö∞ Î≥ÑÎèÑ Í≤∞Í≥º ÌôîÎ©¥ÏúºÎ°ú
                if (currentMatch.isPractice || currentProject?.isPractice) {
                    // ÏûêÎèô Ï†ÄÏû• (silent)
                    savePracticeResult(true);
                    goTo('practice-result');
                    return;
                }
                
                // ÌÜ†ÎÑàÎ®ºÌä∏ ÏßÑÌñâ Ï≤òÎ¶¨
                processTournamentProgression(currentMatch, matchWinner);
                
                saveProjects();
                goTo('project-detail');
            } else {
                // Îã§Ïùå ÏÑ∏Ìä∏Î°ú
                const prevSet = currentMatch.currentSet;
                currentMatch.currentSet++;
                // Îã§Ïùå ÏÑ∏Ìä∏Í∞Ä ÏóÜÏúºÎ©¥ Ï∂îÍ∞Ä
                if (!currentMatch.setScores[currentMatch.currentSet - 1]) {
                    currentMatch.setScores.push({player1: 0, player2: 0});
                } else {
                    // Ïù¥ÎØ∏ ÏûàÏúºÎ©¥ Ï¥àÍ∏∞Ìôî
                    currentMatch.setScores[currentMatch.currentSet - 1] = {player1: 0, player2: 0};
                }
                currentMatch.serveCount = 0;
                currentMatch.sideChangeUsed = false; // ÏÇ¨Ïù¥Îìú Ï≤¥Ïù∏ÏßÄ Î¶¨ÏÖã
                // Í∞úÏù∏Ï†ÑÎßå ÏÑ∏Ìä∏ÎßàÎã§ ÌÉÄÏûÑÏïÑÏõÉ Î¶¨ÏÖã (ÌåÄÏ†ÑÏùÄ Îã®ÌåêÏù¥ÎØÄÎ°ú Î¶¨ÏÖã ÏóÜÏùå)
                if (currentMatch.type === 'individual') {
                    currentMatch.timeouts = { player1: 1, player2: 1 };
                    announce(`ÏÑ∏Ìä∏ ${prevSet} Ï¢ÖÎ£å (${player1SetWins}:${player2SetWins}). ÏÑ∏Ìä∏ ${currentMatch.currentSet} ÏãúÏûë. ÌÉÄÏûÑÏïÑÏõÉ Î¶¨ÏÖã`);
                } else {
                    announce(`ÏÑ∏Ìä∏ ${prevSet} Ï¢ÖÎ£å. ÏÑ∏Ìä∏ ${currentMatch.currentSet} ÏãúÏûë`);
                }
                saveProjects();
                renderMatch();
            }
        }

        // ÏÑúÎ∏åÍ∂å ÏàòÎèô Î≥ÄÍ≤Ω
        function changeServe() {
            if (!isAuthenticated) return;
            currentMatch.currentServe = currentMatch.currentServe === 'player1' ? 'player2' : 'player1';
            currentMatch.serveCount = 0;
            const newServer = currentMatch.currentServe === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            announce(`ÏÑúÎ∏åÍ∂å Î≥ÄÍ≤Ω: ${newServer}`);
            saveProjects();
            renderMatch();
        }
        
        // Í≤ΩÍ∏∞ ÏùºÏãúÏ†ïÏßÄ
        function pauseMatch() {
            if (!isAuthenticated || isPaused) return;
            const reason = prompt('ÏùºÏãúÏ†ïÏßÄ ÏÇ¨Ïú†Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:\n(Ïòà: Î∂ÄÏÉÅ, Ïû•ÎπÑ Î¨∏Ï†ú, Í∏∞ÌÉÄ)');
            if (reason === null) return;
            
            isPaused = true;
            pauseSeconds = 0;
            currentMatch.pauseReason = reason || 'ÏÇ¨Ïú† ÏóÜÏùå';
            
            // ÏùºÏãúÏ†ïÏßÄ Í∏∞Î°ù Ï∂îÍ∞Ä
            if (!currentMatch.pauseHistory) currentMatch.pauseHistory = [];
            currentMatch.pauseHistory.push({
                time: new Date().toLocaleTimeString('ko-KR'),
                reason: currentMatch.pauseReason,
                set: currentMatch.currentSet
            });
            
            pauseTimer = setInterval(() => {
                pauseSeconds++;
                const timerEl = document.getElementById('pause-timer');
                if (timerEl) {
                    timerEl.textContent = `${Math.floor(pauseSeconds / 60)}:${(pauseSeconds % 60).toString().padStart(2, '0')}`;
                }
            }, 1000);
            
            announce(`Í≤ΩÍ∏∞ ÏùºÏãúÏ†ïÏßÄ. ÏÇ¨Ïú†: ${currentMatch.pauseReason}`);
            saveProjects();
            renderMatch();
        }
        
        // Í≤ΩÍ∏∞ Ïû¨Í∞ú
        function resumeMatch() {
            if (!isPaused) return;
            clearInterval(pauseTimer);
            
            // ÏùºÏãúÏ†ïÏßÄ ÏãúÍ∞Ñ Í∏∞Î°ù
            if (currentMatch.pauseHistory && currentMatch.pauseHistory.length > 0) {
                currentMatch.pauseHistory[currentMatch.pauseHistory.length - 1].duration = pauseSeconds;
            }
            
            isPaused = false;
            pauseSeconds = 0;
            currentMatch.pauseReason = null;
            
            announce('Í≤ΩÍ∏∞ Ïû¨Í∞ú');
            saveProjects();
            renderMatch();
        }
        
        // Î©îÎ™® Ï∂îÍ∞Ä
        function addMemo() {
            if (!isAuthenticated) return;
            const memo = prompt('Í≤ΩÍ∏∞ Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            if (!memo) return;
            
            if (!currentMatch.memos) currentMatch.memos = [];
            currentMatch.memos.push({
                time: new Date().toLocaleTimeString('ko-KR'),
                text: memo,
                set: currentMatch.currentSet,
                score: `${currentMatch.setScores[currentMatch.currentSet - 1].player1}:${currentMatch.setScores[currentMatch.currentSet - 1].player2}`
            });
            
            announce(`Î©îÎ™® Ï∂îÍ∞ÄÎê®: ${memo}`);
            saveProjects();
            alert('Î©îÎ™®Í∞Ä Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.');
        }
        
        // ÏÑ†Ïàò ÍµêÏ≤¥ (ÌåÄÏ†Ñ)
        function substitutePlayer() {
            if (!isAuthenticated || currentMatch.type !== 'team') return;
            
            const team = prompt('ÍµêÏ≤¥Ìï† ÌåÄÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî:\n1: ' + currentMatch.player1Name + '\n2: ' + currentMatch.player2Name);
            if (team !== '1' && team !== '2') return;
            
            const lineup = team === '1' ? currentMatch.team1Lineup : currentMatch.team2Lineup;
            const teamName = team === '1' ? currentMatch.player1Name : currentMatch.player2Name;
            
            const outPlayer = prompt(`${teamName} - ÍµêÏ≤¥ OUT ÏÑ†Ïàò Ïù¥Î¶Ñ:\nÌòÑÏû¨ ÎùºÏù∏ÏóÖ: ${lineup.join(', ')}`);
            if (!outPlayer) return;
            
            const inPlayer = prompt(`${teamName} - ÍµêÏ≤¥ IN ÏÑ†Ïàò Ïù¥Î¶Ñ:`);
            if (!inPlayer) return;
            
            // ÎùºÏù∏ÏóÖ ÏóÖÎç∞Ïù¥Ìä∏
            const idx = lineup.findIndex(p => p.includes(outPlayer));
            if (idx >= 0) {
                lineup[idx] = inPlayer;
                
                // ÍµêÏ≤¥ Í∏∞Î°ù
                if (!currentMatch.substitutions) currentMatch.substitutions = [];
                currentMatch.substitutions.push({
                    time: new Date().toLocaleTimeString('ko-KR'),
                    team: teamName,
                    out: outPlayer,
                    in: inPlayer,
                    set: currentMatch.currentSet
                });
                
                announce(`ÏÑ†Ïàò ÍµêÏ≤¥: ${teamName} - ${outPlayer} OUT, ${inPlayer} IN`);
                saveProjects();
                renderMatch();
                alert(`ÏÑ†Ïàò ÍµêÏ≤¥ ÏôÑÎ£å\n${outPlayer} ‚Üí ${inPlayer}`);
            } else {
                alert('Ìï¥Îãπ ÏÑ†ÏàòÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
            }
        }
        
        // QR ÏΩîÎìú ÌëúÏãú
        function showQRCode() {
            const url = window.location.href;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}`;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="text-align:center;">
                    <h2>üì± QR ÏΩîÎìúÎ°ú Í≥µÏú†</h2>
                    <p style="margin:12px 0; color:var(--text-secondary);">Í¥ÄÎûåÍ∞ùÏù¥ Ïù¥ QRÏùÑ Ïä§Ï∫îÌïòÎ©¥<br>Ïã§ÏãúÍ∞ÑÏúºÎ°ú Í≤ΩÍ∏∞Î•º Î≥º Ïàò ÏûàÏäµÎãàÎã§.</p>
                    <img src="${qrUrl}" alt="QR ÏΩîÎìú" style="margin:16px auto; display:block; border-radius:8px;">
                    <p style="font-size:12px; color:var(--text-secondary); word-break:break-all; margin:12px 0;">${url}</p>
                    <button class="btn btn-primary" onclick="this.parentElement.parentElement.remove()">Îã´Í∏∞</button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // ÌîÑÎ°úÏ†ùÌä∏Î≥Ñ QR ÏΩîÎìú ÌëúÏãú
        function showProjectQR(projectIndex) {
            const project = projects[projectIndex];
            if (!project) return;
            
            // ÌîÑÎ°úÏ†ùÌä∏ Ï†ëÏÜç URL ÏÉùÏÑ± (ÌòÑÏû¨ ÎèÑÎ©îÏù∏ + ÌîÑÎ°úÏ†ùÌä∏ ID ÌååÎùºÎØ∏ÌÑ∞)
            const baseUrl = window.location.origin + window.location.pathname;
            const projectUrl = `${baseUrl}?project=${project.id}`;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(projectUrl)}`;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="text-align:center;">
                    <h2>üì± ÌîÑÎ°úÏ†ùÌä∏ QR Í≥µÏú†</h2>
                    <h3 style="color:var(--primary); margin:8px 0;">${project.name}</h3>
                    <p style="margin:8px 0; color:var(--text-secondary); font-size:13px;">
                        ${project.date || 'ÎÇ†Ïßú ÎØ∏Ï†ï'} ¬∑ ${project.location || 'Ïû•ÏÜå ÎØ∏Ï†ï'}
                    </p>
                    <img src="${qrUrl}" alt="QR ÏΩîÎìú" style="margin:16px auto; display:block; border-radius:8px; border:2px solid #eee;">
                    <p style="font-size:11px; color:var(--text-secondary); margin:12px 0;">
                        QRÏùÑ Ïä§Ï∫îÌïòÎ©¥ Ïù¥ ÌîÑÎ°úÏ†ùÌä∏Î°ú Î∞îÎ°ú Ï†ëÏÜçÌï©ÎãàÎã§
                    </p>
                    <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
                        <button class="btn" onclick="copyProjectUrl('${projectUrl}')">URL Î≥µÏÇ¨</button>
                        <button class="btn" onclick="downloadProjectQR('${qrUrl}', '${project.name}')">QR Ï†ÄÏû•</button>
                        <button class="btn btn-primary" onclick="this.parentElement.parentElement.parentElement.remove()">Îã´Í∏∞</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // ÌîÑÎ°úÏ†ùÌä∏ URL Î≥µÏÇ¨
        function copyProjectUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                announce('URLÏù¥ Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§');
                alert('URLÏù¥ ÌÅ¥Î¶ΩÎ≥¥ÎìúÏóê Î≥µÏÇ¨ÎêòÏóàÏäµÎãàÎã§!');
            }).catch(() => {
                prompt('URLÏùÑ Î≥µÏÇ¨ÌïòÏÑ∏Ïöî:', url);
            });
        }
        
        // QR Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú
        function downloadProjectQR(qrUrl, projectName) {
            const link = document.createElement('a');
            link.href = qrUrl;
            link.download = `QR_${projectName.replace(/[^a-zA-Z0-9Í∞Ä-Ìû£]/g, '_')}.png`;
            link.target = '_blank';
            link.click();
            announce('QR Ïù¥ÎØ∏ÏßÄ Îã§Ïö¥Î°úÎìú ÏãúÏûë');
        }

        // ========== ÎåÄÏßÑ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ ==========
        
        // ÏÑ†Ïàò Ï∂îÍ∞Ä
        // ========== ÌåÄ Í¥ÄÎ¶¨ Ìï®Ïàò ==========
        function addTeam() {
            const nameInput = document.getElementById('new-team-name');
            const membersInput = document.getElementById('new-team-members');
            
            const teamName = nameInput.value.trim();
            if (!teamName) {
                alert('ÌåÄÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (!currentProject.teams) currentProject.teams = [];
            
            // Ï§ëÎ≥µ Ï≤¥ÌÅ¨
            if (currentProject.teams.find(t => t.name === teamName)) {
                alert('Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÌåÄÎ™ÖÏûÖÎãàÎã§.');
                return;
            }
            
            // ÏÑ†Ïàò ÌååÏã± (Ïù¥Î¶Ñ/ÏÑ±Î≥Ñ ÌòïÏãù)
            const members = membersInput.value.split(',').map(m => {
                const parts = m.trim().split('/');
                const name = parts[0]?.trim();
                const genderStr = parts[1]?.trim()?.toLowerCase();
                let gender = 'male'; // Í∏∞Î≥∏Í∞í
                if (genderStr === 'Ïó¨' || genderStr === 'f' || genderStr === 'female') {
                    gender = 'female';
                }
                return name ? { name, gender } : null;
            }).filter(m => m);
            
            currentProject.teams.push({
                id: Date.now(),
                name: teamName,
                members: members,
                group: null
            });
            
            saveProjects();
            nameInput.value = '';
            membersInput.value = '';
            render();
            announce(`${teamName} ÌåÄ Ï∂îÍ∞ÄÎê® (${members.length}Î™Ö)`);
        }
        
        function removeTeam(index) {
            if (confirm('Ïù¥ ÌåÄÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                currentProject.teams.splice(index, 1);
                saveProjects();
                render();
            }
        }
        
        // ========== ÏÑ†Ïàò Í¥ÄÎ¶¨ Ìï®Ïàò ==========
        function addPlayer() {
            const input = document.getElementById('new-player-name');
            const names = input.value.split(',').map(n => n.trim()).filter(n => n);
            
            if (names.length === 0) {
                alert('ÏÑ†Ïàò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            if (!currentProject.players) currentProject.players = [];
            
            names.forEach(name => {
                if (!currentProject.players.find(p => p.name === name)) {
                    currentProject.players.push({
                        id: Date.now() + Math.random(),
                        name: name,
                        group: null
                    });
                }
            });
            
            saveProjects();
            input.value = '';
            render();
            announce(`${names.length}Î™Ö ÏÑ†Ïàò Ï∂îÍ∞ÄÎê®`);
        }
        
        // ÏÑ†Ïàò ÏÇ≠Ï†ú
        function removePlayer(index) {
            if (confirm('Ïù¥ ÏÑ†ÏàòÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                currentProject.players.splice(index, 1);
                saveProjects();
                render();
            }
        }
        
        // ÏûêÎèô Ï°∞ Î∞∞Ï†ï (Í∞úÏù∏Ï†Ñ/ÌåÄÏ†Ñ Í≥µÏö©)
        function autoAssignGroups() {
            const isTeam = currentProject.competitionType === 'team';
            const participants = isTeam ? (currentProject.teams || []) : (currentProject.players || []);
            
            if (participants.length < 2) {
                alert(`ÏµúÏÜå 2${isTeam ? 'ÌåÄ' : 'Î™Ö'} Ïù¥ÏÉÅ ÌïÑÏöîÌï©ÎãàÎã§.`);
                return;
            }
            
            const groupCount = parseInt(document.getElementById('group-count-edit')?.value) || 2;
            const advanceCount = parseInt(document.getElementById('advance-count-edit')?.value) || 2;
            const setsPerMatch = parseInt(document.getElementById('group-sets-edit')?.value) || 3;
            
            // Ï∞∏Í∞ÄÏûê ÏÑûÍ∏∞ (IBSA Ï∂îÏ≤® ÏãúÎÆ¨Î†àÏù¥ÏÖò)
            const shuffled = [...participants].sort(() => Math.random() - 0.5);
            
            // Ï°∞ ÏÉùÏÑ±
            currentProject.groups = [];
            for (let i = 0; i < groupCount; i++) {
                currentProject.groups.push({
                    name: String.fromCharCode(65 + i) + 'Ï°∞',
                    players: [], // Í∞úÏù∏Ï†Ñ: ÏÑ†Ïàò, ÌåÄÏ†Ñ: ÌåÄ
                    matches: [],
                    standings: [],
                    isTeam: isTeam
                });
            }
            
            // Î∞∞Ï†ï (Ïä§ÎÑ§Ïù¥ÌÅ¨ Î∞©Ïãù - Í∑†Ìòï Ïû°Ìûå Î∞∞Ï†ï)
            shuffled.forEach((participant, idx) => {
                // Ïä§ÎÑ§Ïù¥ÌÅ¨ Î∞©Ïãù: 0,1,2,3,3,2,1,0,0,1,2,3...
                const round = Math.floor(idx / groupCount);
                const groupIdx = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                participant.group = String.fromCharCode(65 + groupIdx);
                currentProject.groups[groupIdx].players.push({...participant});
            });
            
            // ÏÑ§Ï†ï Ï†ÄÏû•
            currentProject.groupSettings = {
                groupCount: groupCount,
                advanceCount: advanceCount,
                setsPerMatch: isTeam ? 1 : setsPerMatch // ÌåÄÏ†ÑÏùÄ Îã®Ìåê
            };
            
            saveProjects();
            render();
            announce(`${groupCount}Í∞ú Ï°∞Ïóê ${participants.length}${isTeam ? 'ÌåÄ' : 'Î™Ö'} Î∞∞Ï†ï ÏôÑÎ£å`);
        }
        
        // Ï°∞ Ï¥àÍ∏∞Ìôî
        function clearGroups() {
            if (confirm('Ï°∞ Ìé∏ÏÑ±Í≥º ÎåÄÏßÑÌëúÎ•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                currentProject.groups = [];
                currentProject.bracket = null;
                if (currentProject.players) {
                    currentProject.players.forEach(p => p.group = null);
                }
                if (currentProject.teams) {
                    currentProject.teams.forEach(t => t.group = null);
                }
                saveProjects();
                render();
            }
        }
        
        // Ï°∞Î≥Ñ Î¶¨Í∑∏ ÎåÄÏßÑ ÏÉùÏÑ± (IBSA ÎùºÏö¥Îìú Î°úÎπà)
        function generateGroupMatches() {
            if (!currentProject.groups || currentProject.groups.length === 0) {
                alert('Î®ºÏ†Ä Ï°∞ Ìé∏ÏÑ±ÏùÑ Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const isTeam = currentProject.competitionType === 'team';
            const setsPerMatch = isTeam ? 1 : (currentProject.groupSettings?.setsPerMatch || 3);
            let matchCount = 0;
            
            currentProject.groups.forEach((group, gi) => {
                const participants = group.players;
                group.matches = [];
                group.isTeam = isTeam;
                
                // IBSA ÎùºÏö¥Îìú Î°úÎπà: Î™®Îì† Ï∞∏Í∞ÄÏûêÍ∞Ä ÏÑúÎ°ú Ìïú Î≤àÏî© ÎåÄÏ†Ñ
                for (let i = 0; i < participants.length; i++) {
                    for (let j = i + 1; j < participants.length; j++) {
                        const matchId = `G${gi + 1}M${group.matches.length + 1}`;
                        group.matches.push({
                            id: matchId,
                            player1: participants[i].name,
                            player2: participants[j].name,
                            status: 'pending',
                            result: null,
                            sets: setsPerMatch,
                            isTeam: isTeam,
                            // ÌåÄÏ†Ñ Ï∂îÍ∞Ä Ï†ïÎ≥¥
                            winScore: isTeam ? 31 : 11
                        });
                        matchCount++;
                    }
                }
            });
            
            saveProjects();
            const matchType = isTeam ? '(31Ï†ê Îã®Ìåê)' : `(${setsPerMatch}ÏÑ∏Ìä∏)`;
            alert(`IBSA ÎùºÏö¥Îìú Î°úÎπà ÎåÄÏßÑ ÏÉùÏÑ± ÏôÑÎ£å!\nÏ¥ù ${matchCount}Í≤ΩÍ∏∞ ${matchType}`);
            render();
        }
        
        // ÏÑ†Ïàò/ÌåÄ Ï°∞ Ïù¥Îèô
        function movePlayerGroup(groupIdx, playerIdx) {
            const groups = currentProject.groups;
            const participant = groups[groupIdx].players[playerIdx];
            const isTeam = currentProject.competitionType === 'team';
            
            const newGroup = prompt(`${participant.name}${isTeam ? ' ÌåÄ' : ' ÏÑ†Ïàò'}ÏùÑ Ïù¥ÎèôÌï† Ï°∞Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (A, B, C...):`, String.fromCharCode(65 + groupIdx));
            if (!newGroup) return;
            
            const newGroupIdx = newGroup.toUpperCase().charCodeAt(0) - 65;
            if (newGroupIdx < 0 || newGroupIdx >= groups.length || newGroupIdx === groupIdx) {
                alert('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ï°∞ÏûÖÎãàÎã§.');
                return;
            }
            
            // Ïù¥Îèô
            groups[groupIdx].players.splice(playerIdx, 1);
            player.group = String.fromCharCode(65 + newGroupIdx);
            groups[newGroupIdx].players.push(player);
            
            // ÎåÄÏßÑÌëú Ïû¨ÏÉùÏÑ± ÌïÑÏöî ÏïåÎ¶º
            if (groups[groupIdx].matches?.length > 0) {
                alert('Ï°∞ Ìé∏ÏÑ±Ïù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§. ÎåÄÏßÑÌëúÎ•º Îã§Ïãú ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.');
                groups[groupIdx].matches = [];
                groups[newGroupIdx].matches = [];
            }
            
            saveProjects();
            render();
        }
        
        // IBSA ÌÜ†ÎÑàÎ®ºÌä∏ ÎåÄÏßÑÌëú ÏÉùÏÑ± (ÍµêÏ∞® ÎåÄÏßÑ)
        function generateBracket() {
            let participants = [];
            const isTeam = currentProject.competitionType === 'team';
            
            // Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏßÑÏ∂úÏûê ÏàòÏßë
            if (currentProject.groups?.length > 0) {
                const advanceCount = currentProject.groupSettings?.advanceCount || 2;
                currentProject.groups.forEach((group, gi) => {
                    const standings = calculateGroupStandings(group);
                    standings.slice(0, advanceCount).forEach((p, rank) => {
                        participants.push({ 
                            ...p, 
                            fromGroup: String.fromCharCode(65 + gi),
                            groupRank: rank + 1,
                            groupIndex: gi
                        });
                    });
                });
            } else if (currentProject.players?.length > 0) {
                participants = currentProject.players.map((p, i) => ({...p, seed: i + 1}));
            }
            
            if (participants.length < 2) {
                alert('ÏµúÏÜå 2Î™ÖÏùò Ï∞∏Í∞ÄÏûêÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.\nÏ°∞Î≥Ñ Î¶¨Í∑∏Î•º Î®ºÏ†Ä ÏôÑÎ£åÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // 2Ïùò Í±∞Îì≠Ï†úÍ≥±ÏúºÎ°ú ÎßûÏ∂îÍ∏∞
            let size = 2;
            while (size < participants.length) size *= 2;
            
            // IBSA ÍµêÏ∞® ÎåÄÏßÑ: Í∞ôÏùÄ Ï°∞ ÏÑ†ÏàòÍ∞Ä Í∞ÄÎä•Ìïú Îä¶Í≤å ÎßåÎÇòÎèÑÎ°ù
            const seeded = ibsaCrossGroupSeeding(participants, size);
            
            // Î∂ÄÏ†ÑÏäπ Ï∂îÍ∞Ä
            while (seeded.length < size) {
                seeded.push({ name: 'BYE', isBye: true });
            }
            
            // ÎåÄÏßÑÌëú ÏÉùÏÑ±
            const setsPerMatch = currentProject.tournamentSettings?.setsPerMatch || 5;
            currentProject.bracket = {
                size: size,
                rounds: [],
                currentRound: 0,
                setsPerMatch: setsPerMatch,
                thirdPlaceMatch: currentProject.tournamentSettings?.thirdPlaceMatch !== false
            };
            
            // 1ÎùºÏö¥Îìú ÏÉùÏÑ±
            const round1 = [];
            for (let i = 0; i < size / 2; i++) {
                round1.push({
                    matchId: `R1M${i + 1}`,
                    player1: seeded[i * 2],
                    player2: seeded[i * 2 + 1],
                    winner: null,
                    loser: null,
                    status: 'pending',
                    sets: setsPerMatch
                });
            }
            currentProject.bracket.rounds.push(round1);
            
            // Î∂ÄÏ†ÑÏäπ ÏûêÎèô Ï≤òÎ¶¨
            round1.forEach(match => {
                if (match.player1?.isBye) {
                    match.winner = match.player2;
                    match.loser = match.player1;
                    match.status = 'finished';
                } else if (match.player2?.isBye) {
                    match.winner = match.player1;
                    match.loser = match.player2;
                    match.status = 'finished';
                }
            });
            
            saveProjects();
            render();
            announce(`IBSA ÌÜ†ÎÑàÎ®ºÌä∏ ÎåÄÏßÑÌëú ÏÉùÏÑ± ÏôÑÎ£å (${size}Í∞ï)`);
        }
        
        // IBSA ÍµêÏ∞® ÎåÄÏßÑ ÏïåÍ≥†Î¶¨Ï¶ò
        function ibsaCrossGroupSeeding(participants, bracketSize) {
            const numGroups = Math.max(...participants.map(p => p.groupIndex || 0)) + 1;
            const advancePerGroup = participants.length / numGroups;
            
            // Ï°∞ 1ÏúÑ, 2ÏúÑ, 3ÏúÑ... Î∂ÑÎ¶¨
            const byRank = {};
            participants.forEach(p => {
                const rank = p.groupRank || 1;
                if (!byRank[rank]) byRank[rank] = [];
                byRank[rank].push(p);
            });
            
            // Í≤∞Í≥º Î∞∞Ïó¥ (bracketSize ÌÅ¨Í∏∞)
            const seeded = new Array(bracketSize).fill(null);
            
            // ÏãúÎìú ÏúÑÏπò Í≥ÑÏÇ∞ (ÍµêÏ∞® Î∞∞Ï†ï)
            // Ïòà: 8Í∞ï - [1,8,5,4,3,6,7,2] (Í∞ôÏùÄ Ï°∞Í∞Ä Í≤∞ÏäπÏóêÏÑú ÎßåÎÇòÎèÑÎ°ù)
            function getSeedPosition(seed, size) {
                if (size === 2) return seed - 1;
                const half = size / 2;
                if (seed <= half) {
                    return getSeedPosition(seed, half) * 2;
                } else {
                    return getSeedPosition(size - seed + 1, half) * 2 + 1;
                }
            }
            
            // Ï°∞ 1ÏúÑÎì§ Î∞∞Ïπò (1, 2, 3, 4... ÏãúÎìú)
            const firstPlace = byRank[1] || [];
            firstPlace.sort((a, b) => a.groupIndex - b.groupIndex);
            firstPlace.forEach((p, i) => {
                const seedNum = i + 1;
                const pos = getSeedPosition(seedNum, bracketSize);
                seeded[pos] = p;
            });
            
            // Ï°∞ 2ÏúÑÎì§ Î∞∞Ïπò (Îã§Î•∏ Ï°∞ 1ÏúÑÏôÄ ÎßåÎÇòÎèÑÎ°ù Î∞òÎåÄÌé∏)
            const secondPlace = byRank[2] || [];
            secondPlace.sort((a, b) => a.groupIndex - b.groupIndex);
            
            // 2ÏúÑÎäî Î∞òÎåÄ Ï°∞ 1ÏúÑÏôÄ ÎßåÎÇòÏïº Ìï®
            // AÏ°∞2ÏúÑ vs BÏ°∞1ÏúÑ, BÏ°∞2ÏúÑ vs AÏ°∞1ÏúÑ (4Ï°∞: A2-D1, B2-C1, C2-B1, D2-A1)
            const numFirst = firstPlace.length;
            secondPlace.forEach((p, i) => {
                // Î∞òÎåÄ Ï°∞ Ï∞æÍ∏∞
                const oppositeIdx = (numFirst - 1 - i + numFirst) % numFirst;
                const seedNum = numFirst + oppositeIdx + 1;
                const pos = getSeedPosition(seedNum, bracketSize);
                if (seeded[pos] === null) {
                    seeded[pos] = p;
                } else {
                    // Îπà ÏûêÎ¶¨ Ï∞æÍ∏∞
                    for (let j = 0; j < seeded.length; j++) {
                        if (seeded[j] === null) { seeded[j] = p; break; }
                    }
                }
            });
            
            // 3ÏúÑ Ïù¥Ìïò Î∞∞Ïπò
            for (let rank = 3; rank <= Math.max(...Object.keys(byRank).map(Number)); rank++) {
                (byRank[rank] || []).forEach(p => {
                    for (let j = 0; j < seeded.length; j++) {
                        if (seeded[j] === null) { seeded[j] = p; break; }
                    }
                });
            }
            
            return seeded;
        }
        
        // ÎÖπÏïÑÏõÉ Í≤ΩÍ∏∞ ÏÉùÏÑ± (Ïã§Ï†ú Í≤ΩÍ∏∞Î°ú Î≥ÄÌôò)
        function createKnockoutMatches() {
            const bracket = currentProject.bracket;
            if (!bracket) {
                alert('Î®ºÏ†Ä ÎåÄÏßÑÌëúÎ•º ÏÉùÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const currentRound = bracket.rounds[bracket.currentRound];
            const pendingMatches = currentRound.filter(m => m.status === 'pending' && !m.player1?.isBye && !m.player2?.isBye);
            
            if (pendingMatches.length === 0) {
                alert('ÏÉùÏÑ±Ìï† Í≤ΩÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const setsPerMatch = bracket.setsPerMatch || 5;
            
            pendingMatches.forEach(bMatch => {
                // Ïù¥ÎØ∏ Í≤ΩÍ∏∞ Î™©Î°ùÏóê ÏûàÎäîÏßÄ ÌôïÏù∏
                const exists = currentProject.matches?.some(m => 
                    m.player1Name === bMatch.player1.name && 
                    m.player2Name === bMatch.player2.name &&
                    m.status !== 'finished'
                );
                
                if (!exists) {
                    const match = {
                        id: Date.now() + Math.random(),
                        player1Name: bMatch.player1.name,
                        player2Name: bMatch.player2.name,
                        type: 'individual',
                        sets: setsPerMatch,
                        currentSet: 1,
                        setScores: [{player1: 0, player2: 0}],
                        winScore: 11,
                        status: 'active',
                        history: [],
                        timeouts: { player1: 1, player2: 1 },
                        currentServe: 'player1',
                        serveCount: 0,
                        serveSelected: false,
                        mainReferee: '',
                        bracketMatchId: bMatch.matchId,
                        tournamentRound: bracket.currentRound + 1
                    };
                    
                    if (!currentProject.matches) currentProject.matches = [];
                    currentProject.matches.push(match);
                }
            });
            
            saveProjects();
            alert(`${pendingMatches.length}Í∞ú ÎÖπÏïÑÏõÉ Í≤ΩÍ∏∞Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.`);
            render();
        }
        
        // ÎåÄÏßÑÌëú Î∑∞ Î†åÎçîÎßÅ
        function renderBracketView(bracket) {
            if (!bracket || !bracket.rounds) return '';
            
            let html = '';
            const roundNames = ['1ÎùºÏö¥Îìú', '2ÎùºÏö¥Îìú', '8Í∞ï', '4Í∞ï', 'Í≤∞Ïäπ'];
            
            bracket.rounds.forEach((round, ri) => {
                const remaining = bracket.size / Math.pow(2, ri);
                const roundName = remaining <= 4 ? 
                    (remaining === 2 ? 'Í≤∞Ïäπ' : remaining === 4 ? '4Í∞ï' : '8Í∞ï') : 
                    `${ri + 1}ÎùºÏö¥Îìú`;
                
                html += `<div style="margin-bottom:20px;">
                    <h3 style="color:var(--primary); margin-bottom:12px;">${roundName}</h3>`;
                
                round.forEach((match, mi) => {
                    const p1 = match.player1?.name || 'ÎØ∏Ï†ï';
                    const p2 = match.player2?.name || 'ÎØ∏Ï†ï';
                    const winner = match.winner?.name;
                    
                    html += `
                        <div style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid ${match.status === 'completed' ? 'var(--success)' : 'var(--warning)'};">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="${winner === p1 ? 'font-weight:700; color:var(--success);' : ''}">${p1}</span>
                                <span style="color:var(--text-secondary);">vs</span>
                                <span style="${winner === p2 ? 'font-weight:700; color:var(--success);' : ''}">${p2}</span>
                            </div>
                            ${match.status === 'completed' ? `<div style="text-align:center; margin-top:8px; color:var(--success); font-size:12px;">ÏäπÏûê: ${winner}</div>` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            return html;
        }
        
        // Îã§Ïùå ÎùºÏö¥Îìú ÏßÑÌñâ
        function advanceTournament() {
            const bracket = currentProject.bracket;
            if (!bracket) return;
            
            const currentRound = bracket.rounds[bracket.currentRound];
            const allFinished = currentRound.every(m => m.status === 'completed');
            
            if (!allFinished) {
                alert('ÌòÑÏû¨ ÎùºÏö¥ÎìúÏùò Î™®Îì† Í≤ΩÍ∏∞Í∞Ä ÏôÑÎ£åÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                return;
            }
            
            // Îã§Ïùå ÎùºÏö¥Îìú ÏÉùÏÑ±
            if (currentRound.length >= 2) {
                const nextRound = [];
                for (let i = 0; i < currentRound.length / 2; i++) {
                    nextRound.push({
                        player1: currentRound[i * 2].winner,
                        player2: currentRound[i * 2 + 1].winner,
                        winner: null,
                        status: 'pending'
                    });
                }
                bracket.rounds.push(nextRound);
                bracket.currentRound++;
                
                saveProjects();
                render();
                announce('Îã§Ïùå ÎùºÏö¥Îìú ÏßÑÌñâ');
            } else {
                alert('ÌÜ†ÎÑàÎ®ºÌä∏Í∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§!');
            }
        }
        
        // Ï°∞Î≥Ñ ÏàúÏúÑ Í≥ÑÏÇ∞
        function calculateGroupStandings(group) {
            const playerStats = {};
            
            group.players.forEach(p => {
                playerStats[p.name] = {
                    name: p.name,
                    wins: 0,
                    losses: 0,
                    setWins: 0,
                    setLosses: 0,
                    goalsFor: 0,
                    goalsAgainst: 0
                };
            });
            
            // ÏôÑÎ£åÎêú Í≤ΩÍ∏∞ÏóêÏÑú ÌÜµÍ≥Ñ ÏàòÏßë
            const matches = currentProject.matches?.filter(m => 
                m.status === 'completed' && 
                playerStats[m.player1Name] && playerStats[m.player2Name]
            ) || [];
            
            matches.forEach(m => {
                const p1Stats = playerStats[m.player1Name];
                const p2Stats = playerStats[m.player2Name];
                
                // ÏÑ∏Ìä∏ ÌÜµÍ≥Ñ
                m.setScores.forEach(s => {
                    p1Stats.goalsFor += s.player1;
                    p1Stats.goalsAgainst += s.player2;
                    p2Stats.goalsFor += s.player2;
                    p2Stats.goalsAgainst += s.player1;
                    
                    if (s.player1 > s.player2) {
                        p1Stats.setWins++;
                        p2Stats.setLosses++;
                    } else {
                        p2Stats.setWins++;
                        p1Stats.setLosses++;
                    }
                });
                
                // Ïäπ/Ìå®
                const p1SetWins = m.setScores.filter(s => s.player1 > s.player2).length;
                const p2SetWins = m.setScores.filter(s => s.player2 > s.player1).length;
                
                if (p1SetWins > p2SetWins) {
                    p1Stats.wins++;
                    p2Stats.losses++;
                } else {
                    p2Stats.wins++;
                    p1Stats.losses++;
                }
            });
            
            // ÏàúÏúÑ Ï†ïÎ†¨: ÏäπÎ•† ‚Üí ÏÑ∏Ìä∏ÎìùÏã§ ‚Üí Í≥®ÎìùÏã§
            return Object.values(playerStats).sort((a, b) => {
                const aWinRate = a.wins / (a.wins + a.losses || 1);
                const bWinRate = b.wins / (b.wins + b.losses || 1);
                if (bWinRate !== aWinRate) return bWinRate - aWinRate;
                
                const aSetDiff = a.setWins - a.setLosses;
                const bSetDiff = b.setWins - b.setLosses;
                if (bSetDiff !== aSetDiff) return bSetDiff - aSetDiff;
                
                const aGoalDiff = a.goalsFor - a.goalsAgainst;
                const bGoalDiff = b.goalsFor - b.goalsAgainst;
                return bGoalDiff - aGoalDiff;
            }).map(p => ({
                ...p,
                setDiff: p.setWins - p.setLosses,
                goalDiff: p.goalsFor - p.goalsAgainst
            }));
        }
        
        // Ï†ÑÏ≤¥ ÏàúÏúÑ Í≥ÑÏÇ∞
        function calculateStandings() {
            const result = { groups: {}, final: [] };
            
            if (currentProject.groups) {
                currentProject.groups.forEach((group, gi) => {
                    result.groups[gi] = calculateGroupStandings(group);
                });
            }
            
            // ÌÜ†ÎÑàÎ®ºÌä∏ ÏµúÏ¢Ö ÏàúÏúÑ
            if (currentProject.bracket?.rounds) {
                const lastRound = currentProject.bracket.rounds[currentProject.bracket.rounds.length - 1];
                if (lastRound?.length === 1 && lastRound[0].status === 'completed') {
                    result.final.push(lastRound[0].winner);
                    // Ï§ÄÏö∞Ïäπ
                    const loser = lastRound[0].player1.name === lastRound[0].winner.name ? 
                        lastRound[0].player2 : lastRound[0].player1;
                    result.final.push(loser);
                }
            }
            
            return result;
        }
        
        // ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
        function calculateStatistics() {
            const matches = currentProject.matches || [];
            const stats = {
                totalMatches: matches.length,
                completedMatches: matches.filter(m => m.status === 'completed').length,
                playerStats: []
            };
            
            const playerData = {};
            
            matches.filter(m => m.status === 'completed').forEach(m => {
                [m.player1Name, m.player2Name].forEach((name, idx) => {
                    if (!playerData[name]) {
                        playerData[name] = {
                            name,
                            matches: 0,
                            wins: 0,
                            losses: 0,
                            goalsFor: 0,
                            goalsAgainst: 0
                        };
                    }
                    
                    const p = playerData[name];
                    p.matches++;
                    
                    m.setScores.forEach(s => {
                        if (idx === 0) {
                            p.goalsFor += s.player1;
                            p.goalsAgainst += s.player2;
                        } else {
                            p.goalsFor += s.player2;
                            p.goalsAgainst += s.player1;
                        }
                    });
                    
                    const p1SetWins = m.setScores.filter(s => s.player1 > s.player2).length;
                    const p2SetWins = m.setScores.filter(s => s.player2 > s.player1).length;
                    
                    if (idx === 0) {
                        if (p1SetWins > p2SetWins) p.wins++;
                        else p.losses++;
                    } else {
                        if (p2SetWins > p1SetWins) p.wins++;
                        else p.losses++;
                    }
                });
            });
            
            stats.playerStats = Object.values(playerData)
                .map(p => ({
                    ...p,
                    winRate: p.matches > 0 ? Math.round((p.wins / p.matches) * 100) : 0
                }))
                .sort((a, b) => b.winRate - a.winRate || b.wins - a.wins);
            
            return stats;
        }
        
        // ÌÜ†ÎÑàÎ®ºÌä∏ ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏
        function updateTournamentSettings() {
            if (!currentProject.tournamentSettings) currentProject.tournamentSettings = {};
            currentProject.tournamentSettings.thirdPlaceMatch = document.getElementById('third-place-edit')?.checked;
            currentProject.tournamentSettings.setsPerMatch = parseInt(document.getElementById('knockout-sets-edit')?.value) || 5;
            saveProjects();
        }
        
        // ========== PDF Ï∂úÎ†• Ìï®Ïàò ==========
        
        // ÌïúÍ∏Ä Ìè∞Ìä∏ Base64 Î°úÎìú (ÎÇòÎàîÍ≥†Îîï Í≤ΩÎüâÌôî Î≤ÑÏ†Ñ ÏÇ¨Ïö©)
        // jsPDFÎäî Í∏∞Î≥∏Ï†ÅÏúºÎ°ú ÌïúÍ∏ÄÏùÑ ÏßÄÏõêÌïòÏßÄ ÏïäÏúºÎØÄÎ°ú, Ïú†ÎãàÏΩîÎìú Î¨∏ÏûêÎ•º ÏòÅÏñ¥Î°ú Î≥ÄÌôòÌïòÍ±∞ÎÇò
        // Ïô∏Î∂Ä Ìè∞Ìä∏Î•º Î°úÎìúÌï¥Ïïº Ìï©ÎãàÎã§. Ïó¨Í∏∞ÏÑúÎäî Í∞ÑÎã®Ìûà Ï≤òÎ¶¨Ìï©ÎãàÎã§.
        
        function initPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Í∏∞Î≥∏ Ìè∞Ìä∏ ÏÑ§Ï†ï (ÌïúÍ∏Ä ÎØ∏ÏßÄÏõê Ïãú ÏòÅÎ¨∏ÏúºÎ°ú ÎåÄÏ≤¥)
            doc.setFont('helvetica');
            
            return doc;
        }
        
        // ÎåÄÌöå Í≤∞Í≥º Î≥¥Í≥†ÏÑú PDF
        function exportTournamentReport() {
            try {
                const doc = initPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = 20;
                
                // Ï†úÎ™©
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('IBSA Showdown Tournament Report', pageWidth / 2, y, { align: 'center' });
                y += 10;
                
                // ÎåÄÌöå Ï†ïÎ≥¥
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text(currentProject.name || 'Tournament', pageWidth / 2, y, { align: 'center' });
                y += 8;
                
                doc.setFontSize(10);
                const dateStr = currentProject.date || new Date().toLocaleDateString();
                const locationStr = currentProject.location || 'Location TBD';
                doc.text(`Date: ${dateStr} | Location: ${locationStr}`, pageWidth / 2, y, { align: 'center' });
                y += 15;
                
                // ÎåÄÌöå Ïú†Ìòï
                doc.setFontSize(12);
                const isTeam = currentProject.competitionType === 'team';
                const typeStr = isTeam ? 'Team Competition' : 'Individual Competition';
                const formatStr = currentProject.tournamentType === 'group' ? 'Group Stage' :
                    currentProject.tournamentType === 'tournament' ? 'Tournament' : 'Group + Knockout';
                doc.text(`Type: ${typeStr} | Format: ${formatStr}`, 20, y);
                y += 10;
                
                // Ï∞∏Í∞ÄÏûê Ïàò
                const participantCount = isTeam ? 
                    (currentProject.teams?.length || 0) : 
                    (currentProject.players?.length || 0);
                doc.text(`Participants: ${participantCount} ${isTeam ? 'teams' : 'players'}`, 20, y);
                y += 15;
                
                // Íµ¨Î∂ÑÏÑ†
                doc.setLineWidth(0.5);
                doc.line(20, y, pageWidth - 20, y);
                y += 10;
                
                // ÏµúÏ¢Ö ÏàúÏúÑ
                if (currentProject.standings?.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Final Standings', 20, y);
                    y += 8;
                    
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    const medals = ['1st (Gold)', '2nd (Silver)', '3rd (Bronze)', '4th'];
                    currentProject.standings.slice(0, 4).forEach((p, i) => {
                        doc.text(`${medals[i]}: ${p.name}`, 30, y);
                        y += 6;
                    });
                    y += 10;
                }
                
                // Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏöîÏïΩ
                if (currentProject.groups?.length > 0) {
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Group Stage Summary', 20, y);
                    y += 8;
                    
                    currentProject.groups.forEach((group, gi) => {
                        if (y > pageHeight - 40) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        doc.setFontSize(11);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`Group ${String.fromCharCode(65 + gi)}`, 25, y);
                        y += 6;
                        
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(9);
                        
                        const standings = calculateGroupStandings(group);
                        standings.forEach((p, pi) => {
                            const advanceCount = currentProject.groupSettings?.advanceCount || 2;
                            const prefix = pi < advanceCount ? '* ' : '  ';
                            doc.text(`${prefix}${pi + 1}. ${p.name} (W:${p.wins} L:${p.losses})`, 30, y);
                            y += 5;
                        });
                        y += 5;
                    });
                }
                
                // ÌÜµÍ≥Ñ
                const stats = calculateStatistics();
                if (stats.totalMatches > 0) {
                    if (y > pageHeight - 50) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Statistics', 20, y);
                    y += 8;
                    
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Total Matches: ${stats.totalMatches}`, 25, y); y += 5;
                    doc.text(`Completed: ${stats.completedMatches}`, 25, y); y += 5;
                }
                
                // Ìë∏ÌÑ∞
                doc.setFontSize(8);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 20, pageHeight - 10);
                doc.text('IBSA Showdown Referee App', pageWidth - 20, pageHeight - 10, { align: 'right' });
                
                // Ï†ÄÏû•
                const filename = `${currentProject.name || 'tournament'}_report_${Date.now()}.pdf`;
                doc.save(filename);
                announce('PDF saved: ' + filename);
                
            } catch (error) {
                console.error('PDF export error:', error);
                alert('PDF export failed. Please try again.');
            }
        }
        
        // Ï°∞Î≥Ñ Î¶¨Í∑∏ Í∏∞Î°ù PDF
        function exportGroupStageReport() {
            try {
                if (!currentProject.groups || currentProject.groups.length === 0) {
                    alert('No group stage data available.');
                    return;
                }
                
                const doc = initPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = 20;
                
                // Ï†úÎ™©
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('Group Stage Record', pageWidth / 2, y, { align: 'center' });
                y += 8;
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'normal');
                doc.text(currentProject.name || 'Tournament', pageWidth / 2, y, { align: 'center' });
                y += 15;
                
                // Í∞Å Ï°∞Î≥Ñ ÏÉÅÏÑ∏
                currentProject.groups.forEach((group, gi) => {
                    if (y > pageHeight - 80) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    // Ï°∞ Ìó§Îçî
                    doc.setFillColor(230, 230, 230);
                    doc.rect(20, y - 4, pageWidth - 40, 10, 'F');
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text(`Group ${String.fromCharCode(65 + gi)}`, 25, y + 3);
                    y += 15;
                    
                    // ÏàúÏúÑÌëú
                    const standings = calculateGroupStandings(group);
                    const advanceCount = currentProject.groupSettings?.advanceCount || 2;
                    
                    // ÌÖåÏù¥Î∏î Ìó§Îçî
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Rank', 25, y);
                    doc.text('Name', 45, y);
                    doc.text('W', 100, y);
                    doc.text('L', 115, y);
                    doc.text('Sets', 130, y);
                    doc.text('Diff', 155, y);
                    y += 2;
                    doc.line(20, y, pageWidth - 20, y);
                    y += 5;
                    
                    // ÌÖåÏù¥Î∏î ÎÇ¥Ïö©
                    doc.setFont('helvetica', 'normal');
                    standings.forEach((p, pi) => {
                        const qualified = pi < advanceCount ? 'Q' : '';
                        doc.text(`${pi + 1} ${qualified}`, 25, y);
                        doc.text(p.name.substring(0, 15), 45, y);
                        doc.text(String(p.wins), 100, y);
                        doc.text(String(p.losses), 115, y);
                        doc.text(`+${p.setWins}/-${p.setLosses}`, 130, y);
                        doc.text(`+${p.goalsFor}/-${p.goalsAgainst}`, 155, y);
                        y += 5;
                    });
                    y += 5;
                    
                    // Í≤ΩÍ∏∞ Í≤∞Í≥º
                    if (group.matches?.length > 0) {
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'bold');
                        doc.text('Match Results:', 25, y);
                        y += 5;
                        
                        doc.setFontSize(8);
                        doc.setFont('helvetica', 'normal');
                        group.matches.forEach((m, mi) => {
                            if (y > pageHeight - 20) {
                                doc.addPage();
                                y = 20;
                            }
                            
                            let resultStr = `${m.player1} vs ${m.player2}`;
                            if (m.status === 'completed' && m.result) {
                                const winner = m.result.winner;
                                const score = m.result.score1 ? 
                                    `${m.result.score1}:${m.result.score2}` : 
                                    `${m.result.player1Sets || 0}:${m.result.player2Sets || 0}`;
                                resultStr += ` - Winner: ${winner} (${score})`;
                            } else {
                                resultStr += ' - Pending';
                            }
                            doc.text(resultStr, 30, y);
                            y += 4;
                        });
                    }
                    y += 10;
                });
                
                // Ìë∏ÌÑ∞
                doc.setFontSize(8);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 20, pageHeight - 10);
                
                const filename = `${currentProject.name || 'tournament'}_groups_${Date.now()}.pdf`;
                doc.save(filename);
                announce('PDF saved: ' + filename);
                
            } catch (error) {
                console.error('PDF export error:', error);
                alert('PDF export failed.');
            }
        }
        
        // Í≤ΩÍ∏∞ Í∏∞Î°ùÏßÄ PDF
        function exportMatchRecords() {
            try {
                const matches = currentProject.matches || [];
                if (matches.length === 0) {
                    alert('No match records available.');
                    return;
                }
                
                const doc = initPDF();
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                
                matches.forEach((match, mi) => {
                    if (mi > 0) doc.addPage();
                    let y = 20;
                    
                    // Í≤ΩÍ∏∞ Ìó§Îçî
                    doc.setFillColor(50, 50, 50);
                    doc.rect(0, 0, pageWidth, 35, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(16);
                    doc.setFont('helvetica', 'bold');
                    doc.text('IBSA SHOWDOWN', pageWidth / 2, 12, { align: 'center' });
                    doc.setFontSize(12);
                    doc.text('Match Record Sheet', pageWidth / 2, 22, { align: 'center' });
                    doc.setFontSize(9);
                    doc.text(`Match #${mi + 1}`, pageWidth / 2, 30, { align: 'center' });
                    
                    doc.setTextColor(0, 0, 0);
                    y = 45;
                    
                    // ÎåÄÌöå Ï†ïÎ≥¥
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Tournament: ${currentProject.name || 'N/A'}`, 20, y);
                    doc.text(`Date: ${currentProject.date || new Date().toLocaleDateString()}`, 120, y);
                    y += 6;
                    doc.text(`Location: ${currentProject.location || 'N/A'}`, 20, y);
                    doc.text(`Referee: ${match.mainReferee || 'N/A'}`, 120, y);
                    y += 15;
                    
                    // ÏÑ†Ïàò Ï†ïÎ≥¥ Î∞ïÏä§
                    const boxWidth = (pageWidth - 50) / 2;
                    
                    // Player 1
                    doc.setFillColor(230, 240, 255);
                    doc.rect(20, y, boxWidth, 25, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(11);
                    doc.text('Player 1', 20 + boxWidth/2, y + 8, { align: 'center' });
                    doc.setFontSize(14);
                    doc.text(match.player1Name || 'Unknown', 20 + boxWidth/2, y + 18, { align: 'center' });
                    
                    // VS
                    doc.setFontSize(12);
                    doc.text('VS', pageWidth/2, y + 13, { align: 'center' });
                    
                    // Player 2
                    doc.setFillColor(255, 235, 235);
                    doc.rect(30 + boxWidth, y, boxWidth, 25, 'F');
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(11);
                    doc.text('Player 2', 30 + boxWidth + boxWidth/2, y + 8, { align: 'center' });
                    doc.setFontSize(14);
                    doc.text(match.player2Name || 'Unknown', 30 + boxWidth + boxWidth/2, y + 18, { align: 'center' });
                    
                    y += 35;
                    
                    // ÏÑ∏Ìä∏Î≥Ñ Ï†êÏàò
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Set Scores', 20, y);
                    y += 8;
                    
                    // ÏÑ∏Ìä∏ ÌÖåÏù¥Î∏î
                    const setScores = match.setScores || [];
                    const colWidth = 30;
                    const startX = 40;
                    
                    // Ìó§Îçî
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('', startX - 15, y);
                    for (let i = 0; i < (match.sets || 3); i++) {
                        doc.text(`Set ${i + 1}`, startX + i * colWidth, y, { align: 'center' });
                    }
                    doc.text('Total', startX + (match.sets || 3) * colWidth + 10, y, { align: 'center' });
                    y += 2;
                    doc.line(20, y, pageWidth - 20, y);
                    y += 6;
                    
                    // Player 1 Ï†êÏàò
                    doc.setFont('helvetica', 'normal');
                    doc.text(match.player1Name?.substring(0, 8) || 'P1', 20, y);
                    let p1Total = 0;
                    for (let i = 0; i < (match.sets || 3); i++) {
                        const score = setScores[i]?.player1 ?? '-';
                        if (typeof score === 'number') p1Total += score;
                        doc.text(String(score), startX + i * colWidth, y, { align: 'center' });
                    }
                    doc.text(String(p1Total), startX + (match.sets || 3) * colWidth + 10, y, { align: 'center' });
                    y += 6;
                    
                    // Player 2 Ï†êÏàò
                    doc.text(match.player2Name?.substring(0, 8) || 'P2', 20, y);
                    let p2Total = 0;
                    for (let i = 0; i < (match.sets || 3); i++) {
                        const score = setScores[i]?.player2 ?? '-';
                        if (typeof score === 'number') p2Total += score;
                        doc.text(String(score), startX + i * colWidth, y, { align: 'center' });
                    }
                    doc.text(String(p2Total), startX + (match.sets || 3) * colWidth + 10, y, { align: 'center' });
                    y += 15;
                    
                    // ÏäπÏûê
                    if (match.status === 'completed' && match.winner) {
                        doc.setFillColor(255, 215, 0);
                        doc.rect(60, y, pageWidth - 120, 12, 'F');
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.text(`WINNER: ${match.winner}`, pageWidth / 2, y + 8, { align: 'center' });
                        y += 20;
                    }
                    
                    // ÌååÏö∏ Í∏∞Î°ù
                    y += 5;
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Foul Record', 20, y);
                    y += 8;
                    
                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');
                    
                    const p1Fouls = match.fouls?.filter(f => f.player === 1) || [];
                    const p2Fouls = match.fouls?.filter(f => f.player === 2) || [];
                    
                    doc.text(`${match.player1Name || 'P1'}: ${p1Fouls.length} fouls`, 25, y);
                    if (p1Fouls.length > 0) {
                        const foulTypes = p1Fouls.map(f => f.type).join(', ');
                        doc.text(foulTypes.substring(0, 60), 30, y + 5);
                    }
                    y += 12;
                    
                    doc.text(`${match.player2Name || 'P2'}: ${p2Fouls.length} fouls`, 25, y);
                    if (p2Fouls.length > 0) {
                        const foulTypes = p2Fouls.map(f => f.type).join(', ');
                        doc.text(foulTypes.substring(0, 60), 30, y + 5);
                    }
                    y += 20;
                    
                    // ÏÑúÎ™ÖÎûÄ
                    doc.line(20, pageHeight - 35, 80, pageHeight - 35);
                    doc.line(pageWidth - 80, pageHeight - 35, pageWidth - 20, pageHeight - 35);
                    doc.setFontSize(8);
                    doc.text('Referee Signature', 50, pageHeight - 30, { align: 'center' });
                    doc.text('Official Signature', pageWidth - 50, pageHeight - 30, { align: 'center' });
                    
                    // Ìë∏ÌÑ∞
                    doc.text(`Page ${mi + 1} of ${matches.length}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                });
                
                const filename = `${currentProject.name || 'tournament'}_matches_${Date.now()}.pdf`;
                doc.save(filename);
                announce('PDF saved: ' + filename);
                
            } catch (error) {
                console.error('PDF export error:', error);
                alert('PDF export failed.');
            }
        }
        
        // ========== ÏûêÎèô ÎåÄÌöå ÏßÑÌñâ Ìï®Ïàò ==========
        
        const KOREAN_SURNAMES = ['ÍπÄ', 'Ïù¥', 'Î∞ï', 'Ïµú', 'Ï†ï', 'Í∞ï', 'Ï°∞', 'Ïú§', 'Ïû•', 'ÏûÑ', 'Ìïú', 'Ïò§', 'ÏÑú', 'Ïã†', 'Í∂å', 'Ìô©', 'Ïïà', 'ÏÜ°', 'Î•ò', 'Ìôç'];
        const KOREAN_NAMES_MALE = ['ÎØºÏàò', 'Ï§ÄÌò∏', 'ÏÑ±ÎØº', 'ÎèôÌòÑ', 'ÏäπÏö∞', 'ÌòÑÏö∞', 'ÏßÄÌõà', 'ÌÉúÌõà', 'ÏäπÌòÑ', 'Ï†ïÏö∞', 'ÌòÑÏ§Ä', 'ÎèÑÏú§', 'ÏãúÏö∞', 'Ï£ºÏõê', 'ÏòàÏ§Ä'];
        const KOREAN_NAMES_FEMALE = ['ÏòÅÌù¨', 'ÏàòÏßÑ', 'ÏßÄÏõê', 'ÎØ∏ÎûÄ', 'ÎÇòÏòÅ', 'Ïú†ÏßÑ', 'ÏÑúÏó∞', 'ÎØºÏßÄ', 'ÌïòÏùÄ', 'ÏßÄÏú†', 'ÏÑúÌòÑ', 'ÏàòÎπà', 'ÏòàÏßÑ', 'Îã§ÏùÄ', 'Ï±ÑÏõê'];
        const TEAM_CITIES = ['ÏÑúÏö∏', 'Î∂ÄÏÇ∞', 'ÎåÄÍµ¨', 'Ïù∏Ï≤ú', 'Í¥ëÏ£º', 'ÎåÄÏ†Ñ', 'Ïö∏ÏÇ∞', 'ÏÑ∏Ï¢Ö', 'ÏàòÏõê', 'Í≥†Ïñë', 'Ïö©Ïù∏', 'Ï∞ΩÏõê', 'ÏÑ±ÎÇ®', 'Ï≤≠Ï£º', 'Ï†ÑÏ£º', 'Ï≤úÏïà'];
        
        function generateRandomName(gender) {
            const surname = KOREAN_SURNAMES[Math.floor(Math.random() * KOREAN_SURNAMES.length)];
            const names = gender === 'male' ? KOREAN_NAMES_MALE : KOREAN_NAMES_FEMALE;
            const name = names[Math.floor(Math.random() * names.length)];
            return surname + name;
        }
        
        function autoSimulateMatch(p1, p2, isTeam, sets = 3) {
            const history = [];
            
            if (isTeam) {
                // ÌåÄÏ†Ñ: 31Ï†ê 2Ï†êÏ∞®
                let s1 = 0, s2 = 0;
                while (true) {
                    const prevS1 = s1, prevS2 = s2;
                    const points = Math.random() < 0.3 ? 2 : 1;
                    const isP1Score = Math.random() < 0.5;
                    
                    if (isP1Score) {
                        s1 += points;
                        history.push({
                            player: p1,
                            type: 'goal',
                            points: points,
                            scoreBefore: `${prevS1}:${prevS2}`,
                            scoreAfter: `${s1}:${s2}`
                        });
                    } else {
                        s2 += points;
                        history.push({
                            player: p2,
                            type: 'goal',
                            points: points,
                            scoreBefore: `${prevS1}:${prevS2}`,
                            scoreAfter: `${s1}:${s2}`
                        });
                    }
                    
                    if (s1 >= 31 && s1 - s2 >= 2) return { winner: p1, loser: p2, score: `${s1}:${s2}`, s1, s2, setScores: [{s1, s2}], history };
                    if (s2 >= 31 && s2 - s1 >= 2) return { winner: p2, loser: p1, score: `${s2}:${s1}`, s1: s2, s2: s1, setScores: [{s1: s2, s2: s1}], history };
                    if (s1 > 40 || s2 > 40) {
                        return s1 > s2 ? 
                            { winner: p1, loser: p2, score: `${s1}:${s2}`, s1, s2, setScores: [{s1, s2}], history } : 
                            { winner: p2, loser: p1, score: `${s2}:${s1}`, s1: s2, s2: s1, setScores: [{s1: s2, s2: s1}], history };
                    }
                }
            } else {
                // Í∞úÏù∏Ï†Ñ: NÏÑ∏Ìä∏ (sets ÌååÎùºÎØ∏ÌÑ∞ ÏÇ¨Ïö©)
                const winsNeeded = Math.ceil(sets / 2);
                let sets1 = 0, sets2 = 0;
                const setScores = [];
                let totalP1 = 0, totalP2 = 0;
                
                while (sets1 < winsNeeded && sets2 < winsNeeded) {
                    let s1 = 0, s2 = 0;
                    const setNum = setScores.length + 1;
                    
                    // ÏÑ∏Ìä∏ ÏßÑÌñâ ÏãúÎÆ¨Î†àÏù¥ÏÖò
                    while (true) {
                        const prevS1 = s1, prevS2 = s2;
                        const isP1Score = Math.random() < 0.5;
                        
                        if (isP1Score) {
                            s1++;
                            history.push({
                                player: p1,
                                type: 'goal',
                                points: 1,
                                set: setNum,
                                scoreBefore: `${prevS1}:${prevS2}`,
                                scoreAfter: `${s1}:${s2}`
                            });
                        } else {
                            s2++;
                            history.push({
                                player: p2,
                                type: 'goal',
                                points: 1,
                                set: setNum,
                                scoreBefore: `${prevS1}:${prevS2}`,
                                scoreAfter: `${s1}:${s2}`
                            });
                        }
                        
                        // ÏÑ∏Ìä∏ Ï¢ÖÎ£å Ï°∞Í±¥: 11Ï†ê Ïù¥ÏÉÅ, 2Ï†êÏ∞®
                        if (s1 >= 11 && s1 - s2 >= 2) break;
                        if (s2 >= 11 && s2 - s1 >= 2) break;
                        // ÎìÄÏä§ ÏÉÅÌïú (ÏïàÏ†ÑÏû•Ïπò)
                        if (s1 >= 15 && s1 > s2) break;
                        if (s2 >= 15 && s2 > s1) break;
                    }
                    
                    setScores.push({ s1, s2 });
                    totalP1 += s1; totalP2 += s2;
                    if (s1 > s2) sets1++; else sets2++;
                }
                const winner = sets1 > sets2 ? p1 : p2;
                return { 
                    winner, 
                    loser: winner === p1 ? p2 : p1, 
                    score: `${sets1}:${sets2}`, 
                    sets1, sets2, 
                    setScores,
                    totalP1, totalP2,
                    history
                };
            }
        }
        
        function runAutoTournament() {
            const isTeam = currentProject.competitionType === 'team';
            const count = parseInt(document.getElementById('auto-participant-count').value);
            const groupCount = parseInt(document.getElementById('auto-group-count').value);
            const advanceCount = parseInt(document.getElementById('auto-advance-count').value);
            const thirdPlace = document.getElementById('auto-third-place').value === 'yes';
            const fiveSetStart = !isTeam ? (document.getElementById('auto-5set-start')?.value || 'quarter') : null;
            const rankingType = document.getElementById('auto-ranking-type').value;
            
            // ÌÉëÏãúÎìú ÏàòÏßë
            const topSeeds = [];
            for (let i = 0; i < groupCount; i++) {
                const seedInput = document.getElementById(`seed-${String.fromCharCode(65 + i)}`);
                const seedName = seedInput?.value?.trim();
                topSeeds.push(seedName || null);
            }
            
            // ÎùºÏö¥ÎìúÎ≥Ñ ÏÑ∏Ìä∏ Ïàò Í≤∞Ï†ï Ìï®Ïàò
            function getSetsForRound(round) {
                if (isTeam) return 1;
                if (round === 'group') return 3;
                
                const roundOrder = { 'r16': 1, 'quarter': 2, 'semi': 3, 'final': 4 };
                const startOrder = { 'r16': 1, 'quarter': 2, 'semi': 3, 'final': 4, 'all': 1 };
                
                if (fiveSetStart === 'all') return 5;
                return roundOrder[round] >= startOrder[fiveSetStart] ? 5 : 3;
            }
            
            const result = {
                settings: { count, groupCount, advanceCount, thirdPlace, isTeam, fiveSetStart, rankingType, topSeeds },
                participants: [],
                groups: [],
                groupMatches: [],
                groupStandings: [],
                knockoutRounds: [],
                playerRecords: {}, // Í∞úÏù∏Î≥Ñ ÏÉÅÏÑ∏ Í∏∞Î°ù
                finalStandings: []
            };
            
            // 1. Ï∞∏Í∞ÄÏûê ÏÉùÏÑ± (ÌÉëÏãúÎìú Ïö∞ÏÑ†)
            const usedNames = [];
            const extendedCities = [...TEAM_CITIES, 'Ï∂òÏ≤ú', 'ÏõêÏ£º', 'Ï†úÏ£º', 'Ìè¨Ìï≠', 'ÍπÄÌï¥', 'ÎÇ®ÏñëÏ£º', 'ÌôîÏÑ±', 'ÌèâÌÉù', 'ÏùòÏ†ïÎ∂Ä', 'ÏãúÌù•', 'ÌååÏ£º', 'Í¥ëÎ™Ö', 'ÍπÄÌè¨', 'Íµ∞Ìè¨', 'Ïò§ÏÇ∞', 'Ïù¥Ï≤ú'];
            
            // ÌÉëÏãúÎìú Î®ºÏ†Ä Ï∂îÍ∞Ä
            topSeeds.forEach(name => {
                if (name) usedNames.push(name);
            });
            
            for (let i = 0; i < count; i++) {
                let name;
                
                // Ï°∞Î≥Ñ ÌÉëÏãúÎìú ÏúÑÏπò ÌôïÏù∏ (Í∞Å Ï°∞Îãπ Ï≤´ Î≤àÏß∏)
                const perGroup = Math.ceil(count / groupCount);
                const groupIdx = Math.floor(i / perGroup);
                const posInGroup = i % perGroup;
                
                // ÌÉëÏãúÎìúÏù∏ Í≤ΩÏö∞
                if (posInGroup === 0 && topSeeds[groupIdx]) {
                    name = topSeeds[groupIdx];
                } else {
                    // ÏûêÎèô ÏÉùÏÑ±
                    if (isTeam) {
                        do { name = extendedCities[Math.floor(Math.random() * extendedCities.length)]; }
                        while (usedNames.includes(name));
                    } else {
                        do { name = generateRandomName(Math.random() < 0.5 ? 'male' : 'female'); }
                        while (usedNames.includes(name));
                    }
                    usedNames.push(name);
                }
                
                if (isTeam) {
                    const members = [];
                    const mc = Math.random() < 0.5 ? 2 : 1;
                    for (let j = 0; j < mc; j++) members.push({ name: generateRandomName('male'), gender: 'M' });
                    for (let j = 0; j < 3 - mc; j++) members.push({ name: generateRandomName('female'), gender: 'F' });
                    result.participants.push({ name, members });
                } else {
                    result.participants.push({ name });
                }
                
                // Í∞úÏù∏ Í∏∞Î°ù Ï¥àÍ∏∞Ìôî
                result.playerRecords[result.participants[i].name] = {
                    name: result.participants[i].name,
                    matches: [],
                    totalWins: 0, totalLosses: 0,
                    setWins: 0, setLosses: 0,
                    pointsFor: 0, pointsAgainst: 0,
                    group: null, groupRank: null,
                    knockoutRound: null, finalRank: null
                };
            }
            
            // 2. Ï°∞ Ìé∏ÏÑ± (Ïä§ÎÑ§Ïù¥ÌÅ¨ Î∞©Ïãù)
            const shuffled = [...result.participants].sort(() => Math.random() - 0.5);
            for (let i = 0; i < groupCount; i++) {
                result.groups.push({ name: String.fromCharCode(65 + i) + 'Ï°∞', players: [] });
            }
            shuffled.forEach((p, idx) => {
                const round = Math.floor(idx / groupCount);
                const gi = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                result.groups[gi].players.push(p.name);
                result.playerRecords[p.name].group = String.fromCharCode(65 + gi) + 'Ï°∞';
            });
            
            // 3. Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏßÑÌñâ
            result.groups.forEach((group, gi) => {
                const stats = {};
                group.players.forEach(p => { 
                    stats[p] = { wins: 0, losses: 0, pf: 0, pa: 0, sw: 0, sl: 0 }; 
                });
                
                const matches = [];
                for (let i = 0; i < group.players.length; i++) {
                    for (let j = i + 1; j < group.players.length; j++) {
                        const p1 = group.players[i], p2 = group.players[j];
                        const m = autoSimulateMatch(p1, p2, isTeam, getSetsForRound('group'));
                        
                        const matchRecord = {
                            stage: 'Ï°∞Î≥ÑÎ¶¨Í∑∏',
                            group: group.name,
                            opponent: null,
                            result: null,
                            score: m.score,
                            setScores: m.setScores,
                            history: m.history || [],
                            setsWon: isTeam ? (m.winner === p1 ? 1 : 0) : m.sets1,
                            setsLost: isTeam ? (m.winner === p1 ? 0 : 1) : m.sets2
                        };
                        
                        // P1 Í∏∞Î°ù
                        const p1Record = { ...matchRecord, opponent: p2, result: m.winner === p1 ? 'Ïäπ' : 'Ìå®' };
                        result.playerRecords[p1].matches.push(p1Record);
                        
                        // P2 Í∏∞Î°ù
                        const p2Record = { 
                            ...matchRecord, 
                            opponent: p1, 
                            result: m.winner === p2 ? 'Ïäπ' : 'Ìå®',
                            setsWon: isTeam ? (m.winner === p2 ? 1 : 0) : m.sets2,
                            setsLost: isTeam ? (m.winner === p2 ? 0 : 1) : m.sets1
                        };
                        result.playerRecords[p2].matches.push(p2Record);
                        
                        matches.push({ p1, p2, winner: m.winner, score: m.score, setScores: m.setScores, history: m.history || [] });
                        
                        stats[m.winner].wins++;
                        stats[m.loser].losses++;
                        
                        if (isTeam) {
                            stats[p1].pf += m.s1; stats[p1].pa += m.s2;
                            stats[p2].pf += m.s2; stats[p2].pa += m.s1;
                            result.playerRecords[p1].pointsFor += m.s1;
                            result.playerRecords[p1].pointsAgainst += m.s2;
                            result.playerRecords[p2].pointsFor += m.s2;
                            result.playerRecords[p2].pointsAgainst += m.s1;
                        } else {
                            stats[p1].sw += m.sets1; stats[p1].sl += m.sets2;
                            stats[p2].sw += m.sets2; stats[p2].sl += m.sets1;
                            result.playerRecords[p1].setWins += m.sets1;
                            result.playerRecords[p1].setLosses += m.sets2;
                            result.playerRecords[p2].setWins += m.sets2;
                            result.playerRecords[p2].setLosses += m.sets1;
                            // ÎìùÏ†êÎèÑ Í∏∞Î°ù
                            result.playerRecords[p1].pointsFor += m.totalP1;
                            result.playerRecords[p1].pointsAgainst += m.totalP2;
                            result.playerRecords[p2].pointsFor += m.totalP2;
                            result.playerRecords[p2].pointsAgainst += m.totalP1;
                        }
                    }
                }
                result.groupMatches.push({ group: group.name, matches });
                
                // ÏàúÏúÑ Ï†ïÎ†¨
                const sorted = [...group.players].sort((a, b) => {
                    if (stats[b].wins !== stats[a].wins) return stats[b].wins - stats[a].wins;
                    if (isTeam) return (stats[b].pf - stats[b].pa) - (stats[a].pf - stats[a].pa);
                    const setDiffB = stats[b].sw - stats[b].sl;
                    const setDiffA = stats[a].sw - stats[a].sl;
                    if (setDiffB !== setDiffA) return setDiffB - setDiffA;
                    return (stats[b].pf - stats[b].pa) - (stats[a].pf - stats[a].pa);
                });
                
                result.groupStandings.push({
                    group: group.name,
                    standings: sorted.map((p, idx) => {
                        result.playerRecords[p].groupRank = idx + 1;
                        result.playerRecords[p].totalWins = stats[p].wins;
                        result.playerRecords[p].totalLosses = stats[p].losses;
                        return {
                            rank: idx + 1, name: p, ...stats[p],
                            qualified: idx < advanceCount
                        };
                    })
                });
            });
            
            // 4. Î≥∏ÏÑ† ÏßÑÏ∂úÏûê ÏàòÏßë
            const qualifiers = [];
            result.groupStandings.forEach(g => {
                g.standings.filter(p => p.qualified).forEach(p => {
                    qualifiers.push({ 
                        name: p.name, 
                        group: g.group, 
                        rank: p.rank,
                        stats: p
                    });
                    result.playerRecords[p.name].knockoutRound = 'Î≥∏ÏÑ†ÏßÑÏ∂ú';
                });
            });
            
            // 5. Í≤∞ÏÑ† ÌÜ†ÎÑàÎ®ºÌä∏
            if (qualifiers.length >= 2) {
                // ÌÜ†ÎÑàÎ®ºÌä∏ ÌÅ¨Í∏∞ Í≤∞Ï†ï (2Ïùò Í±∞Îì≠Ï†úÍ≥±ÏúºÎ°ú)
                let bracketSize = 2;
                while (bracketSize < qualifiers.length) bracketSize *= 2;
                
                // ÏãúÎìú Î∞∞Ï†ï (Ï°∞ 1ÏúÑ Ïö∞ÏÑ†, ÍµêÏ∞® Î∞∞Ï†ï)
                const seeded = [];
                const maxRank = Math.max(...qualifiers.map(q => q.rank));
                for (let r = 1; r <= maxRank; r++) {
                    const sameRank = qualifiers.filter(q => q.rank === r)
                        .sort((a, b) => a.group.localeCompare(b.group));
                    seeded.push(...sameRank);
                }
                
                // Î∂ÄÏ†ÑÏäπ Ï∂îÍ∞Ä
                while (seeded.length < bracketSize) {
                    seeded.push({ name: 'BYE', group: '-', rank: 99 });
                }
                
                // ÎåÄÏßÑÌëú ÏÉùÏÑ± (ÏãúÎìú Î∞∞Ï†ï)
                const bracket = [];
                for (let i = 0; i < bracketSize / 2; i++) {
                    bracket.push([seeded[i], seeded[bracketSize - 1 - i]]);
                }
                
                // ÎùºÏö¥Îìú Ïù¥Î¶Ñ Í≤∞Ï†ï
                function getRoundName(remaining) {
                    if (remaining === 2) return 'Í≤∞Ïäπ';
                    if (remaining === 4) return 'Ï§ÄÍ≤∞Ïäπ';
                    if (remaining === 8) return '8Í∞ï';
                    if (remaining === 16) return '16Í∞ï';
                    if (remaining === 32) return '32Í∞ï';
                    return `${remaining}Í∞ï`;
                }
                
                function getRoundCode(remaining) {
                    if (remaining === 2) return 'final';
                    if (remaining === 4) return 'semi';
                    if (remaining === 8) return 'quarter';
                    if (remaining === 16) return 'r16';
                    return 'r32';
                }
                
                // Í∞Å ÎùºÏö¥Îìú ÏßÑÌñâ
                let currentBracket = bracket;
                let losers = []; // Ìå®ÏûêÎì§ Ï†ÄÏû• (Ï†ÑÏ≤¥ ÏàúÏúÑÏö©)
                
                while (currentBracket.length >= 1) {
                    const remaining = currentBracket.length * 2;
                    const roundName = getRoundName(remaining);
                    const roundCode = getRoundCode(remaining);
                    const setsForRound = getSetsForRound(roundCode);
                    const roundMatches = [];
                    const nextBracket = [];
                    const roundLosers = [];
                    
                    for (const match of currentBracket) {
                        const p1 = match[0];
                        const p2 = match[1];
                        
                        // Î∂ÄÏ†ÑÏäπ Ï≤òÎ¶¨
                        if (p2.name === 'BYE') {
                            nextBracket.push([p1, null]);
                            continue;
                        }
                        if (p1.name === 'BYE') {
                            nextBracket.push([p2, null]);
                            continue;
                        }
                        
                        const m = autoSimulateMatch(p1.name, p2.name, isTeam, setsForRound);
                        
                        roundMatches.push({
                            p1: p1.name, p2: p2.name,
                            winner: m.winner, loser: m.loser,
                            score: m.score, setScores: m.setScores,
                            history: m.history || [],
                            sets: setsForRound
                        });
                        
                        // Í∞úÏù∏ Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏
                        [p1.name, p2.name].forEach(pName => {
                            const isWinner = m.winner === pName;
                            const opponent = isWinner ? m.loser : m.winner;
                            result.playerRecords[pName].matches.push({
                                stage: roundName,
                                opponent,
                                result: isWinner ? 'Ïäπ' : 'Ìå®',
                                score: m.score,
                                setScores: m.setScores,
                                history: m.history || []
                            });
                            result.playerRecords[pName].totalWins += isWinner ? 1 : 0;
                            result.playerRecords[pName].totalLosses += isWinner ? 0 : 1;
                            if (!isTeam) {
                                result.playerRecords[pName].setWins += isWinner ? m.sets1 : m.sets2;
                                result.playerRecords[pName].setLosses += isWinner ? m.sets2 : m.sets1;
                            }
                            result.playerRecords[pName].knockoutRound = roundName;
                        });
                        
                        const winner = m.winner === p1.name ? p1 : p2;
                        const loser = m.winner === p1.name ? p2 : p1;
                        nextBracket.push([winner, null]);
                        roundLosers.push({ ...loser, eliminatedAt: roundName });
                    }
                    
                    if (roundMatches.length > 0) {
                        result.knockoutRounds.push({ round: roundName, sets: setsForRound, matches: roundMatches });
                    }
                    
                    losers.push(...roundLosers);
                    
                    // Í≤∞ÏäπÏù¥Î©¥ Ï¢ÖÎ£å
                    if (currentBracket.length === 1) break;
                    
                    // Îã§Ïùå ÎùºÏö¥Îìú ÎåÄÏßÑ Íµ¨ÏÑ±
                    currentBracket = [];
                    for (let i = 0; i < nextBracket.length; i += 2) {
                        if (nextBracket[i + 1]) {
                            currentBracket.push([nextBracket[i][0], nextBracket[i + 1][0]]);
                        } else if (nextBracket[i]) {
                            currentBracket.push([nextBracket[i][0], { name: 'BYE' }]);
                        }
                    }
                }
                
                // 3/4ÏúÑÏ†Ñ
                if (thirdPlace && losers.length >= 2) {
                    const semiLosers = losers.filter(l => l.eliminatedAt === 'Ï§ÄÍ≤∞Ïäπ');
                    if (semiLosers.length === 2) {
                        const m = autoSimulateMatch(semiLosers[0].name, semiLosers[1].name, isTeam, getSetsForRound('semi'));
                        result.knockoutRounds.push({
                            round: '3/4ÏúÑÏ†Ñ',
                            sets: getSetsForRound('semi'),
                            matches: [{
                                p1: semiLosers[0].name, p2: semiLosers[1].name,
                                winner: m.winner, loser: m.loser,
                                score: m.score, setScores: m.setScores,
                                history: m.history || []
                            }]
                        });
                        
                        // Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏
                        result.playerRecords[m.winner].finalRank = 3;
                        result.playerRecords[m.loser].finalRank = 4;
                    }
                }
                
                // ÏµúÏ¢Ö ÏàúÏúÑ Í≤∞Ï†ï
                const finalRound = result.knockoutRounds.find(r => r.round === 'Í≤∞Ïäπ');
                if (finalRound && finalRound.matches.length > 0) {
                    const finalMatch = finalRound.matches[0];
                    result.playerRecords[finalMatch.winner].finalRank = 1;
                    result.playerRecords[finalMatch.loser].finalRank = 2;
                }
            }
            
            // 6. Ï†ÑÏ≤¥ ÏàúÏúÑ ÏÇ∞Ï∂ú
            const allPlayers = Object.values(result.playerRecords);
            
            if (rankingType === 'all-ranked') {
                // Ï†ÑÏ≤¥ Ï∞∏Í∞ÄÏûê ÏàúÏúÑ
                // 1. Î≥∏ÏÑ† Í≤∞Í≥ºÎ°ú ÏàúÏúÑ ÏûàÎäî ÏÇ¨Îûå
                // 2. Î≥∏ÏÑ† ÌÉàÎùΩ ÎùºÏö¥ÎìúÎ≥Ñ (8Í∞ï ÌÉàÎùΩ > 16Í∞ï ÌÉàÎùΩ)
                // 3. Ï°∞Î≥Ñ ÌÉàÎùΩÏûêÎäî Ï°∞ ÏàúÏúÑ + ÎìùÏã§Î°ú
                
                const roundOrder = { 'Í≤∞Ïäπ': 1, 'Ï§ÄÍ≤∞Ïäπ': 2, '8Í∞ï': 3, '16Í∞ï': 4, '32Í∞ï': 5, 'Î≥∏ÏÑ†ÏßÑÏ∂ú': 6 };
                
                allPlayers.sort((a, b) => {
                    // ÏµúÏ¢Ö ÏàúÏúÑÍ∞Ä ÏûàÏúºÎ©¥ Ïö∞ÏÑ†
                    if (a.finalRank && b.finalRank) return a.finalRank - b.finalRank;
                    if (a.finalRank) return -1;
                    if (b.finalRank) return 1;
                    
                    // Î≥∏ÏÑ† ÏßÑÏ∂ú Ïó¨Î∂Ä
                    const aKO = roundOrder[a.knockoutRound] || 99;
                    const bKO = roundOrder[b.knockoutRound] || 99;
                    if (aKO !== bKO) return aKO - bKO;
                    
                    // Ï°∞ ÏàúÏúÑ
                    if (a.groupRank !== b.groupRank) return a.groupRank - b.groupRank;
                    
                    // ÏäπÎ•†
                    const aWinRate = a.totalWins / (a.totalWins + a.totalLosses || 1);
                    const bWinRate = b.totalWins / (b.totalWins + b.totalLosses || 1);
                    if (aWinRate !== bWinRate) return bWinRate - aWinRate;
                    
                    // ÏÑ∏Ìä∏ ÎìùÏã§
                    const aSetDiff = a.setWins - a.setLosses;
                    const bSetDiff = b.setWins - b.setLosses;
                    if (aSetDiff !== bSetDiff) return bSetDiff - aSetDiff;
                    
                    // Í≥® ÎìùÏã§
                    return (b.pointsFor - b.pointsAgainst) - (a.pointsFor - a.pointsAgainst);
                });
                
                allPlayers.forEach((p, idx) => {
                    if (!p.finalRank) p.finalRank = idx + 1;
                    result.finalStandings.push({ rank: p.finalRank, name: p.name, record: p });
                });
            } else {
                // Î≥∏ÏÑ† ÏßÑÏ∂úÏûêÎßå
                allPlayers
                    .filter(p => p.finalRank)
                    .sort((a, b) => a.finalRank - b.finalRank)
                    .forEach(p => {
                        result.finalStandings.push({ rank: p.finalRank, name: p.name, record: p });
                    });
            }
            
            // Í≤∞Í≥º Ï†ÄÏû•
            currentProject.autoTournamentResult = result;
            saveProjects();
            
            // Í≤∞Í≥º ÌëúÏãú
            document.getElementById('auto-tournament-result').style.display = 'block';
            document.getElementById('auto-tournament-result').innerHTML = renderAutoTournamentResult();
            announce('ÎåÄÌöå ÏßÑÌñâ ÏôÑÎ£å!');
        }
        
        function renderAutoTournamentResult() {
            const r = currentProject.autoTournamentResult;
            if (!r) return '';
            
            const isTeam = r.settings.isTeam;
            let html = '';
            
            // ÎåÄÌöå ÏÑ§Ï†ï ÏöîÏïΩ
            html += `<div style="margin-bottom:16px; padding:12px; background:#e3f2fd; border-radius:8px;">`;
            html += `<h4 style="margin-bottom:8px;">ÎåÄÌöå ÏÑ§Ï†ï</h4>`;
            html += `<p style="font-size:13px; margin:0;">`;
            html += `${r.settings.count}${isTeam ? 'ÌåÄ' : 'Î™Ö'} / ${r.settings.groupCount}Í∞úÏ°∞ / `;
            html += `Ï°∞Î≥Ñ ${r.settings.advanceCount}${isTeam ? 'ÌåÄ' : 'Î™Ö'} ÏßÑÏ∂ú / `;
            html += `${r.settings.thirdPlace ? '3/4ÏúÑÏ†Ñ ÏßÑÌñâ' : '3/4ÏúÑÏ†Ñ ÏÉùÎûµ'}`;
            if (!isTeam && r.settings.fiveSetStart) {
                const fiveSetText = { 'final': 'Í≤∞ÏäπÎßå', 'semi': '4Í∞ïÎ∂ÄÌÑ∞', 'quarter': '8Í∞ïÎ∂ÄÌÑ∞', 'r16': '16Í∞ïÎ∂ÄÌÑ∞', 'all': 'Î≥∏ÏÑ† Ï†ÑÏ≤¥' };
                html += ` / ${fiveSetText[r.settings.fiveSetStart]} 5ÏÑ∏Ìä∏`;
            }
            html += `</p></div>`;
            
            // Ï∞∏Í∞ÄÏûê
            html += `<div style="margin-bottom:16px; padding:12px; background:var(--bg-secondary); border-radius:8px;">`;
            html += `<h4 style="margin-bottom:8px;">Ï∞∏Í∞Ä${isTeam ? 'ÌåÄ' : 'Ïûê'} (${r.participants.length}${isTeam ? 'ÌåÄ' : 'Î™Ö'})</h4>`;
            html += `<p style="font-size:13px;">${r.participants.map(p => p.name).join(', ')}</p>`;
            html += `</div>`;
            
            // Ï°∞ Ìé∏ÏÑ±
            html += `<div style="margin-bottom:16px;">`;
            html += `<h4 style="margin-bottom:8px;">Ï°∞ Ìé∏ÏÑ± (${r.groups.length}Í∞úÏ°∞)</h4>`;
            html += `<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:8px;">`;
            r.groups.forEach(g => {
                html += `<div style="padding:8px; background:var(--bg-secondary); border-radius:4px;">`;
                html += `<strong>${g.name}</strong>: ${g.players.join(', ')}`;
                html += `</div>`;
            });
            html += `</div></div>`;
            
            // Ï°∞Î≥Ñ Î¶¨Í∑∏ Í≤∞Í≥º + ÏàúÏúÑ
            html += `<div style="margin-bottom:16px;">`;
            html += `<h4 style="margin-bottom:8px;">‚öΩ Ï°∞Î≥Ñ Î¶¨Í∑∏</h4>`;
            
            r.groupStandings.forEach((gs, gi) => {
                const gm = r.groupMatches[gi];
                html += `<div style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid var(--primary);">`;
                html += `<strong style="font-size:15px;">${gs.group}</strong>`;
                
                // ÏàúÏúÑÌëú
                html += `<table style="width:100%; margin:8px 0; font-size:12px; border-collapse:collapse;">`;
                html += `<tr style="background:#e0e0e0;"><th>ÏàúÏúÑ</th><th>Ïù¥Î¶Ñ</th><th>Ïäπ</th><th>Ìå®</th>`;
                html += isTeam ? `<th>ÎìùÏ†ê</th><th>Ïã§Ï†ê</th><th>ÎìùÏã§</th>` : `<th>ÏÑ∏Ìä∏</th><th>ÎìùÏã§</th>`;
                html += `</tr>`;
                gs.standings.forEach(p => {
                    const bg = p.qualified ? '#e8f5e9' : 'white';
                    const diff = isTeam ? (p.pf - p.pa) : (p.sw - p.sl);
                    const diffStr = diff > 0 ? `+${diff}` : diff;
                    html += `<tr style="background:${bg};">`;
                    html += `<td style="padding:4px; text-align:center;">${p.qualified ? 'üèÜ' : ''}${p.rank}</td>`;
                    html += `<td style="padding:4px;">${p.name}</td>`;
                    html += `<td style="padding:4px; text-align:center;">${p.wins}</td>`;
                    html += `<td style="padding:4px; text-align:center;">${p.losses}</td>`;
                    if (isTeam) {
                        html += `<td style="padding:4px; text-align:center;">${p.pf}</td>`;
                        html += `<td style="padding:4px; text-align:center;">${p.pa}</td>`;
                    } else {
                        html += `<td style="padding:4px; text-align:center;">${p.sw}:${p.sl}</td>`;
                    }
                    html += `<td style="padding:4px; text-align:center; color:${diff > 0 ? 'green' : diff < 0 ? 'red' : 'black'};">${diffStr}</td>`;
                    html += `</tr>`;
                });
                html += `</table>`;
                
                // Í≤ΩÍ∏∞ Í≤∞Í≥º
                html += `<details><summary style="cursor:pointer; font-size:12px; color:var(--text-secondary);">Í≤ΩÍ∏∞ ÏÉÅÏÑ∏ (${gm.matches.length}Í≤ΩÍ∏∞)</summary>`;
                html += `<div style="margin-top:8px; font-size:11px;">`;
                gm.matches.forEach((m, mi) => {
                    const setDetail = m.setScores ? m.setScores.map(s => `${s.s1}-${s.s2}`).join(', ') : '';
                    html += `<div style="padding:8px; margin:4px 0; background:#f5f5f5; border-radius:4px;">`;
                    html += `<div>${m.p1} vs ${m.p2}: <strong>${m.winner}</strong> (${m.score}) ${setDetail ? `[${setDetail}]` : ''}</div>`;
                    
                    // ÎìùÏ†ê ÌûàÏä§ÌÜ†Î¶¨
                    if (m.history && m.history.length > 0) {
                        html += `<details style="margin-top:4px;"><summary style="cursor:pointer; font-size:10px; color:var(--primary);">ÎìùÏ†ê Í∏∞Î°ù (${m.history.length}Í∞ú)</summary>`;
                        html += `<div style="margin-top:4px; max-height:150px; overflow-y:auto; background:white; padding:4px; border-radius:3px;">`;
                        m.history.slice(-20).forEach(h => {
                            const color = h.player === m.p1 ? '#1976d2' : '#c62828';
                            html += `<div style="font-size:10px; padding:2px 4px; border-left:2px solid ${color}; margin:1px 0;">`;
                            html += `${h.player} ${h.scoreBefore}‚Üí${h.scoreAfter}`;
                            if (h.set) html += ` (${h.set}ÏÑ∏Ìä∏)`;
                            html += `</div>`;
                        });
                        if (m.history.length > 20) html += `<div style="font-size:9px; color:#999;">... Ïô∏ ${m.history.length - 20}Í∞ú</div>`;
                        html += `</div></details>`;
                    }
                    html += `</div>`;
                });
                html += `</div></details>`;
                html += `</div>`;
            });
            html += `</div>`;
            
            // Í≤∞ÏÑ† ÌÜ†ÎÑàÎ®ºÌä∏
            if (r.knockoutRounds.length > 0) {
                html += `<div style="margin-bottom:16px;">`;
                html += `<h4 style="margin-bottom:8px;">üèÖ Í≤∞ÏÑ† ÌÜ†ÎÑàÎ®ºÌä∏</h4>`;
                
                r.knockoutRounds.forEach(round => {
                    const bg = round.round === 'Í≤∞Ïäπ' ? '#fff3cd' : round.round === '3/4ÏúÑÏ†Ñ' ? '#ffe4c4' : 'var(--bg-secondary)';
                    html += `<div style="padding:12px; margin:8px 0; background:${bg}; border-radius:8px;">`;
                    html += `<strong>${round.round}</strong> (${round.sets}ÏÑ∏Ìä∏)<br>`;
                    round.matches.forEach(m => {
                        const setDetail = m.setScores ? m.setScores.map(s => `${s.s1}-${s.s2}`).join(', ') : '';
                        html += `<div style="padding:6px; margin:4px 0; background:rgba(255,255,255,0.5); border-radius:4px;">`;
                        html += `<div>${m.p1} vs ${m.p2}: <strong>${m.winner}</strong> (${m.score}) ${setDetail ? `[${setDetail}]` : ''}</div>`;
                        
                        // ÎìùÏ†ê ÌûàÏä§ÌÜ†Î¶¨
                        if (m.history && m.history.length > 0) {
                            html += `<details style="margin-top:4px;"><summary style="cursor:pointer; font-size:10px; color:var(--primary);">ÎìùÏ†ê Í∏∞Î°ù (${m.history.length}Í∞ú)</summary>`;
                            html += `<div style="margin-top:4px; max-height:150px; overflow-y:auto; background:white; padding:4px; border-radius:3px;">`;
                            m.history.slice(-20).forEach(h => {
                                const color = h.player === m.p1 ? '#1976d2' : '#c62828';
                                html += `<div style="font-size:10px; padding:2px 4px; border-left:2px solid ${color}; margin:1px 0;">`;
                                html += `${h.player} ${h.scoreBefore}‚Üí${h.scoreAfter}`;
                                if (h.set) html += ` (${h.set}ÏÑ∏Ìä∏)`;
                                html += `</div>`;
                            });
                            if (m.history.length > 20) html += `<div style="font-size:9px; color:#999;">... Ïô∏ ${m.history.length - 20}Í∞ú</div>`;
                            html += `</div></details>`;
                        }
                        html += `</div>`;
                    });
                    html += `</div>`;
                });
                html += `</div>`;
            }
            
            // Í∞úÏù∏Î≥Ñ ÏÉÅÏÑ∏ Í∏∞Î°ù
            html += `<div style="margin-bottom:16px;">`;
            html += `<h4 style="margin-bottom:8px;">Í∞úÏù∏Î≥Ñ ÏÉÅÏÑ∏ Í∏∞Î°ù</h4>`;
            html += `<details><summary style="cursor:pointer; padding:8px; background:var(--bg-secondary); border-radius:4px;">Ï†ÑÏ≤¥ ${r.participants.length}${isTeam ? 'ÌåÄ' : 'Î™Ö'} Í∏∞Î°ù Î≥¥Í∏∞</summary>`;
            html += `<div style="margin-top:8px; max-height:400px; overflow-y:auto;">`;
            
            Object.values(r.playerRecords).forEach(p => {
                const setDiff = p.setWins - p.setLosses;
                const ptDiff = p.pointsFor - p.pointsAgainst;
                html += `<div style="padding:10px; margin:6px 0; background:var(--bg-secondary); border-radius:6px; border-left:3px solid ${p.finalRank <= 3 ? 'gold' : 'var(--primary)'};">`;
                html += `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">`;
                html += `<strong>${p.finalRank ? `#${p.finalRank} ` : ''}${p.name}</strong>`;
                html += `<span style="font-size:12px; color:var(--text-secondary);">${p.group} ${p.groupRank}ÏúÑ</span>`;
                html += `</div>`;
                html += `<div style="font-size:12px;">`;
                html += `Ï†ÑÏ†Å: ${p.totalWins}Ïäπ ${p.totalLosses}Ìå® | `;
                if (!isTeam) html += `ÏÑ∏Ìä∏: +${p.setWins}/-${p.setLosses} | `;
                html += `ÎìùÏã§: +${p.pointsFor}/-${p.pointsAgainst}`;
                html += `</div>`;
                html += `<details style="margin-top:6px;"><summary style="cursor:pointer; font-size:11px;">Í≤ΩÍ∏∞ Í∏∞Î°ù (${p.matches.length}Í≤ΩÍ∏∞)</summary>`;
                html += `<div style="font-size:11px; margin-top:4px;">`;
                p.matches.forEach(m => {
                    const color = m.result === 'Ïäπ' ? 'green' : 'red';
                    html += `[${m.stage}] vs ${m.opponent}: <span style="color:${color};">${m.result}</span> (${m.score})<br>`;
                });
                html += `</div></details></div>`;
            });
            html += `</div></details></div>`;
            
            // ÏµúÏ¢Ö ÏàúÏúÑ
            if (r.finalStandings.length > 0) {
                html += `<div style="padding:16px; background:#e8f5e9; border-radius:8px;">`;
                html += `<h4 style="margin-bottom:12px;">ÏµúÏ¢Ö ÏàúÏúÑ ${r.settings.rankingType === 'all-ranked' ? '(Ï†ÑÏ≤¥)' : '(Î≥∏ÏÑ†)'}</h4>`;
                
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const topN = r.settings.rankingType === 'all-ranked' ? Math.min(r.finalStandings.length, 16) : r.finalStandings.length;
                
                for (let i = 0; i < topN; i++) {
                    const p = r.finalStandings[i];
                    const medal = i < 3 ? medals[i] : `${p.rank}ÏúÑ`;
                    const size = i === 0 ? '18px' : i < 3 ? '16px' : '14px';
                    const weight = i < 4 ? 'bold' : 'normal';
                    html += `<div style="font-size:${size}; font-weight:${weight}; margin:4px 0; padding:4px 8px; background:${i < 4 ? 'rgba(255,255,255,0.5)' : 'transparent'}; border-radius:4px;">`;
                    html += `${medal} ${p.name}`;
                    if (p.record) {
                        html += ` <span style="font-size:11px; font-weight:normal; color:var(--text-secondary);">(${p.record.totalWins}Ïäπ ${p.record.totalLosses}Ìå®)</span>`;
                    }
                    html += `</div>`;
                }
                
                if (r.settings.rankingType === 'all-ranked' && r.finalStandings.length > 16) {
                    html += `<p style="font-size:12px; color:var(--text-secondary); margin-top:8px;">... Ïô∏ ${r.finalStandings.length - 16}Î™Ö</p>`;
                }
                html += `</div>`;
            }
            
            return html;
        }
        
        // ÌÉëÏãúÎìú ÏûÖÎ†• ÌïÑÎìú ÏóÖÎç∞Ïù¥Ìä∏
        function updateTopSeedInputs() {
            const groupCount = parseInt(document.getElementById('auto-group-count')?.value || 4);
            const container = document.getElementById('top-seed-inputs');
            if (!container) return;
            
            let html = '';
            for (let i = 0; i < groupCount; i++) {
                const groupLetter = String.fromCharCode(65 + i);
                html += `<input type="text" placeholder="${groupLetter}Ï°∞ ÌÉëÏãúÎìú" id="seed-${groupLetter}" style="padding:8px; font-size:13px;">`;
            }
            container.innerHTML = html;
        }
        
        // Ï°∞ Ìé∏ÏÑ± ÎØ∏Î¶¨Î≥¥Í∏∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateGroupPreview() {
            const count = parseInt(document.getElementById('auto-participant-count')?.value || 16);
            const groupCount = parseInt(document.getElementById('auto-group-count')?.value || 4);
            const preview = document.getElementById('group-preview');
            if (!preview) return;
            
            if (count < 2 || groupCount < 1) {
                preview.innerHTML = 'Ï∞∏Í∞ÄÏûê 2Î™Ö Ïù¥ÏÉÅ, Ï°∞ 1Í∞ú Ïù¥ÏÉÅ ÌïÑÏöî';
                preview.style.background = '#ffebee';
                return;
            }
            
            // IBSA Î∞©Ïãù: Ïä§ÎÑ§Ïù¥ÌÅ¨ Î∞∞Ï†ïÏúºÎ°ú Ï°∞Î≥Ñ Ïù∏Ïõê Í≥ÑÏÇ∞
            const perGroup = [];
            for (let i = 0; i < groupCount; i++) perGroup.push(0);
            
            for (let i = 0; i < count; i++) {
                const round = Math.floor(i / groupCount);
                const gi = round % 2 === 0 ? i % groupCount : groupCount - 1 - (i % groupCount);
                perGroup[gi]++;
            }
            
            // ÎØ∏Î¶¨Î≥¥Í∏∞ ÏÉùÏÑ±
            const groupNames = perGroup.map((n, i) => `${String.fromCharCode(65 + i)}Ï°∞ ${n}Î™Ö`);
            const isUneven = new Set(perGroup).size > 1;
            
            let html = `Ï°∞ Ìé∏ÏÑ±: ${groupNames.join(', ')}`;
            if (isUneven) {
                html += `<br><span style="color:#ff9800; font-size:12px;">‚Äª IBSA: Î∂àÍ∑†Îì± Ï°∞ ÌóàÏö©, ÏäπÎ•†Î°ú ÏàúÏúÑ Í≤∞Ï†ï</span>`;
            }
            
            preview.innerHTML = html;
            preview.style.background = isUneven ? '#fff3e0' : '#e3f2fd';
        }
        
        // ========== ÏÑ†ÏàòÏö© Î∑∞Ïñ¥ Ìï®Ïàò ==========
        
        // ========== ÎûúÎç§ ÌåÄ Î¶¨Í∑∏Ï†Ñ Ìï®Ïàò ==========
        
        function addRTLParticipant() {
            const name = document.getElementById('rtl-name')?.value?.trim();
            const gender = document.getElementById('rtl-gender')?.value;
            
            if (!name) {
                alert('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!window.randomTeamLeague) window.randomTeamLeague = { participants: [], teams: [], matches: [], phase: 'input' };
            
            window.randomTeamLeague.participants.push({ name, gender });
            document.getElementById('rtl-name').value = '';
            document.getElementById('rtl-name').focus();
            render();
        }
        
        function generateRTLAutoParticipants() {
            const count = parseInt(document.getElementById('rtl-auto-count')?.value || 12);
            const ratio = document.getElementById('rtl-auto-ratio')?.value || 'equal';
            
            if (!window.randomTeamLeague) window.randomTeamLeague = { participants: [], teams: [], matches: [], phase: 'input' };
            
            // Í∏∞Ï°¥ Ï∞∏Í∞ÄÏûê Ï¥àÍ∏∞Ìôî ÌôïÏù∏
            if (window.randomTeamLeague.participants.length > 0) {
                if (!confirm(`Í∏∞Ï°¥ Ï∞∏Í∞ÄÏûê ${window.randomTeamLeague.participants.length}Î™ÖÏùÑ ÏÇ≠Ï†úÌïòÍ≥† ÏÉàÎ°ú ÏÉùÏÑ±Ìï†ÍπåÏöî?`)) {
                    return;
                }
            }
            
            // ÏÑ±ÎπÑ Í≥ÑÏÇ∞
            let maleCount, femaleCount;
            if (ratio === 'male') {
                maleCount = Math.ceil(count * 2 / 3);
                femaleCount = count - maleCount;
            } else if (ratio === 'female') {
                femaleCount = Math.ceil(count * 2 / 3);
                maleCount = count - femaleCount;
            } else {
                maleCount = Math.floor(count / 2);
                femaleCount = count - maleCount;
            }
            
            // Ï∞∏Í∞ÄÏûê ÏÉùÏÑ±
            const participants = [];
            const usedNames = [];
            
            for (let i = 0; i < maleCount; i++) {
                let name;
                do { name = generateRandomName('male'); } while (usedNames.includes(name));
                usedNames.push(name);
                participants.push({ name, gender: 'M' });
            }
            
            for (let i = 0; i < femaleCount; i++) {
                let name;
                do { name = generateRandomName('female'); } while (usedNames.includes(name));
                usedNames.push(name);
                participants.push({ name, gender: 'F' });
            }
            
            // ÏÑûÍ∏∞
            for (let i = participants.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [participants[i], participants[j]] = [participants[j], participants[i]];
            }
            
            window.randomTeamLeague.participants = participants;
            render();
            announce(`${count}Î™Ö Ï∞∏Í∞ÄÏûê ÏûêÎèô ÏÉùÏÑ± ÏôÑÎ£å. ÎÇ®Ïûê ${maleCount}Î™Ö, Ïó¨Ïûê ${femaleCount}Î™Ö.`);
        }
        
        function removeRTLParticipant(index) {
            window.randomTeamLeague.participants.splice(index, 1);
            render();
        }
        
        function goToRTLTeamSetup() {
            window.randomTeamLeague.phase = 'team-setup';
            render();
        }
        
        function generateRandomTeams() {
            const rtl = window.randomTeamLeague;
            const teamCount = parseInt(document.getElementById('rtl-team-count')?.value || rtl.teams.length || 2);
            const balanceGender = document.getElementById('rtl-balance-gender')?.checked ?? true;
            
            // Ï∞∏Í∞ÄÏûê Î≥µÏÇ¨ ÌõÑ ÏÑûÍ∏∞
            let participants = [...rtl.participants];
            
            // ÌåÄ Ï¥àÍ∏∞Ìôî (Ïù¥Î¶ÑÏùÄ ÎπÑÏõåÎëêÍ≥† ÎÇòÏ§ëÏóê ÏûÖÎ†•Î∞õÏùå)
            rtl.teams = [];
            for (let i = 0; i < teamCount; i++) {
                rtl.teams.push({ name: `${i+1}Ï°∞`, members: [] });
            }
            
            if (balanceGender) {
                // ÏÑ±Î≥Ñ Í∑†Ìòï ÎßûÏ∂îÍ∏∞
                const males = participants.filter(p => p.gender === 'M');
                const females = participants.filter(p => p.gender === 'F');
                
                // ÏÑûÍ∏∞
                shuffleArray(males);
                shuffleArray(females);
                
                // ÍµêÎåÄÎ°ú Î∞∞Ï†ï (Ïä§ÎÑ§Ïù¥ÌÅ¨ Î∞©Ïãù)
                let teamIdx = 0;
                let direction = 1;
                
                // ÎÇ®ÏÑ± Î®ºÏ†Ä
                males.forEach(p => {
                    rtl.teams[teamIdx].members.push(p);
                    teamIdx += direction;
                    if (teamIdx >= teamCount || teamIdx < 0) {
                        direction *= -1;
                        teamIdx += direction;
                    }
                });
                
                // Ïó¨ÏÑ±
                females.forEach(p => {
                    rtl.teams[teamIdx].members.push(p);
                    teamIdx += direction;
                    if (teamIdx >= teamCount || teamIdx < 0) {
                        direction *= -1;
                        teamIdx += direction;
                    }
                });
            } else {
                // ÏôÑÏ†Ñ ÎûúÎç§
                shuffleArray(participants);
                participants.forEach((p, i) => {
                    rtl.teams[i % teamCount].members.push(p);
                });
            }
            
            rtl.phase = 'teams-generated';
            render();
        }
        
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
        }
        
        // ÌÉëÏãúÎìú ÏÑ†ÌÉù UI ÏóÖÎç∞Ïù¥Ìä∏
        function updateRTLTopseedInputs() {
            const container = document.getElementById('rtl-topseed-container');
            const validationMsg = document.getElementById('rtl-validation-msg');
            if (!container) return;
            
            const rtl = window.randomTeamLeague;
            const teamCount = parseInt(document.getElementById('rtl-team-count')?.value || 2);
            const membersPerTeam = parseInt(document.getElementById('rtl-members-per-team')?.value || 3);
            
            // ÏÑ§Ï†ï Ï†ÄÏû•
            rtl.teamCount = teamCount;
            rtl.membersPerTeam = membersPerTeam;
            
            // ÌïÑÏöî Ïù∏Ïõê Í≤ÄÏ¶ù
            const totalNeeded = teamCount * membersPerTeam;
            const available = rtl.participants.length;
            
            if (totalNeeded > available) {
                validationMsg.innerHTML = `<div style="color:#d32f2f; padding:8px; background:#ffebee; border-radius:4px;">
                    Ïù∏Ïõê Î∂ÄÏ°±: ${teamCount}ÌåÄ √ó ${membersPerTeam}Î™Ö = ${totalNeeded}Î™Ö ÌïÑÏöî (ÌòÑÏû¨ ${available}Î™Ö)
                </div>`;
            } else {
                const extra = available - totalNeeded;
                validationMsg.innerHTML = extra > 0 ? 
                    `<div style="color:#1976d2; padding:8px; background:#e3f2fd; border-radius:4px;">
                        ‚ÑπÔ∏è ${totalNeeded}Î™Ö Î∞∞Ï†ï ÏòàÏ†ï (${extra}Î™Ö ÎØ∏Î∞∞Ï†ï)
                    </div>` : '';
            }
            
            // Ï∞∏Í∞ÄÏûê ÏòµÏÖò ÏÉùÏÑ±
            const participantOptions = rtl.participants.map((p, i) => 
                `<option value="${i}">${p.gender === 'M' ? 'üë®' : 'üë©'} ${p.name}</option>`
            ).join('');
            
            // Í∞Å ÌåÄÎ≥Ñ ÌÉëÏãúÎìú ÏÑ†ÌÉù ÎìúÎ°≠Îã§Ïö¥ ÏÉùÏÑ±
            let html = '<div style="display:grid; gap:8px;">';
            for (let t = 0; t < teamCount; t++) {
                const savedTopseed = rtl.topseeds?.[t];
                html += `
                    <div style="display:flex; align-items:center; gap:8px; padding:8px; background:#f5f5f5; border-radius:6px;">
                        <span style="min-width:60px; font-weight:bold; color:hsl(${t * 60}, 70%, 40%);">${t+1}ÌåÄ</span>
                        <select id="rtl-topseed-${t}" onchange="saveRTLTopseed(${t})" style="flex:1;">
                            <option value="">-- ÌÉëÏãúÎìú ÏÑ†ÌÉù --</option>
                            ${participantOptions}
                        </select>
                        <span style="font-size:12px; color:#666;">üèÜ</span>
                    </div>
                `;
            }
            html += '</div>';
            
            container.innerHTML = html;
            
            // Ï†ÄÏû•Îêú ÌÉëÏãúÎìú Í∞í Î≥µÏõê
            if (rtl.topseeds) {
                rtl.topseeds.forEach((ts, t) => {
                    const select = document.getElementById(`rtl-topseed-${t}`);
                    if (select && ts !== null && ts !== undefined) {
                        select.value = ts;
                    }
                });
            }
        }
        
        // ÌÉëÏãúÎìú ÏÑ†ÌÉù Ï†ÄÏû•
        function saveRTLTopseed(teamIdx) {
            const rtl = window.randomTeamLeague;
            if (!rtl.topseeds) rtl.topseeds = [];
            
            const value = document.getElementById(`rtl-topseed-${teamIdx}`)?.value;
            rtl.topseeds[teamIdx] = value !== '' ? parseInt(value) : null;
        }
        
        // ÎåÄÌöå Î∞©Ïãù ÏÑ†ÌÉù
        function selectRTLTournamentType(type) {
            const rtl = window.randomTeamLeague;
            rtl.tournamentType = type;
            
            document.getElementById('rtl-type-full-league').checked = (type === 'full-league');
            document.getElementById('rtl-type-group-tournament').checked = (type === 'group-tournament');
            
            updateRTLTournamentOptions();
        }
        
        // ÎåÄÌöå Î∞©Ïãù ÏòµÏÖò ÏóÖÎç∞Ïù¥Ìä∏
        function updateRTLTournamentOptions() {
            const rtl = window.randomTeamLeague;
            const fullLeagueRadio = document.getElementById('rtl-type-full-league');
            const groupTournamentRadio = document.getElementById('rtl-type-group-tournament');
            const optionsDiv = document.getElementById('rtl-group-tournament-options');
            
            if (!fullLeagueRadio || !optionsDiv) return;
            
            const type = groupTournamentRadio?.checked ? 'group-tournament' : 'full-league';
            rtl.tournamentType = type;
            
            // Ïä§ÌÉÄÏùº ÏóÖÎç∞Ïù¥Ìä∏
            const fullLabel = document.getElementById('rtl-type-full-league-label');
            const groupLabel = document.getElementById('rtl-type-group-tournament-label');
            
            if (fullLabel) {
                fullLabel.style.border = type === 'full-league' ? '2px solid #1976d2' : '2px solid transparent';
                fullLabel.style.background = type === 'full-league' ? '#e3f2fd' : 'white';
            }
            if (groupLabel) {
                groupLabel.style.border = type === 'group-tournament' ? '2px solid #1976d2' : '2px solid transparent';
                groupLabel.style.background = type === 'group-tournament' ? '#e3f2fd' : 'white';
            }
            
            // ÏòµÏÖò ÌëúÏãú/Ïà®ÍπÄ
            optionsDiv.style.display = type === 'group-tournament' ? 'block' : 'none';
            
            updateRTLGroupPreview();
        }
        
        // Ï°∞Î≥Ñ+ÌÜ†ÎÑàÎ®ºÌä∏ ÎØ∏Î¶¨Î≥¥Í∏∞
        function updateRTLGroupPreview() {
            const rtl = window.randomTeamLeague;
            const previewDiv = document.getElementById('rtl-group-preview');
            const teamCountEl = document.getElementById('rtl-team-count');
            const groupCountEl = document.getElementById('rtl-group-count');
            const advanceCountEl = document.getElementById('rtl-advance-count');
            
            if (!previewDiv || !teamCountEl) return;
            
            const teamCount = parseInt(teamCountEl.value || 4);
            const groupCount = parseInt(groupCountEl?.value || 2);
            const advanceCount = parseInt(advanceCountEl?.value || 2);
            
            // Ï†ÄÏû•
            rtl.groupCount = groupCount;
            rtl.advanceCount = advanceCount;
            
            // Ï°∞Î≥Ñ ÌåÄ Ïàò Í≥ÑÏÇ∞
            const teamsPerGroup = Math.floor(teamCount / groupCount);
            const remainder = teamCount % groupCount;
            
            // ÏßÑÏ∂úÌåÄ Ï¥ù Ïàò
            const totalAdvance = groupCount * advanceCount;
            
            // ÌÜ†ÎÑàÎ®ºÌä∏ Í∑úÎ™® Í≥ÑÏÇ∞ (2Ïùò Í±∞Îì≠Ï†úÍ≥±)
            let bracketSize = 2;
            while (bracketSize < totalAdvance) bracketSize *= 2;
            
            let html = '';
            
            // Ï°∞ Ìé∏ÏÑ± ÎØ∏Î¶¨Î≥¥Í∏∞
            const groupNames = [];
            for (let i = 0; i < groupCount; i++) {
                const gTeams = teamsPerGroup + (i < remainder ? 1 : 0);
                groupNames.push(`${String.fromCharCode(65 + i)}Ï°∞ ${gTeams}ÌåÄ`);
            }
            html += `Ï°∞ Ìé∏ÏÑ±: ${groupNames.join(', ')}<br>`;
            
            // ÏßÑÏ∂ú Î∞è ÌÜ†ÎÑàÎ®ºÌä∏
            html += `Í≤∞ÏÑ† ÏßÑÏ∂ú: ${groupCount}Ï°∞ √ó ${advanceCount}ÌåÄ = ${totalAdvance}ÌåÄ<br>`;
            html += `Í≤∞ÏÑ† ÌÜ†ÎÑàÎ®ºÌä∏: ${bracketSize}Í∞ï`;
            
            // Í≤ΩÍ≥†
            if (advanceCount >= teamsPerGroup) {
                html += `<br><span style="color:#d32f2f;">ÏßÑÏ∂úÏûê ÏàòÍ∞Ä Ï°∞Î≥Ñ ÌåÄ ÏàòÎ≥¥Îã§ ÎßéÍ±∞ÎÇò Í∞ôÏäµÎãàÎã§</span>`;
            }
            
            previewDiv.innerHTML = html;
        }
        
        // ÌÉëÏãúÎìú Ìè¨Ìï® ÎûúÎç§ ÌåÄ ÏÉùÏÑ±
        function generateRandomTeamsWithTopseeds() {
            const rtl = window.randomTeamLeague;
            const teamCount = parseInt(document.getElementById('rtl-team-count')?.value || 2);
            const membersPerTeam = parseInt(document.getElementById('rtl-members-per-team')?.value || 3);
            const balanceGender = document.getElementById('rtl-balance-gender')?.checked ?? true;
            
            // Í≤ÄÏ¶ù: Ïù∏Ïõê Ïàò
            const totalNeeded = teamCount * membersPerTeam;
            if (totalNeeded > rtl.participants.length) {
                alert(`Ïù∏ÏõêÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§!\nÌïÑÏöî: ${totalNeeded}Î™Ö, ÌòÑÏû¨: ${rtl.participants.length}Î™Ö`);
                return;
            }
            
            // ÌÉëÏãúÎìú ÏàòÏßë
            const topseeds = [];
            const topseedIndices = new Set();
            
            for (let t = 0; t < teamCount; t++) {
                const topseedIdx = rtl.topseeds?.[t];
                if (topseedIdx !== null && topseedIdx !== undefined && topseedIdx !== '') {
                    // Ï§ëÎ≥µ Ï≤¥ÌÅ¨
                    if (topseedIndices.has(topseedIdx)) {
                        alert(`ÌÉëÏãúÎìúÍ∞Ä Ï§ëÎ≥µÎêòÏóàÏäµÎãàÎã§: ${rtl.participants[topseedIdx].name}`);
                        return;
                    }
                    topseedIndices.add(parseInt(topseedIdx));
                    topseeds[t] = rtl.participants[topseedIdx];
                } else {
                    topseeds[t] = null;
                }
            }
            
            // ÌåÄ Ï¥àÍ∏∞Ìôî Î∞è ÌÉëÏãúÎìú Î∞∞Ïπò
            rtl.teams = [];
            for (let t = 0; t < teamCount; t++) {
                const team = { name: `${t+1}Ï°∞`, members: [], topseed: null };
                if (topseeds[t]) {
                    team.members.push(topseeds[t]);
                    team.topseed = topseeds[t].name;
                }
                rtl.teams.push(team);
            }
            
            // ÌÉëÏãúÎìú Ï†úÏô∏Ìïú ÎÇòÎ®∏ÏßÄ Ï∞∏Í∞ÄÏûê
            const remainingParticipants = rtl.participants.filter((p, i) => !topseedIndices.has(i));
            
            // ÎÇòÎ®∏ÏßÄ Ïù∏Ïõê Î∞∞Ï†ï
            const remainingNeeded = teamCount * membersPerTeam - topseedIndices.size;
            let toAssign = [...remainingParticipants].slice(0, remainingNeeded);
            
            if (balanceGender) {
                // ÏÑ±Î≥Ñ Í∑†Ìòï - ÎÇ®ÎÖÄ Î∂ÑÎ¶¨ ÌõÑ ÍµêÎåÄ Î∞∞Ï†ï
                const males = toAssign.filter(p => p.gender === 'M');
                const females = toAssign.filter(p => p.gender === 'F');
                shuffleArray(males);
                shuffleArray(females);
                
                // ÌåÄÎ≥Ñ ÌïÑÏöî Ïù∏Ïõê Í≥ÑÏÇ∞
                const neededPerTeam = rtl.teams.map(t => membersPerTeam - t.members.length);
                
                // Ïä§ÎÑ§Ïù¥ÌÅ¨ Î∞©Ïãù Î∞∞Ï†ï
                let teamIdx = 0;
                let direction = 1;
                
                // ÎÇ®ÏÑ± Î®ºÏ†Ä
                males.forEach(p => {
                    // ÏïÑÏßÅ Ïù∏ÏõêÏù¥ ÌïÑÏöîÌïú ÌåÄ Ï∞æÍ∏∞
                    while (neededPerTeam[teamIdx] <= 0) {
                        teamIdx += direction;
                        if (teamIdx >= teamCount || teamIdx < 0) {
                            direction *= -1;
                            teamIdx += direction;
                        }
                    }
                    rtl.teams[teamIdx].members.push(p);
                    neededPerTeam[teamIdx]--;
                    teamIdx += direction;
                    if (teamIdx >= teamCount || teamIdx < 0) {
                        direction *= -1;
                        teamIdx += direction;
                    }
                });
                
                // Ïó¨ÏÑ±
                females.forEach(p => {
                    while (neededPerTeam[teamIdx] <= 0) {
                        teamIdx += direction;
                        if (teamIdx >= teamCount || teamIdx < 0) {
                            direction *= -1;
                            teamIdx += direction;
                        }
                    }
                    rtl.teams[teamIdx].members.push(p);
                    neededPerTeam[teamIdx]--;
                    teamIdx += direction;
                    if (teamIdx >= teamCount || teamIdx < 0) {
                        direction *= -1;
                        teamIdx += direction;
                    }
                });
            } else {
                // ÏôÑÏ†Ñ ÎûúÎç§
                shuffleArray(toAssign);
                let idx = 0;
                rtl.teams.forEach(team => {
                    while (team.members.length < membersPerTeam && idx < toAssign.length) {
                        team.members.push(toAssign[idx++]);
                    }
                });
            }
            
            rtl.phase = 'teams-generated';
            render();
        }
        
        function updateRTLTeamName(teamIndex, newName) {
            window.randomTeamLeague.teams[teamIndex].name = newName.trim() || `${teamIndex+1}Ï°∞`;
        }
        
        // ÎûúÎç§ ÌåÄÎ¶¨Í∑∏ Ï°∞ Ìé∏ÏÑ± ÏàòÏ†ï ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
        function goToRTLGroupEdit() {
            window.randomTeamLeague.editPhase = 'group-edit';
            render();
        }
        
        // ÎûúÎç§ ÌåÄÎ¶¨Í∑∏ ÎåÄÏßÑÌëú Î≥¥Í∏∞ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
        function goToRTLMatchOrder() {
            window.randomTeamLeague.editPhase = 'match-order';
            render();
        }
        
        // Ï°∞ Ïù¥Îèô
        function moveRTLTeamToGroup(teamIdx, newGroupIdx) {
            const rtl = window.randomTeamLeague;
            if (!rtl.groupAssignments) {
                // Ï°∞ Î∞∞Ï†ï Ï¥àÍ∏∞Ìôî
                const groupCount = rtl.groupCount || 2;
                rtl.groupAssignments = [];
                rtl.teams.forEach((t, idx) => {
                    const round = Math.floor(idx / groupCount);
                    const groupIdx = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                    rtl.groupAssignments[idx] = groupIdx;
                });
            }
            rtl.groupAssignments[teamIdx] = newGroupIdx;
            render();
        }
        
        // Í≤ΩÍ∏∞ ÏàúÏÑú Î≥ÄÍ≤Ω
        function moveRTLMatch(matchIdx, direction) {
            const rtl = window.randomTeamLeague;
            if (!rtl.matchOrder) {
                // Ï¥àÍ∏∞ Í≤ΩÍ∏∞ ÏàúÏÑú ÏÉùÏÑ±
                const totalMatches = rtl.teams.length * (rtl.teams.length - 1) / 2;
                rtl.matchOrder = [];
                let matchNum = 0;
                for (let i = 0; i < rtl.teams.length; i++) {
                    for (let j = i + 1; j < rtl.teams.length; j++) {
                        rtl.matchOrder.push({ team1: i, team2: j, order: matchNum++ });
                    }
                }
            }
            
            const newIdx = matchIdx + direction;
            if (newIdx < 0 || newIdx >= rtl.matchOrder.length) return;
            
            // ÏàúÏÑú ÍµêÌôò
            const temp = rtl.matchOrder[matchIdx];
            rtl.matchOrder[matchIdx] = rtl.matchOrder[newIdx];
            rtl.matchOrder[newIdx] = temp;
            
            render();
        }
        
        function startRTLLeague() {
            const rtl = window.randomTeamLeague;
            
            // ÌåÄ Ïù¥Î¶Ñ Îπà Ïπ∏ Ï≤¥ÌÅ¨
            const emptyNames = rtl.teams.filter(t => !t.name || t.name.match(/^\d+Ï°∞$/));
            if (emptyNames.length > 0) {
                alert('Î™®Îì† ÌåÄÏùò Ïù¥Î¶ÑÏùÑ Ï†ïÌï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            const tournamentType = rtl.tournamentType || 'full-league';
            const typeLabel = tournamentType === 'group-tournament' ? 'Ï°∞Î≥Ñ+ÌÜ†ÎÑàÎ®ºÌä∏' : 'ÌíÄÎ¶¨Í∑∏';
            
            // ÌîÑÎ°úÏ†ùÌä∏Î™Ö ÏûÖÎ†•
            const projectName = prompt('ÌîÑÎ°úÏ†ùÌä∏Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:', `ÎûúÎç§ÌåÄ ${typeLabel} ${new Date().toLocaleDateString()}`);
            if (!projectName) return;
            
            // ÏÉà ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±
            const project = {
                id: Date.now(),
                name: projectName,
                date: new Date().toISOString().split('T')[0],
                location: '',
                desc: `ÎûúÎç§ ÌåÄ ${typeLabel}`,
                matches: [],
                createdAt: new Date().toISOString(),
                competitionType: 'team',
                tournamentType: tournamentType === 'group-tournament' ? 'group-tournament' : 'group',
                groups: [],
                players: [],
                teams: [],
                bracket: null,
                standings: [],
                isRandomTeamLeague: true,
                randomTeamData: {
                    participants: [...rtl.participants],
                    teamAssignments: rtl.teams.map(t => ({
                        name: t.name,
                        members: t.members.map(m => m.name),
                        topseed: t.topseed
                    }))
                }
            };
            
            // ÌåÄ Îì±Î°ù
            rtl.teams.forEach((team, idx) => {
                project.teams.push({
                    id: Date.now() + idx,
                    name: team.name,
                    members: team.members.map(m => ({
                        name: m.name,
                        gender: m.gender === 'M' ? 'male' : 'female'
                    })),
                    topseed: team.topseed || null,
                    group: null // ÎÇòÏ§ëÏóê Î∞∞Ï†ï
                });
            });
            
            if (tournamentType === 'group-tournament') {
                // === Ï°∞Î≥Ñ Î¶¨Í∑∏ + ÌÜ†ÎÑàÎ®ºÌä∏ ===
                const groupCount = rtl.groupCount || 2;
                const advanceCount = rtl.advanceCount || 2;
                
                // Ï°∞ ÏÉùÏÑ±
                for (let i = 0; i < groupCount; i++) {
                    project.groups.push({
                        name: String.fromCharCode(65 + i) + 'Ï°∞',
                        players: [],
                        matches: [],
                        standings: [],
                        isTeam: true
                    });
                }
                
                // ÌåÄÏùÑ Ï°∞Ïóê Î∞∞Ï†ï (Ïä§ÎÑ§Ïù¥ÌÅ¨ Î∞©Ïãù)
                project.teams.forEach((team, idx) => {
                    const round = Math.floor(idx / groupCount);
                    const groupIdx = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                    team.group = String.fromCharCode(65 + groupIdx);
                    project.groups[groupIdx].players.push({ name: team.name, id: team.id });
                });
                
                // Í∞Å Ï°∞Î≥Ñ ÎùºÏö¥Îìú Î°úÎπà ÎåÄÏßÑ ÏÉùÏÑ±
                project.groups.forEach((group, gi) => {
                    const groupTeams = group.players;
                    for (let i = 0; i < groupTeams.length; i++) {
                        for (let j = i + 1; j < groupTeams.length; j++) {
                            const matchId = `G${gi + 1}M${group.matches.length + 1}`;
                            group.matches.push({
                                id: matchId,
                                player1: groupTeams[i].name,
                                player2: groupTeams[j].name,
                                status: 'pending',
                                result: null,
                                sets: 1,
                                isTeam: true,
                                winScore: 31
                            });
                        }
                    }
                });
                
                // ÏÑ§Ï†ï Ï†ÄÏû•
                project.groupSettings = {
                    groupCount: groupCount,
                    advanceCount: advanceCount,
                    setsPerMatch: 1
                };
                
                // ÌÜ†ÎÑàÎ®ºÌä∏ ÏÑ§Ï†ï (Í≤∞ÏÑ†Ïö©)
                const totalAdvance = groupCount * advanceCount;
                let bracketSize = 2;
                while (bracketSize < totalAdvance) bracketSize *= 2;
                
                project.tournamentSettings = {
                    size: bracketSize,
                    thirdPlaceMatch: true,
                    setsPerMatch: 1
                };
                
            } else {
                // === ÌíÄÎ¶¨Í∑∏ ===
                // Îã®Ïùº Ï°∞Ïóê Î™®Îì† ÌåÄ Î∞∞Ï†ï
                project.groups = [{
                    name: 'AÏ°∞',
                    players: project.teams.map(t => ({ name: t.name, id: t.id })),
                    matches: [],
                    standings: [],
                    isTeam: true
                }];
                
                // ÌåÄ Ï°∞ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
                project.teams.forEach(t => t.group = 'A');
                
                // ÎùºÏö¥Îìú Î°úÎπà ÎåÄÏßÑ ÏÉùÏÑ±
                const teams = project.groups[0].players;
                for (let i = 0; i < teams.length; i++) {
                    for (let j = i + 1; j < teams.length; j++) {
                        const matchId = `G1M${project.groups[0].matches.length + 1}`;
                        project.groups[0].matches.push({
                            id: matchId,
                            player1: teams[i].name,
                            player2: teams[j].name,
                            status: 'pending',
                            result: null,
                            sets: 1,
                            isTeam: true,
                            winScore: 31
                        });
                    }
                }
                
                // ÏÑ§Ï†ï Ï†ÄÏû•
                project.groupSettings = {
                    groupCount: 1,
                    advanceCount: project.teams.length,
                    setsPerMatch: 1
                };
            }
            
            // FirebaseÏóê Ï†ÄÏû•
            const teamCount = rtl.teams.length;
            try {
                if (typeof database !== 'undefined' && database) {
                    const newProjectRef = database.ref('projects').push();
                    project.firebaseKey = newProjectRef.key;
                    newProjectRef.set(project).then(() => {
                        console.log('ÎûúÎç§ ÌåÄ ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± ÏôÑÎ£å');
                        projects.push(project);
                        currentProject = project;
                        window.randomTeamLeague = null;
                        goTo('project-detail');
                        announce(`${projectName} ÏÉùÏÑ± ÏôÑÎ£å. ${teamCount}ÌåÄ ${typeLabel}.`);
                    }).catch((error) => {
                        console.error('Firebase Ï†ÄÏû• ÏóêÎü¨:', error);
                        saveRTLProjectLocal(project, projectName, rtl, typeLabel);
                    });
                } else {
                    saveRTLProjectLocal(project, projectName, rtl, typeLabel);
                }
            } catch (error) {
                console.error('ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± ÏóêÎü¨:', error);
                saveRTLProjectLocal(project, projectName, rtl, typeLabel);
            }
        }
        
        function saveRTLProjectLocal(project, projectName, rtl, typeLabel) {
            projects.push(project);
            localStorage.setItem('projects', JSON.stringify(projects));
            currentProject = project;
            const teamCount = rtl.teams.length;
            window.randomTeamLeague = null;
            goTo('project-detail');
            announce(`${projectName} ÏÉùÏÑ± ÏôÑÎ£å. ${teamCount}ÌåÄ ${typeLabel || 'Î¶¨Í∑∏Ï†Ñ'}.`);
        }
        
        function resetRTL() {
            if (confirm('ÏÉà Î¶¨Í∑∏Ï†ÑÏùÑ ÏãúÏûëÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                window.randomTeamLeague = { participants: [], teams: [], matches: [], phase: 'input' };
                render();
            }
        }
        
        function openViewerProject(index) {
            currentProjectIndex = index;
            currentProject = projects[index];
            goTo('viewer-results');
        }
        
        function switchViewerTab(tab) {
            // ÌÉ≠ Î≤ÑÌäº Ïä§ÌÉÄÏùº Î≥ÄÍ≤Ω
            document.querySelectorAll('.viewer-tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}`)?.classList.add('active');
            
            // ÏΩòÌÖêÏ∏† Î≥ÄÍ≤Ω
            const content = document.getElementById('viewer-content');
            switch(tab) {
                case 'overview':
                    content.innerHTML = renderViewerOverview();
                    break;
                case 'groups':
                    content.innerHTML = renderViewerGroups();
                    break;
                case 'bracket':
                    content.innerHTML = renderViewerBracket();
                    break;
                case 'records':
                    content.innerHTML = renderViewerRecords();
                    break;
            }
        }
        
        function renderViewerOverview() {
            const p = currentProject;
            const isTeam = p.competitionType === 'team';
            const hasAutoResult = p.autoTournamentResult;
            const hasGroups = p.groups?.length > 0;
            
            let html = '';
            
            // ÎåÄÌöå Ï†ïÎ≥¥
            html += `<div style="padding:16px; background:var(--bg-secondary); border-radius:8px; margin-bottom:16px;">`;
            html += `<h3 style="margin-bottom:12px;">üìå ÎåÄÌöå Ï†ïÎ≥¥</h3>`;
            html += `<div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:14px;">`;
            html += `<div>üìÖ ÎÇ†Ïßú: ${p.date || 'ÎØ∏Ï†ï'}</div>`;
            html += `<div>üìç Ïû•ÏÜå: ${p.location || 'ÎØ∏Ï†ï'}</div>`;
            html += `<div>üèÖ Ïú†Ìòï: ${isTeam ? 'ÌåÄÏ†Ñ' : 'Í∞úÏù∏Ï†Ñ'}${p.isRandomTeamLeague ? ' (ÎûúÎç§)' : ''}</div>`;
            
            const participantCount = isTeam ? (p.teams?.length || 0) : (p.players?.length || 0);
            html += `<div>Ï∞∏Í∞Ä: ${participantCount}${isTeam ? 'ÌåÄ' : 'Î™Ö'}</div>`;
            html += `</div></div>`;
            
            // ÎûúÎç§ ÌåÄ Î¶¨Í∑∏Ï†Ñ - ÌåÄ Íµ¨ÏÑ± ÌëúÏãú
            if (p.isRandomTeamLeague && p.teams?.length > 0) {
                html += `<div style="padding:16px; background:linear-gradient(135deg, #667eea22 0%, #764ba222 100%); border-radius:8px; margin-bottom:16px; border-left:4px solid #667eea;">`;
                html += `<h3 style="margin-bottom:12px;">ÌåÄ Íµ¨ÏÑ± <span style="font-size:12px; font-weight:normal; color:#666;">(= ÌÉëÏãúÎìú)</span></h3>`;
                
                p.teams.forEach((team, ti) => {
                    html += `<div style="padding:10px; margin:8px 0; background:white; border-radius:6px; border-left:4px solid hsl(${ti * 60}, 70%, 50%);">`;
                    html += `<strong style="font-size:15px;">${team.name}</strong>`;
                    html += `<div style="margin-top:6px;">`;
                    team.members.forEach(m => {
                        const genderIcon = m.gender === 'male' ? 'üë®' : 'üë©';
                        const bgColor = m.gender === 'male' ? '#e3f2fd' : '#fce4ec';
                        const isTopseed = team.topseed === m.name;
                        const border = isTopseed ? 'border:2px solid #ffc107;' : '';
                        html += `<span style="display:inline-block; padding:3px 10px; margin:2px; background:${bgColor}; border-radius:12px; font-size:13px; ${border}">${isTopseed ? 'üèÜ' : ''} ${genderIcon} ${m.name}</span>`;
                    });
                    html += `</div></div>`;
                });
                
                html += `</div>`;
            }
            
            // ÏµúÏ¢Ö ÏàúÏúÑ (ÏûêÎèô ÎåÄÌöå Í≤∞Í≥ºÍ∞Ä ÏûàÏúºÎ©¥)
            if (hasAutoResult && p.autoTournamentResult.finalStandings?.length > 0) {
                html += `<div style="padding:16px; background:#e8f5e9; border-radius:8px; margin-bottom:16px;">`;
                html += `<h3 style="margin-bottom:12px;">ÏµúÏ¢Ö ÏàúÏúÑ</h3>`;
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                p.autoTournamentResult.finalStandings.slice(0, 8).forEach((s, i) => {
                    const medal = i < 3 ? medals[i] : `${s.rank}ÏúÑ`;
                    const bg = i < 3 ? 'rgba(255,215,0,0.2)' : 'transparent';
                    html += `<div style="padding:8px; margin:4px 0; background:${bg}; border-radius:4px; font-size:${i < 3 ? '16px' : '14px'};">`;
                    html += `${medal} <strong>${s.name}</strong>`;
                    html += `</div>`;
                });
                html += `</div>`;
            }
            
            // ÏßÑÌñâ ÏÉÅÌô©
            if (hasGroups) {
                const totalMatches = p.groups.reduce((sum, g) => sum + (g.matches?.length || 0), 0);
                const finishedMatches = p.groups.reduce((sum, g) => 
                    sum + (g.matches?.filter(m => m.status === 'completed').length || 0), 0);
                
                html += `<div style="padding:16px; background:var(--bg-secondary); border-radius:8px;">`;
                html += `<h3 style="margin-bottom:12px;">üìà ÏßÑÌñâ ÏÉÅÌô©</h3>`;
                html += `<div style="font-size:14px;">`;
                html += `<p>Ï°∞Î≥Ñ Î¶¨Í∑∏: ${finishedMatches}/${totalMatches} Í≤ΩÍ∏∞ ÏôÑÎ£å</p>`;
                
                const progress = totalMatches > 0 ? Math.round(finishedMatches / totalMatches * 100) : 0;
                html += `<div style="background:#ddd; border-radius:10px; height:20px; margin-top:8px;">`;
                html += `<div style="background:var(--success); border-radius:10px; height:100%; width:${progress}%; transition:width 0.3s;"></div>`;
                html += `</div>`;
                html += `<p style="text-align:center; margin-top:4px;">${progress}%</p>`;
                html += `</div></div>`;
            }
            
            return html;
        }
        
        function renderViewerGroups() {
            const p = currentProject;
            const isTeam = p.competitionType === 'team';
            const hasAutoResult = p.autoTournamentResult;
            
            // ÏûêÎèô ÏãúÎÆ¨Î†àÏù¥ÏÖò Í≤∞Í≥ºÍ∞Ä ÏûàÏúºÎ©¥ Ìï¥Îãπ Í≤∞Í≥º ÌëúÏãú
            if (hasAutoResult && p.autoTournamentResult.groupStandings?.length > 0) {
                let html = '';
                
                p.autoTournamentResult.groupStandings.forEach((gs, gi) => {
                    const gm = p.autoTournamentResult.groupMatches?.[gi];
                    const advanceCount = p.groupSettings?.advanceCount || p.autoTournamentResult.settings?.advanceCount || 2;
                    
                    html += '<div style="padding:16px; margin:12px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid var(--primary);">';
                    html += '<h4 style="margin-bottom:12px;">' + gs.group + '</h4>';
                    
                    // ÏàúÏúÑÌëú
                    html += '<table style="width:100%; font-size:13px; border-collapse:collapse;">';
                    html += '<tr style="background:#e0e0e0;"><th style="padding:6px;">ÏàúÏúÑ</th><th style="padding:6px;">Ïù¥Î¶Ñ</th>';
                    html += '<th style="padding:6px;">Ïäπ</th><th style="padding:6px;">Ìå®</th>';
                    html += isTeam ? '<th style="padding:6px;">ÎìùÏ†ê</th><th style="padding:6px;">Ïã§Ï†ê</th>' : '<th style="padding:6px;">ÏÑ∏Ìä∏</th>';
                    html += '<th style="padding:6px;">ÎìùÏã§</th></tr>';
                    
                    gs.standings.forEach((s, si) => {
                        const bg = s.qualified ? '#e8f5e9' : 'white';
                        const diff = isTeam ? (s.pf - s.pa) : (s.sw - s.sl);
                        const diffStr = diff > 0 ? '+' + diff : diff;
                        
                        html += '<tr style="background:' + bg + '; border-bottom:1px solid #eee;">';
                        html += '<td style="padding:6px; text-align:center;">' + (s.qualified ? 'üèÜ' : '') + s.rank + '</td>';
                        html += '<td style="padding:6px;">' + s.name + '</td>';
                        html += '<td style="padding:6px; text-align:center;">' + s.wins + '</td>';
                        html += '<td style="padding:6px; text-align:center;">' + s.losses + '</td>';
                        if (isTeam) {
                            html += '<td style="padding:6px; text-align:center;">' + (s.pf || 0) + '</td>';
                            html += '<td style="padding:6px; text-align:center;">' + (s.pa || 0) + '</td>';
                        } else {
                            html += '<td style="padding:6px; text-align:center;">' + s.sw + ':' + s.sl + '</td>';
                        }
                        html += '<td style="padding:6px; text-align:center; color:' + (diff > 0 ? 'green' : diff < 0 ? 'red' : 'black') + ';">' + diffStr + '</td>';
                        html += '</tr>';
                    });
                    html += '</table>';
                    
                    // Í≤ΩÍ∏∞ Í≤∞Í≥º ÏÉÅÏÑ∏
                    if (gm?.matches?.length > 0) {
                        html += '<details style="margin-top:12px;"><summary style="cursor:pointer; font-size:12px; padding:4px 8px; background:#e8f5e9; border-radius:4px;">Í≤ΩÍ∏∞ Í≤∞Í≥º (' + gm.matches.length + 'Í≤ΩÍ∏∞)</summary>';
                        html += '<div style="margin-top:8px;">';
                        gm.matches.forEach(function(m, mi) {
                            const winColor = '#2e7d32';
                            html += '<div style="padding:10px; margin:4px 0; background:#f5f5f5; border-radius:6px; border-left:3px solid ' + winColor + ';">';
                            html += '<div style="display:flex; justify-content:space-between; align-items:center;">';
                            html += '<span style="font-weight:bold;">' + m.p1 + ' vs ' + m.p2 + '</span>';
                            html += '<strong style="font-size:14px; color:' + winColor + ';">' + m.score + '</strong>';
                            html += '</div>';
                            html += '<div style="font-size:12px; color:var(--text-secondary); margin-top:4px;">ÏäπÏûê: ' + m.winner + '</div>';
                            if (m.setScores?.length > 0) {
                                html += '<div style="font-size:11px; margin-top:4px;">';
                                html += 'ÏÑ∏Ìä∏Î≥Ñ: ';
                                m.setScores.forEach(function(s, i) {
                                    html += '<span style="background:white; padding:2px 6px; border-radius:3px; margin:2px;">' + (i+1) + 'ÏÑ∏Ìä∏ ' + s.s1 + '-' + s.s2 + '</span> ';
                                });
                                html += '</div>';
                            }
                            // ÏÉÅÏÑ∏ Í≤ΩÍ∏∞ Í∏∞Î°ù (history)
                            if (m.history?.length > 0) {
                                html += '<details style="margin-top:8px;"><summary style="cursor:pointer; font-size:11px; color:#666;">ÏÉÅÏÑ∏ ÎìùÏ†ê Í∏∞Î°ù (' + m.history.length + 'Ï†ê)</summary>';
                                html += '<div style="max-height:200px; overflow-y:auto; margin-top:4px; padding:8px; background:white; border-radius:4px;">';
                                m.history.forEach(function(h, hi) {
                                    html += '<div style="padding:4px 8px; margin:2px 0; font-size:11px; background:#fafafa; border-radius:3px; display:flex; justify-content:space-between;">';
                                    html += '<span>' + (hi+1) + '. ' + h.player + (h.set ? ' (ÏÑ∏Ìä∏' + h.set + ')' : '') + '</span>';
                                    html += '<span style="color:#1976d2;">+' + h.points + 'Ï†ê ‚Üí ' + h.scoreAfter + '</span>';
                                    html += '</div>';
                                });
                                html += '</div></details>';
                            }
                            html += '</div>';
                        });
                        html += '</div></details>';
                    }
                    
                    html += '</div>';
                });
                
                return html;
            }
            
            if (!p.groups || p.groups.length === 0) {
                return '<p style="text-align:center; padding:20px; color:var(--text-secondary);">Ï°∞Î≥Ñ Î¶¨Í∑∏ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
            }
            
            let html = '';
            
            p.groups.forEach((group, gi) => {
                const standings = calculateGroupStandings(group);
                const advanceCount = p.groupSettings?.advanceCount || 2;
                
                html += `<div style="padding:16px; margin:12px 0; background:var(--bg-secondary); border-radius:8px; border-left:4px solid var(--primary);">`;
                html += `<h4 style="margin-bottom:12px;">${group.name}</h4>`;
                
                // ÏàúÏúÑÌëú
                html += `<table style="width:100%; font-size:13px; border-collapse:collapse;">`;
                html += `<tr style="background:#e0e0e0;"><th style="padding:6px;">ÏàúÏúÑ</th><th style="padding:6px;">Ïù¥Î¶Ñ</th>`;
                html += `<th style="padding:6px;">Ïäπ</th><th style="padding:6px;">Ìå®</th>`;
                html += isTeam ? `<th style="padding:6px;">ÎìùÏ†ê</th><th style="padding:6px;">Ïã§Ï†ê</th>` : `<th style="padding:6px;">ÏÑ∏Ìä∏</th>`;
                html += `<th style="padding:6px;">ÎìùÏã§</th></tr>`;
                
                standings.forEach((s, si) => {
                    const bg = si < advanceCount ? '#e8f5e9' : 'white';
                    const diff = isTeam ? (s.goalDiff) : (s.setWins - s.setLosses);
                    const diffStr = diff > 0 ? `+${diff}` : diff;
                    
                    html += `<tr style="background:${bg}; border-bottom:1px solid #eee;">`;
                    html += `<td style="padding:6px; text-align:center;">${si < advanceCount ? 'üèÜ' : ''}${si + 1}</td>`;
                    html += `<td style="padding:6px;">${s.name}</td>`;
                    html += `<td style="padding:6px; text-align:center;">${s.wins}</td>`;
                    html += `<td style="padding:6px; text-align:center;">${s.losses}</td>`;
                    if (isTeam) {
                        html += `<td style="padding:6px; text-align:center;">${s.goalsFor || 0}</td>`;
                        html += `<td style="padding:6px; text-align:center;">${s.goalsAgainst || 0}</td>`;
                    } else {
                        html += `<td style="padding:6px; text-align:center;">+${s.setWins}/-${s.setLosses}</td>`;
                    }
                    html += `<td style="padding:6px; text-align:center; color:${diff > 0 ? 'green' : diff < 0 ? 'red' : 'black'};">${diffStr}</td>`;
                    html += `</tr>`;
                });
                html += `</table>`;
                
                // Í≤ΩÍ∏∞ Í≤∞Í≥º
                if (group.matches?.length > 0) {
                    html += `<details style="margin-top:12px;"><summary style="cursor:pointer; font-size:12px; padding:4px 8px; background:#e8f5e9; border-radius:4px;">Í≤ΩÍ∏∞ Í≤∞Í≥º (${group.matches.length}Í≤ΩÍ∏∞)</summary>`;
                    html += `<div style="margin-top:8px;">`;
                    group.matches.forEach((m, mi) => {
                        const isFinished = m.status === 'completed';
                        const statusIcon = isFinished ? '‚úÖ' : '‚è≥';
                        let result = 'ÎåÄÍ∏∞Ï§ë';
                        let winner = null;
                        
                        if (m.result) {
                            if (m.result.score1 !== undefined) {
                                result = m.result.score1 + ':' + m.result.score2;
                                winner = m.result.score1 > m.result.score2 ? m.player1 : m.player2;
                            } else if (m.result.player1Sets !== undefined) {
                                result = m.result.player1Sets + ':' + m.result.player2Sets + ' (ÏÑ∏Ìä∏)';
                                winner = m.result.player1Sets > m.result.player2Sets ? m.player1 : m.player2;
                            }
                        }
                        
                        // finalScoreÍ∞Ä ÏûàÏúºÎ©¥ Í∑∏Í≤ÉÎèÑ ÌëúÏãú
                        if (m.finalScore) {
                            result = m.finalScore.player1 + ':' + m.finalScore.player2;
                            winner = m.finalScore.player1 > m.finalScore.player2 ? m.player1Name || m.player1 : m.player2Name || m.player2;
                        }
                        
                        const p1Name = m.player1Name || m.player1;
                        const p2Name = m.player2Name || m.player2;
                        
                        const bg = isFinished ? '#f5f5f5' : 'white';
                        html += '<div style="padding:8px; margin:4px 0; background:' + bg + '; border-radius:6px; border-left:3px solid ' + (isFinished ? 'var(--success)' : 'var(--warning)') + ';">';
                        html += '<div style="display:flex; justify-content:space-between; align-items:center;">';
                        html += '<span>' + statusIcon + ' ' + p1Name + ' vs ' + p2Name + '</span>';
                        html += '<strong style="font-size:14px;">' + result + '</strong>';
                        html += '</div>';
                        if (winner) {
                            html += '<div style="font-size:11px; color:var(--text-secondary); margin-top:4px;">ÏäπÏûê: ' + winner + '</div>';
                        }
                        
                        // Í≤ΩÍ∏∞ ÏÉÅÏÑ∏ Í∏∞Î°ù (historyÍ∞Ä ÏûàÏúºÎ©¥)
                        if (m.history && m.history.length > 0) {
                            html += '<details style="margin-top:6px;"><summary style="cursor:pointer; font-size:11px; color:var(--primary);">ÎìùÏ†ê Í∏∞Î°ù (' + m.history.length + 'Í∞ú)</summary>';
                            html += '<div style="margin-top:6px; max-height:200px; overflow-y:auto; background:white; padding:8px; border-radius:4px;">';
                            m.history.slice().reverse().forEach((h, hi) => {
                                const scoreColor = h.player === p1Name ? '#1976d2' : '#c62828';
                                const bgColor = h.player === p1Name ? '#e3f2fd' : '#ffebee';
                                html += '<div style="padding:4px 8px; margin:2px 0; background:' + bgColor + '; border-radius:4px; font-size:11px; border-left:3px solid ' + scoreColor + ';">';
                                html += '<div style="display:flex; justify-content:space-between;">';
                                html += '<span style="font-weight:bold; color:' + scoreColor + ';">' + h.player + '</span>';
                                html += '<span>' + h.scoreBefore + ' ‚Üí ' + h.scoreAfter + '</span>';
                                html += '</div>';
                                
                                // ÎìùÏ†ê Ïú†Ìòï
                                let actionText = '';
                                if (h.type === 'goal') {
                                    actionText = 'Í≥® ' + h.points + 'Ï†ê';
                                } else if (h.type && h.type.includes('foul')) {
                                    actionText = h.type.split(' ')[0] + ' ÌååÏö∏ (ÏÉÅÎåÄ +1)';
                                } else if (h.type === 'hand' || h.type === 'head' || h.type === 'double' || h.type === 'long') {
                                    actionText = h.type + ' ÌååÏö∏';
                                } else {
                                    actionText = h.type || 'ÎìùÏ†ê';
                                }
                                html += '<div style="color:#666; font-size:10px;">' + actionText + '</div>';
                                html += '</div>';
                            });
                            html += '</div></details>';
                        }
                        
                        // ÏÑ∏Ìä∏ Ïä§ÏΩîÏñ¥Í∞Ä ÏûàÏúºÎ©¥ ÌëúÏãú
                        if (m.setScores && m.setScores.length > 0) {
                            const setInfo = m.setScores.map((s, si) => (si + 1) + 'ÏÑ∏Ìä∏: ' + s.player1 + '-' + s.player2).join(' | ');
                            html += '<div style="font-size:10px; color:#666; margin-top:4px;">' + setInfo + '</div>';
                        }
                        
                        html += '</div>';
                    });
                    html += `</div></details>`;
                }
                
                html += `</div>`;
            });
            
            return html;
        }
        
        function renderViewerBracket() {
            const p = currentProject;
            const hasAutoResult = p.autoTournamentResult;
            
            let html = '';
            
            // ÏûêÎèô ÎåÄÌöå Í≤∞Í≥º ÌÜ†ÎÑàÎ®ºÌä∏
            if (hasAutoResult && p.autoTournamentResult.knockoutRounds?.length > 0) {
                html += `<h4 style="margin-bottom:12px;">üèÖ Í≤∞ÏÑ† ÌÜ†ÎÑàÎ®ºÌä∏</h4>`;
                
                p.autoTournamentResult.knockoutRounds.forEach(round => {
                    const bg = round.round === 'Í≤∞Ïäπ' ? '#fff3cd' : 
                              round.round === '3/4ÏúÑÏ†Ñ' ? '#ffe4c4' : 'var(--bg-secondary)';
                    
                    html += `<div style="padding:12px; margin:8px 0; background:${bg}; border-radius:8px;">`;
                    html += `<strong>${round.round}</strong> (${round.sets}ÏÑ∏Ìä∏)<br>`;
                    round.matches.forEach((m, mi) => {
                        html += `<div style="padding:8px; margin:4px 0; background:white; border-radius:6px;">`;
                        html += `<div style="display:flex; justify-content:space-between; align-items:center;">`;
                        html += `<span>${m.p1} vs ${m.p2}</span>`;
                        html += `<strong style="color:#2e7d32;">${m.winner} (${m.score})</strong>`;
                        html += `</div>`;
                        if (m.setScores?.length > 0) {
                            html += `<div style="font-size:11px; margin-top:4px;">ÏÑ∏Ìä∏Î≥Ñ: `;
                            m.setScores.forEach((s, si) => {
                                html += `<span style="background:#f5f5f5; padding:2px 6px; border-radius:3px; margin:2px;">${si+1}ÏÑ∏Ìä∏ ${s.s1}-${s.s2}</span> `;
                            });
                            html += `</div>`;
                        }
                        // ÏÉÅÏÑ∏ Í≤ΩÍ∏∞ Í∏∞Î°ù
                        if (m.history?.length > 0) {
                            html += `<details style="margin-top:8px;"><summary style="cursor:pointer; font-size:11px; color:#666;">ÏÉÅÏÑ∏ ÎìùÏ†ê Í∏∞Î°ù (${m.history.length}Ï†ê)</summary>`;
                            html += `<div style="max-height:200px; overflow-y:auto; margin-top:4px; padding:8px; background:#fafafa; border-radius:4px;">`;
                            m.history.forEach((h, hi) => {
                                html += `<div style="padding:4px 8px; margin:2px 0; font-size:11px; background:white; border-radius:3px; display:flex; justify-content:space-between;">`;
                                html += `<span>${hi+1}. ${h.player}${h.set ? ' (ÏÑ∏Ìä∏' + h.set + ')' : ''}</span>`;
                                html += `<span style="color:#1976d2;">+${h.points}Ï†ê ‚Üí ${h.scoreAfter}</span>`;
                                html += `</div>`;
                            });
                            html += `</div></details>`;
                        }
                        html += `</div>`;
                    });
                    html += `</div>`;
                });
            }
            // ÏùºÎ∞ò ÎåÄÏßÑÌëú
            else if (p.bracket) {
                html += `<h4 style="margin-bottom:12px;">üèÖ ÎåÄÏßÑÌëú (${p.bracket.size}Í∞ï)</h4>`;
                
                p.bracket.rounds.forEach((round, ri) => {
                    const roundName = p.bracket.size / Math.pow(2, ri) <= 2 ? 'Í≤∞Ïäπ' :
                                     p.bracket.size / Math.pow(2, ri) <= 4 ? 'Ï§ÄÍ≤∞Ïäπ' :
                                     `${p.bracket.size / Math.pow(2, ri)}Í∞ï`;
                    
                    html += `<div style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px;">`;
                    html += `<strong>${roundName}</strong><br>`;
                    round.forEach(m => {
                        if (m.player1?.isBye || m.player2?.isBye) return;
                        const statusIcon = m.status === 'completed' ? '‚úÖ' : '‚è≥';
                        html += `<div style="padding:4px 0;">`;
                        html += `${statusIcon} ${m.player1?.name || '?'} vs ${m.player2?.name || '?'}`;
                        if (m.winner) html += ` ‚Üí <strong>${m.winner.name}</strong>`;
                        html += `</div>`;
                    });
                    html += `</div>`;
                });
            } else {
                html += '<p style="text-align:center; padding:20px; color:var(--text-secondary);">ÎåÄÏßÑÌëú Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
            }
            
            return html;
        }
        
        function renderViewerRecords() {
            const p = currentProject;
            const hasAutoResult = p.autoTournamentResult;
            const isTeam = p.competitionType === 'team';
            
            let html = '';
            
            // Í≤ÄÏÉâ ÌïÑÎìú
            html += `<div style="margin-bottom:16px;">`;
            html += `<input type="text" id="viewer-search" placeholder="Ïù¥Î¶ÑÏúºÎ°ú Í≤ÄÏÉâ..." oninput="filterViewerRecords()" style="width:100%; padding:10px; font-size:14px;" aria-label="Ïù¥Î¶ÑÏúºÎ°ú Í≤ÄÏÉâ">`;
            html += `</div>`;
            
            html += `<div id="viewer-records-list">`;
            
            if (hasAutoResult && p.autoTournamentResult.playerRecords) {
                // ÏûêÎèô ÏãúÎÆ¨Î†àÏù¥ÏÖò Í≤∞Í≥ºÍ∞Ä ÏûàÎäî Í≤ΩÏö∞
                const records = Object.values(p.autoTournamentResult.playerRecords);
                records.sort((a, b) => (a.finalRank || 999) - (b.finalRank || 999));
                
                records.forEach(r => {
                    html += renderTeamRecordCard(r, isTeam);
                });
            } else if (p.isRandomTeamLeague && p.groups?.length > 0) {
                // ÎûúÎç§ ÌåÄ Î¶¨Í∑∏Ï†Ñ - ÏàòÎèô Í≤ΩÍ∏∞ ÏßÑÌñâ Ï§ëÏù∏ Í≤ΩÏö∞
                const teamRecords = calculateTeamRecordsFromGroups(p);
                
                // ÏäπÏàò, ÎìùÏã§Ï∞® Í∏∞Ï§ÄÏúºÎ°ú Ï†ïÎ†¨
                const sorted = Object.values(teamRecords).sort((a, b) => {
                    if (a.wins !== b.wins) return b.wins - a.wins;
                    return (b.pointsFor - b.pointsAgainst) - (a.pointsFor - a.pointsAgainst);
                });
                
                if (sorted.length > 0) {
                    sorted.forEach((r, idx) => {
                        html += renderTeamRecordCard({...r, tempRank: idx + 1}, isTeam);
                    });
                } else {
                    html += '<p style="text-align:center; padding:20px; color:var(--text-secondary);">ÏïÑÏßÅ ÏôÑÎ£åÎêú Í≤ΩÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                }
            } else {
                // ÏùºÎ∞ò ÌÜµÍ≥ÑÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞
                const stats = calculateStatistics();
                if (stats.playerStats?.length > 0) {
                    stats.playerStats.forEach(s => {
                        html += `<div class="viewer-record-item" data-name="${s.name}" style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px;">`;
                        html += `<strong>${s.name}</strong>`;
                        html += `<div style="font-size:13px; margin-top:4px;">`;
                        html += `${s.wins}Ïäπ ${s.losses}Ìå® (${s.winRate}%)`;
                        html += `</div></div>`;
                    });
                } else {
                    html += '<p style="text-align:center; padding:20px; color:var(--text-secondary);">Í∞úÏù∏ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                }
            }
            
            html += `</div>`;
            return html;
        }
        
        // ÌåÄÎ≥Ñ Í≤ΩÍ∏∞ Í∏∞Î°ù Ïπ¥Îìú Î†åÎçîÎßÅ
        function renderTeamRecordCard(r, isTeam) {
            let html = '';
            const rankBadge = r.finalRank ? 
                (r.finalRank <= 3 ? ['ü•á', 'ü•à', 'ü•â'][r.finalRank - 1] : `#${r.finalRank}`) : 
                (r.tempRank ? `#${r.tempRank}` : '');
            
            const borderColor = (r.finalRank && r.finalRank <= 3) ? 'gold' : 'var(--primary)';
            
            html += `<div class="viewer-record-item" data-name="${r.name}" style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:8px; border-left:3px solid ${borderColor};">`;
            html += `<div style="display:flex; justify-content:space-between; align-items:center;">`;
            html += `<strong>${rankBadge} ${r.name}</strong>`;
            html += `<span style="font-size:12px; color:var(--text-secondary);">${r.group || ''} ${r.groupRank ? r.groupRank + 'ÏúÑ' : ''}</span>`;
            html += `</div>`;
            
            // Ï†ÑÏ†Å ÏöîÏïΩ
            html += `<div style="font-size:13px; margin-top:6px;">`;
            html += `Ï†ÑÏ†Å: <strong>${r.wins || r.totalWins || 0}Ïäπ ${r.losses || r.totalLosses || 0}Ìå®</strong>`;
            if (!isTeam && (r.setWins !== undefined)) {
                html += ` | ÏÑ∏Ìä∏: +${r.setWins}/-${r.setLosses}`;
            }
            const pf = r.pointsFor || 0;
            const pa = r.pointsAgainst || 0;
            const diff = pf - pa;
            const diffStr = diff > 0 ? `+${diff}` : diff;
            html += ` | ÎìùÏã§: ${pf}:${pa} (<span style="color:${diff > 0 ? 'green' : diff < 0 ? 'red' : 'black'};">${diffStr}</span>)`;
            html += `</div>`;
            
            // Í≤ΩÍ∏∞ Í∏∞Î°ù
            const matches = r.matches || [];
            if (matches.length > 0) {
                html += `<details style="margin-top:8px;"><summary style="cursor:pointer; font-size:12px; padding:4px 8px; background:#e8f5e9; border-radius:4px;">Í≤ΩÍ∏∞ Í∏∞Î°ù (${matches.length}Í≤ΩÍ∏∞)</summary>`;
                html += `<div style="margin-top:8px;">`;
                matches.forEach(m => {
                    const color = m.result === 'Ïäπ' ? '#2e7d32' : '#c62828';
                    const bg = m.result === 'Ïäπ' ? '#e8f5e9' : '#ffebee';
                    html += `<div style="padding:8px; margin:4px 0; background:${bg}; border-radius:6px; border-left:3px solid ${color};">`;
                    html += `<div style="display:flex; justify-content:space-between; align-items:center;">`;
                    html += `<strong style="color:${color};">${m.result}</strong>`;
                    html += `<span style="font-size:11px; color:var(--text-secondary);">${m.stage || ''}${m.group ? ' ' + m.group : ''}</span>`;
                    html += `</div>`;
                    html += `<div style="margin-top:4px;">vs ${m.opponent}</div>`;
                    html += `<div style="font-size:14px; font-weight:bold; margin-top:4px;">${m.score}</div>`;
                    if (m.setScores?.length > 0) {
                        html += `<div style="font-size:11px; margin-top:4px; color:var(--text-secondary);">`;
                        html += `ÏÑ∏Ìä∏Î≥Ñ: ${m.setScores.map((s, i) => '<span style="background:#fff; padding:2px 6px; border-radius:3px; margin:2px;">' + (i+1) + 'ÏÑ∏Ìä∏ ' + s.s1 + '-' + s.s2 + '</span>').join(' ')}`;
                        html += `</div>`;
                    }
                    
                    // ÎìùÏ†ê ÌûàÏä§ÌÜ†Î¶¨Í∞Ä ÏûàÏúºÎ©¥ ÌëúÏãú
                    if (m.history && m.history.length > 0) {
                        html += `<details style="margin-top:6px;"><summary style="cursor:pointer; font-size:11px; color:var(--primary);">ÏÉÅÏÑ∏ ÎìùÏ†ê Í∏∞Î°ù (${m.history.length}Í∞ú)</summary>`;
                        html += `<div style="margin-top:6px; max-height:150px; overflow-y:auto; background:white; padding:6px; border-radius:4px;">`;
                        m.history.slice().reverse().forEach(h => {
                            const pColor = h.player === r.name ? '#1976d2' : '#c62828';
                            const pBg = h.player === r.name ? '#e3f2fd' : '#ffebee';
                            html += `<div style="padding:3px 6px; margin:2px 0; background:${pBg}; border-radius:3px; font-size:10px; border-left:2px solid ${pColor};">`;
                            html += `<span style="font-weight:bold;">${h.player}</span> `;
                            html += `${h.scoreBefore} ‚Üí ${h.scoreAfter}`;
                            if (h.type === 'goal') html += ` (Í≥® ${h.points}Ï†ê)`;
                            else if (h.type) html += ` (${h.type})`;
                            html += `</div>`;
                        });
                        html += `</div></details>`;
                    }
                    
                    html += `</div>`;
                });
                html += `</div></details>`;
            }
            html += `</div>`;
            
            return html;
        }
        
        // Í∑∏Î£π Í≤ΩÍ∏∞ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú ÌåÄÎ≥Ñ Í∏∞Î°ù Í≥ÑÏÇ∞
        function calculateTeamRecordsFromGroups(p) {
            const records = {};
            
            // Î™®Îì† ÌåÄ Ï¥àÍ∏∞Ìôî
            p.teams?.forEach(team => {
                records[team.name] = {
                    name: team.name,
                    group: team.group ? team.group + 'Ï°∞' : '',
                    wins: 0,
                    losses: 0,
                    pointsFor: 0,
                    pointsAgainst: 0,
                    matches: []
                };
            });
            
            // Ï°∞Î≥Ñ Í≤ΩÍ∏∞ÏóêÏÑú Í∏∞Î°ù ÏàòÏßë
            p.groups?.forEach((group, gi) => {
                const groupName = group.name || (String.fromCharCode(65 + gi) + 'Ï°∞');
                
                group.matches?.forEach(match => {
                    if (match.status !== 'finished') return;
                    
                    const p1 = match.player1Name || match.player1;
                    const p2 = match.player2Name || match.player2;
                    const s1 = match.finalScore?.player1 || match.result?.score1 || 0;
                    const s2 = match.finalScore?.player2 || match.result?.score2 || 0;
                    const history = match.history || [];
                    const setScores = match.setScores || [];
                    
                    // Î†àÏΩîÎìúÍ∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
                    if (!records[p1]) records[p1] = { name: p1, group: groupName, wins: 0, losses: 0, pointsFor: 0, pointsAgainst: 0, matches: [] };
                    if (!records[p2]) records[p2] = { name: p2, group: groupName, wins: 0, losses: 0, pointsFor: 0, pointsAgainst: 0, matches: [] };
                    
                    // ÏäπÌå® Í∏∞Î°ù (history, setScores Ìè¨Ìï®)
                    if (s1 > s2) {
                        records[p1].wins++;
                        records[p2].losses++;
                        records[p1].matches.push({ opponent: p2, result: 'Ïäπ', score: `${s1} - ${s2}`, stage: 'Ï°∞Î≥Ñ', group: groupName, history: history, setScores: setScores });
                        records[p2].matches.push({ opponent: p1, result: 'Ìå®', score: `${s2} - ${s1}`, stage: 'Ï°∞Î≥Ñ', group: groupName, history: history, setScores: setScores });
                    } else {
                        records[p2].wins++;
                        records[p1].losses++;
                        records[p2].matches.push({ opponent: p1, result: 'Ïäπ', score: `${s2} - ${s1}`, stage: 'Ï°∞Î≥Ñ', group: groupName, history: history, setScores: setScores });
                        records[p1].matches.push({ opponent: p2, result: 'Ìå®', score: `${s1} - ${s2}`, stage: 'Ï°∞Î≥Ñ', group: groupName, history: history, setScores: setScores });
                    }
                    
                    // ÎìùÏã§Ï†ê
                    records[p1].pointsFor += s1;
                    records[p1].pointsAgainst += s2;
                    records[p2].pointsFor += s2;
                    records[p2].pointsAgainst += s1;
                });
            });
            
            // Í≤∞ÏÑ† ÌÜ†ÎÑàÎ®ºÌä∏ Í≤ΩÍ∏∞
            p.bracket?.rounds?.forEach(round => {
                round.matches?.forEach(match => {
                    if (match.status !== 'finished') return;
                    
                    const p1 = match.player1Name || match.player1?.name;
                    const p2 = match.player2Name || match.player2?.name;
                    const s1 = match.finalScore?.player1 || 0;
                    const s2 = match.finalScore?.player2 || 0;
                    const roundName = round.name || 'Í≤∞ÏÑ†';
                    const history = match.history || [];
                    const setScores = match.setScores || [];
                    
                    if (!p1 || !p2) return;
                    
                    if (!records[p1]) records[p1] = { name: p1, group: '', wins: 0, losses: 0, pointsFor: 0, pointsAgainst: 0, matches: [] };
                    if (!records[p2]) records[p2] = { name: p2, group: '', wins: 0, losses: 0, pointsFor: 0, pointsAgainst: 0, matches: [] };
                    
                    if (s1 > s2) {
                        records[p1].wins++;
                        records[p2].losses++;
                        records[p1].matches.push({ opponent: p2, result: 'Ïäπ', score: `${s1} - ${s2}`, stage: roundName, history: history, setScores: setScores });
                        records[p2].matches.push({ opponent: p1, result: 'Ìå®', score: `${s2} - ${s1}`, stage: roundName, history: history, setScores: setScores });
                    } else {
                        records[p2].wins++;
                        records[p1].losses++;
                        records[p2].matches.push({ opponent: p1, result: 'Ïäπ', score: `${s2} - ${s1}`, stage: roundName, history: history, setScores: setScores });
                        records[p1].matches.push({ opponent: p2, result: 'Ìå®', score: `${s1} - ${s2}`, stage: roundName, history: history, setScores: setScores });
                    }
                    
                    records[p1].pointsFor += s1;
                    records[p1].pointsAgainst += s2;
                    records[p2].pointsFor += s2;
                    records[p2].pointsAgainst += s1;
                });
            });
            
            return records;
        }
        
        function filterViewerRecords() {
            const search = document.getElementById('viewer-search')?.value.toLowerCase() || '';
            document.querySelectorAll('.viewer-record-item').forEach(item => {
                const name = item.dataset.name?.toLowerCase() || '';
                item.style.display = name.includes(search) ? 'block' : 'none';
            });
        }
        
        // ========== ÎåÄÏßÑ Í¥ÄÎ¶¨ Ìï®Ïàò ÎÅù ==========

        // ========== ÎåÄÌöå ÎåÄÏßÑ ÏúÑÏûêÎìú Ìï®Ïàò ==========
        function twNextStep() {
            const tw = window.tournamentWizard;
            
            // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (tw.step === 1) {
                const name = document.getElementById('tw-name')?.value.trim();
                if (!name) {
                    alert('ÎåÄÌöåÎ™ÖÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                tw.info.name = name;
                tw.info.date = document.getElementById('tw-date')?.value || '';
                tw.info.location = document.getElementById('tw-location')?.value.trim() || '';
                // rules Ï†úÍ±∞Îê®
            } else if (tw.step === 2) {
                if (tw.participants.length < 2) {
                    alert('ÏµúÏÜå 2Î™Ö Ïù¥ÏÉÅÏùò Ï∞∏Í∞ÄÏûêÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.');
                    return;
                }
            } else if (tw.step === 3) {
                // Step 3 ‚Üí Step 4 Ï†ÑÌôò Ïãú Î≥∏ÏÑ† Í∑úÎ™® Ï¥àÍ∏∞Ìôî
                const participantCount = tw.participants.length;
                const finalsCount = tw.preliminary.enabled 
                    ? (tw.preliminary.groupCount * tw.preliminary.advanceCount + tw.preliminary.wildcards)
                    : participantCount;
                
                // Ï†ÅÏ†àÌïú Î≥∏ÏÑ† Í∑úÎ™® ÏûêÎèô ÏÑ§Ï†ï
                const possibleSizes = [4, 8, 16, 32, 64].filter(s => s >= finalsCount);
                if (possibleSizes.length > 0 && !tw.finals.size) {
                    tw.finals.size = possibleSizes[0]; // Ï∞∏Í∞ÄÏûê ÏàòÏóê ÎßûÎäî ÏµúÏÜå Í∑úÎ™®
                } else if (!possibleSizes.includes(tw.finals.size)) {
                    tw.finals.size = possibleSizes[0] || 4;
                }
            } else if (tw.step === 4) {
                // ÏÑ§Ï†ï Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                if (tw.format === 'group-knockout') {
                    const advanceTotal = tw.groupSettings.groupCount * tw.groupSettings.advanceCount;
                    if (advanceTotal > tw.knockoutSettings.size) {
                        alert(`ÏßÑÏ∂úÏûê Ïàò(${advanceTotal}Î™Ö)Í∞Ä ÌÜ†ÎÑàÎ®ºÌä∏ Í∑úÎ™®(${tw.knockoutSettings.size}Í∞ï)Î≥¥Îã§ ÎßéÏäµÎãàÎã§.`);
                        return;
                    }
                }
            }
            
            tw.step++;
            
            // Step 5 ÏßÑÏûÖ Ïãú ÎåÄÏßÑÌëú ÏÉùÏÑ±
            if (tw.step === 5) {
                generateTWBracket();
            }
            
            render();
        }
        
        function twPrevStep() {
            const tw = window.tournamentWizard;
            if (tw.step > 1) {
                tw.step--;
                render();
            }
        }
        
        function addTWParticipant() {
            const tw = window.tournamentWizard;
            const input = document.getElementById('tw-participant');
            const value = input?.value.trim();
            
            if (!value) return;
            
            // ÏâºÌëúÎ°ú Íµ¨Î∂ÑÎêú Ïó¨Îü¨ Î™Ö Ï≤òÎ¶¨
            const names = value.split(',').map(n => n.trim()).filter(n => n);
            names.forEach(name => {
                if (!tw.participants.includes(name)) {
                    tw.participants.push(name);
                }
            });
            
            input.value = '';
            render();
        }
        
        function removeTWParticipant(index) {
            window.tournamentWizard.participants.splice(index, 1);
            render();
        }
        
        function moveTWParticipant(index, direction) {
            const tw = window.tournamentWizard;
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= tw.participants.length) return;
            
            const temp = tw.participants[index];
            tw.participants[index] = tw.participants[newIndex];
            tw.participants[newIndex] = temp;
            render();
        }
        
        function shuffleTWParticipants() {
            const tw = window.tournamentWizard;
            for (let i = tw.participants.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [tw.participants[i], tw.participants[j]] = [tw.participants[j], tw.participants[i]];
            }
            announce('Ï∞∏Í∞ÄÏûê ÏàúÏÑúÍ∞Ä ÎûúÎç§ÏúºÎ°ú ÏÑûÏòÄÏäµÎãàÎã§');
            render();
        }
        
        function clearTWParticipants() {
            if (confirm('Î™®Îì† Ï∞∏Í∞ÄÏûêÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                window.tournamentWizard.participants = [];
                render();
            }
        }
        
        // Ïª§Ïä§ÌÖÄ ÏòàÏÑ† ÏÑ§Ï†ï ÏóÖÎç∞Ïù¥Ìä∏
        function updateCustomPreliminary() {
            const tw = window.tournamentWizard;
            const groupCount = parseInt(document.getElementById('tw-custom-groups')?.value) || 4;
            tw.preliminary.groupCount = groupCount;
            tw.preliminary.perGroup = Math.ceil(tw.participants.length / groupCount);
            render();
        }
        
        // Ïª§Ïä§ÌÖÄ ÎåÄÏßÑÌëú Ï¥àÍ∏∞Ìôî
        function initCustomBracket() {
            const tw = window.tournamentWizard;
            const size = tw.finals.size || 8;
            const matchCount = size / 2;
            
            tw.finals.customBracket = [];
            
            // Ï°∞ ÎùºÎ≤® ÏÉùÏÑ±
            const groupLabels = [];
            for (let i = 0; i < tw.preliminary.groupCount; i++) {
                groupLabels.push(String.fromCharCode(65 + i)); // A, B, C, ...
            }
            
            // Í∏∞Î≥∏ ÎåÄÏßÑ ÏÉùÏÑ± (A1 vs B2, B1 vs A2, ...)
            for (let i = 0; i < matchCount; i++) {
                const g1Idx = (i * 2) % groupLabels.length;
                const g2Idx = (i * 2 + 1) % groupLabels.length;
                
                tw.finals.customBracket.push({
                    matchNum: i + 1,
                    p1Group: groupLabels[g1Idx] || 'A',
                    p1Rank: 1,
                    p2Group: groupLabels[g2Idx] || 'B',
                    p2Rank: 2
                });
            }
        }
        
        // Ïª§Ïä§ÌÖÄ ÎåÄÏßÑ Í∞úÎ≥Ñ Í≤ΩÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏
        function updateCustomBracketMatch(idx, field, value) {
            const tw = window.tournamentWizard;
            if (tw.finals.customBracket && tw.finals.customBracket[idx]) {
                tw.finals.customBracket[idx][field] = value;
            }
        }
        
        // ÏûêÎèô ÎåÄÏßÑ Î∞∞Ï†ï (ÍµêÏ∞® ÏãúÎìú)
        function autoFillBracket() {
            const tw = window.tournamentWizard;
            const size = tw.finals.size || 8;
            const matchCount = size / 2;
            const groupCount = tw.preliminary.groupCount;
            const advanceCount = tw.preliminary.advanceCount;
            
            // Ï°∞ ÎùºÎ≤®
            const groupLabels = [];
            for (let i = 0; i < groupCount; i++) {
                groupLabels.push(String.fromCharCode(65 + i));
            }
            
            tw.finals.customBracket = [];
            
            // ÍµêÏ∞® ÏãúÎìú Î∞©Ïãù (A1 vs B2, A2 vs B1, C1 vs D2, ...)
            for (let i = 0; i < matchCount; i++) {
                const pairIdx = Math.floor(i / 2);
                const isFirstInPair = i % 2 === 0;
                
                const g1Idx = (pairIdx * 2) % groupCount;
                const g2Idx = (pairIdx * 2 + 1) % groupCount;
                
                if (isFirstInPair) {
                    tw.finals.customBracket.push({
                        matchNum: i + 1,
                        p1Group: groupLabels[g1Idx] || 'A',
                        p1Rank: 1,
                        p2Group: groupLabels[g2Idx] || 'B',
                        p2Rank: Math.min(2, advanceCount)
                    });
                } else {
                    tw.finals.customBracket.push({
                        matchNum: i + 1,
                        p1Group: groupLabels[g1Idx] || 'A',
                        p1Rank: Math.min(2, advanceCount),
                        p2Group: groupLabels[g2Idx] || 'B',
                        p2Rank: 1
                    });
                }
            }
            
            announce('ÎåÄÏßÑÏù¥ ÏûêÎèô Î∞∞Ï†ïÎêòÏóàÏäµÎãàÎã§');
            render();
        }
        
        function setTWFormat(format) {
            window.tournamentWizard.format = format;
            render();
        }
        
        // ÌåÄ Î¶¨Í∑∏Ïö© ÌåÄ ÏÉùÏÑ±
        function generateTWTeams() {
            const tw = window.tournamentWizard;
            const teamCount = tw.info.teamCount || 4;
            const membersPerTeam = tw.info.membersPerTeam || 3;
            const participants = [...tw.participants];
            
            // ÎûúÎç§ ÌåÄ Î¶¨Í∑∏Ïù∏ Í≤ΩÏö∞ ÏÑûÍ∏∞
            if (tw.info.type === 'random-team') {
                for (let i = participants.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [participants[i], participants[j]] = [participants[j], participants[i]];
                }
            }
            
            // ÌåÄ ÏÉùÏÑ±
            tw.teams = [];
            for (let t = 0; t < teamCount; t++) {
                tw.teams.push({
                    name: `${t + 1}ÌåÄ`,
                    members: []
                });
            }
            
            // Ïä§ÎÑ§Ïù¥ÌÅ¨ ÎìúÎûòÌîÑÌä∏Î°ú Î∞∞Ï†ï
            participants.forEach((p, idx) => {
                const round = Math.floor(idx / teamCount);
                const teamIdx = round % 2 === 0 ? idx % teamCount : teamCount - 1 - (idx % teamCount);
                if (tw.teams[teamIdx]) {
                    tw.teams[teamIdx].members.push(p);
                }
            });
        }
        
        // ÌåÄ Îã§Ïãú ÏÑûÍ∏∞
        function shuffleTWTeams() {
            const tw = window.tournamentWizard;
            tw.teams = []; // Ï¥àÍ∏∞Ìôî
            generateTWTeams();
            announce('ÌåÄÏù¥ Îã§Ïãú Ìé∏ÏÑ±ÎêòÏóàÏäµÎãàÎã§');
            render();
        }
        
        function updateTWSettings() {
            const tw = window.tournamentWizard;
            
            const groupCount = parseInt(document.getElementById('tw-group-count')?.value) || 4;
            const advanceCount = parseInt(document.getElementById('tw-advance')?.value) || 2;
            const knockoutSize = parseInt(document.getElementById('tw-knockout-size')?.value) || 8;
            
            tw.groupSettings.groupCount = groupCount;
            tw.groupSettings.advanceCount = advanceCount;
            tw.groupSettings.perGroup = Math.ceil(tw.participants.length / groupCount);
            tw.knockoutSettings.size = knockoutSize;
            
            updateTWSettingsSummary();
        }
        
        function updateTWSettingsSummary() {
            const tw = window.tournamentWizard;
            const summary = document.getElementById('tw-settings-summary');
            const validation = document.getElementById('tw-knockout-validation');
            
            if (!summary) return;
            
            const unitName = tw.info.type === 'team' ? 'ÌåÄ' : 'Î™Ö';
            let html = `<p>‚Ä¢ Ï∞∏Í∞ÄÏûê: ${tw.participants.length}${unitName}</p>`;
            
            if (tw.format !== 'knockout-only') {
                html += `<p>‚Ä¢ Ï°∞ Ìé∏ÏÑ±: ${tw.groupSettings.groupCount}Í∞ú Ï°∞ (Ï°∞Îãπ ÏïΩ ${tw.groupSettings.perGroup}${unitName})</p>`;
            }
            
            if (tw.format === 'group-knockout') {
                const advanceTotal = tw.groupSettings.groupCount * tw.groupSettings.advanceCount;
                html += `<p>‚Ä¢ Î≥∏ÏÑ† ÏßÑÏ∂ú: Í∞Å Ï°∞ ÏÉÅÏúÑ ${tw.groupSettings.advanceCount}${unitName} (Ï¥ù ${advanceTotal}${unitName})</p>`;
                html += `<p>‚Ä¢ Î≥∏ÏÑ†: ${tw.knockoutSettings.size}Í∞ï ÌÜ†ÎÑàÎ®ºÌä∏</p>`;
                
                if (validation) {
                    if (advanceTotal > tw.knockoutSettings.size) {
                        validation.innerHTML = `<span style="color:#d32f2f;">ÏßÑÏ∂úÏûê(${advanceTotal}${unitName})Í∞Ä ÌÜ†ÎÑàÎ®ºÌä∏ Í∑úÎ™®(${tw.knockoutSettings.size}Í∞ï)Î≥¥Îã§ ÎßéÏäµÎãàÎã§!</span>`;
                    } else if (advanceTotal < tw.knockoutSettings.size) {
                        validation.innerHTML = `<span style="color:#ff9800;">Î∂ÄÏ†ÑÏäπ ${tw.knockoutSettings.size - advanceTotal}${unitName} Î∞úÏÉù</span>`;
                    } else {
                        validation.innerHTML = `<span style="color:#4caf50;">Îî± ÎßûÏäµÎãàÎã§!</span>`;
                    }
                }
            } else if (tw.format === 'knockout-only') {
                html += `<p>‚Ä¢ ${tw.knockoutSettings.size}Í∞ï ÌÜ†ÎÑàÎ®ºÌä∏</p>`;
            }
            
            summary.innerHTML = html;
        }
        
        function generateTWBracket() {
            const tw = window.tournamentWizard;
            const participants = [...tw.participants];
            const isCustom = tw.mode === 'custom';
            
            // ÎåÄÌöå ÌòïÏãù Í≤∞Ï†ï
            let tournamentType;
            if (isCustom) {
                tournamentType = tw.preliminary?.enabled ? 'group-knockout' : 'knockout-only';
            } else {
                tournamentType = tw.template || 'group-knockout';
            }
            
            // Ï°∞ Ìé∏ÏÑ± ÌïÑÏöî Ïó¨Î∂Ä
            const needsGroups = tournamentType !== 'knockout-only';
            
            // Ïª§Ïä§ÌÖÄ Î™®ÎìúÏóêÏÑú ÏßÅÏ†ë ÏûÖÎ†•Ïù¥ ÏïÑÎãàÍ±∞ÎÇò, ÌÖúÌîåÎ¶ø Î™®ÎìúÎ©¥ ÏÑûÍ∏∞
            const shouldShuffle = isCustom ? (tw.preliminary?.groupAssignment === 'random') : true;
            
            if (shouldShuffle) {
                for (let i = participants.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [participants[i], participants[j]] = [participants[j], participants[i]];
                }
            }
            
            // Ï°∞ Ìé∏ÏÑ±
            if (needsGroups) {
                const groupCount = isCustom ? tw.preliminary.groupCount : (tw.preliminary?.groupCount || 4);
                tw.groups = Array(groupCount).fill(null).map(() => []);
                
                // Ïä§ÎÑ§Ïù¥ÌÅ¨ ÎìúÎûòÌîÑÌä∏ Î∞©ÏãùÏúºÎ°ú Î∞∞Ï†ï
                participants.forEach((p, idx) => {
                    const round = Math.floor(idx / groupCount);
                    const groupIdx = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                    tw.groups[groupIdx].push(p);
                });
            }
            
            // ÌÜ†ÎÑàÎ®ºÌä∏ÎßåÏù∏ Í≤ΩÏö∞ ÎåÄÏßÑÌëú ÏÉùÏÑ±
            if (tournamentType === 'knockout-only') {
                const size = isCustom ? (tw.finals?.size || 8) : (tw.knockoutSettings?.size || participants.length);
                tw.bracket = {
                    size: size,
                    participants: participants.slice(0, size),
                    matches: []
                };
            }
        }
        
        function generateTWPreview() {
            const tw = window.tournamentWizard;
            const isCustom = tw.mode === 'custom';
            let html = '';
            
            // ÎåÄÌöå ÌòïÏãù Í≤∞Ï†ï
            let tournamentType;
            if (isCustom) {
                tournamentType = tw.preliminary?.enabled ? 'group-knockout' : 'knockout-only';
            } else {
                tournamentType = tw.template || 'group-knockout';
            }
            
            // ÏÑ§Ï†ï ÏöîÏïΩ
            html += `
                <div style="background:#f5f5f5; padding:12px; border-radius:8px; margin-bottom:16px;">
                    <div style="font-size:14px;">
                        <strong>Ï∞∏Í∞ÄÏûê:</strong> ${tw.participants.length}Î™Ö<br>
                        ${isCustom && tw.preliminary?.enabled ? `
                            <strong>ÏòàÏÑ†:</strong> ${tw.preliminary.groupCount}Í∞ú Ï°∞, ${tw.preliminary.sets}ÏÑ∏Ìä∏<br>
                            <strong>Î≥∏ÏÑ† ÏßÑÏ∂ú:</strong> Í∞Å Ï°∞ ${tw.preliminary.advanceCount}Î™Ö${tw.preliminary.wildcards > 0 ? ` + ÏôÄÏùºÎìúÏπ¥Îìú ${tw.preliminary.wildcards}Î™Ö` : ''}<br>
                            <strong>Î≥∏ÏÑ†:</strong> ${tw.finals.size}Í∞ï, ${tw.finals.sets}ÏÑ∏Ìä∏
                        ` : isCustom ? `
                            <strong>ÌòïÏãù:</strong> ÌÜ†ÎÑàÎ®ºÌä∏ ${tw.finals?.size || 8}Í∞ï, ${tw.finals?.sets || 5}ÏÑ∏Ìä∏
                        ` : `
                            <strong>ÌòïÏãù:</strong> ${tournamentType === 'group-only' ? 'Ï°∞Î≥Ñ Î¶¨Í∑∏' : tournamentType === 'knockout-only' ? 'ÌÜ†ÎÑàÎ®ºÌä∏' : 'Ï°∞Î≥Ñ ÏòàÏÑ† + Î≥∏ÏÑ†'}
                        `}
                    </div>
                </div>
            `;
            
            // Ï°∞Î≥Ñ Î¶¨Í∑∏ ÎØ∏Î¶¨Î≥¥Í∏∞
            if (tournamentType !== 'knockout-only' && tw.groups && tw.groups.length > 0) {
                html += `<h4 style="margin:0 0 12px 0;">Ï°∞Î≥Ñ Î¶¨Í∑∏</h4>`;
                html += `<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-bottom:20px;">`;
                
                tw.groups.forEach((group, idx) => {
                    const groupName = String.fromCharCode(65 + idx); // A, B, C, ...
                    html += `
                        <div style="background:#f5f5f5; padding:12px; border-radius:8px;">
                            <div style="font-weight:600; margin-bottom:8px; color:#1976d2;">${groupName}Ï°∞ (${group.length}Î™Ö)</div>
                            ${group.map((p, i) => `<div style="font-size:13px; padding:4px 0;">${i+1}. ${p}</div>`).join('')}
                        </div>
                    `;
                });
                
                html += `</div>`;
                
                // Ï°∞Î≥Ñ Í≤ΩÍ∏∞ Ïàò Í≥ÑÏÇ∞
                const matchesPerGroup = tw.groups.map(g => g.length * (g.length - 1) / 2);
                const totalGroupMatches = matchesPerGroup.reduce((a, b) => a + b, 0);
                html += `<p style="font-size:13px; color:#666;">Ï°∞Î≥Ñ Î¶¨Í∑∏ Ï¥ù ${totalGroupMatches}Í≤ΩÍ∏∞</p>`;
            }
            
            // Î≥∏ÏÑ† ÌÜ†ÎÑàÎ®ºÌä∏ ÎØ∏Î¶¨Î≥¥Í∏∞
            if (tournamentType === 'group-knockout') {
                const advanceCount = isCustom ? tw.preliminary.advanceCount : (tw.preliminary?.advanceCount || 2);
                const groupCount = isCustom ? tw.preliminary.groupCount : (tw.preliminary?.groupCount || 4);
                const wildcards = isCustom ? (tw.preliminary.wildcards || 0) : 0;
                const finalsSize = isCustom ? tw.finals.size : (tw.knockoutSettings?.size || 8);
                const advanceTotal = groupCount * advanceCount + wildcards;
                
                html += `
                    <h4 style="margin:20px 0 12px 0;">ü•ä Î≥∏ÏÑ† ÌÜ†ÎÑàÎ®ºÌä∏</h4>
                    <div style="background:#fff3e0; padding:12px; border-radius:8px;">
                        <p style="margin:0;">‚Ä¢ ${finalsSize}Í∞ï ÌÜ†ÎÑàÎ®ºÌä∏</p>
                        <p style="margin:4px 0 0 0;">‚Ä¢ Í∞Å Ï°∞ ÏÉÅÏúÑ ${advanceCount}Î™Ö ÏßÑÏ∂ú${wildcards > 0 ? ` + ÏôÄÏùºÎìúÏπ¥Îìú ${wildcards}Î™Ö` : ''} (Ï¥ù ${advanceTotal}Î™Ö)</p>
                        ${isCustom && tw.finals.customBracket?.length > 0 ? `
                            <p style="margin:8px 0 0 0; font-weight:600;">Ïª§Ïä§ÌÖÄ ÎåÄÏßÑ:</p>
                            ${tw.finals.customBracket.slice(0, 4).map((m, i) => `
                                <p style="margin:4px 0 0 0; font-size:13px;">${i+1}Í≤ΩÍ∏∞: ${m.p1Group}Ï°∞ ${m.p1Rank}ÏúÑ vs ${m.p2Group}Ï°∞ ${m.p2Rank}ÏúÑ</p>
                            `).join('')}
                            ${tw.finals.customBracket.length > 4 ? `<p style="margin:4px 0 0 0; font-size:13px; color:#666;">... Ïô∏ ${tw.finals.customBracket.length - 4}Í≤ΩÍ∏∞</p>` : ''}
                        ` : `
                            <p style="margin:4px 0 0 0; font-size:13px; color:#666;">‚Äª Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏôÑÎ£å ÌõÑ ÎåÄÏßÑÌëú ÌôïÏ†ï</p>
                        `}
                    </div>
                `;
            } else if (tournamentType === 'knockout-only') {
                const finalsSize = isCustom ? (tw.finals?.size || 8) : (tw.knockoutSettings?.size || 8);
                html += `<h4 style="margin:0 0 12px 0;">ü•ä ÌÜ†ÎÑàÎ®ºÌä∏ ÎåÄÏßÑÌëú</h4>`;
                html += `<div style="background:#fff3e0; padding:12px; border-radius:8px;">`;
                html += `<p style="margin:0;">${finalsSize}Í∞ï ÌÜ†ÎÑàÎ®ºÌä∏</p>`;
                
                const bracket = tw.bracket;
                if (bracket && bracket.participants) {
                    html += `<div style="margin-top:12px;">`;
                    for (let i = 0; i < bracket.participants.length; i += 2) {
                        const p1 = bracket.participants[i] || 'BYE';
                        const p2 = bracket.participants[i + 1] || 'BYE';
                        html += `<div style="font-size:13px; padding:6px 0; border-bottom:1px solid #eee;">${i/2+1}Í≤ΩÍ∏∞: ${p1} vs ${p2}</div>`;
                    }
                    html += `</div>`;
                }
                html += `</div>`;
            }
            
            return html;
        }
        
        function confirmTournament() {
            const tw = window.tournamentWizard;
            
            if (!confirm('ÎåÄÏßÑÌëúÎ•º ÌôïÏ†ïÌïòÍ≥† ÎåÄÌöåÎ•º ÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            // ÏÑ∏Ìä∏ Ïàò Í≤∞Ï†ï (Ïª§Ïä§ÌÖÄ Î™®Îìú vs ÌÖúÌîåÎ¶ø Î™®Îìú)
            const isCustom = tw.mode === 'custom';
            const preliminarySets = isCustom ? (tw.preliminary?.sets || 3) : (tw.preliminary?.sets || 3);
            const finalsSets = isCustom ? (tw.finals?.sets || 5) : (tw.preliminary?.sets || 3);
            const isTeam = tw.info.type === 'team';
            const winScore = isTeam ? 31 : 11;
            
            // ÎåÄÌöå ÌòïÏãù Í≤∞Ï†ï
            let tournamentType;
            if (isCustom) {
                tournamentType = tw.preliminary?.enabled ? 'group-knockout' : 'knockout-only';
            } else {
                tournamentType = tw.template || 'group-knockout';
            }
            
            // ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±
            const project = {
                id: Date.now(),
                name: tw.info.name,
                date: tw.info.date,
                location: tw.info.location,
                competitionType: isTeam ? 'team' : 'individual',
                players: !isTeam ? tw.participants : [],
                teams: isTeam ? tw.participants.map(t => ({ name: t, players: [] })) : [],
                tournamentType: tournamentType,
                groups: [],
                matches: [],
                bracket: tw.bracket,
                customBracket: tw.finals?.customBracket || [],
                preliminarySets: preliminarySets,
                finalsSets: finalsSets,
                advanceCount: tw.preliminary?.advanceCount || 2,
                wildcards: tw.preliminary?.wildcards || 0,
                sameGroupAvoid: tw.finals?.sameGroupAvoid || 'quarterfinal',
                referees: tw.referees || [],
                courts: tw.courts || [],
                createdAt: new Date().toISOString()
            };
            
            // Ï°∞ Ìé∏ÏÑ± (Ïª§Ïä§ÌÖÄ ÎòêÎäî ÌÖúÌîåÎ¶ø Î™®Îëê)
            const needsGroups = (isCustom && tw.preliminary?.enabled) || 
                               (!isCustom && tournamentType !== 'knockout-only');
            
            if (needsGroups) {
                const participants = [...tw.participants];
                const groupCount = isCustom ? tw.preliminary.groupCount : (tw.preliminary?.groupCount || 4);
                
                // Ìé∏ÏÑ± Î∞©ÏãùÏóê Îî∞Îùº Ï≤òÎ¶¨
                if (isCustom && tw.preliminary.groupAssignment === 'random') {
                    for (let i = participants.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [participants[i], participants[j]] = [participants[j], participants[i]];
                    }
                } else if (!isCustom) {
                    // ÌÖúÌîåÎ¶ø Î™®ÎìúÎäî Í∏∞Î≥∏ ÎûúÎç§
                    for (let i = participants.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [participants[i], participants[j]] = [participants[j], participants[i]];
                    }
                }
                
                // Ïä§ÎÑ§Ïù¥ÌÅ¨ ÎìúÎûòÌîÑÌä∏Î°ú Ï°∞ Î∞∞Ï†ï
                const groups = Array(groupCount).fill(null).map(() => []);
                participants.forEach((p, idx) => {
                    const round = Math.floor(idx / groupCount);
                    const groupIdx = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                    groups[groupIdx].push(p);
                });
                
                project.groups = groups.map((members, idx) => ({
                    name: String.fromCharCode(65 + idx) + 'Ï°∞',
                    members: members,
                    matches: [],
                    standings: []
                }));
                
                // Ï°∞Î≥Ñ Î¶¨Í∑∏ Í≤ΩÍ∏∞ ÏÉùÏÑ±
                project.groups.forEach((group, gIdx) => {
                    const members = group.members;
                    for (let i = 0; i < members.length; i++) {
                        for (let j = i + 1; j < members.length; j++) {
                            const match = {
                                id: Date.now() + gIdx * 1000 + i * 100 + j,
                                player1Name: members[i],
                                player2Name: members[j],
                                type: isTeam ? 'team' : 'individual',
                                sets: isTeam ? 1 : preliminarySets,
                                winScore: winScore,
                                currentSet: 1,
                                setScores: [{ player1: 0, player2: 0 }],
                                currentServe: 'player1',
                                serveCount: 0,
                                serveSelected: false,
                                timeouts: { player1: 1, player2: 1 },
                                history: [],
                                status: 'pending',
                                groupIndex: gIdx,
                                groupName: group.name,
                                phase: 'preliminary',
                                refereePin: generatePin()
                            };
                            project.matches.push(match);
                            group.matches.push(match.id);
                        }
                    }
                });
            }
            
            // ÌÜ†ÎÑàÎ®ºÌä∏ÎßåÏù∏ Í≤ΩÏö∞ Î∞îÎ°ú Î≥∏ÏÑ† Í≤ΩÍ∏∞ ÏÉùÏÑ±
            if (tournamentType === 'knockout-only') {
                const participants = [...tw.participants];
                const size = isCustom ? (tw.finals?.size || 8) : (tw.knockoutSettings?.size || participants.length);
                
                // ÎûúÎç§ ÏÑûÍ∏∞
                for (let i = participants.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [participants[i], participants[j]] = [participants[j], participants[i]];
                }
                
                for (let i = 0; i < Math.min(participants.length, size); i += 2) {
                    const p1 = participants[i];
                    const p2 = participants[i + 1];
                    
                    if (p1 && p2) {
                        const match = {
                            id: Date.now() + i,
                            player1Name: p1,
                            player2Name: p2,
                            type: isTeam ? 'team' : 'individual',
                            sets: isTeam ? 1 : finalsSets,
                            winScore: winScore,
                            currentSet: 1,
                            setScores: [{ player1: 0, player2: 0 }],
                            currentServe: 'player1',
                            serveCount: 0,
                            serveSelected: false,
                            timeouts: { player1: 1, player2: 1 },
                            history: [],
                            status: 'pending',
                            bracketRound: 1,
                            bracketMatchNum: i / 2 + 1,
                            phase: 'finals',
                            refereePin: generatePin()
                        };
                        project.matches.push(match);
                    }
                }
            }
            
            // ÌîÑÎ°úÏ†ùÌä∏ Ï†ÄÏû•
            projects.push(project);
            saveProjects();
            
            // ÏúÑÏûêÎìú Ï¥àÍ∏∞Ìôî
            window.tournamentWizard = null;
            
            // ÏÉùÏÑ±Îêú ÌîÑÎ°úÏ†ùÌä∏Î°ú Ïù¥Îèô
            currentProject = project;
            announce(`${project.name} ÎåÄÌöåÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§. ${project.matches.length}Í≤ΩÍ∏∞`);
            
            // Í≤ΩÍ∏∞Ïû•Ïù¥ Îì±Î°ùÎêòÏñ¥ ÏûàÏúºÎ©¥ Î∞∞Ï†ï ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô Ï†úÏïà
            if (project.courts && project.courts.length > 0) {
                if (confirm(`ÎåÄÌöåÍ∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§!\n\nÎì±Î°ùÎêú Í≤ΩÍ∏∞Ïû•: ${project.courts.map(c => c.name).join(', ')}\n\nÏßÄÍ∏à Í≤ΩÍ∏∞Ïû•ÏùÑ Î∞∞Ï†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                    goTo('bracket-assign');
                    return;
                }
            }
            
            goTo('bracket-detail');
        }
        
        function generatePin() {
            return Math.random().toString().slice(2, 6);
        }
        
        // ========== Í¥ÄÎ¶¨Ïûê/Ïö¥ÏòÅÏûê Î™®Îìú Ìï®Ïàò ==========
        let adminModeAuth = false;
        
        function enterAdminMode() {
            const operators = JSON.parse(localStorage.getItem('operators') || '[]');
            
            if (operators.length === 0) {
                // Ïö¥ÏòÅÏûê ÏóÜÏùå - ÏµúÏ¥à Îì±Î°ù ÌôîÎ©¥ÏúºÎ°ú
                goTo('operator-setup');
            } else {
                // Ïö¥ÏòÅÏûê ÏûàÏùå - Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ÏúºÎ°ú
                goTo('admin-password');
            }
        }
        
        // Firebase Auth Î°úÍ∑∏Ïù∏ (Î°úÏª¨ Ìè¥Î∞± ÏßÄÏõê)
        async function verifyAdminPin() {
            const inputEmail = document.getElementById('admin-email')?.value.trim();
            const inputPassword = document.getElementById('admin-pin')?.value;
            
            if (!inputEmail || !inputPassword) {
                alert('Ïù¥Î©îÏùºÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            // Î°úÍ∑∏Ïù∏ Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            const loginBtn = document.querySelector('#admin-login-btn');
            if (loginBtn) {
                loginBtn.disabled = true;
                loginBtn.textContent = 'Î°úÍ∑∏Ïù∏ Ï§ë...';
            }
            
            // Î®ºÏ†Ä Î°úÏª¨ÏóêÏÑú Ïö¥ÏòÅÏûê ÌôïÏù∏
            const operators = JSON.parse(localStorage.getItem('operators') || '[]');
            const operator = operators.find(op => op.email === inputEmail);
            
            if (!operator) {
                alert('Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ Ïù¥Î©îÏùºÏûÖÎãàÎã§.');
                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Î°úÍ∑∏Ïù∏';
                }
                return;
            }
            
            // Firebase Auth ÏãúÎèÑ
            let firebaseSuccess = false;
            if (auth && operator.firebaseAuth) {
                try {
                    await auth.signInWithEmailAndPassword(inputEmail, inputPassword);
                    firebaseSuccess = true;
                    console.log('Firebase Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ');
                } catch (error) {
                    console.warn('Firebase Î°úÍ∑∏Ïù∏ Ïã§Ìå®, Î°úÏª¨ Î™®Îìú ÏãúÎèÑ:', error.code);
                    // Firebase Ïã§Ìå® Ïãú Î°úÏª¨ ÎπÑÎ∞ÄÎ≤àÌò∏Î°ú ÌôïÏù∏
                }
            }
            
            // Firebase ÏÑ±Í≥µ ÎòêÎäî Î°úÏª¨ ÎπÑÎ∞ÄÎ≤àÌò∏ ÏùºÏπò Ïãú Î°úÍ∑∏Ïù∏
            if (firebaseSuccess || operator.password === inputPassword) {
                adminModeAuth = true;
                sessionStorage.setItem('currentOperator', JSON.stringify(operator));
                announce(`${operator.name}Îãò, Í¥ÄÎ¶¨Ïûê Î™®Îìú ÏßÑÏûÖ`);
                
                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Î°úÍ∑∏Ïù∏';
                }
                
                goTo('admin-home');
            } else {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');
                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Î°úÍ∑∏Ïù∏';
                }
            }
        }
        
        // ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞ (Ïù¥Î©îÏùº Î∞úÏÜ°)
        async function sendPasswordReset() {
            const email = document.getElementById('reset-email')?.value.trim();
            
            if (!email) {
                alert('Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            // Ïù¥Î©îÏùºÏù¥ Îì±Î°ùÎêú Ïö¥ÏòÅÏûêÏù∏ÏßÄ ÌôïÏù∏
            const operators = JSON.parse(localStorage.getItem('operators') || '[]');
            const operator = operators.find(op => op.email === email);
            
            if (!operator) {
                alert('Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ Ïù¥Î©îÏùºÏûÖÎãàÎã§.');
                return;
            }
            
            try {
                if (auth) {
                    await auth.sendPasswordResetEmail(email);
                    alert(`ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï Ïù¥Î©îÏùºÏù¥ Î∞úÏÜ°ÎêòÏóàÏäµÎãàÎã§!\n\n${email}Î°ú Î∞úÏÜ°Îêú Ïù¥Î©îÏùºÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.`);
                    goTo('admin-password');
                } else {
                    alert('FirebaseÍ∞Ä Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏïÑ Ïù¥Î©îÏùºÏùÑ Î∞úÏÜ°Ìï† Ïàò ÏóÜÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï Ïò§Î•ò:', error);
                let errorMsg = 'Ïù¥Î©îÏùº Î∞úÏÜ°Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
                if (error.code === 'auth/user-not-found') errorMsg = 'Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ Ïù¥Î©îÏùºÏûÖÎãàÎã§.';
                else if (error.code === 'auth/invalid-email') errorMsg = 'Ïù¥Î©îÏùº ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.';
                alert(errorMsg);
            }
        }
        
        // ÏµúÏ¥à Ïö¥ÏòÅÏûê Îì±Î°ù
        async function setupFirstOperator() {
            const name = document.getElementById('first-operator-name')?.value.trim();
            const email = document.getElementById('first-operator-email')?.value.trim();
            const password = document.getElementById('first-operator-password')?.value;
            const confirmPassword = document.getElementById('first-operator-confirm')?.value;
            
            if (!name) {
                alert('Ïö¥ÏòÅÏûê Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!email) {
                alert('Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            // Ïù¥Î©îÏùº ÌòïÏãù Í≤ÄÏ¶ù
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Ïò¨Î∞îÎ•∏ Ïù¥Î©îÏùº ÌòïÏãùÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!password || password.length < 6) {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 6Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                return;
            }
            
            // Îì±Î°ù Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            const registerBtn = document.querySelector('#setup-btn');
            if (registerBtn) {
                registerBtn.disabled = true;
                registerBtn.textContent = 'Îì±Î°ù Ï§ë...';
            }
            
            let firebaseSuccess = false;
            
            // Firebase Auth ÏãúÎèÑ (Ïã§Ìå®Ìï¥ÎèÑ Î°úÏª¨ Î™®ÎìúÎ°ú Í≥ÑÏÜç ÏßÑÌñâ)
            if (auth) {
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    await user.updateProfile({ displayName: name });
                    firebaseSuccess = true;
                    console.log('Firebase Auth Îì±Î°ù ÏÑ±Í≥µ');
                } catch (error) {
                    console.warn('Firebase Auth Ïã§Ìå®, Î°úÏª¨ Î™®ÎìúÎ°ú Ï†ÑÌôò:', error.code, error.message);
                    // Firebase Ïã§Ìå®Ìï¥ÎèÑ Î°úÏª¨ Î™®ÎìúÎ°ú Í≥ÑÏÜç ÏßÑÌñâ
                }
            }
            
            // Î°úÏª¨Ïóê Ï†ÄÏû• (Firebase ÏÑ±Í≥µ/Ïã§Ìå® Í¥ÄÍ≥ÑÏóÜÏù¥)
            const operators = [{
                name: name,
                email: email,
                password: password,
                role: 'super',
                firebaseAuth: firebaseSuccess,
                createdAt: new Date().toISOString()
            }];
            
            localStorage.setItem('operators', JSON.stringify(operators));
            syncOperatorsToFirebase(operators); // Firebase ÎèôÍ∏∞Ìôî
            sessionStorage.setItem('currentOperator', JSON.stringify(operators[0]));
            adminModeAuth = true;
            
            if (firebaseSuccess) {
                alert(`${name}ÎãòÏù¥ ÏµúÍ≥† Í¥ÄÎ¶¨ÏûêÎ°ú Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!\n\n(Firebase Ïù∏Ï¶ù ÌôúÏÑ±ÌôîÎê® - ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞ Í∞ÄÎä•)`);
            } else {
                alert(`${name}ÎãòÏù¥ ÏµúÍ≥† Í¥ÄÎ¶¨ÏûêÎ°ú Îì±Î°ùÎêòÏóàÏäµÎãàÎã§!\n\nÎ°úÏª¨ Î™®ÎìúÎ°ú Îì±Î°ùÎê®\n(ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∞æÍ∏∞ Í∏∞Îä• Ï†úÌïú)`);
            }
            
            if (registerBtn) {
                registerBtn.disabled = false;
                registerBtn.textContent = 'ÏµúÍ≥† Í¥ÄÎ¶¨ÏûêÎ°ú Îì±Î°ù';
            }
            
            goTo('admin-home');
        }
        
        // Ïö¥ÏòÅÏûê Ï∂îÍ∞Ä (ÏµúÍ≥† Í¥ÄÎ¶¨ÏûêÎßå)
        async function addOperator() {
            const currentOperator = JSON.parse(sessionStorage.getItem('currentOperator') || 'null');
            if (!currentOperator || currentOperator.role !== 'super') {
                alert('ÏµúÍ≥† Í¥ÄÎ¶¨ÏûêÎßå Ïö¥ÏòÅÏûêÎ•º Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }
            
            const name = document.getElementById('new-operator-name')?.value.trim();
            const email = document.getElementById('new-operator-email')?.value.trim();
            const role = document.getElementById('new-operator-role')?.value || 'admin';
            const password = document.getElementById('new-operator-password')?.value;
            
            if (!name) {
                alert('Ïö¥ÏòÅÏûê Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!email) {
                alert('Ïù¥Î©îÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Ïò¨Î∞îÎ•∏ Ïù¥Î©îÏùº ÌòïÏãùÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!password || password.length < 6) {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 6Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.');
                return;
            }
            
            const operators = JSON.parse(localStorage.getItem('operators') || '[]');
            
            if (operators.find(op => op.email === email)) {
                alert('Ïù¥ÎØ∏ Îì±Î°ùÎêú Ïù¥Î©îÏùºÏûÖÎãàÎã§.');
                return;
            }
            
            try {
                if (auth) {
                    // ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï†ÄÏû•
                    const currentUser = auth.currentUser;
                    
                    // ÏÉà Ïö¥ÏòÅÏûê Firebase Í≥ÑÏ†ï ÏÉùÏÑ± (Î≥ÑÎèÑ auth Ïù∏Ïä§ÌÑ¥Ïä§ ÌïÑÏöî)
                    // Ï∞∏Í≥†: Firebase Admin SDK ÏóÜÏù¥Îäî ÏßÅÏ†ë ÏÉùÏÑ±Ïù¥ Ï†úÌïúÏ†Å
                    // ÎåÄÏïà: Ï¥àÎåÄ Ïù¥Î©îÏùº Î∞úÏÜ°
                    
                    // Í∞ÑÎã®Ìïú Î∞©Î≤ï: Ïö¥ÏòÅÏûêÍ∞Ä ÏßÅÏ†ë Í∞ÄÏûÖÌïòÎèÑÎ°ù Ï¥àÎåÄ
                    // Ïó¨Í∏∞ÏÑúÎäî Î°úÏª¨ÏóêÎßå Ï†ÄÏû•ÌïòÍ≥† Ï≤´ Î°úÍ∑∏Ïù∏ Ïãú Firebase Í≥ÑÏ†ï ÏÉùÏÑ± Ïú†ÎèÑ
                }
                
                operators.push({
                    name: name,
                    email: email,
                    password: password,
                    role: role,
                    createdAt: new Date().toISOString(),
                    needsFirebaseSetup: true // Firebase Í≥ÑÏ†ï ÏÉùÏÑ± ÌïÑÏöî ÌëúÏãú
                });
                
                localStorage.setItem('operators', JSON.stringify(operators));
                syncOperatorsToFirebase(operators); // Firebase ÎèôÍ∏∞Ìôî
                alert(`Ïö¥ÏòÅÏûê "${name}" Îì±Î°ù ÏôÑÎ£å!\n\nÏù¥Î©îÏùº: ${email}\nÏûÑÏãú ÎπÑÎ∞ÄÎ≤àÌò∏: ${password}\n\nÏ≤´ Î°úÍ∑∏Ïù∏ Ïãú ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Î≥ÄÍ≤ΩÌïòÎèÑÎ°ù ÏïàÎÇ¥Ìï¥Ï£ºÏÑ∏Ïöî.`);
                render();
                
            } catch (error) {
                console.error('Ïö¥ÏòÅÏûê Ï∂îÍ∞Ä Ïò§Î•ò:', error);
                alert('Ïö¥ÏòÅÏûê Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
        }
        
        // Ïö¥ÏòÅÏûê ÏÇ≠Ï†ú
        function deleteOperator(idx) {
            const currentOperator = JSON.parse(sessionStorage.getItem('currentOperator') || 'null');
            if (!currentOperator || currentOperator.role !== 'super') {
                alert('ÏµúÍ≥† Í¥ÄÎ¶¨ÏûêÎßå Ïö¥ÏòÅÏûêÎ•º ÏÇ≠Ï†úÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }
            
            const operators = JSON.parse(localStorage.getItem('operators') || '[]');
            const targetOp = operators[idx];
            
            // ÏûêÍ∏∞ ÏûêÏã†ÏùÄ ÏÇ≠Ï†ú Î∂àÍ∞Ä
            if (targetOp.name === currentOperator.name) {
                alert('ÏûêÍ∏∞ ÏûêÏã†ÏùÄ ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // ÎßàÏßÄÎßâ ÏµúÍ≥† Í¥ÄÎ¶¨ÏûêÎäî ÏÇ≠Ï†ú Î∂àÍ∞Ä
            if (targetOp.role === 'super' && operators.filter(op => op.role === 'super').length <= 1) {
                alert('ÏµúÏÜå 1Î™ÖÏùò ÏµúÍ≥† Í¥ÄÎ¶¨ÏûêÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.');
                return;
            }
            
            if (confirm(`"${targetOp.name}" Ïö¥ÏòÅÏûêÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                operators.splice(idx, 1);
                localStorage.setItem('operators', JSON.stringify(operators));
                syncOperatorsToFirebase(operators); // Firebase ÎèôÍ∏∞Ìôî
                announce(`Ïö¥ÏòÅÏûê ÏÇ≠Ï†úÎê®`);
                render();
            }
        }
        
        // Ïö¥ÏòÅÏûê Í∂åÌïú Î≥ÄÍ≤Ω
        function toggleOperatorRole(idx) {
            const currentOperator = JSON.parse(sessionStorage.getItem('currentOperator') || 'null');
            if (!currentOperator || currentOperator.role !== 'super') {
                alert('ÏµúÍ≥† Í¥ÄÎ¶¨ÏûêÎßå Í∂åÌïúÏùÑ Î≥ÄÍ≤ΩÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }
            
            const operators = JSON.parse(localStorage.getItem('operators') || '[]');
            const targetOp = operators[idx];
            
            const newRole = targetOp.role === 'super' ? 'admin' : 'super';
            const roleLabel = newRole === 'super' ? 'ÏµúÍ≥† Í¥ÄÎ¶¨Ïûê' : 'ÏùºÎ∞ò Í¥ÄÎ¶¨Ïûê';
            
            if (confirm(`"${targetOp.name}"Ïùò Í∂åÌïúÏùÑ "${roleLabel}"Î°ú Î≥ÄÍ≤ΩÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                operators[idx].role = newRole;
                localStorage.setItem('operators', JSON.stringify(operators));
                syncOperatorsToFirebase(operators); // Firebase ÎèôÍ∏∞Ìôî
                alert(`Í∂åÌïúÏù¥ "${roleLabel}"Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
                render();
            }
        }
        
        // ÎÇ¥ ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
        async function changeMyPassword() {
            const currentOperator = JSON.parse(sessionStorage.getItem('currentOperator') || 'null');
            if (!currentOperator) {
                alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                return;
            }
            
            const currentPw = prompt('ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            if (!currentPw) return;
            
            const newPw = prompt('ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (6Ïûê Ïù¥ÏÉÅ):');
            if (!newPw || newPw.length < 6) {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 6Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.');
                return;
            }
            
            const confirmPw = prompt('ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Îã§Ïãú ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            if (newPw !== confirmPw) {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                return;
            }
            
            try {
                if (auth && auth.currentUser) {
                    // Firebase Auth ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        currentOperator.email,
                        currentPw
                    );
                    
                    // Ïû¨Ïù∏Ï¶ù
                    await auth.currentUser.reauthenticateWithCredential(credential);
                    
                    // ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î°ú Î≥ÄÍ≤Ω
                    await auth.currentUser.updatePassword(newPw);
                }
                
                // Î°úÏª¨ Ï†ÄÏû•ÏÜå ÏóÖÎç∞Ïù¥Ìä∏
                const operators = JSON.parse(localStorage.getItem('operators') || '[]');
                const idx = operators.findIndex(op => op.email === currentOperator.email);
                
                if (idx >= 0) {
                    operators[idx].password = newPw;
                    localStorage.setItem('operators', JSON.stringify(operators));
                    
                    currentOperator.password = newPw;
                    sessionStorage.setItem('currentOperator', JSON.stringify(currentOperator));
                }
                
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.');
                
            } catch (error) {
                console.error('ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω Ïò§Î•ò:', error);
                let errorMsg = 'ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.';
                if (error.code === 'auth/wrong-password') errorMsg = 'ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.';
                else if (error.code === 'auth/weak-password') errorMsg = 'ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÎÑàÎ¨¥ ÏïΩÌï©ÎãàÎã§.';
                alert(errorMsg);
            }
        }
        
        // Îã§Î•∏ Ïö¥ÏòÅÏûê ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî (ÏµúÍ≥†Í¥ÄÎ¶¨Ïûê Í∏∞Îä•)
        async function resetOperatorPassword(idx) {
            const currentOperator = JSON.parse(sessionStorage.getItem('currentOperator') || 'null');
            if (!currentOperator || currentOperator.role !== 'super') {
                alert('ÏµúÍ≥† Í¥ÄÎ¶¨ÏûêÎßå ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Ï¥àÍ∏∞ÌôîÌï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }
            
            const operators = JSON.parse(localStorage.getItem('operators') || '[]');
            const targetOp = operators[idx];
            
            if (!targetOp) return;
            
            if (confirm(`"${targetOp.name}" Ïö¥ÏòÅÏûêÏóêÍ≤å ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï Ïù¥Î©îÏùºÏùÑ Î∞úÏÜ°ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                try {
                    if (auth) {
                        await auth.sendPasswordResetEmail(targetOp.email);
                        alert(`ÎπÑÎ∞ÄÎ≤àÌò∏ Ïû¨ÏÑ§Ï†ï Ïù¥Î©îÏùºÏù¥ ${targetOp.email}Î°ú Î∞úÏÜ°ÎêòÏóàÏäµÎãàÎã§.`);
                    } else {
                        // Î°úÏª¨ Î™®Îìú: ÏûÑÏãú ÎπÑÎ∞ÄÎ≤àÌò∏ Î∞úÍ∏â
                        const tempPw = Math.random().toString(36).slice(-8);
                        operators[idx].password = tempPw;
                        localStorage.setItem('operators', JSON.stringify(operators));
                        alert(`ÏûÑÏãú ÎπÑÎ∞ÄÎ≤àÌò∏: ${tempPw}\n\nÏö¥ÏòÅÏûêÏóêÍ≤å ÏßÅÏ†ë Ï†ÑÎã¨Ìï¥Ï£ºÏÑ∏Ïöî.`);
                    }
                } catch (error) {
                    console.error('ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî Ïò§Î•ò:', error);
                    alert('ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
                }
            }
        }
        
        // ÎåÄÌöå Îç∞Ïù¥ÌÑ∞Îßå Ï¥àÍ∏∞Ìôî
        function resetTournamentData() {
            if (prompt('ÎåÄÌöå Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÌôïÏù∏ÌïòÎ†§Î©¥ "Ï¥àÍ∏∞Ìôî"Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:') === 'Ï¥àÍ∏∞Ìôî') {
                projects = [];
                saveProjects();
                localStorage.removeItem('practiceHistory');
                alert('ÎåÄÌöå Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.\n(Ïö¥ÏòÅÏûê, Ïã¨Ìåê, Í≤ΩÍ∏∞Ïû• Ï†ïÎ≥¥Îäî Ïú†ÏßÄÎê©ÎãàÎã§)');
                render();
            }
        }
        
        // Ïö¥ÏòÅÏûê Ï¥àÍ∏∞Ìôî
        function resetOperators() {
            if (prompt('Ïö¥ÏòÅÏûê Ï†ïÎ≥¥Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏû¨ÏÑ§Ï†ï ÌôîÎ©¥ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.\n\nÌôïÏù∏ÌïòÎ†§Î©¥ "Ïû¨ÏÑ§Ï†ï"ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:') === 'Ïû¨ÏÑ§Ï†ï') {
                localStorage.removeItem('operators');
                sessionStorage.removeItem('currentOperator');
                adminModeAuth = false;
                alert('Ïö¥ÏòÅÏûê Ï†ïÎ≥¥Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.\nÏµúÏ¥à Ïö¥ÏòÅÏûê Îì±Î°ù ÌôîÎ©¥ÏúºÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.');
                goTo('operator-setup');
            }
        }
        
        // Í≥µÏû• Ï¥àÍ∏∞Ìôî
        function factoryReset() {
            if (prompt('Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÍ≥† Ï¥àÍ∏∞ ÏÉÅÌÉúÎ°ú ÎêòÎèåÎ¶¨ÏãúÍ≤†ÏäµÎãàÍπå?\n\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!\n\nÌôïÏù∏ÌïòÎ†§Î©¥ "Í≥µÏû•Ï¥àÍ∏∞Ìôî"Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:') === 'Í≥µÏû•Ï¥àÍ∏∞Ìôî') {
                localStorage.clear();
                sessionStorage.clear();
                projects = [];
                alert('Í≥µÏû• Ï¥àÍ∏∞Ìôî ÏôÑÎ£å!\nÏï±Ïù¥ Ïû¨ÏãúÏûëÎê©ÎãàÎã§.');
                location.reload();
            }
        }
        
        // Í¥ÄÎ¶¨Ïûê Î°úÍ∑∏ÏïÑÏõÉ
        function adminLogout() {
            sessionStorage.removeItem('currentOperator');
            adminModeAuth = false;
            announce('Î°úÍ∑∏ÏïÑÏõÉ ÎêòÏóàÏäµÎãàÎã§.');
            goTo('home');
        }
        
        // Ï†ÑÏó≠ Ïã¨Ìåê Í¥ÄÎ¶¨
        function addGlobalReferee() {
            const name = document.getElementById('new-referee-name')?.value.trim();
            const role = document.getElementById('new-referee-role')?.value || 'Ïã¨Ìåê';
            
            if (!name) {
                alert('Ïã¨Ìåê Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const globalReferees = JSON.parse(localStorage.getItem('globalReferees') || '[]');
            
            if (globalReferees.find(r => r.name === name)) {
                alert('Ïù¥ÎØ∏ Îì±Î°ùÎêú Ïã¨ÌåêÏûÖÎãàÎã§.');
                return;
            }
            
            const pin = Math.random().toString().slice(2, 6);
            globalReferees.push({ name, role, pin, createdAt: new Date().toISOString() });
            localStorage.setItem('globalReferees', JSON.stringify(globalReferees));
            
            announce(`Ïã¨Ìåê "${name}" Îì±Î°ù ÏôÑÎ£å. PIN: ${pin}`);
            alert(`Ïã¨Ìåê "${name}" Îì±Î°ù ÏôÑÎ£å!\nPIN: ${pin}`);
            render();
        }
        
        function deleteGlobalReferee(idx) {
            const globalReferees = JSON.parse(localStorage.getItem('globalReferees') || '[]');
            const ref = globalReferees[idx];
            
            if (confirm(`"${ref.name}" Ïã¨ÌåêÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                globalReferees.splice(idx, 1);
                localStorage.setItem('globalReferees', JSON.stringify(globalReferees));
                announce(`Ïã¨Ìåê "${ref.name}" ÏÇ≠Ï†úÎê®`);
                render();
            }
        }
        
        function regenerateRefereePin(idx) {
            const globalReferees = JSON.parse(localStorage.getItem('globalReferees') || '[]');
            const ref = globalReferees[idx];
            const newPin = Math.random().toString().slice(2, 6);
            
            if (confirm(`"${ref.name}" Ïã¨ÌåêÏùò PINÏùÑ Ïû¨Î∞úÍ∏âÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                globalReferees[idx].pin = newPin;
                localStorage.setItem('globalReferees', JSON.stringify(globalReferees));
                alert(`ÏÉà PIN: ${newPin}`);
                render();
            }
        }
        
        function showAllPins() {
            const globalReferees = JSON.parse(localStorage.getItem('globalReferees') || '[]');
            
            if (globalReferees.length === 0) {
                alert('Îì±Î°ùÎêú Ïã¨ÌåêÏù¥ ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            const pinList = globalReferees.map(r => `${r.name} (${r.role}): ${r.pin}`).join('\n');
            alert(`Ïã¨Ìåê PIN Î™©Î°ù\n\n${pinList}`);
        }
        
        // Ï†ÑÏó≠ Í≤ΩÍ∏∞Ïû• Í¥ÄÎ¶¨
        function addGlobalCourt() {
            const name = document.getElementById('new-court-name')?.value.trim();
            const location = document.getElementById('new-court-location')?.value.trim() || '';
            
            if (!name) {
                alert('Í≤ΩÍ∏∞Ïû• Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const globalCourts = JSON.parse(localStorage.getItem('globalCourts') || '[]');
            
            if (globalCourts.find(c => c.name === name)) {
                alert('Ïù¥ÎØ∏ Îì±Î°ùÎêú Í≤ΩÍ∏∞Ïû•ÏûÖÎãàÎã§.');
                return;
            }
            
            globalCourts.push({ name, location, createdAt: new Date().toISOString() });
            localStorage.setItem('globalCourts', JSON.stringify(globalCourts));
            
            announce(`Í≤ΩÍ∏∞Ïû• "${name}" Îì±Î°ù ÏôÑÎ£å`);
            render();
        }
        
        function deleteGlobalCourt(idx) {
            const globalCourts = JSON.parse(localStorage.getItem('globalCourts') || '[]');
            const court = globalCourts[idx];
            
            if (confirm(`"${court.name}" Í≤ΩÍ∏∞Ïû•ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                globalCourts.splice(idx, 1);
                localStorage.setItem('globalCourts', JSON.stringify(globalCourts));
                announce(`Í≤ΩÍ∏∞Ïû• "${court.name}" ÏÇ≠Ï†úÎê®`);
                render();
            }
        }
        
        // ========== ÎåÄÌöåÎ≥Ñ Í≤ΩÍ∏∞Ïû•/Ïã¨Ìåê Í¥ÄÎ¶¨ ==========
        function addTournamentCourt() {
            if (!currentProject) return;
            
            const name = document.getElementById('tournament-court-name')?.value.trim();
            if (!name) {
                alert('Í≤ΩÍ∏∞Ïû• Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!currentProject.courts) currentProject.courts = [];
            
            if (currentProject.courts.find(c => c.name === name)) {
                alert('Ïù¥ÎØ∏ Îì±Î°ùÎêú Í≤ΩÍ∏∞Ïû•ÏûÖÎãàÎã§.');
                return;
            }
            
            currentProject.courts.push({ name });
            saveProjects();
            announce(`Í≤ΩÍ∏∞Ïû• "${name}" Îì±Î°ù ÏôÑÎ£å`);
            render();
        }
        
        function deleteTournamentCourt(idx) {
            if (!currentProject || !currentProject.courts) return;
            
            const court = currentProject.courts[idx];
            if (confirm(`"${court.name}" Í≤ΩÍ∏∞Ïû•ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                currentProject.courts.splice(idx, 1);
                saveProjects();
                announce(`Í≤ΩÍ∏∞Ïû• ÏÇ≠Ï†úÎê®`);
                render();
            }
        }
        
        function importGlobalCourt() {
            if (!currentProject) return;
            
            const courtName = document.getElementById('import-global-court')?.value;
            if (!courtName) {
                alert('Í≤ΩÍ∏∞Ïû•ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!currentProject.courts) currentProject.courts = [];
            currentProject.courts.push({ name: courtName });
            saveProjects();
            announce(`Í≤ΩÍ∏∞Ïû• "${courtName}" Í∞ÄÏ†∏Ïò§Í∏∞ ÏôÑÎ£å`);
            render();
        }
        
        function addTournamentReferee() {
            if (!currentProject) return;
            
            const name = document.getElementById('tournament-referee-name')?.value.trim();
            const role = document.getElementById('tournament-referee-role')?.value || 'Ïã¨Ìåê';
            
            if (!name) {
                alert('Ïã¨Ìåê Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            if (!currentProject.referees) currentProject.referees = [];
            
            if (currentProject.referees.find(r => r.name === name)) {
                alert('Ïù¥ÎØ∏ Îì±Î°ùÎêú Ïã¨ÌåêÏûÖÎãàÎã§.');
                return;
            }
            
            const pin = Math.random().toString().slice(2, 6);
            currentProject.referees.push({ name, role, pin });
            saveProjects();
            
            alert(`Ïã¨Ìåê "${name}" Îì±Î°ù ÏôÑÎ£å!\nPIN: ${pin}`);
            render();
        }
        
        function deleteTournamentReferee(idx) {
            if (!currentProject || !currentProject.referees) return;
            
            const ref = currentProject.referees[idx];
            if (confirm(`"${ref.name}" Ïã¨ÌåêÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                currentProject.referees.splice(idx, 1);
                saveProjects();
                announce(`Ïã¨Ìåê ÏÇ≠Ï†úÎê®`);
                render();
            }
        }
        
        function importGlobalReferee() {
            if (!currentProject) return;
            
            const refName = document.getElementById('import-global-referee')?.value;
            if (!refName) {
                alert('Ïã¨ÌåêÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const globalReferees = JSON.parse(localStorage.getItem('globalReferees') || '[]');
            const globalRef = globalReferees.find(r => r.name === refName);
            
            if (!globalRef) {
                alert('Ïã¨ÌåêÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            if (!currentProject.referees) currentProject.referees = [];
            currentProject.referees.push({ ...globalRef });
            saveProjects();
            announce(`Ïã¨Ìåê "${refName}" Í∞ÄÏ†∏Ïò§Í∏∞ ÏôÑÎ£å`);
            render();
        }
        
        // Í¥ÄÎ¶¨Ïûê ÎπÑÎ∞ÄÎ≤àÌò∏ Î≥ÄÍ≤Ω
        function changeAdminPassword() {
            const currentPw = prompt('ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            if (currentPw !== localStorage.getItem('bracketPin')) {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                return;
            }
            
            const newPw = prompt('ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            if (!newPw || newPw.length < 4) {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 4Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.');
                return;
            }
            
            const confirmPw = prompt('ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Îã§Ïãú ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            if (newPw !== confirmPw) {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                return;
            }
            
            localStorage.setItem('bracketPin', newPw);
            alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.');
        }
        
        // Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨
        function exportAllData() {
            const data = {
                projects: projects,
                globalReferees: JSON.parse(localStorage.getItem('globalReferees') || '[]'),
                globalCourts: JSON.parse(localStorage.getItem('globalCourts') || '[]'),
                practiceHistory: JSON.parse(localStorage.getItem('practiceHistory') || '[]'),
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `showdown-backup-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            announce('Îç∞Ïù¥ÌÑ∞ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ÏôÑÎ£å');
        }
        
        function importDataPrompt() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (confirm(`Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏ†∏Ïò§ÏãúÍ≤†ÏäµÎãàÍπå?\n\nÌîÑÎ°úÏ†ùÌä∏: ${data.projects?.length || 0}Í∞ú\nÏã¨Ìåê: ${data.globalReferees?.length || 0}Î™Ö\nÍ≤ΩÍ∏∞Ïû•: ${data.globalCourts?.length || 0}Í∞ú`)) {
                            if (data.projects) {
                                projects = data.projects;
                                saveProjects();
                            }
                            if (data.globalReferees) localStorage.setItem('globalReferees', JSON.stringify(data.globalReferees));
                            if (data.globalCourts) localStorage.setItem('globalCourts', JSON.stringify(data.globalCourts));
                            if (data.practiceHistory) localStorage.setItem('practiceHistory', JSON.stringify(data.practiceHistory));
                            
                            alert('Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ ÏôÑÎ£å!');
                            render();
                        }
                    } catch (err) {
                        alert('ÌååÏùº ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function clearAllDataConfirm() {
            if (prompt('Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÌôïÏù∏ÌïòÎ†§Î©¥ "ÏÇ≠Ï†ú"Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:') === 'ÏÇ≠Ï†ú') {
                localStorage.clear();
                projects = [];
                alert('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                location.reload();
            }
        }
        
        // Ïã¨ÌåêÏö© ÌîÑÎ°úÏ†ùÌä∏ Ïó¥Í∏∞
        function openRefereeProject(index) {
            currentProject = projects[index];
            userRole = 'referee';
            goTo('project-detail');
        }
        
        // ========== ÎåÄÏßÑ ÏÑ§Ï†ï Î™®Îìú Ìï®Ïàò ==========
        let bracketModeAuth = false;
        
        function enterBracketMode() {
            const savedPin = localStorage.getItem('bracketPin');
            if (!savedPin) {
                // ÎπÑÎ∞ÄÎ≤àÌò∏ ÎØ∏ÏÑ§Ï†ï - ÏÑ§Ï†ï ÌôîÎ©¥ÏúºÎ°ú
                goTo('bracket-set-password');
            } else {
                // ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûàÏùå - Ïù∏Ï¶ù ÌôîÎ©¥ÏúºÎ°ú
                goTo('bracket-password');
            }
        }
        
        function verifyBracketPin() {
            const input = document.getElementById('bracket-pin')?.value;
            const savedPin = localStorage.getItem('bracketPin');
            
            if (input === savedPin) {
                bracketModeAuth = true;
                announce('ÎåÄÏßÑ ÏÑ§Ï†ï Î™®Îìú ÏßÑÏûÖ');
                goTo('bracket-home');
            } else {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                document.getElementById('bracket-pin').value = '';
                document.getElementById('bracket-pin').focus();
            }
        }
        
        function checkPasswordStrength() {
            const pw = document.getElementById('new-bracket-pin')?.value || '';
            const display = document.getElementById('pw-strength');
            if (!display) return;
            
            const checks = {
                length: pw.length >= 8,
                upper: /[A-Z]/.test(pw),
                lower: /[a-z]/.test(pw),
                number: /[0-9]/.test(pw),
                special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pw)
            };
            
            const passed = Object.values(checks).filter(v => v).length;
            
            let html = '';
            html += `<div style="color:${checks.length ? '#4caf50' : '#999'};">${checks.length ? '‚úÖ' : '‚¨ú'} 8Ïûê Ïù¥ÏÉÅ</div>`;
            html += `<div style="color:${checks.upper ? '#4caf50' : '#999'};">${checks.upper ? '‚úÖ' : '‚¨ú'} ÏòÅÎ¨∏ ÎåÄÎ¨∏Ïûê</div>`;
            html += `<div style="color:${checks.lower ? '#4caf50' : '#999'};">${checks.lower ? '‚úÖ' : '‚¨ú'} ÏòÅÎ¨∏ ÏÜåÎ¨∏Ïûê</div>`;
            html += `<div style="color:${checks.number ? '#4caf50' : '#999'};">${checks.number ? '‚úÖ' : '‚¨ú'} Ïà´Ïûê</div>`;
            html += `<div style="color:${checks.special ? '#4caf50' : '#999'};">${checks.special ? '‚úÖ' : '‚¨ú'} ÌäπÏàòÎ¨∏Ïûê</div>`;
            
            if (passed === 5) {
                html += `<div style="color:#4caf50; font-weight:600; margin-top:8px;">üîí Í∞ïÎ†•Ìïú ÎπÑÎ∞ÄÎ≤àÌò∏!</div>`;
            }
            
            display.innerHTML = html;
        }
        
        function validatePassword(pw) {
            if (pw.length < 8) return 'ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 8Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.';
            if (!/[A-Z]/.test(pw)) return 'ÏòÅÎ¨∏ ÎåÄÎ¨∏ÏûêÎ•º 1Í∞ú Ïù¥ÏÉÅ Ìè¨Ìï®Ìï¥Ïïº Ìï©ÎãàÎã§.';
            if (!/[a-z]/.test(pw)) return 'ÏòÅÎ¨∏ ÏÜåÎ¨∏ÏûêÎ•º 1Í∞ú Ïù¥ÏÉÅ Ìè¨Ìï®Ìï¥Ïïº Ìï©ÎãàÎã§.';
            if (!/[0-9]/.test(pw)) return 'Ïà´ÏûêÎ•º 1Í∞ú Ïù¥ÏÉÅ Ìè¨Ìï®Ìï¥Ïïº Ìï©ÎãàÎã§.';
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(pw)) return 'ÌäπÏàòÎ¨∏ÏûêÎ•º 1Í∞ú Ïù¥ÏÉÅ Ìè¨Ìï®Ìï¥Ïïº Ìï©ÎãàÎã§.';
            return null;
        }
        
        function setBracketPin() {
            const newPin = document.getElementById('new-bracket-pin')?.value;
            const confirmPin = document.getElementById('confirm-bracket-pin')?.value;
            
            const error = validatePassword(newPin);
            if (error) {
                alert(error);
                return;
            }
            
            if (newPin !== confirmPin) {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
                return;
            }
            
            localStorage.setItem('bracketPin', newPin);
            bracketModeAuth = true;
            announce('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏÑ§Ï†ïÎêòÏóàÏäµÎãàÎã§');
            goTo('bracket-home');
        }
        
        // ========== Ïã¨Ìåê ÎπÑÎ∞ÄÎ≤àÌò∏ Ïù∏Ï¶ù ==========
        function verifyRefereePassword() {
            const pin = document.getElementById('referee-pin')?.value;
            const password = document.getElementById('referee-password')?.value;
            const refPasswords = JSON.parse(localStorage.getItem('refereePasswords') || '{}');
            
            if (!pin) {
                alert('Ïã¨ÌåêÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');
                return;
            }
            
            if (!password) {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî');
                return;
            }
            
            if (!refPasswords[pin]) {
                alert('Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ Ïã¨ÌåêÏûÖÎãàÎã§');
                return;
            }
            
            if (refPasswords[pin] !== password) {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§');
                document.getElementById('referee-password').value = '';
                document.getElementById('referee-password').focus();
                return;
            }
            
            // Ïù∏Ï¶ù ÏÑ±Í≥µ
            isAuthenticated = true;
            sessionStorage.setItem('refereePin', pin);
            sessionStorage.setItem('refereeAuth', 'true');
            announce('Ïã¨Ìåê Ïù∏Ï¶ù ÏôÑÎ£å');
            screen = 'referee-home';
            render();
        }
        
        // Ïã¨Ìåê ÎπÑÎ∞ÄÎ≤àÌò∏ Ï∂îÍ∞Ä (Í¥ÄÎ¶¨ÏûêÏö©)
        function addRefereePassword() {
            const pin = prompt('Ïã¨Ìåê PINÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:\n(Ïòà: REF001, Ïã¨Ìåê1)');
            if (!pin) return;
            
            const password = prompt('Ïã¨Ìåê ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî:\n(8Ïûê Ïù¥ÏÉÅ, ÎåÄÏÜåÎ¨∏Ïûê+Ïà´Ïûê+ÌäπÏàòÎ¨∏Ïûê)');
            if (!password) return;
            
            const error = validatePassword(password);
            if (error) {
                alert(error);
                return;
            }
            
            const confirmPassword = prompt('ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Îã§Ïãú ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
            if (confirmPassword !== password) {
                alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§');
                return;
            }
            
            const refPasswords = JSON.parse(localStorage.getItem('refereePasswords') || '{}');
            if (refPasswords[pin]) {
                alert('Ïù¥ÎØ∏ Îì±Î°ùÎêú Ïã¨ÌåêÏûÖÎãàÎã§');
                return;
            }
            
            refPasswords[pin] = password;
            localStorage.setItem('refereePasswords', JSON.stringify(refPasswords));
            announce(`${pin} Ïã¨ÌåêÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§`);
        }
        
        // Ïã¨Ìåê ÎπÑÎ∞ÄÎ≤àÌò∏ ÏÇ≠Ï†ú (Í¥ÄÎ¶¨ÏûêÏö©)
        function deleteRefereePassword() {
            const refPasswords = JSON.parse(localStorage.getItem('refereePasswords') || '{}');
            const pins = Object.keys(refPasswords);
            
            if (pins.length === 0) {
                alert('Îì±Î°ùÎêú Ïã¨ÌåêÏù¥ ÏóÜÏäµÎãàÎã§');
                return;
            }
            
            const pinList = pins.join('\n');
            const pin = prompt(`ÏÇ≠Ï†úÌï† Ïã¨Ìåê PINÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:\n\nÎì±Î°ùÎêú Ïã¨Ìåê:\n${pinList}`);
            
            if (!pin) return;
            
            if (!refPasswords[pin]) {
                alert('Îì±Î°ùÎêòÏßÄ ÏïäÏùÄ Ïã¨ÌåêÏûÖÎãàÎã§');
                return;
            }
            
            if (!confirm(`${pin} Ïã¨ÌåêÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) return;
            
            delete refPasswords[pin];
            localStorage.setItem('refereePasswords', JSON.stringify(refPasswords));
            announce(`${pin} Ïã¨ÌåêÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§`);
        }
        
        // ========== ÏÑ†Ïàò ÏùºÏ†ï Ï°∞Ìöå Ìï®Ïàò ==========
        function onScheduleProjectChange() {
            const select = document.getElementById('schedule-project');
            const area = document.getElementById('participant-select-area');
            const nameSelect = document.getElementById('schedule-name-select');
            const result = document.getElementById('schedule-result');
            
            if (!select.value) {
                area.style.display = 'none';
                result.innerHTML = '';
                return;
            }
            
            const project = projects[parseInt(select.value)];
            if (!project) return;
            
            area.style.display = 'block';
            result.innerHTML = '';
            
            // Ï∞∏Í∞ÄÏûê Î™©Î°ù ÏàòÏßë
            let participants = [];
            if (project.groups && project.groups.length > 0) {
                project.groups.forEach(g => {
                    participants = participants.concat(g.members || []);
                });
            } else if (project.players && project.players.length > 0) {
                participants = project.players;
            } else if (project.teams && project.teams.length > 0) {
                participants = project.teams.map(t => t.name || t);
            }
            
            // Ï§ëÎ≥µ Ï†úÍ±∞
            participants = [...new Set(participants)];
            
            // Ï†ïÎ†¨
            participants.sort((a, b) => a.localeCompare(b, 'ko'));
            
            nameSelect.innerHTML = '<option value="">-- Î™©Î°ùÏóêÏÑú ÏÑ†ÌÉù --</option>' + 
                participants.map(p => `<option value="${p}">${p}</option>`).join('');
        }
        
        function onScheduleNameSelect() {
            const select = document.getElementById('schedule-name-select');
            const input = document.getElementById('schedule-name-input');
            if (select.value) {
                input.value = select.value;
            }
        }
        
        function lookupSchedule() {
            const projectIdx = document.getElementById('schedule-project')?.value;
            const name = document.getElementById('schedule-name-input')?.value.trim() || 
                         document.getElementById('schedule-name-select')?.value;
            
            if (!projectIdx || !name) {
                alert('ÎåÄÌöåÏôÄ Ïù¥Î¶ÑÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const project = projects[parseInt(projectIdx)];
            if (!project) return;
            
            const resultDiv = document.getElementById('schedule-result');
            
            // Ìï¥Îãπ ÏÑ†ÏàòÏùò Í≤ΩÍ∏∞ Ï∞æÍ∏∞
            const myMatches = project.matches.filter(m => 
                m.player1Name === name || m.player2Name === name
            );
            
            if (myMatches.length === 0) {
                resultDiv.innerHTML = `
                    <div style="text-align:center; padding:20px; background:#fff3e0; border-radius:8px;">
                        <span style="font-size:24px;">üîç</span>
                        <p style="margin-top:8px;">"${name}"Ïùò Í≤ΩÍ∏∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                        <p style="font-size:13px; color:#666;">Ïù¥Î¶ÑÏùÑ Ï†ïÌôïÌûà ÏûÖÎ†•ÌñàÎäîÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.</p>
                    </div>
                `;
                return;
            }
            
            // Í≤ΩÍ∏∞ Î∂ÑÎ•ò
            const pending = myMatches.filter(m => m.status !== 'completed');
            const completed = myMatches.filter(m => m.status === 'completed');
            
            // Îã§Ïùå Í≤ΩÍ∏∞ (ÎåÄÍ∏∞ Ï§ëÏù∏ Ï≤´ Î≤àÏß∏ Í≤ΩÍ∏∞)
            const nextMatch = pending[0];
            
            // Ï†ÑÏ†Å Í≥ÑÏÇ∞
            let wins = 0, losses = 0;
            completed.forEach(m => {
                const isP1 = m.player1Name === name;
                const p1Sets = m.setScores.filter(s => s.player1 > s.player2).length;
                const p2Sets = m.setScores.filter(s => s.player2 > s.player1).length;
                if ((isP1 && p1Sets > p2Sets) || (!isP1 && p2Sets > p1Sets)) {
                    wins++;
                } else if (p1Sets !== p2Sets) {
                    losses++;
                }
            });
            
            // ÎÇ¥ Ï°∞ Ï∞æÍ∏∞
            let myGroup = null;
            if (project.groups) {
                project.groups.forEach(g => {
                    if (g.members && g.members.includes(name)) {
                        myGroup = g;
                    }
                });
            }
            
            // ÌÜ†ÎÑàÎ®ºÌä∏ ÎùºÏö¥Îìú Ï†ïÎ≥¥
            const knockoutMatches = project.matches.filter(m => m.bracketRound);
            const maxRound = knockoutMatches.length > 0 ? Math.max(...knockoutMatches.map(m => m.bracketRound)) : 0;
            
            // Í≤∞Í≥º ÌëúÏãú
            let html = `
                <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:16px; border-radius:12px; margin-bottom:16px;">
                    <div style="font-size:24px; font-weight:700;">${name}</div>
                    ${myGroup ? `<div style="opacity:0.9; margin-top:4px;">${myGroup.name}</div>` : ''}
                    <div style="display:flex; gap:16px; margin-top:12px;">
                        <div style="text-align:center;">
                            <div style="font-size:20px; font-weight:600;">${wins}</div>
                            <div style="font-size:12px; opacity:0.8;">Ïäπ</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:20px; font-weight:600;">${losses}</div>
                            <div style="font-size:12px; opacity:0.8;">Ìå®</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:20px; font-weight:600;">${myMatches.length}</div>
                            <div style="font-size:12px; opacity:0.8;">Ï¥ù Í≤ΩÍ∏∞</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Îã§Ïùå Í≤ΩÍ∏∞
            if (nextMatch) {
                const opponent = nextMatch.player1Name === name ? nextMatch.player2Name : nextMatch.player1Name;
                const isTBD = opponent === 'TBD';
                const roundName = nextMatch.bracketRound ? getRoundName(nextMatch.bracketRound, maxRound + 1) : null;
                
                html += `
                    <div style="background:#e3f2fd; padding:16px; border-radius:8px; margin-bottom:16px;">
                        <div style="font-weight:600; margin-bottom:8px;">‚è≠Ô∏è Îã§Ïùå Í≤ΩÍ∏∞</div>
                        <div style="font-size:18px; font-weight:600;">
                            ${isTBD ? 'üîú ÏÉÅÎåÄ ÎØ∏Ï†ï (Ïù¥Ï†Ñ Í≤ΩÍ∏∞ Í≤∞Í≥º ÎåÄÍ∏∞ Ï§ë)' : `vs ${opponent}`}
                        </div>
                        <div style="font-size:13px; color:#666; margin-top:4px;">
                            ${roundName ? `${roundName}` : ''}
                            ${nextMatch.groupName ? nextMatch.groupName : ''}
                        </div>
                    </div>
                `;
            } else if (project.tournamentType === 'group-knockout' && myGroup) {
                // Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏßÑÌñâ Ï§ëÏù¥Î©¥ Î≥∏ÏÑ† ÏßÑÏ∂ú ÏïàÎÇ¥
                const groupMatches = project.matches.filter(m => m.groupIndex !== undefined);
                const completedGroupMatches = groupMatches.filter(m => m.status === 'completed');
                
                if (completedGroupMatches.length < groupMatches.length) {
                    html += `
                        <div style="background:#fff3e0; padding:16px; border-radius:8px; margin-bottom:16px;">
                            <div style="font-weight:600; margin-bottom:8px;">Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏßÑÌñâ Ï§ë</div>
                            <div style="font-size:14px; color:#666;">
                                Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏôÑÎ£å ÌõÑ Î≥∏ÏÑ† ÌÜ†ÎÑàÎ®ºÌä∏Í∞Ä ÏãúÏûëÎê©ÎãàÎã§.
                            </div>
                        </div>
                    `;
                }
            }
            
            // ÎåÄÍ∏∞ Ï§ëÏù∏ Í≤ΩÍ∏∞
            if (pending.length > 0) {
                html += `
                    <div style="margin-bottom:16px;">
                        <h4 style="margin:0 0 8px 0;">‚è≥ ÎåÄÍ∏∞ Ï§ëÏù∏ Í≤ΩÍ∏∞ (${pending.length})</h4>
                        ${pending.map(m => {
                            const opponent = m.player1Name === name ? m.player2Name : m.player1Name;
                            const isTBD = opponent === 'TBD';
                            const roundName = m.bracketRound ? getRoundName(m.bracketRound, maxRound + 1) : null;
                            
                            return `
                                <div style="padding:10px; margin:4px 0; background:#fff3e0; border-radius:6px; display:flex; justify-content:space-between; align-items:center;">
                                    <span>${isTBD ? 'üîú ÏÉÅÎåÄ ÎØ∏Ï†ï' : `vs ${opponent}`}</span>
                                    <span style="font-size:12px; color:#666;">
                                        ${roundName ? `${roundName}` : ''}
                                        ${m.groupName || ''}
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            // ÏôÑÎ£åÎêú Í≤ΩÍ∏∞
            if (completed.length > 0) {
                html += `
                    <div>
                        <h4 style="margin:0 0 8px 0;">ÏôÑÎ£åÎêú Í≤ΩÍ∏∞ (${completed.length})</h4>
                        ${completed.filter(m => !m.isBye).map(m => {
                            const isP1 = m.player1Name === name;
                            const opponent = isP1 ? m.player2Name : m.player1Name;
                            const scores = m.setScores.map(s => isP1 ? `${s.player1}-${s.player2}` : `${s.player2}-${s.player1}`).join(', ');
                            const p1Sets = m.setScores.filter(s => s.player1 > s.player2).length;
                            const p2Sets = m.setScores.filter(s => s.player2 > s.player1).length;
                            const won = (isP1 && p1Sets > p2Sets) || (!isP1 && p2Sets > p1Sets);
                            const roundName = m.bracketRound ? getRoundName(m.bracketRound, maxRound + 1) : null;
                            
                            return `
                                <div style="padding:10px; margin:4px 0; background:${won ? '#e8f5e9' : '#ffebee'}; border-radius:6px;">
                                    <div style="display:flex; justify-content:space-between;">
                                        <span>${won ? 'üèÜ' : ''} vs ${opponent}</span>
                                        <span style="font-weight:600; color:${won ? '#4caf50' : '#f44336'};">${won ? 'Ïäπ' : 'Ìå®'}</span>
                                    </div>
                                    <div style="font-size:12px; color:#666; margin-top:4px;">
                                        ${roundName ? `${roundName} ¬∑ ` : ''}${m.groupName ? `${m.groupName} ¬∑ ` : ''}${scores}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            resultDiv.innerHTML = html;
        }
        // ========== ÏÑ†Ïàò ÏùºÏ†ï Ï°∞Ìöå Ìï®Ïàò ÎÅù ==========
        
        // ========== ÌÜ†ÎÑàÎ®ºÌä∏ ÏßÑÌñâ Ìï®Ïàò ==========
        function processTournamentProgression(match, winner) {
            if (!currentProject) return;
            
            const p = currentProject;
            
            // 1. ÌÜ†ÎÑàÎ®ºÌä∏ Í≤ΩÍ∏∞Ïù∏ Í≤ΩÏö∞ Îã§Ïùå ÎùºÏö¥Îìú Ï≤òÎ¶¨
            if (match.bracketRound) {
                advanceTournamentWinner(p, match, winner);
            }
            
            // 2. Ï°∞Î≥Ñ Î¶¨Í∑∏ Í≤ΩÍ∏∞Ïù∏ Í≤ΩÏö∞ Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏôÑÎ£å Ïó¨Î∂Ä Ï≤¥ÌÅ¨
            if (match.groupIndex !== undefined && p.tournamentType === 'group-knockout') {
                checkGroupStageCompletion(p);
            }
        }
        
        function advanceTournamentWinner(project, match, winner) {
            const currentRound = match.bracketRound;
            const matchNum = match.bracketMatchNum;
            const nextRound = currentRound + 1;
            const nextMatchNum = Math.ceil(matchNum / 2);
            
            // Îã§Ïùå ÎùºÏö¥Îìú Í≤ΩÍ∏∞ Ï∞æÍ∏∞
            let nextMatch = project.matches.find(m => 
                m.bracketRound === nextRound && m.bracketMatchNum === nextMatchNum
            );
            
            // Îã§Ïùå ÎùºÏö¥Îìú Í≤ΩÍ∏∞Í∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±
            if (!nextMatch) {
                // Í≤∞ÏäπÏ†Ñ Ïù¥ÌõÑÎäî Îçî Ïù¥ÏÉÅ Í≤ΩÍ∏∞ ÏóÜÏùå
                const remainingMatches = project.matches.filter(m => 
                    m.bracketRound === currentRound && m.status !== 'completed'
                );
                
                // Í∞ôÏùÄ ÎùºÏö¥ÎìúÏóê Îã§Î•∏ Í≤ΩÍ∏∞Í∞Ä ÎÇ®ÏïÑÏûàÎäîÏßÄ ÌôïÏù∏
                const sameRoundCompleted = project.matches.filter(m => 
                    m.bracketRound === currentRound && m.status === 'completed'
                ).length;
                
                const totalInRound = project.matches.filter(m => m.bracketRound === currentRound).length;
                
                // Í≤∞ÏäπÏ†Ñ(1Í≤ΩÍ∏∞Îßå ÏûàÎäî ÎùºÏö¥Îìú)Ïù¥Î©¥ Ï¢ÖÎ£å
                if (totalInRound === 1) {
                    project.tournamentWinner = winner;
                    announce(`Ïö∞Ïäπ: ${winner}!`);
                    return;
                }
                
                // Îã§Ïùå ÎùºÏö¥Îìú Í≤ΩÍ∏∞ ÏÉùÏÑ±
                nextMatch = {
                    id: Date.now() + nextRound * 100 + nextMatchNum,
                    player1Name: matchNum % 2 === 1 ? winner : 'TBD',
                    player2Name: matchNum % 2 === 0 ? winner : 'TBD',
                    type: project.competitionType,
                    sets: project.competitionType === 'individual' ? 3 : 1,
                    winScore: project.competitionType === 'individual' ? 11 : 31,
                    currentSet: 1,
                    setScores: [{ player1: 0, player2: 0 }],
                    currentServe: 'player1',
                    serveCount: 0,
                    serveSelected: false,
                    timeouts: { player1: 1, player2: 1 },
                    history: [],
                    status: 'pending',
                    bracketRound: nextRound,
                    bracketMatchNum: nextMatchNum,
                    refereePin: generatePin()
                };
                project.matches.push(nextMatch);
            } else {
                // Í∏∞Ï°¥ Îã§Ïùå ÎùºÏö¥Îìú Í≤ΩÍ∏∞Ïóê ÏäπÏûê Î∞∞Ï†ï
                if (matchNum % 2 === 1) {
                    nextMatch.player1Name = winner;
                } else {
                    nextMatch.player2Name = winner;
                }
                
                // Îëê ÏÑ†Ïàò Î™®Îëê Í≤∞Ï†ïÎêòÎ©¥ Í≤ΩÍ∏∞ Ï§ÄÎπÑ ÏôÑÎ£å
                if (nextMatch.player1Name !== 'TBD' && nextMatch.player2Name !== 'TBD') {
                    nextMatch.status = 'ready';
                }
            }
        }
        
        function checkGroupStageCompletion(project) {
            if (!project.groups || project.groups.length === 0) return;
            
            // Ï°∞Î≥Ñ Î¶¨Í∑∏ Í≤ΩÍ∏∞Í∞Ä Î™®Îëê ÏôÑÎ£åÎêòÏóàÎäîÏßÄ ÌôïÏù∏
            const groupMatches = project.matches.filter(m => m.groupIndex !== undefined);
            const completedGroupMatches = groupMatches.filter(m => m.status === 'completed');
            
            if (groupMatches.length === 0 || completedGroupMatches.length < groupMatches.length) {
                return; // ÏïÑÏßÅ Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏßÑÌñâ Ï§ë
            }
            
            // Ïù¥ÎØ∏ Î≥∏ÏÑ† ÏÉùÏÑ±Îê®?
            const knockoutMatches = project.matches.filter(m => m.bracketRound);
            if (knockoutMatches.length > 0) return;
            
            // Ï°∞Î≥Ñ ÏàúÏúÑ Í≥ÑÏÇ∞ Î∞è Î≥∏ÏÑ† ÏßÑÏ∂úÏûê Í≤∞Ï†ï
            const advanceCount = project.groupSettings?.advanceCount || 2;
            const knockoutSize = project.knockoutSettings?.size || 8;
            
            const advancers = [];
            
            project.groups.forEach((group, gIdx) => {
                const standings = calculateGroupStandings(project, gIdx);
                const groupAdvancers = standings.slice(0, advanceCount);
                advancers.push(...groupAdvancers.map((s, rank) => ({
                    name: s.name,
                    group: group.name,
                    rank: rank + 1,
                    seed: gIdx * advanceCount + rank + 1
                })));
            });
            
            // Î≥∏ÏÑ† ÎåÄÏßÑÌëú ÏÉùÏÑ± (ÏãúÎìú Î∞∞Ï†ï)
            generateKnockoutBracket(project, advancers, knockoutSize);
            
            announce(`Ï°∞Î≥Ñ Î¶¨Í∑∏ ÏôÑÎ£å! Î≥∏ÏÑ† ${knockoutSize}Í∞ï ÎåÄÏßÑÌëú ÏÉùÏÑ±`);
        }
        
        function calculateGroupStandings(project, groupIndex) {
            const group = project.groups[groupIndex];
            if (!group) return [];
            
            const records = {};
            group.members.forEach(m => {
                records[m] = { name: m, wins: 0, losses: 0, setsWon: 0, setsLost: 0, pointsFor: 0, pointsAgainst: 0 };
            });
            
            const groupMatches = project.matches.filter(m => 
                m.groupIndex === groupIndex && m.status === 'completed'
            );
            
            groupMatches.forEach(m => {
                const p1 = m.player1Name;
                const p2 = m.player2Name;
                
                if (!records[p1] || !records[p2]) return;
                
                let p1Sets = 0, p2Sets = 0;
                m.setScores.forEach(s => {
                    if (s.player1 > s.player2) p1Sets++;
                    else if (s.player2 > s.player1) p2Sets++;
                    
                    records[p1].pointsFor += s.player1;
                    records[p1].pointsAgainst += s.player2;
                    records[p2].pointsFor += s.player2;
                    records[p2].pointsAgainst += s.player1;
                });
                
                records[p1].setsWon += p1Sets;
                records[p1].setsLost += p2Sets;
                records[p2].setsWon += p2Sets;
                records[p2].setsLost += p1Sets;
                
                if (p1Sets > p2Sets) {
                    records[p1].wins++;
                    records[p2].losses++;
                } else {
                    records[p2].wins++;
                    records[p1].losses++;
                }
            });
            
            // Ï†ïÎ†¨: ÏäπÏàò > ÏÑ∏Ìä∏ÎìùÏã§ > Ï†êÏàòÎìùÏã§
            return Object.values(records).sort((a, b) => {
                if (b.wins !== a.wins) return b.wins - a.wins;
                const aSetDiff = a.setsWon - a.setsLost;
                const bSetDiff = b.setsWon - b.setsLost;
                if (bSetDiff !== aSetDiff) return bSetDiff - aSetDiff;
                const aPointDiff = a.pointsFor - a.pointsAgainst;
                const bPointDiff = b.pointsFor - b.pointsAgainst;
                return bPointDiff - aPointDiff;
            });
        }
        
        function generateKnockoutBracket(project, advancers, size) {
            // ÏãúÎìú Î∞∞Ï†ï (1Î≤à ÏãúÎìú vs ÎßàÏßÄÎßâ ÏãúÎìúÍ∞Ä Í≤∞ÏäπÏóêÏÑú ÎßåÎÇòÎèÑÎ°ù)
            const seededOrder = [];
            
            // Í∏∞Î≥∏ ÏãúÎìú Î∞∞Ïπò (8Í∞ï ÏòàÏãú: 1-8, 4-5, 2-7, 3-6)
            function getSeedOrder(n) {
                if (n === 2) return [1, 2];
                const half = getSeedOrder(n / 2);
                const result = [];
                half.forEach(seed => {
                    result.push(seed);
                    result.push(n + 1 - seed);
                });
                return result;
            }
            
            const seedOrder = getSeedOrder(size);
            
            // ÎåÄÏßÑ ÏÉùÏÑ±
            for (let i = 0; i < size; i += 2) {
                const seed1 = seedOrder[i];
                const seed2 = seedOrder[i + 1];
                
                const p1 = advancers.find(a => a.seed === seed1);
                const p2 = advancers.find(a => a.seed === seed2);
                
                const match = {
                    id: Date.now() + i,
                    player1Name: p1 ? p1.name : 'BYE',
                    player2Name: p2 ? p2.name : 'BYE',
                    type: project.competitionType,
                    sets: project.competitionType === 'individual' ? 3 : 1,
                    winScore: project.competitionType === 'individual' ? 11 : 31,
                    currentSet: 1,
                    setScores: [{ player1: 0, player2: 0 }],
                    currentServe: 'player1',
                    serveCount: 0,
                    serveSelected: false,
                    timeouts: { player1: 1, player2: 1 },
                    history: [],
                    status: 'pending',
                    bracketRound: 1,
                    bracketMatchNum: (i / 2) + 1,
                    refereePin: generatePin()
                };
                
                // BYE Ï≤òÎ¶¨ - ÏÉÅÎåÄÍ∞Ä ÏûêÎèô ÏßÑÏ∂ú
                if (p1 && !p2) {
                    match.status = 'completed';
                    match.winner = p1.name;
                    match.setScores = [{ player1: 0, player2: 0 }];
                    match.isBye = true;
                } else if (p2 && !p1) {
                    match.status = 'completed';
                    match.winner = p2.name;
                    match.setScores = [{ player1: 0, player2: 0 }];
                    match.isBye = true;
                }
                
                project.matches.push(match);
                
                // BYE ÏäπÏûêÎäî Î∞îÎ°ú Îã§Ïùå ÎùºÏö¥ÎìúÎ°ú ÏßÑÏ∂ú
                if (match.isBye && match.winner) {
                    advanceTournamentWinner(project, match, match.winner);
                }
            }
        }
        
        function getRoundName(round, totalRounds) {
            const roundsFromFinal = totalRounds - round;
            switch(roundsFromFinal) {
                case 0: return 'Í≤∞Ïäπ';
                case 1: return 'Ï§ÄÍ≤∞Ïäπ';
                case 2: return '8Í∞ï';
                case 3: return '16Í∞ï';
                case 4: return '32Í∞ï';
                default: return `${round}ÎùºÏö¥Îìú`;
            }
        }
        // ========== ÌÜ†ÎÑàÎ®ºÌä∏ ÏßÑÌñâ Ìï®Ïàò ÎÅù ==========
        
        function openBracketProject(index) {
            currentProject = projects[index];
            goTo('bracket-detail');
        }
        
        function editTournamentInfo() {
            const p = currentProject;
            if (!p) return;
            
            const newName = prompt('ÎåÄÌöåÎ™Ö:', p.name);
            if (newName && newName.trim()) {
                p.name = newName.trim();
            }
            
            const newDate = prompt('ÎÇ†Ïßú (YYYY-MM-DD):', p.date || '');
            if (newDate !== null) {
                p.date = newDate;
            }
            
            const newLocation = prompt('Ïû•ÏÜå:', p.location || '');
            if (newLocation !== null) {
                p.location = newLocation;
            }
            
            saveProjects();
            render();
        }
        
        function editGroup(groupIndex) {
            const p = currentProject;
            if (!p || !p.groups[groupIndex]) return;
            
            const group = p.groups[groupIndex];
            const currentMembers = group.members.join(', ');
            const newMembers = prompt(`${group.name} Î©§Î≤Ñ (ÏâºÌëúÎ°ú Íµ¨Î∂Ñ):`, currentMembers);
            
            if (newMembers !== null) {
                const members = newMembers.split(',').map(m => m.trim()).filter(m => m);
                if (members.length > 0) {
                    group.members = members;
                    
                    // Ìï¥Îãπ Ï°∞ Í≤ΩÍ∏∞ Ïû¨ÏÉùÏÑ±
                    p.matches = p.matches.filter(m => m.groupIndex !== groupIndex);
                    
                    for (let i = 0; i < members.length; i++) {
                        for (let j = i + 1; j < members.length; j++) {
                            const match = {
                                id: Date.now() + groupIndex * 1000 + i * 100 + j,
                                player1Name: members[i],
                                player2Name: members[j],
                                type: p.competitionType,
                                sets: p.competitionType === 'individual' ? 3 : 1,
                                winScore: p.competitionType === 'individual' ? 11 : 31,
                                currentSet: 1,
                                setScores: [{ player1: 0, player2: 0 }],
                                currentServe: 'player1',
                                serveCount: 0,
                                serveSelected: false,
                                timeouts: { player1: 1, player2: 1 },
                                history: [],
                                status: 'pending',
                                groupIndex: groupIndex,
                                groupName: group.name,
                                refereePin: generatePin()
                            };
                            p.matches.push(match);
                            if (!group.matches) group.matches = [];
                            group.matches.push(match.id);
                        }
                    }
                    
                    saveProjects();
                    announce(`${group.name} ÏàòÏ†ï ÏôÑÎ£å`);
                    render();
                }
            }
        }
        
        // ÎåÄÏßÑÌëúÏóêÏÑú Í≤ΩÍ∏∞ ÏãúÏûë
        function startMatchFromBracket(matchId) {
            const p = currentProject;
            if (!p) return;
            
            const match = p.matches.find(m => m.id === matchId);
            if (!match) {
                alert('Í≤ΩÍ∏∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            // PIN ÌôïÏù∏
            if (match.refereePin) {
                const inputPin = prompt('Ïã¨Ìåê PINÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:');
                if (inputPin !== match.refereePin) {
                    alert('PINÏù¥ ÌãÄÎ†∏ÏäµÎãàÎã§.');
                    return;
                }
            }
            
            // Í≤ΩÍ∏∞ ÏÉÅÌÉú Î≥ÄÍ≤Ω
            match.status = 'in-progress';
            saveProjects();
            
            // Í≤ΩÍ∏∞ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
            currentMatch = match;
            isAuthenticated = true;
            screen = 'match';
            announce(`${match.player1Name} ÎåÄ ${match.player2Name} Í≤ΩÍ∏∞Î•º ÏãúÏûëÌï©ÎãàÎã§.`);
            render();
        }
        
        function editMatch(matchId) {
            const p = currentProject;
            if (!p) return;
            
            const match = p.matches.find(m => m.id === matchId);
            if (!match) return;
            
            const newP1 = prompt('ÏÑ†Ïàò1 Ïù¥Î¶Ñ:', match.player1Name);
            if (newP1 && newP1.trim()) {
                match.player1Name = newP1.trim();
            }
            
            const newP2 = prompt('ÏÑ†Ïàò2 Ïù¥Î¶Ñ:', match.player2Name);
            if (newP2 && newP2.trim()) {
                match.player2Name = newP2.trim();
            }
            
            saveProjects();
            render();
        }
        
        function shuffleGroups() {
            const p = currentProject;
            if (!p || !p.groups || p.groups.length === 0) return;
            
            if (!confirm('Ï°∞Î•º Îã§Ïãú ÏÑûÏúºÏãúÍ≤†ÏäµÎãàÍπå? ÏßÑÌñâÎêú Í≤ΩÍ∏∞ Í∏∞Î°ùÏù¥ Ï¥àÍ∏∞ÌôîÎê©ÎãàÎã§.')) return;
            
            // Î™®Îì† Î©§Î≤Ñ ÏàòÏßë
            const allMembers = [];
            p.groups.forEach(g => allMembers.push(...g.members));
            
            // ÏÑûÍ∏∞
            for (let i = allMembers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allMembers[i], allMembers[j]] = [allMembers[j], allMembers[i]];
            }
            
            // Îã§Ïãú Î∞∞Ï†ï
            const groupCount = p.groups.length;
            p.groups.forEach((g, idx) => {
                g.members = [];
                g.matches = [];
            });
            
            allMembers.forEach((member, idx) => {
                const round = Math.floor(idx / groupCount);
                const groupIdx = round % 2 === 0 ? idx % groupCount : groupCount - 1 - (idx % groupCount);
                p.groups[groupIdx].members.push(member);
            });
            
            // Í≤ΩÍ∏∞ Ïû¨ÏÉùÏÑ±
            p.matches = [];
            p.groups.forEach((group, gIdx) => {
                const members = group.members;
                for (let i = 0; i < members.length; i++) {
                    for (let j = i + 1; j < members.length; j++) {
                        const match = {
                            id: Date.now() + gIdx * 1000 + i * 100 + j,
                            player1Name: members[i],
                            player2Name: members[j],
                            type: p.competitionType,
                            sets: p.competitionType === 'individual' ? 3 : 1,
                            winScore: p.competitionType === 'individual' ? 11 : 31,
                            currentSet: 1,
                            setScores: [{ player1: 0, player2: 0 }],
                            currentServe: 'player1',
                            serveCount: 0,
                            serveSelected: false,
                            timeouts: { player1: 1, player2: 1 },
                            history: [],
                            status: 'pending',
                            groupIndex: gIdx,
                            groupName: group.name,
                            refereePin: generatePin()
                        };
                        p.matches.push(match);
                        group.matches.push(match.id);
                    }
                }
            });
            
            saveProjects();
            announce('Ï°∞Í∞Ä Îã§Ïãú Ìé∏ÏÑ±ÎêòÏóàÏäµÎãàÎã§');
            render();
        }
        
        function deleteTournament() {
            if (!currentProject) return;
            
            if (!confirm(`"${currentProject.name}" ÎåÄÌöåÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\nÎ™®Îì† Í≤ΩÍ∏∞ Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎê©ÎãàÎã§.`)) return;
            
            const idx = projects.indexOf(currentProject);
            if (idx > -1) {
                projects.splice(idx, 1);
                saveProjects();
                currentProject = null;
                announce('ÎåÄÌöåÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
                goTo('bracket-home');
            }
        }
        // ========== ÎåÄÏßÑ ÏÑ§Ï†ï Î™®Îìú Ìï®Ïàò ÎÅù ==========
        
        // ========== ÎåÄÌöå ÎåÄÏßÑ ÏúÑÏûêÎìú Ìï®Ïàò ÎÅù ==========

        function startTimeout(player) {
            if (currentMatch.timeouts[player] === 0 || isTimeoutActive) return;
            
            // Ïù∏Ï¶ù ÌôïÏù∏
            if (!isAuthenticated) {
                alert('Ïã¨ÌåêÎßå ÌÉÄÏûÑÏïÑÏõÉÏùÑ ÏãúÏûëÌï† Ïàò ÏûàÏäµÎãàÎã§');
                return;
            }
            
            isTimeoutActive = true;
            currentMatch.timeouts[player]--;
            saveProjects();
            
            const playerName = player === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            document.getElementById('timeout-title').textContent = `${playerName} ÌÉÄÏûÑÏïÑÏõÉ`;
            document.getElementById('timeout-modal').classList.add('active');
            
            timeoutSeconds = 60;
            updateTimerDisplay();
            speak(`${playerName} ÌÉÄÏûÑÏïÑÏõÉ ÏãúÏûë. 60Ï¥à`);
            announce(`${playerName} ÌÉÄÏûÑÏïÑÏõÉ ÏãúÏûë. ÎÇ®ÏùÄ ÌöüÏàò ${currentMatch.timeouts[player]}`);
            
            timeoutTimer = setInterval(() => {
                timeoutSeconds--;
                updateTimerDisplay();
                
                if (timeoutSeconds === 15) {
                    speak('15Ï¥à ÎÇ®Ïùå');
                    announce('15Ï¥à ÎÇ®Ïùå');
                    document.getElementById('timer-display').classList.add('warning');
                } else if (timeoutSeconds === 0) {
                    speak('ÌÉÄÏûÑÏïÑÏõÉ Ï¢ÖÎ£å');
                    announce('ÌÉÄÏûÑÏïÑÏõÉ Ï¢ÖÎ£å');
                    closeTimeout();
                }
            }, 1000);
            
            renderMatch();
        }

        function startSideChange() {
            if (isTimeoutActive) return;
            
            isTimeoutActive = true;
            document.getElementById('timeout-title').textContent = 'ÏÇ¨Ïù¥Îìú Ï≤¥Ïù∏ÏßÄ (1Î∂Ñ Ìú¥Ïãù)';
            document.getElementById('timeout-modal').classList.add('active');
            
            timeoutSeconds = 60;
            updateTimerDisplay();
            speak('ÏÇ¨Ïù¥Îìú Ï≤¥Ïù∏ÏßÄ. 1Î∂Ñ Ìú¥Ïãù ÏãúÏûë');
            announce('ÏÇ¨Ïù¥Îìú Ï≤¥Ïù∏ÏßÄ. 1Î∂Ñ Ìú¥Ïãù');
            
            timeoutTimer = setInterval(() => {
                timeoutSeconds--;
                updateTimerDisplay();
                
                if (timeoutSeconds === 15) {
                    speak('15Ï¥à ÎÇ®Ïùå');
                    announce('15Ï¥à ÎÇ®Ïùå');
                    document.getElementById('timer-display').classList.add('warning');
                } else if (timeoutSeconds === 0) {
                    speak('Ìú¥Ïãù Ï¢ÖÎ£å');
                    announce('Ìú¥Ïãù Ï¢ÖÎ£å');
                    closeTimeout();
                }
            }, 1000);
            
            renderMatch();
        }

        function updateTimerDisplay() {
            document.getElementById('timer-display').textContent = timeoutSeconds;
        }

        function closeTimeout() {
            clearInterval(timeoutTimer);
            document.getElementById('timeout-modal').classList.remove('active');
            document.getElementById('timer-display').classList.remove('warning');
            timeoutSeconds = 60;
            isTimeoutActive = false;
            renderMatch();
        }

        function deleteMatch(event, index) {
            event.stopPropagation();
            const match = currentProject.matches[index];
            const matchName = `${match.player1Name} vs ${match.player2Name}`;
            
            if (confirm(`Í≤ΩÍ∏∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n${matchName}\nÏÑ∏Ìä∏ ${match.currentSet}/${match.sets}`)) {
                currentProject.matches.splice(index, 1);
                saveProjects();
                render();
            }
        }

        function deleteProject(index) {
            const project = projects[index];
            
            if (confirm(`ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n${project.name}\nÍ≤ΩÍ∏∞ ${project.matches?.length || 0}Í∞ú Ìè¨Ìï®`)) {
                // FirebaseÏóêÏÑú ÏÇ≠Ï†ú
                if (database && project.firebaseKey) {
                    database.ref('projects/' + project.firebaseKey).remove();
                } else {
                    // Î°úÏª¨ÏóêÏÑú ÏÇ≠Ï†ú
                    projects.splice(index, 1);
                    localStorage.setItem('projects', JSON.stringify(projects));
                }
                render();
            }
        }

        function deleteMatchDirect(index) {
            const match = currentProject.matches[index];
            const matchName = `${match.player1Name} vs ${match.player2Name}`;
            
            if (confirm(`Í≤ΩÍ∏∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n${matchName}`)) {
                currentProject.matches.splice(index, 1);
                saveProjects();
                render();
            }
        }
        
        // ========== Í≤ΩÍ∏∞ Ìé∏Ïßë - Ïã¨Ìåê/Í≤ΩÍ∏∞Ïû• Ïã§ÏãúÍ∞Ñ Î∞∞Ï†ï ==========
        
        function updateMatchReferee(matchIdx) {
            const match = currentProject.matches[matchIdx];
            const refereeSelect = document.getElementById(`ref-${matchIdx}`);
            const refereeName = refereeSelect.value;
            
            if (!refereeName) {
                match.mainRefereeName = null;
                match.refereePin = null;
                announce(`Ïã¨Ìåê Î∞∞Ï†ï Ï†úÍ±∞Îê®`);
            } else {
                const referee = currentProject.referees.find(r => r.name === refereeName);
                match.mainRefereeName = refereeName;
                match.refereePin = referee?.pin; // PINÎèÑ Ï†ÄÏû•
                announce(`Ïã¨Ìåê Î∞∞Ï†ï: ${refereeName}`);
            }
            
            saveProjects(); // Ï¶âÏãú Ï†ÄÏû•
            render(); // ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
        }
        
        function updateMatchCourt(matchIdx) {
            const match = currentProject.matches[matchIdx];
            const courtSelect = document.getElementById(`court-${matchIdx}`);
            const courtName = courtSelect.value;
            
            if (!courtName) {
                match.courtName = null;
                announce(`Í≤ΩÍ∏∞Ïû• Î∞∞Ï†ï Ï†úÍ±∞Îê®`);
            } else {
                match.courtName = courtName;
                announce(`Í≤ΩÍ∏∞Ïû• Î∞∞Ï†ï: ${courtName}`);
            }
            
            saveProjects(); // Ï¶âÏãú Ï†ÄÏû•
            render(); // ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
        }
        
        // Í≤ΩÍ∏∞Ïû• Î∞∞Ï†ï Î™®Îìú ÏÑ§Ï†ï
        function setCourtAssignMode(mode) {
            if (!currentProject) return;
            currentProject.courtAssignMode = mode;
            saveProjects();
            render();
        }
        
        // Í≥†Ï†ï Í≤ΩÍ∏∞Ïû• ÏÑ§Ï†ï
        function setFixedCourt(courtName) {
            if (!currentProject) return;
            currentProject.fixedCourt = courtName;
            saveProjects();
            render();
        }
        
        // Î™®Îì† Í≤ΩÍ∏∞Ïóê Í≥†Ï†ï Í≤ΩÍ∏∞Ïû• Ï†ÅÏö©
        function applyFixedCourt() {
            if (!currentProject || !currentProject.fixedCourt) return;
            const courtName = currentProject.fixedCourt;
            
            currentProject.matches.forEach(m => {
                m.courtName = courtName;
            });
            
            saveProjects();
            announce(`Î™®Îì† Í≤ΩÍ∏∞Î•º "${courtName}"Ïóê Î∞∞Ï†ïÌñàÏäµÎãàÎã§`);
            render();
        }
        
        // Í≤ΩÍ∏∞Ïû• ÏûêÎèô ÏàúÌôò Î∞∞Ï†ï
        function applyRotateCourt() {
            if (!currentProject || !currentProject.courts || currentProject.courts.length === 0) return;
            
            const courts = currentProject.courts;
            currentProject.matches.forEach((m, idx) => {
                m.courtName = courts[idx % courts.length].name;
            });
            
            saveProjects();
            announce(`${courts.length}Í∞ú Í≤ΩÍ∏∞Ïû•Ïóê ÏàúÌôò Î∞∞Ï†ï ÏôÑÎ£å`);
            render();
        }
        
        // ========== Í≤ΩÍ∏∞ Ïä§ÏºÄÏ§Ñ Í¥ÄÎ¶¨ Ìï®Ïàò ==========
        
        // Í≤ΩÍ∏∞ Ïä§ÏºÄÏ§Ñ ÏóÖÎç∞Ïù¥Ìä∏ (ÎÇ†Ïßú, ÏãúÍ∞Ñ, ÏÜåÏöîÏãúÍ∞Ñ)
        function updateMatchSchedule(matchIdx, field, value) {
            if (!currentProject || !currentProject.matches[matchIdx]) return;
            
            const match = currentProject.matches[matchIdx];
            
            switch(field) {
                case 'date':
                    match.scheduledDate = value;
                    announce(`Í≤ΩÍ∏∞ ÎÇ†Ïßú ÏÑ§Ï†ï: ${value}`);
                    break;
                case 'time':
                    match.scheduledTime = value;
                    announce(`Í≤ΩÍ∏∞ ÏãúÍ∞Ñ ÏÑ§Ï†ï: ${value}`);
                    break;
                case 'duration':
                    match.estimatedDuration = parseInt(value);
                    announce(`ÏòàÏÉÅ ÏÜåÏöîÏãúÍ∞Ñ ÏÑ§Ï†ï: ${value}Î∂Ñ`);
                    break;
            }
            
            saveProjects();
        }
        
        // Îã§Ïùå Í≤ΩÍ∏∞Ïóê Ïó∞ÏÜç Ïä§ÏºÄÏ§Ñ Î∞∞Ï†ï
        function copyScheduleToNext(matchIdx) {
            if (!currentProject || !currentProject.matches[matchIdx]) return;
            
            const currentMatch = currentProject.matches[matchIdx];
            const nextMatch = currentProject.matches[matchIdx + 1];
            
            if (!nextMatch) {
                alert('Îã§Ïùå Í≤ΩÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }
            
            if (!currentMatch.scheduledDate || !currentMatch.scheduledTime) {
                alert('ÌòÑÏû¨ Í≤ΩÍ∏∞Ïùò ÎÇ†ÏßúÏôÄ ÏãúÍ∞ÑÏùÑ Î®ºÏ†Ä ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // ÌòÑÏû¨ Í≤ΩÍ∏∞ ÏãúÍ∞Ñ + ÏÜåÏöîÏãúÍ∞ÑÏúºÎ°ú Îã§Ïùå Í≤ΩÍ∏∞ ÏãúÍ∞Ñ Í≥ÑÏÇ∞
            const currentDateTime = new Date(`${currentMatch.scheduledDate}T${currentMatch.scheduledTime}`);
            const nextDateTime = new Date(currentDateTime.getTime() + (currentMatch.estimatedDuration * 60000));
            
            // Îã§Ïùå Í≤ΩÍ∏∞Ïóê ÏÑ§Ï†ï
            nextMatch.scheduledDate = nextDateTime.toISOString().split('T')[0];
            nextMatch.scheduledTime = nextDateTime.toTimeString().slice(0, 5);
            nextMatch.courtName = currentMatch.courtName; // Í≤ΩÍ∏∞Ïû•ÎèÑ Î≥µÏÇ¨
            nextMatch.estimatedDuration = currentMatch.estimatedDuration; // ÏÜåÏöîÏãúÍ∞ÑÎèÑ Î≥µÏÇ¨
            
            saveProjects();
            announce(`Îã§Ïùå Í≤ΩÍ∏∞Ïóê Ïó∞ÏÜç Ïä§ÏºÄÏ§Ñ Î∞∞Ï†ïÎê®: ${nextMatch.scheduledDate} ${nextMatch.scheduledTime}`);
            render();
        }
        
        // Ï†ÑÏ≤¥ Ïä§ÏºÄÏ§Ñ ÏûêÎèô ÏÉùÏÑ±
        function generateAutoSchedule() {
            if (!currentProject || !currentProject.matches.length) return;
            
            const startDate = prompt('ÏãúÏûë ÎÇ†ÏßúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
            if (!startDate) return;
            
            const startTime = prompt('ÏãúÏûë ÏãúÍ∞ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (HH:MM):', '09:00');
            if (!startTime) return;
            
            const intervalMinutes = parseInt(prompt('Í≤ΩÍ∏∞ Í∞ÑÍ≤©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Î∂Ñ):', '45'));
            if (isNaN(intervalMinutes)) return;
            
            let currentDateTime = new Date(`${startDate}T${startTime}`);
            
            currentProject.matches.forEach((match, idx) => {
                match.scheduledDate = currentDateTime.toISOString().split('T')[0];
                match.scheduledTime = currentDateTime.toTimeString().slice(0, 5);
                match.estimatedDuration = intervalMinutes - 15; // 15Î∂Ñ Ïó¨Ïú†ÏãúÍ∞Ñ
                match.matchOrder = idx + 1;
                
                // Îã§Ïùå Í≤ΩÍ∏∞ ÏãúÍ∞Ñ Í≥ÑÏÇ∞
                currentDateTime = new Date(currentDateTime.getTime() + (intervalMinutes * 60000));
            });
            
            saveProjects();
            announce(`Ï†ÑÏ≤¥ Ïä§ÏºÄÏ§ÑÏù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§ (${currentProject.matches.length}Í≤ΩÍ∏∞)`);
            render();
        }
        
        // ========== Ïä§ÏºÄÏ§Ñ Í≤ÄÏÉâ Ìï®ÏàòÎì§ ==========
        
        // Í∏∞Ï°¥ Í≤ΩÍ∏∞ Îç∞Ïù¥ÌÑ∞Ïóê Ïä§ÏºÄÏ§Ñ ÌïÑÎìú Ï∂îÍ∞Ä (Ìò∏ÌôòÏÑ±)
        function initializeScheduleFields() {
            projects.forEach(project => {
                if (!project.matches) return;
                
                project.matches.forEach(match => {
                    // Ïä§ÏºÄÏ§Ñ ÌïÑÎìúÍ∞Ä ÏóÜÎäî Í∏∞Ï°¥ Í≤ΩÍ∏∞Ïóê Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                    if (match.scheduledDate === undefined) match.scheduledDate = null;
                    if (match.scheduledTime === undefined) match.scheduledTime = null;
                    if (match.estimatedDuration === undefined) match.estimatedDuration = 30;
                    if (match.courtName === undefined) match.courtName = '';
                    if (match.mainRefereeName === undefined) match.mainRefereeName = '';
                    if (match.round === undefined) match.round = '';
                    if (match.matchOrder === undefined) match.matchOrder = 0;
                });
            });
            saveProjects();
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïä§ÏºÄÏ§Ñ ÌïÑÎìú Ï¥àÍ∏∞Ìôî
        setTimeout(() => {
            initializeScheduleFields();
        }, 2000);
        
        // Ï∞∏Í∞ÄÏûê Ïä§ÏºÄÏ§Ñ Í≤ÄÏÉâ
        function searchPlayerSchedule() {
            const playerName = document.getElementById('player-name-search')?.value.trim();
            if (!playerName) {
                alert('ÏÑ†Ïàò Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const resultsDiv = document.getElementById('player-schedule-results');
            if (!resultsDiv) return;
            
            // Î™®Îì† ÌîÑÎ°úÏ†ùÌä∏ÏóêÏÑú Ìï¥Îãπ ÏÑ†ÏàòÏùò Í≤ΩÍ∏∞ Ï∞æÍ∏∞
            const playerMatches = [];
            projects.forEach(project => {
                if (!project.matches) return;
                
                project.matches.forEach(match => {
                    if (match.player1Name?.includes(playerName) || match.player2Name?.includes(playerName)) {
                        playerMatches.push({
                            ...match,
                            projectName: project.name,
                            projectDate: project.date
                        });
                    }
                });
            });
            
            if (playerMatches.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="background:#fff3e0; padding:16px; border-radius:8px; margin-top:16px; border-left:4px solid #ff9800;">
                        <p style="margin:0; text-align:center;">"${playerName}"ÎãòÏùò Í≤ΩÍ∏∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                    </div>
                `;
                return;
            }
            
            // ÎÇ†ÏßúÏôÄ ÏãúÍ∞Ñ Í∏∞Ï§ÄÏúºÎ°ú Ï†ïÎ†¨
            playerMatches.sort((a, b) => {
                if (a.scheduledDate && b.scheduledDate) {
                    const aDateTime = new Date(`${a.scheduledDate}T${a.scheduledTime || '00:00'}`);
                    const bDateTime = new Date(`${b.scheduledDate}T${b.scheduledTime || '00:00'}`);
                    return aDateTime - bDateTime;
                }
                return a.projectName.localeCompare(b.projectName);
            });
            
            const matchesHTML = playerMatches.map(match => {
                const isPlayer1 = match.player1Name?.includes(playerName);
                const opponent = isPlayer1 ? match.player2Name : match.player1Name;
                const scheduledInfo = match.scheduledDate && match.scheduledTime ? 
                    `üïê ${match.scheduledDate} ${match.scheduledTime}` : 
                    'üïê ÏãúÍ∞Ñ ÎØ∏Ï†ï';
                
                const statusInfo = match.status === 'completed' ? '‚úÖ Í≤ΩÍ∏∞ ÏôÑÎ£å' : 
                                 match.status === 'in-progress' ? '‚è≥ ÏßÑÌñâÏ§ë' : 
                                 '‚≠ï Í≤ΩÍ∏∞ ÏòàÏ†ï';
                
                return `
                    <div style="background:white; border:1px solid #ddd; border-radius:8px; padding:16px; margin-bottom:12px;">
                        <div style="margin-bottom:8px;">
                            <h4 style="margin:0 0 4px 0; color:#1976d2;">
                                ${match.player1Name} vs ${match.player2Name}
                            </h4>
                            <div style="font-size:13px; color:#666;">
                                ${match.projectName} ${match.projectDate ? `¬∑ ${match.projectDate}` : ''}
                            </div>
                        </div>
                        
                        <div style="background:#f8f9fa; padding:12px; border-radius:6px; font-size:14px;">
                            <div style="margin-bottom:6px;">
                                <strong>üìù ÏÉÅÎåÄ:</strong> ${opponent}
                            </div>
                            <div style="margin-bottom:6px;">
                                ${scheduledInfo}
                            </div>
                            <div style="margin-bottom:6px;">
                                <strong>üèüÔ∏è Í≤ΩÍ∏∞Ïû•:</strong> ${match.courtName || 'ÎØ∏Ï†ï'}
                            </div>
                            <div style="margin-bottom:6px;">
                                <strong>üë®‚Äç‚öñÔ∏è Ïã¨Ìåê:</strong> ${match.mainRefereeName || 'ÎØ∏Ï†ï'}
                            </div>
                            <div>
                                <strong>üìä ÏÉÅÌÉú:</strong> ${statusInfo}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsDiv.innerHTML = `
                <div style="margin-top:20px;">
                    <h3>üìã "${playerName}"ÎãòÏùò Í≤ΩÍ∏∞ ÏùºÏ†ï (${playerMatches.length}Í≤ΩÍ∏∞)</h3>
                    <div style="max-height:500px; overflow-y:auto;">
                        ${matchesHTML}
                    </div>
                </div>
            `;
        }
        
        // Ïã¨Ìåê Ïä§ÏºÄÏ§Ñ Í≤ÄÏÉâ
        function searchRefereeSchedule() {
            const refereeName = document.getElementById('referee-name-search')?.value.trim();
            if (!refereeName) {
                alert('Ïã¨Ìåê Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.');
                return;
            }
            
            const resultsDiv = document.getElementById('referee-schedule-results');
            if (!resultsDiv) return;
            
            // Î™®Îì† ÌîÑÎ°úÏ†ùÌä∏ÏóêÏÑú Ìï¥Îãπ Ïã¨ÌåêÏùò Í≤ΩÍ∏∞ Ï∞æÍ∏∞
            const refereeMatches = [];
            projects.forEach(project => {
                if (!project.matches) return;
                
                project.matches.forEach(match => {
                    if (match.mainRefereeName?.includes(refereeName)) {
                        refereeMatches.push({
                            ...match,
                            projectName: project.name,
                            projectDate: project.date
                        });
                    }
                });
            });
            
            if (refereeMatches.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="background:#fff3e0; padding:16px; border-radius:8px; margin-top:16px; border-left:4px solid #ff9800;">
                        <p style="margin:0; text-align:center;">"${refereeName}" Ïã¨ÌåêÎãòÏùò Î∞∞Ï†ïÎêú Í≤ΩÍ∏∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                    </div>
                `;
                return;
            }
            
            // ÎÇ†ÏßúÏôÄ ÏãúÍ∞Ñ Í∏∞Ï§ÄÏúºÎ°ú Ï†ïÎ†¨
            refereeMatches.sort((a, b) => {
                if (a.scheduledDate && b.scheduledDate) {
                    const aDateTime = new Date(`${a.scheduledDate}T${a.scheduledTime || '00:00'}`);
                    const bDateTime = new Date(`${b.scheduledDate}T${b.scheduledTime || '00:00'}`);
                    return aDateTime - bDateTime;
                }
                return a.projectName.localeCompare(b.projectName);
            });
            
            const matchesHTML = refereeMatches.map(match => {
                const scheduledInfo = match.scheduledDate && match.scheduledTime ? 
                    `üïê ${match.scheduledDate} ${match.scheduledTime}` : 
                    'üïê ÏãúÍ∞Ñ ÎØ∏Ï†ï';
                
                const endTime = match.scheduledDate && match.scheduledTime ? 
                    (() => {
                        const end = new Date(`${match.scheduledDate}T${match.scheduledTime}`);
                        end.setMinutes(end.getMinutes() + (match.estimatedDuration || 30));
                        return ` ~ ${end.toTimeString().slice(0, 5)}`;
                    })() : '';
                
                const statusInfo = match.status === 'completed' ? '‚úÖ Ïã¨Ìåê ÏôÑÎ£å' : 
                                 match.status === 'in-progress' ? '‚è≥ Ïã¨Ìåê ÏßÑÌñâÏ§ë' : 
                                 '‚≠ï Ïã¨Ìåê ÎåÄÍ∏∞';
                
                return `
                    <div style="background:white; border:1px solid #ddd; border-radius:8px; padding:16px; margin-bottom:12px;">
                        <div style="margin-bottom:8px;">
                            <h4 style="margin:0 0 4px 0; color:#9c27b0;">
                                ${match.player1Name} vs ${match.player2Name}
                            </h4>
                            <div style="font-size:13px; color:#666;">
                                ${match.projectName} ${match.projectDate ? `¬∑ ${match.projectDate}` : ''}
                            </div>
                        </div>
                        
                        <div style="background:#f8f9fa; padding:12px; border-radius:6px; font-size:14px;">
                            <div style="margin-bottom:6px;">
                                ${scheduledInfo}${endTime} ${match.estimatedDuration ? `(${match.estimatedDuration}Î∂Ñ)` : ''}
                            </div>
                            <div style="margin-bottom:6px;">
                                <strong>üèüÔ∏è Í≤ΩÍ∏∞Ïû•:</strong> ${match.courtName || 'ÎØ∏Ï†ï'}
                            </div>
                            <div style="margin-bottom:6px;">
                                <strong>üîë PIN:</strong> ${match.refereePin || 'ÎØ∏ÏÑ§Ï†ï'}
                            </div>
                            <div>
                                <strong>üìä ÏÉÅÌÉú:</strong> ${statusInfo}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsDiv.innerHTML = `
                <div style="margin-top:20px;">
                    <h3>üë®‚Äç‚öñÔ∏è "${refereeName}" Ïã¨ÌåêÎãòÏùò Î∞∞Ï†ï Í≤ΩÍ∏∞ (${refereeMatches.length}Í≤ΩÍ∏∞)</h3>
                    <div style="max-height:500px; overflow-y:auto;">
                        ${matchesHTML}
                    </div>
                </div>
            `;
        }

        // Í≤ΩÍ∏∞ Í∏∞Î°ù ÏàúÏÑú ÌÜ†Í∏Ä
        let historyOrderDesc = true; // true: ÏµúÏã†Ïàú, false: Ïò§ÎûòÎêúÏàú
        let finishedHistoryOrderDesc = true;

        function toggleHistoryOrder() {
            historyOrderDesc = !historyOrderDesc;
            const btn = document.getElementById('history-order-btn');
            btn.textContent = historyOrderDesc ? 'ÏµúÏã†Ïàú ‚Üì' : 'Ïò§ÎûòÎêúÏàú ‚Üë';
            
            const container = document.getElementById('match-history');
            const items = Array.from(container.children);
            items.reverse().forEach(item => container.appendChild(item));
        }

        function toggleFinishedHistoryOrder() {
            finishedHistoryOrderDesc = !finishedHistoryOrderDesc;
            // Ï†ÑÏ≤¥ ÌôîÎ©¥ Îã§Ïãú Î†åÎçîÎßÅÌïòÏó¨ Ï†ïÎ†¨ Ï†ÅÏö©
            render();
        }
        
        // Îπ†Î•∏ ÌîÑÎ°úÏ†ùÌä∏ - ÏÑ∏Ìä∏ Ïàò ÌëúÏãú ÌÜ†Í∏Ä
        function updateQPSets() {
            const type = document.getElementById('qp-type').value;
            const setsGroup = document.getElementById('qp-sets-group');
            if (setsGroup) {
                setsGroup.style.display = type === 'team' ? 'none' : 'block';
            }
        }
        
        // Îπ†Î•∏ ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±
        function createQuickProject() {
            const name = document.getElementById('qp-name').value.trim();
            if (!name) {
                alert('ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            const participantsText = document.getElementById('qp-participants').value.trim();
            if (!participantsText) {
                alert('Ï∞∏Í∞ÄÏûêÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // Ï∞∏Í∞ÄÏûê ÌååÏã± (Ï§ÑÎ∞îÍøà ÎòêÎäî ÏâºÌëúÎ°ú Íµ¨Î∂Ñ)
            const participants = participantsText
                .split(/[\n,]+/)
                .map(p => p.trim())
                .filter(p => p.length > 0);
            
            if (participants.length < 2) {
                alert('ÏµúÏÜå 2Î™Ö Ïù¥ÏÉÅÏùò Ï∞∏Í∞ÄÏûêÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§.');
                return;
            }
            
            const type = document.getElementById('qp-type').value;
            const sets = type === 'team' ? 1 : parseInt(document.getElementById('qp-sets').value);
            const format = document.getElementById('qp-format').value;
            const isTeam = type === 'team';
            const winScore = isTeam ? 31 : 11;
            
            // ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ±
            const project = {
                id: Date.now(),
                name: name,
                date: new Date().toISOString().split('T')[0],
                location: '',
                competitionType: isTeam ? 'team' : 'individual',
                players: isTeam ? [] : participants,
                teams: isTeam ? participants.map(t => ({ name: t, players: [] })) : [],
                tournamentType: format === 'full-league' ? 'group-only' : 'knockout-only',
                groups: [],
                matches: [],
                preliminarySets: sets,
                finalsSets: sets,
                createdAt: new Date().toISOString(),
                isQuickProject: true
            };
            
            // Í≤ΩÍ∏∞ ÏÉùÏÑ±
            if (format === 'full-league') {
                // ÌíÄÎ¶¨Í∑∏: Î™®Îì† Ï°∞Ìï©
                for (let i = 0; i < participants.length; i++) {
                    for (let j = i + 1; j < participants.length; j++) {
                        const match = {
                            id: Date.now() + i * 100 + j,
                            player1Name: participants[i],
                            player2Name: participants[j],
                            type: isTeam ? 'team' : 'individual',
                            sets: sets,
                            winScore: winScore,
                            currentSet: 1,
                            setScores: [{ player1: 0, player2: 0 }],
                            currentServe: 'player1',
                            serveCount: 0,
                            serveSelected: false,
                            timeouts: { player1: 1, player2: 1 },
                            history: [],
                            status: 'pending',
                            refereePin: generatePin()
                        };
                        project.matches.push(match);
                    }
                }
            } else {
                // ÌÜ†ÎÑàÎ®ºÌä∏: ÏàúÏÑúÎåÄÎ°ú Îß§Ïπ≠
                const shuffled = [...participants];
                // ÎûúÎç§ ÏÑûÍ∏∞
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                
                for (let i = 0; i < shuffled.length - 1; i += 2) {
                    const match = {
                        id: Date.now() + i,
                        player1Name: shuffled[i],
                        player2Name: shuffled[i + 1] || 'BYE',
                        type: isTeam ? 'team' : 'individual',
                        sets: sets,
                        winScore: winScore,
                        currentSet: 1,
                        setScores: [{ player1: 0, player2: 0 }],
                        currentServe: 'player1',
                        serveCount: 0,
                        serveSelected: false,
                        timeouts: { player1: 1, player2: 1 },
                        history: [],
                        status: 'pending',
                        bracketRound: 1,
                        bracketMatchNum: i / 2 + 1,
                        refereePin: generatePin()
                    };
                    project.matches.push(match);
                }
            }
            
            // ÌîÑÎ°úÏ†ùÌä∏ Ï†ÄÏû•
            projects.push(project);
            saveProjects();
            
            // ÏÉùÏÑ±Îêú ÌîÑÎ°úÏ†ùÌä∏Î°ú Ïù¥Îèô
            currentProject = project;
            announce(`${project.name} ÌîÑÎ°úÏ†ùÌä∏Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§. ${project.matches.length}Í≤ΩÍ∏∞`);
            goTo('project-list');
        }

        // Ïã¨Ìåê Ïó∞Ïäµ Î™®Îìú Í≤ΩÍ∏∞ ÏãúÏûë
        function startPracticeMatch() {
            const type = document.getElementById('practice-type').value;
            const sets = type === 'team' ? 1 : parseInt(document.getElementById('practice-sets').value);
            const player1 = document.getElementById('practice-player1').value.trim() || 'ÏÑ†Ïàò A';
            const player2 = document.getElementById('practice-player2').value.trim() || 'ÏÑ†Ïàò B';
            const shareEnabled = document.getElementById('practice-share')?.checked ?? true;
            
            // Ïó∞ÏäµÏö© ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± (Firebase ÎèôÍ∏∞ÌôîÎê®)
            const practiceProject = {
                id: Date.now(),
                name: 'Ïó∞Ïäµ Í≤ΩÍ∏∞',
                date: new Date().toISOString().split('T')[0],
                location: 'Ïó∞Ïäµ',
                competitionType: type === 'team' ? 'team' : 'individual',
                matches: [],
                isPractice: true,
                isShared: shareEnabled // Ïã§ÏãúÍ∞Ñ Í≥µÏú† Ïó¨Î∂Ä
            };
            
            // Ïó∞Ïäµ Í≤ΩÍ∏∞ ÏÉùÏÑ±
            const practiceMatch = {
                id: Date.now() + 1,
                type: type, // Í∞úÏù∏Ï†Ñ/ÌåÄÏ†Ñ Íµ¨Î∂Ñ - ÏÑúÎ∏å ÌöüÏàòÏóê ÏòÅÌñ•
                player1Name: player1,
                player2Name: player2,
                mainReferee: 'Ïó∞Ïäµ',
                refereePin: null, // PIN ÏóÜÏùå
                sets: sets,
                winScore: type === 'team' ? 31 : 11,
                currentSet: 1,
                setScores: [{ player1: 0, player2: 0 }], // Ï≤´ ÏÑ∏Ìä∏Îßå ÏÉùÏÑ±
                currentServe: 'player1',
                serveCount: 0,
                serveSelected: false, // ÏÑúÎ∏å ÎØ∏ÏÑ†ÌÉù ÏÉÅÌÉú
                timeouts: { player1: 1, player2: 1 },
                history: [],
                warmupUsed: false,
                status: 'in-progress',
                isPractice: true,
                isShared: shareEnabled,
                startedAt: new Date().toISOString()
            };
            
            practiceProject.matches.push(practiceMatch);
            
            // ÌîÑÎ°úÏ†ùÌä∏ Ï†ÄÏû• (Firebase ÎèôÍ∏∞Ìôî)
            projects.push(practiceProject);
            saveProjects();
            
            // Ïã§ÏãúÍ∞Ñ Í≥µÏú† ÌôúÏÑ±Ìôî Ïãú FirebaseÏóê Î≥ÑÎèÑ Ï†ÄÏû•
            if (shareEnabled && database) {
                database.ref('liveMatches/' + practiceMatch.id).set({
                    ...practiceMatch,
                    projectName: practiceProject.name,
                    updatedAt: new Date().toISOString()
                });
            }
            
            // ÌòÑÏû¨ ÌîÑÎ°úÏ†ùÌä∏/Í≤ΩÍ∏∞ ÏÑ§Ï†ï
            currentProject = practiceProject;
            currentMatch = practiceMatch;
            isAuthenticated = true; // Ïó∞Ïäµ Î™®ÎìúÎäî Ìï≠ÏÉÅ Ïù∏Ï¶ùÎê®
            
            // Í≤ΩÍ∏∞ ÌôîÎ©¥ÏúºÎ°ú Ïù¥Îèô
            screen = 'match';
            announce('Ïó∞Ïäµ Í≤ΩÍ∏∞Í∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§. ' + player1 + ' ÎåÄ ' + player2 + '. ' + sets + 'ÏÑ∏Ìä∏');
            render();
        }
        
        // Ïó∞Ïäµ Í≤ΩÍ∏∞ Í∏∞Î°ù Ï†ÄÏû• (Firebase + Î°úÏª¨)
        // Ïã§ÏãúÍ∞Ñ Ïó∞Ïäµ Í≤ΩÍ∏∞ Í¥ÄÎûå
        function watchLiveMatch(matchId) {
            // ÌîÑÎ°úÏ†ùÌä∏ÏóêÏÑú Í≤ΩÍ∏∞ Ï∞æÍ∏∞
            for (const project of projects) {
                const match = project.matches?.find(m => m.id === matchId);
                if (match) {
                    currentProject = project;
                    currentMatch = match;
                    isAuthenticated = false; // Í¥ÄÎûå Î™®Îìú
                    userRole = 'viewer';
                    
                    // Firebase Ïã§ÏãúÍ∞Ñ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
                    if (database && match.isShared) {
                        database.ref('liveMatches/' + matchId).on('value', (snapshot) => {
                            const liveData = snapshot.val();
                            if (liveData && currentMatch && currentMatch.id === matchId) {
                                // Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞Î°ú Í≤ΩÍ∏∞ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
                                Object.assign(currentMatch, liveData);
                                render();
                            }
                        });
                    }
                    
                    screen = 'match';
                    announce(`${match.player1Name} ÎåÄ ${match.player2Name} Í≤ΩÍ∏∞ Í¥ÄÎûå ÏãúÏûë`);
                    render();
                    return;
                }
            }
            alert('Í≤ΩÍ∏∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
        }
        
        // Ïã§ÏãúÍ∞Ñ Í≤ΩÍ∏∞ Îç∞Ïù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏ (Ï†êÏàò Î≥ÄÍ≤Ω Ïãú Ìò∏Ï∂ú)
        function updateLiveMatch() {
            if (!currentMatch) return;
            
            // Î°úÏª¨ Ï†ÄÏû• Î∞è ÌîÑÎ°úÏ†ùÌä∏ ÏóÖÎç∞Ïù¥Ìä∏
            updateLiveMatchStatus(currentMatch);
            
            // Firebase Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî (Í≥µÏú†Îêú Í≤ΩÍ∏∞Îßå)
            if (currentMatch.isShared) {
                syncLiveMatchToFirebase(currentMatch);
            }
        }
        
        function savePracticeResult(silent = false) {
            if (!currentMatch) return;
            
            const practiceHistory = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
            
            // Ï§ëÎ≥µ Ï†ÄÏû• Î∞©ÏßÄ
            const exists = practiceHistory.some(m => m.id === currentMatch.id);
            if (exists) {
                if (!silent) alert('Ïù¥ÎØ∏ Ï†ÄÏû•Îêú Í∏∞Î°ùÏûÖÎãàÎã§.');
                return;
            }
            
            // Ï†ÄÏû•Ìï† Îç∞Ïù¥ÌÑ∞
            const matchRecord = {
                id: currentMatch.id,
                player1Name: currentMatch.player1Name,
                player2Name: currentMatch.player2Name,
                setScores: currentMatch.setScores,
                history: currentMatch.history,
                winner: currentMatch.winner,
                finishedAt: currentMatch.finishedAt || new Date().toISOString(),
                sets: currentMatch.sets,
                matchType: 'practice' // ‚ú® Íµ¨Î∂Ñ ÌïÑÎìú
            };
            
            // Î°úÏª¨Ïóê Ï†ÄÏû•
            practiceHistory.push(matchRecord);
            localStorage.setItem('practiceHistory', JSON.stringify(practiceHistory));
            
            // ‚ú® FirebaseÏóêÎèÑ Ï†ÄÏû•
            savePracticeToFirebase(matchRecord);
            
            if (!silent) {
                announce('Í∏∞Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§');
                alert('Í∏∞Î°ùÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
            }
        }
        
        // ‚ú® Ïó∞Ïäµ Í≤ΩÍ∏∞Î•º FirebaseÏóê Ï†ÄÏû•
        function savePracticeToFirebase(matchRecord) {
            if (!database || !userId) {
                // Firebase ÎØ∏Ïó∞Í≤∞ - Ïò§ÌîÑÎùºÏù∏ ÌÅêÏóê Ï∂îÍ∞Ä
                const queue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
                queue.push({
                    type: 'practiceMatch',
                    userId: userId,
                    data: matchRecord,
                    timestamp: Date.now()
                });
                localStorage.setItem('offlineQueue', JSON.stringify(queue));
                console.log('üì¥ Ïó∞Ïäµ Í≤ΩÍ∏∞ Ïò§ÌîÑÎùºÏù∏ ÌÅêÏóê Ï∂îÍ∞Ä');
                return;
            }
            
            try {
                if (!isOffline) {
                    // FirebaseÏóê Ï†ÄÏû•
                    const matchId = 'practice_' + matchRecord.id;
                    database.ref(`practiceMatches/${userId}/${matchId}`).set(matchRecord);
                    console.log('FirebaseÏóê Ïó∞Ïäµ Í≤ΩÍ∏∞ Ï†ÄÏû•:', matchId);
                } else {
                    // Ïò§ÌîÑÎùºÏù∏ ÌÅêÏóê Ï∂îÍ∞Ä
                    const queue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
                    queue.push({
                        type: 'practiceMatch',
                        userId: userId,
                        matchId: 'practice_' + matchRecord.id,
                        data: matchRecord,
                        timestamp: Date.now()
                    });
                    localStorage.setItem('offlineQueue', JSON.stringify(queue));
                    console.log('üì¥ Ïó∞Ïäµ Í≤ΩÍ∏∞ Ïò§ÌîÑÎùºÏù∏ ÌÅêÏóê Ï∂îÍ∞Ä');
                }
            } catch (error) {
                console.error('Ïó∞Ïäµ Í≤ΩÍ∏∞ Firebase Ï†ÄÏû• Ïã§Ìå®:', error);
            }
        }
        
        // ‚ú® FirebaseÏóêÏÑú Ïó∞Ïäµ Í≤ΩÍ∏∞ Î°úÎìú
        let practiceMatchesFromFirebase = [];
        
        function loadPracticeMatchesFromFirebase() {
            if (!database || !userId) {
                console.log('üì¥ Firebase ÎØ∏Ïó∞Í≤∞ - Î°úÏª¨Îßå ÏÇ¨Ïö©');
                return;
            }
            
            try {
                database.ref(`practiceMatches/${userId}`).once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        practiceMatchesFromFirebase = Object.values(data);
                        console.log('FirebaseÏóêÏÑú Ïó∞Ïäµ Í≤ΩÍ∏∞ Î°úÎìú:', practiceMatchesFromFirebase.length);
                    } else {
                        console.log('FirebaseÏóê Ïó∞Ïäµ Í≤ΩÍ∏∞ ÏóÜÏùå');
                    }
                }).catch(error => {
                    console.log('Firebase Ïó∞Ïäµ Í≤ΩÍ∏∞ Î°úÎìú Ïã§Ìå®:', error);
                });
            } catch (error) {
                console.log('Ïó∞Ïäµ Í≤ΩÍ∏∞ Î°úÎìú ÏóêÎü¨:', error);
            }
        }
        
        // Ïó∞Ïäµ Í∏∞Î°ù ÏÉÅÏÑ∏ Î≥¥Í∏∞
        function viewPracticeRecord(idx) {
            window.currentPracticeRecordIdx = idx;
            goTo('practice-detail');
        }
        
        // Ïó∞Ïäµ Í∏∞Î°ù ÏÇ≠Ï†ú
        function deletePracticeRecord(idx) {
            if (!confirm('Ïù¥ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            const practiceHistory = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
            practiceHistory.splice(idx, 1);
            localStorage.setItem('practiceHistory', JSON.stringify(practiceHistory));
            
            announce('Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
            render();
        }
        
        // Ïó∞Ïäµ Í∏∞Î°ù Ï†ÑÏ≤¥ ÏÇ≠Ï†ú
        function clearPracticeHistory() {
            if (!confirm('Î™®Îì† Ïó∞Ïäµ Í∏∞Î°ùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            localStorage.removeItem('practiceHistory');
            announce('Î™®Îì† Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§');
            render();
        }

        // Ï≤´ ÏÑúÎ∏å ÏÑ†ÌÉù
        function selectFirstServe(player) {
            if (!currentMatch) return;
            currentMatch.currentServe = player;
            currentMatch.serveSelected = true;
            currentMatch.serveCount = 0;
            const serverName = player === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            announce(serverName + ' Ï≤´ ÏÑúÎ∏å');
            saveProjects();
            render();
        }

        // ÏõåÎ∞çÏóÖ ÏãúÏûë (IBSA Í∑úÏπô: Í∞úÏù∏Ï†Ñ 60Ï¥à, ÌåÄÏ†Ñ 90Ï¥à)
        function startWarmup() {
            // Í≤ΩÍ∏∞Îãπ ÏõåÎ∞çÏóÖ 1ÌöåÎßå ÏÇ¨Ïö© Í∞ÄÎä•
            currentMatch.warmupUsed = true;
            saveProjects();
            
            warmupActive = true;
            // IBSA Í∑úÏπô: Í∞úÏù∏Ï†Ñ 60Ï¥à, ÌåÄÏ†Ñ 90Ï¥à (type ÏóÜÏúºÎ©¥ Í∞úÏù∏Ï†ÑÏúºÎ°ú Ï≤òÎ¶¨)
            const isTeam = currentMatch.type === 'team';
            warmupSeconds = isTeam ? 90 : 60;
            announce(`ÏõåÎ∞çÏóÖ ${warmupSeconds}Ï¥à ÏãúÏûë`);
            render();
            
            warmupTimer = setInterval(() => {
                warmupSeconds--;
                const display = document.getElementById('warmup-timer');
                if (display) {
                    display.textContent = `${Math.floor(warmupSeconds / 60)}:${(warmupSeconds % 60).toString().padStart(2, '0')}`;
                }
                
                // ÎÇ®ÏùÄ ÏãúÍ∞Ñ ÏïàÎÇ¥
                if (isTeam) {
                    // ÌåÄÏ†Ñ 90Ï¥à: 60Ï¥à, 30Ï¥àÏóê "30Ï¥à" ÏïàÎÇ¥
                    if (warmupSeconds === 60 || warmupSeconds === 30) {
                        announce('30Ï¥à');
                    }
                } else {
                    // Í∞úÏù∏Ï†Ñ 60Ï¥à: 15Ï¥àÏóêÎßå ÏïàÎÇ¥
                    if (warmupSeconds === 15) {
                        announce('15Ï¥à');
                    }
                }
                
                if (warmupSeconds <= 0) {
                    stopWarmup();
                    announce('ÏõåÎ∞çÏóÖ Ï¢ÖÎ£å');
                }
            }, 1000);
        }

        // ÏõåÎ∞çÏóÖ Ï¢ÖÎ£å
        function stopWarmup() {
            warmupActive = false;
            if (warmupTimer) {
                clearInterval(warmupTimer);
                warmupTimer = null;
            }
            render();
        }

        // Ï¥àÍ∏∞Ìôî
        const savedTheme = localStorage.getItem('theme') || 'normal';
        const savedThemeIndex = parseInt(localStorage.getItem('themeIndex')) || 0;
        currentThemeIndex = savedThemeIndex;
        
        if (savedTheme !== 'normal') {
            document.body.className = savedTheme;
        }
        
        const currentTheme = themes[currentThemeIndex];
        const themeBtnInit = document.getElementById('theme-btn');
        const voiceBtnInit = document.getElementById('voice-btn');
        if (themeBtnInit) themeBtnInit.textContent = `Î™®Îìú: ${currentTheme.name}`;
        if (voiceBtnInit) voiceBtnInit.style.opacity = voiceEnabled ? '1' : '0.5';
        
        // Ïã¨Ìåê ÎπÑÎ∞ÄÎ≤àÌò∏ Ï¥àÍ∏∞Ìôî (Ï≤´ Ïã§Ìñâ Ïãú)
        if (!localStorage.getItem('refereePasswordsInitialized')) {
            localStorage.setItem('refereePasswords', JSON.stringify({}));
            localStorage.setItem('refereePasswordsInitialized', 'true');
        }
        
        render();
        
        // PWA Service Worker Îì±Î°ù
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('SW Îì±Î°ù ÏÑ±Í≥µ:', registration.scope);
                        
                        // ÏóÖÎç∞Ïù¥Ìä∏ ÌôïÏù∏
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // ÏÉà Î≤ÑÏ†Ñ ÏÇ¨Ïö© Í∞ÄÎä•
                                    if (confirm('ÏÉà Î≤ÑÏ†ÑÏù¥ ÏûàÏäµÎãàÎã§. ÏóÖÎç∞Ïù¥Ìä∏ÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(err => {
                        console.log('SW Îì±Î°ù Ïã§Ìå®:', err);
                    });
            });
        }
        
        // PWA ÏÑ§Ïπò ÌîÑÎ°¨ÌîÑÌä∏
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // ÏÑ§Ïπò Î≤ÑÌäº ÌëúÏãú (ÏÑ†ÌÉùÏ†Å)
            const installBtn = document.getElementById('pwa-install-btn');
            if (installBtn) {
                installBtn.style.display = 'block';
                installBtn.onclick = async () => {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('ÏÑ§Ïπò Í≤∞Í≥º:', outcome);
                    deferredPrompt = null;
                    installBtn.style.display = 'none';
                };
            }
        });
        
        // ========== Tournament Wizard - Step 6: Ïã¨Ìåê/Í≤ΩÍ∏∞Ïû• ÏÑ§Ï†ï ==========
        
        function addTWReferee() {
            const tw = window.tournamentWizard;
            const name = document.getElementById('tw-ref-name')?.value.trim();
            const role = document.getElementById('tw-ref-role')?.value || 'main';
            const pin = document.getElementById('tw-ref-pin')?.value.trim();
            
            // Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (!name) {
                announce('Ïã¨Ìåê Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
                return;
            }
            
            if (!pin || pin.length < 6) {
                announce('PIN Î≤àÌò∏Îäî 6ÏûêÎ¶¨ Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§');
                return;
            }
            
            if (!/^\d+$/.test(pin)) {
                announce('PIN Î≤àÌò∏Îäî Ïà´ÏûêÎßå ÏûÖÎ†• Í∞ÄÎä•Ìï©ÎãàÎã§');
                return;
            }
            
            // Ï§ëÎ≥µ ÌôïÏù∏
            if (tw.referees.some(r => r.name === name)) {
                announce('Ïù¥ÎØ∏ Îì±Î°ùÎêú Ïã¨ÌåêÏûÖÎãàÎã§');
                return;
            }
            
            // Ï∂îÍ∞Ä
            tw.referees.push({ name, role, pin });
            
            // Ï¥àÍ∏∞Ìôî
            document.getElementById('tw-ref-name').value = '';
            document.getElementById('tw-ref-pin').value = '';
            
            announce(`Ïã¨Ìåê "${name}" Ï∂îÍ∞ÄÎê® (PIN: ${pin})`);
            render();
        }
        
        function deleteTWReferee(index) {
            const tw = window.tournamentWizard;
            const ref = tw.referees[index];
            tw.referees.splice(index, 1);
            announce(`Ïã¨Ìåê "${ref.name}" ÏÇ≠Ï†úÎê®`);
            render();
        }
        
        function addTWCourt() {
            const tw = window.tournamentWizard;
            const name = document.getElementById('tw-court-name')?.value.trim();
            
            if (!name) {
                announce('Í≤ΩÍ∏∞Ïû• Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
                return;
            }
            
            // Ï§ëÎ≥µ ÌôïÏù∏
            if (tw.courts.some(c => c.name === name)) {
                announce('Ïù¥ÎØ∏ Îì±Î°ùÎêú Í≤ΩÍ∏∞Ïû•ÏûÖÎãàÎã§');
                return;
            }
            
            // Ï∂îÍ∞Ä
            tw.courts.push({ name });
            
            // Ï¥àÍ∏∞Ìôî
            document.getElementById('tw-court-name').value = '';
            
            announce(`Í≤ΩÍ∏∞Ïû• "${name}" Ï∂îÍ∞ÄÎê®`);
            render();
        }
        
        function deleteTWCourt(index) {
            const tw = window.tournamentWizard;
            const court = tw.courts[index];
            tw.courts.splice(index, 1);
            announce(`Í≤ΩÍ∏∞Ïû• "${court.name}" ÏÇ≠Ï†úÎê®`);
            render();
        }
        
        // ‚ú® Firebase Í∏∞Î∞ò ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï
        // FirebaseÏóêÏÑú ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Î°úÎìú
        function loadUserPreferences() {
            if (!database || !userId) {
                // Firebase ÎØ∏Ïó∞Í≤∞ - Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Î°úÎìú
                favoritePlayers = JSON.parse(localStorage.getItem('favorite-players') || '[]');
                notifiedMatches = JSON.parse(localStorage.getItem('notified-matches') || '[]');
                console.log('üì¥ Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Î°úÎìú');
                return;
            }
            
            try {
                // FirebaseÏóêÏÑú ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Î°úÎìú
                database.ref(`userPreferences/${userId}`).once('value', (snapshot) => {
                    const prefs = snapshot.val();
                    if (prefs) {
                        favoritePlayers = prefs.favorites || [];
                        notifiedMatches = prefs.notifications || [];
                        console.log('FirebaseÏóêÏÑú ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Î°úÎìú:', userId);
                    } else {
                        // Ï≤´ Î°úÎìú - Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
                        favoritePlayers = JSON.parse(localStorage.getItem('favorite-players') || '[]');
                        notifiedMatches = JSON.parse(localStorage.getItem('notified-matches') || '[]');
                        saveUserPreferences(); // FirebaseÏóê Ï†ÄÏû•
                        console.log('Î°úÏª¨ Îç∞Ïù¥ÌÑ∞Î•º FirebaseÎ°ú ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò');
                    }
                }).catch(error => {
                    console.log('Firebase Î°úÎìú Ïã§Ìå® - Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ ÏÇ¨Ïö©:', error);
                    favoritePlayers = JSON.parse(localStorage.getItem('favorite-players') || '[]');
                    notifiedMatches = JSON.parse(localStorage.getItem('notified-matches') || '[]');
                });
            } catch (error) {
                console.log('ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Î°úÎìú Ïã§Ìå®:', error);
            }
        }
        
        // FirebaseÏóê ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Ï†ÄÏû•
        function saveUserPreferences() {
            if (!database || !userId) {
                // Firebase ÎØ∏Ïó∞Í≤∞ - Î°úÏª¨Îßå Ï†ÄÏû•
                localStorage.setItem('favorite-players', JSON.stringify(favoritePlayers));
                localStorage.setItem('notified-matches', JSON.stringify(notifiedMatches));
                return;
            }
            
            try {
                if (database && userId && !isOffline) {
                    database.ref(`userPreferences/${userId}`).set({
                        favorites: favoritePlayers,
                        notifications: notifiedMatches,
                        lastUpdated: new Date().toISOString()
                    });
                    console.log('FirebaseÏóê ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Ï†ÄÏû•');
                } else if (isOffline) {
                    // Ïò§ÌîÑÎùºÏù∏ ÌÅêÏóê Ï∂îÍ∞Ä
                    const queue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
                    queue.push({
                        type: 'userPreferences',
                        userId: userId,
                        data: { favorites: favoritePlayers, notifications: notifiedMatches },
                        timestamp: Date.now()
                    });
                    localStorage.setItem('offlineQueue', JSON.stringify(queue));
                    // Î°úÏª¨ÏóêÎèÑ Ï†ÄÏû•
                    localStorage.setItem('favorite-players', JSON.stringify(favoritePlayers));
                    localStorage.setItem('notified-matches', JSON.stringify(notifiedMatches));
                    console.log('üì¥ Ïò§ÌîÑÎùºÏù∏ - ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Î°úÏª¨ Ï†ÄÏû• Î∞è ÌÅêÏóê Ï∂îÍ∞Ä');
                }
            } catch (error) {
                console.error('ÏÇ¨Ïö©Ïûê ÏÑ§Ï†ï Ï†ÄÏû• ÏóêÎü¨:', error);
            }
        }
        
        // Í≤ÄÏÉâ Í≤∞Í≥º Î†åÎçîÎßÅ Ìï®Ïàò
        function renderViewerResults() {
            const container = document.getElementById('viewer-results-container');
            if (!container) return;
            
            const tab = window.viewerTab || 'actual';
            const query = (document.getElementById('viewer-search')?.value || '').toLowerCase();
            
            // Î™®Îì† Í≤ΩÍ∏∞ ÏàòÏßë
            let allMatches = [];
            
            // ‚ú® ÌÉ≠Ïù¥ 'actual'Ïù¥Î©¥ Ïã§Ï†ú Í≤ΩÍ∏∞
            if (tab === 'actual') {
                projects.forEach((project, pIdx) => {
                    if (project.matches) {
                        project.matches.forEach((match, mIdx) => {
                            allMatches.push({
                                ...match,
                                projectName: project.name,
                                projectIdx: pIdx,
                                matchIdx: mIdx,
                                matchType: 'actual'
                            });
                        });
                    }
                });
            } 
            // ‚ú® ÌÉ≠Ïù¥ 'practice'Ïù¥Î©¥ Ïó∞Ïäµ Í≤ΩÍ∏∞
            else if (tab === 'practice') {
                const practiceHistory = JSON.parse(localStorage.getItem('practiceHistory') || '[]');
                // Firebase Îç∞Ïù¥ÌÑ∞ÎèÑ Ìè¨Ìï®
                const allPractice = [...practiceHistory, ...practiceMatchesFromFirebase];
                // Ï§ëÎ≥µ Ï†úÍ±∞
                const unique = Array.from(new Map(allPractice.map(m => [m.id, m])).values());
                
                unique.forEach((match, idx) => {
                    allMatches.push({
                        ...match,
                        projectName: 'Ïó∞Ïäµ Í≤ΩÍ∏∞',
                        projectIdx: -1,
                        matchIdx: idx,
                        matchType: 'practice'
                    });
                });
            }
            
            // ÌïÑÌÑ∞ÎßÅ
            let filtered = allMatches.filter(m => {
                const matchesQuery = !query || 
                    (m.player1Name && m.player1Name.toLowerCase().includes(query)) ||
                    (m.player2Name && m.player2Name.toLowerCase().includes(query));
                
                const isFavorite = favoritePlayers.includes(m.player1Name) || favoritePlayers.includes(m.player2Name);
                return matchesQuery && (!showFavoritesOnly || isFavorite);
            });
            
            if (filtered.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:40px 20px; color:var(--text-secondary);">
                    <div style="font-size:48px; margin-bottom:12px;">üòï</div>
                    <p>${tab === 'actual' ? 'Í≤ΩÍ∏∞Í∞Ä ÏóÜÏäµÎãàÎã§' : 'Ïó∞Ïäµ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§'}</p>
                </div>`;
                return;
            }
            
            // Í≤ΩÍ∏∞ Ïπ¥Îìú Î†åÎçîÎßÅ
            container.innerHTML = filtered.map(m => {
                const isFav = favoritePlayers.includes(m.player1Name) || favoritePlayers.includes(m.player2Name);
                const isNotify = notifiedMatches.includes(`${m.projectIdx}-${m.matchIdx}`);
                
                // ‚ú® Ïã§Ï†ú Í≤ΩÍ∏∞ÏôÄ Ïó∞Ïäµ Í≤ΩÍ∏∞ ÌëúÏãú Î∞©Ïãù Îã§Î•¥Í≤å
                let resultText = '';
                if (m.matchType === 'actual') {
                    resultText = `
                        <div style="font-size:1.3rem; margin-top:6px; font-weight:bold; color:#667eea;">
                            ${m.setScores ? m.setScores[m.currentSet-1]?.player1 || 0 : 0} : ${m.setScores ? m.setScores[m.currentSet-1]?.player2 || 0 : 0}
                        </div>
                        <div style="font-size:0.85rem; color:#999; margin-top:4px;">
                            üìç ${m.courtName || 'ÎØ∏Ï†ï'} | ${m.status === 'completed' ? 'ÏôÑÎ£å' : m.status === 'inprogress' ? '‚è≥ ÏßÑÌñâÏ§ë' : '‚≠ï ÎåÄÍ∏∞'}
                        </div>
                    `;
                } else {
                    // Ïó∞Ïäµ Í≤ΩÍ∏∞
                    const date = m.finishedAt ? new Date(m.finishedAt).toLocaleDateString('ko-KR') : '';
                    const p1Wins = m.setScores?.filter(s => s.player1 > s.player2).length || 0;
                    const p2Wins = m.setScores?.filter(s => s.player2 > s.player1).length || 0;
                    resultText = `
                        <div style="font-size:1.3rem; margin-top:6px; font-weight:bold; color:#4caf50;">
                            ${p1Wins} : ${p2Wins} ÏÑ∏Ìä∏ (Ïäπ: ${m.winner})
                        </div>
                        <div style="font-size:0.85rem; color:#999; margin-top:4px;">
                            üìÖ ${date}
                        </div>
                    `;
                }
                
                return `
                    <div class="card" style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center; padding:15px; border-left:4px solid ${m.matchType === 'actual' ? '#667eea' : '#4caf50'};">
                        <div style="flex:1; cursor:pointer;" onclick="viewMatchResult('${m.matchType}', ${m.matchType === 'actual' ? m.projectIdx : m.matchIdx})">
                            <div style="font-size:0.9rem; color:${m.matchType === 'actual' ? '#667eea' : '#4caf50'}; font-weight:bold;">
                                ${m.matchType === 'actual' ? '' : 'üèãÔ∏è '}${m.projectName}
                            </div>
                            <div style="font-size:1.05rem; margin-top:4px; font-weight:600;">${m.player1Name || 'ÏÑ†Ïàò1'} vs ${m.player2Name || 'ÏÑ†Ïàò2'}</div>
                            ${resultText}
                        </div>
                        <div style="display:flex; flex-direction:column; gap:10px; margin-left:12px;">
                            <button style="font-size:26px; background:none; border:none; cursor:pointer; padding:0; color:${isFav ? '#f1c40f' : '#ddd'};" 
                                    onclick="toggleFavorite('${m.player1Name}', '${m.player2Name}')"
                                    aria-label="${m.player1Name}ÏôÄ ${m.player2Name}Ïùò Í≤ΩÍ∏∞Î•º Ï¶êÍ≤®Ï∞æÍ∏∞Ïóê ${isFav ? 'Ìï¥Ï†ú' : 'Ï∂îÍ∞Ä'}">
                                ${isFav ? '‚òÖ' : '‚òÜ'}
                            </button>
                            <button style="font-size:22px; background:none; border:none; cursor:pointer; padding:0; color:${isNotify ? '#4a90d9' : '#ddd'};" 
                                    onclick="toggleNotification('${m.projectIdx}-${m.matchIdx}')"
                                    aria-label="${m.player1Name}ÏôÄ ${m.player2Name}Ïùò Í≤ΩÍ∏∞ ÎìùÏ†ê ÏïåÎ¶ºÏùÑ ${isNotify ? 'ÎÅÑÍ∏∞' : 'Î∞õÍ∏∞'}">
                                ${isNotify ? 'üîî' : 'üîï'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ‚ú® ÌÉ≠ Ï†ÑÌôò Ìï®Ïàò
        function switchViewerTab(tab) {
            window.viewerTab = tab;
            render(); // Ï†ÑÏ≤¥ ÌôîÎ©¥ Îã§Ïãú Î†åÎçîÎßÅ
        }
        
        // ‚ú® Í≤ΩÍ∏∞ Í≤∞Í≥º Î≥¥Í∏∞
        function viewMatchResult(type, idx) {
            if (type === 'actual') {
                currentProject = projects[idx];
                goTo('project-detail');
            } else {
                window.currentPracticeRecordIdx = idx;
                goTo('practice-detail');
            }
        }
        
        // Ï¶êÍ≤®Ï∞æÍ∏∞ ÌÜ†Í∏Ä
        function toggleFavorite(player1, player2) {
            if (!player1 || !player2) return;
            [player1, player2].forEach(p => {
                if (p && p !== 'ÏÑ†Ïàò1' && p !== 'ÏÑ†Ïàò2') {
                    const idx = favoritePlayers.indexOf(p);
                    if (idx > -1) {
                        favoritePlayers.splice(idx, 1);
                    } else {
                        favoritePlayers.push(p);
                    }
                }
            });
            
            // ‚ú® Firebase Ï†ÄÏû•
            saveUserPreferences();
            
            renderViewerResults();
            announce(`${player1} Ï¶êÍ≤®Ï∞æÍ∏∞ ${favoritePlayers.includes(player1) ? 'Ï∂îÍ∞Ä' : 'Ï†úÍ±∞'}`);
        }
        
        // ÏïåÎ¶º ÌÜ†Í∏Ä
        function toggleNotification(matchKey) {
            const idx = notifiedMatches.indexOf(matchKey);
            if (idx > -1) {
                notifiedMatches.splice(idx, 1);
            } else {
                notifiedMatches.push(matchKey);
            }
            
            // ‚ú® Firebase Ï†ÄÏû•
            saveUserPreferences();
            
            renderViewerResults();
            announce(`ÏïåÎ¶º ${idx > -1 ? 'Ìï¥Ï†ú' : 'ÏÑ§Ï†ï'}`);
        }
        
        // Í≤ÄÏÉâÏñ¥ Ï¥àÍ∏∞Ìôî
        function clearSearch() {
            const searchInput = document.getElementById('viewer-search');
            if (searchInput) {
                searchInput.value = '';
                renderViewerResults();
                announce('Í≤ÄÏÉâÏñ¥ Ï¥àÍ∏∞ÌôîÎê®');
            }
        }
        
        // Ï¶êÍ≤®Ï∞æÍ∏∞Îßå Î≥¥Í∏∞
        function filterFavoritesOnly() {
            showFavoritesOnly = !showFavoritesOnly;
            renderViewerResults();
            announce(showFavoritesOnly ? 'Ï¶êÍ≤®Ï∞æÍ∏∞Îßå ÌëúÏãú' : 'Ï†ÑÏ≤¥ ÌëúÏãú');
        }
        
        // Ïó∞Ïäµ Í≤ΩÍ∏∞ ÏãúÏûë
        function startPracticeMode() {
            goTo('practice-mode');
            announce('üèãÔ∏è Ïó∞Ïäµ Í≤ΩÍ∏∞ Î™®ÎìúÎ°ú Ï†ÑÌôòÎêòÏóàÏäµÎãàÎã§');
        }
        
    </script>
</body>
</html>
