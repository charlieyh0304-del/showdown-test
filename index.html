<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‡¼ë‹¤ìš´ ì‹¬íŒ ì•± - ìµœì¢… í†µí•©ë³¸</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 600px; margin: 0 auto; padding: 16px; }
        .header { background: linear-gradient(135deg, #1976d2 0%, #0d47a1 100%); color: white; padding: 16px; border-radius: 8px; margin-bottom: 16px; text-align: center; }
        .header h1 { font-size: 24px; margin-bottom: 4px; }
        .header p { font-size: 12px; opacity: 0.9; }
        .card { background: white; padding: 16px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .btn { width: 100%; padding: 10px; margin: 6px 0; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; color: white; font-size: 14px; transition: all 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: #1976d2; }
        .btn-success { background: #4caf50; }
        .btn-info { background: #2196f3; }
        .btn-secondary { background: #999; }
        .btn-danger { background: #f44336; }
        input, select { width: 100%; padding: 8px; margin: 6px 0; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .item { background: #f9f9f9; padding: 10px; border-radius: 6px; margin: 6px 0; border-left: 4px solid #2196f3; }
        .item strong { display: block; margin-bottom: 2px; }
        .item small { color: #999; font-size: 12px; }
        .score-display { font-size: 56px; font-weight: bold; text-align: center; color: #1976d2; margin: 20px 0; }
        .timer { font-size: 48px; font-weight: bold; text-align: center; color: #d32f2f; margin: 20px 0; font-family: monospace; }
        .status { background: #e3f2fd; padding: 8px; border-radius: 6px; margin: 8px 0; color: #1976d2; text-align: center; font-size: 11px; }
        .status.offline { background: #fff3e0; color: #e65100; }
        hr { margin: 10px 0; border: none; border-top: 1px solid #ddd; }
        h2, h3 { margin: 10px 0 6px; font-size: 16px; }
        .match-live { background: #e8f5e9; border-left-color: #4caf50; }
        .match-live::before { content: "ğŸ”´ "; color: #d32f2f; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container" id="app"></div>

    <!-- Firebase SDK (ìµœì‹  ë²„ì „) -->
    <script src="https://www.gstatic.com/firebaseapps/live/11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebaseapps/live/11.0/firebase-database-compat.js"></script>

    <script>
        // ==================== Firebase ì„¤ì • ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAKv3QOpSg-hLnyXSnE299fHRV-akpPQCs",
            authDomain: "showdown1-838bf.firebaseapp.com",
            databaseURL: "https://showdown1-838bf-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "showdown1-838bf",
            storageBucket: "showdown1-838bf.firebasestorage.app",
            messagingSenderId: "379033064628",
            appId: "1:379033064628:web:252eef0e38b45859df73e1"
        };

        let db = null;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log('âœ… Firebase ì—°ê²°ë¨');
        } catch (e) {
            console.warn('âš ï¸ Firebase ì„¤ì • í•„ìš”:', e.message);
        }

        // ==================== ìƒíƒœ ====================
        const state = {
            screen: 'home',
            projects: [],
            currentProject: null,
            currentMatch: null,
            isOnline: navigator.onLine,
            timerInterval: null,
            timerSeconds: 0,
            timerRunning: false
        };

        // ==================== ì´ˆê¸°í™” ====================
        window.addEventListener('online', () => {
            state.isOnline = true;
            syncData();
            render();
        });
        window.addEventListener('offline', () => {
            state.isOnline = false;
            render();
        });

        // ==================== Firebase ====================
        function loadData() {
            if (!db) { loadLocal(); return; }
            
            db.ref('projects').on('value', snapshot => {
                state.projects = [];
                snapshot.forEach(child => {
                    state.projects.push({ id: child.key, ...child.val() });
                });
                render();
            });
        }

        function saveData() {
            const data = JSON.stringify(state.projects);
            localStorage.setItem('projects', data);
            
            if (!db) return;
            
            state.projects.forEach(p => {
                db.ref('projects/' + p.id).set(p).catch(e => console.warn('ì €ì¥ ì‹¤íŒ¨:', e));
            });
        }

        function loadLocal() {
            try {
                state.projects = JSON.parse(localStorage.getItem('projects') || '[]');
            } catch (e) {
                state.projects = [];
            }
        }

        // ==================== í™”ë©´ ====================
        function goTo(screen) {
            state.screen = screen;
            if (state.timerRunning) {
                clearInterval(state.timerInterval);
                state.timerRunning = false;
            }
            render();
        }

        function render() {
            const app = document.getElementById('app');
            const offline = state.isOnline ? '' : '<div class="status offline">ğŸ“´ ì˜¤í”„ë¼ì¸</div>';

            // í™ˆ
            if (state.screen === 'home') {
                app.innerHTML = `
                    ${offline}
                    <div class="header"><h1>âš« ì‹¬íŒ ì•±</h1><p>í†µí•© ë²„ì „</p></div>
                    <div class="card">
                        <button class="btn btn-primary" onclick="goTo('admin')">ğŸ‘¨â€ğŸ’¼ ìš´ì˜ì</button>
                        <button class="btn btn-success" onclick="goTo('referee-login')">ğŸ” ì‹¬íŒ</button>
                        <button class="btn btn-info" onclick="goTo('viewer')">ğŸ‘ï¸ ê´€ëŒ</button>
                    </div>
                `;
            }

            // ìš´ì˜ì
            else if (state.screen === 'admin') {
                let html = state.projects.map((p, i) => `
                    <div class="item">
                        <strong>${p.name}</strong>
                        <small>ê²½ê¸°: ${(p.matches||[]).length}ê°œ</small>
                        <button class="btn btn-primary" style="margin-top:6px;padding:8px;" onclick="selectProject(${i})">ì„ íƒ</button>
                    </div>
                `).join('');

                app.innerHTML = `
                    ${offline}
                    <div class="header"><h1>ğŸ‘¨â€ğŸ’¼ ìš´ì˜ì</h1></div>
                    <div class="card">
                        <button class="btn btn-success" onclick="createProject()">â• ëŒ€íšŒ ìƒì„±</button>
                        <hr>
                        ${html || '<p style="color:#999;">ëŒ€íšŒ ì—†ìŒ</p>'}
                        <button class="btn btn-secondary" onclick="goTo('home')">â¬…ï¸</button>
                    </div>
                `;
            }

            // ëŒ€íšŒ ê´€ë¦¬
            else if (state.screen === 'admin-project') {
                if (!state.currentProject) { goTo('admin'); return; }
                
                let html = (state.currentProject.matches||[]).map((m, i) => `
                    <div class="item">
                        <strong>${m.player1} vs ${m.player2}</strong>
                        <small>${m.score1}:${m.score2}</small>
                        <button class="btn btn-info" style="margin-top:6px;padding:8px;" onclick="selectMatch(${i})">ì§„í–‰</button>
                        <button class="btn btn-danger" style="margin-top:4px;padding:8px;" onclick="deleteMatch(${i})">ì‚­ì œ</button>
                    </div>
                `).join('');

                app.innerHTML = `
                    ${offline}
                    <div class="header"><h1>${state.currentProject.name}</h1></div>
                    <div class="card">
                        <button class="btn btn-success" onclick="addMatch()">â• ê²½ê¸°</button>
                        <hr>
                        ${html || '<p style="color:#999;">ê²½ê¸° ì—†ìŒ</p>'}
                        <button class="btn btn-secondary" onclick="goTo('admin')">â¬…ï¸</button>
                    </div>
                `;
            }

            // ê²½ê¸° ì§„í–‰
            else if (state.screen === 'match') {
                if (!state.currentMatch) { goTo('admin-project'); return; }

                const time = String(Math.floor(state.timerSeconds/60)).padStart(2,'0') + ':' + String(state.timerSeconds%60).padStart(2,'0');

                app.innerHTML = `
                    ${offline}
                    <div class="header">
                        <h1>${state.currentMatch.player1} vs ${state.currentMatch.player2}</h1>
                        <p>ì ìˆ˜ ì…ë ¥</p>
                    </div>
                    <div class="card">
                        <div class="score-display">${state.currentMatch.score1} : ${state.currentMatch.score2}</div>
                        ${state.timerRunning ? `<div class="timer">${time}</div>` : ''}
                        
                        <h3>${state.currentMatch.player1}</h3>
                        <button class="btn btn-success" onclick="score(1,1)">+1</button>
                        <button class="btn btn-danger" onclick="score(1,-1)">-1</button>
                        
                        <hr>
                        
                        <h3>${state.currentMatch.player2}</h3>
                        <button class="btn btn-success" onclick="score(2,1)">+1</button>
                        <button class="btn btn-danger" onclick="score(2,-1)">-1</button>
                        
                        <hr>
                        
                        <button class="btn btn-primary" onclick="toggleTimer()">${state.timerRunning?'â¸ï¸':'â–¶ï¸'} íƒ€ì´ë¨¸</button>
                        <button class="btn btn-info" onclick="saveMatch()">ğŸ’¾ ì €ì¥</button>
                        <button class="btn btn-secondary" onclick="goTo('admin-project')">â¬…ï¸</button>
                    </div>
                `;
            }

            // ì‹¬íŒ ë¡œê·¸ì¸
            else if (state.screen === 'referee-login') {
                app.innerHTML = `
                    ${offline}
                    <div class="header"><h1>ğŸ” ì‹¬íŒ</h1></div>
                    <div class="card">
                        <input type="password" id="pin" placeholder="PIN (í…ŒìŠ¤íŠ¸: 1234)" onkeypress="if(event.key==='Enter')loginRef()">
                        <button class="btn btn-success" onclick="loginRef()">ë¡œê·¸ì¸</button>
                        <button class="btn btn-secondary" onclick="goTo('home')">â¬…ï¸</button>
                    </div>
                `;
                setTimeout(() => document.getElementById('pin')?.focus(), 100);
            }

            // ì‹¬íŒ ê²½ê¸° ì„ íƒ
            else if (state.screen === 'referee') {
                let html = state.projects.flatMap(p => (p.matches||[]).map((m, i) => `
                    <div class="item ${m.inProgress ? 'match-live' : ''}">
                        <strong>${m.player1} vs ${m.player2}</strong>
                        <small>${p.name} | ${m.score1}:${m.score2}</small>
                        <button class="btn btn-info" style="margin-top:6px;padding:8px;" onclick="selectRefMatch('${p.id}',${i})">ì§„í–‰</button>
                    </div>
                `)).join('');

                app.innerHTML = `
                    ${offline}
                    <div class="header"><h1>ğŸ” ê²½ê¸° ì„ íƒ</h1></div>
                    <div class="card">
                        ${html || '<p style="color:#999;">ê²½ê¸° ì—†ìŒ</p>'}
                        <button class="btn btn-secondary" onclick="goTo('home')">â¬…ï¸</button>
                    </div>
                `;
            }

            // ê´€ëŒ
            else if (state.screen === 'viewer') {
                let html = state.projects.flatMap(p => (p.matches||[]).map((m, i) => `
                    <div class="item ${m.inProgress ? 'match-live' : ''}">
                        <strong>${m.player1} vs ${m.player2}</strong>
                        <small>${p.name}</small>
                        <div style="margin-top:6px; font-weight:bold; color:#1976d2;">ì ìˆ˜: ${m.score1}:${m.score2}</div>
                    </div>
                `)).join('');

                app.innerHTML = `
                    ${offline}
                    <div class="header"><h1>ğŸ‘ï¸ ê²½ê¸° ê´€ëŒ</h1></div>
                    <div class="card">
                        <h3>ì‹¤ì‹œê°„ ê²½ê¸°</h3>
                        ${html || '<p style="color:#999;">ê²½ê¸° ì—†ìŒ</p>'}
                        <button class="btn btn-secondary" onclick="goTo('home')">â¬…ï¸</button>
                    </div>
                `;
            }
        }

        // ==================== í•¨ìˆ˜ ====================
        function createProject() {
            const name = prompt('ëŒ€íšŒ ì´ë¦„:');
            if (!name) return;
            state.projects.push({
                id: Date.now().toString(),
                name: name,
                matches: []
            });
            saveData();
            goTo('admin');
        }

        function selectProject(i) {
            state.currentProject = state.projects[i];
            goTo('admin-project');
        }

        function addMatch() {
            const p1 = prompt('ì„ ìˆ˜ 1:');
            if (!p1) return;
            const p2 = prompt('ì„ ìˆ˜ 2:');
            if (!p2) return;
            
            if (!state.currentProject.matches) state.currentProject.matches = [];
            state.currentProject.matches.push({
                id: Date.now().toString(),
                player1: p1,
                player2: p2,
                score1: 0,
                score2: 0,
                inProgress: false
            });
            saveData();
            goTo('admin-project');
        }

        function selectMatch(i) {
            state.currentMatch = state.currentProject.matches[i];
            state.currentMatch.inProgress = true;
            state.timerSeconds = 0;
            state.timerRunning = false;
            saveData();
            goTo('match');
        }

        function deleteMatch(i) {
            if (confirm('ì‚­ì œ?')) {
                state.currentProject.matches.splice(i, 1);
                saveData();
                goTo('admin-project');
            }
        }

        function score(player, change) {
            if (player === 1) state.currentMatch.score1 = Math.max(0, state.currentMatch.score1 + change);
            else state.currentMatch.score2 = Math.max(0, state.currentMatch.score2 + change);
            render();
        }

        function toggleTimer() {
            if (state.timerRunning) {
                clearInterval(state.timerInterval);
                state.timerRunning = false;
            } else {
                state.timerRunning = true;
                state.timerInterval = setInterval(() => {
                    state.timerSeconds++;
                    render();
                }, 1000);
            }
            render();
        }

        function saveMatch() {
            saveData();
            alert('âœ… ì €ì¥ë¨');
            goTo('admin-project');
        }

        function loginRef() {
            const pin = document.getElementById('pin').value;
            if (pin === '1234') {
                goTo('referee');
            } else {
                alert('âŒ PIN í‹€ë¦¼');
            }
        }

        function selectRefMatch(projectId, matchIdx) {
            state.currentProject = state.projects.find(p => p.id === projectId);
            state.currentMatch = state.currentProject.matches[matchIdx];
            state.currentMatch.inProgress = true;
            state.timerSeconds = 0;
            state.timerRunning = false;
            saveData();
            goTo('match');
        }

        function syncData() {
            if (state.isOnline) saveData();
        }

        // ì‹œì‘
        window.addEventListener('load', () => {
            loadData();
            render();
        });
    </script>
</body>
</html>
