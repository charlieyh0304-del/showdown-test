<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ì‡¼ë‹¤ìš´ ì‹¬íŒ ì•± í”„ë¡œ - í”„ë¡œì íŠ¸ ê´€ë¦¬, ì‹¬íŒ ì •ë³´, íƒ€ì„ì•„ì›ƒ ê¸°ëŠ¥">
    <title>ì‡¼ë‹¤ìš´ ì‹¬íŒ ì•± PRO</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* í…Œë§ˆ ë³€ìˆ˜ */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border: #dadce0;
            --primary: #1a73e8;
            --primary-hover: #1557b0;
            --success: #34a853;
            --warning: #fbbc04;
            --danger: #ea4335;
            --shadow: rgba(0,0,0,0.1);
        }
        
        body.enhanced-contrast {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f0f0;
            --bg-card: #ffffff;
            --text-primary: #000000;
            --text-secondary: #333333;
            --border: #999999;
            --primary: #0066cc;
            --success: #228b22;
            --warning: #cc9900;
            --danger: #cc0000;
        }
        
        body.high-contrast {
            --bg-primary: #ffffff;
            --text-primary: #000000;
            --border: #000000;
            --primary: #0000ff;
            --success: #008000;
            --warning: #ff8c00;
            --danger: #ff0000;
        }
        
        body.inverted {
            --bg-primary: #000000;
            --bg-secondary: #1a1a1a;
            --bg-card: #000000;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border: #666666;
            --primary: #66b3ff;
            --success: #66ff66;
            --warning: #ffcc66;
            --danger: #ff6666;
        }
        
        body.dark {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-card: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border: #444444;
            --primary: #4d9eff;
            --success: #4ade80;
            --warning: #fbbf24;
            --danger: #f87171;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s, color 0.3s;
        }
        
        /* ìŠ¤í¬ë¦° ë¦¬ë” ì „ìš© (í™”ë©´ì— ë³´ì´ì§€ ì•ŠìŒ) */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        *:focus {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
        }
        
        .accessibility-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-bottom: 2px solid var(--border);
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 8px var(--shadow);
        }
        
        .accessibility-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .a11y-btn {
            min-width: 44px;
            min-height: 44px;
            padding: 8px 12px;
            border: 2px solid var(--border);
            background: var(--bg-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        .a11y-btn:hover, .a11y-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 70px 20px 20px;
            min-height: 100vh;
        }
        
        .header {
            text-align: center;
            padding: 24px;
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px var(--shadow);
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px var(--shadow);
            border: 1px solid var(--border);
        }
        
        .card h2 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
        }
        
        .btn {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            min-height: 48px;
            margin-bottom: 12px;
            transition: all 0.2s;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary { 
            background: var(--primary); 
            color: white;
            border-color: var(--primary);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
        }
        
        .btn-success { background: var(--success); color: white; border-color: var(--success); }
        .btn-warning { background: var(--warning); color: white; border-color: var(--warning); }
        .btn-danger { background: var(--danger); color: white; border-color: var(--danger); }
        
        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            margin: 8px 0;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-top: 12px;
            margin-bottom: 4px;
        }
        
        .score-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin: 24px 0;
        }
        
        .player-score {
            text-align: center;
        }
        
        .score-display {
            font-size: 72px;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }
        
        .player-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .serve-indicator {
            margin-top: 8px;
            font-size: 14px;
            color: var(--success);
            font-weight: 600;
        }
        
        .timeout-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }
        
        .timeout-btn {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--warning);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        
        .timeout-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .timeout-count {
            font-size: 12px;
        }
        
        .foul-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .foul-btn {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            min-height: 60px;
            background: var(--warning);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }
        
        .goal-btn {
            background: var(--success);
            grid-column: 1 / -1;
            min-height: 80px;
            font-size: 18px;
        }
        
        .action-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }
        
        .folder-item, .match-item {
            padding: 16px;
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 8px;
            margin: 12px 0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .folder-item:hover, .match-item:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .timer-display {
            font-size: 96px;
            font-weight: 700;
            color: var(--primary);
            margin: 24px 0;
            font-variant-numeric: tabular-nums;
        }
        
        .timer-display.warning {
            color: var(--danger);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-weight: 600;
            border: 2px solid var(--success);
            background: var(--bg-secondary);
            text-align: center;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 12px;
        }
        
        .info-item {
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
            border: 1px solid var(--border);
        }
        
        .info-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .info-value {
            font-weight: 600;
        }
        
        @media (max-width: 600px) {
            .score-display { font-size: 56px; }
            .timer-display { font-size: 72px; }
            .foul-grid { grid-template-columns: 1fr; }
            .info-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="accessibility-bar">
        <div style="font-weight: 600; font-size: 14px;">ì ‘ê·¼ì„±</div>
        <div class="accessibility-controls">
            <button class="a11y-btn" onclick="cycleTheme()" id="theme-btn">ëª¨ë“œ: ì¼ë°˜</button>
            <button class="a11y-btn" onclick="toggleVoice()" id="voice-btn">ğŸ”Š</button>
        </div>
    </div>

    <div id="app" class="container"></div>

    <!-- aria-live ì‹¤ì‹œê°„ ì•ˆë‚´ (í™”ë©´ì— ë³´ì´ì§€ ì•ŠìŒ, ìŠ¤í¬ë¦° ë¦¬ë”ë§Œ) -->
    <div aria-live="assertive" aria-atomic="true" class="sr-only" id="live-announcement"></div>

    <!-- íƒ€ì„ì•„ì›ƒ ëª¨ë‹¬ -->
    <div id="timeout-modal" class="modal">
        <div class="modal-content">
            <h2 id="timeout-title">íƒ€ì„ì•„ì›ƒ</h2>
            <div id="timer-display" class="timer-display">60</div>
            <button class="btn btn-danger" onclick="closeTimeout()" style="width:100%">íƒ€ì„ì•„ì›ƒ ì¢…ë£Œ</button>
        </div>
    </div>

    <script>
        // Firebase ì´ˆê¸°í™”
        const firebaseConfig = {
            apiKey: "AIzaSyAKv3QOpSg-hLnyXSnE299fHRV-akpPQCs",
            authDomain: "showdown1-838bf.firebaseapp.com",
            databaseURL: "https://showdown1-838bf-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "showdown1-838bf",
            storageBucket: "showdown1-838bf.firebasestorage.app",
            messagingSenderId: "379033064628",
            appId: "1:379033064628:web:252eef0e38b45859df73e1"
        };
        
        let database = null;
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('âœ… Firebase ì—°ê²°ë¨');
        } catch (error) {
            console.log('Firebase ì—°ê²° ì‹¤íŒ¨ - ë¡œì»¬ ëª¨ë“œ');
        }
        
        // ìŒì„± ì•ˆë‚´
        let voiceEnabled = localStorage.getItem('voice') !== 'false';
        let isTimeoutActive = false;
        
        function speak(text) {
            if (!voiceEnabled) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ko-KR';
            utterance.rate = 1.1;
            speechSynthesis.cancel();
            speechSynthesis.speak(utterance);
        }

        // aria-live ì‹¤ì‹œê°„ ì•ˆë‚´ (ìŠ¤í¬ë¦° ë¦¬ë”ìš©)
        function announce(text) {
            const liveRegion = document.getElementById('live-announcement');
            if (liveRegion) {
                liveRegion.textContent = text;
            }
        }

        // í…Œë§ˆ ìˆœí™˜
        const themes = [
            { id: 'normal', name: 'ì¼ë°˜' },
            { id: 'enhanced-contrast', name: 'ëª…ë„ëŒ€ë¹„' },
            { id: 'high-contrast', name: 'ê³ ëŒ€ë¹„' },
            { id: 'inverted', name: 'ìƒ‰ë°˜ì „' },
            { id: 'dark', name: 'ë‹¤í¬' }
        ];
        let currentThemeIndex = 0;

        function cycleTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            const theme = themes[currentThemeIndex];
            
            document.body.className = theme.id === 'normal' ? '' : theme.id;
            localStorage.setItem('theme', theme.id);
            localStorage.setItem('themeIndex', currentThemeIndex);
            
            document.getElementById('theme-btn').textContent = `ëª¨ë“œ: ${theme.name}`;
            speak(`${theme.name} ëª¨ë“œë¡œ ë³€ê²½ë¨`);
        }

        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            localStorage.setItem('voice', voiceEnabled);
            speak(voiceEnabled ? 'ìŒì„± ì•ˆë‚´ ì¼œì§' : 'ìŒì„± ì•ˆë‚´ êº¼ì§');
            document.getElementById('voice-btn').style.opacity = voiceEnabled ? '1' : '0.5';
        }

        // ë°ì´í„° êµ¬ì¡°
        let projects = [];
        let currentProject = null;
        let currentMatch = null;
        let screen = 'home';
        let timeoutTimer = null;
        let timeoutSeconds = 60;
        let isAuthenticated = false; // ì‹¬íŒ ì¸ì¦ ì—¬ë¶€
        
        // Firebaseì—ì„œ í”„ë¡œì íŠ¸ ë¡œë“œ
        function loadProjects() {
            try {
                if (!database) {
                    console.log('Firebase ë¯¸ì—°ê²° - ë¡œì»¬ ëª¨ë“œ');
                    projects = JSON.parse(localStorage.getItem('projects') || '[]');
                    render();
                    return;
                }
                console.log('Firebaseì—ì„œ í”„ë¡œì íŠ¸ ë¡œë“œ ì¤‘...');
                database.ref('projects').on('value', (snapshot) => {
                    const data = snapshot.val();
                    projects = data ? Object.keys(data).map(key => ({...data[key], firebaseKey: key})) : [];
                    console.log('ë¡œë“œëœ í”„ë¡œì íŠ¸:', projects.length);
                    
                    // í˜„ì¬ í”„ë¡œì íŠ¸/ê²½ê¸° ì—…ë°ì´íŠ¸
                    if (currentProject) {
                        const updatedProject = projects.find(p => p.firebaseKey === currentProject.firebaseKey);
                        if (updatedProject) {
                            currentProject = updatedProject;
                            if (currentMatch && currentProject.matches) {
                                const matchIndex = currentProject.matches.findIndex(m => m.id === currentMatch.id);
                                if (matchIndex >= 0) {
                                    currentMatch = currentProject.matches[matchIndex];
                                }
                            }
                        }
                    }
                    
                    if (screen !== 'match') {
                        render();
                    } else if (currentMatch) {
                        renderMatch();
                    }
                });
            } catch (error) {
                console.log('Firebase ë¡œë“œ ì‹¤íŒ¨ - ë¡œì»¬ ëª¨ë“œ:', error);
                projects = JSON.parse(localStorage.getItem('projects') || '[]');
                render();
            }
        }
        
        // Firebaseì— í”„ë¡œì íŠ¸ ì €ì¥
        function saveProjects() {
            try {
                if (database && currentProject && currentProject.firebaseKey) {
                    database.ref('projects/' + currentProject.firebaseKey).set(currentProject);
                    console.log('âœ… Firebase ì €ì¥ ì™„ë£Œ');
                } else {
                    // ë¡œì»¬ ì €ì¥
                    localStorage.setItem('projects', JSON.stringify(projects));
                    console.log('âœ… ë¡œì»¬ ì €ì¥ ì™„ë£Œ');
                }
            } catch (error) {
                console.error('ì €ì¥ ì—ëŸ¬:', error);
                localStorage.setItem('projects', JSON.stringify(projects));
            }
        }
        
        // ì´ˆê¸° ë¡œë“œ
        setTimeout(() => loadProjects(), 1000);


        const FOULS = [
            { id: 'irregular-serve', name: 'ë¶€ì • ì„œë¸Œ', points: 1 },
            { id: 'centerboard', name: 'ì„¼í„°ë³´ë“œ', points: 1 },
            { id: 'body-touch', name: 'ë°”ë””í„°ì¹˜', points: 1 },
            { id: 'out', name: 'ì•„ì›ƒ', points: 1 },
            { id: 'mask-touch', name: 'ê³ ê¸€í„°ì¹˜', points: 2 },
            { id: 'delay', name: 'ì§€ì—°í–‰ìœ„', points: 1 },
            { id: '2-second', name: '2ì´ˆë£°', points: 1 }
        ];

        function render() {
            const app = document.getElementById('app');
            
            if (screen === 'home') {
                app.innerHTML = `
                    <div class="header">
                        <h1>âš« ì‡¼ë‹¤ìš´ ì‹¬íŒ ì•± PRO</h1>
                        <p>ì‹¤ì‹œê°„ ë™ê¸°í™” Â· ì‹¬íŒ/ê´€ëŒ ëª¨ë“œ</p>
                    </div>
                    <div class="card">
                        <h2>ëª¨ë“œ ì„ íƒ</h2>
                        <p style="color:var(--text-secondary); margin-bottom:16px;">ì‚¬ìš© ëª©ì ì— ë§ëŠ” ëª¨ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                        <button type="button" role="button" class="btn btn-primary" onclick="selectRole('referee')" style="background:var(--success); margin-bottom:12px;" aria-label="ì‹¬íŒ ëª¨ë“œ ì„ íƒ - í”„ë¡œì íŠ¸ ìƒì„±, ê²½ê¸° ê´€ë¦¬, ë“ì  ì…ë ¥">
                            ğŸ” ì‹¬íŒ ëª¨ë“œ
                        </button>
                        <p style="font-size:14px; color:var(--text-secondary); margin-bottom:20px;">
                            í”„ë¡œì íŠ¸ ìƒì„±, ê²½ê¸° ê´€ë¦¬, ë“ì  ì…ë ¥
                        </p>
                        <button type="button" role="button" class="btn btn-primary" onclick="selectRole('viewer')" style="background:var(--primary);" aria-label="ê´€ëŒ ëª¨ë“œ ì„ íƒ - ì‹¤ì‹œê°„ ì ìˆ˜ í™•ì¸, ê²½ê¸° ê¸°ë¡ ë³´ê¸°">
                            ğŸ‘ï¸ ê´€ëŒ ëª¨ë“œ
                        </button>
                        <p style="font-size:14px; color:var(--text-secondary); margin-top:8px;">
                            ì‹¤ì‹œê°„ ì ìˆ˜ í™•ì¸, ê²½ê¸° ê¸°ë¡ ë³´ê¸°
                        </p>
                    </div>
                `;
            }
            else if (screen === 'referee-home') {
                app.innerHTML = `
                    <div class="header">
                        <h1>ğŸ” ì‹¬íŒ ëª¨ë“œ</h1>
                        <p>í”„ë¡œì íŠ¸ ê´€ë¦¬ Â· ë“ì  ì…ë ¥</p>
                    </div>
                    <div class="card">
                        <h2>í”„ë¡œì íŠ¸ ê´€ë¦¬</h2>
                        <button type="button" role="button" class="btn btn-primary" onclick="goTo('create-project')" aria-label="ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±">ğŸ“ ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±</button>
                        <button type="button" role="button" class="btn btn-primary" onclick="goTo('project-list')" aria-label="í”„ë¡œì íŠ¸ ëª©ë¡ ë³´ê¸°">ğŸ“‚ í”„ë¡œì íŠ¸ ëª©ë¡</button>
                        <button type="button" role="button" class="btn" onclick="goTo('home')" style="margin-top:16px;" aria-label="ëª¨ë“œ ì„ íƒ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°">â† ëª¨ë“œ ì„ íƒìœ¼ë¡œ</button>
                    </div>
                `;
            }
            else if (screen === 'viewer-home') {
                app.innerHTML = `
                    <div class="header" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h1>ğŸ‘ï¸ ê´€ëŒ ëª¨ë“œ</h1>
                        <p>ì‹¤ì‹œê°„ ì ìˆ˜ í™•ì¸</p>
                    </div>
                    <div class="card">
                        <div style="background:#fff3cd; border-left:4px solid #fbbc04; padding:12px; border-radius:8px; margin-bottom:16px;">
                            <strong>ğŸ“º ê´€ëŒ ì „ìš©</strong><br>
                            <span style="font-size:14px;">ì ìˆ˜ í™•ì¸ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. ë“ì  ì…ë ¥ì€ ì‹¬íŒ ëª¨ë“œì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</span>
                        </div>
                        <button type="button" role="button" class="btn btn-primary" onclick="goTo('project-list')" aria-label="í”„ë¡œì íŠ¸ ëª©ë¡ ë³´ê¸°">ğŸ“‚ í”„ë¡œì íŠ¸ ëª©ë¡ ë³´ê¸°</button>
                        <button type="button" role="button" class="btn" onclick="goTo('home')" style="margin-top:16px;" aria-label="ëª¨ë“œ ì„ íƒ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°">â† ëª¨ë“œ ì„ íƒìœ¼ë¡œ</button>
                    </div>
                `;
            }
            else if (screen === 'create-project') {
                app.innerHTML = `
                    <div class="card">
                        <h2>ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±</h2>
                        <label for="project-name">í”„ë¡œì íŠ¸ëª… *</label>
                        <input type="text" id="project-name" placeholder="ì˜ˆ: 2025 ì „êµ­ì¥ì• ì¸ì²´ìœ¡ëŒ€íšŒ">
                        <label for="project-date">ë‚ ì§œ (ì„ íƒì‚¬í•­)</label>
                        <input type="text" id="project-date" placeholder="ì˜ˆ: 2025-03-15 ë˜ëŠ” 3ì›” 15ì¼">
                        <label for="project-location">ì¥ì†Œ (ì„ íƒì‚¬í•­)</label>
                        <input type="text" id="project-location" placeholder="ì˜ˆ: ì„œìš¸ì¢…í•©ìš´ë™ì¥">
                        <label for="project-desc">ì„¤ëª… (ì„ íƒì‚¬í•­)</label>
                        <textarea id="project-desc" rows="3" placeholder="í”„ë¡œì íŠ¸ ì„¤ëª…"></textarea>
                        <div class="action-row">
                            <button type="button" role="button" class="btn btn-danger" onclick="goTo('referee-home')" aria-label="ì·¨ì†Œí•˜ê³  ëŒì•„ê°€ê¸°">ì·¨ì†Œ</button>
                            <button type="button" role="button" class="btn btn-primary" onclick="createProject()" aria-label="í”„ë¡œì íŠ¸ ìƒì„±">ìƒì„±</button>
                        </div>
                    </div>
                `;
            }
            else if (screen === 'project-list') {
                const isReferee = (userRole === 'referee');
                const backScreen = isReferee ? 'referee-home' : 'viewer-home';
                
                let projectListHTML = '';
                if (projects.length === 0) {
                    projectListHTML = '<p style="text-align:center; padding:40px; color:var(--text-secondary)">ìƒì„±ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    projectListHTML = projects.map((p, i) => `
                        <div class="folder-item" onclick="selectProject(${i})" role="button" tabindex="0" aria-label="${p.name} í”„ë¡œì íŠ¸ ì—´ê¸°, ê²½ê¸° ${p.matches?.length || 0}ê°œ">
                            <h4>ğŸ“ ${p.name}</h4>
                            <p style="color:var(--text-secondary); font-size:14px; margin-top:4px">
                                ${p.date || 'ë‚ ì§œ ë¯¸ì •'} Â· ${p.location || 'ì¥ì†Œ ë¯¸ì •'} Â· ê²½ê¸° ${p.matches?.length || 0}ê°œ
                            </p>
                        </div>
                    `).join('');
                }
                
                // í¸ì§‘ ë²„íŠ¼ (ì‹¬íŒ ëª¨ë“œ + í”„ë¡œì íŠ¸ ìˆì„ ë•Œë§Œ)
                const editButtonHTML = (isReferee && projects.length > 0) ? 
                    '<button type="button" role="button" class="btn btn-danger" onclick="goTo(\'edit-projects\')" aria-label="í”„ë¡œì íŠ¸ í¸ì§‘ ëª¨ë“œ">ğŸ—‘ï¸ í¸ì§‘</button>' : '';
                
                // ê´€ëŒ ëª¨ë“œ ì•ˆë‚´
                const viewerNoticeHTML = !isReferee ? 
                    '<div style="background:#e3f2fd; padding:12px; border-radius:8px; margin-bottom:16px;"><span style="color:#1565c0;">ğŸ‘ï¸ ê´€ëŒ ëª¨ë“œ - í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì—¬ ê²½ê¸°ë¥¼ í™•ì¸í•˜ì„¸ìš”</span></div>' : '';
                
                app.innerHTML = `
                    <div class="card">
                        <h2>í”„ë¡œì íŠ¸ ëª©ë¡</h2>
                        ${viewerNoticeHTML}
                        ${projectListHTML}
                        <div style="display:flex; gap:12px; margin-top:16px; flex-wrap:wrap;">
                            <button type="button" role="button" class="btn" onclick="goTo('${backScreen}')" aria-label="ë’¤ë¡œ ê°€ê¸°">â† ë’¤ë¡œ</button>
                            ${editButtonHTML}
                        </div>
                    </div>
                `;
            }
            else if (screen === 'edit-projects') {
                // í”„ë¡œì íŠ¸ í¸ì§‘ ëª¨ë“œ (ì‚­ì œìš©)
                let editListHTML = '';
                if (projects.length === 0) {
                    editListHTML = '<p style="text-align:center; padding:40px; color:var(--text-secondary)">ì‚­ì œí•  í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    editListHTML = projects.map((p, i) => `
                        <div class="folder-item" style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h4>ğŸ“ ${p.name}</h4>
                                <p style="color:var(--text-secondary); font-size:14px; margin-top:4px">
                                    ê²½ê¸° ${p.matches?.length || 0}ê°œ
                                </p>
                            </div>
                            <button type="button" role="button" onclick="deleteProject(${i})" 
                                    aria-label="${p.name} í”„ë¡œì íŠ¸ ì‚­ì œ"
                                    class="btn btn-danger" style="min-width:auto; padding:8px 16px;">
                                ì‚­ì œ
                            </button>
                        </div>
                    `).join('');
                }
                
                app.innerHTML = `
                    <div class="card">
                        <h2>ğŸ—‘ï¸ í”„ë¡œì íŠ¸ í¸ì§‘</h2>
                        <p style="color:var(--text-secondary); margin-bottom:16px;">ì‚­ì œí•  í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                        ${editListHTML}
                        <button type="button" role="button" class="btn btn-primary" onclick="goTo('project-list')" style="margin-top:16px;" aria-label="í¸ì§‘ ì™„ë£Œ">âœ“ í¸ì§‘ ì™„ë£Œ</button>
                    </div>
                `;
            }
            else if (screen === 'project-detail') {
                const active = currentProject.matches ? currentProject.matches.filter(m => m.status === 'active') : [];
                const finished = currentProject.matches ? currentProject.matches.filter(m => m.status === 'finished') : [];
                const isReferee = (userRole === 'referee');
                const hasMatches = (active.length > 0 || finished.length > 0);
                
                let activeMatchesHTML = '';
                if (active.length > 0) {
                    activeMatchesHTML = `
                        <h3 style="color:var(--success); margin:16px 0">ì§„í–‰ ì¤‘ì¸ ê²½ê¸°</h3>
                        ${active.map(m => {
                            const idx = currentProject.matches.indexOf(m);
                            return `
                                <div class="match-item" onclick="selectMatch(${idx})" role="button" tabindex="0" aria-label="${m.player1Name} vs ${m.player2Name} ê²½ê¸° ì—´ê¸°">
                                    <h4>${m.player1Name} vs ${m.player2Name}</h4>
                                    <p style="color:var(--text-secondary); font-size:14px; margin-top:4px">
                                        ì„¸íŠ¸ ${m.currentSet}/${m.sets} Â· ${m.setScores[m.currentSet - 1].player1}-${m.setScores[m.currentSet - 1].player2} Â· ì£¼ì‹¬: ${m.mainReferee || 'ë¯¸ì •'}
                                    </p>
                                </div>
                            `;
                        }).join('')}
                    `;
                }
                
                let finishedMatchesHTML = '';
                if (finished.length > 0) {
                    finishedMatchesHTML = `
                        <h3 style="color:var(--text-secondary); margin:24px 0 16px">ì™„ë£Œëœ ê²½ê¸°</h3>
                        ${finished.map(m => {
                            const idx = currentProject.matches.indexOf(m);
                            return `
                                <div class="match-item" onclick="selectMatch(${idx})" role="button" tabindex="0" aria-label="${m.player1Name} vs ${m.player2Name} ê²½ê¸° ì—´ê¸°">
                                    <h4>${m.player1Name} vs ${m.player2Name}</h4>
                                    <p style="color:var(--text-secondary); font-size:14px; margin-top:4px">
                                        ì™„ë£Œ Â· ì£¼ì‹¬: ${m.mainReferee || 'ë¯¸ì •'}
                                    </p>
                                </div>
                            `;
                        }).join('')}
                    `;
                }
                
                let noMatchesHTML = '';
                if (!hasMatches) {
                    noMatchesHTML = '<p style="text-align:center; padding:20px; color:var(--text-secondary)">ìƒì„±ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
                
                // ë¯¸ë¦¬ ê³„ì‚°
                const titleHTML = isReferee ? 'ê²½ê¸° ê´€ë¦¬' : 'ê²½ê¸° ëª©ë¡';
                const createButtonHTML = isReferee ? 
                    '<button type="button" role="button" class="btn btn-primary" onclick="goTo(\'create-match\')" aria-label="ìƒˆ ê²½ê¸° ìƒì„±">â• ìƒˆ ê²½ê¸° ìƒì„±</button>' : 
                    '<div style="background:#e8f5e9; padding:12px; border-radius:8px; margin-bottom:16px;"><span style="color:#2e7d32;">ğŸ‘ï¸ ê´€ëŒ ëª¨ë“œ - ê²½ê¸°ë¥¼ ì„ íƒí•˜ì—¬ ì ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”</span></div>';
                const editButtonHTML = (isReferee && hasMatches) ? 
                    '<button type="button" role="button" class="btn btn-danger" onclick="goTo(\'edit-matches\')" aria-label="ê²½ê¸° í¸ì§‘ ëª¨ë“œ">ğŸ—‘ï¸ í¸ì§‘</button>' : '';
                
                app.innerHTML = `
                    <div class="card">
                        <h2>ğŸ“ ${currentProject.name}</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="info-label">ë‚ ì§œ</div>
                                <div class="info-value">${currentProject.date || 'ë¯¸ì •'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">ì¥ì†Œ</div>
                                <div class="info-value">${currentProject.location || 'ë¯¸ì •'}</div>
                            </div>
                        </div>
                        ${currentProject.desc ? `<p style="margin-top:12px; color:var(--text-secondary)">${currentProject.desc}</p>` : ''}
                    </div>
                    <div class="card">
                        <h2>${titleHTML}</h2>
                        ${createButtonHTML}
                        ${noMatchesHTML}
                        ${activeMatchesHTML}
                        ${finishedMatchesHTML}
                        <div style="display:flex; gap:12px; margin-top:16px; flex-wrap:wrap;">
                            <button type="button" role="button" class="btn" onclick="goTo('project-list')" aria-label="í”„ë¡œì íŠ¸ ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°">â† í”„ë¡œì íŠ¸ ëª©ë¡</button>
                            ${editButtonHTML}
                        </div>
                    </div>
                `;
            }
            else if (screen === 'edit-matches') {
                // ê²½ê¸° í¸ì§‘ ëª¨ë“œ (ì‚­ì œìš©)
                const allMatches = currentProject.matches || [];
                
                let editMatchesHTML = '';
                if (allMatches.length === 0) {
                    editMatchesHTML = '<p style="text-align:center; padding:40px; color:var(--text-secondary)">ì‚­ì œí•  ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    editMatchesHTML = allMatches.map((m, i) => `
                        <div class="match-item" style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h4>${m.player1Name} vs ${m.player2Name}</h4>
                                <p style="color:var(--text-secondary); font-size:14px; margin-top:4px">
                                    ${m.status === 'finished' ? 'ì™„ë£Œ' : `ì„¸íŠ¸ ${m.currentSet}/${m.sets}`}
                                </p>
                            </div>
                            <button type="button" role="button" onclick="deleteMatchDirect(${i})" 
                                    aria-label="${m.player1Name} vs ${m.player2Name} ê²½ê¸° ì‚­ì œ"
                                    class="btn btn-danger" style="min-width:auto; padding:8px 16px;">
                                ì‚­ì œ
                            </button>
                        </div>
                    `).join('');
                }
                
                app.innerHTML = `
                    <div class="card">
                        <h2>ğŸ—‘ï¸ ê²½ê¸° í¸ì§‘ - ${currentProject.name}</h2>
                        <p style="color:var(--text-secondary); margin-bottom:16px;">ì‚­ì œí•  ê²½ê¸°ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
                        ${editMatchesHTML}
                        <button type="button" role="button" class="btn btn-primary" onclick="goTo('project-detail')" style="margin-top:16px;" aria-label="í¸ì§‘ ì™„ë£Œ">âœ“ í¸ì§‘ ì™„ë£Œ</button>
                    </div>
                `;
            }
            else if (screen === 'create-match') {
                app.innerHTML = `
                    <div class="card">
                        <h2>ìƒˆ ê²½ê¸° ìƒì„±</h2>
                        
                        <h3 style="margin-top:20px">ê²½ê¸° ì •ë³´</h3>
                        <label>ê²½ê¸° ìœ í˜• *</label>
                        <select id="match-type">
                            <option value="individual">ê°œì¸ì „</option>
                            <option value="team">íŒ€ì „</option>
                        </select>
                        <div id="sets-div">
                            <label>ì„¸íŠ¸ ìˆ˜ *</label>
                            <select id="sets">
                                <option value="3">3ì„¸íŠ¸</option>
                                <option value="5">5ì„¸íŠ¸</option>
                            </select>
                        </div>
                        
                        <h3 style="margin-top:20px">ì„ ìˆ˜ ì •ë³´</h3>
                        <label id="player1-label">ì„ ìˆ˜ 1 ì´ë¦„ *</label>
                        <input type="text" id="player1" placeholder="ì„ ìˆ˜ 1">
                        <label id="player2-label">ì„ ìˆ˜ 2 ì´ë¦„ *</label>
                        <input type="text" id="player2" placeholder="ì„ ìˆ˜ 2">
                        
                        <div id="team-lineup" style="display:none;">
                            <h3 style="margin-top:20px">íŒ€ ë¼ì¸ì—…</h3>
                            <label id="team1-lineup-label">íŒ€ 1 ë¼ì¸ì—… (3ëª…) *</label>
                            <input type="text" id="team1-player1" placeholder="ì„ ìˆ˜ 1 ì´ë¦„">
                            <input type="text" id="team1-player2" placeholder="ì„ ìˆ˜ 2 ì´ë¦„">
                            <input type="text" id="team1-player3" placeholder="ì„ ìˆ˜ 3 ì´ë¦„">
                            <label id="team2-lineup-label">íŒ€ 2 ë¼ì¸ì—… (3ëª…) *</label>
                            <input type="text" id="team2-player1" placeholder="ì„ ìˆ˜ 1 ì´ë¦„">
                            <input type="text" id="team2-player2" placeholder="ì„ ìˆ˜ 2 ì´ë¦„">
                            <input type="text" id="team2-player3" placeholder="ì„ ìˆ˜ 3 ì´ë¦„">
                        </div>
                        
                        <h3 style="margin-top:20px">ì‹¬íŒ ì •ë³´</h3>
                        <label>ì£¼ì‹¬</label>
                        <input type="text" id="main-referee" placeholder="ì£¼ì‹¬ ì´ë¦„">
                        <label>ë¶€ì‹¬</label>
                        <input type="text" id="assistant-referee" placeholder="ë¶€ì‹¬ ì´ë¦„">
                        
                        <h3 style="margin-top:20px">ì½”ì¹˜ ì •ë³´</h3>
                        <label id="coach1-label">ì„ ìˆ˜ 1 ì½”ì¹˜</label>
                        <input type="text" id="coach1" placeholder="ì½”ì¹˜ ì´ë¦„">
                        <label id="coach2-label">ì„ ìˆ˜ 2 ì½”ì¹˜</label>
                        <input type="text" id="coach2" placeholder="ì½”ì¹˜ ì´ë¦„">
                        
                        <h3 style="margin-top:20px">ğŸ” ë³´ì•ˆ ì„¤ì •</h3>
                        <label>ì‹¬íŒ PIN (6ìë¦¬ ì´ìƒ) *</label>
                        <input type="password" id="referee-pin" placeholder="6ìë¦¬ ì´ìƒ ìˆ«ì" maxlength="8" pattern="[0-9]{6,8}">
                        <p style="font-size:12px; color:var(--text-secondary); margin-top:4px;">
                            âš ï¸ ë“ì  ì…ë ¥ ì‹œ í•„ìš”í•©ë‹ˆë‹¤. ìŠì§€ ë§ˆì„¸ìš”!
                        </p>
                        
                        <div class="action-row">
                            <button type="button" class="btn btn-danger" onclick="goTo('project-detail')">ì·¨ì†Œ</button>
                            <button type="button" class="btn btn-primary" onclick="createMatch()">ê²½ê¸° ì‹œì‘</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('match-type').onchange = (e) => {
                    const isTeam = e.target.value === 'team';
                    document.getElementById('sets-div').style.display = isTeam ? 'none' : 'block';
                    document.getElementById('team-lineup').style.display = isTeam ? 'block' : 'none';
                    document.getElementById('player1-label').textContent = isTeam ? 'íŒ€ 1 ì´ë¦„ *' : 'ì„ ìˆ˜ 1 ì´ë¦„ *';
                    document.getElementById('player2-label').textContent = isTeam ? 'íŒ€ 2 ì´ë¦„ *' : 'ì„ ìˆ˜ 2 ì´ë¦„ *';
                    document.getElementById('coach1-label').textContent = isTeam ? 'íŒ€ 1 ì½”ì¹˜' : 'ì„ ìˆ˜ 1 ì½”ì¹˜';
                    document.getElementById('coach2-label').textContent = isTeam ? 'íŒ€ 2 ì½”ì¹˜' : 'ì„ ìˆ˜ 2 ì½”ì¹˜';
                };
            }
            else if (screen === 'match') {
                renderMatch();
            }
        }

        function renderMatch() {
            const app = document.getElementById('app');
            
            // currentMatch í™•ì¸
            if (!currentMatch) {
                app.innerHTML = `
                    <div class="card">
                        <h2>âš ï¸ ì˜¤ë¥˜</h2>
                        <p>ê²½ê¸° ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                        <button type="button" class="btn btn-primary" onclick="goTo('project-detail')">ê²½ê¸° ëª©ë¡ìœ¼ë¡œ</button>
                    </div>
                `;
                return;
            }
            
            // ì™„ë£Œëœ ê²½ê¸°ëŠ” ê¸°ë¡ë§Œ í‘œì‹œ
            if (currentMatch.status === 'finished') {
                renderFinishedMatch();
                return;
            }
            
            const set = currentMatch.setScores[currentMatch.currentSet - 1];
            const canEnd = Math.max(set.player1, set.player2) >= currentMatch.winScore && 
                          Math.abs(set.player1 - set.player2) >= 2;
            
            app.innerHTML = `
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <div style="font-weight:600;">ì„¸íŠ¸ ${currentMatch.currentSet}/${currentMatch.sets}</div>
                        <div style="display:flex; gap:12px; align-items:center;">
                            ${isAuthenticated ? 
                                '<span style="background:var(--success); color:white; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:600;">ğŸ”“ ì‹¬íŒ ëª¨ë“œ</span>' : 
                                '<span style="background:var(--warning); color:white; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:600;">ğŸ‘ï¸ ê´€ëŒ ëª¨ë“œ</span>'
                            }
                            <div style="font-size:12px; color:var(--text-secondary)">ì£¼ì‹¬: ${currentMatch.mainReferee || 'ë¯¸ì •'}</div>
                        </div>
                    </div>
                    
                    <div class="score-grid">
                        <div class="player-score">
                            <div class="player-name">${currentMatch.player1Name}</div>
                            <div class="score-display">${set.player1}</div>
                            ${currentMatch.team1Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team1Lineup.join(', ')}</div>` : ''}
                        </div>
                        <div style="font-size:24px; font-weight:700; color:var(--text-secondary)">VS</div>
                        <div class="player-score">
                            <div class="player-name">${currentMatch.player2Name}</div>
                            <div class="score-display">${set.player2}</div>
                            ${currentMatch.team2Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team2Lineup.join(', ')}</div>` : ''}
                        </div>
                    </div>
                    
                    <div style="text-align:center; padding:12px; background:var(--bg-secondary); border-radius:8px; margin-bottom:16px;">
                        <div class="serve-indicator">ğŸ¾ ${currentMatch.currentServe === 'player1' ? currentMatch.player1Name : currentMatch.player2Name} - ì„œë¸Œ ${currentMatch.serveCount + 1}íšŒì°¨</div>
                    </div>
                    
                    <h3 style="margin-bottom:8px;">â±ï¸ íƒ€ì„ì•„ì›ƒ</h3>
                    <div class="timeout-section">
                        <button class="timeout-btn" onclick="startTimeout('player1')" ${currentMatch.timeouts.player1 === 0 || isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player1Name} íƒ€ì„ì•„ì›ƒ
                            <span class="timeout-count">ë‚¨ì€ íšŸìˆ˜: ${currentMatch.timeouts.player1}</span>
                        </button>
                        <button class="timeout-btn" onclick="startTimeout('player2')" ${currentMatch.timeouts.player2 === 0 || isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player2Name} íƒ€ì„ì•„ì›ƒ
                            <span class="timeout-count">ë‚¨ì€ íšŸìˆ˜: ${currentMatch.timeouts.player2}</span>
                        </button>
                    </div>
                    
                    <h3 style="margin-top:24px; margin-bottom:12px;">ë“ì  ê¸°ë¡</h3>
                    
                    <!-- ê³¨ ë“ì  (ì¢Œìš° ë°°ì¹˜) -->
                    <div class="foul-grid">
                        <button class="foul-btn goal-btn" onclick="addScore('player1', 2, '${currentMatch.player1Name} ê³¨')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ê³¨ +2ì 
                        </button>
                        <button class="foul-btn goal-btn" onclick="addScore('player2', 2, '${currentMatch.player2Name} ê³¨')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ê³¨ +2ì 
                        </button>
                    </div>
                    
                    <!-- íŒŒìš¸ (ìƒëŒ€ ë“ì ) -->
                    <h4 style="margin:16px 0 8px; font-size:14px; color:var(--text-secondary);">íŒŒìš¸ (ìƒëŒ€ ë“ì )</h4>
                    
                    <!-- ë¶€ì • ì„œë¸Œ +1ì  -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} ë¶€ì • ì„œë¸Œ')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ë¶€ì • ì„œë¸Œ +1ì 
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} ë¶€ì • ì„œë¸Œ')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ë¶€ì • ì„œë¸Œ +1ì 
                        </button>
                    </div>
                    
                    <!-- ì„¼í„°ë³´ë“œ +1ì  -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} ì„¼í„°ë³´ë“œ')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ì„¼í„°ë³´ë“œ +1ì 
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} ì„¼í„°ë³´ë“œ')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ì„¼í„°ë³´ë“œ +1ì 
                        </button>
                    </div>
                    
                    <!-- ë°”ë””í„°ì¹˜ +1ì  -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} ë°”ë””í„°ì¹˜')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ë°”ë””í„°ì¹˜ +1ì 
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} ë°”ë””í„°ì¹˜')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ë°”ë””í„°ì¹˜ +1ì 
                        </button>
                    </div>
                    
                    <!-- ì•„ì›ƒ +1ì  -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} ì•„ì›ƒ')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ì•„ì›ƒ +1ì 
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} ì•„ì›ƒ')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ì•„ì›ƒ +1ì 
                        </button>
                    </div>
                    
                    <!-- ê³ ê¸€í„°ì¹˜ +2ì  (ì¤‘ìš”!) -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 2, '${currentMatch.player1Name} ê³ ê¸€í„°ì¹˜')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ê³ ê¸€í„°ì¹˜ +2ì 
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 2, '${currentMatch.player2Name} ê³ ê¸€í„°ì¹˜')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ê³ ê¸€í„°ì¹˜ +2ì 
                        </button>
                    </div>
                    
                    <!-- ì§€ì—°í–‰ìœ„ +1ì  -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} ì§€ì—°í–‰ìœ„')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>ì§€ì—°í–‰ìœ„ +1ì 
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} ì§€ì—°í–‰ìœ„')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>ì§€ì—°í–‰ìœ„ +1ì 
                        </button>
                    </div>
                    
                    <!-- 2ì´ˆë£° +1ì  -->
                    <div class="foul-grid">
                        <button class="foul-btn" onclick="addScore('player2', 1, '${currentMatch.player1Name} 2ì´ˆë£°')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player1Name}<br>2ì´ˆë£° +1ì 
                        </button>
                        <button class="foul-btn" onclick="addScore('player1', 1, '${currentMatch.player2Name} 2ì´ˆë£°')" ${isTimeoutActive ? 'disabled' : ''}>
                            ${currentMatch.player2Name}<br>2ì´ˆë£° +1ì 
                        </button>
                    </div>
                    
                    <div class="action-row">
                        <button class="btn btn-danger" onclick="undo()" ${currentMatch.history.length === 0 ? 'disabled' : ''}>â†©ï¸ ì·¨ì†Œ</button>
                        <button class="btn btn-success" onclick="endSet()">${currentMatch.currentSet < currentMatch.sets ? 'ì„¸íŠ¸ ì¢…ë£Œ' : 'ê²½ê¸° ì¢…ë£Œ'}</button>
                    </div>
                    <button class="btn" onclick="goTo('project-detail')" style="margin-top:12px">â† ê²½ê¸° ëª©ë¡</button>
                </div>
                
                ${currentMatch.history.length > 0 ? `
                    <div class="card">
                        <h2>ê²½ê¸° ê¸°ë¡</h2>
                        <div style="margin-bottom:12px; display:flex; gap:8px;">
                            <button class="btn" onclick="toggleHistoryOrder()" id="history-order-btn" style="font-size:12px; padding:6px 12px;">ìµœì‹ ìˆœ â†“</button>
                        </div>
                        <div id="match-history">
                            ${currentMatch.history.slice(0, 5).map(h => {
                                // ì•¡ì…˜ ì„¤ëª… ìƒì„±
                                let actionDesc = '';
                                if (h.type.includes('ê³¨')) {
                                    actionDesc = `${h.player} ê³¨`;
                                } else {
                                    // íŒŒìš¸: "í™ê¸¸ë™ ë¶€ì •ì„œë¸Œ" í˜•íƒœì—ì„œ íŒŒìš¸í•œ ì‚¬ëŒê³¼ íŒŒìš¸ ì¢…ë¥˜ ì¶”ì¶œ
                                    const foulType = h.type.split(' ').slice(1).join(' ');
                                    actionDesc = `${h.actionPlayer || h.type.split(' ')[0]} ${foulType} (${h.player} ë“ì )`;
                                }
                                
                                return `
                                <div style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:6px;">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                        <span style="font-size:12px; color:var(--text-secondary);">${h.time} - ${h.server || h.player} ì„œë¸Œ ${h.serveNumber || ''}íšŒì°¨</span>
                                        ${h.scoreBefore ? `<span style="font-size:12px; color:var(--text-secondary);">(${h.scoreBefore.player1}:${h.scoreBefore.player2})</span>` : ''}
                                    </div>
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <span>${actionDesc}</span>
                                        <span style="font-weight:700; color:var(--primary);">${h.points}ì  ë“ì </span>
                                    </div>
                                    ${h.scoreAfter ? `
                                        <div style="margin-top:6px; padding-top:6px; border-top:1px solid var(--border);">
                                            <span style="font-size:13px; font-weight:600; color:var(--success);">â†’ ìŠ¤ì½”ì–´: ${h.scoreAfter.player1}:${h.scoreAfter.player2}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function renderFinishedMatch() {
            const app = document.getElementById('app');
            
            // ì„¸íŠ¸ë³„ ì ìˆ˜ ê³„ì‚°
            const setResults = currentMatch.setScores.map((s, idx) => {
                const winner = s.player1 > s.player2 ? currentMatch.player1Name : currentMatch.player2Name;
                return `ì„¸íŠ¸ ${idx + 1}: ${s.player1}-${s.player2} (${winner} ìŠ¹)`;
            }).join(' | ');
            
            // ìµœì¢… ì ìˆ˜
            const finalSet = currentMatch.setScores[currentMatch.setScores.length - 1];
            const winner = currentMatch.setScores.filter((s, idx) => idx < currentMatch.setScores.length && s.player1 > s.player2).length > 
                          currentMatch.setScores.filter((s, idx) => idx < currentMatch.setScores.length && s.player2 > s.player1).length 
                          ? currentMatch.player1Name : currentMatch.player2Name;
            
            app.innerHTML = `
                <div class="card">
                    <div style="text-align:center; padding:16px; background:var(--success); color:white; border-radius:8px; margin-bottom:16px;">
                        <h2 style="margin:0; color:white;">âœ… ê²½ê¸° ì¢…ë£Œ</h2>
                        <div style="font-size:18px; margin-top:8px;">ìŠ¹ì: ${winner}</div>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                        <div style="font-weight:600;">ê²½ê¸° ì •ë³´</div>
                        <div style="font-size:12px; color:var(--text-secondary)">ì£¼ì‹¬: ${currentMatch.mainReferee || 'ë¯¸ì •'}</div>
                    </div>
                    
                    <div class="score-grid">
                        <div class="player-score">
                            <div class="player-name">${currentMatch.player1Name}</div>
                            <div class="score-display">${finalSet.player1}</div>
                            ${currentMatch.team1Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team1Lineup.join(', ')}</div>` : ''}
                        </div>
                        <div style="font-size:24px; font-weight:700; color:var(--text-secondary)">VS</div>
                        <div class="player-score">
                            <div class="player-name">${currentMatch.player2Name}</div>
                            <div class="score-display">${finalSet.player2}</div>
                            ${currentMatch.team2Lineup ? `<div style="font-size:12px; color:var(--text-secondary); margin-top:8px;">${currentMatch.team2Lineup.join(', ')}</div>` : ''}
                        </div>
                    </div>
                    
                    <div style="padding:12px; background:var(--bg-secondary); border-radius:8px; margin-top:16px;">
                        <div style="font-size:14px; font-weight:600; margin-bottom:8px;">ì„¸íŠ¸ë³„ ê²°ê³¼</div>
                        <div style="font-size:14px;">${setResults}</div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="goTo('project-detail')" style="margin-top:16px">â† ê²½ê¸° ëª©ë¡ìœ¼ë¡œ</button>
                </div>
                
                ${currentMatch.history.length > 0 ? `
                    <div class="card">
                        <h2>ì „ì²´ ê²½ê¸° ê¸°ë¡</h2>
                        <div style="margin-bottom:12px; display:flex; gap:8px;">
                            <button class="btn" onclick="toggleFinishedHistoryOrder()" id="finished-history-order-btn" style="font-size:12px; padding:6px 12px;">ìµœì‹ ìˆœ â†“</button>
                        </div>
                        <div id="finished-match-history">
                            ${currentMatch.history.map(h => {
                                // ì•¡ì…˜ ì„¤ëª… ìƒì„±
                                let actionDesc = '';
                                if (h.type.includes('ê³¨')) {
                                    actionDesc = `${h.player} ê³¨`;
                                } else {
                                    // íŒŒìš¸: "í™ê¸¸ë™ ë¶€ì •ì„œë¸Œ" í˜•íƒœì—ì„œ íŒŒìš¸í•œ ì‚¬ëŒê³¼ íŒŒìš¸ ì¢…ë¥˜ ì¶”ì¶œ
                                    const foulType = h.type.split(' ').slice(1).join(' ');
                                    actionDesc = `${h.actionPlayer || h.type.split(' ')[0]} ${foulType} (${h.player} ë“ì )`;
                                }
                                
                                return `
                                <div style="padding:12px; margin:8px 0; background:var(--bg-secondary); border-radius:6px;">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                                        <span style="font-size:12px; color:var(--text-secondary);">${h.time} - ${h.server || h.player} ì„œë¸Œ ${h.serveNumber || ''}íšŒì°¨</span>
                                        ${h.scoreBefore ? `<span style="font-size:12px; color:var(--text-secondary);">(${h.scoreBefore.player1}:${h.scoreBefore.player2})</span>` : ''}
                                    </div>
                                    <div style="display:flex; justify-content:space-between; align-items:center;">
                                        <span>${actionDesc}</span>
                                        <span style="font-weight:700; color:var(--primary);">${h.points}ì  ë“ì </span>
                                    </div>
                                    ${h.scoreAfter ? `
                                        <div style="margin-top:6px; padding-top:6px; border-top:1px solid var(--border);">
                                            <span style="font-size:13px; font-weight:600; color:var(--success);">â†’ ìŠ¤ì½”ì–´: ${h.scoreAfter.player1}:${h.scoreAfter.player2}</span>
                                        </div>
                                    ` : ''}
                                </div>
                            `}).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        let userRole = null; // 'referee' ë˜ëŠ” 'viewer'
        
        function selectRole(role) {
            userRole = role;
            if (role === 'referee') {
                isAuthenticated = true; // ì‹¬íŒ ëª¨ë“œëŠ” ì¸ì¦ë¨
                screen = 'referee-home';
            } else {
                isAuthenticated = false; // ê´€ëŒ ëª¨ë“œëŠ” ì¸ì¦ ì•ˆ ë¨
                screen = 'viewer-home';
            }
            render();
        }

        function goTo(s) {
            screen = s;
            render();
        }

        function createProject() {
            const name = document.getElementById('project-name').value.trim();
            if (!name) {
                alert('í”„ë¡œì íŠ¸ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                return;
            }
            
            const project = {
                id: Date.now(),
                name,
                date: document.getElementById('project-date').value,
                location: document.getElementById('project-location').value,
                desc: document.getElementById('project-desc').value,
                matches: [],
                createdAt: new Date().toISOString()
            };
            
            console.log('í”„ë¡œì íŠ¸ ìƒì„± ì‹œë„:', project);
            
            // Firebaseì— ì €ì¥
            try {
                if (typeof database !== 'undefined' && database) {
                    console.log('Firebaseì— ì €ì¥ ì¤‘...');
                    const newProjectRef = database.ref('projects').push();
                    project.firebaseKey = newProjectRef.key;
                    newProjectRef.set(project).then(() => {
                        console.log('âœ… Firebase ì €ì¥ ì„±ê³µ!');
                        goTo('project-list');
                    }).catch((error) => {
                        console.error('Firebase ì €ì¥ ì—ëŸ¬:', error);
                        alert('Firebase ì €ì¥ ì‹¤íŒ¨. ë¡œì»¬ ì €ì¥ìœ¼ë¡œ ì „í™˜í•©ë‹ˆë‹¤.');
                        projects.push(project);
                        localStorage.setItem('projects', JSON.stringify(projects));
                        goTo('project-list');
                    });
                } else {
                    // ë¡œì»¬ ì €ì¥
                    console.log('ë¡œì»¬ ì €ì¥ ëª¨ë“œ');
                    projects.push(project);
                    localStorage.setItem('projects', JSON.stringify(projects));
                    goTo('project-list');
                }
            } catch (error) {
                console.error('í”„ë¡œì íŠ¸ ìƒì„± ì—ëŸ¬:', error);
                alert('ì—ëŸ¬: ' + error.message);
                projects.push(project);
                localStorage.setItem('projects', JSON.stringify(projects));
                goTo('project-list');
            }
        }

        function selectProject(index) {
            currentProject = projects[index];
            goTo('project-detail');
        }

        function createMatch() {
            // ìœ íš¨ì„± ê²€ì‚¬ í•¨ìˆ˜
            function validateField(id, message) {
                const el = document.getElementById(id);
                const value = el ? el.value.trim() : '';
                if (!value) {
                    alert(message);
                    if (el) el.focus();
                    return null;
                }
                return value;
            }
            
            const type = document.getElementById('match-type').value;
            
            // ì„ ìˆ˜/íŒ€ ì´ë¦„ ê²€ì‚¬
            const player1 = validateField('player1', type === 'team' ? 'íŒ€ 1 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”' : 'ì„ ìˆ˜ 1 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            if (!player1) return;
            
            const player2 = validateField('player2', type === 'team' ? 'íŒ€ 2 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”' : 'ì„ ìˆ˜ 2 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
            if (!player2) return;
            
            // PIN ê²€ì‚¬
            const pinEl = document.getElementById('referee-pin');
            const pin = pinEl ? pinEl.value.trim() : '';
            if (!pin) {
                alert('ì‹¬íŒ PINì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                if (pinEl) pinEl.focus();
                return;
            }
            if (pin.length < 6) {
                alert('ì‹¬íŒ PINì€ 6ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤');
                if (pinEl) pinEl.focus();
                return;
            }
            if (!/^\d+$/.test(pin)) {
                alert('ì‹¬íŒ PINì€ ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                if (pinEl) pinEl.focus();
                return;
            }
            
            // íŒ€ì „ì¼ ê²½ìš° ë¼ì¸ì—… í™•ì¸
            let team1Lineup = null;
            let team2Lineup = null;
            if (type === 'team') {
                const t1p1 = validateField('team1-player1', 'íŒ€ 1 ì„ ìˆ˜ 1 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                if (!t1p1) return;
                const t1p2 = validateField('team1-player2', 'íŒ€ 1 ì„ ìˆ˜ 2 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                if (!t1p2) return;
                const t1p3 = validateField('team1-player3', 'íŒ€ 1 ì„ ìˆ˜ 3 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                if (!t1p3) return;
                const t2p1 = validateField('team2-player1', 'íŒ€ 2 ì„ ìˆ˜ 1 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                if (!t2p1) return;
                const t2p2 = validateField('team2-player2', 'íŒ€ 2 ì„ ìˆ˜ 2 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                if (!t2p2) return;
                const t2p3 = validateField('team2-player3', 'íŒ€ 2 ì„ ìˆ˜ 3 ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
                if (!t2p3) return;
                
                team1Lineup = [t1p1, t1p2, t1p3];
                team2Lineup = [t2p1, t2p2, t2p3];
            }

            const sets = type === 'individual' ? parseInt(document.getElementById('sets').value) : 1;
            const match = {
                id: Date.now(),
                type,
                sets,
                player1Name: player1,
                player2Name: player2,
                team1Lineup,
                team2Lineup,
                mainReferee: document.getElementById('main-referee')?.value.trim() || '',
                assistantReferee: document.getElementById('assistant-referee')?.value.trim() || '',
                coach1: document.getElementById('coach1')?.value.trim() || '',
                coach2: document.getElementById('coach2')?.value.trim() || '',
                refereePin: pin,
                winScore: type === 'individual' ? 11 : 31,
                currentSet: 1,
                setScores: [{player1: 0, player2: 0}],
                currentServe: 'player1',
                serveCount: 0,
                timeouts: {
                    player1: 1,
                    player2: 1
                },
                sideChangeUsed: false,
                status: 'active',
                history: [],
                createdAt: new Date().toISOString()
            };
            
            // currentProject í™•ì¸
            if (!currentProject) {
                alert('í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”');
                goTo('project-list');
                return;
            }
            
            if (!currentProject.matches) {
                currentProject.matches = [];
            }
            
            currentProject.matches.push(match);
            currentMatch = match;
            isAuthenticated = true;
            
            // ì €ì¥ (ë¡œì»¬ ìš°ì„ )
            try {
                if (database && currentProject.firebaseKey) {
                    database.ref('projects/' + currentProject.firebaseKey).set(currentProject);
                } else {
                    // ë¡œì»¬ ì €ì¥
                    const idx = projects.findIndex(p => p.id === currentProject.id);
                    if (idx >= 0) {
                        projects[idx] = currentProject;
                    }
                    localStorage.setItem('projects', JSON.stringify(projects));
                }
            } catch (e) {
                localStorage.setItem('projects', JSON.stringify(projects));
            }
            
            // ê²½ê¸° ìƒì„± ì™„ë£Œ í›„ ê²½ê¸° ëª©ë¡ìœ¼ë¡œ ì´ë™
            alert('âœ… ê²½ê¸°ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
            screen = 'project-detail';
            render();
        }

        function selectMatch(index) {
            currentMatch = currentProject.matches[index];
            
            // ì™„ë£Œëœ ê²½ê¸°ëŠ” ì¸ì¦ ë¶ˆí•„ìš”
            if (currentMatch.status === 'finished') {
                isAuthenticated = false;
                screen = 'match';
                render();
                return;
            }
            
            // ê´€ëŒ ëª¨ë“œë¡œ ì ‘ì†í–ˆìœ¼ë©´ ë°”ë¡œ ë³´ê¸°
            if (userRole === 'viewer') {
                isAuthenticated = false;
                screen = 'match';
                render();
                return;
            }
            
            // ì‹¬íŒ ëª¨ë“œ - PIN í™•ì¸
            const inputPin = prompt('ğŸ” ì‹¬íŒ PINì„ ì…ë ¥í•˜ì„¸ìš”:');
            if (inputPin === currentMatch.refereePin) {
                isAuthenticated = true;
                alert('âœ… ì‹¬íŒ ì¸ì¦ ì™„ë£Œ!');
                screen = 'match';
                render();
            } else {
                alert('âŒ PINì´ í‹€ë ¸ìŠµë‹ˆë‹¤. ê²½ê¸°ì— ì§„ì…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                // í™”ë©´ ì „í™˜ ì•ˆ í•¨ - ê²½ê¸° ëª©ë¡ì— ë¨¸ë¬´ë¦„
            }
        }

        function addScore(player, points, type) {
            // ì¸ì¦ í™•ì¸
            if (!isAuthenticated) {
                alert('âŒ ì‹¬íŒë§Œ ë“ì ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
                return;
            }
            
            const set = currentMatch.setScores[currentMatch.currentSet - 1];
            // ë“ì  ì „ ìŠ¤ì½”ì–´ ì €ì¥
            const scoreBefore = { player1: set.player1, player2: set.player2 };
            
            if (player === 'player1') set.player1 += points;
            else set.player2 += points;
            
            // ë“ì  í›„ ìŠ¤ì½”ì–´ ì €ì¥
            const scoreAfter = { player1: set.player1, player2: set.player2 };
            
            // í˜„ì¬ ì„œë¸Œ ì •ë³´ ì €ì¥
            const servingPlayer = currentMatch.currentServe === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            const serveNumber = currentMatch.serveCount + 1;
            
            currentMatch.history.unshift({
                time: new Date().toLocaleTimeString('ko-KR'),
                player: player === 'player1' ? currentMatch.player1Name : currentMatch.player2Name, // ë“ì í•œ ì„ ìˆ˜
                actionPlayer: type.includes('ê³¨') ? (player === 'player1' ? currentMatch.player1Name : currentMatch.player2Name) : type.split(' ')[0], // ì•¡ì…˜í•œ ì„ ìˆ˜ (ê³¨ ë˜ëŠ” íŒŒìš¸í•œ ì„ ìˆ˜)
                type,
                points,
                set: currentMatch.currentSet,
                server: servingPlayer,
                serveNumber: serveNumber,
                scoreBefore: scoreBefore,
                scoreAfter: scoreAfter
            });
            
            currentMatch.serveCount++;
            const maxServes = currentMatch.type === 'individual' ? 2 : 3;
            if (currentMatch.serveCount >= maxServes) {
                currentMatch.currentServe = currentMatch.currentServe === 'player1' ? 'player2' : 'player1';
                currentMatch.serveCount = 0;
            }
            
            const score = player === 'player1' ? set.player1 : set.player2;
            const playerName = player === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            
            saveProjects();
            renderMatch();
            
            // aria-live ì‹¤ì‹œê°„ ì•ˆë‚´ (ê°„ë‹¨í•˜ê²Œ)
            const nextServer = currentMatch.currentServe === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            const nextServeCount = currentMatch.serveCount + 1;
            const announcement = `${type}, ${points}ì . ${currentMatch.player1Name} ${set.player1}, ${currentMatch.player2Name} ${set.player2}. ë‹¤ìŒ ì„œë¸Œ ${nextServer}`;
            announce(announcement);
            
            // ì‚¬ì´ë“œ ì²´ì¸ì§€ ì²´í¬
            // ê°œì¸ì „: ë§ˆì§€ë§‰ ì„¸íŠ¸ì—ì„œë§Œ 6ì , íŒ€ì „: 16ì 
            let shouldCheckSideChange = false;
            if (currentMatch.type === 'team') {
                shouldCheckSideChange = true;
            } else {
                // ê°œì¸ì „: ë§ˆì§€ë§‰ ì„¸íŠ¸ì¸ì§€ í™•ì¸
                const player1SetWins = currentMatch.setScores.filter((s, idx) => idx < currentMatch.currentSet - 1 && s.player1 > s.player2).length;
                const player2SetWins = currentMatch.setScores.filter((s, idx) => idx < currentMatch.currentSet - 1 && s.player2 > s.player1).length;
                const totalSetsNeeded = Math.ceil(currentMatch.sets / 2); // 3ì„¸íŠ¸ë©´ 2ìŠ¹, 5ì„¸íŠ¸ë©´ 3ìŠ¹
                const isLastSet = (player1SetWins === totalSetsNeeded - 1 && player2SetWins === totalSetsNeeded - 1);
                shouldCheckSideChange = isLastSet;
            }
            
            if (shouldCheckSideChange) {
                const sideChangePoint = currentMatch.type === 'individual' ? 6 : 16;
                const totalScore = set.player1 + set.player2;
                if (!currentMatch.sideChangeUsed && totalScore >= sideChangePoint) {
                    currentMatch.sideChangeUsed = true;
                    saveProjects();
                    setTimeout(() => {
                        if (confirm(`ì‚¬ì´ë“œ ì²´ì¸ì§€! (í•©ì‚° ${totalScore}ì )\n\n1ë¶„ íœ´ì‹ íƒ€ì´ë¨¸ë¥¼ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                            startSideChange();
                        }
                    }, 500);
                    return; // ì‚¬ì´ë“œ ì²´ì¸ì§€ í™•ì¸ í›„ ë¦¬í„´
                }
            }
            
            // ì„¸íŠ¸ ì¢…ë£Œ ì¡°ê±´ í™•ì¸ ë° ìë™ íŒì—…
            const diff = Math.abs(set.player1 - set.player2);
            const max = Math.max(set.player1, set.player2);
            if (max >= currentMatch.winScore && diff >= 2) {
                setTimeout(() => {
                    const setEndText = currentMatch.currentSet < currentMatch.sets 
                        ? `ì„¸íŠ¸ ${currentMatch.currentSet}ì„(ë¥¼) ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní˜„ì¬ ì ìˆ˜: ${set.player1} - ${set.player2}`
                        : `ê²½ê¸°ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nìµœì¢… ì ìˆ˜: ${set.player1} - ${set.player2}`;
                    
                    if (confirm(setEndText)) {
                        endSet();
                    }
                }, 500);
            }
        }


        function undo() {
            if (!isAuthenticated) {
                alert('âŒ ì‹¬íŒë§Œ ì·¨ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
                return;
            }
            if (currentMatch.history.length === 0) return;
            
            const last = currentMatch.history.shift();
            const set = currentMatch.setScores[currentMatch.currentSet - 1];
            
            if (last.player === currentMatch.player1Name) set.player1 -= last.points;
            else set.player2 -= last.points;
            
            currentMatch.serveCount--;
            if (currentMatch.serveCount < 0) {
                currentMatch.currentServe = currentMatch.currentServe === 'player1' ? 'player2' : 'player1';
                const maxServes = currentMatch.type === 'individual' ? 2 : 3;
                currentMatch.serveCount = maxServes - 1;
            }
            
            // aria-live ì‹¤ì‹œê°„ ì•ˆë‚´
            const nextServer = currentMatch.currentServe === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            announce(`ì·¨ì†Œë¨. ${currentMatch.player1Name} ${set.player1}, ${currentMatch.player2Name} ${set.player2}. ë‹¤ìŒ ì„œë¸Œ ${nextServer}`);
            
            saveProjects();
            renderMatch();
        }

        function endSet() {
            if (!isAuthenticated) {
                alert('âŒ ì‹¬íŒë§Œ ì„¸íŠ¸ë¥¼ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
                return;
            }
            const set = currentMatch.setScores[currentMatch.currentSet - 1];
            const diff = Math.abs(set.player1 - set.player2);
            const max = Math.max(set.player1, set.player2);
            
            if (max < currentMatch.winScore) {
                alert(`${currentMatch.winScore}ì  ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤`);
                return;
            }
            if (diff < 2) {
                alert('2ì  ì´ìƒ ì°¨ì´ê°€ ë‚˜ì•¼ í•©ë‹ˆë‹¤');
                return;
            }
            
            if (currentMatch.currentSet < currentMatch.sets) {
                const prevSet = currentMatch.currentSet;
                currentMatch.currentSet++;
                currentMatch.setScores.push({player1: 0, player2: 0});
                currentMatch.serveCount = 0;
                currentMatch.sideChangeUsed = false; // ì‚¬ì´ë“œ ì²´ì¸ì§€ ë¦¬ì…‹
                // ê°œì¸ì „ë§Œ ì„¸íŠ¸ë§ˆë‹¤ íƒ€ì„ì•„ì›ƒ ë¦¬ì…‹ (íŒ€ì „ì€ ë‹¨íŒì´ë¯€ë¡œ ë¦¬ì…‹ ì—†ìŒ)
                if (currentMatch.type === 'individual') {
                    currentMatch.timeouts = { player1: 1, player2: 1 };
                    announce(`ì„¸íŠ¸ ${prevSet} ì¢…ë£Œ. ì„¸íŠ¸ ${currentMatch.currentSet} ì‹œì‘. íƒ€ì„ì•„ì›ƒ ë¦¬ì…‹`);
                } else {
                    announce(`ì„¸íŠ¸ ${prevSet} ì¢…ë£Œ. ì„¸íŠ¸ ${currentMatch.currentSet} ì‹œì‘`);
                }
                saveProjects();
                renderMatch();
            } else {
                if (confirm('ê²½ê¸°ë¥¼ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    currentMatch.status = 'finished';
                    currentMatch.finishedAt = new Date().toISOString();
                    announce(`ê²½ê¸° ì¢…ë£Œ. ${currentMatch.player1Name} ${set.player1}, ${currentMatch.player2Name} ${set.player2}`);
                    saveProjects();
                    goTo('project-detail');
                }
            }
        }

        function startTimeout(player) {
            if (currentMatch.timeouts[player] === 0 || isTimeoutActive) return;
            
            // ì¸ì¦ í™•ì¸
            if (!isAuthenticated) {
                alert('âŒ ì‹¬íŒë§Œ íƒ€ì„ì•„ì›ƒì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤');
                return;
            }
            
            isTimeoutActive = true;
            currentMatch.timeouts[player]--;
            saveProjects();
            
            const playerName = player === 'player1' ? currentMatch.player1Name : currentMatch.player2Name;
            document.getElementById('timeout-title').textContent = `${playerName} íƒ€ì„ì•„ì›ƒ`;
            document.getElementById('timeout-modal').classList.add('active');
            
            timeoutSeconds = 60;
            updateTimerDisplay();
            speak(`${playerName} íƒ€ì„ì•„ì›ƒ ì‹œì‘. 60ì´ˆ`);
            announce(`${playerName} íƒ€ì„ì•„ì›ƒ ì‹œì‘. ë‚¨ì€ íšŸìˆ˜ ${currentMatch.timeouts[player]}`);
            
            timeoutTimer = setInterval(() => {
                timeoutSeconds--;
                updateTimerDisplay();
                
                if (timeoutSeconds === 15) {
                    speak('15ì´ˆ ë‚¨ìŒ');
                    announce('15ì´ˆ ë‚¨ìŒ');
                    document.getElementById('timer-display').classList.add('warning');
                } else if (timeoutSeconds === 0) {
                    speak('íƒ€ì„ì•„ì›ƒ ì¢…ë£Œ');
                    announce('íƒ€ì„ì•„ì›ƒ ì¢…ë£Œ');
                    closeTimeout();
                }
            }, 1000);
            
            renderMatch();
        }

        function startSideChange() {
            if (isTimeoutActive) return;
            
            isTimeoutActive = true;
            document.getElementById('timeout-title').textContent = 'ì‚¬ì´ë“œ ì²´ì¸ì§€ (1ë¶„ íœ´ì‹)';
            document.getElementById('timeout-modal').classList.add('active');
            
            timeoutSeconds = 60;
            updateTimerDisplay();
            speak('ì‚¬ì´ë“œ ì²´ì¸ì§€. 1ë¶„ íœ´ì‹ ì‹œì‘');
            announce('ì‚¬ì´ë“œ ì²´ì¸ì§€. 1ë¶„ íœ´ì‹');
            
            timeoutTimer = setInterval(() => {
                timeoutSeconds--;
                updateTimerDisplay();
                
                if (timeoutSeconds === 15) {
                    speak('15ì´ˆ ë‚¨ìŒ');
                    announce('15ì´ˆ ë‚¨ìŒ');
                    document.getElementById('timer-display').classList.add('warning');
                } else if (timeoutSeconds === 0) {
                    speak('íœ´ì‹ ì¢…ë£Œ');
                    announce('íœ´ì‹ ì¢…ë£Œ');
                    closeTimeout();
                }
            }, 1000);
            
            renderMatch();
        }

        function updateTimerDisplay() {
            document.getElementById('timer-display').textContent = timeoutSeconds;
        }

        function closeTimeout() {
            clearInterval(timeoutTimer);
            document.getElementById('timeout-modal').classList.remove('active');
            document.getElementById('timer-display').classList.remove('warning');
            timeoutSeconds = 60;
            isTimeoutActive = false;
            renderMatch();
        }

        function deleteMatch(event, index) {
            event.stopPropagation();
            const match = currentProject.matches[index];
            const matchName = `${match.player1Name} vs ${match.player2Name}`;
            
            if (confirm(`ê²½ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${matchName}\nì„¸íŠ¸ ${match.currentSet}/${match.sets}`)) {
                currentProject.matches.splice(index, 1);
                saveProjects();
                render();
            }
        }

        function deleteProject(index) {
            const project = projects[index];
            
            if (confirm(`í”„ë¡œì íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${project.name}\nê²½ê¸° ${project.matches?.length || 0}ê°œ í¬í•¨`)) {
                // Firebaseì—ì„œ ì‚­ì œ
                if (database && project.firebaseKey) {
                    database.ref('projects/' + project.firebaseKey).remove();
                } else {
                    // ë¡œì»¬ì—ì„œ ì‚­ì œ
                    projects.splice(index, 1);
                    localStorage.setItem('projects', JSON.stringify(projects));
                }
                render();
            }
        }

        function deleteMatchDirect(index) {
            const match = currentProject.matches[index];
            const matchName = `${match.player1Name} vs ${match.player2Name}`;
            
            if (confirm(`ê²½ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${matchName}`)) {
                currentProject.matches.splice(index, 1);
                saveProjects();
                render();
            }
        }

        // ê²½ê¸° ê¸°ë¡ ìˆœì„œ í† ê¸€
        let historyOrderDesc = true; // true: ìµœì‹ ìˆœ, false: ì˜¤ë˜ëœìˆœ
        let finishedHistoryOrderDesc = true;

        function toggleHistoryOrder() {
            historyOrderDesc = !historyOrderDesc;
            const btn = document.getElementById('history-order-btn');
            btn.textContent = historyOrderDesc ? 'ìµœì‹ ìˆœ â†“' : 'ì˜¤ë˜ëœìˆœ â†‘';
            
            const container = document.getElementById('match-history');
            const items = Array.from(container.children);
            items.reverse().forEach(item => container.appendChild(item));
        }

        function toggleFinishedHistoryOrder() {
            finishedHistoryOrderDesc = !finishedHistoryOrderDesc;
            const btn = document.getElementById('finished-history-order-btn');
            btn.textContent = finishedHistoryOrderDesc ? 'ìµœì‹ ìˆœ â†“' : 'ì˜¤ë˜ëœìˆœ â†‘';
            
            const container = document.getElementById('finished-match-history');
            const items = Array.from(container.children);
            items.reverse().forEach(item => container.appendChild(item));
        }

        // ì´ˆê¸°í™”
        const savedTheme = localStorage.getItem('theme') || 'normal';
        const savedThemeIndex = parseInt(localStorage.getItem('themeIndex')) || 0;
        currentThemeIndex = savedThemeIndex;
        
        if (savedTheme !== 'normal') {
            document.body.className = savedTheme;
        }
        
        const currentTheme = themes[currentThemeIndex];
        document.getElementById('theme-btn').textContent = `ëª¨ë“œ: ${currentTheme.name}`;
        document.getElementById('voice-btn').style.opacity = voiceEnabled ? '1' : '0.5';
        render();
    </script>
</body>
</html>
